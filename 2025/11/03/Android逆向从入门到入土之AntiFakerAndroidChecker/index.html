<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Android逆向从入门到入土之AntiFakerAndroidChecker(3) | S1nec-1o's B1og</title><meta name="author" content="s1nec-1o"><meta name="copyright" content="s1nec-1o"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言本文的项目来自于https:&#x2F;&#x2F;github.com&#x2F;happylishang&#x2F;AntiFakerAndroidChecker&#x2F; 模拟器检测MainActivity.java在demo中展示的就是检测模拟器的代码 onCreate1234super.onCreate(savedInstanceState);binding &#x3D; ActivityMainBinding.inflate(getLay">
<meta property="og:type" content="article">
<meta property="og:title" content="Android逆向从入门到入土之AntiFakerAndroidChecker(3)">
<meta property="og:url" content="http://s1nec-1o.github.io/2025/11/03/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%E4%B9%8BAntiFakerAndroidChecker/index.html">
<meta property="og:site_name" content="S1nec-1o&#39;s B1og">
<meta property="og:description" content="前言本文的项目来自于https:&#x2F;&#x2F;github.com&#x2F;happylishang&#x2F;AntiFakerAndroidChecker&#x2F; 模拟器检测MainActivity.java在demo中展示的就是检测模拟器的代码 onCreate1234super.onCreate(savedInstanceState);binding &#x3D; ActivityMainBinding.inflate(getLay">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png">
<meta property="article:published_time" content="2025-11-03T13:26:59.000Z">
<meta property="article:modified_time" content="2025-11-03T13:41:08.342Z">
<meta property="article:author" content="s1nec-1o">
<meta property="article:tag" content="android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281712481.jpg"><link rel="canonical" href="http://s1nec-1o.github.io/2025/11/03/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%E4%B9%8BAntiFakerAndroidChecker/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css?v=4.12.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"距离文章发布已经过去","messageNext":"天了，信息可能已经过时"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Android逆向从入门到入土之AntiFakerAndroidChecker(3)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-11-03 21:41:08'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 8 || hour >= 20
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/atom.xml" title="S1nec-1o's B1og" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">25</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281616326.png')"><nav id="nav"><span id="blog-info"><a href="/" title="S1nec-1o's B1og"><span class="site-name">S1nec-1o's B1og</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Android逆向从入门到入土之AntiFakerAndroidChecker(3)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-11-03T13:26:59.000Z" title="发表于 2025-11-03 21:26:59">2025-11-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-11-03T13:41:08.342Z" title="更新于 2025-11-03 21:41:08">2025-11-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/">安卓逆向</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文的项目来自于<a target="_blank" rel="noopener" href="https://github.com/happylishang/AntiFakerAndroidChecker/">https://github.com/happylishang/AntiFakerAndroidChecker/</a></p>
<h2 id="模拟器检测"><a href="#模拟器检测" class="headerlink" title="模拟器检测"></a>模拟器检测</h2><h3 id="MainActivity-java"><a href="#MainActivity-java" class="headerlink" title="MainActivity.java"></a>MainActivity.java</h3><p>在demo中展示的就是检测模拟器的代码</p>
<h3 id="onCreate"><a href="#onCreate" class="headerlink" title="onCreate"></a>onCreate</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">binding = ActivityMainBinding.inflate(getLayoutInflater());</span><br><span class="line">setContentView(binding.getRoot());</span><br><span class="line">mActivity = <span class="built_in">this</span>;</span><br></pre></td></tr></table></figure>

<p>设置<code>mActivity</code>为当前<code>MainActivity</code>的实例，方便调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  子进程检测是否是模拟器，不影响UI线程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">binding.btnAsyncSimu.setOnClickListener(v -&gt; EmuCheckUtil.checkEmulatorFromCache(getApplicationContext(),</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">EmuCheckUtil</span>.CheckEmulatorCallBack() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCheckSuccess</span><span class="params">(<span class="type">boolean</span> isEmulator)</span> &#123;</span><br><span class="line">                <span class="type">TextView</span> <span class="variable">textView</span> <span class="operator">=</span> (TextView) findViewById(R.id.btn_async_simu);</span><br><span class="line">                textView.setText(<span class="string">&quot;  内存异步非UI进程获取是否模拟器 &quot;</span> + isEmulator);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCheckFaild</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">TextView</span> <span class="variable">textView</span> <span class="operator">=</span> (TextView) findViewById(R.id.btn_async_simu);</span><br><span class="line">                textView.setText(<span class="string">&quot;  内存异步非UI进程获取是否模拟器 失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br></pre></td></tr></table></figure>

<p><strong><code>binding.btnAsyncSimu.setOnClickListener(...)</code></strong></p>
<ul>
<li>为布局文件中 ID 为 <code>btn_async_simu</code> 的按钮设置一个点击事件监听器<ul>
<li>布局文件<code>app\src\main\res\layout\activity_main.xml</code></li>
</ul>
</li>
<li>当用户点击这个按钮时，监听器内部的代码会被执行</li>
</ul>
<p>点击事件触发后，会调用 <code>EmuCheckUtil.checkEmulatorFromCache()</code> 方法。这个方法是整个功能的核心</p>
<h4 id="checkEmulatorFromCache"><a href="#checkEmulatorFromCache" class="headerlink" title="checkEmulatorFromCache"></a>checkEmulatorFromCache</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">checkEmulatorFromCache</span><span class="params">(<span class="keyword">final</span> Context context, <span class="meta">@NonNull</span> <span class="keyword">final</span> EmuCheckUtil.CheckEmulatorCallBack callBack)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 创建一个 Intent 来标识目标服务。</span></span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(context, EmulatorCheckService.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 绑定到服务。</span></span><br><span class="line">    context.bindService(intent, <span class="keyword">new</span> <span class="title class_">ServiceConnection</span>() &#123;</span><br><span class="line">        <span class="comment">// 这个匿名类处理连接的生命周期。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 连接建立时调用。</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> &#123;</span><br><span class="line">            <span class="comment">// 4. 将原始 IBinder 转换为 AIDL 接口。</span></span><br><span class="line">            <span class="type">IEmulatorCheck</span> <span class="variable">IEmulatorCheck</span> <span class="operator">=</span> com.snail.antifake.IEmulatorCheck.Stub.asInterface(service);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (IEmulatorCheck != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 5. 进行远程调用并传递结果。</span></span><br><span class="line">                    callBack.onCheckSuccess(IEmulatorCheck.isEmulator());</span><br><span class="line">                    <span class="comment">// 6. 获取结果后解除与服务的绑定。</span></span><br><span class="line">                    context.unbindService(<span class="built_in">this</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException var5) &#123;</span><br><span class="line">                    <span class="comment">// 7. 处理通信错误。</span></span><br><span class="line">                    callBack.onCheckFaild();</span><br><span class="line">                    context.unbindService(<span class="built_in">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8. 如果连接意外丢失时调用。</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceDisconnected</span><span class="params">(ComponentName name)</span> &#123;</span><br><span class="line">            <span class="comment">// 此实现不执行任何操作，但可用于清理或重试逻辑。</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, BIND_AUTO_CREATE); <span class="comment">// 9. 如果服务未运行，则自动创建服务的标志。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>详细分析：</strong></p>
<ol>
<li>一开始先创建了一个显式 <code>Intent</code>。<strong>这种类型的 Intent 用于应用程序内部通信</strong>。它明确指明了<strong>目的地</strong>：<code>EmulatorCheckService</code></li>
<li><code>context.bindService</code> 启动与 <code>intent</code> 指定的服务的连接，第二个参数是<code>ServiceConnection</code> 的实例，这是一个用于<strong>监视连接状态的接口</strong>。这里，它被实现为一个<strong>匿名内部类</strong></li>
<li>当与 <code>EmulatorCheckService</code> 的连接成功建立后，Android 系统会调用此回调方法。它接收一个 <code>IBinder</code> 对象，它是与远程服务的<strong>原始通信通道</strong></li>
<li><code>IEmulatorCheck</code> 接口在 <code>.aidl</code> 文件中定义。静态方法 <code>asInterface()</code> 接收来自服务的通用 <code>IBinder</code> 并将其转换为客户端代理对象 (<code>IEmulatorCheck</code>)。这个代理对象具有与远程服务接口相同的方法（例如 <code>isEmulator()</code>），<strong>允许客户端像调用本地方法一样调用它们</strong></li>
<li>代码现在在代理对象上调用 <code>isEmulator()</code> 方法。这会触发 IPC 机制：方法调用及其参数被“编组”（<strong>序列化</strong>），跨进程边界发送到 <code>EmulatorCheckService</code>，并在那里执行。来自服务的布尔结果随后被“解组”并返回到此处</li>
<li>成功获取结果后，<strong>客户端解除与服务的绑定</strong>。这对于资源管理至关重要。由于服务可能是通过 <code>BIND_AUTO_CREATE</code> 启动的，一旦所有客户端都解除绑定，系统将自动销毁它</li>
<li>如果服务进程崩溃或被终止，对远程服务的调用可能会失败。此类故障会抛出 <code>RemoteException</code></li>
<li>此方法仅在意外断开连接（例如服务进程崩溃）时调用</li>
<li>**<code>BIND_AUTO_CREATE</code>**此标志告诉 <code>bindService</code> 如果服务尚未运行则创建它</li>
</ol>
<blockquote>
<p><strong>什么是 AIDL？</strong></p>
<p>AIDL 全称是 <strong>Android Interface Definition Language</strong>，即 <strong>Android 接口定义语言</strong>。</p>
<p>它是一种 <strong>IPC (Inter-Process Communication，进程间通信)</strong> 机制。当你的 Android 应用需要与另一个应用或服务（尤其是在不同进程中运行的服务）进行通信时，就需要一种双方都能理解的“协议”来传递数据和调用方法。<strong>AIDL 就是用来定义这个协议的工具</strong>。</p>
<p>它的工作流程大致如下：</p>
<ol>
<li><strong>定义接口</strong>：你使用类似 Java 接口的语法在一个 <code>.aidl</code> 文件中声明一个接口，包括你想<strong>暴露给客户端调用的方法</strong>。</li>
<li><strong>生成代码</strong>：Android SDK 工具会处理这个 <code>.aidl</code> 文件，并自动生成一个同名的 Java 接口文件。这个文件中包含一个名为 <code>Stub</code> 的抽象内部类，它实现了接口并处理了所有远程调用的细节。</li>
<li><strong>服务端实现</strong>：服务（Service）需要创建一个 <code>Stub</code> 类的实例，并实现你在 <code>.aidl</code> 文件中定义的方法。<code>Service</code> 的 <code>onBind()</code> 方法会返回这个 <code>Stub</code> 实例。</li>
<li><strong>客户端调用</strong>：客户端在 <code>onServiceConnected()</code> 回调中接收到一个 <code>IBinder</code> 对象。通过调用 <code>YourInterface.Stub.asInterface(binder)</code>，客户端可以得到一个接口的代理对象。之后，客户端就可以像调用本地方法一样调用这个代理对象的方法，而 Android 系统会在底层处理所有跨进程的数据打包（编组）、传输和解包（解组）工作。</li>
</ol>
<p><strong>为什么这里使用 AIDL 而不是更简单的方法？</strong></p>
<p>查看项目中的 <code>AndroidManifest.xml</code> 文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">&quot;.jni.EmulatorCheckService&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:process</span>=<span class="string">&quot;:EmulatorCheckService&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>关键在于 <code>android:process=&quot;:EmulatorCheckService&quot;</code> 这一行。</p>
<p>属性值前面的冒号 (<code>:</code>) 表示这个 Service 将会运行在一个<strong>私有的、独立的进程</strong>中，进程名是 <code>你的应用包名:EmulatorCheckService</code></p>
<p><strong>既然检测逻辑被刻意放到了一个独立的进程中，那么主应用进程与这个服务进程之间的通信就必须使用 IPC 机制。</strong> AIDL 是 Android 官方提供的、功能强大且高效的 IPC 方式之一，因此被选用</p>
<p><strong>提高安全性，防止 Hook</strong>：</p>
<p><strong>Hook 工具通常是注入到目标应用的主进程里</strong>，它们无法直接影响到另一个独立的 <code>EmulatorCheckService</code> 进程。攻击者如果想破解，就必须设法去 Hook 这个新的服务进程，操作更复杂，从而有效地提升了反作弊的门槛。</p>
</blockquote>
<blockquote>
<p><strong>异步性</strong>: 检查不会阻塞主线程，确保流畅的用户体验。</p>
<p><strong>隔离性</strong>: 通过在单独的进程中运行检查，使得恶意工具（如 Hook 框架）更难从应用程序的主进程中篡改检测逻辑。</p>
</blockquote>
<h4 id="EmulatorCheckService"><a href="#EmulatorCheckService" class="headerlink" title="EmulatorCheckService"></a>EmulatorCheckService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">callBack.onCheckSuccess(IEmulatorCheck.isEmulator());</span><br></pre></td></tr></table></figure>

<p>此处调用<code>isEmulator</code>函数，会触发IPC机制</p>
<blockquote>
<p>为什么执行它就是执行EmulatorCheckService的isEmulator函数？</p>
<p>调用 <code>AIDL</code> 接口的 <code>isEmulator()</code> 方法之所以会执行 <code>EmulatorCheckService</code> 中的 <code>isEmulator()</code> 方法，是因为 Android 系统在背后为你构建了一座“通信桥梁”。这个桥梁由两部分组成：客户端的 <strong>代理（Proxy）</strong> 和服务端的 <strong>存根（Stub）</strong></p>
<p>当你编译项目时，Android 构建工具会找到 <code>IEmulatorCheck.aidl</code> 文件，并自动生成一个 <code>IEmulatorCheck.java</code> 文件。这个自动生成的文件包含了所有实现跨进程通信所需要的“胶水代码”</p>
<p>在 <code>EmulatorCheckService.java</code> 中，创建了一个 <code>IEmulatorCheck.Stub</code> 的匿名内部类实例，并实现了 <code>isEmulator()</code> 方法</p>
<p>当服务启动并被绑定时，这个 <code>Stub</code> 对象（它本身就是一个 <code>IBinder</code>）被 Android 系统传递给了客户端</p>
<p>这里的 <code>Stub.asInterface(service)</code> 方法做了什么？</p>
<ul>
<li>它检查发现客户端和服务端不在同一个进程。</li>
<li>于是，它创建并返回了一个 <code>IEmulatorCheck.Stub.Proxy</code> 对象。这个 <code>Proxy</code> 对象持有了指向服务端 <code>Binder</code> 的引用。</li>
</ul>
<p>所以，<strong>AIDL 接口本身只是一个约定，而自动生成的 <code>Proxy</code> 和 <code>Stub</code> 类才是实现这个约定的“工匠”，它们联手完成了所有复杂的跨进程通信工作，让你感觉就像在调用一个本地方法一样简单。</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmulatorCheckService</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line"></span><br><span class="line">    Handler mHandler=<span class="keyword">new</span> <span class="title class_">Handler</span>();</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IEmulatorCheck</span>.Stub() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmulator</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">                <span class="keyword">return</span> EmulatorDetectUtil.isEmulator(EmulatorCheckService.<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">kill</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">                stopSelf();</span><br><span class="line">                mHandler.postDelayed(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                       System.exit(<span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,<span class="number">500</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">        Process.killProcess(Process.myPid());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>EmulatorCheckService</code> 是一个标准的 Android <code>Service</code>。它的特殊之处在于，通过在 <code>AndroidManifest.xml</code> 文件中的配置，它运行在一个<strong>独立的私有进程</strong>中</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">&quot;.jni.EmulatorCheckService&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:process</span>=<span class="string">&quot;:EmulatorCheckService&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>onBind(Intent intent)</code> 方法</p>
<ul>
<li><strong>作用</strong>：这是 <code>Service</code> 与客户端（<code>EmuCheckUtil</code>）建立连接的入口点。当客户端调用 <code>bindService()</code> 时，Android 系统会调用这个方法。</li>
<li><strong>返回值</strong>：它必须返回一个 <code>IBinder</code> 对象，这个对象是客户端与服务端之间通信的桥梁。</li>
<li><strong>实现方式</strong>：这里直接返回了一个 <code>new IEmulatorCheck.Stub() &#123; ... &#125;</code> 的匿名内部类实例。<code>IEmulatorCheck.Stub</code> 是由 AIDL 工具根据 <code>IEmulatorCheck.aidl</code> 文件自动生成的。我们在这里继承 <code>Stub</code> 类并实现其抽象方法，这就构成了 AIDL 的<strong>服务端实现</strong>。</li>
</ul>
<p><code>isEmulator()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmulator</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="keyword">return</span> EmulatorDetectUtil.isEmulator(EmulatorCheckService.<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>作用</strong>：这是对 AIDL 接口中 <code>isEmulator()</code> 方法的具体实现。当客户端的代理对象调用 <code>isEmulator()</code> 时，经过一系列的 IPC（进程间通信）流程，最终会执行到这里的代码。</p>
</li>
<li><p><strong>核心逻辑</strong>：它没有自己实现检测逻辑，而是直接调用了 <code>EmulatorDetectUtil.isEmulator()</code>。</p>
</li>
<li><p><strong>关键点</strong>：因为 <code>EmulatorCheckService</code> 运行在独立的进程中</p>
<p>所以 <code>EmulatorDetectUtil.isEmulator()</code> 这个调用（以及它内部的 native 方法 <code>detectS()</code>）也<strong>发生在这个独立进程中</strong>。这就达到了将检测逻辑与主应用进程隔离的目的，极大地增加了 Hook 攻击的难度。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//antifake\src\main\java\com\snail\antifake\jni\EmulatorDetectUtil.java</span></span><br><span class="line">....</span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;emulator_check&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Keep</span></span><br><span class="line">    <span class="keyword">native</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">detectS</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同时考虑特征值跟cache</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isEmulator</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> detectS();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//CMakeList.txt</span><br><span class="line"><span class="keyword">add_library</span>(</span><br><span class="line">      <span class="comment"># 设置so文件名称.</span></span><br><span class="line">       emulator_check</span><br><span class="line">       <span class="comment"># 设置这个so文件为共享.</span></span><br><span class="line">       SHARED</span><br><span class="line">       <span class="comment"># Provides a relative path to your source file(s).</span></span><br><span class="line">       src/main/jni/emulator/emcheck64.c )</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">getArch</span><span class="params">(JNIEnv *env)</span> </span>&#123;</span><br><span class="line">    jclass cls = (*env)-&gt;<span class="built_in">FindClass</span>(env, <span class="string">&quot;com/snail/antifake/jni/EmulatorDetectUtil&quot;</span>);</span><br><span class="line">    jmethodID mid = (*env)-&gt;<span class="built_in">GetStaticMethodID</span>(env, cls, <span class="string">&quot;getSystemArch&quot;</span>, <span class="string">&quot;()I&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (jint) (*env)-&gt;<span class="built_in">CallStaticIntMethod</span>(env, cls, mid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">jboolean JNICALL <span class="title">detect</span><span class="params">(JNIEnv *env, jclass jclass1)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">load</span>(env);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> type = <span class="built_in">getArch</span>(env);</span><br><span class="line">    <span class="keyword">if</span> (type == <span class="number">0</span> || type == <span class="number">1</span>) &#123; <span class="keyword">return</span> JNI_TRUE; &#125;</span><br><span class="line">    <span class="type">char</span> code32[] =</span><br><span class="line">            <span class="string">&quot;\x04\xe0\x2d\xE5&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x20\xA0\xE3&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xA0\xE3&quot;</span></span><br><span class="line">            <span class="string">&quot;\x01\x20\x82\xE2&quot;</span></span><br><span class="line">            <span class="string">&quot;\x0c\x30\x4f\xe2&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x10\x93\xE5&quot;</span></span><br><span class="line">            <span class="string">&quot;\x01\x00\x80\xE2&quot;</span></span><br><span class="line">            <span class="string">&quot;\x0c\x30\x4f\xe2&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x10\x83\xE5&quot;</span></span><br><span class="line">            <span class="string">&quot;\x0A\x00\x50\xE3&quot;</span></span><br><span class="line">            <span class="string">&quot;\x02\x00\x00\xAA&quot;</span></span><br><span class="line">            <span class="string">&quot;\x0A\x00\x52\xE3&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\x00\xAA&quot;</span></span><br><span class="line">            <span class="string">&quot;\xf7\xff\xff\xea&quot;</span></span><br><span class="line">            <span class="string">&quot;\x04\xf0\x9d\xE4&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> code64[] =</span><br><span class="line">            <span class="string">&quot;\xff\xc3\x00\xd1&quot;</span><span class="comment">//	sub	sp, sp, #0x30</span></span><br><span class="line">            <span class="string">&quot;\xfd\x7b\x02\xa9&quot;</span><span class="comment">//	x29, x30, [sp,#32]</span></span><br><span class="line">            <span class="string">&quot;\x02\x00\x80\xd2&quot;</span><span class="comment">//	x2, #0x0</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\x80\xd2&quot;</span><span class="comment">//	mov	x0, #0x0</span></span><br><span class="line">            <span class="string">&quot;\x42\x04\x00\x91&quot;</span><span class="comment">//	add	x2, x2, #0x1</span></span><br><span class="line">            <span class="string">&quot;\xe3\xff\xff\x10&quot;</span><span class="comment">//	adr	x3, 18 &lt;smc&gt;</span></span><br><span class="line">            <span class="string">&quot;\x61\x00\x40\xf9&quot;</span><span class="comment">//	ldr	x1, [x3]</span></span><br><span class="line">            <span class="string">&quot;\x00\x04\x00\x91&quot;</span><span class="comment">//	add	x0, x0, #0x1</span></span><br><span class="line">            <span class="string">&quot;\xe3\xff\xff\x10&quot;</span><span class="comment">//	adr	x3, 24 &lt;code&gt;</span></span><br><span class="line">            <span class="string">&quot;\x61\x00\x00\xf9&quot;</span><span class="comment">//	str	x1, [x3]</span></span><br><span class="line">            <span class="string">&quot;\x1f\x28\x00\xf1&quot;</span> <span class="comment">//	cmp	x0, #0xa</span></span><br><span class="line">            <span class="string">&quot;\x8a\x00\x00\x54&quot;</span><span class="comment">//	b.ge	44 &lt;out&gt;</span></span><br><span class="line">            <span class="string">&quot;\x5f\x28\x00\xf1&quot;</span>  <span class="comment">//	cmp	x2, #0xa</span></span><br><span class="line">            <span class="string">&quot;\x4a\x00\x00\x54&quot;</span><span class="comment">//	b.ge	44 &lt;out&gt;</span></span><br><span class="line">            <span class="string">&quot;\xf9\xff\xff\x17&quot;</span><span class="comment">//	b	24 &lt;code&gt;</span></span><br><span class="line">            <span class="string">&quot;\xfd\x7b\x42\xa9&quot;</span><span class="comment">//	ldp	x29, x30, [sp,#32]</span></span><br><span class="line">            <span class="string">&quot;\xff\xc3\x00\x91&quot;</span><span class="comment">//	add	sp, sp, #0x30</span></span><br><span class="line">            <span class="string">&quot;\xc0\x03\x5f\xd6&quot;</span> <span class="comment">//	ret</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span> <span class="comment">//	nop</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span> <span class="comment">//	nop</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span> <span class="comment">//	nop</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span> <span class="comment">//	nop</span></span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">//   LOGI(&quot; start  detect&quot;);</span></span><br><span class="line">    <span class="type">void</span> *exec = <span class="built_in">mmap</span>(<span class="literal">NULL</span>, (<span class="type">size_t</span>) <span class="built_in">getpagesize</span>(), PROT, MAP_ANONYMOUS | MAP_PRIVATE, <span class="number">-1</span>,</span><br><span class="line">                      (<span class="type">off_t</span>) <span class="number">0</span>);</span><br><span class="line"><span class="comment">//    LOGI(&quot; mmap sucess exec  %x  %d &quot;, exec,(size_t) getpagesize());</span></span><br><span class="line">    <span class="keyword">if</span> (exec == (<span class="type">void</span> *) <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="type">int</span> fd = <span class="built_in">fopen</span>(<span class="string">&quot;/dev/zero&quot;</span>, <span class="string">&quot;w+&quot;</span>);</span><br><span class="line">        exec = <span class="built_in">mmap</span>(<span class="literal">NULL</span>, (<span class="type">size_t</span>) <span class="built_in">getpagesize</span>(), PROT, MAP_PRIVATE, fd, (<span class="type">off_t</span>) <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (exec == (<span class="type">void</span> *) <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (type == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(exec, code32, <span class="built_in">sizeof</span>(code32));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(exec, code64, <span class="built_in">sizeof</span>(code64));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    LOGI(&quot; mmap copy  exec  %x&quot;, exec);</span></span><br><span class="line">    <span class="comment">//如果不是 (size_t) getpagesize() 是sizeof（code），就必须加上LOGI(&quot; mmap sucess exec  %x&quot;, exec); ，才能降低崩溃概率，这尼玛操蛋</span></span><br><span class="line">    asmcheck = (<span class="type">int</span> *) exec;</span><br><span class="line">    __clear_cache(exec, exec + (<span class="type">size_t</span>) <span class="built_in">getpagesize</span>());</span><br><span class="line">    a = <span class="built_in">asmcheck</span>();</span><br><span class="line"><span class="comment">//        LOGI(&quot; ret --  %x&quot;, a);</span></span><br><span class="line">    <span class="built_in">munmap</span>(exec, <span class="built_in">getpagesize</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来到了检测模拟器的native层函数，详细分析如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> type = getArch(env);</span><br><span class="line"><span class="keyword">if</span> (type == <span class="number">0</span> || type == <span class="number">1</span>) &#123; <span class="keyword">return</span> JNI_TRUE; &#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><strong>获取架构</strong>：代码首先通过 JNI 回调 <code>EmulatorDetectUtil.getSystemArch()</code> 方法。这个 Java 方法会读取系统属性 <code>ro.product.cpu.abi</code> 来获取当前的 CPU ABI（应用二进制接口）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getSystemArch</span><span class="params">()</span> &#123;</span><br><span class="line">    String cpuAbi=  PropertiesGet.getString(<span class="string">&quot;ro.product.cpu.abi&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;armeabi-v7a&quot;</span>.equals(cpuAbi))</span><br><span class="line">        <span class="keyword">return</span> Arch.ARM32;</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;arm64-v8a&quot;</span>.equals(cpuAbi))</span><br><span class="line">        <span class="keyword">return</span> Arch.ARM64;</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;x86&quot;</span>.equals(cpuAbi)  )</span><br><span class="line">        <span class="keyword">return</span> Arch.X86;</span><br><span class="line">    <span class="keyword">if</span>(  <span class="string">&quot;x86_64&quot;</span>.equals(cpuAbi))</span><br><span class="line">        <span class="keyword">return</span> Arch.X86_64;</span><br><span class="line">    <span class="keyword">return</span> Arch.ARM64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>判断架构</strong>：</p>
<ul>
<li><code>type == 0</code> 对应 <code>x86</code></li>
<li><code>type == 1</code> 对应 <code>x86_64</code></li>
</ul>
</li>
<li><p><strong>判定结果</strong>：如果检测到 CPU 是 x86 或 x86_64 架构，函数就**立即返回 <code>JNI_TRUE</code>**，判定当前环境为模拟器</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">    <span class="type">char</span> code32[] =</span><br><span class="line">            <span class="string">&quot;\x04\xe0\x2d\xE5&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x20\xA0\xE3&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xA0\xE3&quot;</span></span><br><span class="line">            <span class="string">&quot;\x01\x20\x82\xE2&quot;</span></span><br><span class="line">            <span class="string">&quot;\x0c\x30\x4f\xe2&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x10\x93\xE5&quot;</span></span><br><span class="line">            <span class="string">&quot;\x01\x00\x80\xE2&quot;</span></span><br><span class="line">            <span class="string">&quot;\x0c\x30\x4f\xe2&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x10\x83\xE5&quot;</span></span><br><span class="line">            <span class="string">&quot;\x0A\x00\x50\xE3&quot;</span></span><br><span class="line">            <span class="string">&quot;\x02\x00\x00\xAA&quot;</span></span><br><span class="line">            <span class="string">&quot;\x0A\x00\x52\xE3&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\x00\xAA&quot;</span></span><br><span class="line">            <span class="string">&quot;\xf7\xff\xff\xea&quot;</span></span><br><span class="line">            <span class="string">&quot;\x04\xf0\x9d\xE4&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> code64[] =</span><br><span class="line">            <span class="string">&quot;\xff\xc3\x00\xd1&quot;</span><span class="comment">//	sub	sp, sp, #0x30</span></span><br><span class="line">            <span class="string">&quot;\xfd\x7b\x02\xa9&quot;</span><span class="comment">//	x29, x30, [sp,#32]</span></span><br><span class="line">            <span class="string">&quot;\x02\x00\x80\xd2&quot;</span><span class="comment">//	x2, #0x0</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\x80\xd2&quot;</span><span class="comment">//	mov	x0, #0x0</span></span><br><span class="line">            <span class="string">&quot;\x42\x04\x00\x91&quot;</span><span class="comment">//	add	x2, x2, #0x1</span></span><br><span class="line">            <span class="string">&quot;\xe3\xff\xff\x10&quot;</span><span class="comment">//	adr	x3, 18 &lt;smc&gt;</span></span><br><span class="line">            <span class="string">&quot;\x61\x00\x40\xf9&quot;</span><span class="comment">//	ldr	x1, [x3]</span></span><br><span class="line">            <span class="string">&quot;\x00\x04\x00\x91&quot;</span><span class="comment">//	add	x0, x0, #0x1</span></span><br><span class="line">            <span class="string">&quot;\xe3\xff\xff\x10&quot;</span><span class="comment">//	adr	x3, 24 &lt;code&gt;</span></span><br><span class="line">            <span class="string">&quot;\x61\x00\x00\xf9&quot;</span><span class="comment">//	str	x1, [x3]</span></span><br><span class="line">            <span class="string">&quot;\x1f\x28\x00\xf1&quot;</span> <span class="comment">//	cmp	x0, #0xa</span></span><br><span class="line">            <span class="string">&quot;\x8a\x00\x00\x54&quot;</span><span class="comment">//	b.ge	44 &lt;out&gt;</span></span><br><span class="line">            <span class="string">&quot;\x5f\x28\x00\xf1&quot;</span>  <span class="comment">//	cmp	x2, #0xa</span></span><br><span class="line">            <span class="string">&quot;\x4a\x00\x00\x54&quot;</span><span class="comment">//	b.ge	44 &lt;out&gt;</span></span><br><span class="line">            <span class="string">&quot;\xf9\xff\xff\x17&quot;</span><span class="comment">//	b	24 &lt;code&gt;</span></span><br><span class="line">            <span class="string">&quot;\xfd\x7b\x42\xa9&quot;</span><span class="comment">//	ldp	x29, x30, [sp,#32]</span></span><br><span class="line">            <span class="string">&quot;\xff\xc3\x00\x91&quot;</span><span class="comment">//	add	sp, sp, #0x30</span></span><br><span class="line">            <span class="string">&quot;\xc0\x03\x5f\xd6&quot;</span> <span class="comment">//	ret</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span> <span class="comment">//	nop</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span> <span class="comment">//	nop</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span> <span class="comment">//	nop</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span> <span class="comment">//	nop</span></span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">//   LOGI(&quot; start  detect&quot;);</span></span><br><span class="line">    <span class="type">void</span> *exec = mmap(<span class="literal">NULL</span>, (<span class="type">size_t</span>) getpagesize(), PROT, MAP_ANONYMOUS | MAP_PRIVATE, <span class="number">-1</span>,</span><br><span class="line">                      (<span class="type">off_t</span>) <span class="number">0</span>);</span><br><span class="line"><span class="comment">//    LOGI(&quot; mmap sucess exec  %x  %d &quot;, exec,(size_t) getpagesize());</span></span><br><span class="line">    <span class="keyword">if</span> (exec == (<span class="type">void</span> *) <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="type">int</span> fd = fopen(<span class="string">&quot;/dev/zero&quot;</span>, <span class="string">&quot;w+&quot;</span>);</span><br><span class="line">        exec = mmap(<span class="literal">NULL</span>, (<span class="type">size_t</span>) getpagesize(), PROT, MAP_PRIVATE, fd, (<span class="type">off_t</span>) <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (exec == (<span class="type">void</span> *) <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (type == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(exec, code32, <span class="keyword">sizeof</span>(code32));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(exec, code64, <span class="keyword">sizeof</span>(code64));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    LOGI(&quot; mmap copy  exec  %x&quot;, exec);</span></span><br><span class="line">    <span class="comment">//如果不是 (size_t) getpagesize() 是sizeof（code），就必须加上LOGI(&quot; mmap sucess exec  %x&quot;, exec); ，才能降低崩溃概率，这尼玛操蛋</span></span><br><span class="line">    asmcheck = (<span class="type">int</span> *) exec;</span><br><span class="line">    __clear_cache(exec, exec + (<span class="type">size_t</span>) getpagesize());</span><br><span class="line">    a = asmcheck();</span><br><span class="line"><span class="comment">//        LOGI(&quot; ret --  %x&quot;, a);</span></span><br><span class="line">    munmap(exec, getpagesize());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a == <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>利用了真实 ARM 硬件分离的 I&#x2F;D Cache 与 QEMU 动态翻译引擎在处理自修改代码时的缓存一致性行为差异来区分模拟器</p>
<blockquote>
<p><strong>真机 (ARM CPU) 的行为</strong></p>
<ul>
<li><strong>哈佛&#x2F;改进型哈佛架构 (Harvard&#x2F;Modified Harvard Architecture)<strong>：现代高性能 ARM 内核（如 Cortex-A 系列）普遍采用这种架构。其核心特征就是</strong>指令总线和数据总线分离</strong>，从而实现了独立的指令缓存（I-Cache）和数据缓存（D-Cache）。</li>
<li><strong>缓存一致性问题 (Cache Coherency Problem)<strong>：当一个 CPU 核心执行 <code>STR</code> (Store) 指令修改一段内存时，这个写操作是通过数据路径进行的，它会更新 D-Cache 和最终的主存。然而，如果被修改的内存区域恰好也作为指令被加载到了 I-Cache 中，硬件本身</strong>不会</strong>自动使 I-Cache 中对应的缓存行（Cache Line）失效。</li>
<li><strong><code>__clear_cache</code> 的必要性</strong>：为了解决这个问题，ARM 架构提供了特定的指令（如 <code>IC IALLU</code>, <code>DC CIVAC</code>）和相应的系统调用（最终由内核实现），允许软件显式地管理缓存。<code>__clear_cache</code> 这个 GCC 内建函数（或类似的库函数）就是上层对这些底层操作的封装。它的作用是：<ol>
<li>将 D-Cache 中被修改的数据写回到主存（Write-Back&#x2F;Clean）。</li>
<li>使 I-Cache 中覆盖了相同内存地址的缓存行失效（Invalidate）。 这样，当 CPU 再次从该地址取指时，由于 I-Cache Miss，它会从主存中重新加载最新的、已被修改的指令。</li>
</ol>
</li>
<li><strong>检测利用点</strong>：如果不调用 <code>__clear_cache</code>，CPU 就会执行 I-Cache 中陈旧的指令，导致程序行为与预期不符。</li>
</ul>
<p><strong>模拟器 (QEMU) 的行为</strong></p>
<ul>
<li>**动态二进制翻译 (Dynamic Binary Translation - DBT)**：QEMU 的核心是它的 TCG (Tiny Code Generator)。它并非逐条解释执行 ARM 指令，而是将一个 ARM 指令块（Guest Code）动态翻译成一段等效的、能在宿主 CPU（Host CPU，通常是 x86）上直接运行的机器码块（Host Code）。</li>
<li><strong>翻译缓存与内存监控</strong>：QEMU 会缓存这些翻译好的代码块。为了保证正确性，QEMU 必须监控被模拟的客户机内存（Guest Memory）。当 QEMU 检测到一段已经被翻译过的 Guest Code 所在的内存区域被写操作修改时，它会<strong>废弃（Invalidate）</strong>掉对应的、已缓存的 Host Code。</li>
<li><strong>重新翻译 (Re-translation)<strong>：当模拟的程序流程再次跳转到那段被修改过的地址时，QEMU 会发现没有可用的翻译缓存，于是它会重新从 Guest Memory 中读取</strong>最新的指令</strong>，进行新一轮的翻译和执行。</li>
<li><strong>检测利用点</strong>：QEMU 的这种为保证模拟正确性而设计的机制，恰好“完美”地处理了自修改代码。它表现出的行为，等同于一个<strong>缓存永远同步</strong>的理想化处理器。</li>
</ul>
</blockquote>
<p>说白了就是真机的<code>i-cache</code>和<code>d-cache</code>是不是随时同步的，当<code>i-cache</code>调用<code>STR(store)</code>指令时，是通过数据总线来更新<code>d-cache</code>和主存的，如果此时没及时调用<code>__clear_cache</code>的话，也会继续执行当前<code>cache line</code>的代码</p>
<blockquote>
<p><code>cache line</code>就是 <strong>CPU 缓存 (Cache) 和主内存 (RAM) 之间数据传输的最小单位</strong>（毕竟如果一个字节一个字节从CPU中读取的话，那么太浪费资源了，因此就直接读很多个字节（称之为<code>cache line</code>），常见的大小是 32 字节、64 字节或 128 字节</p>
</blockquote>
<p>而模拟器一般都是缓存永远同步的，即会执行最新修改的代码</p>
<p>这里利用的就是在真机中如果不调用 <code>__clear_cache</code>，CPU 就会执行 <code>I-Cache</code> 中陈旧的指令，导致程序行为与预期不符</p>
<blockquote>
<p><code>__clear_cache</code> 的作用就是 强制<strong>冲刷流水线（Pipeline Flush）</strong>并使 <code>I-Cache</code> 失效</p>
</blockquote>
<h3 id="onCreate-1"><a href="#onCreate-1" class="headerlink" title="onCreate"></a>onCreate</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  UI进程检测，可能影响UI线程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">binding.btnSycnSycSimu.<span class="built_in">setOnClickListener</span>(<span class="keyword">new</span> View.<span class="built_in">OnClickListener</span>() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="type">void</span> <span class="built_in">onClick</span>(View v) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            TextView textView = (TextView) <span class="built_in">findViewById</span>(R.id.btn_sycn_syc_simu);</span><br><span class="line">            textView.<span class="built_in">setText</span>(<span class="string">&quot; 内存同步是否模拟器 &quot;</span> + EmulatorDetectUtil.<span class="built_in">isEmulator</span>(MainActivity.<span class="keyword">this</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>通过<code>EmulatorDetectUtil.isEmulator(MainActivity.this)</code>来检测<code>UI</code>进程</p>
<p><strong>同步的、在当前线程和当前进程中</strong>执行的方法调用</p>
<p>而上面那种是<strong>异步的、通过AIDL在另一个服务进程中</strong>执行的方法调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//        特征值判断是否模拟器</span></span><br><span class="line">        binding.btnSample.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                <span class="type">TextView</span> <span class="variable">textView</span> <span class="operator">=</span> (TextView) findViewById(R.id.btn_sample);</span><br><span class="line">                textView.setText(<span class="string">&quot;特征信息判断是否模拟器 &quot;</span> + AndroidDeviceIMEIUtil.isRunOnEmulator(MainActivity.<span class="built_in">this</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>调用<code>AndroidDeviceIMEIUtil.isRunOnEmulator(MainActivity.this)</code>方法来特征检测</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AndroidDeviceIMEIUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isRunOnEmulator</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> EmuCheckUtil.mayOnEmulator(context);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">mayOnEmulator</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mayOnEmulatorViaQEMU(context)</span><br><span class="line">            || isEmulatorViaBuild(context)</span><br><span class="line">            || isEmulatorFromAbi()</span><br><span class="line">            || isEmulatorFromCpu();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="mayOnEmulatorViaQEMU"><a href="#mayOnEmulatorViaQEMU" class="headerlink" title="mayOnEmulatorViaQEMU"></a>mayOnEmulatorViaQEMU</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  qemu模拟器特征</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">mayOnEmulatorViaQEMU</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">qemu</span> <span class="operator">=</span> PropertiesGet.getString(<span class="string">&quot;ro.kernel.qemu&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>.equals(qemu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中getString函数如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.snail.antifake.jni;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Author: snail</span></span><br><span class="line"><span class="comment"> * Data: 2017/7/20 上午9:11</span></span><br><span class="line"><span class="comment"> * Des:</span></span><br><span class="line"><span class="comment"> * version:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PropertiesGet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;property_get&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title function_">native_get</span><span class="params">(String key)</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title function_">native_get</span><span class="params">(String key,String def)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getString</span><span class="params">(String key)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> native_get(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getString</span><span class="params">(String key,String def)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> native_get(key,def);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是通过native获得</p>
<p>在cmake中</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_library</span>(</span><br><span class="line">      <span class="comment"># 设置so文件名称.</span></span><br><span class="line">       property_get</span><br><span class="line">       <span class="comment"># 设置这个so文件为共享.</span></span><br><span class="line">       SHARED</span><br><span class="line">       <span class="comment"># Provides a relative path to your source file(s).</span></span><br><span class="line">       src/main/jni/property/proget.c)</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/system_properties.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO,<span class="string">&quot;lishang&quot;</span>,__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function"><span class="title">proGetSS</span></span></span><br><span class="line"><span class="function">        <span class="params">(JNIEnv *env, jclass clazz, jstring keyJ, jstring defJ)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *key;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    jstring rvJ = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (keyJ == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">LOGI</span>(<span class="string">&quot;key must not be null.&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    key = (*env)-&gt;<span class="built_in">GetStringUTFChars</span>(env, keyJ, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    len = __system_property_get(key, buf);</span><br><span class="line">    <span class="keyword">if</span> ((len &lt;= <span class="number">0</span>) &amp;&amp; (defJ != <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        rvJ = defJ;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        rvJ = (*env)-&gt;<span class="built_in">NewStringUTF</span>(env, buf);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        rvJ = (*env)-&gt;<span class="built_in">NewStringUTF</span>(env, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    (*env)-&gt;<span class="built_in">ReleaseStringUTFChars</span>(env, keyJ, key);</span><br><span class="line"></span><br><span class="line">    error:</span><br><span class="line">    <span class="keyword">return</span> rvJ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function">    <span class="title">proGet</span><span class="params">(JNIEnv *env, jclass clazz, jstring keyJ)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">proGetSS</span>(env, clazz, keyJ, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">registerNativeMethods</span><span class="params">(JNIEnv *env, <span class="type">const</span> <span class="type">char</span> *className,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 JNINativeMethod *gMethods, <span class="type">int</span> numMethods)</span> </span>&#123;</span><br><span class="line">    jclass clazz;</span><br><span class="line"></span><br><span class="line">    clazz = (*env)-&gt;<span class="built_in">FindClass</span>(env, className);</span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((*env)-&gt;<span class="built_in">RegisterNatives</span>(env, clazz, gMethods, numMethods) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> JNI_TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *classPathName = <span class="string">&quot;com/snail/antifake/jni/PropertiesGet&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> JNINativeMethod methods[] = &#123;</span><br><span class="line">        &#123;<span class="string">&quot;native_get&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, (<span class="type">void</span> *) proGet&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;native_get&quot;</span>, <span class="string">&quot;(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;&quot;</span>, (<span class="type">void</span> *) proGetSS&#125;,</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="type">void</span>* reserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    JNIEnv* env = <span class="literal">NULL</span>;</span><br><span class="line">    jint result = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((*vm)-&gt;<span class="built_in">GetEnv</span>(vm, (<span class="type">void</span>**) &amp;env, JNI_VERSION_1_4) != JNI_OK)</span><br><span class="line">        <span class="keyword">goto</span> bail;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">registerNativeMethods</span>(env, classPathName, methods, <span class="built_in">sizeof</span>(methods)/<span class="built_in">sizeof</span>(methods[<span class="number">0</span>])))</span><br><span class="line">        <span class="keyword">goto</span> bail;</span><br><span class="line"></span><br><span class="line">    result = JNI_VERSION_1_4;</span><br><span class="line"></span><br><span class="line">    bail:</span><br><span class="line">    <span class="comment">//LOGI(&quot;Leaving JNI_OnLoad (result=0x%x)\n&quot;, result);</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先通过<code>registerNativeMethods</code>注册<code>com/snail/antifake/jni/PropertiesGet</code>下的两个方法</p>
<p>然后<code>proGet</code>和<code>proGetSS</code>的返回值变量类型定义为<code>JNIEXPORT jstring JNICALL</code></p>
<ul>
<li><code>JNIEXPORT</code> 的核心作用是<strong>将 native 函数标记为 “可导出符号”</strong></li>
<li><code>JNICALL</code> 的作用是<strong>统一函数的调用约定</strong></li>
<li><code>jstring</code>：是函数的<strong>返回值类型</strong>，对应 Java 中的 <code>String</code> 类型</li>
</ul>
<p><code>len = __system_property_get(key, buf);</code>主要是通过这个函数读取相应的数据</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __system_property_get(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">char</span> *value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 数据已经存储在共享内存中，通过__system_property_area__ 即可获取到，之后等待读取完返回</span></span><br><span class="line">    <span class="type">const</span> prop_info *pi = __system_property_find(name);</span><br><span class="line">    <span class="keyword">if</span>(pi != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> __system_property_read(pi, <span class="number">0</span>, value); <span class="comment">// 阻塞式读取</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        value[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="isEmulatorViaBuild"><a href="#isEmulatorViaBuild" class="headerlink" title="isEmulatorViaBuild"></a>isEmulatorViaBuild</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isEmulatorViaBuild</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(PropertiesGet.getString(<span class="string">&quot;ro.product.model&quot;</span>))</span><br><span class="line">            &amp;&amp; PropertiesGet.getString(<span class="string">&quot;ro.product.model&quot;</span>).toLowerCase().contains(<span class="string">&quot;sdk&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ro.product.manufacturer likes unknown</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(PropertiesGet.getString(<span class="string">&quot;ro.product.manufacturer&quot;</span>))</span><br><span class="line">            &amp;&amp; PropertiesGet.getString(<span class="string">&quot;ro.product.manufacture&quot;</span>).toLowerCase().contains(<span class="string">&quot;unknown&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ro.product.device likes generic</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(PropertiesGet.getString(<span class="string">&quot;ro.product.device&quot;</span>))</span><br><span class="line">            &amp;&amp; PropertiesGet.getString(<span class="string">&quot;ro.product.device&quot;</span>).toLowerCase().contains(<span class="string">&quot;generic&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ro.product.model</code>: 这是一个系统属性，通常表示<strong>设备的型号</strong>。在模拟器环境中，这个值经常包含 “sdk” 字样，例如 “sdk_gphone_x86”、”Android SDK built for x86” 等。</li>
<li><code>ro.product.manufacturer</code>: 这是一个系统属性，表示<strong>设备的制造商</strong>。在某些模拟器（尤其是 Genymotion 或一些早期模拟器）中，这个值可能被设置为 “unknown” 或其他非真实制造商的字符串。</li>
<li><code>ro.product.device</code>: 这是一个系统属性，表示设<strong>备的代号或名称</strong>。Android 模拟器（AVD）通常会使用 “generic” 作为其设备名称的一部分，例如 “generic_x86”、”generic_arm64” 等。</li>
</ul>
<h4 id="isEmulatorFromAbi"><a href="#isEmulatorFromAbi" class="headerlink" title="isEmulatorFromAbi"></a>isEmulatorFromAbi</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isEmulatorFromAbi</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    String abi= AndroidDeviceIMEIUtil.getCpuAbi();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> !TextUtils.isEmpty(abi) &amp;&amp; abi.contains(<span class="string">&quot;x86&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCpuAbi</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.cpu.abi&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过架构来判断模拟器</p>
<h4 id="isEmulatorFromCpu"><a href="#isEmulatorFromCpu" class="headerlink" title="isEmulatorFromCpu"></a>isEmulatorFromCpu</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查杀比较严格，放在最后，直接pass x86</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isEmulatorFromCpu</span><span class="params">()</span> &#123;</span><br><span class="line">    ShellAdbUtils.<span class="type">CommandResult</span> <span class="variable">commandResult</span> <span class="operator">=</span> ShellAdbUtils.execCommand(<span class="string">&quot;cat /proc/cpuinfo&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">cpuInfo</span> <span class="operator">=</span> commandResult == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : commandResult.successMsg;</span><br><span class="line">    <span class="keyword">return</span> !TextUtils.isEmpty(cpuInfo) &amp;&amp; ((cpuInfo.toLowerCase().contains(<span class="string">&quot;intel&quot;</span>) || cpuInfo.toLowerCase().contains(<span class="string">&quot;amd&quot;</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接通过命令行获取cpu信息，如果是intel或者amd的直接杀死</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CommandResult <span class="title function_">execCommand</span><span class="params">(String[] commands, <span class="type">boolean</span> isRoot, <span class="type">boolean</span> isNeedResultMsg)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (commands == <span class="literal">null</span> || commands.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommandResult</span>(result, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">successResult</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">errorResult</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">successMsg</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">errorMsg</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">DataOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        process = Runtime.getRuntime().exec(isRoot ? COMMAND_SU : COMMAND_SH);</span><br><span class="line">        os = <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(process.getOutputStream());</span><br><span class="line">        <span class="keyword">for</span> (String command : commands) &#123;</span><br><span class="line">            <span class="keyword">if</span> (command == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// donnot use os.writeBytes(commmand), avoid chinese charset error</span></span><br><span class="line">            os.write(command.getBytes());</span><br><span class="line">            os.writeBytes(COMMAND_LINE_END);</span><br><span class="line">            os.flush();</span><br><span class="line">        &#125;</span><br><span class="line">        os.writeBytes(COMMAND_EXIT);</span><br><span class="line">        os.flush();</span><br><span class="line"></span><br><span class="line">        result = process.waitFor();</span><br><span class="line">        <span class="comment">// get command result</span></span><br><span class="line">        <span class="keyword">if</span> (isNeedResultMsg) &#123;</span><br><span class="line">            successMsg = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            errorMsg = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            successResult = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">            errorResult = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getErrorStream()));</span><br><span class="line">            String s;</span><br><span class="line">            <span class="keyword">while</span> ((s = successResult.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                successMsg.append(s);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> ((s = errorResult.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                errorMsg.append(s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (os != <span class="literal">null</span>) &#123;</span><br><span class="line">                os.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (successResult != <span class="literal">null</span>) &#123;</span><br><span class="line">                successResult.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (errorResult != <span class="literal">null</span>) &#123;</span><br><span class="line">                errorResult.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (process != <span class="literal">null</span>) &#123;</span><br><span class="line">            process.destroy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommandResult</span>(result, successMsg == <span class="literal">null</span> ? <span class="literal">null</span> : successMsg.toString(), errorMsg == <span class="literal">null</span> ? <span class="literal">null</span></span><br><span class="line">            : errorMsg.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>process = Runtime.getRuntime().exec(isRoot ? COMMAND_SU : COMMAND_SH);</code>运行一个shell</p>
<ul>
<li>通过 <code>DataOutputStream os = new DataOutputStream(process.getOutputStream());</code> 获取到子进程的标准输入流</li>
<li>代码会遍历 <code>commands</code> 数组，将每一条命令写入这个流中</li>
<li>每条命令后都会写入一个换行符 <code>COMMAND_LINE_END</code>，这模拟了回车操作，是命令得以执行的前提</li>
<li>在所有命令都写入后，会写入 <code>COMMAND_EXIT</code> 命令。这会使 <code>su</code> 或 <code>sh</code> 进程正常退出，从而让 <code>process.waitFor()</code> 调用可以结束等待。如果没有这一步，程序会永久阻塞</li>
<li><code>result = process.waitFor();</code>: 这行代码会阻塞当前线程，直到子进程执行完毕并返回退出码。</li>
<li>如果 <code>isNeedResultMsg</code> 为 <code>true</code>，代码会创建 <code>BufferedReader</code> 来分别读取子进程的标准输出流 (<code>process.getInputStream()</code>) 和标准错误流 (<code>process.getErrorStream()</code>)，并将结果存入 <code>StringBuilder</code></li>
</ul>
<h3 id="onCreate-2"><a href="#onCreate-2" class="headerlink" title="onCreate"></a>onCreate</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//        综合判断一次</span></span><br><span class="line">        binding.btnSycnInteger.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                <span class="type">TextView</span> <span class="variable">textView</span> <span class="operator">=</span> (TextView) findViewById(R.id.btn_sycn_integer);</span><br><span class="line">                textView.setText(<span class="string">&quot;综合判断是否模拟器 &quot;</span> + EmulatorDetectUtil.isEmulatorFromAll(MainActivity.<span class="built_in">this</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 只考虑cache，Android R之后，模拟器机制有变化，检测会有问题</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isEmulatorFromAll</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> AndroidDeviceIMEIUtil.isRunOnEmulator(context) || detectS();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就是上述几个判断的合体</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//获取其他硬件信息</span></span><br><span class="line">    binding.btnHwinfo.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">            requestGetInfo();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="meta">@SuppressLint(&quot;SetTextI18n&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestGetInfo</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不同的版本不一样，4.3之前ITelephony没有getDeviceId</span></span><br><span class="line">    <span class="keyword">if</span> (ActivityCompat.checkSelfPermission(MainActivity.<span class="built_in">this</span>, Manifest.permission.READ_PHONE_STATE) != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        ActivityCompat.requestPermissions(MainActivity.<span class="built_in">this</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;Manifest.permission.READ_PHONE_STATE&#125;,</span><br><span class="line">                <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        renderHWInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先会检测是否有<code>PackageManager.PERMISSION_GRANTED</code>权限</p>
<p>如果没权限会执行<code>ActivityCompat.requestPermissions</code>弹出一个对话框，请求用户添加权限</p>
<p>如果权限已经被授予，则会执行<code>renderHWInfo();</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressLint(&quot;SetTextI18n&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">renderHWInfo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">apideviceId</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        apideviceId = ((TelephonyManager) getSystemService(Context.TELEPHONY_SERVICE)).getDeviceId();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    binding.tvDeviceid.setText(</span><br><span class="line">            <span class="string">&quot; \n \n设备信息 &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;  \n\n最终方法获取IMEI  : &quot;</span> + AndroidDeviceIMEIUtil.getDeviceId(mActivity) + <span class="string">&quot; 是否有效 &quot;</span> + AndroidDeviceIMEIUtil.isValidIMEI(AndroidDeviceIMEIUtil.getDeviceId(mActivity))</span><br><span class="line">                    + <span class="string">&quot;\n最终方法获取MAC地址 : &quot;</span> + AndroidDeviceIMEIUtil.getMacAddress(mActivity) + <span class="string">&quot; 是否有效 &quot;</span> + AndroidDeviceIMEIUtil.isValidAddress(MacAddressUtils.getMacAddress(mActivity))</span><br><span class="line">                    + <span class="string">&quot;\n最终方法获取AndroidID : &quot;</span> + AndroidDeviceIMEIUtil.getAndroidId(mActivity)</span><br><span class="line">                    + <span class="string">&quot;\n最终方法获取序列号 : &quot;</span> + AndroidDeviceIMEIUtil.getSerialno()</span><br><span class="line">                    + <span class="string">&quot;\n特征值检测是否模拟器  : &quot;</span> + EmuCheckUtil.mayOnEmulator(mActivity)</span><br><span class="line">                    + <span class="string">&quot; \n\nIMEI详细信息: &quot;</span></span><br><span class="line">                    + <span class="string">&quot; \n\n可Hook系统API获取Deviceid: &quot;</span> + apideviceId</span><br><span class="line">                    + <span class="string">&quot;\nProxy代理获取Deviceid level0 : &quot;</span> + IPhoneSubInfoUtil.getDeviceIdLevel0(mActivity)</span><br><span class="line">                    + <span class="string">&quot;\nProxy代理获取Deviceid level1 :&quot;</span> + IPhoneSubInfoUtil.getDeviceIdLevel1(mActivity)</span><br><span class="line">                    + <span class="string">&quot;\nProxy代理获取Deviceid level2 :&quot;</span> + IPhoneSubInfoUtil.getDeviceIdLevel2(mActivity)</span><br><span class="line">                    + <span class="string">&quot;\nITelephonyUtil获取DeviceId level0: &quot;</span> + ITelephonyUtil.getDeviceIdLevel0(mActivity)</span><br><span class="line">                    + <span class="string">&quot;\nITelephonyUtil获取DeviceId level1 : &quot;</span> + ITelephonyUtil.getDeviceIdLevel1(mActivity)</span><br><span class="line">                    + <span class="string">&quot;\nITelephonyUtil获取DeviceId level2 :&quot;</span> + ITelephonyUtil.getDeviceIdLevel2(mActivity)</span><br><span class="line">                 );</span><br><span class="line"></span><br><span class="line">    binding.tvAndroididMacSerial.setText(<span class="string">&quot;\n\n序列号信息 ：&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  \n\n系统API反射获取序列号 ： &quot;</span> + SysAPIUtil.getSerialNumber(mActivity)</span><br><span class="line">            + <span class="string">&quot;\n系统API反射获取序列号 ： &quot;</span> + SysAPIUtil.getJavaSerialNumber(mActivity)</span><br><span class="line">            + <span class="string">&quot;\n直接通过 Build Serial &quot;</span> + Build.SERIAL</span><br><span class="line">            + <span class="string">&quot;\n通过ADB Build Serial &quot;</span> + AndroidDeviceIMEIUtil.getSerialno()</span><br><span class="line">            + <span class="string">&quot;\n直接native获取  Serial &quot;</span> + PropertiesGet.getString(<span class="string">&quot;ro.serialno&quot;</span>)</span><br><span class="line">            + <span class="string">&quot;\n\nMAC地址信息 ：&quot;</span></span><br><span class="line">            + <span class="string">&quot;\n\n通过系统API获取MAC地址  ： &quot;</span> + SysAPIUtil.getMacAddress(mActivity)</span><br><span class="line">            + <span class="string">&quot;\nIwifmanager 获取mac level 0  ： &quot;</span> + IWifiManagerUtil.getMacAddress(mActivity)</span><br><span class="line">            + <span class="string">&quot;\n通过NetworkInterface获取MAC地址  ： &quot;</span> + MacAddressUtils.getMacAddressByWlan0(mActivity)</span><br><span class="line">            + <span class="string">&quot;\n通过ADB获取MAC地址  ： &quot;</span> + MacAddressUtils.getMacInfoByAdb()</span><br><span class="line"></span><br><span class="line">            + <span class="string">&quot;\n\nAndroidID信息 ：&quot;</span></span><br><span class="line">            + <span class="string">&quot;\n\n通过系统API获取ANDROID_ID (XPOSED可以HOOK)  ： &quot;</span> + SysAPIUtil.getAndroidId(mActivity)</span><br><span class="line">            + <span class="string">&quot;\n反射获取系统 ANDROID_IDISettingUtils  ： &quot;</span> + ISettingUtils.getAndroidProperty(mActivity, Settings.Secure.ANDROID_ID)</span><br><span class="line">            + <span class="string">&quot;\n反射获取系统 ANDROID_ID ISettingUtils level2  ： &quot;</span> + ISettingUtils.getAndroidPropertyLevel1(mActivity, Settings.Secure.ANDROID_ID)</span><br><span class="line">            + <span class="string">&quot;\n\n其他手机型号信息 ：&quot;</span></span><br><span class="line">            + <span class="string">&quot;\n系统API获取手机型号 （作假）  ： &quot;</span> + SysAPIUtil.getPhoneManufacturer()</span><br><span class="line">            + <span class="string">&quot;\nnative ro.product.manufacturer&quot;</span> + PropertiesGet.getString(<span class="string">&quot;ro.product.manufacturer&quot;</span>)</span><br><span class="line">            + <span class="string">&quot;\nnative ro.product.model  &quot;</span> + PropertiesGet.getString(<span class="string">&quot;ro.product.model&quot;</span>)</span><br><span class="line">            + <span class="string">&quot;\nnative ro.product.device &quot;</span> + PropertiesGet.getString(<span class="string">&quot;ro.product.device&quot;</span>)</span><br><span class="line">            + <span class="string">&quot;\nnative ro.product.name&quot;</span> + PropertiesGet.getString(<span class="string">&quot;ro.product.name&quot;</span>)</span><br><span class="line">            + <span class="string">&quot;\n\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;\n系统架构  &quot;</span> + PropertiesGet.getString(<span class="string">&quot;ro.product.cpu.abi&quot;</span>)</span><br><span class="line">            + <span class="string">&quot;\n获取链接的路由器地址 &quot;</span> + MacAddressUtils.getConnectedWifiMacAddress(getApplication())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="deviceid获取"><a href="#deviceid获取" class="headerlink" title="deviceid获取"></a>deviceid获取</h2><h3 id="AndroidDeviceIMEIUtil-java"><a href="#AndroidDeviceIMEIUtil-java" class="headerlink" title="AndroidDeviceIMEIUtil.java"></a>AndroidDeviceIMEIUtil.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.snail.antifake.deviceid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.annotation.SuppressLint;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.content.IntentFilter;</span><br><span class="line"><span class="keyword">import</span> android.os.Build;</span><br><span class="line"><span class="keyword">import</span> android.telephony.TelephonyManager;</span><br><span class="line"><span class="keyword">import</span> android.text.TextUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.snail.antifake.deviceid.androidid.IAndroidIdUtil;</span><br><span class="line"><span class="keyword">import</span> com.snail.antifake.deviceid.deviceid.DeviceIdUtil;</span><br><span class="line"><span class="keyword">import</span> com.snail.antifake.deviceid.emulator.EmuCheckUtil;</span><br><span class="line"><span class="keyword">import</span> com.snail.antifake.deviceid.macaddress.MacAddressUtils;</span><br><span class="line"><span class="keyword">import</span> com.snail.antifake.jni.PropertiesGet;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Author: hzlishang</span></span><br><span class="line"><span class="comment"> * Data: 17-7-26 上午11:02</span></span><br><span class="line"><span class="comment"> * Des: java与C ，代理与服务都能被hook，目前还没找不能被篡改的方法，只能将篡改的成本提高</span></span><br><span class="line"><span class="comment"> * version:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AndroidDeviceIMEIUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isRunOnEmulator</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> EmuCheckUtil.mayOnEmulator(context);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDeviceId</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DeviceIdUtil.getDeviceId(context);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getAndroidId</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> IAndroidIdUtil.getAndroidId(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getMacAddress</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> MacAddressUtils.getMacAddress(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//@Deprecated</span></span><br><span class="line">    <span class="comment">// IMPORTANT: This field should be initialized via a function call to</span></span><br><span class="line">    <span class="comment">// prevent its value being inlined in the app during compilation because</span></span><br><span class="line">    <span class="comment">// we will later set it to the value based on the app&#x27;s target SDK.</span></span><br><span class="line">    <span class="comment">//  public static final String SERIAL = getString(&quot;no.such.thing&quot;);</span></span><br><span class="line">    <span class="comment">//    序列号	 重新烧录flash</span></span><br><span class="line">    <span class="meta">@SuppressLint(&quot;MissingPermission&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getSerialno</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">serialno</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">                serialno = Build.getSerial();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                serialno = PropertiesGet.getString(<span class="string">&quot;ro.serialno&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (TextUtils.isEmpty(serialno)) &#123;</span><br><span class="line">                    serialno = Build.SERIAL;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> serialno;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getManufacturer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.manufacturer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getBrand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.brand&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getModel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.model&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCpuAbi</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.cpu.abi&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDevice</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.device&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name of the underlying board, like &quot;goldfish&quot;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getBoard</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.board&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name of the hardware (from the kernel command line or /proc).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getHardware</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.hardware&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getBootloader</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.bootloader&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    //TODO 17-7-31 by lishang : 暂时这么获取，不太重要</span></span><br><span class="line">    <span class="meta">@SuppressLint(&quot;MissingPermission&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getIMSI</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="type">TelephonyManager</span> <span class="variable">telephonyManager</span> <span class="operator">=</span> ((TelephonyManager) context.getSystemService(Context.TELEPHONY_SERVICE));</span><br><span class="line">        <span class="keyword">return</span> telephonyManager.getSubscriberId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> BatteryChangeReceiver sBatteryChangeReceiver;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerBatteryChangeListener</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sBatteryChangeReceiver == <span class="literal">null</span>) &#123;</span><br><span class="line">            sBatteryChangeReceiver = <span class="keyword">new</span> <span class="title class_">BatteryChangeReceiver</span>();</span><br><span class="line">            <span class="type">IntentFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">            filter.addAction(Intent.ACTION_BATTERY_CHANGED);</span><br><span class="line">            context.registerReceiver(sBatteryChangeReceiver, filter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unRegisterBatteryChangeListener</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sBatteryChangeReceiver == <span class="literal">null</span>) &#123;</span><br><span class="line">            context.unregisterReceiver(sBatteryChangeReceiver);</span><br><span class="line">            sBatteryChangeReceiver = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isCharging</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> !(sBatteryChangeReceiver == <span class="literal">null</span> || sBatteryChangeReceiver.isCharging());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getCurrentBatteryLevel</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sBatteryChangeReceiver != <span class="literal">null</span> ? sBatteryChangeReceiver.getCurrentLevel() : -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getMac</span><span class="params">(IpScanner.OnScanListener listener)</span> &#123;</span><br><span class="line">        <span class="type">IpScanner</span> <span class="variable">ipScanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IpScanner</span>();</span><br><span class="line">        ipScanner.startScan(listener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们只看实现的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressLint(&quot;MissingPermission&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getSerialno</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">serialno</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">            serialno = Build.getSerial();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            serialno = PropertiesGet.getString(<span class="string">&quot;ro.serialno&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (TextUtils.isEmpty(serialno)) &#123;</span><br><span class="line">                serialno = Build.SERIAL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> serialno;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Android 8.0 (API 26) 及以上版本，使用<code>Build.getSerial()</code>（<code>import android.os.Build;</code>）获取设备的硬件序列号</p>
<p>在旧版本中，通过<code>PropertiesGet.getString(&quot;ro.serialno&quot;)</code>的JNI来读取系统属性，如果失败，则回退到使用 <code>Build.SERIAL</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getManufacturer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.manufacturer&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getBrand</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.brand&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getModel</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.model&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCpuAbi</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.cpu.abi&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDevice</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.device&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The name of the underlying board, like &quot;goldfish&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getBoard</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.board&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The name of the hardware (from the kernel command line or /proc).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getHardware</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.hardware&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getBootloader</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.bootloader&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>getManufacturer()</code>: 获取设备制造商，如 “HUAWEI”, “Xiaomi”。</li>
<li><code>getBrand()</code>: 获取设备品牌，如 “honor”, “Redmi”。</li>
<li><code>getModel()</code>: 获取设备型号，如 “VOG-AL00”, “K30S Ultra”。</li>
<li><code>getCpuAbi()</code>: 获取 CPU 的 ABI（应用二进制接口），如 “arm64-v8a”。这表明了 CPU 的架构。</li>
<li><code>getDevice()</code>: 获取设备代号，如 “HWVOG”。</li>
<li><code>getBoard()</code>: 获取主板名称，如 “goldfish”（常见于模拟器）。</li>
<li><code>getHardware()</code>: 获取硬件名称，如 “kirin980”。</li>
<li><code>getBootloader()</code>: 获取引导加载程序（Bootloader）的版本号。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TODO 17-7-31 by lishang : 暂时这么获取，不太重要</span></span><br><span class="line"><span class="meta">@SuppressLint(&quot;MissingPermission&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getIMSI</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="type">TelephonyManager</span> <span class="variable">telephonyManager</span> <span class="operator">=</span> ((TelephonyManager) context.getSystemService(Context.TELEPHONY_SERVICE));</span><br><span class="line">    <span class="keyword">return</span> telephonyManager.getSubscriberId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取设备的 <strong>IMSI</strong>，IMSI 是用于唯一识别移动网络中用户的编号，它存储在 SIM 卡中</p>
<blockquote>
<p>但是<strong>从 Android 10 (API 29) 开始</strong>，普通应用调用 <code>getSubscriberId()</code> 将不再返回有效的 IMSI。如果应用不具备特殊的运营商权限，调用此方法会抛出 <code>SecurityException</code>。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> BatteryChangeReceiver sBatteryChangeReceiver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerBatteryChangeListener</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sBatteryChangeReceiver == <span class="literal">null</span>) &#123;</span><br><span class="line">        sBatteryChangeReceiver = <span class="keyword">new</span> <span class="title class_">BatteryChangeReceiver</span>();</span><br><span class="line">        <span class="type">IntentFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">        filter.addAction(Intent.ACTION_BATTERY_CHANGED);</span><br><span class="line">        context.registerReceiver(sBatteryChangeReceiver, filter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unRegisterBatteryChangeListener</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sBatteryChangeReceiver == <span class="literal">null</span>) &#123;</span><br><span class="line">        context.unregisterReceiver(sBatteryChangeReceiver);</span><br><span class="line">        sBatteryChangeReceiver = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isCharging</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> !(sBatteryChangeReceiver == <span class="literal">null</span> || sBatteryChangeReceiver.isCharging());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getCurrentBatteryLevel</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> sBatteryChangeReceiver != <span class="literal">null</span> ? sBatteryChangeReceiver.getCurrentLevel() : -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>registerBatteryChangeListener</code>注册一个<code>BatteryChangeReceiver</code>来监听系统的电池状态变化</p>
<blockquote>
<p>所有方法位于<code>BatteryChangeReceiver.java</code>实现</p>
</blockquote>
<p><code>unRegisterBatteryChangeListener</code>注销之前注册的广播接收器</p>
<p><code>isCharging()</code>获取当前是否在充电，通过<code>sBatteryChangeReceiver.isCharging()</code></p>
<p><code>getCurrentBatteryLevel</code>获取当前的电量，通过<code>sBatteryChangeReceiver.getCurrentLevel()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getMac</span><span class="params">(IpScanner.OnScanListener listener)</span> &#123;</span><br><span class="line">    <span class="type">IpScanner</span> <span class="variable">ipScanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IpScanner</span>();</span><br><span class="line">    ipScanner.startScan(listener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>IpScanner.java</code>中实现，其中<code>ipScanner.startScan(listener);</code>会扫描局域网内的其他设备</p>
<h3 id="BatteryChangeReceiver-java"><a href="#BatteryChangeReceiver-java" class="headerlink" title="BatteryChangeReceiver.java"></a>BatteryChangeReceiver.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.snail.antifake.deviceid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.BatteryManager;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Author: hzlishang</span></span><br><span class="line"><span class="comment"> * Data: 17-8-18 下午1:54</span></span><br><span class="line"><span class="comment"> * Des:</span></span><br><span class="line"><span class="comment"> * version:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BatteryChangeReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> mIsCharging;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mCurrentLevel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 只有未充电，并且电量经常不变才看成模拟器，这个方法很容易造假，参考意义不大</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> intent.getIntExtra(BatteryManager.EXTRA_STATUS, <span class="number">0</span>);</span><br><span class="line">        mCurrentLevel = intent.getIntExtra(BatteryManager.EXTRA_LEVEL, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ( ) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> BatteryManager.BATTERY_STATUS_CHARGING:</span><br><span class="line">                <span class="comment">// 电池满不作为参考，看做充电中</span></span><br><span class="line">            <span class="keyword">case</span> BatteryManager.BATTERY_STATUS_FULL:</span><br><span class="line">            <span class="keyword">case</span> BatteryManager.BATTERY_STATUS_UNKNOWN:</span><br><span class="line">                mIsCharging = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BatteryManager.BATTERY_STATUS_NOT_CHARGING:</span><br><span class="line">            <span class="keyword">case</span> BatteryManager.BATTERY_STATUS_DISCHARGING:</span><br><span class="line">                mIsCharging = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        Toast.makeText(context, &quot; &quot; + mCurrentLevel + &quot; mIsCharging &quot;+ mIsCharging, Toast.LENGTH_SHORT).show();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCharging</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mIsCharging;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCurrentLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mCurrentLevel;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>public class BatteryChangeReceiver extends BroadcastReceiver</code>继承了<code>BroadcastReceiver</code>类，这意味着它具备了广播接收器的能力。</p>
<p><code>onReceive</code>方法的调用时机：要让 <code>onReceive</code> 方法被调用，需要两个步骤：</p>
<ol>
<li><strong>创建广播接收器</strong>：我们已经有了 <code>BatteryChangeReceiver</code> 这个类。</li>
<li><strong>注册广播接收器</strong>：我们需要告诉安卓系统，“嘿，我这里有一个接收器，它对某个特定的事件感兴趣。当这个事件发生时，请通知我。”</li>
</ol>
<p>这个“注册”的动作发生在 <code>AndroidDeviceIMEIUtil.java</code> 文件中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// d:\android_re\AntiFakerAndroidChecker-1.6.0\AntiFakerAndroidChecker-1.6.0\antifake\src\main\java\com\snail\antifake\deviceid\AndroidDeviceIMEIUtil.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerBatteryChangeListener</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sBatteryChangeReceiver == <span class="literal">null</span>) &#123;</span><br><span class="line">        sBatteryChangeReceiver = <span class="keyword">new</span> <span class="title class_">BatteryChangeReceiver</span>();</span><br><span class="line">        <span class="comment">// 1. 创建一个意图过滤器 (IntentFilter)</span></span><br><span class="line">        <span class="type">IntentFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 告诉过滤器，我们只对 &quot;ACTION_BATTERY_CHANGED&quot; 这个动作感兴趣</span></span><br><span class="line">        filter.addAction(Intent.ACTION_BATTERY_CHANGED);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 使用上下文(context)将我们的接收器(sBatteryChangeReceiver)和过滤器(filter)注册到系统中</span></span><br><span class="line">        context.registerReceiver(sBatteryChangeReceiver, filter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Intent.ACTION_BATTERY_CHANGED</code> 是安卓系统预定义的一个<strong>广播动作（Action）</strong></p>
<p>当系统检测到电池的状态发生了变化，比如：</p>
<ul>
<li>开始充电（插上充电器）</li>
<li>停止充电（拔掉充电器）</li>
<li>电量百分比发生改变（例如从 81% 掉到 80%）</li>
<li>电池充满</li>
<li>电池温度变化等</li>
</ul>
<p>系统就会发送一个带有 <code>ACTION_BATTERY_CHANGED</code> 动作的广播</p>
<p>由于我们的 <code>BatteryChangeReceiver</code> 已经注册监听了这个动作，所以安卓系统就会自动调用它的 <code>onReceive</code> 方法，并将包含详细信息的 <code>Intent</code> 对象传递进来</p>
<p><code>status</code>也可以通过定义看到，其值是通过<code>intent</code>监听<code>Broadcast</code>获取的</p>
<p>或者说是<code>BroadcastReceiver</code>带给<code>intent</code>的值</p>
<p>不过也可知这是关于当前电池状态的变化的状态的</p>
<blockquote>
<p><code>BatteryManager.BATTERY_STATUS_CHARGING</code>：设备正在充电。</p>
<p><code>BatteryManager.BATTERY_STATUS_DISCHARGING</code>：设备正在使用电池。</p>
<p><code>BatteryManager.BATTERY_STATUS_NOT_CHARGING</code>：设备未在充电。</p>
<p><code>BatteryManager.BATTERY_STATUS_FULL</code>：电池已充满。</p>
<p><code>BatteryManager.BATTERY_STATUS_UNKNOWN</code>：电池状态未知。</p>
</blockquote>
<p>如果设备正在充电、电池已充满或者电池状态未知，<code>mIsCharging</code> 标志被设置为 <code>true</code>。</p>
<p>如果状态是 <code>BATTERY_STATUS_NOT_CHARGING</code> 或 <code>BATTERY_STATUS_DISCHARGING</code>，<code>mIsCharging</code> 标志被设置为 <code>false</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCharging</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mIsCharging;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCurrentLevel</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mCurrentLevel;<span class="comment">//电池电量</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="BinderUtil-java"><a href="#BinderUtil-java" class="headerlink" title="BinderUtil.java"></a>BinderUtil.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.snail.antifake.deviceid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Author: hzlishang</span></span><br><span class="line"><span class="comment"> * Data: 17-7-13 下午1:29</span></span><br><span class="line"><span class="comment"> * Des:</span></span><br><span class="line"><span class="comment"> * version:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BinderUtil</span> &#123;</span><br><span class="line">    <span class="comment">//根据方法名，反射获得方法transactionId</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getTransactionId</span><span class="params">(Object proxy,</span></span><br><span class="line"><span class="params">                                        String name)</span> <span class="keyword">throws</span> RemoteException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">transactionId</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">outclass</span> <span class="operator">=</span> proxy.getClass().getEnclosingClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">idField</span> <span class="operator">=</span> outclass.getDeclaredField(name);</span><br><span class="line">        idField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        transactionId = (<span class="type">int</span>) idField.get(proxy);</span><br><span class="line">        <span class="keyword">return</span> transactionId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据方法名，反射获得方法transactionId</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getInterfaceDescriptor</span><span class="params">(Object proxy)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getInterfaceDescriptor</span> <span class="operator">=</span> proxy.getClass().getDeclaredMethod(<span class="string">&quot;getInterfaceDescriptor&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> (String) getInterfaceDescriptor.invoke(proxy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码是一个名为 <code>BinderUtil</code> 的工具类，这个工具类的核心目的是通过 <strong>Java 反射</strong> 技术，来获取 Android 系统底层 <strong>Binder 通信机制</strong> 中的一些关键信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据方法名，反射获得方法transactionId</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getTransactionId</span><span class="params">(Object proxy,</span></span><br><span class="line"><span class="params">                                    String name)</span> <span class="keyword">throws</span> RemoteException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">transactionId</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 1. 获取代理对象所属的外部类（通常是 Stub 类）</span></span><br><span class="line">    <span class="type">Class</span> <span class="variable">outclass</span> <span class="operator">=</span> proxy.getClass().getEnclosingClass();</span><br><span class="line">    <span class="comment">// 2. 在外部类中查找名为 name 的字段</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">idField</span> <span class="operator">=</span> outclass.getDeclaredField(name);</span><br><span class="line">    <span class="comment">// 3. 强制使其可访问（即使是 private）</span></span><br><span class="line">    idField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// 4. 获取该字段的值</span></span><br><span class="line">    transactionId = (<span class="type">int</span>) idField.get(proxy);</span><br><span class="line">    <span class="keyword">return</span> transactionId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Binder 通信中，每个可以被远程调用的方法都有一个唯一的整数 ID，称为 <code>Transaction ID</code>。当客户端发起调用时，并不会把方法名传给服务端，而是传递这个 <code>Transaction ID</code>。服务端根据这个 ID 来判断应该执行哪个具体的方法。 这些 ID 通常在编译时由 AIDL（Android 接口定义语言）工具自动生成，并作为 <code>static final int</code> 常量字段定义在 <code>Stub</code> 类中，例如 <code>TRANSACTION_getDeviceId</code>。</p>
<p>这个方法的作用就是通过反射，在运行时动态地获取这个 <code>Transaction ID</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据方法名，反射获得方法transactionId</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getInterfaceDescriptor</span><span class="params">(Object proxy)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">    <span class="comment">// 1. 获取 proxy 类中名为 &quot;getInterfaceDescriptor&quot; 的方法</span></span><br><span class="line">    <span class="type">Method</span> <span class="variable">getInterfaceDescriptor</span> <span class="operator">=</span> proxy.getClass().getDeclaredMethod(<span class="string">&quot;getInterfaceDescriptor&quot;</span>);</span><br><span class="line">    <span class="comment">// 2. 调用该方法</span></span><br><span class="line">    <span class="keyword">return</span> (String) getInterfaceDescriptor.invoke(proxy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个 Binder 服务都有一个唯一的字符串名称，称为“接口描述符”（Interface Descriptor）。它通常是接口的完整类名（例如 <code>&quot;android.telephony.ITelephony&quot;</code>）。这个描述符用于在 Binder 通信的两端验证对方是不是自己想要通信的那个服务。 <code>IBinder</code> 接口本身就定义了 <code>getInterfaceDescriptor()</code> 方法，所有 Binder 对象都实现了它</p>
<p>这个工具方法的作用就是通过反射来调用 <code>getInterfaceDescriptor()</code> 方法</p>
<p>但是这里有个问题就是，这个项目本身在使用这个方法是通过：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">Stub</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.android.internal.telephony.IPhoneSubInfo$Stub&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">asInterface</span> <span class="operator">=</span> Stub.getDeclaredMethod(<span class="string">&quot;asInterface&quot;</span>, IBinder.class);</span><br><span class="line">asInterface.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">binderProxy</span> <span class="operator">=</span> asInterface.invoke(<span class="literal">null</span>, binder);</span><br><span class="line">BinderUtil.getTransactionId(binderProxy, <span class="string">&quot;TRANSACTION_getDeviceId&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这样调用的，而如此调用会发生一个错误：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.NoSuchMethodException: com.android.internal.telephony.IPhoneSubInfo$Stub$Proxy.getInterfaceDescriptor []</span><br></pre></td></tr></table></figure>

<p>原因是：对于这个Proxy来说，不存在<code>getInterfaceDescriptor</code>这个方法，<code>getInterfaceDescriptor</code>是在<code>IBinder</code>底层类就有实现的，而这个通过<code>asInterface</code>返回的Proxy代理类是由系统在编译时根据提供的AIDL文件生成的，它只包含AIDL中的业务方法而不会包含像<code>getInterfaceDescriptor</code>这种<code>IBinder</code>底层管理方法</p>
<p>因此要先获取其<code>IBinder</code>然后调用对应的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getInterfaceDescriptor</span><span class="params">(Object proxy)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException, RemoteException &#123;</span><br><span class="line">    <span class="keyword">if</span> (proxy <span class="keyword">instanceof</span> IInterface) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((IInterface) proxy).asBinder().getInterfaceDescriptor();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Fallback for other types of proxies if needed, though less likely for AIDL.</span></span><br><span class="line">    <span class="type">Method</span> <span class="variable">getInterfaceDescriptorMethod</span> <span class="operator">=</span> proxy.getClass().getMethod(<span class="string">&quot;getInterfaceDescriptor&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (String) getInterfaceDescriptorMethod.invoke(proxy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CrashHandler-java"><a href="#CrashHandler-java" class="headerlink" title="CrashHandler.java"></a>CrashHandler.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.snail.antifake.deviceid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.ActivityManager;</span><br><span class="line"><span class="keyword">import</span> android.app.Application;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.os.Process;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Author: snail</span></span><br><span class="line"><span class="comment"> * Data: 2017/8/3 下午3:25</span></span><br><span class="line"><span class="comment"> * Des:</span></span><br><span class="line"><span class="comment"> * version:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CrashHandler</span> <span class="keyword">implements</span> <span class="title class_">Thread</span>.UncaughtExceptionHandler &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Application mApplication;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CrashHandler</span><span class="params">(Application application)</span>&#123;</span><br><span class="line">        mApplication=application;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uncaughtException</span><span class="params">(Thread thread, Throwable ex)</span> &#123;</span><br><span class="line">        Process.killProcess( Process.myPid());</span><br><span class="line">        <span class="type">ActivityManager</span> <span class="variable">manager</span> <span class="operator">=</span> (ActivityManager)</span><br><span class="line">                mApplication.getSystemService(Context.ACTIVITY_SERVICE);</span><br><span class="line">        <span class="keyword">for</span> (ActivityManager.RunningAppProcessInfo processInfo : manager.getRunningAppProcesses()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (processInfo.pid == Process.myPid()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mApplication.getPackageName().equals(processInfo.processName)) &#123;</span><br><span class="line">                    Process.killProcess( Process.myPid());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>implements</code>的作用是**声明一个类正在“实现”一个或多个接口 (Interface)**，可以一次声明多个接口</p>
<p><strong>如果是一个普通类 (Concrete Class)：</strong>必须<strong>实现该接口及其所有父接口中定义的</strong>所有抽象 (abstract) 方法。如果漏掉了任何一个，Java 编译器都会报错。</p>
<p><strong>如果是一个抽象类 (Abstract Class)：</strong> <strong>不需要</strong>实现所有方法。你可以选择实现一部分、或一个都不实现。</p>
</blockquote>
<blockquote>
<p><code>Thread.UncaughtExceptionHandler</code> 是 Java 提供的一个接口。任何实现了这个接口的类都可以被注册为“默认的未捕获异常处理器”。当应用中的任何线程（包括主线程）抛出一个没有被 <code>try-catch</code> 语句捕获的异常时，JVM 就会自动调用这个处理器中的 <code>uncaughtException</code> 方法。</p>
</blockquote>
<p>这个 <code>CrashHandler</code> 的设计目的并不仅仅是为了处理常规的程序崩溃，它还包含了一层<strong>基础的反注入和反调试保护</strong>。</p>
<ul>
<li><strong>常规崩溃处理</strong>：在任何未捕获异常发生时，它会确保应用进程被彻底终止，而不是依赖系统默认的崩溃对话框。</li>
<li><strong>安全检测</strong>：它在应用崩溃的瞬间，检查自身进程名是否与预期的包名一致。如果发现不一致，它会再次强制杀死进程。这可以防止在某些被注入或篡改的环境下，即使应用主逻辑崩溃，注入的代码仍然可能继续在应用的进程空间中运行。</li>
</ul>
<h3 id="IpScanner-java"><a href="#IpScanner-java" class="headerlink" title="IpScanner.java"></a>IpScanner.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">getHostIP</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">hostIp</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Enumeration</span> <span class="variable">nis</span> <span class="operator">=</span> NetworkInterface.getNetworkInterfaces();</span><br><span class="line">        InetAddress ia;</span><br><span class="line">        <span class="keyword">while</span> (nis.hasMoreElements()) &#123;</span><br><span class="line">            <span class="type">NetworkInterface</span> <span class="variable">ni</span> <span class="operator">=</span> (NetworkInterface) nis.nextElement();</span><br><span class="line">            Enumeration&lt;InetAddress&gt; ias = ni.getInetAddresses();</span><br><span class="line">            <span class="keyword">while</span> (ias.hasMoreElements()) &#123;</span><br><span class="line">                ia = ias.nextElement();</span><br><span class="line">                <span class="keyword">if</span> (ia <span class="keyword">instanceof</span> Inet6Address) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;<span class="comment">// skip ipv6</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> ia.getHostAddress();</span><br><span class="line">                <span class="keyword">if</span> (!<span class="string">&quot;127.0.0.1&quot;</span>.equals(ip)) &#123;</span><br><span class="line">                    hostIp = ia.getHostAddress();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SocketException e) &#123;</span><br><span class="line">        Log.i(<span class="string">&quot;kalshen&quot;</span>, <span class="string">&quot;SocketException&quot;</span>);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hostIp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>Enumeration nis = NetworkInterface.getNetworkInterfaces();</code></strong></p>
<ul>
<li>这是获取网络信息的关键入口。<code>NetworkInterface</code> 类代表一个网络接口，如Wi-Fi网卡 (<code>wlan0</code>)、移动数据网络接口或以太网卡 (<code>eth0</code>)。</li>
<li><code>getNetworkInterfaces()</code> 方法返回一个 <code>Enumeration</code> (枚举) 对象，其中包含了设备上所有可用的网络接口。</li>
</ul>
<p><code>Enumeration&lt;InetAddress&gt; ias = ni.getInetAddresses();</code></p>
<p>对于每一个网络接口，调用 <code>getInetAddresses()</code> 方法。一个网络接口可能绑定了多个IP地址（例如，一个<code>IPv4</code>地址和一个或多个<code>IPv6</code>地址）。此方法返回包含所有这些地址的 <code>Enumeration</code> 对象</p>
<p>一旦找到了一个既不是IPv6也不是本地回环地址的IP，就将其赋值给 <code>hostIp</code> 变量，然后停止循环</p>
<p>但是这里的代码并不能确保获取的IPv4就是本机<code>ip</code>地址</p>
<p>可以进行改进：</p>
<ul>
<li><code>intf.getName().equalsIgnoreCase(&quot;wlan0&quot;)</code>: 明确指定查找名为 “wlan0” 的接口，这是绝大多数Android设备上Wi-Fi接口的名称。</li>
<li><code>intf.isUp()</code>: 确保这个网络接口是“活跃”的。</li>
<li><code>!inetAddress.isLoopbackAddress()</code>: 这是比 <code>!&quot;127.0.0.1&quot;.equals(ip)</code> 更规范的判断回环地址的方法。</li>
<li><code>inetAddress instanceof java.net.Inet4Address</code>: 这是比 <code>!(ia instanceof Inet6Address)</code> 更直接的判断IPv4的方式。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startScan</span><span class="params">(<span class="keyword">final</span> OnScanListener listener)</span> &#123;</span><br><span class="line">    <span class="comment">//局域网内存在的ip集合</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; ipList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取本机所在的局域网地址</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">hostIP</span> <span class="operator">=</span> getHostIP();</span><br><span class="line">    <span class="keyword">if</span>(TextUtils.isEmpty(hostIP))</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    <span class="type">int</span> <span class="variable">lastIndexOf</span> <span class="operator">=</span> hostIP.lastIndexOf(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">substring</span> <span class="operator">=</span> hostIP.substring(<span class="number">0</span>, lastIndexOf + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">DatagramPacket</span> <span class="variable">dp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DatagramPacket</span>(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>], <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            DatagramSocket socket;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                socket = <span class="keyword">new</span> <span class="title class_">DatagramSocket</span>();</span><br><span class="line">                <span class="type">int</span> <span class="variable">position</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">while</span> (position &lt; <span class="number">255</span>) &#123;</span><br><span class="line">                    Log.e(<span class="string">&quot;kalshen&quot;</span>, <span class="string">&quot;run: udp-&quot;</span> + substring + position);</span><br><span class="line">                    dp.setAddress(InetAddress.getByName(substring + String.valueOf(position)));</span><br><span class="line">                    socket.send(dp);</span><br><span class="line">                    position++;</span><br><span class="line">                    <span class="keyword">if</span> (position == <span class="number">125</span>) &#123;<span class="comment">//分两段掉包，一次性发的话，达到236左右，会耗时3秒左右再往下发</span></span><br><span class="line">                        socket.close();</span><br><span class="line">                        socket = <span class="keyword">new</span> <span class="title class_">DatagramSocket</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                socket.close();</span><br><span class="line">                execCatForArp(listener);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SocketException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要的逻辑发生在下方的run中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">DatagramPacket</span> <span class="variable">dp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DatagramPacket</span>(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>], <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    DatagramSocket socket;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">		...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SocketException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>

<p><code>DatagramPacket dp = new DatagramPacket(new byte[0], 0, 0);</code></p>
<ul>
<li>创建一个UDP数据包（<code>DatagramPacket</code>）。这个数据包的内容是空的（<code>new byte[0]</code>），因为发送数据本身不重要。重要的是<strong>发送这个动作本身</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">socket = <span class="keyword">new</span> <span class="title class_">DatagramSocket</span>();</span><br><span class="line"><span class="type">int</span> <span class="variable">position</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">while</span> (position &lt; <span class="number">255</span>) &#123;</span><br><span class="line">    Log.e(<span class="string">&quot;kalshen&quot;</span>, <span class="string">&quot;run: udp-&quot;</span> + substring + position);</span><br><span class="line">    dp.setAddress(InetAddress.getByName(substring + String.valueOf(position)));</span><br><span class="line">    socket.send(dp);</span><br><span class="line">    position++;</span><br><span class="line">    <span class="keyword">if</span> (position == <span class="number">125</span>) &#123;<span class="comment">//分两段掉包，一次性发的话，达到236左右，会耗时3秒左右再往下发</span></span><br><span class="line">        socket.close();</span><br><span class="line">        socket = <span class="keyword">new</span> <span class="title class_">DatagramSocket</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">socket.close();</span><br><span class="line">execCatForArp(listener);</span><br></pre></td></tr></table></figure>

<p> <code>position</code>从2到254，避开网路地址(.0)、常见网关(.1)和广播地址(.255)</p>
<p><strong><code>dp.setAddress(InetAddress.getByName(substring + String.valueOf(position)));</code></strong></p>
<p>在循环中，为UDP包设置目标IP地址，例如 <code>&quot;192.168.1.2&quot;, &quot;192.168.1.3&quot;, ...</code></p>
<p><strong><code>socket.send(dp);</code></strong></p>
<ul>
<li><strong>核心操作</strong>。向目标IP发送这个空的UDP包。当操作系统执行这个发送命令时，它需要知道目标IP对应的MAC地址</li>
<li>如果操作系统的ARP缓存中没有这个IP的记录，它就会在局域网中广播一个<code>ARP</code>请求：“谁是 192.168.1.x？请告诉我你的MAC地址。”</li>
<li>如果网络中存在该IP的设备，它会响应这个ARP请求。</li>
<li><strong>无论目标设备是否真的在监听UDP端口，只要它响应了ARP请求，它的IP-MAC映射关系就会被记录到本机的ARP缓存中。</strong></li>
</ul>
<p>**<code>if (position == 125) &#123; ... &#125;</code>**经验优化，分两段发包，可以学习！</p>
<p>最后执行<code>execCatForArp</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行 cat命令 查找android 设备arp表</span></span><br><span class="line"><span class="comment"> * arp表 包含ip地址和对应的mac地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">execCatForArp</span><span class="params">(<span class="keyword">final</span> OnScanListener listener)</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                <span class="type">Process</span> <span class="variable">exec</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;cat proc/net/arp&quot;</span>);</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> exec.getInputStream();</span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(is));</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    Log.e(<span class="string">&quot;kalshen&quot;</span>, <span class="string">&quot;run: &quot;</span> + line);</span><br><span class="line">                    <span class="keyword">if</span> (!line.contains(<span class="string">&quot;00:00:00:00:00:00&quot;</span>) &amp;&amp; !line.contains(<span class="string">&quot;IP&quot;</span>)) &#123;</span><br><span class="line">                        String[] split = line.split(<span class="string">&quot;\\s+&quot;</span>);</span><br><span class="line">                        map.put(split[<span class="number">3</span>], split[<span class="number">0</span>]);</span><br><span class="line">                        <span class="comment">//                                Log.e(&quot;kalshen&quot;, &quot;run: &quot; + s1);</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                mHandler.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        listener.scan(map);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在完善完ARP表之后<code>cat proc/net/arp</code></p>
<p>然后<code>map.put(split[3], split[0]);</code>将MAC地址和IP地址分别作为key和value存储在<code>map</code>中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 execCatForArp 方法的后台线程中</span></span><br><span class="line">mHandler.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        listener.scan(map); <span class="comment">// 这行代码将在主线程上执行</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>mHandler是通过<code>private Handler mHandler = new Handler(Looper.getMainLooper());</code>来获取主线程的Looper，然后将这个 <code>Runnable</code> 对象发送到 <code>mHandler</code> 所绑定的消息队列中，也就是<strong>主线程的消息队列</strong></p>
<p>主线程有一个持续运行的 <code>Looper</code>，它会不断地从自己的消息队列中取出消息或 <code>Runnable</code> 来执行。当主线程的 <code>Looper</code> 处理到我们刚刚投递的这个 <code>Runnable</code> 对象时，它就会在<strong>主线程的环境下</strong>调用该对象的 <code>run()</code> 方法</p>
<p>而这个scan方法，是在这个接口定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OnScanListener</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">scan</span><span class="params">(Map&lt;String, String&gt; resultMap)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>getMac</code>中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getMac</span><span class="params">(IpScanner.OnScanListener listener)</span> &#123;</span><br><span class="line">    <span class="type">IpScanner</span> <span class="variable">ipScanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IpScanner</span>();</span><br><span class="line">    ipScanner.startScan(listener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>listener</code>并没有被实现，因此这个<code>listener</code>的处理是通过用户外部传入的，处理的参数就是最后传出来的map结果</p>
<h3 id="ShellAdbUtils-java"><a href="#ShellAdbUtils-java" class="headerlink" title="ShellAdbUtils.java"></a>ShellAdbUtils.java</h3><p><code>ShellAdbUtils</code> 类被设计为不可实例化，它只包含静态方法和静态常量，这是一个典型的工具类设计模式</p>
<p>这个类是一个用于在 Android 设备上执行 Shell 命令的工具类</p>
<p>它封装了通过 <code>Runtime.getRuntime().exec()</code> 执行命令的逻辑，并提供了检查 root 权限、以 root 或普通用户身份执行单个或多个命令的功能</p>
<h3 id="androidid"><a href="#androidid" class="headerlink" title="androidid"></a>androidid</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.snail.antifake.deviceid.androidid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.provider.Settings;</span><br><span class="line"><span class="keyword">import</span> android.text.TextUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * androidid获取</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IAndroidIdUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getAndroidId</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        String androidId;</span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(androidId = ISettingUtils.getAndroidPropertyLevel1(context, Settings.Secure.ANDROID_ID))</span><br><span class="line">                || !TextUtils.isEmpty(androidId = ISettingUtils.getAndroidProperty(context, Settings.Secure.ANDROID_ID))) &#123;</span><br><span class="line">            <span class="keyword">return</span> androidId;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Settings.Secure.getString(context.getContentResolver(), Settings.Secure.ANDROID_ID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    getStringForUser 是一个隐藏方法，按理说 第三方不能随意修改，因为版本不一致，但是仍然可以修改，虽然可能导致ROM不稳定，但是定制ROM或者做插件的也许不关心</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getAndroidPropertyLevel1</span><span class="params">(Context context, String name)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">ContentResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> context.getContentResolver();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">mUserHandle</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.os.UserHandle&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getUserId</span> <span class="operator">=</span> mUserHandle.getDeclaredMethod(<span class="string">&quot;getUserId&quot;</span>, <span class="type">int</span>.class);</span><br><span class="line">        getUserId.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">uid</span> <span class="operator">=</span> (<span class="type">int</span>) getUserId.invoke(<span class="literal">null</span>, Process.myUid());</span><br><span class="line"></span><br><span class="line">        HashSet&lt;String&gt; MOVED_TO_SECURE = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        HashSet&lt;String&gt; MOVED_TO_LOCK_SETTINGS = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        HashSet&lt;String&gt; MOVED_TO_GLOBAL = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">Global</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.provider.Settings$Global&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Global.getDeclaredField(<span class="string">&quot;MOVED_TO_SECURE&quot;</span>);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            MOVED_TO_SECURE = (HashSet&lt;String&gt;) field.get(Global);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">Secure</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.provider.Settings$Secure&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Secure.getDeclaredField(<span class="string">&quot;MOVED_TO_LOCK_SETTINGS&quot;</span>);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            MOVED_TO_LOCK_SETTINGS = (HashSet&lt;String&gt;) field.get(Secure);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">Secure</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.provider.Settings$Secure&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Secure.getDeclaredField(<span class="string">&quot;MOVED_TO_GLOBAL&quot;</span>);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            MOVED_TO_GLOBAL = (HashSet&lt;String&gt;) field.get(Secure);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (MOVED_TO_SECURE.contains(name)) &#123;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (MOVED_TO_GLOBAL.contains(name)) &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">mSecure</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.provider.Global&quot;</span>);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getStringForUser</span> <span class="operator">=</span> mSecure.getDeclaredMethod(<span class="string">&quot;getStringForUser&quot;</span>, ContentResolver.class, String.class, <span class="type">int</span>.class);</span><br><span class="line">            getStringForUser.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> (String) getStringForUser.invoke(<span class="literal">null</span>, resolver, name, uid);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((MOVED_TO_LOCK_SETTINGS.contains(name))) &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">ServiceManager</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.os.ServiceManager&quot;</span>);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getService</span> <span class="operator">=</span> ServiceManager.getDeclaredMethod(<span class="string">&quot;getService&quot;</span>);</span><br><span class="line">            getService.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> (IBinder) getService.invoke(<span class="literal">null</span>, <span class="string">&quot;lock_settings&quot;</span>);</span><br><span class="line">            <span class="type">Class</span> <span class="variable">Stub</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.android.internal.widget.ILockSettings$Stub&quot;</span>);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">asInterface</span> <span class="operator">=</span> Stub.getDeclaredMethod(<span class="string">&quot;asInterface&quot;</span>, IBinder.class);</span><br><span class="line">            asInterface.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">binderProxy</span> <span class="operator">=</span> asInterface.invoke(<span class="literal">null</span>, binder);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">sIsSystemProcess</span> <span class="operator">=</span> Process.myUid() == Process.SYSTEM_UID;</span><br><span class="line">            <span class="keyword">if</span> (MOVED_TO_LOCK_SETTINGS.contains(name)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (binderProxy != <span class="literal">null</span> &amp;&amp; !sIsSystemProcess) &#123;</span><br><span class="line">                    <span class="type">Class</span> <span class="variable">proxy</span> <span class="operator">=</span> binderProxy.getClass();</span><br><span class="line">                    <span class="type">Method</span> <span class="variable">getString</span> <span class="operator">=</span> proxy.getDeclaredMethod(<span class="string">&quot;getString&quot;</span>, String.class, String.class, <span class="type">int</span>.class);</span><br><span class="line">                    <span class="keyword">return</span> (String) getString.invoke(name, <span class="string">&quot;0&quot;</span>, uid);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">Secure</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.provider.Settings$Secure&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Secure.getDeclaredField(<span class="string">&quot;sNameValueCache&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">sNameValueCache</span> <span class="operator">=</span> field.get(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">NameValueCache</span> <span class="operator">=</span> sNameValueCache.getClass();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getStringForUser</span> <span class="operator">=</span> NameValueCache.getDeclaredMethod(<span class="string">&quot;getStringForUser&quot;</span>, ContentResolver.class, String.class, <span class="type">int</span>.class);</span><br><span class="line">        <span class="keyword">return</span> (String) getStringForUser.invoke(sNameValueCache, resolver, name, uid);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>通过大量的反射，调用很多安卓内部的方法和字段名</p>
<ol>
<li><p><code>android.os.UserHandle</code>类中的<code>getUserId</code>静态方法获取uid</p>
</li>
<li><p><code>android.provider.Settings$Global</code>内部类中的<code>MOVED_TO_SECURE</code>字段</p>
<blockquote>
<p><code>MOVED_TO_SECURE</code> 是一个 <code>private static final HashSet&lt;String&gt;</code> 类型的字段。它的作用是记录那些<strong>从 <code>Settings.Global</code> 表迁移到 <code>Settings.Secure</code> 表的设置项的键名</strong></p>
<p>当系统尝试访问一个曾经在 <code>Global</code> 中但现在已迁移的设置时，会检查这个 <code>HashSet</code>。如果设置项的键名存在于 <code>MOVED_TO_SECURE</code> 中，系统就会重定向到 <code>Settings.Secure</code> 去读取，并打印一条警告日志</p>
<p>总结来说，<code>MOVED_TO_SECURE</code> 字段是 <code>Settings.Global</code> 类内部用于处理设置项迁移的一个私有静态成员</p>
</blockquote>
<p>如果当在<code>MOVED_TO_SECURE</code>这个字段中存在<code>Settings.Secure.ANDROID_ID</code>的话，那么就会调用<code>android.provider.Settings</code> 类中一个内部类 <code>NameValueCache</code> 的 <code>getStringForUser</code> 方法。这个方法是 Android 系统中从设置（Settings）数据库（如 <code>System</code>, <code>Secure</code>, <code>Global</code> 表）中读取一个特定键值（Setting）的核心逻辑</p>
<blockquote>
<p><strong>根据给定的设置名称（<code>name</code>）和用户句柄（<code>userHandle</code>），安全、高效地从内容提供者（Content Provider）中检索对应的字符串值</strong></p>
</blockquote>
</li>
<li><p><code>android.provider.Settings$Secure</code>内部类中的<code>MOVED_TO_LOCK_SETTINGS</code>字段</p>
<p>如果该字段存在对应的键名，会先调用<code>android.os.ServiceManager</code>类中的<code>getService</code>静态方法，这个函数是 Android 框架中用于获取系统服务（System Service）的 <code>IBinder</code> 接口的核心方法，<code>lock_settings</code> 是 <code>LockSettingsService</code> 服务的注册名称。这个服务运行在 <code>system_server</code> 进程中，专门负责管理与设备锁屏安全相关的设置</p>
<p>之后通过<code>asInterface</code>返回的<code>Proxy</code>远程调用<code>getString</code>来获取对应字段的值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> LockSettingsStorage mStorage;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getString</span><span class="params">(String key, String defaultValue, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">       checkReadPermission(key, userId);</span><br><span class="line">       <span class="keyword">return</span> mStorage.getString(key, defaultValue, userId);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>android.provider.Settings$Secure</code>内部类中的<code>MOVED_TO_GLOBAL</code>字段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">mSecure</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.provider.Global&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">getStringForUser</span> <span class="operator">=</span> mSecure.getDeclaredMethod(<span class="string">&quot;getStringForUser&quot;</span>, ContentResolver.class, String.class, <span class="type">int</span>.class);</span><br><span class="line">getStringForUser.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">return</span> (String) getStringForUser.invoke(<span class="literal">null</span>, resolver, name, uid);</span><br></pre></td></tr></table></figure></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDeviceIdLevel2</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">deviceId</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">ServiceManager</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.os.ServiceManager&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getService</span> <span class="operator">=</span> ServiceManager.getDeclaredMethod(<span class="string">&quot;getService&quot;</span>, String.class);</span><br><span class="line">        getService.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> (IBinder) getService.invoke(<span class="literal">null</span>, Context.TELEPHONY_SERVICE);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">Stub</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.android.internal.telephony.ITelephony$Stub&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">asInterface</span> <span class="operator">=</span> Stub.getDeclaredMethod(<span class="string">&quot;asInterface&quot;</span>, IBinder.class);</span><br><span class="line">        asInterface.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">binderProxy</span> <span class="operator">=</span> asInterface.invoke(<span class="literal">null</span>, binder);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>, String.class);</span><br><span class="line">            <span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">                deviceId = binderGetHardwareInfo(context.getPackageName(),</span><br><span class="line">                        binder, BinderUtil.getInterfaceDescriptor(binderProxy),</span><br><span class="line">                        BinderUtil.getTransactionId(binderProxy, <span class="string">&quot;TRANSACTION_getDeviceId&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">            deviceId = binderGetHardwareInfo(<span class="string">&quot;&quot;</span>,</span><br><span class="line">                    binder, BinderUtil.getInterfaceDescriptor(binderProxy),</span><br><span class="line">                    BinderUtil.getTransactionId(binderProxy, <span class="string">&quot;TRANSACTION_getDeviceId&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">//();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> deviceId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ServiceManager</code> 提供的 <code>IBinder</code> 和 <code>ITelephony</code> 的 <code>asInterface</code> 方法分别工作在 <strong>连接层</strong> 和 <strong>接口协议层</strong>，它们各司其职，共同完成了整个跨进程通信（IPC）的流程</p>
<h3 id="deviceid"><a href="#deviceid" class="headerlink" title="deviceid"></a>deviceid</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressLint(&quot;MissingPermission&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDeviceId</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">    String deviceId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//先看底下</span></span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(deviceId = ITelephonyUtil.getDeviceIdLevel2(context))</span><br><span class="line">            || !TextUtils.isEmpty(deviceId = IPhoneSubInfoUtil.getDeviceIdLevel2(context))) &#123;</span><br><span class="line">        <span class="keyword">return</span> deviceId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//再看中部</span></span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(deviceId = ITelephonyUtil.getDeviceIdLevel1(context))</span><br><span class="line">            || !TextUtils.isEmpty(deviceId = IPhoneSubInfoUtil.getDeviceIdLevel1(context))) &#123;</span><br><span class="line">        <span class="keyword">return</span> deviceId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//再看上部</span></span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(deviceId = IPhoneSubInfoUtil.getDeviceIdLevel0(context))</span><br><span class="line">            || !TextUtils.isEmpty(deviceId = ITelephonyUtil.getDeviceIdLevel0(context))) &#123;</span><br><span class="line">        <span class="keyword">return</span> deviceId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">TelephonyManager</span> <span class="variable">telephonyManager</span> <span class="operator">=</span> ((TelephonyManager) context.getSystemService(Context.TELEPHONY_SERVICE));</span><br><span class="line">        deviceId =telephonyManager.getDeviceId();</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception ignore)&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> deviceId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法按照从最难 Hook 到最容易 Hook 的顺序</p>
<h4 id="Level2"><a href="#Level2" class="headerlink" title="Level2"></a>Level2</h4><p>第一个先从<code>ITelephonyUtil.getDeviceIdLevel2(context)</code></p>
<p><code>IPhoneSubInfoUtil.getDeviceIdLevel2(context)</code>这两个函数获取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//风险  如果底层ROM改了ServiceManager，那就可能有问题，但是概率很小</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDeviceIdLevel2</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">deviceId</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">ServiceManager</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.os.ServiceManager&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getService</span> <span class="operator">=</span> ServiceManager.getDeclaredMethod(<span class="string">&quot;getService&quot;</span>, String.class);</span><br><span class="line">        getService.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> (IBinder) getService.invoke(<span class="literal">null</span>, <span class="string">&quot;iphonesubinfo&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">Stub</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.android.internal.telephony.IPhoneSubInfo$Stub&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">asInterface</span> <span class="operator">=</span> Stub.getDeclaredMethod(<span class="string">&quot;asInterface&quot;</span>, IBinder.class);</span><br><span class="line">        asInterface.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">binderProxy</span> <span class="operator">=</span> asInterface.invoke(<span class="literal">null</span>, binder);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>, String.class);</span><br><span class="line">            <span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">                deviceId = binderGetHardwareInfo(context.getPackageName(),</span><br><span class="line">                        binder, BinderUtil.getInterfaceDescriptor(binderProxy),</span><br><span class="line">                        BinderUtil.getTransactionId(binderProxy, <span class="string">&quot;TRANSACTION_getDeviceId&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">            deviceId = binderGetHardwareInfo(<span class="string">&quot;&quot;</span>,</span><br><span class="line">                    binder, BinderUtil.getInterfaceDescriptor(binderProxy),</span><br><span class="line">                    BinderUtil.getTransactionId(binderProxy, <span class="string">&quot;TRANSACTION_getDeviceId&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">//();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> deviceId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">ServiceManager</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.os.ServiceManager&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">getService</span> <span class="operator">=</span> ServiceManager.getDeclaredMethod(<span class="string">&quot;getService&quot;</span>, String.class);</span><br><span class="line">getService.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> (IBinder) getService.invoke(<span class="literal">null</span>, <span class="string">&quot;iphonesubinfo&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这里获取的是<code>IBinder</code>对象，是<code>android.os.BinderProxy</code>类</p>
<p>通过<code>asInterface</code>调用转换成<code>...IPhoneSubInfo$Stub$Proxy</code>类</p>
<p>简单来说，<code>asInterface</code> 就是一个<strong>适配器（Adapter）或者工厂方法</strong>，它将一个通用的、底层的 <code>BinderProxy</code> 对象，转换成了一个专用的、易于使用的服务接口代理<code>$Stub$Proxy</code>对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>, String.class);</span><br><span class="line"><span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">    deviceId = binderGetHardwareInfo(context.getPackageName(),</span><br><span class="line">            binder, BinderUtil.getInterfaceDescriptor(binderProxy),</span><br><span class="line">            BinderUtil.getTransactionId(binderProxy, <span class="string">&quot;TRANSACTION_getDeviceId&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>而真正的核心实现在于<code>binderGetHardwareInfo</code>，模拟了底层的IPC交互</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    其实这里多一个参数并没有什么影响</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">binderGetHardwareInfo</span><span class="params">(String callingPackage,</span></span><br><span class="line"><span class="params">                                            IBinder remote,</span></span><br><span class="line"><span class="params">                                            String DESCRIPTOR,</span></span><br><span class="line"><span class="params">                                            <span class="type">int</span> tid)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"></span><br><span class="line">    android.os.<span class="type">Parcel</span> <span class="variable">_data</span> <span class="operator">=</span> android.os.Parcel.obtain();</span><br><span class="line">    android.os.<span class="type">Parcel</span> <span class="variable">_reply</span> <span class="operator">=</span> android.os.Parcel.obtain();</span><br><span class="line">    String _result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(callingPackage)) &#123;</span><br><span class="line">            _data.writeString(callingPackage);</span><br><span class="line">        &#125;</span><br><span class="line">        remote.transact(tid, _data, _reply, <span class="number">0</span>);</span><br><span class="line">        _reply.readException();</span><br><span class="line">        _result = _reply.readString();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        _reply.recycle();</span><br><span class="line">        _data.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android.os.<span class="type">Parcel</span> <span class="variable">_data</span> <span class="operator">=</span> android.os.Parcel.obtain();</span><br><span class="line">android.os.<span class="type">Parcel</span> <span class="variable">_reply</span> <span class="operator">=</span> android.os.Parcel.obtain();</span><br></pre></td></tr></table></figure>

<p><strong>首先获取两个<code>Parcel</code>对象</strong></p>
<blockquote>
<p><code>Parcel</code> 是 Android 中用于在进程间传递数据的高性能容器。</p>
<ul>
<li><code>_data</code>: 用来打包所有需要<strong>发送给</strong>远程服务的数据，包括要调用的接口信息和方法参数</li>
<li><code>_reply</code>: 用来接收远程服务<strong>返回的</strong>数据，包括返回值和可能的异常信息</li>
<li><code>obtain()</code>: 从一个全局池中获取可复用的 <code>Parcel</code> 对象，以提高性能，避免频繁创建和销毁对象</li>
</ul>
</blockquote>
<p><strong>然后写入接口描述符</strong> (<code>writeInterfaceToken</code>)，<code>_data.writeInterfaceToken(DESCRIPTOR)</code></p>
<p>其中<code>DESCRIPTOR</code>是唯一标识字符串</p>
<p>代表了要调用的接口（例如<code>&quot;com.android.internal.telephony.IPhoneSubInfo&quot;</code>），在 <code>_data</code> 包的最开始写入这个“<strong>令牌</strong>”，远程服务在收到数据后会首先读取并验证它，确保客户端请求的是正确的服务接口，防止调用混乱</p>
<p><strong>之后写入方法参数</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!TextUtils.isEmpty(callingPackage)) &#123;</span><br><span class="line">    _data.writeString(callingPackage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里将 <code>getDeviceId</code> 方法所需的参数写入 <code>_data</code> 包，此时参数是通过<code>context.getPackageName()</code>获取，即是调用方的包名</p>
<ul>
<li>如果 <code>callingPackage</code> 不为空，就将其写入 <code>_data</code>，对应 <code>getDeviceId(String pkg)</code> 这种方法签名。</li>
<li>如果 <code>callingPackage</code> 为空，就不写入任何东西，对应 <code>getDeviceId()</code> 这种无参的方法签名。</li>
</ul>
<p><strong>发起远程事务 (<code>transact</code>)</strong></p>
<ul>
<li><code>remote.transact(tid, _data, _reply, 0);</code></li>
</ul>
<p>这是整个过程的核心，它真正地发起了跨进程调用。</p>
<p><code>remote</code>: 这是从 <code>ServiceManager</code> 获取到的原始 <code>IBinder</code> 对象（一个 <code>BinderProxy</code> 实例），代表了通往远程服务的连接通道。</p>
<p><code>tid</code>参数就是<code>TransactionId</code>（事务id），然后<code>_data</code>包含接口令牌和参数的输入数据包，<code>_reply</code>用于接收返回结果的空数据包，<code>0</code>是事务标志位，<code>0</code> 表示这是一次标准的同步调用，方法会阻塞直到远程服务处理完毕并返回结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    _reply.readException();</span><br><span class="line">    _result = _reply.readString();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    _reply.recycle();</span><br><span class="line">    _data.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>最后就处理返回结果和回收Parcel对象了</strong></p>
<p>但是从 <code>Android 10 (API 29)</code> 开始，获取是可以正常获取，但是就无法正常使用了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TelephonyPermissions    com.android.phone                    W  reportAccessDeniedToReadIdentifiers:com.sheep.anti:getDeviceId:-1</span><br></pre></td></tr></table></figure>

<p>会报错误显示没权限访问</p>
<h4 id="Level1"><a href="#Level1" class="headerlink" title="Level1"></a>Level1</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDeviceIdLevel1</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">ServiceManager</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.os.ServiceManager&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getService</span> <span class="operator">=</span> ServiceManager.getDeclaredMethod(<span class="string">&quot;getService&quot;</span>, String.class);</span><br><span class="line">        getService.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> (IBinder) getService.invoke(<span class="literal">null</span>, <span class="string">&quot;iphonesubinfo&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">Stub</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.android.internal.telephony.IPhoneSubInfo$Stub&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">asInterface</span> <span class="operator">=</span> Stub.getDeclaredMethod(<span class="string">&quot;asInterface&quot;</span>, IBinder.class);</span><br><span class="line">        asInterface.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">binderProxy</span> <span class="operator">=</span> asInterface.invoke(<span class="literal">null</span>, binder);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>, String.class);</span><br><span class="line">            <span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> (String) getDeviceId.invoke(binderProxy, context.getPackageName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (String) getDeviceId.invoke(binderProxy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">//();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就是直接调用<code>com.android.internal.telephony.IPhoneSubInfo$Stub$Proxy-&gt;getDeviceId</code>方法</p>
<h4 id="Level0"><a href="#Level0" class="headerlink" title="Level0"></a>Level0</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDeviceIdLevel0</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="type">TelephonyManager</span> <span class="variable">telephonyManager</span> <span class="operator">=</span> ((TelephonyManager) context.getSystemService(Context.TELEPHONY_SERVICE));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> TelephonyManager.class.getDeclaredMethod(<span class="string">&quot;getSubscriberInfo&quot;</span>);</span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">binderProxy</span> <span class="operator">=</span> method.invoke(telephonyManager);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>, String.class);</span><br><span class="line">            <span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> (String) getDeviceId.invoke(binderProxy, context.getPackageName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (String) getDeviceId.invoke(binderProxy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">//();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>getSubscriberInfo</code>获取其代理对象，剩下步骤都差不多了</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://s1nec-1o.github.io">s1nec-1o</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://s1nec-1o.github.io/2025/11/03/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%E4%B9%8BAntiFakerAndroidChecker/">http://s1nec-1o.github.io/2025/11/03/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%E4%B9%8BAntiFakerAndroidChecker/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://s1nec-1o.github.io" target="_blank">S1nec-1o's B1og</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/android/">android</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2025/10/21/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%E4%B9%8B%E5%88%9D%E8%AF%86%E9%A3%8E%E6%8E%A7-2/" title="Android逆向从入门到入土之初识风控(2)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android逆向从入门到入土之初识风控(2)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2025/04/14/Android%E9%80%86%E5%90%91%E4%B9%8BWiki%E7%AF%87/" title="Android逆向之Wiki篇"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-14</div><div class="title">Android逆向之Wiki篇</div></div></a></div><div><a href="/2025/10/11/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F-1/" title="Android逆向从入门到入土(1)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-11</div><div class="title">Android逆向从入门到入土(1)</div></div></a></div><div><a href="/2025/10/21/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%E4%B9%8B%E5%88%9D%E8%AF%86%E9%A3%8E%E6%8E%A7-2/" title="Android逆向从入门到入土之初识风控(2)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-21</div><div class="title">Android逆向从入门到入土之初识风控(2)</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">s1nec-1o</div><div class="author-info__description">万事胜意</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">25</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="http://github.com/s1nec-1o"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">正在学习iot pwn 欢迎广大师傅与我交流</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E5%99%A8%E6%A3%80%E6%B5%8B"><span class="toc-number">2.</span> <span class="toc-text">模拟器检测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MainActivity-java"><span class="toc-number">2.1.</span> <span class="toc-text">MainActivity.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#onCreate"><span class="toc-number">2.2.</span> <span class="toc-text">onCreate</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#checkEmulatorFromCache"><span class="toc-number">2.2.1.</span> <span class="toc-text">checkEmulatorFromCache</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EmulatorCheckService"><span class="toc-number">2.2.2.</span> <span class="toc-text">EmulatorCheckService</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#onCreate-1"><span class="toc-number">2.3.</span> <span class="toc-text">onCreate</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mayOnEmulatorViaQEMU"><span class="toc-number">2.3.1.</span> <span class="toc-text">mayOnEmulatorViaQEMU</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#isEmulatorViaBuild"><span class="toc-number">2.3.2.</span> <span class="toc-text">isEmulatorViaBuild</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#isEmulatorFromAbi"><span class="toc-number">2.3.3.</span> <span class="toc-text">isEmulatorFromAbi</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#isEmulatorFromCpu"><span class="toc-number">2.3.4.</span> <span class="toc-text">isEmulatorFromCpu</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#onCreate-2"><span class="toc-number">2.4.</span> <span class="toc-text">onCreate</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#deviceid%E8%8E%B7%E5%8F%96"><span class="toc-number">3.</span> <span class="toc-text">deviceid获取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AndroidDeviceIMEIUtil-java"><span class="toc-number">3.1.</span> <span class="toc-text">AndroidDeviceIMEIUtil.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BatteryChangeReceiver-java"><span class="toc-number">3.2.</span> <span class="toc-text">BatteryChangeReceiver.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BinderUtil-java"><span class="toc-number">3.3.</span> <span class="toc-text">BinderUtil.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CrashHandler-java"><span class="toc-number">3.4.</span> <span class="toc-text">CrashHandler.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IpScanner-java"><span class="toc-number">3.5.</span> <span class="toc-text">IpScanner.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ShellAdbUtils-java"><span class="toc-number">3.6.</span> <span class="toc-text">ShellAdbUtils.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#androidid"><span class="toc-number">3.7.</span> <span class="toc-text">androidid</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#deviceid"><span class="toc-number">3.8.</span> <span class="toc-text">deviceid</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Level2"><span class="toc-number">3.8.1.</span> <span class="toc-text">Level2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Level1"><span class="toc-number">3.8.2.</span> <span class="toc-text">Level1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Level0"><span class="toc-number">3.8.3.</span> <span class="toc-text">Level0</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/03/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%E4%B9%8BAntiFakerAndroidChecker/" title="Android逆向从入门到入土之AntiFakerAndroidChecker(3)">Android逆向从入门到入土之AntiFakerAndroidChecker(3)</a><time datetime="2025-11-03T13:26:59.000Z" title="发表于 2025-11-03 21:26:59">2025-11-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/21/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%E4%B9%8B%E5%88%9D%E8%AF%86%E9%A3%8E%E6%8E%A7-2/" title="Android逆向从入门到入土之初识风控(2)">Android逆向从入门到入土之初识风控(2)</a><time datetime="2025-10-21T14:17:54.000Z" title="发表于 2025-10-21 22:17:54">2025-10-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/11/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F-1/" title="Android逆向从入门到入土(1)">Android逆向从入门到入土(1)</a><time datetime="2025-10-11T06:38:08.000Z" title="发表于 2025-10-11 14:38:08">2025-10-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/05/CVE-2024-35250%E5%A4%8D%E7%8E%B0/" title="CVE-2024-35250复现">CVE-2024-35250复现</a><time datetime="2025-09-05T13:13:44.000Z" title="发表于 2025-09-05 21:13:44">2025-09-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/16/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bafl-fuzz%E7%BB%93%E6%9D%9F/" title="AFL源码阅读之afl-fuzz结束">AFL源码阅读之afl-fuzz结束</a><time datetime="2025-08-16T07:03:01.000Z" title="发表于 2025-08-16 15:03:01">2025-08-16</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281616326.png')"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By s1nec-1o</div><div class="footer_custom_text">介是s1nec-1o的博客</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.12.0"></script><script src="/js/main.js?v=4.12.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><div><canvas id="snow" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:99999;pointer-events:none"></canvas></div><script>const notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));</script><script async type="text/javascript" src="https://cdn.jsdelivr.net/gh/Candinya/Kratos-Rebirth@latest/source/js/snow.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>