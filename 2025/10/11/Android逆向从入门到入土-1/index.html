<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Android逆向从入门到入土(1) | S1nec-1o's B1og</title><meta name="author" content="s1nec-1o"><meta name="copyright" content="s1nec-1o"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言只做学习记录的备份，来自于 [原创]Android漏洞之战（11）——整体加壳原理和脱壳技巧详解  《安卓逆向这档事》 Android App启动流程  Zygote进程fork的第一个进程是：SystemServer进程，SystemServer进程主要进行以下的工作   Android APP安装1234· 系统启动时安装，没有安装界面· 第三方应用安装，有安装界面，也是我们最熟悉的方式·">
<meta property="og:type" content="article">
<meta property="og:title" content="Android逆向从入门到入土(1)">
<meta property="og:url" content="http://s1nec-1o.github.io/2025/10/11/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F-1/index.html">
<meta property="og:site_name" content="S1nec-1o&#39;s B1og">
<meta property="og:description" content="前言只做学习记录的备份，来自于 [原创]Android漏洞之战（11）——整体加壳原理和脱壳技巧详解  《安卓逆向这档事》 Android App启动流程  Zygote进程fork的第一个进程是：SystemServer进程，SystemServer进程主要进行以下的工作   Android APP安装1234· 系统启动时安装，没有安装界面· 第三方应用安装，有安装界面，也是我们最熟悉的方式·">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png">
<meta property="article:published_time" content="2025-10-11T06:38:08.000Z">
<meta property="article:modified_time" content="2025-10-11T07:45:29.720Z">
<meta property="article:author" content="s1nec-1o">
<meta property="article:tag" content="android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281712481.jpg"><link rel="canonical" href="http://s1nec-1o.github.io/2025/10/11/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F-1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css?v=4.12.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"距离文章发布已经过去","messageNext":"天了，信息可能已经过时"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Android逆向从入门到入土(1)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-10-11 15:45:29'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 8 || hour >= 20
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/atom.xml" title="S1nec-1o's B1og" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">25</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281616326.png')"><nav id="nav"><span id="blog-info"><a href="/" title="S1nec-1o's B1og"><span class="site-name">S1nec-1o's B1og</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Android逆向从入门到入土(1)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-10-11T06:38:08.000Z" title="发表于 2025-10-11 14:38:08">2025-10-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-10-11T07:45:29.720Z" title="更新于 2025-10-11 15:45:29">2025-10-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/">安卓逆向</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>只做学习记录的备份，来自于</p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-273293.htm">[原创]Android漏洞之战（11）——整体加壳原理和脱壳技巧详解</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.52pojie.cn/home.php?mod=space&uid=1109458">《安卓逆向这档事》</a></p>
<h2 id="Android-App启动流程"><a href="#Android-App启动流程" class="headerlink" title="Android App启动流程"></a>Android App启动流程</h2><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544534.png" alt="image-20250928213056553" style="zoom:50%;" />

<p><code>Zygote</code>进程fork的第一个进程是：<code>SystemServer</code>进程，<code>SystemServer</code>进程主要进行以下的工作</p>
<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544536.png" alt="image-20250928213032187"  />

<h3 id="Android-APP安装"><a href="#Android-APP安装" class="headerlink" title="Android APP安装"></a>Android APP安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">· 系统启动时安装，没有安装界面</span><br><span class="line">· 第三方应用安装，有安装界面，也是我们最熟悉的方式</span><br><span class="line">· ADB命令安装，没有安装界面</span><br><span class="line">· 通过各类应用市场安装，没有安装界面</span><br></pre></td></tr></table></figure>

<p>有这四种安装模式</p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544537.png" alt="image-20250928215538686"></p>
<p>但是都是通过<code>PackgeManagerService</code>服务来完成应用程序的安装的，而<code>PackgeManagerService</code>服务会与<code>installed</code>服务通信，发送具体的指令来执行应用程序的安装、卸载等工作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> IPackageManager <span class="title function_">main</span><span class="params">(Context context, Installer installer,</span></span><br><span class="line"><span class="params">    <span class="type">boolean</span> factoryTest, <span class="type">boolean</span> onlyCore)</span> &#123;</span><br><span class="line">        <span class="type">PackageManagerService</span> <span class="variable">m</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageManagerService</span>(context, installer, factoryTest, onlyCore);</span><br><span class="line">        ServiceManager.addService(<span class="string">&quot;package&quot;</span>, m);</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里的<code>PackgeManagerService</code>其实就是上述的<code>PackageManager</code>服务注册的</p>
</blockquote>
<p><code>IPackageManager</code>函数是Android系统中包管理服务的初始化入口，初始化<code>PackageManagerService</code>，将服务加入到系统服务管理器中，然后返回<code>PackgeManagerService</code>的实例供用户使用</p>
<p>应用程序在安装时涉及到如下几个重要目录：</p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544538.png" alt="image-20250928220334806"></p>
<p>App的安装流程是由<code>PackageManagerService</code>完成的，此前<code>SystemServer</code>就已经启动了一个更重要的服务<code>ActivityManagerService</code>，<code>ActivityManagerService</code>其中一个重要的作用就是在启动完<code>PackageManagerService</code>之后将<code>Launcher</code>进程启动起来</p>
<h4 id="Launcher启动流程"><a href="#Launcher启动流程" class="headerlink" title="Launcher启动流程"></a><a target="_blank" rel="noopener" href="https://blog.csdn.net/itachi85/article/details/56669808">Launcher</a>启动流程</h4><p>启动<code>Launcher</code>的入口为<code>ActivityManagerService</code>的<code>systemReady</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startOtherServices</span><span class="params">()</span> &#123;</span><br><span class="line">...</span><br><span class="line">mActivityManagerService.systemReady(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">&quot;Making services ready&quot;</span>);</span><br><span class="line">            mSystemServiceManager.startBootPhase(</span><br><span class="line">                    SystemService.PHASE_ACTIVITY_MANAGER_READY);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>startOtherServices</code>函数中，会调用<code>ActivityManagerService</code>的<code>systemReady</code>函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">systemReady</span><span class="params">(<span class="keyword">final</span> Runnable goingCallback)</span> &#123;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">       ...</span><br><span class="line">        mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">        mUserController.sendUserSwitchBroadcastsLocked(-<span class="number">1</span>, currentUserId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>systemReady</code>函数中调用了<code>ActivityStackSupervisor</code>的<code>resumeFocusedStackTopActivityLocked</code>函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">resumeFocusedStackTopActivityLocked</span><span class="params">(</span></span><br><span class="line"><span class="params">        ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (targetStack != <span class="literal">null</span> &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class="line">        <span class="keyword">return</span> targetStack.resumeTopActivityUncheckedLocked(target, targetOptions); <span class="comment">//1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ActivityRecord</span> <span class="variable">r</span> <span class="operator">=</span> mFocusedStack.topRunningActivityLocked();</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="literal">null</span> || r.state != RESUMED) &#123;</span><br><span class="line">        mFocusedStack.resumeTopActivityUncheckedLocked(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在注释1处会调用<code>ActivityStack</code>的<code>resumeTopActivityUncheckedLocked</code>函数，<code>ActivityStack</code>对象是用来描述<code>Activity</code>堆栈的，<code>resumeTopActivityUncheckedLocked</code>函数如下所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">resumeTopActivityUncheckedLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mStackSupervisor.inResumeTopActivity) &#123;</span><br><span class="line">        <span class="comment">// Don&#x27;t even start recursing.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Protect against recursion.</span></span><br><span class="line">        mStackSupervisor.inResumeTopActivity = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (mService.mLockScreenShown == ActivityManagerService.LOCK_SCREEN_LEAVING) &#123;</span><br><span class="line">            mService.mLockScreenShown = ActivityManagerService.LOCK_SCREEN_HIDDEN;</span><br><span class="line">            mService.updateSleepIfNeededLocked();</span><br><span class="line">        &#125;</span><br><span class="line">        result = resumeTopActivityInnerLocked(prev, options);<span class="comment">//1</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mStackSupervisor.inResumeTopActivity = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>调用了<code>resumeTopActivityInnerLocked</code>函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> &#123;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">return</span> isOnHomeDisplay() &amp;&amp;</span><br><span class="line">                    mStackSupervisor.resumeHomeStackTask(returnTaskType, prev, <span class="string">&quot;prevFinished&quot;</span>);</span><br><span class="line">...                 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用<code>ActivityStackSupervisor</code>的<code>resumeHomeStackTask</code>函数，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">resumeHomeStackTask</span><span class="params">(<span class="type">int</span> homeStackTaskType, ActivityRecord prev, String reason)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="literal">null</span> &amp;&amp; !r.finishing) &#123;</span><br><span class="line">        mService.setFocusedActivityLocked(r, myReason);</span><br><span class="line">        <span class="keyword">return</span> resumeFocusedStackTopActivityLocked(mHomeStack, prev, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mService.startHomeActivityLocked(mCurrentUser, myReason);<span class="comment">//1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了<code>ActivityManagerService</code>的<code>startHomeActivityLocked</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">startHomeActivityLocked</span><span class="params">(<span class="type">int</span> userId, String reason)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL</span><br><span class="line">            &amp;&amp; mTopAction == <span class="literal">null</span>) &#123;<span class="comment">//1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getHomeIntent();<span class="comment">//2</span></span><br><span class="line">    <span class="type">ActivityInfo</span> <span class="variable">aInfo</span> <span class="operator">=</span> resolveActivityInfo(intent, STOCK_PM_FLAGS, userId);</span><br><span class="line">    <span class="keyword">if</span> (aInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">        intent.setComponent(<span class="keyword">new</span> <span class="title class_">ComponentName</span>(aInfo.applicationInfo.packageName, aInfo.name));</span><br><span class="line">        aInfo = <span class="keyword">new</span> <span class="title class_">ActivityInfo</span>(aInfo);</span><br><span class="line">        aInfo.applicationInfo = getAppInfoForUser(aInfo.applicationInfo, userId);</span><br><span class="line">        <span class="type">ProcessRecord</span> <span class="variable">app</span> <span class="operator">=</span> getProcessRecordLocked(aInfo.processName,</span><br><span class="line">                aInfo.applicationInfo.uid, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (app == <span class="literal">null</span> || app.instrumentationClass == <span class="literal">null</span>) &#123;<span class="comment">//3</span></span><br><span class="line">            intent.setFlags(intent.getFlags() | Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">            mActivityStarter.startHomeActivityLocked(intent, aInfo, reason);<span class="comment">//4</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">&quot;No home screen found for &quot;</span> + intent, <span class="keyword">new</span> <span class="title class_">Throwable</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处的<code>mFactoryTest</code>代表<strong>系统的运行模式</strong>，系统的运行模式分为三种，分别是<strong>非工厂模式、低级工厂模式和高级工厂模式</strong>，<code>mTopAction</code>则用来描述<strong>第一个</strong>被启动Activity组件的<code>Action</code>，它的值为<code>Intent.ACTION_MAIN</code>。</p>
<p>因此注释1的代码意思就是<code>mFactoryTest</code>为<code>FactoryTest.FACTORY_TEST_LOW_LEVEL</code>（低级工厂模式）并且<code>mTopAction=null</code>时，直接返回false。注释2处的<code>getHomeIntent</code>函数如下所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Intent <span class="title function_">getHomeIntent</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(mTopAction, mTopData != <span class="literal">null</span> ? Uri.parse(mTopData) : <span class="literal">null</span>);</span><br><span class="line">    intent.setComponent(mTopComponent);</span><br><span class="line">    intent.addFlags(Intent.FLAG_DEBUG_TRIAGED_MISSING);</span><br><span class="line">    <span class="keyword">if</span> (mFactoryTest != FactoryTest.FACTORY_TEST_LOW_LEVEL) &#123;</span><br><span class="line">        intent.addCategory(Intent.CATEGORY_HOME);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> intent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>getHomeIntent</code>函数中创建了<code>Intent</code>，并将<code>mTopAction</code>和<code>mTopData</code>传入。<code>mTopAction</code>的值为<code>Intent.ACTION_MAIN</code>，并且如果系统运行模式不是低级工厂模式则将<code>intent</code>的<code>Category</code>设置为<code>Intent.CATEGORY_HOME</code></p>
<p>我们再回到<code>ActivityManagerService</code>的<code>startHomeActivityLocked</code>函数</p>
<p>假设系统的运行模式不是低级工厂模式，在注释3处判断符合<code>Action</code>为<code>Intent.ACTION_MAIN</code>，<code>Category</code>为<code>Intent.CATEGORY_HOME</code>的应用程序是否已经启动，如果没启动则调用注释4的方法启动该应用程序。</p>
<p>这个被启动的应用程序就是<code>Launcher</code>，因为<code>Launcher</code>的<code>Manifest</code>文件中的<code>intent-filter</code>标签匹配了<code>Action</code>为<code>Intent.ACTION_MAIN</code>，<code>Category</code>为<code>Intent.CATEGORY_HOME</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.android.launcher3&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">android:targetSdkVersion</span>=<span class="string">&quot;23&quot;</span> <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;16&quot;</span>/&gt;</span></span><br><span class="line"> ...</span><br><span class="line"> <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span></span></span><br><span class="line"><span class="tag">        &lt;<span class="attr">activity</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;com.android.launcher3.Launcher&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:launchMode</span>=<span class="string">&quot;singleTask&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:clearTaskOnLaunch</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:stateNotNeeded</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:windowSoftInputMode</span>=<span class="string">&quot;adjustPan&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:screenOrientation</span>=<span class="string">&quot;nosensor&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:configChanges</span>=<span class="string">&quot;keyboard|keyboardHidden|navigation&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:resumeWhilePausing</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:taskAffinity</span>=<span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.HOME&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.MONKEY&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">application</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span>         </span><br></pre></td></tr></table></figure>

<p>之后<code>Launcher</code>就会开始执行<code>onCreate</code>了</p>
<h4 id="App启动流程"><a href="#App启动流程" class="headerlink" title="App启动流程"></a>App启动流程</h4><p>应用程序<code>Launcher</code>在启动过程中会请求<code>PackageManagerService</code>返回系统中已经安装的应用程序的信息，并将这些信息封装成一个快捷图标列表显示在系统屏幕上，这样用户可以通过点击这些快捷图标来启动相应的应用程序</p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544539.png" alt="image-20250928223841904"></p>
<ol>
<li>点击桌面APP图标时，Launcher的<code>startActivity()</code>方法，通过<code>Binder</code>通信，调用system_server进程中AMS服务的<code>startActivity</code>方法，<strong>发起启动请求</strong></li>
<li><code>system_server</code>进程接收到请求后，向<code>Zygote</code>进程<strong>发送创建进程的请求</strong></li>
<li>Zygote进程fork出App进程，并执行<code>ActivityThread</code>的main方法，创建ActivityThread线程，初始化<code>MainLooper</code>，主线程Handler，同时<strong>初始化ApplicationThread用于和AMS通信交互</strong></li>
<li>App进程，通过Binder向sytem_server进程发起<code>attachApplication</code>请求，这里实际上就是APP进程<strong>通过Binder调用sytem_server进程中AMS的attachApplication方法</strong>,AMS的attachApplication方法的作用是<strong>将ApplicationThread对象与AMS绑定</strong></li>
<li>system_server进程在收到attachApplication的请求，进行一些准备工作后，再通过binder IPC向App进程<strong>发送handleBindApplication请求</strong>（初始化Application并调用onCreate方法）和scheduleLaunchActivity请求（创建启动Activity）</li>
<li>App进程的binder线程（ApplicationThread）在收到请求后，<strong>通过handler向主线程发送BIND_APPLICATION和LAUNCH_ACTIVITY消息</strong>，这里注意的是AMS和主线程并不直接通信，而是AMS和主线程的内部类<code>ApplicationThread</code>通过Binder通信，<code>ApplicationThread</code>再和主线程通过Handler消息交互。</li>
<li>主线程在收到Message后，<strong>创建Application并调用onCreate方法</strong>，再通过反射机制创建目标Activity，并回调<code>Activity.onCreate()</code>等方法</li>
<li>到此，App便正式启动，开始进入Activity生命周期，执行完<code>onCreate/onStart/onResume</code>方法，UI渲染后显示APP主界面</li>
</ol>
<p>这里我们就进入了加壳中十分重要的地方<code>ActivityTread</code>，之后就是调用各种函数来启动APP，过程如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">App的运行流程是</span><br><span class="line">    初始化————&gt;Application的构造函数————&gt;Application.attachBaseContext()————&gt;Application.onCreate()函数</span><br></pre></td></tr></table></figure>

<p>最后才会进入<code>MainActivity</code>中的<code>attachBaseContext</code>函数、<code>onCreate</code>函数</p>
<p>所以加壳厂商要在程序正式执行前，也就是上面的流程中进行<strong>动态加载和类加载器的修正</strong>，这样才能对加密的dex进行释放，而一般的厂商往往选择在<strong>Application中的attachBaseContext或onCreate函数</strong>进行</p>
<h2 id="整体加壳原理详解"><a href="#整体加壳原理详解" class="headerlink" title="整体加壳原理详解"></a>整体加壳原理详解</h2><h3 id="深入理解类加载器和动态加载"><a href="#深入理解类加载器和动态加载" class="headerlink" title="深入理解类加载器和动态加载"></a>深入理解类加载器和动态加载</h3><p>在学习如何对App加上一层外壳之前，需要详细了解<strong>类加载器和动态加载</strong>的机制</p>
<h4 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h4><p>Android中的类加载器机制与JVM一样遵循双亲委派模式</p>
<h5 id="双亲委派模式"><a href="#双亲委派模式" class="headerlink" title="双亲委派模式"></a>双亲委派模式</h5><p>代码解释：</p>
<ol>
<li><p>首先检查该类是否已被加载</p>
</li>
<li><p>若未加载，则委托给父类的<code>Loader</code>加载，如果没有父类则委托给<code>BootClassLoader</code>尝试加载</p>
</li>
<li><p>若<code>BootClassLoader</code>无法加载，则<code>PathClassLoader</code>尝试从应用的dex文件中加载</p>
</li>
<li><p>若需要动态加载外部dex，则使用<code>DexClassLoader</code></p>
</li>
</ol>
<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544540.png" alt="image-20250929131650468" style="zoom:33%;" />

<p><strong>双亲委派模式加载</strong></p>
<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544541.png" alt="image-20250929132247135" style="zoom:50%;" />

<p>我们要加载一个<code>class</code>文件，我们定义了一个<code>CustomerClassLoader</code>类加载器:<br>(1)首先会判断自己的<code>CustomerClassLoader</code>否加载过,如果加载过直接返回,<br>(2)如果没有加载过则会调用父类<code>PathClassLoader</code>去加载,该父类同样会<strong>判断</strong>自己是否加载过,如果没有加载过则委托给父类<code>BootClassLoader</code>去加载,<br>(3)这个<code>BootClassLoader</code>是顶级<code>classLoader</code>,同样会去<strong>判断</strong>自己有没有加载过,如果也没有加载过则会调用自己的<code>findClass(name)</code>去加载,<br>(4)如果顶级<code>BootClassLoader</code>加载<strong>失败</strong>了,则会把加载这个动作<strong>向下交还</strong>给<code>PathClassLoader</code>,<br>(5)这个<code>PathClassLoader</code>也会尝试去调用<code>findClass(name);</code>去加载,如果加载失败了,则会继续向下交还给<code>CustomClassLoader</code>来完成加载,这整个过程感觉是一个<strong>递归</strong>的过程,逐渐往上然后有逐渐往下,直到加载成功<br>其实这个<code>String.class</code>在系统启动的时候已经被加载了,我们自己定义一个<code>CustomerClassLoader</code>去加载,其实也是父类加载的</p>
<h5 id="Android中类加载机制"><a href="#Android中类加载机制" class="headerlink" title="Android中类加载机制"></a>Android中类加载机制</h5><p>Android的类加载机制和JVM一样遵循双亲委派模式，在dalvik&#x2F;art启动时将所有Java基本类和Android系统框架的基本类加载进来，预加载的类记录在<code>/frameworks/base/config/preloaded-classes</code>中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">android.R$styleable</span><br><span class="line">android.accessibilityservice.AccessibilityServiceInfo$<span class="number">1</span></span><br><span class="line">android.accessibilityservice.AccessibilityServiceInfo</span><br><span class="line">android.accessibilityservice.IAccessibilityServiceClient$Stub$Proxy</span><br><span class="line">android.accessibilityservice.IAccessibilityServiceClient$Stub</span><br><span class="line">android.accessibilityservice.IAccessibilityServiceClient</span><br><span class="line">android.accounts.AbstractAccountAuthenticator$Transport</span><br><span class="line">android.accounts.AbstractAccountAuthenticator</span><br><span class="line">android.accounts.Account$<span class="number">1</span></span><br><span class="line">android.accounts.Account</span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line">java.lang.Short</span><br><span class="line">java.lang.StackOverflowError</span><br><span class="line">java.lang.StackTraceElement</span><br><span class="line">java.lang.StrictMath</span><br><span class="line">java.lang.String$<span class="number">1</span></span><br><span class="line">java.lang.String$CaseInsensitiveComparator</span><br><span class="line">java.lang.String</span><br><span class="line">java.lang.StringBuffer</span><br><span class="line">java.lang.StringBuilder</span><br><span class="line">java.lang.StringFactory</span><br><span class="line">java.lang.StringIndexOutOfBoundsException</span><br><span class="line">java.lang.System$PropertiesWithNonOverrideableDefaults</span><br><span class="line">java.lang.System</span><br><span class="line">java.lang.Thread$<span class="number">1</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>这些类只需要在Zygote进程启动时加载一遍就可以了，后续每一个APP或Android运行时环境的进程，都是从Zygote中<code>fork</code>出来，天然保留了加载过的类缓存</p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544542.png" alt="image-20250929133634773"></p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544543.png" alt="image-20250929134222740"></p>
<p>Android中的<code>ClassLoader</code>类型分为<strong>系统ClassLoader</strong>和<strong>自定义ClassLoader</strong>。其中<strong>系统ClassLoader</strong>包括3种是<code>BootClassLoader</code>、<code>DexClassLoader</code>、<code>PathClassLoader</code></p>
<ol>
<li><code>BootClassLoader</code>:Android平台上所有Android系统启动时会使用BootClassLoader来预加载常用的类</li>
<li><code>BaseDexClassLoader</code>:实际应用层类文件的加载，而真正的加载委托给pathList来完成</li>
<li><code>DexClassLoader</code>:可以加载dex文件以及包含dex的压缩文件(apk,dex,jar,zip),可以安装一个未安装的apk文件，一般为自定义类加载器</li>
<li><code>PathClassLoader</code>:可以加载系统类和应用程序的类，通常用来加载已安装的apk的dex文件</li>
</ol>
<blockquote>
<p>Android 提供的原生加载器叫做<strong>基础类加载器</strong>，包括：<code>BootClassLoader，PathClassLoader，DexClassLoader，InMemoryDexClassLoader</code>（Android 8.0 引入）</p>
<p><code>DelegateLastClassLoader</code>（Android 8.1 引入）</p>
</blockquote>
<h5 id="BootClassLoader"><a href="#BootClassLoader" class="headerlink" title="BootClassLoader"></a>BootClassLoader</h5><p>启动类加载器，用于加载 <code>Zygote</code> 进程已经预加载的基本类，可以推测它只需从缓存中加载。这是基类 <code>ClassLoader</code> 的一个内部类，是包访问权限，所以应用程序无权直接访问</p>
<p><code>BootClassLoader</code>没有父加载器，在缓存取不到类是直接调用自己的<code>findClass()</code>方法<br><code>findClass()</code>方法调用<code>Class.classForName()</code>方法，而<code>ZygoteInit.preloadClasses()</code>中，加载基本类是<code>Class.forName()</code></p>
<p>无论是系统类加载器（<code>PathClassLoader</code>）还是自定义的类加载器（<code>DexClassLoader</code>），最顶层的祖先加载器默认是 <code>BootClassLoader</code>，与 JVM 一样，保证了基本类的类型安全</p>
<h5 id="Class文件加载："><a href="#Class文件加载：" class="headerlink" title="Class文件加载："></a>Class文件加载：</h5><ol>
<li>通过<code>Class.forName()</code>方法动态加载</li>
<li>通过<code>ClassLoader.loadClass()</code>方法动态加载</li>
</ol>
<p>类的加载分为3个步骤:<strong>1.装载(Load),2.链接(Link),3.初始化(Intialize)</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544544.png" alt="image-20250929140247689"></p>
<p><strong>类加载时机：</strong></p>
<p>1.隐式加载:</p>
<ol>
<li>创建类的实例,也就是new一个对象</li>
<li>访问某个类或接口的静态变量,或者对该静态变量赋值</li>
<li>调用类的静态方法</li>
<li>反射<code>Class.forName(&quot;android.app.ActivityThread&quot;)</code></li>
<li>初始化一个类的子类(会首先初始化子类的父类)</li>
</ol>
<p>2.显示加载：</p>
<ol>
<li>使用<code>LoadClass()</code>加载</li>
<li>使用<code>forName()</code>加载</li>
</ol>
<p><strong>Class.forName 和 ClassLoader.loadClass加载有何不同：</strong></p>
<ol>
<li><code>ClassLoader.loadClass</code>也能加载一个类,但是不会触发类的初始化(也就是说不会对类的静态变量,静态代码块进行初始化操作)</li>
<li><code>Class.forName</code>这种方式,不但会加载一个类,还会触发类的初始化阶段,也能够为这个类的静态变量,静态代码块进行初始化操作</li>
</ol>
<h5 id="PathClassLoader"><a href="#PathClassLoader" class="headerlink" title="PathClassLoader"></a>PathClassLoader</h5><p>主要用于系统和app的类加载器,其中<code>optimizedDirectory</code>为<code>null</code>, 采用默认目录<code>/data/dalvik-cache/</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PathClassLoader 是作为应用程序的系统类加载器，也是在 Zygote 进程启动的时候初始化的（基本流程为：ZygoteInit.main() -&gt; ZygoteInit.forkSystemServer() -&gt; ZygoteInit.handleSystemServerProcess() -&gt; ZygoteInit.createPathClassLoader()。在预加载基本类之后执行），所以每一个 APP 进程从 Zygote 中 fork 出来之后都自动携带了一个 PathClassLoader，它通常用于加载 apk 里面的 .dex 文件</span><br></pre></td></tr></table></figure>

<h5 id="DexClassLoader"><a href="#DexClassLoader" class="headerlink" title="DexClassLoader"></a>DexClassLoader</h5><p>我们可以发现<code>DexClassLoader</code>与<code>PathClassLoader</code>都继承于<code>BaseDexClassLoader</code>，这两个类只是提供了自己的构造函数，<strong>没有额外的实现</strong></p>
<p><strong>区别：</strong><br><code>DexClassLoader</code>提供了<code>optimizedDirectory</code>，而<code>PathClassLoader</code>则没有，<code>optimizedDirectory</code>正是用来存放<code>odex</code>文件的地方，所以可以利用<code>DexClassLoader</code>实现动态加载</p>
<h5 id="BaseDexClassLoader"><a href="#BaseDexClassLoader" class="headerlink" title="BaseDexClassLoader"></a>BaseDexClassLoader</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseDexClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DexPathList pathList;  <span class="comment">//记录dex文件路径信息</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BaseDexClassLoader</span><span class="params">(String dexPath, File optimizedDirectory, String libraryPath, ClassLoader parent)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(parent);</span><br><span class="line">        <span class="built_in">this</span>.pathList = <span class="keyword">new</span> <span class="title class_">DexPathList</span>(<span class="built_in">this</span>, dexPath, libraryPath, optimizedDirectory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>dexPath</code>: 包含目标类或资源的apk&#x2F;jar列表;当有多个路径则采用:分割;</li>
<li><code>optimizedDirectory</code>: 优化后dex文件存在的目录, 可以为null;</li>
<li><code>libraryPath</code>: native库所在路径列表;当有多个路径则采用:分割;</li>
<li><code>ClassLoader</code>:父类的类加载器</li>
</ul>
<p><code>BaseDexClassLoader</code>会初始化<code>dexPathList</code>，收集<code>dex</code>文件和<code>Native</code>文件动态库</p>
<p>………（<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-271538.htm%EF%BC%89">https://bbs.kanxue.com/thread-271538.htm）</a></p>
<p>最后，Android类加载详细流程：</p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544545.png" alt="image-20250929143026114"></p>
<p>假设我们要加载一个类com.example.MyActivity：</p>
<ol>
<li>应用通过Custom ClassLoader请求加载类（图中步骤1）</li>
<li>Custom ClassLoader调用loadClass()，遵循双亲委派，先委托给PathClassLoader（步骤3）</li>
<li>PathClassLoader委托给BootClassLoader（步骤5）</li>
<li>BootClassLoader无法加载该类，返回给PathClassLoader（步骤8）</li>
<li>PathClassLoader调用findClass()方法（步骤9）</li>
<li>findClass()调用DexPathList的findClass()方法</li>
<li>DexPathList遍历dexElements数组：</li>
<li>对每个Element调用findClass()</li>
<li>Element调用DexFile的loadClassBinaryName()方法</li>
<li>如果在某个DexFile中找到类，立即返回</li>
<li>如果PathClassLoader未找到，返回给Custom ClassLoader（步骤11）</li>
<li>Custom ClassLoader调用自己的findClass()（步骤12）</li>
<li>同样通过DexPathList查找类</li>
<li>如果找到，返回类对象（步骤14）</li>
<li>如果未找到，抛出ClassNotFoundException（步骤15）</li>
</ol>
<h3 id="整体加壳原理"><a href="#整体加壳原理" class="headerlink" title="整体加壳原理"></a>整体加壳原理</h3><p><strong>Dex整体加壳</strong>可以理解为在加密的源Apk程序外面有套上了一层外壳，简单过程为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544546.png" alt="image-20250929130703014"></p>
<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544547.png" alt="image-20250929130743024" style="zoom:33%;" />

<p>加壳例子：</p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544548.png" alt="image-20250929143926144"></p>
<p>我们很明显看见，除了一个代理类<code>Application</code>，其他相关的代码信息都无法发现</p>
<p>在代理类中反射调用了一些方法，很显然我们解析出的结果都无法查找，很明显就说明在<code>Application.attchBaseContext()</code>和<code>Application.onCreate()</code>中必须要完成对源加密的<code>dex</code>的<strong>动态加载和解密</strong></p>
<p>App加载应用解析时流程如下：</p>
<ol>
<li><code>BootClassLoader</code>加载系统核心库</li>
<li><code>PathClassLoader</code>加载APP自身dex</li>
<li>进入APP自身组件，解析<code>AndroidManifest.xml</code>，然后查找<code>Application</code>代理</li>
<li>调用声明<code>Application</code>的<code>attachBaseContext()</code>对源程序进行动态加载或解密</li>
<li>调用声明<code>Application</code>的<code>onCreate()</code>对源程序进行动态加载或解密</li>
<li>进入<code>MainActivity</code>中的<code>attachBaseContext()</code>，然后进入<code>onCreate()</code>函数，执行源程序代码</li>
</ol>
<p>上面我们已经很清晰的了解了壳加载的流程，我们很明显的意识到一个问题，我们从头到尾都是用<code>PathClassLoader</code>来加载dex</p>
<h4 id="简单整体加壳"><a href="#简单整体加壳" class="headerlink" title="简单整体加壳"></a>简单整体加壳</h4><p>我们要想动态加载dex文件必须使用自定义的<code>DexClassLoader</code>，但是直接使用<code>DexClassLoader</code>进行加载，会报异常，是因为<code>DexClassLoader</code>加载的类是<strong>没有组件生命周期</strong>的，即<code>DexClassLoader</code>即使通过对APK的动态加载完成了对组件类的加载，当系统启动该组件时，依然会出现加载类失败的异常</p>
<p>所以我们要想使用<code>DexClassLoader</code>进行动态加载dex，我们需要<strong>进行类加载器的修正</strong></p>
<p>主要有两种方案：</p>
<ol>
<li>替换系统组件类加载器为我们的<code>DexClassLoader</code>，同时设置<code>DexClassLoader</code>的<code>parent</code>为系统组件加载器</li>
<li>打破原有的双亲委派关系，在系统组件类加载器<code>PathClassLoader</code>和<code>BootClassLoader</code>的中间插入我们自己的<code>DexClassLoader</code></li>
</ol>
<h5 id="类加载器替换"><a href="#类加载器替换" class="headerlink" title="类加载器替换"></a>类加载器替换</h5><p><code>LoadedApk</code>主要负责加载一个Apk程序，其中有一个字段<code>mclassLoader</code>，我们通过反射来使用我们的<code>DexClassLoader</code>将其替换，就能让我们的<code>DexClassLoader</code>拥有生命周期</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">replaceClassLoader</span><span class="params">(Context context,ClassLoader dexClassLoader)</span>&#123;</span><br><span class="line">   <span class="type">ClassLoader</span> <span class="variable">pathClassLoader</span> <span class="operator">=</span> MainActivity.class.getClassLoader();</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="comment">//1.获取ActivityThread实例</span></span><br><span class="line">       <span class="type">Class</span> <span class="variable">ActivityThread</span> <span class="operator">=</span> pathClassLoader.loadClass(<span class="string">&quot;android.app.ActivityThread&quot;</span>);</span><br><span class="line">       <span class="type">Method</span> <span class="variable">currentActivityThread</span> <span class="operator">=</span> ActivityThread.getDeclaredMethod(<span class="string">&quot;currentActivityThread&quot;</span>);</span><br><span class="line">       <span class="type">Object</span> <span class="variable">activityThreadObj</span> <span class="operator">=</span> currentActivityThread.invoke(<span class="literal">null</span>);</span><br><span class="line">       <span class="comment">//2.通过反射获得类加载器</span></span><br><span class="line">       <span class="comment">//final ArrayMap&lt;String, WeakReference&lt;LoadedApk&gt;&gt; mPackages = new ArrayMap&lt;&gt;();</span></span><br><span class="line">       <span class="type">Field</span> <span class="variable">mPackagesField</span> <span class="operator">=</span> ActivityThread.getDeclaredField(<span class="string">&quot;mPackages&quot;</span>);</span><br><span class="line">       mPackagesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       <span class="comment">//3.拿到LoadedApk</span></span><br><span class="line">       <span class="type">ArrayMap</span> <span class="variable">mPackagesObj</span> <span class="operator">=</span> (ArrayMap) mPackagesField.get(activityThreadObj);</span><br><span class="line">       <span class="type">String</span> <span class="variable">packagename</span> <span class="operator">=</span> context.getPackageName();</span><br><span class="line">       <span class="type">WeakReference</span> <span class="variable">wr</span> <span class="operator">=</span> (WeakReference) mPackagesObj.get(packagename);</span><br><span class="line">       <span class="type">Object</span> <span class="variable">LoadApkObj</span> <span class="operator">=</span> wr.get();</span><br><span class="line">       <span class="comment">//4.拿到mclassLoader</span></span><br><span class="line">       <span class="type">Class</span> <span class="variable">LoadedApkClass</span> <span class="operator">=</span> pathClassLoader.loadClass(<span class="string">&quot;android.app.LoadedApk&quot;</span>);</span><br><span class="line">       <span class="type">Field</span> <span class="variable">mClassLoaderField</span> <span class="operator">=</span> LoadedApkClass.getDeclaredField(<span class="string">&quot;mClassLoader&quot;</span>);</span><br><span class="line">       mClassLoaderField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       <span class="type">Object</span> <span class="variable">mClassLoader</span> <span class="operator">=</span>mClassLoaderField.get(LoadApkObj);</span><br><span class="line">       Log.e(<span class="string">&quot;mClassLoader&quot;</span>,mClassLoader.toString());</span><br><span class="line">       <span class="comment">//5.将系统组件ClassLoader给替换</span></span><br><span class="line">       mClassLoaderField.set(LoadApkObj,dexClassLoader);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">       e.printStackTrace();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">       e.printStackTrace();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">       e.printStackTrace();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">       e.printStackTrace();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">       e.printStackTrace();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="类加载器插入"><a href="#类加载器插入" class="headerlink" title="类加载器插入"></a>类加载器插入</h5><p> 类加载器刚拿到类，并不会直接进行加载，而是先判断自己是否加载，如果没有加载则给自己的父类，父类再给父类，所以我们让<code>DexClassLoader</code>成为<code>PathClassLoader</code>的父类</p>
<p>这样就可以解决<code>DexClassLoader</code>生命周期的问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">replaceClassLoader</span><span class="params">(Context context, ClassLoader dexClassLoader)</span>&#123;</span><br><span class="line">    <span class="comment">//将pathClassLoader父节点设置为DexClassLoader</span></span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">pathClassLoaderobj</span> <span class="operator">=</span> context.getClassLoader();</span><br><span class="line">    Class&lt;ClassLoader&gt; ClassLoaderClass = ClassLoader.class;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">parent</span> <span class="operator">=</span> ClassLoaderClass.getDeclaredField(<span class="string">&quot;parent&quot;</span>);</span><br><span class="line">        parent.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        parent.set(pathClassLoaderobj,dexClassLoader);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完成壳加载器的修正后，我们就可以正常的加载dex了</p>
<p>之后只需要编写<code>Application</code>代理的<code>onCreate</code>和<code>attachBaseContext</code>函数即可</p>
<h3 id="脱壳方法"><a href="#脱壳方法" class="headerlink" title="脱壳方法"></a>脱壳方法</h3><p>常用fart、frida-dexdump（要先过frida）</p>
<p>以后补，还在学</p>
<h2 id="Frida基础知识"><a href="#Frida基础知识" class="headerlink" title="Frida基础知识"></a>Frida基础知识</h2><h4 id="操作模式"><a href="#操作模式" class="headerlink" title="操作模式:"></a>操作模式:</h4><table>
<thead>
<tr>
<th align="left">操作模式</th>
<th align="left">描述</th>
<th align="left">优点</th>
<th align="left">主要用途</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CLI（命令行）模式</td>
<td align="left">通过命令行直接将JavaScript脚本注入进程中，对进程进行操作</td>
<td align="left">便于直接注入和操作</td>
<td align="left">在较小规模的操作或者需求比较简单的场景中使用</td>
</tr>
<tr>
<td align="left">RPC模式</td>
<td align="left">使用Python进行JavaScript脚本的注入工作，实际对进程进行操作的还是JavaScript脚本，可以通过RPC传输给Python脚本来进行复杂数据的处理</td>
<td align="left">在对复杂数据的处理上可以通过RPC传输给Python脚本来进行，有利于减少被注入进程的性能损耗</td>
<td align="left">在大规模调用中更加普遍，特别是对于复杂数据处理的需求</td>
</tr>
</tbody></table>
<h4 id="注入模式与启动命令"><a href="#注入模式与启动命令" class="headerlink" title="注入模式与启动命令:"></a>注入模式与启动命令:</h4><table>
<thead>
<tr>
<th align="left">注入模式</th>
<th align="left">描述</th>
<th align="left">命令或参数</th>
<th align="left">优点</th>
<th align="left">主要用途</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Spawn模式</td>
<td align="left">将启动App的权利交由Frida来控制，即使目标App已经启动，在使用Frida注入程序时还是会重新启动App</td>
<td align="left">在CLI模式中，Frida通过加上 -f 参数指定包名以spawn模式操作App</td>
<td align="left">适合于需要在App启动时即进行注入的场景，可以在App启动时即捕获其行为</td>
<td align="left">当需要监控App从启动开始的所有行为时使用</td>
</tr>
<tr>
<td align="left">Attach模式</td>
<td align="left">在目标App已经启动的情况下，Frida通过ptrace注入程序从而执行Hook的操作</td>
<td align="left">在CLI模式中，如果不添加 -f 参数，则默认会通过attach模式注入App</td>
<td align="left">适合于已经运行的App，不会重新启动App，对用户体验影响较小</td>
<td align="left">在App已经启动，或者我们只关心特定时刻或特定功能的行为时使用</td>
</tr>
</tbody></table>
<p>Spawn模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f 进程名 -l hook.js</span><br></pre></td></tr></table></figure>

<p>attach模式 ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U 进程名 -l hook.js</span><br></pre></td></tr></table></figure>

<h4 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h4><table>
<thead>
<tr>
<th align="left">API名称</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>Java.use(className)</code></td>
<td align="left">获取指定的Java类并使其在JavaScript代码中可用。</td>
</tr>
<tr>
<td align="left"><code>Java.perform(callback)</code></td>
<td align="left">确保回调函数在Java的主线程上执行。</td>
</tr>
<tr>
<td align="left"><code>Java.choose(className, callbacks)</code></td>
<td align="left">枚举指定类的所有实例。</td>
</tr>
<tr>
<td align="left"><code>Java.cast(obj, cls)</code></td>
<td align="left">将一个Java对象转换成另一个Java类的实例。</td>
</tr>
<tr>
<td align="left"><code>Java.enumerateLoadedClasses(callbacks)</code></td>
<td align="left">枚举进程中已经加载的所有Java类。</td>
</tr>
<tr>
<td align="left"><code>Java.enumerateClassLoaders(callbacks)</code></td>
<td align="left">枚举进程中存在的所有Java类加载器。</td>
</tr>
<tr>
<td align="left"><code>Java.enumerateMethods(targetClassMethod)</code></td>
<td align="left">枚举指定类的所有方法。</td>
</tr>
</tbody></table>
<h4 id="日志输出语法区别"><a href="#日志输出语法区别" class="headerlink" title="日志输出语法区别"></a>日志输出语法区别</h4><table>
<thead>
<tr>
<th align="left">日志方法</th>
<th align="left">描述</th>
<th align="left">区别</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>console.log()</code></td>
<td align="left">使用JavaScript直接进行日志打印</td>
<td align="left">多用于在CLI模式中，<code>console.log()</code>直接输出到命令行界面，使用户可以实时查看。在RPC模式中，<code>console.log()</code>同样输出在命令行，但可能被Python脚本的输出内容掩盖。</td>
</tr>
<tr>
<td align="left"><code>send()</code></td>
<td align="left">Frida的专有方法，用于发送数据或日志到外部Python脚本</td>
<td align="left">多用于RPC模式中，它允许JavaScript脚本发送数据到Python脚本，Python脚本可以进一步处理或记录这些数据。</td>
</tr>
</tbody></table>
<h3 id="Frida常用API"><a href="#Frida常用API" class="headerlink" title="Frida常用API"></a>Frida常用API</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义一个名为hookTest1的函数</span></span><br><span class="line">function <span class="title function_">hookTest1</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//获取一个名为&quot;类名&quot;的Java类，并将其实例赋值给JavaScript变量utils</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">utils</span> <span class="operator">=</span> Java.use(<span class="string">&quot;类名&quot;</span>);</span><br><span class="line">    <span class="comment">//修改&quot;类名&quot;的&quot;method&quot;方法的实现。这个新的实现会接收两个参数（a和b）</span></span><br><span class="line">    utils.method.implementation = function(a, b)&#123;</span><br><span class="line">            <span class="comment">//将参数a和b的值改为123和456。</span></span><br><span class="line">        a = <span class="number">123</span>;</span><br><span class="line">        b = <span class="number">456</span>;</span><br><span class="line">        <span class="comment">//调用修改过的&quot;method&quot;方法，并将返回值存储在`retval`变量中</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">retval</span> <span class="operator">=</span> <span class="built_in">this</span>.method(a, b);</span><br><span class="line">        <span class="comment">//在控制台上打印参数a，b的值以及&quot;method&quot;方法的返回值</span></span><br><span class="line">        console.log(a, b, retval);</span><br><span class="line">        <span class="comment">//返回&quot;method&quot;方法的返回值</span></span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .overload()</span></span><br><span class="line"><span class="comment">// .overload(&#x27;自定义参数&#x27;)</span></span><br><span class="line"><span class="comment">// .overload(&#x27;int&#x27;)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest2</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> utils = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>);</span><br><span class="line">    <span class="comment">//overload定义重载函数，根据函数的参数类型填</span></span><br><span class="line">    utils.<span class="property">Inner</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.zj.wuaipojie.Demo$Animal&#x27;</span>,<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a，b</span>)&#123;</span><br><span class="line">        b = <span class="string">&quot;aaaaaaaaaa&quot;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title class_">Inner</span>(a,b);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest3</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> utils = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>);</span><br><span class="line">    <span class="comment">//修改类的构造函数的实现，$init表示构造函数</span></span><br><span class="line">    utils.<span class="property">$init</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">str</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(str);</span><br><span class="line">        str = <span class="string">&quot;52&quot;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.$init(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">hookTest5</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        <span class="comment">//静态字段的修改</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">utils</span> <span class="operator">=</span> Java.use(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>);</span><br><span class="line">        <span class="comment">//修改类的静态字段&quot;flag&quot;的值</span></span><br><span class="line">        utils.staticField.value = <span class="string">&quot;我是被修改的静态变量&quot;</span>;</span><br><span class="line">        console.log(utils.staticField.value);</span><br><span class="line">        <span class="comment">//非静态字段的修改</span></span><br><span class="line">        <span class="comment">//使用`Java.choose()`枚举类的所有实例</span></span><br><span class="line">        Java.choose(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>, &#123;</span><br><span class="line">            onMatch: function(obj)&#123;			<span class="comment">//通过onMatch回调函数访问每个找到的实例,obj代表Frida找到的每一个实例对象</span></span><br><span class="line">                    <span class="comment">//修改实例的非静态字段&quot;_privateInt&quot;的值为&quot;123456&quot;，并修改非静态字段&quot;privateInt&quot;的值为9999。</span></span><br><span class="line">                obj._privateInt.value = <span class="string">&quot;123456&quot;</span>; <span class="comment">//字段名与函数名相同 前面加个下划线</span></span><br><span class="line">                obj.privateInt.value = <span class="number">9999</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: function()&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">hookTest6</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        <span class="comment">//内部类</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">innerClass</span> <span class="operator">=</span> Java.use(<span class="string">&quot;com.zj.wuaipojie.Demo$innerClass&quot;</span>);</span><br><span class="line">        console.log(innerClass);</span><br><span class="line">        innerClass.$init.implementation = function()&#123;</span><br><span class="line">            console.log(<span class="string">&quot;eeeeeeee&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">hookTest7</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        <span class="comment">//枚举所有的类与类的所有方法,异步枚举</span></span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            onMatch: function(name,handle)&#123; <span class="comment">//name和handle参数是由Frida框架自动传入的，分别代表类名和类句柄</span></span><br><span class="line">                    <span class="comment">//过滤类名</span></span><br><span class="line">                <span class="keyword">if</span>(name.indexOf(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>) !=-<span class="number">1</span>)&#123; </span><br><span class="line">                    console.log(name);</span><br><span class="line">                    <span class="type">var</span> <span class="variable">clazz</span> <span class="operator">=</span>Java.use(name);</span><br><span class="line">                    console.log(clazz);</span><br><span class="line">                    <span class="type">var</span> <span class="variable">methods</span> <span class="operator">=</span> clazz.class.getDeclaredMethods();</span><br><span class="line">                    console.log(methods);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: function()&#123;&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">hookTest8</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">Demo</span> <span class="operator">=</span> Java.use(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>);</span><br><span class="line">        <span class="comment">//getDeclaredMethods枚举所有方法</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">methods</span> <span class="operator">=</span>Demo.class.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>; j &lt; methods.length; j++)&#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">methodName</span> <span class="operator">=</span> methods[j].getName();</span><br><span class="line">            console.log(methodName);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> k=<span class="number">0</span>; k&lt;Demo[methodName].overloads.length;k++)&#123;</span><br><span class="line">                Demo[methodName].overloads[k].implementation = function()&#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;arguments.length;i++)&#123;</span><br><span class="line">                        console.log(arguments[i]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>[methodName].apply(<span class="built_in">this</span>,arguments);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ClassName=Java.use(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>); </span><br><span class="line">ClassName.privateFunc(<span class="string">&quot;传参&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">var</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">Java.perform(function () &#123;</span><br><span class="line">    Java.choose(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>,&#123;    <span class="comment">//要hook的类</span></span><br><span class="line">        onMatch:function(instance)&#123;</span><br><span class="line">            ret=instance.privateFunc(<span class="string">&quot;aaaaaaa&quot;</span>); <span class="comment">//要hook的方法</span></span><br><span class="line">        &#125;,</span><br><span class="line">        onComplete:function()&#123;</span><br><span class="line">                <span class="comment">//console.log(&quot;result: &quot; + ret);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//return ret;</span></span><br></pre></td></tr></table></figure>

<h3 id="Process、Module、Memory基础"><a href="#Process、Module、Memory基础" class="headerlink" title="Process、Module、Memory基础"></a>Process、Module、Memory基础</h3><h4 id="1-Process"><a href="#1-Process" class="headerlink" title="1.Process"></a>1.Process</h4><p><code>Process</code> 对象代表当前被Hook的进程，能获取进程的信息，枚举模块，枚举范围等</p>
<table>
<thead>
<tr>
<th align="left">API</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>Process.id</code></td>
<td align="left">返回附加目标进程的 <code>PID</code></td>
</tr>
<tr>
<td align="left"><code>Process.isDebuggerAttached()</code></td>
<td align="left">检测当前是否对目标程序已经附加</td>
</tr>
<tr>
<td align="left"><code>Process.enumerateModules()</code></td>
<td align="left">枚举当前加载的模块，返回模块对象的数组</td>
</tr>
<tr>
<td align="left"><code>Process.enumerateThreads()</code></td>
<td align="left">枚举当前所有的线程，返回包含 <code>id</code>, <code>state</code>, <code>context</code> 等属性的对象数组</td>
</tr>
</tbody></table>
<h4 id="2-Module"><a href="#2-Module" class="headerlink" title="2.Module"></a>2.Module</h4><p><code>Module</code> 对象代表一个加载到进程的模块(例如，在 Windows 上的 DLL，或在 Linux&#x2F;Android 上的 .so 文件),能查询模块的信息，如模块的基址、名称、导入&#x2F;导出的函数等</p>
<table>
<thead>
<tr>
<th align="left">API</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>Module.load()</code></td>
<td align="left">加载指定so文件，返回一个Module对象</td>
</tr>
<tr>
<td align="left"><code>enumerateImports()</code></td>
<td align="left">枚举所有Import库函数，返回Module数组对象</td>
</tr>
<tr>
<td align="left"><code>enumerateExports()</code></td>
<td align="left">枚举所有Export库函数，返回Module数组对象</td>
</tr>
<tr>
<td align="left"><code>enumerateSymbols()</code></td>
<td align="left">枚举所有Symbol库函数，返回Module数组对象</td>
</tr>
<tr>
<td align="left"><code>Module.findExportByName(exportName)、Module.getExportByName(exportName)</code></td>
<td align="left">寻找指定so中export库中的函数地址</td>
</tr>
<tr>
<td align="left"><code>Module.findBaseAddress(name)、Module.getBaseAddress(name)</code></td>
<td align="left">返回so的基地址</td>
</tr>
</tbody></table>
<h4 id="3-Memory"><a href="#3-Memory" class="headerlink" title="3.Memory"></a>3.Memory</h4><p><code>Memory</code>是一个工具对象，提供直接读取和修改进程内存的功能，能够读取特定地址的值、写入数据、分配内存等</p>
<table>
<thead>
<tr>
<th align="left">方法</th>
<th align="left">功能</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>Memory.copy()</code></td>
<td align="left">复制内存</td>
</tr>
<tr>
<td align="left"><code>Memory.scan()</code></td>
<td align="left">搜索内存中特定模式的数据</td>
</tr>
<tr>
<td align="left"><code>Memory.scanSync()</code></td>
<td align="left">同上，但返回多个匹配的数据</td>
</tr>
<tr>
<td align="left"><code>Memory.alloc()</code></td>
<td align="left">在目标进程的堆上申请指定大小的内存，返回一个<code>NativePointer</code></td>
</tr>
<tr>
<td align="left"><code>Memory.writeByteArray()</code></td>
<td align="left">将字节数组写入一个指定内存</td>
</tr>
<tr>
<td align="left"><code>Memory.readByteArray()</code></td>
<td align="left">读取内存</td>
</tr>
</tbody></table>
<h3 id="Frida检测"><a href="#Frida检测" class="headerlink" title="Frida检测"></a>Frida检测</h3><ol>
<li>检测<code>/data/local/tmp</code>路径下的是否有frida特征文件（重命名文件）</li>
<li>检测maps（<code>hook strstr/strcmp</code>函数）&#x2F;（重定向<code>maps</code>文件）&#x2F;（用eBPF来hook系统调用并修改参数实现目的，使用<code>bpf_probe_write_user</code>向用户态函数地址写内容直接修改参数）</li>
<li>检测status(线程名)（<code>hook strstr strcmp</code>函数）</li>
<li>检测inlinehook（<code>hook memcmp</code>函数）</li>
</ol>
<blockquote>
<p>实际的hook还需要去逆向对应的frida检测代码，然后做出相应的change</p>
</blockquote>
<p>也可以刷入魔改后的frida-server客户端</p>
<p><a target="_blank" rel="noopener" href="https://github.com/hzzheyang/strongR-frida-android?tab=readme-ov-file">https://github.com/hzzheyang/strongR-frida-android?tab=readme-ov-file</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Ylarod/Florida">https://github.com/Ylarod/Florida</a></p>
<h2 id="App1"><a href="#App1" class="headerlink" title="App1"></a>App1</h2><p>一个登录界面，尝试登录请求抓包：</p>
<p>账号：<code>1234567890</code> 密码：<code>123456789</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /api/user/login HTTP/1.1</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">User-Agent: Dalvik/2.1.0 (Linux; U; Android 9; Pixel Build/PQ2A.190405.003)</span><br><span class="line">Host: api.dodovip.com</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line">Content-Length: 262</span><br><span class="line"></span><br><span class="line">&#123;&quot;Encrypt&quot;:&quot;NIszaqFPos1vd0pFqKlB42Np5itPxaNH\/\/FDsRnlBfgL4lcVxjXii02ggCULFNaeuVKT\/FXC+BMD\nbmIP0xrILxokBXoh7OoVgMbtuNMHBgOkhfune+JRPpa3O6XOpZbvNSV4zGRVpm6sKZ74RrRZvf5Y\nR1tTPSGZkERXdKPxddJZKfJiqwKHHMTk61D\/Z4zcZYYsTWqycwQ+ZGFjPIugKPjPFFzcf+vHE3CR\nGqsmzGc=\n&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>但是返回了一个404的包，说明该接口已经被弃用了，只能纯逆向了（因为是一个非常老的apk了）</p>
<p>反编译apk然后分析算法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">private</span> Map para;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(String userName, String pwd)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.DEFAULT_TYPE = <span class="keyword">new</span> <span class="title class_">TypeToken</span>() &#123;</span><br><span class="line">    &#125;.getType();</span><br><span class="line">    <span class="built_in">this</span>.para.clear();</span><br><span class="line">    <span class="built_in">this</span>.para.put(<span class="string">&quot;username&quot;</span>, userName);</span><br><span class="line">    <span class="built_in">this</span>.para.put(<span class="string">&quot;userPwd&quot;</span>, pwd);</span><br><span class="line">    <span class="keyword">if</span>(TextUtils.isEmpty(DodonewOnlineApplication.devId)) &#123;</span><br><span class="line">        DodonewOnlineApplication.devId = Utils.getDevId(DodonewOnlineApplication.getAppContext());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.para.put(<span class="string">&quot;equtype&quot;</span>, <span class="string">&quot;ANDROID&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.para.put(<span class="string">&quot;loginImei&quot;</span>, <span class="string">&quot;Android&quot;</span> + DodonewOnlineApplication.devId);</span><br><span class="line">    <span class="built_in">this</span>.requestNetwork(<span class="string">&quot;user/login&quot;</span>, <span class="built_in">this</span>.para, <span class="built_in">this</span>.DEFAULT_TYPE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将userName、pwd、equtype和loginImei打包成一个Map类型的值类似json，然后通过this.requestNetwork，传递给user&#x2F;login接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">requestNetwork</span><span class="params">(String cmd, Map para, Type type)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.showProgress();</span><br><span class="line">    <span class="built_in">this</span>.request = <span class="keyword">new</span> <span class="title class_">JsonRequest</span>(<span class="built_in">this</span>, <span class="string">&quot;http://api.dodovip.com/api/&quot;</span> + cmd, <span class="string">&quot;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Listener</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(RequestResult requestResult)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(!requestResult.code.equals(<span class="string">&quot;1&quot;</span>)) &#123;</span><br><span class="line">                LoginActivity.<span class="built_in">this</span>.showToast(requestResult.message);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(cmd.equals(<span class="string">&quot;user/login&quot;</span>)) &#123;</span><br><span class="line">                DodonewOnlineApplication.loginUser = (User)requestResult.data;</span><br><span class="line">                DodonewOnlineApplication.loginLabel = <span class="string">&quot;mobile&quot;</span>;</span><br><span class="line">                Utils.saveJson(LoginActivity.<span class="built_in">this</span>, DodonewOnlineApplication.loginLabel, <span class="string">&quot;LOGINLABEL&quot;</span>);</span><br><span class="line">                LoginActivity.<span class="built_in">this</span>.intentMainActivity();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LoginActivity.<span class="built_in">this</span>.dissProgress();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="built_in">this</span>, type);</span><br><span class="line">    <span class="built_in">this</span>.request.addRequestMap(para, <span class="number">0</span>);</span><br><span class="line">    DodonewOnlineApplication.addRequest(<span class="built_in">this</span>.request, <span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建JsonRequest对象，构造完整API URL为<code>http://api.dodovip.com/api/ + cmd</code></li>
<li>设置响应监听器(Listener)处理请求结果</li>
<li>通过addRequestMap方法将参数(para)添加到请求中</li>
<li>最后通过DodonewOnlineApplication.addRequest将请求添加到队列中执行</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addRequestMap</span><span class="params">(Map map0, <span class="type">int</span> a)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> System.currentTimeMillis() + <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(map0 == <span class="literal">null</span>) &#123;</span><br><span class="line">        map0 = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    map0.put(<span class="string">&quot;timeStamp&quot;</span>, s);</span><br><span class="line">    <span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> RequestUtil.encodeDesMap(RequestUtil.paraMap(map0, <span class="string">&quot;sdlkjsdljf0j2fsjk&quot;</span>, <span class="string">&quot;sign&quot;</span>), <span class="built_in">this</span>.desKey, <span class="built_in">this</span>.desIV);</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        obj.put(<span class="string">&quot;Encrypt&quot;</span>, s1);</span><br><span class="line">        <span class="built_in">this</span>.mRequestBody = obj + <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(JSONException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到再次加入一个<code>timeStamp</code>参数，然后通过Des加密就成了<code>Encrypt</code>的<code>value</code>了，可以看到我们请求包中的参数的<code>key</code>就是<code>Encrypt</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> RequestUtil.encodeDesMap(RequestUtil.paraMap(map0, <span class="string">&quot;sdlkjsdljf0j2fsjk&quot;</span>, <span class="string">&quot;sign&quot;</span>), <span class="built_in">this</span>.desKey, <span class="built_in">this</span>.desIV);</span><br></pre></td></tr></table></figure>

<p>这里可以通过frida hook来获取这三个参数的值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">RequestUtil</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.dodonew.online.http.RequestUtil&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">RequestUtil</span>);</span><br><span class="line">    <span class="title class_">RequestUtil</span>.<span class="property">encodeDesMap</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a,b,c</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data: &quot;</span>+a);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;desKey: &quot;</span>+b);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;desIV: &quot;</span>+c);</span><br><span class="line">        <span class="keyword">var</span> returnValue = <span class="variable language_">this</span>.<span class="title function_">encodeDesMap</span>(a,b,c);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;returnValue: &quot;</span>+returnValue);</span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Pixel::PID::18572 ]-&gt; data: &#123;&quot;equtype&quot;:&quot;ANDROID&quot;,&quot;loginImei&quot;:&quot;Android352689080920725&quot;,&quot;sign&quot;:&quot;D890E5736DE831FE31CFEAB80EA79808&quot;,&quot;timeStamp&quot;:&quot;1759499341310&quot;,&quot;userPwd&quot;:&quot;12345678 &quot;,&quot;username&quot;:&quot;12345678901&quot;&#125;</span><br><span class="line">desKey: 65102933</span><br><span class="line">desIV: 32028092</span><br><span class="line">returnValue: NIszaqFPos1vd0pFqKlB42Np5itPxaNH//FDsRnlBfgL4lcVxjXii02ggCULFNaeuVKT/FXC+BMD</span><br><span class="line">bmIP0xrILw+btCAOv/RTB58iDYS9BneDRhHyJkzHZpgn+2fSdkhXpYri+OFeZ+MGhIR+Vqny4/K5</span><br><span class="line">nBpbSsQk3dnxQYVkLC64nN947cLFIUOcvnABk93q8ih6kqT53Hj0yxQbl3ksduKCO4P/pZPpQzAG</span><br><span class="line">6DUPk6s=</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;equtype&quot;:&quot;ANDROID&quot;,&quot;loginImei&quot;:&quot;Android352689080920725&quot;,&quot;sign&quot;:&quot;D890E5736DE831FE31CFEAB80EA79808&quot;,&quot;timeStamp&quot;:&quot;1759499341310&quot;,&quot;userPwd&quot;:&quot;12345678 &quot;,&quot;username&quot;:&quot;12345678901&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>这是<code>RequestUtil.paraMap(map0, &quot;sdlkjsdljf0j2fsjk&quot;, &quot;sign&quot;)</code>的返回值，然后Key和IV是硬编码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /api/user/login HTTP/1.1</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">User-Agent: Dalvik/2.1.0 (Linux; U; Android 9; Pixel Build/PQ2A.190405.003)</span><br><span class="line">Host: api.dodovip.com</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line">Content-Length: 264</span><br><span class="line"></span><br><span class="line">&#123;&quot;Encrypt&quot;:&quot;NIszaqFPos1vd0pFqKlB42Np5itPxaNH\/\/FDsRnlBfgL4lcVxjXii02ggCULFNaeuVKT\/FXC+BMD\nbmIP0xrILw+btCAOv\/RTB58iDYS9BneDRhHyJkzHZpgn+2fSdkhXpYri+OFeZ+MGhIR+Vqny4\/K5\nnBpbSsQk3dnxQYVkLC64nN947cLFIUOcvnABk93q8ih6kqT53Hj0yxQbl3ksduKCO4P\/pZPpQzAG\n6DUPk6s=\n&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>返回值和抓包得到<code>Encrypt</code>的value是一样的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;equtype&quot;:&quot;ANDROID&quot;,&quot;loginImei&quot;:&quot;Android352689080920725&quot;,&quot;sign&quot;:&quot;D890E5736DE831FE31CFEAB80EA79808&quot;,&quot;timeStamp&quot;:&quot;1759499341310&quot;,&quot;userPwd&quot;:&quot;12345678 &quot;,&quot;username&quot;:&quot;12345678901&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><code>timeStamp</code>是时间戳，通过<code>String s = System.currentTimeMillis() + &quot;&quot;;</code>获取</p>
<p>其他字段都是明文，重点看<code>sign</code>字段是如何得到的</p>
<p>Hook<code>paraMap</code>函数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">timeStamp : 1759500042670</span><br><span class="line">loginImei : Android352689080920725</span><br><span class="line">equtype : ANDROID</span><br><span class="line">userPwd : 12345678</span><br><span class="line">username : 12345678901</span><br></pre></td></tr></table></figure>

<p>map里的内容是以上的明文字段，因此sign是在当前函数产生的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">paraMap</span><span class="params">(Map map0, String append, String sign)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Set</span> <span class="variable">set0</span> <span class="operator">=</span> map0.keySet();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="type">ArrayList</span> <span class="variable">list</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        <span class="keyword">for</span>(Object object0: set0) &#123;</span><br><span class="line">            list.add(((String)object0) + <span class="string">&quot;=&quot;</span> + ((String)map0.get(((String)object0))));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Collections.sort(list);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); ++i) &#123;</span><br><span class="line">            builder.append(((String)list.get(i)));</span><br><span class="line">            builder.append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        builder.append(<span class="string">&quot;key=&quot;</span> + append);</span><br><span class="line">        map0.put(<span class="string">&quot;sign&quot;</span>, Utils.md5(builder.toString()).toUpperCase());</span><br><span class="line">        <span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(RequestUtil.sortMapByKey(map0));</span><br><span class="line">        Log.w(<span class="string">&quot;yang&quot;</span>, s2 + <span class="string">&quot;   result&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> s2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从map0中获取所有的key，然后按照key&#x3D;value的格式放到一个list里，之后进行字典排序，然后用<code>&amp;</code>将每个键值对拼接起来，最后将其MD5就获得了<code>sign</code>，因此我们hook<code>md5</code>函数就能得到参数是什么了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">md5: equtype=ANDROID&amp;loginImei=Android352689080920725&amp;timeStamp=1759500651664&amp;userPwd=12345678 &amp;username=12345678901&amp;key=sdlkjsdljf0j2fsjk</span><br><span class="line">returnValue: 7514354356ba3ea708a5df7bcd139bbd</span><br><span class="line">returnValue: &#123;&quot;equtype&quot;:&quot;ANDROID&quot;,&quot;loginImei&quot;:&quot;Android352689080920725&quot;,&quot;sign&quot;:&quot;7514354356BA3EA708A5DF7BCD139BBD&quot;,&quot;timeStamp&quot;:&quot;1759500651664&quot;,&quot;userPwd&quot;:&quot;12345678 &quot;,&quot;username&quot;:&quot;12345678901&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到是通过首字符升序排序的，<code>key</code>也是一个固定的值</p>
<p>然后详细看加密算法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">encodeDesMap</span><span class="params">(String data, String desKey, String desIV)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DesSecurity</span>(desKey, desIV).encrypt64(data.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">DesSecurity</span><span class="params">(String key, String iv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span>(key == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;Parameter is null!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.InitCipher(key.getBytes(), iv.getBytes());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">InitCipher</span><span class="params">(<span class="type">byte</span>[] secKey, <span class="type">byte</span>[] secIv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">MessageDigest</span> <span class="variable">messageDigest0</span> <span class="operator">=</span> MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>);</span><br><span class="line">    messageDigest0.update(secKey);</span><br><span class="line">    <span class="type">DESKeySpec</span> <span class="variable">dsk</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DESKeySpec</span>(messageDigest0.digest());</span><br><span class="line">    <span class="type">SecretKey</span> <span class="variable">secretKey0</span> <span class="operator">=</span> SecretKeyFactory.getInstance(<span class="string">&quot;DES&quot;</span>).generateSecret(dsk);</span><br><span class="line">    <span class="type">IvParameterSpec</span> <span class="variable">iv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IvParameterSpec</span>(secIv);</span><br><span class="line">    <span class="built_in">this</span>.enCipher = Cipher.getInstance(<span class="string">&quot;DES/CBC/PKCS5Padding&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.deCipher = Cipher.getInstance(<span class="string">&quot;DES/CBC/PKCS5Padding&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.enCipher.init(<span class="number">1</span>, secretKey0, iv);</span><br><span class="line">    <span class="built_in">this</span>.deCipher.init(<span class="number">2</span>, secretKey0, iv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] decrypt64(String data) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.deCipher.doFinal(Base64.decode(data, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在初始化Cipher函数中，会获取一个MD5，然后将secKey推进去，之后调用DES的获取密钥的函数将dsk截断，之后使用MD5后的Key和原始IV进行DES加密，加密模式为<code>DES/CBC/PKCS5Padding</code></p>
<p>因此整个流程是：先将<code>equtype</code>、<code>loginImei</code>、<code>timeStamp</code>、<code>userPwd</code>、<code>username</code>和<code>key</code>拼接起来，只有<code>userPwd</code>和<code>username</code>是用户传入的然后剩下是时间戳或固定的设备参数或者硬编码，之后将其MD5后拼接到<code>sign</code>的<code>value</code>，作为新的<code>map</code>，之后将<code>Key</code>进行一次<code>MD5</code>然后将其和原本的<code>IV</code>作为密钥对新的<code>map</code>进行加密，得到的就是最后的<code>Encrypt</code></p>
<h3 id="算法还原"><a href="#算法还原" class="headerlink" title="算法还原"></a>算法还原</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> DES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">sign_string=<span class="string">&#x27;equtype=ANDROID&amp;loginImei=Android352689080920725&amp;timeStamp=1759501463192&amp;userPwd=12345678 &amp;username=12345678901&amp;key=sdlkjsdljf0j2fsjk&#x27;</span>;</span><br><span class="line">md5_sign=hashlib.md5(sign_string.encode()).hexdigest().upper()</span><br><span class="line"><span class="comment"># print(md5_string)</span></span><br><span class="line"></span><br><span class="line">user_string=<span class="string">&#x27;&#123;&quot;equtype&quot;:&quot;ANDROID&quot;,&quot;loginImei&quot;:&quot;Android352689080920725&quot;,&quot;sign&quot;:&quot;&#x27;</span>+<span class="built_in">str</span>(md5_sign)+<span class="string">&#x27;&quot;,&quot;timeStamp&quot;:&quot;1759501463192&quot;,&quot;userPwd&quot;:&quot;12345678 &quot;,&quot;username&quot;:&quot;12345678901&quot;&#125;&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;user_string=<span class="subst">&#123;user_string&#125;</span>&quot;</span>)</span><br><span class="line">key_string = <span class="string">&quot;65102933&quot;</span></span><br><span class="line">key_md5 = hashlib.md5(key_string.encode()).digest()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;key_md5=<span class="subst">&#123;key_md5&#125;</span>&quot;</span>)</span><br><span class="line">key = key_md5[:<span class="number">8</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;key=<span class="subst">&#123;key&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">iv = <span class="string">&quot;32028092&quot;</span>.encode()</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(iv) &lt; <span class="number">8</span>:</span><br><span class="line">    iv = iv + <span class="string">b&#x27;\0&#x27;</span> * (<span class="number">8</span> - <span class="built_in">len</span>(iv))</span><br><span class="line"><span class="keyword">elif</span> <span class="built_in">len</span>(iv) &gt; <span class="number">8</span>:</span><br><span class="line">    iv = iv[:<span class="number">8</span>]</span><br><span class="line">data = user_string.encode()</span><br><span class="line">padded_data = pad(data, DES.block_size)</span><br><span class="line">cipher = DES.new(key, DES.MODE_CBC, iv)</span><br><span class="line">encrypted_data = cipher.encrypt(padded_data)</span><br><span class="line">encrypted_base64 = base64.b64encode(encrypted_data).decode()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;加密后的结果: <span class="subst">&#123;encrypted_base64&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>因为使用Python写加解密算法比较方便，因此使用python进行算法还原</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">user_string=&#123;<span class="string">&quot;equtype&quot;</span>:<span class="string">&quot;ANDROID&quot;</span>,<span class="string">&quot;loginImei&quot;</span>:<span class="string">&quot;Android352689080920725&quot;</span>,<span class="string">&quot;sign&quot;</span>:<span class="string">&quot;914CCB500B828858A16496959DE4CC7A&quot;</span>,<span class="string">&quot;timeStamp&quot;</span>:<span class="string">&quot;1759501463192&quot;</span>,<span class="string">&quot;userPwd&quot;</span>:<span class="string">&quot;12345678 &quot;</span>,<span class="string">&quot;username&quot;</span>:<span class="string">&quot;12345678901&quot;</span>&#125;</span><br><span class="line">key_md5=<span class="string">b&#x27;\xc3\xd2m\xca\x86%\x97\x82\xbd\x91\x86H\x1f\x89*\xe6&#x27;</span></span><br><span class="line">key=<span class="string">b&#x27;\xc3\xd2m\xca\x86%\x97\x82&#x27;</span></span><br><span class="line">加密后的结果: </span><br><span class="line">NIszaqFPos1vd0pFqKlB42Np5itPxaNH//FDsRnlBfgL4lcVxjXii02ggCULFNaeuVKT/FXC+BMD</span><br><span class="line">bmIP0xrIL5+cfhEzMXyKHy4xuh0h19w1UoI+CUlznYRWafwBDARtKnpa1J/s5fecfmKDlU6dbU70</span><br><span class="line">CC9YUEGfzovqMpwa+LSpI8uI0g8zWl8z9CGsfPmQirjlSp41/YR/AvN6QLOGCxJbcAk8Zlh2O2nR</span><br><span class="line">Z9vurSE=</span><br><span class="line"></span><br><span class="line">returnValue: </span><br><span class="line">NIszaqFPos1vd0pFqKlB42Np5itPxaNH//FDsRnlBfgL4lcVxjXii02ggCULFNaeuVKT/FXC+BMD</span><br><span class="line">bmIP0xrIL5+cfhEzMXyKHy4xuh0h19w1UoI+CUlznYRWafwBDARtKnpa1J/s5fecfmKDlU6dbU70</span><br><span class="line">CC9YUEGfzovqMpwa+LSpI8uI0g8zWl8z9CGsfPmQirjlSp41/YR/AvN6QLOGCxJbcAk8Zlh2O2nR</span><br><span class="line">Z9vurSE=</span><br></pre></td></tr></table></figure>

<p>一毛一样！！！</p>
<h4 id="hook-js"><a href="#hook-js" class="headerlink" title="hook.js"></a>hook.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">RequestUtil</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.dodonew.online.http.RequestUtil&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">RequestUtil</span>);</span><br><span class="line">    <span class="title class_">RequestUtil</span>.<span class="property">encodeDesMap</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a,b,c</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data: &quot;</span>+a);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;desKey: &quot;</span>+b);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;desIV: &quot;</span>+c);</span><br><span class="line">        <span class="keyword">var</span> returnValue = <span class="variable language_">this</span>.<span class="title function_">encodeDesMap</span>(a,b,c);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;returnValue: &quot;</span>+returnValue);</span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">RequestUtil</span>.<span class="property">paraMap</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.util.Map&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a,b,c</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;map0 类型: &quot;</span> + (a ? a.<span class="property">$className</span> : <span class="string">&quot;null&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 打印Map内容</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (a != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;map内容:&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> keySet = a.<span class="title function_">keySet</span>();</span><br><span class="line">                <span class="keyword">var</span> keyArray = keySet.<span class="title function_">toArray</span>();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keyArray.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                    <span class="keyword">var</span> key = keyArray[i];</span><br><span class="line">                    <span class="keyword">var</span> value = a.<span class="title function_">get</span>(key);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(key + <span class="string">&quot; : &quot;</span> + value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;打印Map内容时出错: &quot;</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;append: &quot;</span>+b);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sign: &quot;</span>+c);</span><br><span class="line">        <span class="keyword">var</span> returnValue = <span class="variable language_">this</span>.<span class="title function_">paraMap</span>(a,b,c);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;returnValue: &quot;</span>+returnValue);</span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Utils</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.dodonew.online.util.Utils&quot;</span>)</span><br><span class="line">    <span class="title class_">Utils</span>.<span class="property">md5</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;md5: &quot;</span>+a);</span><br><span class="line">        <span class="keyword">var</span> returnValue = <span class="variable language_">this</span>.<span class="title function_">md5</span>(a);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;returnValue: &quot;</span>+returnValue);</span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="算法转发"><a href="#算法转发" class="headerlink" title="算法转发"></a>算法转发</h3><p>直接使用该App内部的Java算法来进行一个加密的操作，我们就不用进行算法的还原了，只需要调用该App的算法函数，然后提供需要的原料，通过Rpc映射到本地的一个端口上，就能实现一个Rpc远程调用该算法</p>
<p>使用小肩膀课程中的代码会发现会报一个错误：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;error&quot;</span><span class="punctuation">:</span><span class="string">&quot;ReferenceError: &#x27;Java&#x27; is not defined\n    at hookTest (/script1.js:5)\n    at call (native)\n    at handleRpcMessage (/frida/runtime/message-dispatcher.js:39)\n    at handleMessage (/frida/runtime/message-dispatcher.js:25)&quot;</span><span class="punctuation">,</span><span class="attr">&quot;item_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这是因为<a target="_blank" rel="noopener" href="https://frida.re/news/2025/05/17/frida-17-0-0-released/%E5%9C%A8%E8%BF%99%E9%87%8C%E8%AF%B4%E6%98%8Efrida17%E7%9A%84%E7%89%88%E6%9C%AC%EF%BC%8C%E6%A1%A5%E6%8E%A5%E5%99%A8%60frida-%7Bobjc,swift,java%7D-bridge%60%E4%B8%8D%E5%86%8D%E9%BB%98%E8%AE%A4%E5%8A%A0%E8%BD%BD%EF%BC%8C%E9%9C%80%E8%A6%81%E6%89%8B%E5%8A%A8%E5%AF%BC%E5%85%A5%EF%BC%8C%E4%BD%BF%E7%94%A8AI%E5%8E%BB%E9%87%8D%E5%86%99%E4%B8%80%E4%B8%AA">https://frida.re/news/2025/05/17/frida-17-0-0-released/在这里说明frida17的版本，桥接器`frida-{objc,swift,java}-bridge`不再默认加载，需要手动导入，使用AI去重写一个</a> Python 脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">wrap_user_script</span>(<span class="params">name, script</span>):</span><br><span class="line">    <span class="keyword">if</span> script.startswith(<span class="string">&quot;📦\n&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> script</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;Script.evaluate(<span class="subst">&#123;json.dumps(name)&#125;</span>, <span class="subst">&#123;json.dumps(script)&#125;</span>);&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_final_script</span>(<span class="params">raw_fragments</span>):</span><br><span class="line">    fragments = []</span><br><span class="line">    next_script_id = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> raw_fragment <span class="keyword">in</span> raw_fragments:</span><br><span class="line">        <span class="keyword">if</span> raw_fragment.startswith(<span class="string">&quot;📦\n&quot;</span>):</span><br><span class="line">            fragments.append(raw_fragment[<span class="number">2</span>:])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            script_id = next_script_id</span><br><span class="line">            next_script_id += <span class="number">1</span></span><br><span class="line">            size = <span class="built_in">len</span>(raw_fragment.encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">            fragments.append(<span class="string">f&quot;<span class="subst">&#123;size&#125;</span> /frida/repl-<span class="subst">&#123;script_id&#125;</span>.js\n✄\n<span class="subst">&#123;raw_fragment&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;📦\n&quot;</span> + <span class="string">&quot;\n✄\n&quot;</span>.join(fragments)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_java_bridge</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;查找Java桥接器文件&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> path <span class="keyword">in</span> <span class="built_in">reversed</span>(sys.path):</span><br><span class="line">        <span class="keyword">if</span> path.endswith(<span class="string">&#x27;site-packages&#x27;</span>):</span><br><span class="line">            bridge_path = os.path.join(path, <span class="string">&#x27;frida_tools&#x27;</span>, <span class="string">&#x27;bridges&#x27;</span>, <span class="string">&#x27;java.js&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> os.path.exists(bridge_path):</span><br><span class="line">                <span class="keyword">return</span> bridge_path</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果找不到，尝试其他可能的路径</span></span><br><span class="line">    <span class="keyword">import</span> frida_tools</span><br><span class="line">    frida_tools_path = os.path.dirname(frida_tools.__file__)</span><br><span class="line">    bridge_path = os.path.join(frida_tools_path, <span class="string">&#x27;bridges&#x27;</span>, <span class="string">&#x27;java.js&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(bridge_path):</span><br><span class="line">        <span class="keyword">return</span> bridge_path</span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> FileNotFoundError(<span class="string">&quot;找不到Java桥接器文件，请确保frida-tools已正确安装&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 你的JavaScript代码</span></span><br><span class="line">user_js_code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">function hookTest(username, passward)&#123;</span></span><br><span class="line"><span class="string">    var result;</span></span><br><span class="line"><span class="string">    Java.perform(function()&#123;</span></span><br><span class="line"><span class="string">        var time = new Date().getTime();</span></span><br><span class="line"><span class="string">        time = &#x27;1759643230427&#x27;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        var string = Java.use(&#x27;java.lang.String&#x27;);</span></span><br><span class="line"><span class="string">        var signData = string.$new(&#x27;equtype=ANDROID&amp;loginImei=Android352689080920725&amp;timeStamp=&#x27; + </span></span><br><span class="line"><span class="string">        time + &#x27;&amp;userPwd=&#x27; + passward + &#x27;&amp;username=&#x27; + username + &#x27;&amp;key=sdlkjsdljf0j2fsjk&#x27;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        var Utils = Java.use(&#x27;com.dodonew.online.util.Utils&#x27;);</span></span><br><span class="line"><span class="string">        var sign = Utils.md5(signData).toUpperCase();</span></span><br><span class="line"><span class="string">        console.log(&#x27;sign: &#x27;, sign);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        var encryptData = &#x27;&#123;&quot;equtype&quot;:&quot;ANDROID&quot;,&quot;loginImei&quot;:&quot;Android352689080920725&quot;,&quot;sign&quot;:&quot;&#x27;+ </span></span><br><span class="line"><span class="string">        sign +&#x27;&quot;,&quot;timeStamp&quot;:&quot;&#x27;+ time +&#x27;&quot;,&quot;userPwd&quot;:&quot;&#x27; + passward + &#x27;&quot;,&quot;username&quot;:&quot;&#x27; + username + &#x27;&quot;&#125;&#x27;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        var RequestUtil = Java.use(&#x27;com.dodonew.online.http.RequestUtil&#x27;);</span></span><br><span class="line"><span class="string">        var Encrypt = RequestUtil.encodeDesMap(encryptData, &#x27;65102933&#x27;, &#x27;32028092&#x27;);</span></span><br><span class="line"><span class="string">        console.log(&#x27;Encrypt: &#x27;, Encrypt);</span></span><br><span class="line"><span class="string">        result = Encrypt;</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    return result;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">rpc.exports = &#123;</span></span><br><span class="line"><span class="string">    s1nec1o: hookTest</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">message, data</span>):</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] <span class="subst">&#123;message[<span class="string">&#x27;payload&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] ERROR: <span class="subst">&#123;message&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建完整的脚本</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 读取Java桥接器</span></span><br><span class="line">    bridge_path = find_java_bridge()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(bridge_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        java_bridge = f.read()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加Java到全局对象</span></span><br><span class="line">    java_bridge += <span class="string">&quot;\n\nObject.defineProperty(globalThis, &#x27;Java&#x27;, &#123; value: bridge &#125;);&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 包装用户脚本</span></span><br><span class="line">    wrapped_script = wrap_user_script(<span class="string">&quot;hookTest&quot;</span>, user_js_code)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构建最终脚本</span></span><br><span class="line">    raw_fragments = [java_bridge, wrapped_script]</span><br><span class="line">    final_script = build_final_script(raw_fragments)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;脚本构建成功&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;脚本构建失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Frida连接</span></span><br><span class="line">devices = frida.get_usb_device(<span class="number">1000</span>)</span><br><span class="line">pid = devices.spawn(<span class="string">&#x27;com.dodonew.online&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;pid: <span class="subst">&#123;pid&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">process = devices.attach(pid)</span><br><span class="line">script = process.create_script(final_script)</span><br><span class="line">script.on(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line">devices.resume(pid)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;应用已恢复执行&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待应用完全启动</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;等待应用完全启动...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/get_data&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">getEchoApi</span>(<span class="params">item_id: <span class="built_in">str</span>, item_user: <span class="built_in">str</span>, item_pass: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;开始处理请求: user=<span class="subst">&#123;item_user&#125;</span>, pass=<span class="subst">&#123;item_pass&#125;</span>&quot;</span>)</span><br><span class="line">        result = script.exports_sync.s1nec1o(item_user, item_pass)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item_retval&quot;</span>: result&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        error_msg = <span class="built_in">str</span>(e)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;RPC调用错误: <span class="subst">&#123;error_msg&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: error_msg, <span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/status&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">check_status</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;ready&quot;</span>, <span class="string">&quot;frida_version&quot;</span>: frida.__version__&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(app=app, host=<span class="string">&quot;127.0.0.1&quot;</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>

<p>增加部分的详细说明：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">wrap_user_script</span>(<span class="params">name, script</span>):</span><br><span class="line">    <span class="keyword">if</span> script.startswith(<span class="string">&quot;📦\n&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> script</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;Script.evaluate(<span class="subst">&#123;json.dumps(name)&#125;</span>, <span class="subst">&#123;json.dumps(script)&#125;</span>);&quot;</span></span><br></pre></td></tr></table></figure>

<p>将Js代码包装成frida能识别的格式。<code>Script.evaluate()</code>是Frida内部用来执行脚本的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">build_final_script</span><span class="params">(raw_fragments)</span>:</span><br><span class="line">    fragments = []</span><br><span class="line">    next_script_id = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> raw_fragment in raw_fragments:</span><br><span class="line">        <span class="keyword">if</span> raw_fragment.startswith(<span class="string">&quot;📦\n&quot;</span>):</span><br><span class="line">            fragments.append(raw_fragment[<span class="number">2</span>:])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            script_id = next_script_id</span><br><span class="line">            next_script_id += <span class="number">1</span></span><br><span class="line">            size = len(raw_fragment.encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">            fragments.append(f<span class="string">&quot;&#123;size&#125; /frida/repl-&#123;script_id&#125;.js\n✄\n&#123;raw_fragment&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;📦\n&quot;</span> + <span class="string">&quot;\n✄\n&quot;</span>.join(fragments)</span><br></pre></td></tr></table></figure>

<p>将多个JavaScript片段（Java桥接器 + 你的代码）组合成一个完整的Frida脚本包。📦和✄是Frida的内部标记符。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">find_java_bridge</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;查找Java桥接器文件&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> path <span class="keyword">in</span> <span class="built_in">reversed</span>(sys.path):</span><br><span class="line">        <span class="keyword">if</span> path.endswith(<span class="string">&#x27;site-packages&#x27;</span>):</span><br><span class="line">            bridge_path = os.path.join(path, <span class="string">&#x27;frida_tools&#x27;</span>, <span class="string">&#x27;bridges&#x27;</span>, <span class="string">&#x27;java.js&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> os.path.exists(bridge_path):</span><br><span class="line">                <span class="keyword">return</span> bridge_path</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 如果找不到，尝试其他可能的路径</span></span><br><span class="line">    <span class="keyword">import</span> frida_tools</span><br><span class="line">    frida_tools_path = os.path.dirname(frida_tools.__file__)</span><br><span class="line">    bridge_path = os.path.join(frida_tools_path, <span class="string">&#x27;bridges&#x27;</span>, <span class="string">&#x27;java.js&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(bridge_path):</span><br><span class="line">        <span class="keyword">return</span> bridge_path</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">raise</span> FileNotFoundError(<span class="string">&quot;找不到Java桥接器文件，请确保frida-tools已正确安装&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>自动查找系统中安装的Java桥接器文件。这个文件包含了让<code>Java.perform()</code>工作所需的所有代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建完整的脚本</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 读取Java桥接器</span></span><br><span class="line">    bridge_path = find_java_bridge()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(bridge_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        java_bridge = f.read()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加Java到全局对象</span></span><br><span class="line">    java_bridge += <span class="string">&quot;\n\nObject.defineProperty(globalThis, &#x27;Java&#x27;, &#123; value: bridge &#125;);&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 包装用户脚本</span></span><br><span class="line">    wrapped_script = wrap_user_script(<span class="string">&quot;hookTest&quot;</span>, user_js_code)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 构建最终脚本</span></span><br><span class="line">    raw_fragments = [java_bridge, wrapped_script]</span><br><span class="line">    final_script = build_final_script(raw_fragments)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;脚本构建成功&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;脚本构建失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<ol>
<li>读取Java桥接器: 从<code>frida_tools/bridges/java.js</code>读取Java桥接器代码</li>
<li>注册Java对象: 添加<code>Object.defineProperty(globalThis, &#39;Java&#39;, &#123; value: bridge &#125;);</code>，这行代码让Java对象在全局可用</li>
<li>包装你的脚本: 将你的<code>JavaScript</code>代码包装成<code>Frida</code>格式</li>
<li>组合脚本: 将<code>Java</code>桥接器和你的代码组合成最终脚本</li>
</ol>
<p><a target="_blank" rel="noopener" href="http://127.0.0.1:8000/get_data?item_id=1&item_user=12345678901&item_pass=123456789">http://127.0.0.1:8000/get_data?item_id=1&amp;item_user=12345678901&amp;item_pass=123456789</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;item_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">,</span><span class="attr">&quot;item_retval&quot;</span><span class="punctuation">:</span><span class="string">&quot;NIszaqFPos1vd0pFqKlB42Np5itPxaNH//FDsRnlBfgL4lcVxjXii02ggCULFNaeuVKT/FXC+BMD\nbmIP0xrIL98xsKTOSbgIWuEhruHgPtMk8UaM2X3bIN17yS34xTmxUQlfDaRFr4d1eIV2+Kn2vl2z\n8dbq+kB0AY2H+3lKAmUDzuRngtxIqaZHS9MIBv9sErGLqpABUb9MgTOmjljk+33RaMn5gSx6PQKy\nQN2xZw4=\n&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>抓包结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;Encrypt&quot;</span><span class="punctuation">:</span><span class="string">&quot;NIszaqFPos1vd0pFqKlB42Np5itPxaNH\/\/FDsRnlBfgL4lcVxjXii02ggCULFNaeuVKT\/FXC+BMD\nbmIP0xrIL98xsKTOSbgIWuEhruHgPtMk8UaM2X3bIN17yS34xTmxUQlfDaRFr4d1eIV2+Kn2vl2z\n8dbq+kB0AY2H+3lKAmUDzuRngtxIqaZHS9MIBv9sErGLqpABUb9MgTOmjljk+33RaMn5gSx6PQKy\nQN2xZw4=\n&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>结果相等~~~</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://s1nec-1o.github.io">s1nec-1o</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://s1nec-1o.github.io/2025/10/11/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F-1/">http://s1nec-1o.github.io/2025/10/11/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F-1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://s1nec-1o.github.io" target="_blank">S1nec-1o's B1og</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/android/">android</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/10/21/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%E4%B9%8B%E5%88%9D%E8%AF%86%E9%A3%8E%E6%8E%A7-2/" title="Android逆向从入门到入土之初识风控(2)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android逆向从入门到入土之初识风控(2)</div></div></a></div><div class="next-post pull-right"><a href="/2025/09/05/CVE-2024-35250%E5%A4%8D%E7%8E%B0/" title="CVE-2024-35250复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">CVE-2024-35250复现</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2025/04/14/Android%E9%80%86%E5%90%91%E4%B9%8BWiki%E7%AF%87/" title="Android逆向之Wiki篇"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-14</div><div class="title">Android逆向之Wiki篇</div></div></a></div><div><a href="/2025/11/03/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%E4%B9%8BAntiFakerAndroidChecker/" title="Android逆向从入门到入土之AntiFakerAndroidChecker()"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-03</div><div class="title">Android逆向从入门到入土之AntiFakerAndroidChecker()</div></div></a></div><div><a href="/2025/10/21/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%E4%B9%8B%E5%88%9D%E8%AF%86%E9%A3%8E%E6%8E%A7-2/" title="Android逆向从入门到入土之初识风控(2)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-21</div><div class="title">Android逆向从入门到入土之初识风控(2)</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">s1nec-1o</div><div class="author-info__description">万事胜意</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">25</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="http://github.com/s1nec-1o"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">正在学习iot pwn 欢迎广大师傅与我交流</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Android-App%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">Android App启动流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Android-APP%E5%AE%89%E8%A3%85"><span class="toc-number">2.1.</span> <span class="toc-text">Android APP安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Launcher%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.1.</span> <span class="toc-text">Launcher启动流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#App%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.2.</span> <span class="toc-text">App启动流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E5%8A%A0%E5%A3%B3%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3"><span class="toc-number">3.</span> <span class="toc-text">整体加壳原理详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%92%8C%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD"><span class="toc-number">3.1.</span> <span class="toc-text">深入理解类加载器和动态加载</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">3.1.1.</span> <span class="toc-text">类加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">双亲委派模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Android%E4%B8%AD%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">Android中类加载机制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#BootClassLoader"><span class="toc-number">3.1.1.3.</span> <span class="toc-text">BootClassLoader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Class%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%EF%BC%9A"><span class="toc-number">3.1.1.4.</span> <span class="toc-text">Class文件加载：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#PathClassLoader"><span class="toc-number">3.1.1.5.</span> <span class="toc-text">PathClassLoader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#DexClassLoader"><span class="toc-number">3.1.1.6.</span> <span class="toc-text">DexClassLoader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#BaseDexClassLoader"><span class="toc-number">3.1.1.7.</span> <span class="toc-text">BaseDexClassLoader</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E5%8A%A0%E5%A3%B3%E5%8E%9F%E7%90%86"><span class="toc-number">3.2.</span> <span class="toc-text">整体加壳原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%95%B4%E4%BD%93%E5%8A%A0%E5%A3%B3"><span class="toc-number">3.2.1.</span> <span class="toc-text">简单整体加壳</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%9B%BF%E6%8D%A2"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">类加载器替换</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%8F%92%E5%85%A5"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">类加载器插入</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%B1%E5%A3%B3%E6%96%B9%E6%B3%95"><span class="toc-number">3.3.</span> <span class="toc-text">脱壳方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Frida%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">4.</span> <span class="toc-text">Frida基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.0.1.</span> <span class="toc-text">操作模式:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E6%A8%A1%E5%BC%8F%E4%B8%8E%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">4.0.2.</span> <span class="toc-text">注入模式与启动命令:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95"><span class="toc-number">4.0.3.</span> <span class="toc-text">基础语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA%E8%AF%AD%E6%B3%95%E5%8C%BA%E5%88%AB"><span class="toc-number">4.0.4.</span> <span class="toc-text">日志输出语法区别</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Frida%E5%B8%B8%E7%94%A8API"><span class="toc-number">4.1.</span> <span class="toc-text">Frida常用API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Process%E3%80%81Module%E3%80%81Memory%E5%9F%BA%E7%A1%80"><span class="toc-number">4.2.</span> <span class="toc-text">Process、Module、Memory基础</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Process"><span class="toc-number">4.2.1.</span> <span class="toc-text">1.Process</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Module"><span class="toc-number">4.2.2.</span> <span class="toc-text">2.Module</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Memory"><span class="toc-number">4.2.3.</span> <span class="toc-text">3.Memory</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Frida%E6%A3%80%E6%B5%8B"><span class="toc-number">4.3.</span> <span class="toc-text">Frida检测</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#App1"><span class="toc-number">5.</span> <span class="toc-text">App1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%97%E6%B3%95%E8%BF%98%E5%8E%9F"><span class="toc-number">5.1.</span> <span class="toc-text">算法还原</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#hook-js"><span class="toc-number">5.1.1.</span> <span class="toc-text">hook.js</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%97%E6%B3%95%E8%BD%AC%E5%8F%91"><span class="toc-number">5.2.</span> <span class="toc-text">算法转发</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/03/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%E4%B9%8BAntiFakerAndroidChecker/" title="Android逆向从入门到入土之AntiFakerAndroidChecker()">Android逆向从入门到入土之AntiFakerAndroidChecker()</a><time datetime="2025-11-03T13:26:59.000Z" title="发表于 2025-11-03 21:26:59">2025-11-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/21/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%E4%B9%8B%E5%88%9D%E8%AF%86%E9%A3%8E%E6%8E%A7-2/" title="Android逆向从入门到入土之初识风控(2)">Android逆向从入门到入土之初识风控(2)</a><time datetime="2025-10-21T14:17:54.000Z" title="发表于 2025-10-21 22:17:54">2025-10-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/11/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F-1/" title="Android逆向从入门到入土(1)">Android逆向从入门到入土(1)</a><time datetime="2025-10-11T06:38:08.000Z" title="发表于 2025-10-11 14:38:08">2025-10-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/05/CVE-2024-35250%E5%A4%8D%E7%8E%B0/" title="CVE-2024-35250复现">CVE-2024-35250复现</a><time datetime="2025-09-05T13:13:44.000Z" title="发表于 2025-09-05 21:13:44">2025-09-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/16/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bafl-fuzz%E7%BB%93%E6%9D%9F/" title="AFL源码阅读之afl-fuzz结束">AFL源码阅读之afl-fuzz结束</a><time datetime="2025-08-16T07:03:01.000Z" title="发表于 2025-08-16 15:03:01">2025-08-16</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281616326.png')"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By s1nec-1o</div><div class="footer_custom_text">介是s1nec-1o的博客</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.12.0"></script><script src="/js/main.js?v=4.12.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><div><canvas id="snow" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:99999;pointer-events:none"></canvas></div><script>const notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));</script><script async type="text/javascript" src="https://cdn.jsdelivr.net/gh/Candinya/Kratos-Rebirth@latest/source/js/snow.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>